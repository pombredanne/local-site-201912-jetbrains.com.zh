<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>Profiler-帮助|里昂</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="procedures.profiler" data-breadcrumbs="Profiling_Tools.xml|Dynamic Code Analysis/CPU_Profiler.xml|Profiler" data-main-title="Profiler"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索CLion帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>CLion 2019.3帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option value="primary_default_for_windows" data-group="primary" selected>Windows的默认设置</option><option value="primary_default_for_macos" data-group="primary">macOS的默认设置</option><option value="primary_intellij_idea_classic_macos" data-group="primary">IntelliJ IDEA经典版（macOS）</option><option value="primary_emacs" data-group="primary">埃马克斯</option><option value="primary_visual_studio" data-group="primary">视觉工作室</option><option value="primary_default_for_xwin" data-group="primary">XWin的默认设置</option><option value="primary_default_for_gnome" data-group="primary">GNOME的默认设置</option><option value="primary_default_for_kde" data-group="primary">KDE的默认值</option><option value="primary_eclipse" data-group="primary">日食</option><option value="primary_eclipse_macos" data-group="primary">Eclipse（macOS）</option><option value="primary_netbeans" data-group="primary">NetBeans</option><option value="primary_sublime_text" data-group="primary">崇高文字</option><option value="primary_sublime_text_macos" data-group="primary">崇高文字（macOS）</option><option value="primary_xcode" data-group="primary">Xcode</option><option value="primary_resharper" data-group="primary">锐化器</option><option value="primary_resharper_macos" data-group="primary">ReSharper（macOS）</option><option value="secondary_default_for_windows" data-group="secondary">Windows的默认设置</option><option value="secondary_default_for_macos" data-group="secondary">macOS的默认设置</option><option value="secondary_intellij_idea_classic" data-group="secondary">IntelliJ IDEA经典版</option><option value="secondary_emacs" data-group="secondary">埃马克斯</option><option value="secondary_visual_studio" data-group="secondary">视觉工作室</option><option value="secondary_default_for_xwin" data-group="secondary">XWin的默认设置</option><option value="secondary_default_for_gnome" data-group="secondary">GNOME的默认设置</option><option value="secondary_default_for_kde" data-group="secondary">KDE的默认值</option><option value="secondary_eclipse" data-group="secondary">日食</option><option value="secondary_eclipse_macos" data-group="secondary">Eclipse（macOS）</option><option value="secondary_netbeans" data-group="secondary">NetBeans</option><option value="secondary_sublime_text" data-group="secondary">崇高文字</option><option value="secondary_sublime_text_macos" data-group="secondary">崇高文字（macOS）</option><option value="secondary_xcode" data-group="secondary">Xcode</option><option value="secondary_resharper" data-group="secondary">锐化器</option><option value="secondary_resharper_macos" data-group="secondary">ReSharper（macOS）</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="CPU_Profiler.xml" data-toc="procedures.profiler">探查器</h1>                             <p id="Intro">借助CLion的CPU Profiler集成，您可以分析为应用程序收集的性能指标（内核和用户代码）。探查器可在<span class="control">Linux和macOS上使用</span> ，并且实现分别基于<a href="https://perf.wiki.kernel.org/index.php/Main_Page" rel="noopener noreferrer" data-external="true" target="_blank">Perf</a>和<a href="http://dtrace.org/blogs/about/" rel="noopener noreferrer" data-external="true" target="_blank">DTrace</a>工具。在当前状态下，您可以为<span class="control">CMake和Gradle项目</span>运行探查器。请注意，WSL工具链和远程开发模式<span class="emphasis">不支持</span>它。</p>    <p id="f226d0e1">        <span class="control">Perf</span>和<span class="control">DTrace</span>使用<span class="control">固定速率的采样</span>来中断应用程序并收集程序计数器和堆栈跟踪，然后将其转换为性能分析报告。这样的报告可能很长且难以分析，因此CLion提供了探查器输出数据的<span class="control">可视化</span> 。</p>            <div class="chapter"><h2 id="Prerequisites" data-toc="procedures.profiler#Prerequisites">先决条件</h2>                <div class="tabs" id="90ca3ef6"><div class="tabs__content" id="74a153cc" data-title="Linux">                <section class="procedure-steps"><ol class="list _decimal"><li class="list__item" id="9433e225">                        <p id="a37a4088">为您的<span class="control">特定内核版本</span>安装<span class="control">Perf</span>工具。</p>                        <p id="499c87c4">使用<code class="code">uname -r</code>找出确切的版本，然后安装相应的<span class="filepath">linux-tools</span>软件包。例如：</p><div class="code-block" data-lang="bash">$ uname -r 4.15.0-36-generic $ sudo apt-get install linux-tools-4.15.0-36-generic</div>                        <p></p>                    </li><li class="list__item" id="6df53976">                        <p id="3682fb3f"><span class="control">调整内核选项</span></p>                                                                    <ul class="list _bullet"><li class="list__item" id="43c6bcec"><p id="7fd7cc88">                                <i id="14ffa615">perf_event_paranoid-</i>控制非root用户对性能事件数据的使用。</p>                                <p id="986a2f92">将该值设置为小于2，以允许探查器在没有root特权的情况下收集性能信息：</p><div class="code-block" data-lang="bash">sudo sh -c'回显1> / proc / sys / kernel / perf_event_paranoid'</div>                                <p></p>                            </li><li class="list__item" id="ed916031"><p id="99b2d37a">                                <i id="3cafc6f3">kptr_restrict-</i>设置对公开内核地址的限制。</p>                                <p id="a6471dc2">要正确解析内核符号， <i id="4daf1519">请将</i>其值设置为0，以禁用<i id="4daf1519">kptr_restrict</i>提供的保护：</p><div class="code-block" data-lang="bash">sudo sh -c'回显0> / proc / sys / kernel / kptr_restrict'</div>                                <p></p>                            </li></ul>                        <p id="0a42192e">默认情况下，这些更改仅影响您当前的OS会话。要在整个系统重新引导期间保留设置，请运行：</p>                        <div class="code-block" data-lang="bash">sudo sh -c'echo kernel.perf_event_paranoid = 1 >> /etc/sysctl.d/99-perf.conf'sudo sh -c'echo kernel.kptr_restrict = 0 >> /etc/sysctl.d/99-perf。 conf'sudo sh -c'sysctl --system'</div>                       <p id="a87f4b34">首次启动探查器时，CLion检查是否已设置内核变量并提出必要的更改建议：</p>                        <figure><img alt="调整探查器的linux内核变量" title="调整探查器的linux内核变量" src="/help/img/idea/2019.3/cl_profiler_kernelvars.png" id="99934cc7" width="500" height="303"></figure>                                       </li><li class="list__item" id="32209c36">                        <p id="4c24ef73">对于输出和跳转到源代码导航中<span class="control">易于理解的名称</span> ，分析器需要<span class="control">addr2line</span> 。</p>                <p id="dc2dcee0">该工具是<a href="https://www.gnu.org/software/binutils/" rel="noopener noreferrer" data-external="true" target="_blank">binutils</a>软件包的一部分，因此默认情况下您可能会将其安装在系统上。如果没有，请单独安装该软件包：</p><div class="code-block" data-lang="bash">apt-get安装binutils</div>                <p></p>                    </li></ol></section>            </div><div class="tabs__content" id="5d92e3f5" data-title="macOS">                    <section class="procedure-steps"><ul class="list "><li class="list__item" id="9a2a68cc"><p>唯一需要的工具是<span class="control">DTrace</span> ，它很可能默认安装在您的macOS上。通过调用检查<code class="code">dtrace</code>终端中的命令。</p></li></ul></section>            </div></div>    <p id="aa94bace">如果其位置包含在<span class="filepath">PATH</span>环境变量中，CLion会自动检测<span class="control">Perf</span>或<span class="control">DTrace</span>可执行文件。您也可以在<span class="menupath" data-skip-index="skip">“设置” /“首选项” |“设置”中</span>手动<span class="menupath" data-skip-index="skip">设置</span>路径<span class="menupath" data-skip-index="skip">。构建，执行，部署|动态分析工具|探查器</span> 。</p></div> <div class="chapter"><h2 id="UsingTheProfiler" data-toc="procedures.profiler#UsingTheProfiler">运行分析</h2>     <section class="procedure-steps"><h3 id="UsingTheProfiler_Prepare">准备构建</h3><ol class="list _decimal"><li class="list__item" id="0e7cf282"><p>探查器依靠调试信息来提供有意义的输出数据和导航，因此最好将<span class="control">Debug</span>配置用于性能分析。</p></li><li class="list__item" id="3255598e">             <p id="2034c4d1">内联之类的编译器<span class="control">优化</span>可能会影响分析结果。为确保没有任何帧因内联而丢失，请将优化级别设置为<code class="code">-O0</code>在您的<span class="filepath">CMakeLists.txt中</span> ：</p><div class="code-block" data-lang="makefile">set（CMAKE_C_FLAGS“ $ {CMAKE_C_FLAGS} -O0”）set（CMAKE_CXX_FLAGS“ $ {CMAKE_CXX_FLAGS} -O0”）</div>             <p></p>             <p id="eac48507">同样，编译器可以将帧指针寄存器用作通用寄存器以进行优化，这可能会导致堆栈跟踪中断。在Linux上，探查器的实现不依赖于此，但是在macOS上，我们建议设置<code class="code">-fno-omit-frame-pointer</code> <span class="control">gcc</span>和两者的编译标志<code class="code">-fno-omit-frame-pointer</code>和<code class="code">-mno-omit-leaf-frame-pointer</code>为<span class="control">c</span> 。</p>         </li></ol></section>     <section class="procedure-steps"><h3 id="UsingTheProfiler_Sampling">配置采样频率</h3><ul class="list "><li class="list__item" id="1ae9f77e">             <p id="3a11b4f9">默认采样率值非常高，长时间运行的程序可能需要大量磁盘空间。</p>             <p id="1dab494f">如果需要，可以在<span class="menupath" data-skip-index="skip">“设置” /“首选项” |“设置”中</span>更改探查器的采样频率。 <span class="menupath" data-skip-index="skip">构建，执行，部署|动态分析工具|探查器</span> 。</p><figure><img alt="分析器设置" title="分析器设置" src="/help/img/idea/2019.3/cl_profiler_settings.png" id="ba5a66ce" width="544" height="332"></figure>             <p></p>             <p id="3f33c988">选择采样率时，请<span class="control">注意</span>系统中可能安排的<span class="control">其他计时器驱动的活动</span> 。例如，默认值设置为99赫兹，而不是100赫兹，以避免采用其他可能的活动以100Hz的采样频率进行锁步采样。</p>         </li></ul></section>     <section class="procedure-steps"><h3 id="UsingTheProfiler_RunProfiler">运行分析器</h3><ol class="list _decimal"><li class="list__item" id="7a3250e3">            <p id="2cbb7958">要运行分析器，请使用<img class="inline-icon-16" src="/help/img/idea/2019.3/icons.actions.profile@2x.png" width="16" alt="图标动作配置文件">在主工具栏上单击按钮或调用<span class="menupath" data-skip-index="skip">运行|个人资料</span> 。另一种选择是选择<img class="inline-icon-16" src="/help/img/idea/2019.3/icons.actions.profile@2x.png" width="16" alt="图标动作配置文件">左侧装订线菜单中的<span class="control">配置文件</span> ：</p><figure><img alt="使用探查器选项运行装订线菜单" title="使用探查器选项运行装订线菜单" src="/help/img/idea/2019.3/cl_profiler_rungutter.png" id="3dbc86f6" width="364" height="240"></figure>            <p></p>            <p id="ba430f9d">请注意，在<span class="control">macOS上</span> ，您还可以将探查器附加到正在运行的进程（调用<span class="menupath" data-skip-index="skip">Run | Attach Profiler to Process</span> ）：</p><figure><img alt="将探查器附加到流程" title="将探查器附加到流程" src="/help/img/idea/2019.3/cl_attachwithprofiler.png" id="155155d3" width="449" height="401"></figure>            <p></p>        </li><li class="list__item" id="88ffb3c1">             <p id="f39a59d0">启动分析时，CLion会通知您分析器是否成功连接。</p>             <p id="f67cd952">在应用程序停止并且分析数据准备就绪之后，CLion显示一个气球，该气球带有指向<span class="control">CPU Profiler工具窗口</span>的链接（也可以从主菜单“ <span class="menupath" data-skip-index="skip">视图|工具窗口| CPU Profiler”访问</span> ）：</p><figure><img alt="仿形完成的气球" title="仿形完成的气球" src="/help/img/idea/2019.3/cl_profiler_balloon.png" id="57ac2c9f" width="208" height="117"></figure><p></p>            <p id="3b44d1db">要在停止应用程序之前停止事件探查器，请使用<img class="inline-icon-16" src="/help/img/idea/2019.3/Docker-core.icons.StopContainer_1.png" width="16" alt="Docker核心图标StopContainer 1">分析器工具窗口中的按钮。</p>         </li></ol></section>         </div>        <div class="chapter"><h2 id="InterpretingTheResults" data-toc="procedures.profiler#InterpretingTheResults">解释结果</h2>        <p id="7122a4e5">在“ CPU Profiler工具”窗口中，您可以在三个选项卡中看到收集的数据：“ <span class="control">火焰图”</span> ，“ <span class="control">调用树</span> ”和“ <span class="control">方法列表”</span> 。左侧列出了应用程序线程和<span class="control">所有合并的线程</span> 。在Linux上，如果在程序中进行了设置，CLion将显示有意义的线程名称，而在macOS上，线程名称显示为id-s。</p>    <p id="f8e2e7e4">要在分析结果进行搜索，就可以<span class="control">开始</span>在工具窗口区域中<span class="control">键入</span>正确的，其结果将在当前打开的选项卡中予以强调：</p><figure><img alt="在分析器工具窗口中键入以开始搜索" title="在分析器工具窗口中键入以开始搜索" src="/help/img/idea/2019.3/cl_profiler_typesearch_mac.png" id="bc01ad78" width="750" height="688"></figure>    <p></p>    <p id="cd8863ef">        “事件探查器”工具窗口的所有三个选项卡中均提供了<span class="control">上下文菜单</span> 。它使您可以在另一个选项卡中找到所选功能（例如， <span class="control">在“</span>火焰图”块的“ <span class="control">方法列表”中关注“方法”</span> ），导航到源代码（“ <span class="control">跳转到源代码”</span> ），并将框架信息复制到剪贴板：仅框架名称（ <span class="control">复制帧</span> ）或从堆栈底部到所选帧的帧名称序列（ <span class="control">复制堆栈至帧</span> ）。</p><figure><img alt="选项卡元素的上下文菜单" title="选项卡元素的上下文菜单" src="/help/img/idea/2019.3/cl_profiler_context_menu.png" id="fafb8b18" width="510" height="445"></figure>    <p></p>    <div class="chapter"><h3 id="InterpretingTheResults_FlameChart">火焰图</h3>        <p id="77ea0632"><span class="control">Perf</span>或<span class="control">DTrace</span>收集的原始分析数据是调用树摘要。<a href="http://www.brendangregg.com/flamegraphs.html" rel="noopener noreferrer" data-external="true" target="_blank">火焰图</a>将其可视化为堆栈轨迹的集合：矩形代表调用堆栈的帧，按宽度排序。</p>        <p id="197d1085">每个块代表堆栈中的一个功能（堆栈框架）。每个块的宽度对应于所用方法的CPU时间（或分配大小（在分配概要分析的情况下））。在Y轴上，从下往上有一个堆栈深度。X轴显示了堆栈配置文件，从最消耗资源的功能到最不消耗功能的功能排序。</p>        <p id="806bceaa">阅读火焰图时，请注意<span class="control">最宽的方块</span> 。这些块是配置文件中最常显示的功能。您可以从底部开始向上移动，按照从父方法到子方法的代码流进行操作，也可以使用相反的方向探索显示直接在CPU上运行的功能的顶部块。</p>        <p id="9264a4c5">将鼠标悬停在任何块上可以查看详细信息：</p><figure><img alt="阻止火焰图中的细节" title="阻止火焰图中的细节" src="/help/img/idea/2019.3/cl_profiler_flamechart_hover.png" id="fe5ee4b0" width="388" height="339"></figure>        <p></p>    </div>    <div class="chapter"><h3 id="InterpretingTheResults_CallTree">呼叫树</h3>        <p id="4b305475">“ <span class="control">调用树”</span>选项卡显示程序调用树，其中包含每个功能在总分析时间内的百分比。百分比后面的可选数字表示已过滤的呼叫序列。单击以展开此序列。</p>        <figure><img alt="探查器结果中的“调用树”选项卡" title="探查器结果中的“调用树”选项卡" src="/help/img/idea/2019.3/cl_profiler_calltree_mac.png" id="eca08de5" width="750" height="685"></figure>         <p id="f15aa5f2">要配置和过滤“呼叫树”视图，请使用“演示设置”按钮（ <img class="inline-icon-16" src="/help/img/idea/2019.3/artwork.studio.icons.logcat.toolbar.settings@2x.png" width="16" alt="设定"> ）。</p>    </div>     <div class="chapter"><h3 id="InterpretingTheResults_MethodList">方法清单</h3>         <p id="c15e09f7">方法列表收集配置文件数据中的所有方法，并按累计采样时间对它们进行排序。对于列表中的每个功能，您都可以查看<span class="control">Back Traces</span>和<span class="control">Merged Callees</span> 。</p>   <figure><img alt="分析器结果中的“方法列表”选项卡" title="分析器结果中的“方法列表”选项卡" src="/help/img/idea/2019.3/cl_profiler_methodlist_mac.png" id="5c19b81a" width="631" height="619"></figure>     </div>                 </div>    <div class="last-modified" data-skip-index="skip">上次修改时间：2019年12月1日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="memory-profiling-with-valgrind.html">Valgrind Memcheck</a> <a class="navigation-links__next" href="code-coverage-clion.html">代码覆盖率</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>