<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>为Amazon EC2设置TeamCity-帮助|帮助团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Setting Up TeamCity for Amazon EC2" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/teamcity-integration-with-cloud-solutions.md|TeamCity Integration with Cloud Solutions/setting-up-teamcity-for-amazon-ec2.md|Setting Up TeamCity for Amazon EC2" data-main-title="Setting Up TeamCity for Amazon EC2" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/setting-up-teamcity-for-amazon-ec2.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="setting-up-teamcity-for-amazon-ec2.md" data-toc="Setting Up TeamCity for Amazon EC2">为Amazon EC2设置TeamCity</h1><p id="f8d6b34d">通过TeamCity Amazon EC2集成，您可以使用您的Amazon帐户配置TeamCity，然后根据队列中的构建按需使用TeamCity代理按需启动和停止映像。</p><p id="cdcd3ba7">与其他云解决方案集成是<a href="teamcity-integration-with-cloud-solutions.html#Available-Integrations">可用的</a> 。</p><p id="2a2d613b">在此页：</p><p id="f74dba7d"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-GeneralDescription">一般说明</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Configuration">组态</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-RequiredIAMpermissions">所需的IAM权限</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Optionalpermissions">可选权限</a></li></ul></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-PreparingImagewithInstalledTeamCityAgent">使用已安装的TeamCity Agent准备映像</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AdditionalconfigurationforWindowsagents">Windows代理的其他配置</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-ImportantnoteforimagesbasedonWindowsServer2016image">基于Windows Server 2016映像的映像的重要说明</a></li></ul></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Agentauto-upgradeNote">代理自动升级说明</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-ConfiguringanAmazonEC2cloudprofile">配置Amazon EC2云配置文件</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-CustomImageName">自定义图片名称</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-IAMprofiles">IAM配置文件</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AmazonEC2SpotInstancessupport">Amazon EC2竞价型实例支持</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AmazonEC2SpotFleetsupport">Amazon EC2 Spot Fleet支持</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AmazonEBS-OptimizedInstances">Amazon EBS优化的实例</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-TaggingforTeamCity-launchedinstances">标记TeamCity启动的实例</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Requirements">要求</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Automatictags">自动标签</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Customtags">自定义标签</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Tagginginstance-dependentresources">标记与实例相关的资源</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-SharingsingleEBSinstancebetweenseveralTeamCityservers">在多个TeamCity服务器之间共享单个EBS实例</a></li></ul></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Newinstancetypes">新实例类型</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Proxysettings">代理设定</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Customscript">自定义脚本</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-EstimatingEC2Costs">估算EC2成本</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-TrafficEstimate">流量估算</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-UptimeCosts">正常运行时间成本</a></li></ul></li></ul></li></ul><p></p><a name="GeneralDescription"></a><a name="General-Description"></a><div class="chapter"><h2 id="SettingUpTeamCityforAmazonEC2-GeneralDescription">一般说明</h2><p id="eaaf7592">假定机器映像已预先配置为在引导时启动TeamCity代理（请参见<a href="#Preparing-Image-with-Installed-TeamCity-Agent">下面的</a>详细信息）。</p><p id="764a5261">在TeamCity中为一个或多个映像配置了云配置文件后，TeamCity将对所有新映像进行测试启动，以了解它们上的代理。<br>连接代理后，TeamCity将存储其参数，以便能够正确处理构建配置与代理之间的兼容性。</p><p id="c7901b34">对于每个排队的构建，TeamCity首先尝试在常规的非云代理之一上启动它。如果没有可用的常规代理，TeamCity将查找具有兼容代理的匹配云映像，并为该映像启动一个新实例。TeamCity确保不超过云配置文件中配置的运行实例限制。</p><p id="f1e002aa">从TeamCity启动的云实例连接代理后，将自动对其进行授权（前提是存在可用的代理许可证）。之后，该代理将作为常规代理进行处理。<br>如果在云配置文件上配置了运行超时并达到了运行超时，则该实例将终止（如果已选择现有的Amazon实例作为图像源，则该实例将被终止）。</p><p id="387ba46f">在实例终止/停止时，其断开连接的代理将从授权代理列表中删除，并从系统中删除。</p><p id="6e33cd6a">TeamCity支持Amazon EC2 <a href="#Amazon-EC2-Spot-Instances-support">竞价型实例</a>和<a href="#Amazon-EC2-Spot-Fleet-support">竞价型队列</a> 。</p></div><a name="Configuration"></a><a name="Configuration"></a><div class="chapter"><h2 id="SettingUpTeamCityforAmazonEC2-Configuration">组态</h2><p id="26e2961c">了解Amazon EC2和执行EC2任务的能力是配置和使用TeamCity Amazon EC2集成的先决条件。</p><p id="e5f510eb">TeamCity EC2的基本设置包括：</p><ul class="list _ul"><li class="list__item" id="a655a343"><p>使用已安装的TeamCity代理准备Amazon EC2映像（AMI）</p></li><li class="list__item" id="eb07e709"><p>在TeamCity服务器上配置EC2集成</p></li></ul><aside class="note " rel="f4a9075d" id="dd7a9abc" data-title=""><p id="e0a67861">请注意，EC2代理的数量受您在TeamCity中拥有的代理许可证总数的限制。</p></aside><p id="c58c0563">确保在<b id="08917037">管理|</b>服务器上指定的服务器URL <b id="08917037">。</b>如果未在<a href="agent-cloud-profile.html#Specifying-profile-settings">云配置文件设置中</a>指定自定义服务器URL，则“ <b id="08917037">全局设置”</b>页面是正确的，因为代理将使用它来连接到服务器。</p><p id="305ed127">如果您需要TeamCity使用代理访问EC2服务，请阅读专用<a href="http://youtrack.jetbrains.com/issue/TW-23637#comment=27-380892" rel="noopener noreferrer" data-external="true" target="_blank">问题中</a>的最新解决方法。</p><a name="RequiredIAMpermissions"></a><a name="Required-IAM-permissions"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-RequiredIAMpermissions">所需的IAM权限</h3><p id="c0bbbd44">TeamCity需要具有Amazon EC2资源的以下权限：</p><ul class="list _ul"><li class="list__item" id="237542e1"><code class="code">ec2:Describe*</code></li><li class="list__item" id="b6e47b2e"><code class="code">ec2:StartInstances</code></li><li class="list__item" id="24de0cbe"><code class="code">ec2:StopInstances</code></li><li class="list__item" id="cfa8e183"><code class="code">ec2:TerminateInstances</code></li><li class="list__item" id="a6769f5b"><code class="code">ec2:RebootInstances</code></li><li class="list__item" id="79631c90"><code class="code">ec2:RunInstances</code></li><li class="list__item" id="544216cd"><code class="code">ec2:ModifyInstanceAttribute</code></li><li class="list__item" id="773f8e10"><a href="#Tagging-for-TeamCity-launched-instances"><code class="code">ec2:*Tags</code></a></li></ul><p id="c4139548">要使用<a href="#Amazon-EC2-Spot-Instances-support">竞价型实例</a> ，需要以下附加权限：</p><ul class="list _ul"><li class="list__item" id="33d8dba2"><code class="code">ec2:RequestSpotInstances</code></li><li class="list__item" id="44b0544c"><code class="code">ec2:CancelSpotInstanceRequests</code></li></ul><p id="33402da8">要使用<a href="#Amazon-EC2-Spot-Fleet-support">现货车队</a> ，还需要以下附加权限：</p><ul class="list _ul"><li class="list__item" id="c1ee42f2"><code class="code">ec2:ec2:RequestSpotFleet</code></li><li class="list__item" id="1741add9"><code class="code">ec2:DescribeSpotFleetRequests</code></li><li class="list__item" id="7b7ebefd"><code class="code">ec2:CancelSpotFleetRequests</code></li></ul><p id="473e9dbd">要启动<a href="#Configuring-an-Amazon-EC2-cloud-profile">具有IAM角色</a>的<a href="#Configuring-an-Amazon-EC2-cloud-profile">实例</a> （仅适用于从AMI-s克隆的实例），需要以下附加权限：</p><ul class="list _ul"><li class="list__item" id="c4583bf5"><code class="code">iam:ListInstanceProfiles</code></li><li class="list__item" id="64fc0af6"><code class="code">iam:PassRole</code></li></ul><p id="4df751f9">定制IAM策略定义的示例（允许来自指定IP地址的所有EC2操作）：</p><div class="code-block" data-lang="bash">{“版本”：“ 2012-10-17”，“声明”：[{“ Sid”：“ 1”，“效果”：“允许”，“动作”：“ ec2：*”，“条件”：{ “ IpAddress”：{“ aws：SourceIp”：“ <teamcity server="" ip="" address="">”}}，“ Resource”：“ *”}]}</teamcity></div><a name="Optionalpermissions"></a><a name="Optional-permissions"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Optionalpermissions">可选权限</h4><p id="af7d39b8">请参阅以下<a href="#Configuring-an-Amazon-EC2-cloud-profile">部分</a> ，以获取在代理程序实例上设置IAM角色的权限。</p><p id="4b845d46">在Amazon网站上查看有关适用于<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ExamplePolicies_EC2.html" rel="noopener noreferrer" data-external="true" target="_blank">Linux</a>和<a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ExamplePolicies_EC2.html" rel="noopener noreferrer" data-external="true" target="_blank">Windows的</a>示例策略的信息。</p></div></div><a name="PreparingImagewithInstalledTeamCityAgent"></a><a name="Preparing-Image-with-Installed-TeamCity-Agent"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-PreparingImagewithInstalledTeamCityAgent">使用已安装的TeamCity Agent准备映像</h3><p id="6f19683d">以下是可用于TeamCity云集成的映像的要求：</p><ul class="list _ul"><li class="list__item" id="097b0315"><p>TeamCity代理应正确<a href="setting-up-and-running-additional-build-agents.html">安装</a> 。</p></li><li class="list__item" id="20c21df0"><p>TeamCity代理应在计算机启动时启动。</p></li><li class="list__item" id="abe993b0"><p><code class="code">buildAgent.properties</code>可以保持原样。的<code class="code">serverUrl</code> ， <code class="code">name</code>和<code class="code">authorizationToken</code>属性可以为空或设置为任何值；当TeamCity启动实例时，它们将被忽略。</p></li></ul><p id="804db624">如果满足这些要求，则适用常规TeamCity代理安装和云提供商映像捆绑程序。</p><p id="fc17099c">如果需要确保服务器和代理计算机之间的<a href="setting-up-and-running-additional-build-agents.html#Agent-Server-Data-Transfers">连接</a>安全，则需要在启动时设置代理计算机以建立到服务器的安全隧道（例如VPN），以便TeamCity代理通过安全的服务器接收数据。渠道。</p><p id="4e458b6d">推荐的图像（例如，Amazon AMI）准备步骤：</p><ol class="list _decimal"><li class="list__item" id="6750b55a"><p>选择现有的通用映像之一。</p></li><li class="list__item" id="c549c18f"><p>启动图像。</p></li><li class="list__item" id="24397fee">配置正在运行的实例：<ul class="list _ul"><li class="list__item" id="f795e9b6">安装和配置构建代理：<ul class="list _ul"><li class="list__item" id="3cf69443"><p>在中配置服务器名称和代理名称<code class="code">conf/buildAgent.properties</code> –如果映像将由TeamCity启动，则这是可选的，但对测试代理配置是否正确很有用。</p></li><li class="list__item" id="b967cc5f"><p>通常，指定<code class="code">tempDir</code>和<code class="code">workDir</code>在<code class="code">conf/buildAgent.properties</code>使用非系统驱动器（ <code class="code">d:</code>在Windows下）。</p></li></ul></li><li class="list__item" id="bca2cb24"><p>在计算机上安装构建所需的任何其他软件。</p></li><li class="list__item" id="18ad1e67"><p>运行代理，并检查它是否正常运行，并且与所有必需的构建配置兼容，依此类推。</p></li><li class="list__item" id="7100174c"><p>配置系统，以便在计算机启动时启动代理（并确保在计算机启动时可访问TeamCity服务器）。</p></li><li class="list__item" id="4084b93a"><p>对于Windows，另请参阅<a href="#Additional-configuration-for-Windows-agents">Windows代理的其他配置</a></p></li></ul></li><li class="list__item" id="6aa0be89"><p>通过重新引导计算机并检查代理是否正常连接到服务器来测试设置。</p></li><li class="list__item" id="e58d3407">准备要捆绑的图像：<ul class="list _ul"><li class="list__item" id="2ea4c410"><p>删除系统中的所有临时/历史信息。</p></li><li class="list__item" id="12ec29d5"><p>停止代理（在Windows下停止服务，但将其保留为“ <i id="9bf11835">自动</i>启动”类型）</p></li><li class="list__item" id="fdb7962b"><p>删除内容<code class="code">logs</code>和<code class="code">temp</code>代理程序主目录中的目录（可选）</p></li><li class="list__item" id="4d7783e6"><p>删除<code class="code"><Agent Home>/conf/amazon-*</code>文件（可选）</p></li><li class="list__item" id="abfb2b1a"><p>更改<code class="code">config/buildAgent.properties</code>删除属性： <code class="code">name</code> ， <code class="code">serverUrl</code> ， <code class="code">authorizationToken</code> （可选的）。 <code class="code">serverUrl</code>可以为EC2集成插件删除。其他插件可能要求它存在并设置为正确的值。</p></li></ul></li><li class="list__item" id="0ae37d57"><p>停止正在运行的实例并从中创建新图像（或者，如果已选择现有的Amazon实例作为图像源，则停止它）。</p></li></ol><a name="AdditionalconfigurationforWindowsagents"></a><a name="Additional-configuration-for-Windows-agents"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AdditionalconfigurationforWindowsagents">Windows代理的其他配置</h4><p id="4c145490"><i id="3c536128">为了确保TeamCity代理与Windows上的EC2 API进行正确的通信（包括访问其他驱动器）</i> ，请添加<a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html" rel="noopener noreferrer" data-external="true" target="_blank">AmazonSSMAgent</a>或<a href="http://docs.amazonwebservices.com/AWSEC2/latest/WindowsGuide/UsingConfig_WinAMI.html" rel="noopener noreferrer" data-external="true" target="_blank">EC2Launch / EC2Config</a>服务（该服务可确保机器完全针对AWS进行了初始化<i id="3c536128">）上</i>的TeamCity Build Agent服务的依赖项。基础架构使用）。例如，可以通过<a href="https://support.microsoft.com/en-us/kb/193888" rel="noopener noreferrer" data-external="true" target="_blank">注册表</a>或使用<a href="https://technet.microsoft.com/en-us/library/cc990290(v=ws.11).aspx" rel="noopener noreferrer" data-external="true" target="_blank">sc config</a> （例如， <code class="code">sc config TCBuildAgent depend=EC2Config</code> ）。<br>或者，您可以使用“自动（延迟启动）”服务启动模式。</p></div><a name="ImportantnoteforimagesbasedonWindowsServer2016image"></a><a name="Important-note-for-images-based-on-Windows-Server-2016-image"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-ImportantnoteforimagesbasedonWindowsServer2016image">基于Windows Server 2016映像的映像的重要说明</h4><p id="72229833">由于<a href="https://forums.aws.amazon.com/thread.jspa?threadID=242194" rel="noopener noreferrer" data-external="true" target="_blank">网络设置中</a>存在<a href="https://forums.aws.amazon.com/thread.jspa?threadID=242194" rel="noopener noreferrer" data-external="true" target="_blank">错误，因此</a>默认情况下实例元数据不可用。这意味着TeamCity代理服务无法检索其属性，并且云集成不起作用（代理未连接到服务器或未得到自动授权）。要解决此问题，请执行以下操作：</p><ol class="list _decimal"><li class="list__item" id="016fcdb5"><p>安装<a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/UsingConfig_Install.html?shortFooter=true#ec2config-update-version" rel="noopener noreferrer" data-external="true" target="_blank">最新的EC2Config</a> 。</p></li><li class="list__item" id="a712b7b7"><p>设置依赖项<code class="code">TCBuildAgent</code>两者都服务<code class="code">EC2Config</code>和<code class="code">AmazonSSMAgent</code>通过命令： <code class="code">sc config TCBuildAgent depend=Ec2Config/AmazonSSMAgent</code> 。</p></li></ol></div></div><a name="Agentauto-upgradeNote"></a><a name="Agent-auto-upgrade-Note"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Agentauto-upgradeNote">代理自动升级说明</h3><p id="228f758d">每当服务器上代理插件的分布发生更改时（例如，在TeamCity升级后），TeamCity代理都会自动升级。如果要缩短代理启动时间，则可能需要在代理插件自动更新后重新捆绑代理AMI。</p></div><a name="ConfiguringanAmazonEC2cloudprofile"></a><a name="Configuring-an-Amazon-EC2-cloud-profile"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-ConfiguringanAmazonEC2cloudprofile">配置Amazon EC2云配置文件</h3><p id="abfa820b">您可以在“ <b id="9bc396f0">项目设置”的“</b> <b id="b6756ab4">云配置文件”</b>部分中配置Amazon EC2 <a href="agent-cloud-profile.html">代理云配置</a> <b id="b6756ab4">文件</b> 。</p><a name="CustomImageName"></a><a name="Custom-Image-Name"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-CustomImageName">自定义图片名称</h4><p id="727c661c"><b id="ea578eb1">从TeamCity 2019.1开始</b> ， <i id="720ac3ca">图像</i>的“ <i id="720ac3ca">自定义图像名称”</i>参数的值用作使用该图像的所有TeamCity代理的唯一标识符。例如，此值作为前缀添加到“ <b id="35c3bb25">代理程序” |</b> “ <b id="35c3bb25">代理程序” |</b> “云配置文件”中的<b id="35c3bb25">代理</b>程序ID中<b id="35c3bb25">。云</b>标签。</p><p id="17c9c232">云配置文件中的每个映像都必须具有唯一的自定义名称。</p></div><a name="IAMprofiles"></a><a name="IAM-profiles"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-IAMprofiles">IAM配置文件</h4><p id="4008f84c">可以将IAM（身份和访问管理）配置文件与作为Amazon EC2实例启动的构建代理一起使用，这要求提供的AWS账户具有以下权限：</p><ul class="list _ul"><li class="list__item" id="0045ee40"><code class="code">iam:ListInstanceProfiles</code></li><li class="list__item" id="b73b6681"><code class="code">iam:PassRole</code></li></ul><p id="b112d57b">必须在Amazon EC2中<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html" rel="noopener noreferrer" data-external="true" target="_blank">预配置</a> IAM配置文件。在TeamCity Web UI中， <b id="e1c07665">IAM配置文件</b>下拉菜单使您可以选择角色。每个新启动的EC2实例将承担<a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/roles-usingrole-ec2instance.html" rel="noopener noreferrer" data-external="true" target="_blank">所选的IAM角色</a> 。</p></div><a name="AmazonEC2SpotInstancessupport"></a><a name="Amazon-EC2-Spot-Instances-support"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AmazonEC2SpotInstancessupport">Amazon EC2竞价型实例支持</h4><p id="b4f5743c">TeamCity的支持<a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html" rel="noopener noreferrer" data-external="true" target="_blank">亚马逊EC2实例现货</a>允许你把未使用的EC2容量出价，并使用它，只要你的建议价格超过当前的<i id="e66e5244">现货价格</i> 。</p><p id="a561a2ae">您可以在<a href="agent-cloud-profile.html">云配置文件设置中</a>为Amazon EC2映像启用竞价型实例。单击<b id="19bfe58f">添加图像，</b>然后选择<i id="3043a237">源</i> ，或编辑现有图像。选择<b id="56c5b32b">竞价型</b> <b id="bef851f2">实例</b>选项，指定<b id="56c5b32b">出价</b> ，然后保存图像。<br>如果未指定出价，则将使用默认的按需价格。</p><p id="75bca5ec"><b id="0061b60c">从2019.1版本开始</b> ，TeamCity在保存云配置文件后立即启动<b id="0061b60c">竞价型</b>实例。如果无法启动实例（例如，如果没有可用容量，或者您的出价低于亚马逊当前的最低现货价格），TeamCity将每分钟重复一次启动尝试，只要有可以在此代理上运行的已排队构建。</p><aside class="note " rel="75bca5ec" id="f0cc5b2e" data-title=""><p id="b279e430">不建议将竞价型实例用于生产关键型构建，因为<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-interruptions.html#using-spot-instances-managing-interruptions" rel="noopener noreferrer" data-external="true" target="_blank">Amazon</a>可能会<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-interruptions.html#using-spot-instances-managing-interruptions" rel="noopener noreferrer" data-external="true" target="_blank">意外终止竞价型实例</a> 。</p></aside></div><a name="AmazonEC2SpotFleetsupport"></a><a name="Amazon-EC2-Spot-Fleet-support"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AmazonEC2SpotFleetsupport">Amazon EC2 Spot Fleet支持</h4><p id="7a37142a"><i id="b3a8d1a7">竞价型队列</i>是根据预定义条件启动的<a href="#Amazon-EC2-Spot-Instances-support">竞价型实例</a>的集合。您可以请求竞价型舰队而不是常规竞价型实例，并且TeamCity将能够在您指定的可用区域中以最低价格选择并启动竞价型实例。</p><p id="ac80c612">在项目中使用Spot Fleet：</p><ol class="list _decimal"><li class="list__item" id="66b3aa34">在<a href="https://aws.amazon.com/console/" rel="noopener noreferrer" data-external="true" target="_blank">AWS Management Console中</a> ，生成Spot Fleet请求：<ul class="list _ul"><li class="list__item" id="a4e1cb88"><p>转到<b id="b1de4e82">实例|现货请求|请求竞价型实例</b> 。</p></li><li class="list__item" id="3fed8149"><p>指定所需的AMI，最小计算单元，可用区和其他请求详细信息。</p></li><li class="list__item" id="c62c16d8"><p>单击<b id="208ca7b5">JSON配置</b>以下载具有Spot Fleet配置参数的JSON文件。</p></li></ul></li></ol><p id="4b6ec9d5"></p><figure><img alt="Amazon中的Spot舰队配置生成按钮" title="Amazon中的Spot舰队配置生成按钮" src="/help/img/teamcity/2019.1/SpotFleetConfigButton.png" id="d76c298d" width="600" height="287"></figure><p></p><ol class="list _decimal" start="2"><li class="list__item" id="40ade782">在TeamCity中，将Spot Fleet添加到云配置文件中：<ul class="list _ul"><li class="list__item" id="13f6e1e1"><p>在“ <b id="1f2983ca">云配置文件”</b>页面上，单击<b id="9a9b4d46">添加映像</b> 。</p></li><li class="list__item" id="cb0a7eb6"><p>在“ <i id="5171913c">源”</i>下拉菜单中，选择“ <i id="de1b5b98">竞价型实例队列”</i> 。输入Fleet中所需的竞价型实例的最大数量（ <i id="12657426">最多实例</i> ），然后选择一个<i id="c2b6298c"><a href="agent-pools.html">代理程序池</a></i> 。</p></li><li class="list__item" id="993c3f9a"><p>在<i id="30ef013e">Spot Fleet Config</i>字段中，插入在AWS管理控制台中生成的JSON配置文件。</p></li></ul></li></ol><p id="451325f6"></p><figure><img alt="TeamCity中的现货车队配置" title="TeamCity中的现货车队配置" src="/help/img/teamcity/2019.1/SpotFleetConfig.png" id="31daae64" width="550" height="1276"></figure><p></p><ul class="list _ul"><li class="list__item" id="2458f53e"><p>保存图像。</p></li></ul><p id="6e988f55">要运行该映像，TeamCity将启动与Spot Fleet配置中指定的分配策略匹配的竞价型实例。</p><aside class="note " rel="6e988f55" id="823c5efb" data-title=""><p id="279bc510">TeamCity使用自己的值而不是JSON配置文件的以下参数：</p><ul class="list _ul"><li class="list__item" id="c9df126b"><p><code class="code">TargetCapacity</code> ：TeamCity将其设置为<code class="code">1</code>并根据<i id="5cdfd91f">最大实例</i>数运行实例</p></li><li class="list__item" id="b45580c5"><p><code class="code">TerminateInstancesWithExpiration</code> ：<code class="code">false</code></p></li><li class="list__item" id="b1ce4741"><p><code class="code">ValidFrom</code> ：创建图像的时间</p></li><li class="list__item" id="0025e47d"><p><code class="code">ValidUntil</code> ： <code class="code">ValidFrom</code>价值加5分钟</p></li><li class="list__item" id="b8073a78"><p><code class="code">Type</code> ：<code class="code">request</code></p></li></ul></aside></div><a name="AmazonEBS-OptimizedInstances"></a><a name="Amazon-EBS-Optimized-Instances"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AmazonEBS-OptimizedInstances">Amazon EBS优化的实例</h4><p id="7e7971dd">TeamCity中<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSOptimized.html" rel="noopener noreferrer" data-external="true" target="_blank">EBS优化</a>的行为类似于EC2控制台提供的行为。在配置Amazon <a href="agent-cloud-profile.html">云配置文件</a>的映像时，可以使用“实例类型”的相应框来设置优化。注意</p><ul class="list _ul"><li class="list__item" id="ed45105f"><p>默认情况下，EBS优化已打开<code class="code">c4.*</code> ， <code class="code">d2.*</code>和<code class="code">m4.*</code> （不可配置）</p></li><li class="list__item" id="43f2cad3"><p>默认情况下，对于其他任何实例类型，EBS优化均处于关闭状态，并且可以为支持该实例的实例（例如， <code class="code">c3.xlarge</code> ， 等等）</p></li></ul></div><a name="TaggingforTeamCity-launchedinstances"></a><a name="Tagging-for-TeamCity-launched-instances"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-TaggingforTeamCity-launchedinstances">标记TeamCity启动的实例</h4></div><a name="Requirements"></a><a name="Requirements"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Requirements">要求</h4><p id="30235948">标记TeamCity启动的实例必须满足以下要求：</p><ul class="list _ul"><li class="list__item" id="d62bf1a8"><p>你有<code class="code">ec2:*Tags</code>权限</p></li><li class="list__item" id="12125d53"><p>未达到您的Amazon EC2资源的<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html#tag-restrictions" rel="noopener noreferrer" data-external="true" target="_blank">最大标签数（50）</a></p></li></ul><p id="58ebd0be">在没有标签许可的情况下，TeamCity仍将启动未应用标签的Amazon AMI和EBS图像； Amazon EC2竞价型实例将不会启动。</p></div><a name="Automatictags"></a><a name="Automatic-tags"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Automatictags">自动标签</h4><p id="096fa39c">通过TeamCity，用户可以通过使用标记创建的实例来获取实例启动信息。 <code class="code">teamcity:TeamcityData</code>标签包含<code class="code"><server UUID>:-<cloud profile ID>:-<image reference>.</code></p></div><a name="Customtags"></a><a name="Custom-tags"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Customtags">自定义标签</h4><p id="536e2797">可以将自定义标签应用于EC2云代理实例：配置云配置文件设置时，在“ <b id="b98ffd38">添加映像/编辑映像”</b>对话框中，使用“ <b id="13f82bb3">实例标签</b> ：”字段以以下格式指定标签： <code class="code"><key1>=<value1>,<key2>=<value2></code> 。需要考虑<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html#tag-restrictions" rel="noopener noreferrer" data-external="true" target="_blank">亚马逊标签限制</a> 。</p><p id="c02bd76c">在标记值中使用equal（=）符号时，不需要转义。例如，字符串<code class="code">extraParam=name=John</code>将被解析成<code class="code"><key=extraParam></code>和价值<code class="code"><name=John>.</code></p></div><a name="Tagginginstance-dependentresources"></a><a name="Tagging-instance-dependent-resources"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Tagginginstance-dependentresources">标记与实例相关的资源</h4><p id="93f9b41c">启动Amazon EC2实例时，TeamCity标记与创建的实例关联的所有资源（例如，卷和网络适配器），这在评估实例的整体成本（考虑存储驱动器类型和大小，I / O操作（用于标准驱动器），网络（输出），等等。</p></div><a name="SharingsingleEBSinstancebetweenseveralTeamCityservers"></a><a name="Sharing-single-EBS-instance-between-several-TeamCity-servers"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-SharingsingleEBSinstancebetweenseveralTeamCityservers">在多个TeamCity服务器之间共享单个EBS实例</h4><p id="11a8516a"><a href="#Automatic-tags">如上所述</a> ，TeamCity使用它标记每个启动的实例<code class="code">teamcity:TeamcityData</code>代表服务器，云配置文件和源（AMI或EBS实例）的标签。因此，当多个TeamCity服务器尝试使用相同的EBS实例时，第二个服务器将看到以下消息“实例被另一TeamCity服务器使用。无法启动/停止它”。如果您确定没有其他TeamCity服务器在使用该实例，则可以删除<code class="code">teamcity:TeamcityData</code>标签，实例将再次对所有TeamCity服务器可用。</p></div></div><a name="Newinstancetypes"></a><a name="New-instance-types"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Newinstancetypes">新实例类型</h3><p id="992b5bef">由于Amazon没有提供可靠的API方法来检索所有实例类型，因此Amazon集成依赖于AWS SDK的定期更新来提供新的实例类型。</p><p id="ae9b6460">但是，有一种解决方法，如果您不愿意等待。要注册新的实例类型，请使用<code class="code">teamcity.ec2.instance.types</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性</a> ，其新实例类型之间用“，”分隔</p></div><a name="Proxysettings"></a><a name="Proxy-settings"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Proxysettings">代理设定</h3><p id="1b6290ab">如果您的TeamCity服务器需要使用代理来连接到AWS API终端节点，请配置以下服务器<a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性</a>以连接到Amazon AWS地址。</p><ul class="list _ul"><li class="list__item" id="321f4732"><p><code class="code">teamcity.http.proxy.host.ec2</code> –代理服务器主机名</p></li><li class="list__item" id="39a8602e"><p><code class="code">teamcity.http.proxy.port.ec2</code> –代理服务器端口</p></li></ul><p id="0f14da36">对于代理服务器身份验证：</p><ul class="list _ul"><li class="list__item" id="32e197d7"><p><code class="code">teamcity.http.proxy.user.ec2</code> –代理访问用户名</p></li><li class="list__item" id="718bf9e8"><p><code class="code">teamcity.http.proxy.password.ec2</code> –代理访问用户密码</p></li></ul><p id="507b349a">对于NTML身份验证：</p><ul class="list _ul"><li class="list__item" id="4a07a710"><p><code class="code">teamcity.http.proxy.domain.ec2</code> – NTLM身份验证的代理用户域</p></li><li class="list__item" id="2253fda7"><p><code class="code">teamcity.http.proxy.workstation.ec2</code> –用于NTLM身份验证的代理访问工作站</p></li></ul></div><a name="Customscript"></a><a name="Custom-script"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Customscript">自定义脚本</h3><p id="cfc20aae">可以在实例开始时运行自定义脚本（仅适用于从AMI克隆的实例）。<br>亚马逊网站详细介绍了<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" rel="noopener noreferrer" data-external="true" target="_blank">Linux</a>和<a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-instance-metadata.html#user-data-execution" rel="noopener noreferrer" data-external="true" target="_blank">Windows</a>的脚本格式。</p></div><a name="EstimatingEC2Costs"></a><a name="Estimating-EC2-Costs"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-EstimatingEC2Costs">估算EC2成本</h3><p id="4663e748">通常采用Amazon EC2定价。请注意，亚马逊的费用可能取决于为部署TeamCity实施的特定配置。我们建议您定期检查配置和Amazon帐户数据，以便尽早发现并防止意外费用。</p><p id="06fb43a7">请注意，通信量以及必要的服务器和代理计算机特性在很大程度上取决于TeamCity设置和构建运行的性质。另请参阅<a href="how-to.html#Estimate-Hardware-Requirements-for-TeamCity">TeamCity的估计硬件要求</a> 。</p></div><a name="TrafficEstimate"></a><a name="Traffic-Estimate"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-TrafficEstimate">流量估算</h3><p id="673feb73">以下几点可帮助您估算与TeamCity相关的流量：</p><ul class="list _ul"><li class="list__item" id="65412367"><p>如果TeamCity服务器不在TeamCity EC2设置中为代理配置的相同EC2区域或可用性区域内，则服务器和代理之间的流量需支付常规的Amazon EC2外部流量费用。</p></li><li class="list__item" id="7c612aa8"><p>在估算流量时，请记住与TeamCity相关的流量类型很多（请参阅下面的不完整列表）。</p></li></ul><p id="55b09431"><b id="781675a7">由服务器发起的外部连接：</b></p><ul class="list _ul"><li class="list__item" id="ea3753f0"><p>VCS服务器</p></li><li class="list__item" id="5b6ac825"><p>电子邮件和Jabber服务器</p></li><li class="list__item" id="3d625a6e"><p>Maven仓库</p></li></ul><p id="18ffb193"><b id="11b5de79">由服务器发起的内部连接：</b></p><ul class="list _ul"><li class="list__item" id="0ab0f123"><p>TeamCity代理（检查状态，发送命令，检索信息如线程转储，等等）</p></li></ul><p id="c9fab2f2"><b id="99cbfdf2">由代理发起的外部连接：</b></p><ul class="list _ul"><li class="list__item" id="ad026899"><p>VCS服务器（在代理方结帐的情况下）</p></li><li class="list__item" id="1197e1a8"><p>Maven仓库</p></li><li class="list__item" id="d0b142cc"><p>从构建过程本身执行的任何连接</p></li></ul><p id="29e74229"><b id="9c569974">由代理发起的内部连接：</b></p><ul class="list _ul"><li class="list__item" id="c8f34e19"><p>TeamCity服务器（在服务器端检出或进行个人构建，下载工件等情况下，检索构建源）</p></li></ul><p id="3ae8e6b9"><b id="8684975b">服务器提供的常规连接：</b></p><ul class="list _ul"><li class="list__item" id="0024e07a"><p>网页浏览器</p></li><li class="list__item" id="59d54de9"><p>IDE插件</p></li></ul><a name="UptimeCosts"></a><a name="Uptime-Costs"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-UptimeCosts">正常运行时间成本</h4><p id="8c7259e8">随着Amazon将机器正常运行时间舍入到最接近的整小时，请根据您通常的构建长度在TeamCity云集成设置上的EC2映像设置上调整超时设置。</p><p id="0083bf67">强烈建议为所有构建设置执行超时，以使构建挂起不会导致实例在没有有效负载的情况下长时间运行。</p><hr id="a1b9c7e0"></div></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>