<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Setting Up TeamCity for Amazon EC2 - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Setting Up TeamCity for Amazon EC2" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/teamcity-integration-with-cloud-solutions.md|TeamCity Integration with Cloud Solutions/setting-up-teamcity-for-amazon-ec2.md|Setting Up TeamCity for Amazon EC2" data-main-title="Setting Up TeamCity for Amazon EC2" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/setting-up-teamcity-for-amazon-ec2.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Setting Up TeamCity for Amazon EC2" id="setting-up-teamcity-for-amazon-ec2.md">Setting Up TeamCity for Amazon EC2</h1><p id="f8d6b34d">TeamCity Amazon EC2 integration allows you to configure TeamCity with your Amazon account and then start and stop images with TeamCity agents on-demand based on the queued builds.</p><p id="cdcd3ba7">Integrations with other cloud solutions are <a href="teamcity-integration-with-cloud-solutions.html#Available-Integrations">available</a>.</p><p id="2a2d613b">On this page:</p><p id="f74dba7d"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-GeneralDescription">General Description</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Configuration">Configuration</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-RequiredIAMpermissions">Required IAM permissions</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Optionalpermissions">Optional permissions</a></li></ul></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-PreparingImagewithInstalledTeamCityAgent">Preparing Image with Installed TeamCity Agent</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AdditionalconfigurationforWindowsagents">Additional configuration for Windows agents</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-ImportantnoteforimagesbasedonWindowsServer2016image">Important note for images based on Windows Server 2016 image</a></li></ul></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Agentauto-upgradeNote">Agent auto-upgrade Note</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-ConfiguringanAmazonEC2cloudprofile">Configuring an Amazon EC2 cloud profile</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-CustomImageName">Custom Image Name</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-IAMprofiles">IAM profiles</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AmazonEC2SpotInstancessupport">Amazon EC2 Spot Instances support</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AmazonEC2SpotFleetsupport">Amazon EC2 Spot Fleet support</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-AmazonEBS-OptimizedInstances">Amazon EBS-Optimized Instances</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-TaggingforTeamCity-launchedinstances">Tagging for TeamCity-launched instances</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Requirements">Requirements</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Automatictags">Automatic tags</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Customtags">Custom tags</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Tagginginstance-dependentresources">Tagging instance-dependent resources</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-SharingsingleEBSinstancebetweenseveralTeamCityservers">Sharing single EBS instance between several TeamCity servers</a></li></ul></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Newinstancetypes">New instance types</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Proxysettings">Proxy settings</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-Customscript">Custom script</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-EstimatingEC2Costs">Estimating EC2 Costs</a></li><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-TrafficEstimate">Traffic Estimate</a><ul class="list _bullet"><li class="list__item"><a href="#SettingUpTeamCityforAmazonEC2-UptimeCosts">Uptime Costs</a></li></ul></li></ul></li></ul></p><a name="GeneralDescription"></a><a name="General-Description"></a><div class="chapter"><h2 id="SettingUpTeamCityforAmazonEC2-GeneralDescription">General Description</h2><p id="eaaf7592">It is assumed that the machine images are preconfigured to start TeamCity agent on boot (see details <a href="#Preparing-Image-with-Installed-TeamCity-Agent">below</a>).</p><p id="764a5261">Once a cloud profile is configured in TeamCity with one or several images, TeamCity does a test start for all the new images to learn about the agents on them.<br>Once the agents are connected, TeamCity stores their parameters to be able to process the build configurations-to-agents compatibility correctly.</p><p id="c7901b34">For each queued build, TeamCity first tries to start it on one of the regular, non-cloud agents. If there are no usual agents available, TeamCity finds a matching cloud image with a compatible agent and starts a new instance for the image. TeamCity ensures that the running instances limit configured in the cloud profile is not exceeded.</p><p id="f1e002aa">Once an agent is connected from a cloud instance started by TeamCity, it is automatically authorized (provided there are available agent licenses). After that, the agent is processed as a regular agent.<br>If running timeout is configured on the cloud profile and it is reached, the instance is terminated (or stopped, if an existing Amazon instance has been selected as an image source).</p><p id="387ba46f">On the instance terminating/stopping, its disconnected agent is removed from the authorized agents list and is deleted from the system.</p><p id="6e33cd6a">TeamCity supports Amazon EC2 <a href="#Amazon-EC2-Spot-Instances-support">Spot Instances</a> and <a href="#Amazon-EC2-Spot-Fleet-support">Spot Fleets</a>.</p></div><a name="Configuration"></a><a name="Configuration"></a><div class="chapter"><h2 id="SettingUpTeamCityforAmazonEC2-Configuration">Configuration</h2><p id="26e2961c">Understanding Amazon EC2 and ability to perform EC2 tasks is a prerequisite for configuring and using TeamCity Amazon EC2 integration.</p><p id="e5f510eb">Basic TeamCity EC2 setup involves:</p><ul class="list _ul"><li class="list__item" id="a655a343"><p>preparing an Amazon EC2 image (AMI) with an installed TeamCity agent</p></li><li class="list__item" id="eb07e709"><p>configuring EC2 integration on TeamCity server</p></li></ul><aside class="note " data-title="" rel="f4a9075d" id="dd7a9abc"><p id="e0a67861">Note that the number of EC2 agents is limited by the total number of agent licenses you have in TeamCity.</p></aside><p id="c58c0563">Make sure the server URL specified on the <b id="08917037">Administration | Global Settings</b> page is correct since agents will use it to connect to the server, if a custom server URL is not specified in the <a href="agent-cloud-profile.html#Specifying-profile-settings">cloud profile settings</a>.</p><p id="305ed127">If you need TeamCity to use a proxy to access EC2 services, please read on a current workaround in the dedicated <a href="http://youtrack.jetbrains.com/issue/TW-23637#comment=27-380892" data-external="true" target="_blank" rel="noopener noreferrer">issue</a>.</p><a name="RequiredIAMpermissions"></a><a name="Required-IAM-permissions"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-RequiredIAMpermissions">Required IAM permissions</h3><p id="c0bbbd44">TeamCity requires the following permissions for Amazon EC2 Resources:</p><ul class="list _ul"><li class="list__item" id="237542e1"><code class="code">ec2:Describe*</code></li><li class="list__item" id="b6e47b2e"><code class="code">ec2:StartInstances</code></li><li class="list__item" id="24de0cbe"><code class="code">ec2:StopInstances</code></li><li class="list__item" id="cfa8e183"><code class="code">ec2:TerminateInstances</code></li><li class="list__item" id="a6769f5b"><code class="code">ec2:RebootInstances</code></li><li class="list__item" id="79631c90"><code class="code">ec2:RunInstances</code></li><li class="list__item" id="544216cd"><code class="code">ec2:ModifyInstanceAttribute</code></li><li class="list__item" id="773f8e10"><a href="#Tagging-for-TeamCity-launched-instances"><code class="code">ec2:*Tags</code></a></li></ul><p id="c4139548">To use <a href="#Amazon-EC2-Spot-Instances-support">spot instances</a>, the following additional permissions are required:</p><ul class="list _ul"><li class="list__item" id="33d8dba2"><code class="code">ec2:RequestSpotInstances</code></li><li class="list__item" id="44b0544c"><code class="code">ec2:CancelSpotInstanceRequests</code></li></ul><p id="33402da8">To use <a href="#Amazon-EC2-Spot-Fleet-support">spot fleets</a>, the following additional permissions are required:</p><ul class="list _ul"><li class="list__item" id="c1ee42f2"><code class="code">ec2:ec2:RequestSpotFleet</code></li><li class="list__item" id="1741add9"><code class="code">ec2:DescribeSpotFleetRequests</code></li><li class="list__item" id="7b7ebefd"><code class="code">ec2:CancelSpotFleetRequests</code></li></ul><p id="473e9dbd">To launch an <a href="#Configuring-an-Amazon-EC2-cloud-profile">instance with the IAM Role</a> (applicable to instances cloned from AMI-s only), the following additional permissions are required:</p><ul class="list _ul"><li class="list__item" id="c4583bf5"><code class="code">iam:ListInstanceProfiles</code></li><li class="list__item" id="64fc0af6"><code class="code">iam:PassRole</code></li></ul><p id="4df751f9">An example of custom IAM policy definition (allows all EC2 operations from a specified IP address):</p><div class="code-block" data-lang="bash">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "1",
            "Effect": "Allow",
            "Action": "ec2:*",
            "Condition": {
                "IpAddress": {
                    "aws:SourceIp": "&lt;TeamCity server IP address&gt;"
                }
            },
            "Resource": "*"
        }
    ]
}

</div><a name="Optionalpermissions"></a><a name="Optional-permissions"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Optionalpermissions">Optional permissions</h4><p id="af7d39b8">See the <a href="#Configuring-an-Amazon-EC2-cloud-profile">section below</a> for permissions to set IAM roles on an agent instance.</p><p id="4b845d46">View information on example policies for <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ExamplePolicies_EC2.html" data-external="true" target="_blank" rel="noopener noreferrer">Linux</a> and <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ExamplePolicies_EC2.html" data-external="true" target="_blank" rel="noopener noreferrer">Windows</a> on the Amazon website.</p></div></div><a name="PreparingImagewithInstalledTeamCityAgent"></a><a name="Preparing-Image-with-Installed-TeamCity-Agent"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-PreparingImagewithInstalledTeamCityAgent">Preparing Image with Installed TeamCity Agent</h3><p id="6f19683d">Here are the requirements for an image that can be used for TeamCity cloud integration:</p><ul class="list _ul"><li class="list__item" id="097b0315"><p>TeamCity agent should be correctly <a href="setting-up-and-running-additional-build-agents.html">installed</a>.</p></li><li class="list__item" id="20c21df0"><p>TeamCity agent should start on machine startup.</p></li><li class="list__item" id="abe993b0"><p><code class="code">buildAgent.properties</code> can be left as is. The <code class="code">serverUrl</code>, <code class="code">name</code>, and <code class="code">authorizationToken</code> properties can be empty or set to any value; they are ignored when TeamCity starts the instance.</p></li></ul><p id="804db624">Provided these requirements are met, usual TeamCity agent installation and cloud-provider image bundling procedures are applicable.</p><p id="fc17099c">If you need the <a href="setting-up-and-running-additional-build-agents.html#Agent-Server-Data-Transfers">connection</a> between the server and the agent machine to be secure, you will need to set up the agent machine to establish a secure tunnel (for example, VPN) to the server on boot so that TeamCity agent receives data via the secure channel.</p><p id="4e458b6d">Recommended image (for example, Amazon AMI) preparation steps:</p><ol class="list _decimal"><li class="list__item" id="6750b55a"><p>Choose one of the existing generic images.</p></li><li class="list__item" id="c549c18f"><p>Start the image.</p></li><li class="list__item" id="24397fee">Configure the running instance:<ul class="list _ul"><li class="list__item" id="f795e9b6">Install and configure a build agent:<ul class="list _ul"><li class="list__item" id="3cf69443"><p>Configure server name and agent name in <code class="code">conf/buildAgent.properties</code> – this is optional if the image will be started by TeamCity, but it is useful to test if the agent is configured correctly.</p></li><li class="list__item" id="b967cc5f"><p>It usually makes sense to specify <code class="code">tempDir</code> and <code class="code">workDir</code> in <code class="code">conf/buildAgent.properties</code> to use the non-system drive (<code class="code">d:</code> under Windows).</p></li></ul></li><li class="list__item" id="bca2cb24"><p>Install any additional software necessary for the builds on the machine.</p></li><li class="list__item" id="18ad1e67"><p>Run the agent and check it is working OK and is compatible with all necessary build configurations, and so on.</p></li><li class="list__item" id="7100174c"><p>Configure the system so that the agent is started on machine boot (and make sure TeamCity server is accessible on machine boot).</p></li><li class="list__item" id="4084b93a"><p>For Windows, see also <a href="#Additional-configuration-for-Windows-agents">Additional configuration for Windows agents</a></p></li></ul></li><li class="list__item" id="6aa0be89"><p>Test the setup by rebooting the machine and checking that the agent connects normally to the server.</p></li><li class="list__item" id="e58d3407">Prepare the Image for bundling:<ul class="list _ul"><li class="list__item" id="2ea4c410"><p>Remove any temporary/history information in the system.</p></li><li class="list__item" id="12ec29d5"><p>Stop the agent (under Windows stop the service but leave it in <i id="9bf11835">Automatic</i> startup type)</p></li><li class="list__item" id="fdb7962b"><p>Delete the content <code class="code">logs</code> and <code class="code">temp</code> directories in agent home (optional)</p></li><li class="list__item" id="4d7783e6"><p>Delete the <code class="code">&lt;Agent Home&gt;/conf/amazon-*</code> file (optional)</p></li><li class="list__item" id="abfb2b1a"><p>Change <code class="code">config/buildAgent.properties</code> to remove properties: <code class="code">name</code>, <code class="code">serverUrl</code>, <code class="code">authorizationToken</code> (optional). <code class="code">serverUrl</code> can be removed for EC2 integration plugins. Other plugins might require that it is present and set to correct value.</p></li></ul></li><li class="list__item" id="0ae37d57"><p>Stop the running instance and make a new image from it (or just stop it if an existing Amazon instance has been selected as an image source).</p></li></ol><a name="AdditionalconfigurationforWindowsagents"></a><a name="Additional-configuration-for-Windows-agents"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AdditionalconfigurationforWindowsagents">Additional configuration for Windows agents</h4><p id="4c145490"><i id="3c536128">To ensure proper TeamCity agent communication with EC2 API (including access to additional drives) on Windows</i>, add a dependency from the TeamCity Build Agent service on the <a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent.html" data-external="true" target="_blank" rel="noopener noreferrer">AmazonSSMAgent</a> or <a href="http://docs.amazonwebservices.com/AWSEC2/latest/WindowsGuide/UsingConfig_WinAMI.html" data-external="true" target="_blank" rel="noopener noreferrer">EC2Launch/EC2Config</a> service (the service which ensures the machine is fully initialized in regard to AWS infrastructure use). This can be done, for example, via the <a href="https://support.microsoft.com/en-us/kb/193888" data-external="true" target="_blank" rel="noopener noreferrer">Registry</a> or using <a href="https://technet.microsoft.com/en-us/library/cc990290(v=ws.11).aspx" data-external="true" target="_blank" rel="noopener noreferrer">sc config</a> (for instance, <code class="code">sc config TCBuildAgent depend=EC2Config</code>).<br>Alternatively, you can use the "Automatic (delayed start)" service starting mode.</p></div><a name="ImportantnoteforimagesbasedonWindowsServer2016image"></a><a name="Important-note-for-images-based-on-Windows-Server-2016-image"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-ImportantnoteforimagesbasedonWindowsServer2016image">Important note for images based on Windows Server 2016 image</h4><p id="72229833">Due to the <a href="https://forums.aws.amazon.com/thread.jspa?threadID=242194" data-external="true" target="_blank" rel="noopener noreferrer">bug in the network settings</a>, instance meta-data is not available by default. It means the TeamCity agent service cannot retrieve its properties and cloud integration doesn't work (the agent does not connect to the server or is not automatically authorized). To fix this issue, do the following:</p><ol class="list _decimal"><li class="list__item" id="016fcdb5"><p>Install the <a href="https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/UsingConfig_Install.html?shortFooter=true#ec2config-update-version" data-external="true" target="_blank" rel="noopener noreferrer">latest EC2Config</a>.</p></li><li class="list__item" id="a712b7b7"><p>Set the dependency of the <code class="code">TCBuildAgent</code> service on both <code class="code">EC2Config</code> and <code class="code">AmazonSSMAgent</code> via the command: <code class="code">sc config TCBuildAgent depend=Ec2Config/AmazonSSMAgent</code>.</p></li></ol></div></div><a name="Agentauto-upgradeNote"></a><a name="Agent-auto-upgrade-Note"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Agentauto-upgradeNote">Agent auto-upgrade Note</h3><p id="228f758d">TeamCity agent auto-upgrades whenever distribution of agent plugins on the server changes (for example, after TeamCity upgrade). If you want to cut agent startup time, you might want to rebundle the agent AMI after agent plugins have been auto-updated.</p></div><a name="ConfiguringanAmazonEC2cloudprofile"></a><a name="Configuring-an-Amazon-EC2-cloud-profile"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-ConfiguringanAmazonEC2cloudprofile">Configuring an Amazon EC2 cloud profile</h3><p id="abfa820b">You can configure an Amazon EC2 <a href="agent-cloud-profile.html">agent cloud profile</a> in the <b id="b6756ab4">Cloud Profiles</b> section of the <b id="9bc396f0">Project Settings</b>.</p><a name="CustomImageName"></a><a name="Custom-Image-Name"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-CustomImageName">Custom Image Name</h4><p id="727c661c"><b id="ea578eb1">Since TeamCity 2019.1</b>, the value of the <i id="720ac3ca">Custom Image Name</i> parameter of the image serves as a unique identifier for all TeamCity agents using this image. For example, this value is added as a prefix to agents IDs in the cloud profiles log on the <b id="35c3bb25">Agents | Cloud</b> tab.</p><p id="17c9c232">Each image in a cloud profile must have a unique custom name.</p></div><a name="IAMprofiles"></a><a name="IAM-profiles"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-IAMprofiles">IAM profiles</h4><p id="4008f84c">It is possible to use IAM (Identity and Access Management) profiles with build agents launched as Amazon EC2 instances, which requires the supplied AWS account to have the following permissions:</p><ul class="list _ul"><li class="list__item" id="0045ee40"><code class="code">iam:ListInstanceProfiles</code></li><li class="list__item" id="b73b6681"><code class="code">iam:PassRole</code></li></ul><p id="b112d57b">IAM profiles must be <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html" data-external="true" target="_blank" rel="noopener noreferrer">preconfigured</a> in Amazon EC2. In the TeamCity web UI, the <b id="e1c07665">IAM profile</b> drop-down menu enables you to select a role. Every new launched EC2 instance will assume the <a href="http://docs.aws.amazon.com/IAM/latest/UserGuide/roles-usingrole-ec2instance.html" data-external="true" target="_blank" rel="noopener noreferrer">selected IAM role</a>.</p></div><a name="AmazonEC2SpotInstancessupport"></a><a name="Amazon-EC2-Spot-Instances-support"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AmazonEC2SpotInstancessupport">Amazon EC2 Spot Instances support</h4><p id="b4f5743c">TeamCity supports <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html" data-external="true" target="_blank" rel="noopener noreferrer">Amazon EC2 Spot Instances</a> which allows you to place your bid on unused EC2 capacity and use it, as long as your suggested price exceeds the current <i id="e66e5244">Spot price</i>.</p><p id="a561a2ae">You can enable Spot Instances for an Amazon EC2 image in your <a href="agent-cloud-profile.html">cloud profile settings</a>. Click <b id="19bfe58f">Add image</b> and select a <i id="3043a237">Source</i>, or edit an existing image. Select the <b id="bef851f2">Spot instances</b> option, specify a <b id="56c5b32b">Bid price</b>, and save the image.<br>If the bid price is not specified, the default On-Demand price will be used.</p><p id="75bca5ec"><b id="0061b60c">Since version 2019.1</b>, TeamCity launches a spot instance as soon as the cloud profile is saved. If it is impossible to launch the instance (for example, if there is no available capacity or if your bid price is lower than the current minimum Spot Price in Amazon), TeamCity will be repeating the launch attempt once a minute, as long as there are queued builds which can run on this agent.</p><aside class="note " data-title="" rel="75bca5ec" id="f0cc5b2e"><p id="b279e430">It is not recommended to use spot instances for production-critical builds due to the possibility of an <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/spot-interruptions.html#using-spot-instances-managing-interruptions" data-external="true" target="_blank" rel="noopener noreferrer">unexpected spot instance termination by Amazon</a>.</p></aside></div><a name="AmazonEC2SpotFleetsupport"></a><a name="Amazon-EC2-Spot-Fleet-support"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AmazonEC2SpotFleetsupport">Amazon EC2 Spot Fleet support</h4><p id="7a37142a">A <i id="b3a8d1a7">Spot Fleet</i> is a set of <a href="#Amazon-EC2-Spot-Instances-support">Spot Instances</a> launched based on the predefined criteria. You can request a Spot Fleet instead of regular Spot Instances, and TeamCity will be able to select and launch Spot Instances with the lowest price in the availability zones you specify.</p><p id="ac80c612">To use a Spot Fleet in your project:</p><ol class="list _decimal"><li class="list__item" id="66b3aa34">In <a href="https://aws.amazon.com/console/" data-external="true" target="_blank" rel="noopener noreferrer">AWS Management Console</a>, generate a Spot Fleet request:<ul class="list _ul"><li class="list__item" id="a4e1cb88"><p>Go to <b id="b1de4e82">Instances | Spot Requests | Request Spot Instances</b>.</p></li><li class="list__item" id="3fed8149"><p>Specify the required AMI, minimum compute unit, availability zones, and other request details.</p></li><li class="list__item" id="c62c16d8"><p>Click <b id="208ca7b5">JSON config</b> to download a JSON file with the Spot Fleet configuration parameters.</p></li></ul></li></ol><p id="4b6ec9d5"><figure><img alt="Spot fleet config generation button in Amazon" title="Spot fleet config generation button in Amazon" src="/help/img/teamcity/2019.1/SpotFleetConfigButton.png" id="d76c298d" width="600" height="287"></figure></p><ol class="list _decimal" start="2"><li class="list__item" id="40ade782">In TeamCity, add a Spot Fleet to a cloud profile:<ul class="list _ul"><li class="list__item" id="13f6e1e1"><p>On the <b id="1f2983ca">Cloud Profile</b> page click <b id="9a9b4d46">Add image</b>.</p></li><li class="list__item" id="cb0a7eb6"><p>In the <i id="5171913c">Source</i> drop-down menu, select <i id="de1b5b98">Spot Instance Fleet</i>. Enter the maximum number of required Spot Instances (<i id="12657426">Max instances</i>) in a Fleet and select an <i id="c2b6298c"><a href="agent-pools.html">agent pool</a></i>.</p></li><li class="list__item" id="993c3f9a"><p>In the <i id="30ef013e">Spot Fleet Config</i> field, insert the JSON configuration file generated in AWS Management Console.</p></li></ul></li></ol><p id="451325f6"><figure><img alt="Spot Fleet configuration in TeamCity" title="Spot Fleet configuration in TeamCity" src="/help/img/teamcity/2019.1/SpotFleetConfig.png" id="31daae64" width="550" height="1276"></figure></p><ul class="list _ul"><li class="list__item" id="2458f53e"><p>Save the image.</p></li></ul><p id="6e988f55">To run the image, TeamCity will launch spot instances matching the allocation strategy specified in the Spot Fleet configuration.</p><aside class="note " data-title="" rel="6e988f55" id="823c5efb"><p id="279bc510">TeamCity uses own values instead of the following parameters of the JSON config file:</p><ul class="list _ul"><li class="list__item" id="c9df126b"><p><code class="code">TargetCapacity</code>: TeamCity sets it to <code class="code">1</code> and runs instances in accordance with the <i id="5cdfd91f">Max instances</i> number instead</p></li><li class="list__item" id="b45580c5"><p><code class="code">TerminateInstancesWithExpiration</code>: <code class="code">false</code></p></li><li class="list__item" id="b1ce4741"><p><code class="code">ValidFrom</code>: the time when the image is created</p></li><li class="list__item" id="0025e47d"><p><code class="code">ValidUntil</code>: the <code class="code">ValidFrom</code> value plus 5 minutes</p></li><li class="list__item" id="b8073a78"><p><code class="code">Type</code>: <code class="code">request</code></p></li></ul></aside></div><a name="AmazonEBS-OptimizedInstances"></a><a name="Amazon-EBS-Optimized-Instances"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-AmazonEBS-OptimizedInstances">Amazon EBS-Optimized Instances</h4><p id="7e7971dd">The behavior of <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSOptimized.html" data-external="true" target="_blank" rel="noopener noreferrer">EBS-optimization</a> in TeamCity is similar to that offered by EC2 console. When configuring an image of the Amazon <a href="agent-cloud-profile.html">cloud profile</a>, the optimization can be set using the corresponding box of the Instance Type. Note that</p><ul class="list _ul"><li class="list__item" id="ed45105f"><p>EBS-optimization is turned on by default for <code class="code">c4.*</code>, <code class="code">d2.*</code>, and <code class="code">m4.*</code> (non-configurable)</p></li><li class="list__item" id="43f2cad3"><p>EBS-optimization is turned off by default for any other instance types and  can be turned on for instances that support it (such as <code class="code">c3.xlarge</code>, and so on)</p></li></ul></div><a name="TaggingforTeamCity-launchedinstances"></a><a name="Tagging-for-TeamCity-launched-instances"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-TaggingforTeamCity-launchedinstances">Tagging for TeamCity-launched instances</h4></div><a name="Requirements"></a><a name="Requirements"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Requirements">Requirements</h4><p id="30235948">The following requirements must be met for tagging instances launched by TeamCity:</p><ul class="list _ul"><li class="list__item" id="d62bf1a8"><p>you have the <code class="code">ec2:*Tags</code> permissions</p></li><li class="list__item" id="12125d53"><p>the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html#tag-restrictions" data-external="true" target="_blank" rel="noopener noreferrer">maximum number of tags (50)</a> for your Amazon EC2 resource is not reached</p></li></ul><p id="58ebd0be">In the absence of tagging permissions, TeamCity will still launch Amazon AMI and EBS images with no tags applied; Amazon EC2 Spot Instances will not be launched.</p></div><a name="Automatictags"></a><a name="Automatic-tags"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Automatictags">Automatic tags</h4><p id="096fa39c">TeamCity enables users to get instance launch information by marking the created instances with the <code class="code">teamcity:TeamcityData</code> tag containing <code class="code">&lt;server UUID&gt;:-&lt;cloud profile ID&gt;:-&lt;image reference&gt;.</code></p></div><a name="Customtags"></a><a name="Custom-tags"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Customtags">Custom tags</h4><p id="536e2797">Custom tags can be applied to EC2 cloud agent instances: when configuring Cloud profile settings, in the <b id="b98ffd38">Add Image/Edit Image</b> dialog use the <b id="13f82bb3">Instance tags</b>: field to specify tags in the format of <code class="code">&lt;key1&gt;=&lt;value1&gt;,&lt;key2&gt;=&lt;value2&gt;</code>.  <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Using_Tags.html#tag-restrictions" data-external="true" target="_blank" rel="noopener noreferrer">Amazon tag restrictions</a> need to be considered.</p><p id="c02bd76c">When using the equal(=) sign in the tag value, no escaping is needed. For instance, the string <code class="code">extraParam=name=John</code> will be parsed into <code class="code">&lt;key=extraParam&gt;</code> and value <code class="code">&lt;name=John&gt;.</code></p></div><a name="Tagginginstance-dependentresources"></a><a name="Tagging-instance-dependent-resources"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-Tagginginstance-dependentresources">Tagging instance-dependent resources</h4><p id="93f9b41c">When launching Amazon EC2 instances, TeamCity tags all the resources (for example, volumes and network adapters) associated with the created instances, which is important when evaluating the overall cost of an instance (taking into account the storage drive type and size, I/O operations (for standard drives), network (transfers out), and so on.</p></div><a name="SharingsingleEBSinstancebetweenseveralTeamCityservers"></a><a name="Sharing-single-EBS-instance-between-several-TeamCity-servers"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-SharingsingleEBSinstancebetweenseveralTeamCityservers">Sharing single EBS instance between several TeamCity servers</h4><p id="11a8516a">As mentioned <a href="#Automatic-tags">above</a>, TeamCity tags every instance it launches with the <code class="code">teamcity:TeamcityData</code> tag that represents a server, cloud profile, and source (AMI or EBS-instance). So, when several TeamCity servers try to use the same EBS instance, the second one will see the following message "Instance is used by another TeamCity server. Unable to start/stop it". If you are sure that no other TeamCity servers are working with this instance, you can delete the <code class="code">teamcity:TeamcityData</code> tag and the instance will become available for all TeamCity servers again.</p></div></div><a name="Newinstancetypes"></a><a name="New-instance-types"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Newinstancetypes">New instance types</h3><p id="992b5bef">Since Amazon doesn't provide a robust API method to retrieve all instance types, Amazon integration relies on the periodical update of AWS SDK to make new instance types available.</p><p id="ae9b6460">However, there is a workaround if you are not willing to wait. To register new Instance Types, use the <code class="code">teamcity.ec2.instance.types</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal property</a> with new instance types separated by ","</p></div><a name="Proxysettings"></a><a name="Proxy-settings"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Proxysettings">Proxy settings</h3><p id="1b6290ab">If your TeamCity server needs to use a proxy to connect to AWS API endpoint, configure the following server <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal properties</a> to connect to Amazon AWS addresses.</p><ul class="list _ul"><li class="list__item" id="321f4732"><p><code class="code">teamcity.http.proxy.host.ec2</code> – proxy server host name</p></li><li class="list__item" id="39a8602e"><p><code class="code">teamcity.http.proxy.port.ec2</code> – proxy server port</p></li></ul><p id="0f14da36">For proxy server authentication:</p><ul class="list _ul"><li class="list__item" id="32e197d7"><p><code class="code">teamcity.http.proxy.user.ec2</code> – proxy access username</p></li><li class="list__item" id="718bf9e8"><p><code class="code">teamcity.http.proxy.password.ec2</code> – proxy access user password</p></li></ul><p id="507b349a">For NTML authentication:</p><ul class="list _ul"><li class="list__item" id="4a07a710"><p><code class="code">teamcity.http.proxy.domain.ec2</code> – proxy user domain for NTLM authentication</p></li><li class="list__item" id="2253fda7"><p><code class="code">teamcity.http.proxy.workstation.ec2</code> – proxy access workstation for NTLM authentication</p></li></ul></div><a name="Customscript"></a><a name="Custom-script"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-Customscript">Custom script</h3><p id="cfc20aae">It is possible to run a custom script on the instance start (applicable to instances cloned from AMI's only).<br>The Amazon website details the script format for <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" data-external="true" target="_blank" rel="noopener noreferrer">Linux</a> and <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/ec2-instance-metadata.html#user-data-execution" data-external="true" target="_blank" rel="noopener noreferrer">Windows</a>.</p></div><a name="EstimatingEC2Costs"></a><a name="Estimating-EC2-Costs"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-EstimatingEC2Costs">Estimating EC2 Costs</h3><p id="4663e748">Usual Amazon EC2 pricing applies. Note that Amazon charges can depend on the specific configuration implemented to deploy TeamCity. We advise you to check your configuration and Amazon account data regularly in order to discover and prevent unexpected charges as early as possible.</p><p id="06fb43a7">Note that traffic volumes and necessary server and agent machines characteristics depend a big deal on the TeamCity setup and nature of the builds run. See also <a href="how-to.html#Estimate-Hardware-Requirements-for-TeamCity">Estimate Hardware Requirements for TeamCity</a>.</p></div><a name="TrafficEstimate"></a><a name="Traffic-Estimate"></a><div class="chapter"><h3 id="SettingUpTeamCityforAmazonEC2-TrafficEstimate">Traffic Estimate</h3><p id="673feb73">Here are some points to help you estimate TeamCity-related traffic:</p><ul class="list _ul"><li class="list__item" id="65412367"><p>If TeamCity server is not located within the same EC2 region or availability zone that is configured in TeamCity EC2 settings for agents, traffic between the server and agent is subject to usual Amazon EC2 external traffic charges.</p></li><li class="list__item" id="7c612aa8"><p>When estimating traffic, bear in mind that there are lots types of traffic related to TeamCity (see a non-complete list below).</p></li></ul><p id="55b09431"><b id="781675a7">External connections originated by server:</b></p><ul class="list _ul"><li class="list__item" id="ea3753f0"><p>VCS servers</p></li><li class="list__item" id="5b6ac825"><p>Email and Jabber servers</p></li><li class="list__item" id="3d625a6e"><p>Maven repositories</p></li></ul><p id="18ffb193"><b id="11b5de79">Internal connections originated by server:</b></p><ul class="list _ul"><li class="list__item" id="0ab0f123"><p>TeamCity agents (checking status, sending commands, retrieving information like thread dumps, and so on)</p></li></ul><p id="c9fab2f2"><b id="99cbfdf2">External connections originated by agent:</b></p><ul class="list _ul"><li class="list__item" id="ad026899"><p>VCS servers (in case of agent-side checkout)</p></li><li class="list__item" id="1197e1a8"><p>Maven repositories</p></li><li class="list__item" id="d0b142cc"><p>any connections performed from the build process itself</p></li></ul><p id="29e74229"><b id="9c569974">Internal connections originated by agent:</b></p><ul class="list _ul"><li class="list__item" id="c8f34e19"><p>TeamCity server (retrieving build sources in case of server-side checkout or personal builds, downloading artifacts, and so on)</p></li></ul><p id="3ae8e6b9"><b id="8684975b">Usual connections served by the server:</b></p><ul class="list _ul"><li class="list__item" id="0024e07a"><p>web browsers</p></li><li class="list__item" id="59d54de9"><p>IDE plugins</p></li></ul><a name="UptimeCosts"></a><a name="Uptime-Costs"></a><div class="chapter"><h4 id="SettingUpTeamCityforAmazonEC2-UptimeCosts">Uptime Costs</h4><p id="8c7259e8">As Amazon rounds machine uptime to the nearest full hour, adjust timeout setting on the EC2 image setting on TeamCity cloud integration settings according to your usual builds length.</p><p id="0083bf67">It is also highly recommended to set execution timeout for all your builds so that a build hanging does not cause prolonged instance running with no payload.</p><hr id="a1b9c7e0"></div></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>