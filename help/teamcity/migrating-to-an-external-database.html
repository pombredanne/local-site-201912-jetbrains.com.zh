<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Migrating to an External Database - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Migrating to an External Database" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/migrating-to-an-external-database.md|Migrating to an External Database" data-main-title="Migrating to an External Database" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/migrating-to-an-external-database.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Migrating to an External Database" id="migrating-to-an-external-database.md">Migrating to an External Database</h1><p id="46d1fd8a">For details on using an external database from the first TeamCity start, as well as the general external database information and the database-specific configuration steps, refer to the <a href="setting-up-an-external-database.html">Setting up an External Database</a> page.</p><p id="f565396f">The current section covers the steps required to migrate TeamCity data from the database of one type to another. The most typical case is when you evaluated TeamCity with the default internal database and need to switch to an external database to prepare your TeamCity installation for production use. The steps here are also applicable when switching from one external database to another. You can also use the steps to move between database servers of the same type, but in that case the database-specific data transfer is regularly more preferable.</p><aside class="note " data-title="" rel="f565396f" id="b8eedc17"><p id="7e2a9159">Database migration cannot be combined with the server upgrade. If you want to upgrade at the same time, you should first <a href="upgrade.html">upgrade</a>, run the new version of TeamCity, and then migrate to another database.</p></aside><p id="3e849576">There are several ways to migrate data into a new database:</p><ul class="list _ul"><li class="list__item" id="46d1e9c1"><p><a href="#Switch-with-No-Data-Migration">Switch</a> with no data migration: build configurations settings will be preserved, but not the historical builds data or users.</p></li><li class="list__item" id="e8c97c83"><p><a href="#Full-Migration">Full Migration</a>: all the data is preserved except for any database-stored data provided by the third-party plugins.</p></li><li class="list__item" id="643c64bd"><p><a href="#Backup-and-Restore">Backup and then restore</a>: the same as full migration, but using the two-step approach.</p></li></ul><a name="SwitchwithNoDataMigration"></a><a name="Switch-with-No-Data-Migration"></a><div class="chapter"><h2 id="MigratingtoanExternalDatabase-SwitchwithNoDataMigration">Switch with No Data Migration</h2><p id="f7638b91">If you want a fast switch to an external database and <i id="753c81ba">do not want to preserve existing data</i> like users and builds on the server, follow the steps below. See <a href="#Full-Migration">Full Migration</a> for preserving all the data. After the switch, the server will start with an empty database, but preserve all the <i id="7621853c">settings</i> stored under TeamCity Data Directory (see <a href="manual-backup-and-restore.html">details</a> on what is stored where).</p><p id="7ad88e6e">Steps to perform the switch:</p><ol class="list _decimal"><li class="list__item" id="090e6c70"><p><a href="setting-up-an-external-database.html#Supported-Databases">Create and configure an external database</a> to be used by TeamCity.</p></li><li class="list__item" id="42b1addf"><p>Shut down the TeamCity server.</p></li><li class="list__item" id="0ea2dd39"><p><a href="teamcity-data-backup.html">Create a backup copy</a> of the &lt;<a href="teamcity-data-directory.html">TeamCity Data Directory</a>&gt; used by the server.</p></li><li class="list__item" id="aed4e0e1"><p>Clean up the <code class="code">system</code> folder: you <b id="807b7a3d">must</b> remove the <code class="code">messages</code> and <code class="code">artifacts</code> folders from the <code class="code">system</code> folder of your &lt;<a href="teamcity-data-directory.html">TeamCity Data Directory</a>&gt;; you <b id="4f509abf">may</b> delete the old HSQLDB files: <code class="code">buildserver.*</code> to remove the no longer needed internal storage data.</p></li><li class="list__item" id="20744f5c"><p>Start the TeamCity server.</p></li></ol><aside class="tip sideblock" data-title="" rel="23cf54c3" id="cba136f0"><p id="f554b7a2">If you see the <b id="28bf9387">TeamCity Maintenance</b> screen, click the <i id="fe196e2e">"Im a server administrator, show me the details"</i> link and enter the <a href="super-user.html">Super User Token</a>. Follow the instructions to create a new TeamCity database.</p></aside></div><a name="FullMigration"></a><a name="Full-Migration"></a><div class="chapter"><h2 id="MigratingtoanExternalDatabase-FullMigration">Full Migration</h2><p id="6fc02596">These steps describe switching to another database preserving all data. The TeamCity migration tool, the <code class="code">maintainDB</code> command line utility, is available for this purpose.</p><p id="6cd12adc">The <code class="code">maintainDB.[cmd|sh]</code> shell/batch script is located in the &lt;<a href="teamcity-home-directory.html">TeamCity Home  Directory</a>&gt;/bin directory and is used for migrating as well as for <a href="creating-backup-via-maintaindb-command-line-tool.html">backing up</a> and <a href="restoring-teamcity-data-from-backup.html">restoring</a> TeamCity data. The utility is only available in the TeamCity <code class="code">.tar.gz</code> and .<code class="code">exe</code> distributions. If you installed TeamCity using the <code class="code">.war distribution</code> and need to perform data migration, use the tool from the <code class="code">.tar.gz</code> distribution.</p><p id="58d7aa96">TeamCity supports <b id="c3e48631">HSQLDB</b>, <b id="dc946378">MySQL</b>, <b id="0a908be7">Oracle</b>, <b id="ca9b5a45">PostgreSQL</b> and <b id="a8c1f543">Microsoft SQL Server</b>; the migration is possible between any of these databases.</p><aside class="note " data-title="" rel="58d7aa96" id="8a8bce23"><p id="3e779d85">The target database must be empty before the migration process (it must NOT contain any tables).</p></aside><aside class="note " data-title="" rel="MigratingtoanExternalDatabase-FullMigration" id="dc138f52"><p id="99b79b1d">If an error occurs during migration, do not use the new database as it may result in the database data corruption or various errors that can uncover later. In case of an error, investigate the reason logged into the console or in the migration logs (see below), and, if a solution is found, clean the target database and repeat the migration process.</p></aside><p id="fe18d9cb"><b id="30125fdd">To migrate all your existing data to a new external database:</b></p><p id="908e6753">1. <a href="setting-up-an-external-database.html#Supported-Databases">Create and configure an external database</a> to be used by TeamCity and install the database driver into TeamCity. <b id="454f716a">Do not modify any TeamCity settings at this stage</b>.</p><p id="eb651e44">2. Shut down the TeamCity server.</p><p id="56faa930">3. Create a temporary properties file with a custom name (for example, <code class="code">database.&lt;database_type&gt;.properties</code>) for the target database using the corresponding template (&lt;<a href="teamcity-data-directory.html">TeamCity Data Directory</a>&gt;/config/database.&lt;database_type&gt;.properties.dist). Configure the properties and place the file into any temporary directory. <b id="547232bb">Do not modify the original <code class="code">database.&lt;database_type&gt;.properties</code> file</b>.</p><p id="35eb7550">4. Run the <code class="code">maintainDB</code> tool with the <code class="code">migrate</code> command and specify the absolute path to the newly created target database properties file with the <code class="code">-T</code> option:</p><div class="code-block" data-lang="bash">maintainDB.[cmd|sh] migrate [-A &lt;path to TeamCity Data Directory&gt;] -T &lt;path to database.properties file&gt;

</div><p id="11856af1">Upon the successful completion of the database migration, the temporary file will be copied to the &lt;<a href="teamcity-data-directory.html">TeamCity Data Directory</a>&gt;/config/database.properties file which will be used by TeamCity. The temporary file can be safely deleted. If you are migrating between external databases, the original <code class="code">database.properties</code> file for the source database will be replaced with the file specified via the <code class="code">-T</code> option. The original <code class="code">database.properties</code> file will be automatically renamed to <code class="code">database.properties.before.&lt;timestamp&gt;</code>.</p><aside class="tip sideblock" data-title="" rel="11856af1" id="33bb3d00"><p id="d81a83d9">If you have the <code class="code">TEAMCITY_DATA_PATH</code> environment set (pointing to the <a href="teamcity-data-directory.html">TeamCity Data Directory</a>), you do not need the <code class="code">-A &lt;path to TeamCity Data Directory&gt;</code> parameter of the tool.</p></aside><p id="b9e51444">5. Start the TeamCity server. This must be the same TeamCity version that was run last time (TeamCity <a href="upgrade.html">upgrade</a> must be performed as a separate procedure).</p><p id="9a7c2722">After you make sure the migration succeeded, you <b id="f9b4d291">may</b> delete the old HSQLDB files: <code class="code">buildserver.*</code> to remove the no longer needed internal storage data.</p><p id="7841de2f"><a name="backup_restore"></a><a name="MigratingtoanExternalDatabase-backup_restore"></a></p></div><a name="BackupandRestore"></a><a name="Backup-and-Restore"></a><div class="chapter"><h2 id="MigratingtoanExternalDatabase-BackupandRestore">Backup and Restore</h2><p id="78d512d4">You can <a href="teamcity-data-backup.html">create a backup</a> and then <a href="restoring-teamcity-data-from-backup.html">restore it</a> using different target database settings. You will probably need to specify restore options to restore only the database data.</p><a name="Troubleshooting"></a><a name="Troubleshooting"></a><div class="chapter"><h3 id="MigratingtoanExternalDatabase-Troubleshooting">Troubleshooting</h3><ul class="list _ul"><li class="list__item" id="7c20ac0a"><p id="1594f349">Extended information during migration execution is logged into the <code class="code">logs\teamcity-maintenance.log</code> file. Also, <code class="code">logs\teamcity-maintenance-truncation.log</code> contains extended information on possible data truncation during the migration process.</p></li><li class="list__item" id="dfae75c0"><p id="34d902ed">If you encounter an "out of memory" error, try increasing the number in the <code class="code">-Xmx512m</code> parameter in the <code class="code">maintainDB</code> script. On a 32-bit platform, the maximum is about 1300 megabytes.<br>Alternatively, run HSQLDB in the standalone mode via</p><div class="code-block" data-lang="java">java -Xmx256M -cp ..\webapps\ROOT\WEB-INF\lib\hsqldb.jar org.hsqldb.Server -database.0
&lt;TeamCity Data Directory&gt;\system\buildserver -dbname.0 buildserver
</div><p id="7f77ae50">and then run the Migration tool pointing to the database as the source: <code class="code">jdbc:hsqldb:hsql://localhost/buildserver sa ''</code></p></li><li class="list__item" id="5f014cdd"><p id="7f6c8941">If you get "The input line is too long." error while running the tool (e.g. this may happen on Windows 2000), change the script to use an alternative classpath method.<br>For <code class="code">maintainDB.bat</code>, remove the lines below "Add all JARs from WEB-INF\lib to classpath" comment and uncomment the lines below "Alternative classpath: Add only necessary JARs" comment.</p></li></ul><hr id="9fadf0c6"><p id="5576904f"><b id="6db6f4f7">See also:</b></p><p id="e0586f79"><b id="1e632a3d">Installation and Upgrade</b>: <a href="common-problems.html">Common database-related problems</a> | <a href="setting-up-an-external-database.html">Setting up an External Database</a><br><b id="f692aae1">Concepts</b>: <a href="teamcity-data-directory.html">TeamCity Data Directory</a><br><b id="e609e6d9">Administrator's Guide</b>: <a href="teamcity-data-backup.html">TeamCity Data Backup</a></p><hr id="9816c637"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>