<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>迁移到外部数据库-帮助|帮助团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Migrating to an External Database" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/migrating-to-an-external-database.md|Migrating to an External Database" data-main-title="Migrating to an External Database" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/migrating-to-an-external-database.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="migrating-to-an-external-database.md" data-toc="Migrating to an External Database">迁移到外部数据库</h1><p id="46d1fd8a">有关从第一个TeamCity开始使用外部数据库的详细信息，以及常规外部数据库信息和特定于数据库的配置步骤，请参阅“ <a href="setting-up-an-external-database.html">设置外部数据库”</a>页面。</p><p id="f565396f">当前部分介绍将TeamCity数据从一种类型的数据库迁移到另一种类型所需的步骤。最典型的情况是，您使用默认的内部数据库评估了TeamCity并需要切换到外部数据库来准备TeamCity安装以供生产使用。从一个外部数据库切换到另一个外部数据库时，此处的步骤也适用。您也可以使用这些步骤在相同类型的数据库服务器之间移动，但是在那种情况下，特定于数据库的数据传输通常更可取。</p><aside class="note " rel="f565396f" id="b8eedc17" data-title=""><p id="7e2a9159">数据库迁移不能与服务器升级结合使用。如果要同时升级，则应先<a href="upgrade.html">升级</a> ，运行新版本的TeamCity，然后再迁移到另一个数据库。</p></aside><p id="3e849576">有几种方法可以将数据迁移到新数据库中：</p><ul class="list _ul"><li class="list__item" id="46d1e9c1"><p>无需数据迁移即可<a href="#Switch-with-No-Data-Migration">切换</a> ：将保留构建配置设置，但不保留历史构建数据或用户。</p></li><li class="list__item" id="e8c97c83"><p><a href="#Full-Migration">完全迁移</a> ：保留所有数据，但第三方插件提供的任何数据库存储数据除外。</p></li><li class="list__item" id="643c64bd"><p><a href="#Backup-and-Restore">备份然后还原</a> ：与完全迁移相同，但是使用两步方法。</p></li></ul><a name="SwitchwithNoDataMigration"></a><a name="Switch-with-No-Data-Migration"></a><div class="chapter"><h2 id="MigratingtoanExternalDatabase-SwitchwithNoDataMigration">切换无数据迁移</h2><p id="f7638b91">如果要快速切换到外部数据库，并且<i id="753c81ba">不想保留</i>用户和服务器上的<i id="753c81ba">现有数据</i> ，请执行以下步骤。请参阅<a href="#Full-Migration">完全迁移</a>以保留所有数据。切换之后，服务器将以一个空数据库启动，但保留存储在TeamCity Data Directory下的所有<i id="7621853c">设置</i> （请参阅<a href="manual-backup-and-restore.html">有关</a>存储位置的<a href="manual-backup-and-restore.html">详细信息</a> ）。</p><p id="7ad88e6e">执行切换的步骤：</p><ol class="list _decimal"><li class="list__item" id="090e6c70"><p><a href="setting-up-an-external-database.html#Supported-Databases">创建和配置</a>要由TeamCity使用<a href="setting-up-an-external-database.html#Supported-Databases">的外部数据库</a> 。</p></li><li class="list__item" id="42b1addf"><p>关闭TeamCity服务器。</p></li><li class="list__item" id="0ea2dd39"><p><a href="teamcity-data-backup.html">创建</a>服务器使用的< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > <a href="teamcity-data-backup.html">的备份副本</a> 。</p></li><li class="list__item" id="aed4e0e1"><p>清理<code class="code">system</code>文件夹：您<b id="807b7a3d">必须</b>删除<code class="code">messages</code>和<code class="code">artifacts</code>来自的文件夹<code class="code">system</code> < <a href="teamcity-data-directory.html">TeamCity数据目录</a> >的文件夹；您<b id="4f509abf">可以</b>删除旧的HSQLDB文件： <code class="code">buildserver.*</code>删除不再需要的内部存储数据。</p></li><li class="list__item" id="20744f5c"><p>启动TeamCity服务器。</p></li></ol><aside class="tip sideblock" rel="23cf54c3" id="cba136f0" data-title=""><p id="f554b7a2">如果看到“ <b id="28bf9387">TeamCity维护”</b>屏幕，请单击<i id="fe196e2e">“我是服务器管理员，请向我显示详细信息”</i>链接，然后输入“ <a href="super-user.html">超级用户令牌”</a> 。按照说明创建新的TeamCity数据库。</p></aside></div><a name="FullMigration"></a><a name="Full-Migration"></a><div class="chapter"><h2 id="MigratingtoanExternalDatabase-FullMigration">全面迁移</h2><p id="6fc02596">这些步骤描述了切换到保留所有数据的另一个数据库。TeamCity迁移工具<code class="code">maintainDB</code>命令行实用程序可用于此目的。</p><p id="6cd12adc">的<code class="code">maintainDB.[cmd|sh]</code> shell / batch脚本位于< <a href="teamcity-home-directory.html">TeamCity主目录</a> > / bin目录中，用于迁移以及<a href="creating-backup-via-maintaindb-command-line-tool.html">备份</a>和<a href="restoring-teamcity-data-from-backup.html">还原</a> TeamCity数据。该实用程序仅在TeamCity中可用<code class="code">.tar.gz</code>和。 <code class="code">exe</code>分布。如果您使用<code class="code">.war distribution</code>并需要执行数据迁移，请使用<code class="code">.tar.gz</code>分配。</p><p id="58d7aa96">TeamCity支持<b id="c3e48631">HSQLDB</b> ， <b id="dc946378">MySQL</b> ， <b id="0a908be7">Oracle</b> ， <b id="ca9b5a45">PostgreSQL</b>和<b id="a8c1f543">Microsoft SQL Server</b> ；这些数据库之间都可以迁移。</p><aside class="note " rel="58d7aa96" id="8a8bce23" data-title=""><p id="3e779d85">在迁移过程之前，目标数据库必须为空（不得包含任何表）。</p></aside><aside class="note " rel="MigratingtoanExternalDatabase-FullMigration" id="dc138f52" data-title=""><p id="99b79b1d">如果在迁移过程中发生错误，请不要使用新数据库，因为这可能会导致数据库数据损坏或可能在以后发现的各种错误。如果发生错误，请调查登录到控制台或迁移日志中的原因（请参见下文），如果找到解决方案，请清理目标数据库并重复迁移过程。</p></aside><p id="fe18d9cb"><b id="30125fdd">要将所有现有数据迁移到新的外部数据库：</b></p><p id="908e6753">1。<a href="setting-up-an-external-database.html#Supported-Databases">创建并配置</a>供TeamCity使用<a href="setting-up-an-external-database.html#Supported-Databases">的外部数据库</a> ，并将数据库驱动程序安装到TeamCity。<b id="454f716a">在此阶段，请勿修改任何TeamCity设置</b> 。</p><p id="eb651e44">2。关闭TeamCity服务器。</p><p id="56faa930">3。使用自定义名称创建一个临时属性文件（例如， <code class="code">database.<database_type>.properties</code> ），并使用相应的模板（< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > <database_type>/config/database.properties.dist）。配置属性并将文件放置到任何临时目录中。<b id="547232bb">请勿修改原图<code class="code">database.<database_type>.properties</code>文件</b> 。</database_type></p><p id="35eb7550">4。跑过<code class="code">maintainDB</code>与工具<code class="code">migrate</code>命令并使用来指定新创建的目标数据库属性文件的绝对路径。 <code class="code">-T</code>选项：</p><div class="code-block" data-lang="bash">maintenanceDB。[cmd | sh]迁移[-A <path data="" to="" teamcity="" directory="">] -T <path to="" database.properties="" file="">

</path></path></div><p id="11856af1">成功完成数据库迁移后，临时文件将复制到< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > /config/database.properties文件，TeamCity将使用该文件。可以安全删除临时文件。如果要在外部数据库之间迁移，则原始数据库<code class="code">database.properties</code>源数据库的文件将替换为通过<code class="code">-T</code>选项。原本的<code class="code">database.properties</code>文件将自动重命名为<code class="code">database.properties.before.<timestamp></code> 。</p><aside class="tip sideblock" rel="11856af1" id="33bb3d00" data-title=""><p id="d81a83d9">如果你有<code class="code">TEAMCITY_DATA_PATH</code>环境集（指向<a href="teamcity-data-directory.html">TeamCity数据目录</a> ），则不需要<code class="code">-A <path to TeamCity Data Directory></code>工具的参数。</p></aside><p id="b9e51444">5，启动TeamCity服务器。该版本必须与上次运行的TeamCity版本相同（TeamCity <a href="upgrade.html">升级</a>必须作为单独的过程执行）。</p><p id="9a7c2722">确保迁移成功后， <b id="f9b4d291">可以</b>删除旧的HSQLDB文件： <code class="code">buildserver.*</code>删除不再需要的内部存储数据。</p><p id="7841de2f"><a name="backup_restore"></a><a name="MigratingtoanExternalDatabase-backup_restore"></a></p></div><a name="BackupandRestore"></a><a name="Backup-and-Restore"></a><div class="chapter"><h2 id="MigratingtoanExternalDatabase-BackupandRestore">备份还原</h2><p id="78d512d4">您可以<a href="teamcity-data-backup.html">创建备份</a> ，然后使用其他目标数据库设置来<a href="restoring-teamcity-data-from-backup.html">还原它</a> 。您可能需要指定还原选项以仅还原数据库数据。</p><a name="Troubleshooting"></a><a name="Troubleshooting"></a><div class="chapter"><h3 id="MigratingtoanExternalDatabase-Troubleshooting">故障排除</h3><ul class="list _ul"><li class="list__item" id="7c20ac0a"><p id="1594f349">迁移执行期间的扩展信息将登录到<code class="code">logs\teamcity-maintenance.log</code>文件。也， <code class="code">logs\teamcity-maintenance-truncation.log</code>包含有关迁移过程中可能的数据截断的扩展信息。</p></li><li class="list__item" id="dfae75c0"><p id="34d902ed">如果遇到“内存不足”错误，请尝试增加<code class="code">-Xmx512m</code>中的参数<code class="code">maintainDB</code>脚本。在32位平台上，最大约为1300兆字节。<br>或者，通过以下方式在独立模式下运行HSQLDB</p><div class="code-block" data-lang="java">java -Xmx256M -cp .. \ webapps \ ROOT \ WEB-INF \ lib \ hsqldb.jar org.hsqldb。服务器-database.0 <teamcity data="" directory="">\ system \ buildserver -dbname.0 buildserver</teamcity></div><p id="7f77ae50">然后运行迁移工具，指向数据库作为源：<code class="code">jdbc:hsqldb:hsql://localhost/buildserver sa ''</code></p></li><li class="list__item" id="5f014cdd"><p id="7f6c8941">如果显示“输入行太长”。在运行工具时出现错误（例如，在Windows 2000上可能会发生），请更改脚本以使用替代的类路径方法。<br>对于<code class="code">maintainDB.bat</code> ，请删除“将所有WEB-INF \ lib中的所有JAR添加到类路径”注释下的行，并取消注释“替代类路径：仅添加必要的JAR”注释下的行。</p></li></ul><hr id="9fadf0c6"><p id="5576904f"><b id="6db6f4f7">也可以看看：</b></p><p id="e0586f79"><b id="1e632a3d">安装和升级</b> ： <a href="common-problems.html">与数据库有关的常见问题</a> <a href="setting-up-an-external-database.html">设置外部数据库</a><br><b id="f692aae1">概念</b> ： <a href="teamcity-data-directory.html">TeamCity数据目录</a><br><b id="e609e6d9">管理员指南</b> ： <a href="teamcity-data-backup.html">TeamCity数据备份</a></p><hr id="9816c637"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>