<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>从备份还原TeamCity数据-帮助|帮助团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Restoring TeamCity Data from Backup" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/teamcity-configuration-and-maintenance.md|TeamCity Configuration and Maintenance/teamcity-data-backup.md|TeamCity Data Backup/restoring-teamcity-data-from-backup.md|Restoring TeamCity Data from Backup" data-main-title="Restoring TeamCity Data from Backup" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/restoring-teamcity-data-from-backup.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="restoring-teamcity-data-from-backup.md" data-toc="Restoring TeamCity Data from Backup">从备份还原TeamCity数据</h1><p id="e9dec095"></p><ul class="list" data-skip-index="skip"></ul><p></p><p id="ce34b0c1">TeamCity的管理员都能够恢复<a href="creating-backup-via-maintaindb-command-line-tool.html">备份数据</a>使用<code class="code">maintainDB</code>命令行实用程序。</p><aside class="note " rel="ce34b0c1" id="1e519091" data-title=""><p id="9e6e3224"><b id="b827f80f">服务器复制</b></p><p id="708a9c18">如果要创建服务器的副本，请确保还原后通过<a href="how-to.html#Copied-Server-Checklist">复制的服务器清单</a> 。</p></aside><p id="e4b139c9">您可以将备份的数据还原到相同或不同的数据库中。从/到任何<a href="supported-platforms-and-environments.html#Supported-Databases">受支持的数据库</a> （例如，您可以将数据从HSQL数据库还原到PostgreSQL数据库，以及将PostgreSQL数据库的备份还原到新的PostgreSQL数据库）。</p><p id="22dfe9f8">可以使用更高版本的TeamCity还原使用任何先前TeamCity版本创建的备份（前提是TeamCity版本晚于6.0）。</p><p id="3ee905b0">在大型数据库的还原过程中，您可能需要配置特定于数据库的设置，以使批量数据更改更快（例如将SQL Server的“恢复模型”设置为“简单”）。有关更多详细信息，请咨询您的DBA。</p><p id="8ae14e5d">TeamCity备份文件<b id="0dd7b98b">不包含构建工件</b> ，因此要使服务器具有从备份文件（至少是设置和数据库）还原所需的所有相同重要数据，并复制构建日志和工件（位于<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/system/artifacts</code> <a href="build-artifact.html">默认情况下</a> ）手动从旧数据目录切换到新数据目录。下数据的通用兼容性规则<code class="code">system/artifacts</code>是由较旧的TeamCity版本创建的文件可以由较新的版本读取，但不一定相反。</p><p id="5cadfcb6">启用<a href="configuring-artifacts-storage.html#External-Artifacts-Storage">外部工件存储</a>后，TeamCity数据目录的<a href="teamcity-configuration-and-maintenance.html#artifact-directories">工件目录</a>包含有关工件映射的元数据，因此请确保将其还原。</p><p id="96094d46">另请参见<a href="teamcity-data-directory.html">TeamCity数据目录</a>说明中有关<a href="teamcity-data-directory.html">目录的</a>详细信息。</p><a name="Performingrestore"></a><a name="Performing-restore"></a><h3 id="RestoringTeamCityDatafromBackup-Performingrestore">执行还原</h3><p id="c8edd1c8">本文档<b id="2f78935c">仅</b>描述<b id="2f78935c">了一些</b> <code class="code">maintainDB</code>选项。有关所有可用选项的完整列表，请运行<code class="code">maintainDB</code>从命令行不带参数。另请参见maintainDB <a href="creating-backup-via-maintaindb-command-line-tool.html#maintainDB-Startup-Options">启动选项</a> 。</p><p id="11e3eb10">要从备份文件执行还原：</p><ol class="list _decimal"><li class="list__item" id="e5160e0c"><p id="1c7a530b">从以下位置安装TeamCity服务器<code class="code">tar.gz</code>要么<code class="code">.exe</code>安装包。不要启动TeamCity服务器。</p></li><li class="list__item" id="2af36e16"><p id="ff2893a1">创建一个新的空<a href="teamcity-data-directory.html">TeamCity数据目录</a> 。</p></li><li class="list__item" id="ea328de3"><p id="865318b2">选择以下选项之一：</p><ul class="list _ul"><li class="list__item" id="e883ca73"><p>要将备份还原到<b id="279c1fce">新的外部数据库中</b> ，请<a href="setting-up-an-external-database.html">创建并配置一个空数据库</a> ，然后配置一个<code class="code">database.properties</code>文件，其中包含要传递给数据库设置的数据库<code class="code">restore</code>稍后再将其放入<code class="code">/config</code>新创建的<a href="teamcity-data-directory.html">TeamCity数据目录的</a>子目录，或者文件系统上TeamCity数据目录之外的任何位置。</p></li><li class="list__item" id="a7bf750c"><p>要将数据还原到<b id="2370bc5d">创建备份所用</b>的<b id="2370bc5d">同一数据库中</b> ，请继续下一步。</p></li></ul></li><li class="list__item" id="22340730"><p id="6a3bd61a">将所需的<a href="setting-up-an-external-database.html#Database-specific-Steps">数据库驱动程序</a>放入<code class="code">lib/jdbc</code>新创建的<a href="teamcity-data-directory.html">TeamCity数据目录</a>目录的子目录。</p></li><li class="list__item" id="fd228ba2"><p id="757239da">使用<code class="code">maintainDB</code>实用程序位于<code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a> <code class="code">>/bin</code>目录运行<code class="code">restore</code>命令：</p><p id="54789b74">一种。要将备份还原到<b id="cb2ab75d">新的外部数据库中</b></p><p id="d2a0a0d2">-如果<code class="code">database.properties</code>文件在TeamCity数据目录中：</p><div class="code-block" data-lang="none">maintenanceDB。[cmd | sh]恢复-A <absolute data="" path="" to="" the="" newly="" created="" teamcity="" directory="">-F <path to="" the="" teamcity="" backup="" file="">-T <config database.properties="">
</config></path></absolute></div><p id="3e05502c">-如果<code class="code">database.properties</code>文件在TeamCity数据目录之外：</p><div class="code-block" data-lang="none">maintenanceDB。[cmd | sh]恢复-A <absolute data="" path="" to="" the="" newly="" created="" teamcity="" directory="">-F <path to="" the="" teamcity="" backup="" file="">-T <absolute data="" path="" to="" the="" database.properties="" file="" of="" target="" database="" on="" system="" outside="">
</absolute></path></absolute></div><p id="0b8355d1">b。要将数据还原到<b id="43eef065">同一数据库中，备份是通过以下方式创建的</b> ：</p><div class="code-block" data-lang="none">maintenanceDB。[cmd | sh]恢复-A <absolute data="" path="" to="" the="" newly="" created="" teamcity="" directory="">-F <path to="" the="" teamcity="" backup="" file="">
</path></absolute></div><p id="dac77e25">C。要将备份还原到<b id="3ac0b3b0">内部数据库</b> ：</p><div class="code-block" data-lang="none">maintenanceDB。[cmd | sh]恢复-A <absolute data="" path="" to="" the="" newly="" created="" teamcity="" directory="">-I -F <path to="" the="" teamcity="" backup="" file="">
</path></absolute></div></li><li class="list__item" id="4b31b72f"><p id="bf6f5e9b">如果该过程成功<b id="35cc94fd">完成，</b> <a href="teamcity-data-directory.html">则要</a> <b id="35cc94fd">完成还原，</b>您需要从旧目录<b id="c789e162">复制</b> < <a href="teamcity-data-directory.html">TeamCity数据目录</a> > / system / artifacts。该目录存储构建构件，而这些构件不包含在备份文件中。</p></li></ol><p id="b96b0db9">关于的注意事项<code class="code">restore</code>命令选项：</p><ul class="list _ul"><li class="list__item" id="17c04a54"><p>的<code class="code">-A</code>如果您有<a href="teamcity-data-directory.html"><code class="code">TEAMCITY_DATA_PATH</code></a>环境变量集。</p></li><li class="list__item" id="6e3956fd"><p>的<code class="code">-F</code>参数可以是绝对路径，也可以是相对于< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > / backup目录的路径。</p></li><li class="list__item" id="be05c732"><p>的<code class="code">-T</code>参数必须指向<code class="code">database.properties</code>在步骤3中创建的文件。</p></li><li class="list__item" id="c6cf2e20"><p>如果<code class="code">-T</code>没有指定参数，并且<code class="code">database.properties</code>文件存在于新创建的文件中<code class="code">TeamCity Data Directory/config and the backup file, the database is restored using the properties file in</code> TeamCity数据目录/配置。`</p></li><li class="list__item" id="13973e52"><p>默认情况下，如果没有其他选择<code class="code">-F</code>指定后，所有备份的作用域将从备份文件中还原。要仅从备份文件还原特定范围，请使用<code class="code">maintainDB</code>效用： <code class="code">-D</code> ， <code class="code">-C</code> ， <code class="code">-U</code> ， <code class="code">-L</code>和<code class="code">-P</code> 。</p></li></ul><aside class="tip sideblock" rel="8f19d897" id="3dc8c7f2" data-title=""><p id="44a96de1">获得参考的可用选项<code class="code">maintainDB</code> ，无需任何命令或选项即可运行该实用程序。</p></aside><a name="Restoringdatabaseonly"></a><a name="Restoring-database-only"></a><h3 id="RestoringTeamCityDatafromBackup-Restoringdatabaseonly">仅还原数据库</h3><p id="1a850f23">在还原数据库但保留最新的TeamCity数据目录时，确保数据一致很重要：</p><ul class="list _ul"><li class="list__item" id="a205f725"><p>< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > / system / pluginData（ <i id="3d6b9210">补充数据</i> ）也应还原，以与存储在数据库中的数据一致</p></li><li class="list__item" id="afe3ac3f"><p>< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > / system / caches应该在服务器启动之前清除</p></li></ul><p id="7215dd20">将TeamCity数据库还原到现有服务器之前，请确保TeamCity服务器未运行。</p><p id="d0c7c4d4">要将TeamCity数据库仅从备份文件还原到现有服务器，请执行以下操作：</p><ol class="list _decimal"><li class="list__item" id="8a25502e"><p id="10dc3b3e"><a href="setting-up-an-external-database.html">创建和配置数据库</a> ，放置<code class="code">database.properties</code>归档到<code class="code">config</code>的子目录<code class="code">TeamCity Data Directory</code> 。</p></li><li class="list__item" id="1b436d5c"><p id="82295e0e">确保所需的数据库驱动程序存在于<code class="code">/lib/jdbc</code>子目录。</p></li><li class="list__item" id="3b6f5013"><p id="dded7039">使用<code class="code">maintainDB</code>位于< <a href="teamcity-home-directory.html">TeamCity主页</a> > / bin目录中的实用程序（仅在TeamCity中可用） <code class="code">.tar.gz</code>和<code class="code">.exe</code>分布）。</p></li><li class="list__item" id="624bbdab"><p id="2e2504d0">如果备份中存在<i id="b81175b4">补充数据</i> ，请删除< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > / system / pluginData目录的内容（请先考虑将其备份到另一个位置）。</p></li><li class="list__item" id="bc19fba3"><p id="692adf78">使用<code class="code">restore</code>命令（ <code class="code">-T</code>参数必须指向<code class="code">database.properties</code>在步骤1）中创建的文件：</p><div class="code-block" data-lang="none">maintenanceDB。[cmd | sh]恢复-A <absolute data="" path="" to="" teamcity="" directory="">-F <path to="" the="" teamcity="" backup="" file="">-T <path to="" the="" database.properties="" file="" of="" target="" database="">-D</path></path></absolute></div></li><li class="list__item" id="a9eb68e7"><p id="87dcb380">见<code class="code">maintainDB</code>实用程序控制台输出。您可能需要复制<code class="code">database.properties</code>如果需要，请手动归档。</p></li><li class="list__item" id="2f58a288"><p id="a70f8de9">删除< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > / system / caches目录的内容。</p></li></ol><a name="Resumingrestoreafterinterruption"></a><a name="Resuming-restore-after-interruption"></a><h3 id="RestoringTeamCityDatafromBackup-Resumingrestoreafterinterruption">中断后恢复还原</h3><p id="9b29dc7e">还原可能由于以下原因而中断：</p><ul class="list _ul"><li class="list__item" id="89b95112"><p>文件系统或数据库中空间不足</p></li><li class="list__item" id="7e281098"><p>对文件系统或数据库的权限不足。当表或索引之一无法还原时会发生中断，这在<code class="code">maintainDB</code>实用程序控制台输出。<br><b id="71f8ad72">在恢复还原之前</b> ，请从数据库中手动删除错误还原的对象。</p></li></ul><p id="2a0faf77">要在中断后恢复备份还原：<br>跑过<code class="code">maintainDB</code>实用程序<code class="code">restore</code>带有所需选项和附加命令的命令<code class="code">--continue</code>选项：</p><div class="code-block" data-lang="none"><all previously="" used="" restore="" options="">maintenanceDB</all> 。[cmd | sh]恢复- <all previously="" used="" restore="" options="">继续</all></div><hr id="598162ea"><p id="fb84a98a"><b id="fe2e31f7">也可以看看：</b></p><p id="27bbe874"><b id="1224ce51">管理员指南</b> ： <a href="creating-backup-via-maintaindb-command-line-tool.html">通过maintainDB命令行工具创建备份</a></p><hr id="668f9c23"></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>