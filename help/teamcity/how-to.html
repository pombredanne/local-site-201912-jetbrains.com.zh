<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>如何...-帮助|团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="viewpage.actionpageId113084582" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/how-to.md|How To..." data-main-title="How To..." data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/how-to.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="how-to.md" data-toc="viewpage.actionpageId113084582">如何...</h1><p id="76c79525">在此页：</p><p id="9b56c082"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#HowTo...-ChooseOS/PlatformforTeamCityServer">选择TeamCity Server的操作系统/平台</a></li><li class="list__item"><a href="#HowTo...-EstimateHardwareRequirementsforTeamCity">估算TeamCity的硬件要求</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-NetworkTrafficbetweentheServerandtheAgents">服务器和代理之间的网络流量</a></li></ul></li><li class="list__item"><a href="#HowTo...-ConfiguringTeamCityServerforPerformance">配置TeamCity Server以获得性能</a></li><li class="list__item"><a href="#HowTo...-RetrieveAdministratorPassword">检索管理员密码</a></li><li class="list__item"><a href="#HowTo...-EstimateExternalDatabaseCapacity">估计外部数据库容量</a></li><li class="list__item"><a href="#HowTo...-EstimatetheNumberofRequiredBuildAgents">估计所需的构建代理数量</a></li><li class="list__item"><a href="#HowTo...-SetupTeamCityinReplication/ClusteringEnvironment">在复制/群集环境中设置TeamCity</a></li><li class="list__item"><a href="#HowTo...-TeamCitySecurityNotes">TeamCity安全说明</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-Additionalsecurity-relatedsettings">其他与安全性相关的设置</a></li><li class="list__item"><a href="#HowTo...-Security-relatedRisksEvaluation">与安全相关的风险评估</a></li></ul></li><li class="list__item"><a href="#HowTo...-WhatEncryptionisUsedbyTeamCity">TeamCity使用什么加密</a></li><li class="list__item"><a href="#HowTo...-ConfigureNewlyInstalledMySQLServer">配置新安装的MySQL服务器</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-InnoDBdatabaseengine">InnoDB数据库引擎</a></li><li class="list__item"><a href="#HowTo...-maxconnections">max_connections</a></li><li class="list__item"><a href="#HowTo...-innodbbufferpoolsizeandinnodblogfilesize">innodb_buffer_pool_size和innodb_log_file_size</a></li><li class="list__item"><a href="#HowTo...-innodbfilepertable">innodb_file_per_table</a></li><li class="list__item"><a href="#HowTo...-innodbflushlogattrxcommit">innodb_flush_log_at_trx_commit</a></li><li class="list__item"><a href="#HowTo...-logfilesondifferentdisk">记录不同磁盘上的文件</a></li><li class="list__item"><a href="#HowTo...-SettingTheBinaryLogFormat">设置二进制日志格式</a></li><li class="list__item"><a href="#HowTo...-Enableadditionaldiagnostics">启用其他诊断</a></li></ul></li><li class="list__item"><a href="#HowTo...-ConfigureNewlyInstalledPostgreSQLServer">配置新安装的PostgreSQL服务器</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-sharedbuffers">shared_buffers</a></li><li class="list__item"><a href="#HowTo...-checkpoint-relatedparameters">检查点相关参数</a></li><li class="list__item"><a href="#HowTo...-synchronouscommit">同步提交</a></li></ul></li><li class="list__item"><a href="#HowTo...-SetUpTeamCitybehindaProxyServer">在代理服务器后面设置TeamCity</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-ProxyServerSetup">代理服务器设置</a></li><li class="list__item"><a href="#HowTo...-Apache">阿帕奇</a></li><li class="list__item"><a href="#HowTo...-NGINX">NGINX</a></li><li class="list__item"><a href="#HowTo...-Commonmisconfigurations">常见配置错误</a></li><li class="list__item"><a href="#HowTo...-Otherservers">其他服务器</a></li><li class="list__item"><a href="#HowTo...-TeamCityTomcatConfiguration">TeamCity Tomcat配置</a></li><li class="list__item"><a href="#HowTo...-Dedicated" connecto="nodeapproach" ="">专用“连接器”节点方法</a></li><li class="list__item"><a href="#HowTo...-" remoteipvalv="approach" ="">“ RemoteIpValve”方法</a></li></ul></li><li class="list__item"><a href="#HowTo...-ConfigureHTTPSforTeamCityWebUI">为TeamCity Web UI配置HTTPS</a></li><li class="list__item"><a href="#HowTo...-ConfigureTeamCitytoUseProxyServerforOutgoingConnections">配置TeamCity以使用代理服务器进行传出连接</a></li><li class="list__item"><a href="#HowTo...-ConfigureTeamCityAgenttoUseProxyToConnecttoTeamCityServer">配置TeamCity代理以使用代理连接到TeamCity服务器</a></li><li class="list__item"><a href="#HowTo...-InstallMultipleAgentsontheSameMachine">在同一台计算机上安装多个代理</a></li><li class="list__item"><a href="#HowTo...-ChangeServerPort">更改服务器端口</a></li><li class="list__item"><a href="#HowTo...-Test-driveNewerTeamCityVersionbeforeUpgrade">升级前试用新版TeamCity版本</a></li><li class="list__item"><a href="#HowTo...-CreateaCopyofTeamCityServerwithAllData">创建包含所有数据的TeamCity Server副本</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-CreateaServerCopy">创建服务器副本</a></li><li class="list__item"><a href="#HowTo...-UseTeamCityBackup">使用TeamCity备份</a></li><li class="list__item"><a href="#HowTo...-CopyManually">手动复制</a></li><li class="list__item"><a href="#HowTo...-Environmenttransferring">环境转移</a></li><li class="list__item"><a href="#HowTo...-Licensingissues">许可问题</a></li><li class="list__item"><a href="#HowTo...-CopiedServerChecklist">复制的服务器清单</a></li></ul></li><li class="list__item"><a href="#HowTo...-MoveTeamCityProjectsfromOneServertoAnother">将TeamCity项目从一台服务器移动到另一台服务器</a></li><li class="list__item"><a href="#HowTo...-MoveTeamCityInstallationtoaNewMachine">将TeamCity安装移至新计算机</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-Switchingfromoneservertoanother">从一台服务器切换到另一台</a></li></ul></li><li class="list__item"><a href="#HowTo...-MoveTeamCityAgenttoaNewMachine">将TeamCity Agent移至新计算机</a></li><li class="list__item"><a href="#HowTo...-SharetheBuildnumberforBuildsinaChainBuild">在链式构建中共享构建的内部版本号</a></li><li class="list__item"><a href="#HowTo...-MakeTemporaryBuildFilesErasedbetweentheBuilds">使生成之间删除临时生成文件</a></li><li class="list__item"><a href="#HowTo...-ClearBuildQueueifItHasTooManyBuildsduetoaConfigurationError">如果由于配置错误而导致构建数量过多，请清除构建队列</a></li><li class="list__item"><a href="#HowTo...-AutomaticallycreateorchangeTeamCitybuildconfigurationsettings">自动创建或更改TeamCity构建配置设置</a></li><li class="list__item"><a href="#HowTo...-AttachCucumberReportertoAntBuild">将Cucumber Reporter附加到Ant Build</a></li><li class="list__item"><a href="#HowTo...-GetLastSuccessfulBuildNumber">获取上一个成功的内部版本号</a></li><li class="list__item"><a href="#HowTo...-SetupDeploymentforMyApplicationinTeamCity">在TeamCity中为我的应用程序设置部署</a></li><li class="list__item"><a href="#HowTo...-UseanExternalToolthatMyBuildRelieson">使用我的构建所依赖的外部工具</a></li><li class="list__item"><a href="#HowTo...-IntegratewithBuildandReportingTools">与构建和报告工具集成</a></li><li class="list__item"><a href="#HowTo...-RestoreJustDeletedProject">恢复刚刚删除的项目</a></li><li class="list__item"><a href="#HowTo...-Transfer3DefaultAgentstoAnotherServer">将3个默认代理传输到另一台服务器</a></li><li class="list__item"><a href="#HowTo...-ImportcoverageresultsinTeamCity">在TeamCity中导入覆盖结果</a></li><li class="list__item"><a href="#HowTo...-Recoverfrom" dataformatofthedatadirectory(nnn)andthedatabase(mmm)donotmatc="error" ="">从“数据目录（NNN）的数据格式和数据库（MMM）的数据格式不匹配”中恢复</a></li><li class="list__item"><a href="#HowTo...-DebugaBuildonaSpecificAgent">在特定代理上调试构建</a></li><li class="list__item"><a href="#HowTo...-DebugaPartoftheBuild(abuildstep)">调试构建的一部分（构建步骤）</a></li><li class="list__item"><a href="#HowTo...-Vulnerabilities">漏洞</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-Heartbleed,ShellShock">伤心欲绝，ShellShock</a></li><li class="list__item"><a href="#HowTo...-POODLE">泡菜</a></li><li class="list__item"><a href="#HowTo...-GHOST">鬼</a></li><li class="list__item"><a href="#HowTo...-FREAK">怪物</a></li><li class="list__item"><a href="#HowTo...-ApacheStruts">Apache Struts</a></li></ul></li><li class="list__item"><a href="#HowTo...-WatchSeveralTeamCityServerswithWindowsTrayNotifier">观看带有Windows托盘通知程序的多个TeamCity服务器</a></li><li class="list__item"><a href="#HowTo...-PersonalUserDataProcessing">个人用户数据处理</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-TeamCityandUsersPersonalData">TeamCity和用户的个人数据</a></li><li class="list__item"><a href="#HowTo...-DeletingtheUserData">删除用户数据</a></li><li class="list__item"><a href="#HowTo...-UserAgreement">用户协议</a></li><li class="list__item"><a href="#HowTo...-Encryption">加密</a></li><li class="list__item"><a href="#HowTo...-LogsandDebuggingData">日志和调试数据</a></li><li class="list__item"><a href="#HowTo...-Customizations">客制化</a></li></ul></li><li class="list__item"><a href="#HowTo...-TeamCityReleaseCycle">TeamCity发布周期</a></li></ul><p></p><a name="ChooseOS/PlatformforTeamCityServer"></a><a name="Choose-OS/Platform-for-TeamCity-Server"></a><div class="chapter"><h2 id="HowTo...-ChooseOS/PlatformforTeamCityServer">选择TeamCity Server的操作系统/平台</h2><p id="f48ed1ed">服务器/操作系统满足<a href="supported-platforms-and-environments.html#TeamCity-Server">要求后</a> ，TeamCity即可在任何系统上运行。还请查看计划使用的集成的<a href="supported-platforms-and-environments.html">要求</a> ，例如，在Windows下安装TeamCity服务器时，以下功能需要或更好地起作用：</p><ul class="list _ul"><li class="list__item" id="ec505df0"><p>VCS与TFS集成</p></li><li class="list__item" id="61c911d3"><p>VCS与VSS集成</p></li><li class="list__item" id="e2f06a60"><p>Windows域登录（在Linux下也可以使用，但可能不稳定），尤其是NTLM HTTP身份验证</p></li><li class="list__item" id="d4b4db07"><p>服务器上的NuGet提要（也可以在Linux下工作，但可能不太稳定）</p></li><li class="list__item" id="37753373"><p>代理推送到Windows计算机</p></li></ul><p id="f2eb216b">如果没有优先选择，由于文件系统操作更有效以及所需的常规OS维护级别，Linux平台可能更可取。</p><p id="f65086dc">最终操作系统的选择可能应更多地取决于组织中的可用资源和已建立的实践。</p><p id="9b8c3bb7">如果选择安装64位操作系统，TeamCity可以在64位JDK（服务器和代理）下运行。但是，除非需要为TeamCity提供超过1Gb的内存，否则建议的方法是即使在64位OS下也要使用32位JVM。我们的经验表明，使用64位JVM不会显着提高性能。同时，它确实将内存需求增加到几乎2的大小。请参阅有关内存配置的<a href="installing-and-configuring-the-teamcity-server.html#Setting-Up-Memory-settings-for-TeamCity-Server">注释</a> 。</p></div><a name="EstimateHardwareRequirementsforTeamCity"></a><a name="Estimate-Hardware-Requirements-for-TeamCity"></a><div class="chapter"><h2 id="HowTo...-EstimateHardwareRequirementsforTeamCity">估算TeamCity的硬件要求</h2><p id="ce67fe76">服务器和代理的硬件要求不同。</p><p id="76615d0d"><b id="c4562892">代理程序</b>硬件要求基本上由运行的版本确定。运行TeamCity代理软件会要求增加CPU时间（但与构建过程的CPU要求相比通常可以忽略）和额外的内存：大约500Mb。所需的磁盘空间对应于在代理程序上运行的构建所使用的磁盘使用情况（源签出，下载的工件，在构建期间消耗的磁盘空间；所有这些都结合了定期进行的构建）。尽管您可以在与TeamCity服务器相同的计算机上运行构建代理，但是建议的方法是为每个构建代理使用单独的计算机（可能是虚拟的）。如果选择在<a href="setting-up-and-running-additional-build-agents.html#Installing-Several-Build-Agents-on-the-Same-Machine">同一台计算机</a>上安装多个代理，请考虑可能发生的CPU，磁盘，内存或网络瓶颈。<a href="performance-monitor.html">性能监视器</a>构建功能可以帮助您分析实时数据。</p><p id="f3a7f0ea"><b id="4a7c2d51">服务器</b>硬件要求取决于服务器负载，而服务器负载又取决于构建类型和服务器使用情况。请考虑以下一般准则。</p><aside class="tip sideblock" rel="f3a7f0ea" id="67cfe486" data-title=""><ul class="list _ul"><li class="list__item" id="c1168ad6"><p>如果您决定在与服务器相同的机器上运行<a href="setting-up-an-external-database.html">外部数据库</a> ，请考虑硬件要求并考虑数据库引擎的要求。</p></li><li class="list__item" id="ff0fc033"><p>如果您遇到一些与TeamCity相关的性能问题，则应单独进行调查和解决。例如，如果生成的数据太多，则服务器磁盘系统可能需要升级大小和速度特性。</p></li></ul></aside><p id="88e24812"><b id="865bcf9e">数据库说明：</b><br>广泛使用服务器时，数据库性能开始发挥更大的作用。<br>出于可靠性和性能的原因，您应该使用外部数据库。<br>查看<a href="setting-up-an-external-database.html">笔记</a>上选择外部数据库。<br>数据库大小要求自然会根据存储的数据量（构建数，测试数等）而变化。可以估计每年活动服务器数据库的使用量为几GB数据。</p><p id="6158870c"><b id="c53ffa30">TeamCity硬件资源使用概述：</b></p><ul class="list _ul"><li class="list__item" id="507bb42a"><p>CPU：TeamCity利用CPU的多个核心，因此增加核心数量是有意义的。对于平凡的TeamCity使用率，建议至少使用4个CPU内核。</p></li><li class="list__item" id="2b5dc5cf"><p>内存：由TeamCity服务器主进程和子进程使用（用于Maven集成，版本控制集成，Kotlin DSL执行）。请参阅有关主进程内存使用情况的<a href="installing-and-configuring-the-teamcity-server.html#Setting-Up-Memory-settings-for-TeamCity-Server">注释</a> 。通常，如果您不打算运行超过100个并发构建（代理），不支持200个以上的在线用户或使用大型存储库，则可能不需要为TeamCity服务器分配4G以上的内存。</p></li><li class="list__item" id="d8ab09ad"><p>HDD /磁盘使用情况：这主要来自临时目录的使用情况（ <code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a> <code class="code">>/temp</code>和操作系统默认的临时目录）和<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/system</code>用法。TeamCity服务器的性能在很大程度上取决于磁盘系统的性能。由于TeamCity在以下位置存储大量数据<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/system</code> （最值得注意的是，VCS缓存和构建结果）重要的是，对磁盘的访问要快速（特别是在多个线程中读写文件，列出具有属性的文件）。如果计划将数据目录存储在网络驱动器上，则确保磁盘具有良好的性能尤为重要。建议将本地存储用于<code class="code">TeamCity Data Directory/system/caches</code>目录。另请参见<a href="teamcity-data-directory.html#Recommendations-as-to-choosing-Data-Directory-Location">TeamCity数据目录</a> 。</p></li><li class="list__item" id="c86fe4eb"><p>网络：这主要是从VCS服务器到客户端（Web浏览器，IDE等）和构建代理（发送源，接收构建结果，日志和工件）之间的流量的总和。</p></li></ul><p id="0ab3b8ac"><b id="569a0ee7">服务器上的负载取决于：</b></p><ul class="list _ul"><li class="list__item" id="29774347"><p>构建配置数量；</p></li><li class="list__item" id="000f744e"><p>历史上的建筑数量；</p></li><li class="list__item" id="aa5ed6d2"><p>每天运行的内部版本数；</p></li><li class="list__item" id="59a0e09f"><p>构建消耗和生成的数据量（使用的源和工件的大小，构建日志的大小，单元测试的数量和输出大小，检查和重复命中的次数，生成的工件的大小和数量，等等） ;</p></li><li class="list__item" id="35a84f82"><p>配置的清理规则</p></li><li class="list__item" id="3c88b688"><p>代理商数量及其利用率</p></li><li class="list__item" id="6536d67f"><p>打开TeamCity网页的用户数量；</p></li><li class="list__item" id="6d6fbf15"><p>从IDE插件登录的用户数；</p></li><li class="list__item" id="2af0dafb"><p>VCS根的数量和类型，以及为VCS根配置的更改间隔检查。VCS检出模式也很重要：服务器检出模式会产生更大的服务器负载。特定类型的VCS也会影响服务器负载，但是可以根据本机VCS客户端性能粗略估算它们。</p></li><li class="list__item" id="c41f02d8"><p>TeamCity每天在所有VCS根目录中检测到的更改数量；</p></li><li class="list__item" id="5652f8e7"><p>TeamCity与之合作的存储库的大小；</p></li><li class="list__item" id="383b9e96"><p>TeamCity每天检出的资源的总大小。</p></li></ul><p id="d65aace3">能够处理多达100个并发运行的构建并且仅运行TeamCity服务器的硬件配置的一般示例可以是：<br>适用于服务器的现代多核CPU，8Gb内存，快速的网络连接，快速可靠的HDD，快速的外部数据库访问。</p><p id="3af2bbab">根据我们的经验，适度的硬件（例如Intel 3.2 GHz双核CPU，Windows下的3.2Gb内存，1Gb网络适配器，单个HDD）可以为以下设置提供可接受的性能：</p><ul class="list _ul"><li class="list__item" id="5f056a1e"><p>60个项目和300个构建配置（其中一个处于活动状态并定期运行）；</p></li><li class="list__item" id="718d4d08"><p>每天有300多个建筑物；</p></li><li class="list__item" id="4aebe164"><p>每个版本大约2Mb日志；</p></li><li class="list__item" id="95650c26"><p>50名建筑代理商；</p></li><li class="list__item" id="30cb92d3"><p>50个Web用户和30个IDE用户；</p></li><li class="list__item" id="044e301f"><p>100个VCS根目录（主要是使用服务器检出的Perforce和Subversion），平均检查更改间隔为120秒；</p></li><li class="list__item" id="e3e194cd"><p>每天超过150次更改；</p></li><li class="list__item" id="ace35d59"><p>未使用Kotlin DSL；</p></li><li class="list__item" id="a8e6f3d1"><p>数据库（MySQL）在同一台计算机上运行；</p></li><li class="list__item" id="33f1addc"><p>TeamCity服务器进程具有<code class="code">-Xmx1100m</code> JVM设置。</p></li></ul><p id="24991ce2">以下配置可以为负载更重的TeamCity服务器提供可接受的性能：<br>Intel Xeon E5520 2.2 GHz CPU（4个核心，8个线程），Windows Server 2008 R2 x64下的12Gb内存，1Gb网络适配器，3个HDD RAID1磁盘（通用，一个用于工件，日志和缓存存储，一个用于数据库存储）</p><p id="3df371f9"><b id="c8e4f33d">服务器负载特征：</b></p><ul class="list _ul"><li class="list__item" id="fee2290e"><p>150个项目和1500个构建配置（其中三分之一处于活动状态并定期运行）；</p></li><li class="list__item" id="0c228ec7"><p>每天建造1500多个；</p></li><li class="list__item" id="991717f3"><p>每个版本约4Mb日志；</p></li><li class="list__item" id="3e52ed1c"><p>100名建筑代理商；</p></li><li class="list__item" id="191abf2c"><p>150个Web用户和40个IDE用户；</p></li><li class="list__item" id="2c83698e"><p>250个VCS根目录（主要是使用代理端检出的Git，Hg，Perforce和Subversion），平均检查更改间隔为180秒；</p></li><li class="list__item" id="c3ac6208"><p>每天超过1000次更改；</p></li><li class="list__item" id="2b60305b"><p>数据库（MySQL）在同一台计算机上运行；</p></li><li class="list__item" id="7216df81"><p>TeamCity服务器进程具有<code class="code">-Xmx3700m</code> x64 JVM设置。</p></li></ul><p id="de5e36d8">但是，为了确保可以很好地处理峰值负载，建议使用功能更强大的硬件。</p><p id="b0dede76">HDD的可用空间需求主要由存储在服务器上的构建数量以及每个构建中的构件大小/构建日志大小确定。服务器磁盘存储还用于存储与VCS相关的缓存，您可以估算出该值是服务器上配置的所有VCS根的签出大小的两倍。</p><p id="6e259972">如果构建生成大量数据（工件/构建日志/测试数据），请使用快速硬盘进行存储<code class="code">.BuildServer/system</code>建议使用目录和代理与服务器之间的快速网络。</p><p id="04e364b0">部署大规模TeamCity安装的一般建议是从考虑硬件升级的合理硬件开始。然后逐渐增加服务器上的负载（例如添加更多项目），监视性能特征并确定必要的硬件或软件改进。还有一个<a href="https://confluence.jetbrains.com/display/TW/TeamCity+Benchmark" rel="noopener noreferrer" data-external="true" target="_blank">基准插件</a> ，可用于估计当前服务器安装可以处理的同时构建数量。无论如何，建议最佳管理实践，例如保持足够的磁盘碎片整理级别，等等。</p><p id="671fba1f">从适当加载的系统开始，如果随后将并发运行的内部版本（代理）的数量增加某个倍数，则准备将CPU，数据库和HDD的访问速度，内存量增加相同的倍数，以实现相同的性能。<br>如果增加每天的内部版本数，请准备增加磁盘大小。</p><p id="347c1c69">如果您考虑为TeamCity代理部署云（例如，在Amazon EC2上），还请查看<a href="setting-up-teamcity-for-amazon-ec2.html#Estimating-EC2-Costs">为Amazon EC2设置TeamCity</a></p><p id="24e876c4">关于JetBrains内部TeamCity安装中的代理设置的说明：<br>我们既使用分别运行一个代理的单独计算机，又使用运行多个虚拟机的专用“服务器”，每个虚拟机都安装了一个代理。当每台core7i物理机运行3个虚拟代理（每个代理使用单独的硬盘）时，我们在配置硬件和软件时进行了试验。这是因为我们的（主要是Java）构建首先取决于HDD性能。但是YMMV。</p><p id="3e9e71bb">众所周知，TeamCity可与500多个构建代理（500个同时运行的构建主动记录构建运行时数据）配合使用。在综合测试中，该服务器可以运行多达1000个并发构建（包括8个核，在Linux下运行的总内存为32Gb的服务器以及在单独的可比较机器上运行的MySQL服务器）的运行正常。每个构建所产生的服务器负载取决于构建所产生的数据量（构建日志，测试编号和故障详细信息，检查/重复问题编号等）。保持合理的数据量限制（将较大的输出作为构建工件发布，而不是将其打印到标准输出中；调整检查配置文件以报告有限的最重要的检查命中集等）将有助于扩展服务器以处理更多的并发构建。<br>如果您需要更多的代理/并行构建，建议使用<a href="multinode-setup.html">几个节点设置</a> 。如果需要大量代理，建议考虑使用几个单独的TeamCity实例并在它们之间分配项目。我们一直致力于TeamCity的性能改进，并愿意与运行大型TeamCity安装的组织紧密合作，以研究任何性能问题并改进TeamCity以处理更大的负载。另请参阅有关<a href="http://blog.jetbrains.com/teamcity/2015/08/benchmarking-teamcity/" rel="noopener noreferrer" data-external="true" target="_blank">TeamCity可以处理</a>的<a href="http://blog.jetbrains.com/teamcity/2015/08/benchmarking-teamcity/" rel="noopener noreferrer" data-external="true" target="_blank">最大座席数的</a>相关文章</p><p id="78d2ce0b">另请参阅相关文章： <a href="http://blogs.jetbrains.com/teamcity/2011/09/05/improving-performance-and-scalability-of-your-teamcity-server/" rel="noopener noreferrer" data-external="true" target="_blank">大量TeamCity设置的描述</a> 。</p><a name="NetworkTrafficbetweentheServerandtheAgents"></a><a name="Network-Traffic-between-the-Server-and-the-Agents"></a><div class="chapter"><h3 id="HowTo...-NetworkTrafficbetweentheServerandtheAgents">服务器和代理之间的网络流量</h3><p id="e15b26e6">通信量主要取决于设置，因为其中一些设置包括在代理和服务器之间传输二进制文件。<br>代理程序和服务器之间最重要的通信流是：</p><ul class="list _ul"><li class="list__item" id="e52d13bd"><p>代理从服务器检索命令：这些通常是构建开始任务，基本上包括构建配置设置和完整构建参数集的转储。在大型构建链的情况下，后者可能很大（例如，兆字节）。可以在构建的“ <a href="working-with-build-results.html#Parameters">参数”选项卡</a>上查看<a href="working-with-build-results.html#Parameters">参数</a> ；</p></li><li class="list__item" id="5b3a40bd"><p>代理会定期将当前状态数据发送到服务器（包括所有代理参数，可以在代理的“ <a href="viewing-build-agent-details.html#Agent-Parameters">代理参数”</a>选项卡上进行查看）；</p></li><li class="list__item" id="5184fa31"><p>在构建期间，代理将构建日志消息和参数数据发送回服务器。可以在<a href="working-with-build-results.html#Build-Log">构建的“构建日志”</a>和“ <a href="working-with-build-results.html#Parameters">参数”</a>选项卡上查看这些内容。</p></li><li class="list__item" id="a7714bd1"><p>（使用服务器端检出模式时），代理会在从服务器（作为完整补丁或增量补丁）构建之前下载源。</p></li><li class="list__item" id="19d4266a"><p>（配置了<a href="artifact-dependencies.html">构件依赖项</a>时）代理程序在开始构建之前会从服务器下载其他构建的构件。</p></li><li class="list__item" id="7a682590"><p>（当为构件配置构件时），代理将构件构件上载到服务器；</p></li><li class="list__item" id="dc43b672"><p>一些竞争者（例如覆盖率或代码分析）包括将其结果报告自动上载到服务器。</p></li></ul></div></div><a name="ConfiguringTeamCityServerforPerformance"></a><a name="Configuring-TeamCity-Server-for-Performance"></a><div class="chapter"><h2 id="HowTo...-ConfiguringTeamCityServerforPerformance">配置TeamCity Server以获得性能</h2><p id="a8c1a067">以下是一些调整TeamCity服务器设置以提高性能的建议。<a href="installing-and-configuring-the-teamcity-server.html#Configuring-Server-for-Production-Use">生产服务器使用</a>列表是先决条件：</p><ul class="list _ul"><li class="list__item" id="2cac8afa"><p>定期查看报告的服务器运行状况报告（包括隐藏的报告）</p></li><li class="list__item" id="c36f1ef9"><p>使用单独的<a href="#Set-Up-TeamCity-behind-a-Proxy-Server">反向代理</a>服务器（例如NGINX）来处理HTTPS</p></li><li class="list__item" id="e3249d82"><p>对外部数据库使用单独的服务器并监视数据库性能</p></li><li class="list__item" id="3053b9d3"><p>监视服务器的CPU和IO性能，必要时增加硬件资源（另请参阅<a href="#Estimate-Hardware-Requirements-for-TeamCity">硬件说明</a> ）</p></li><li class="list__item" id="eda7a114"><p>确保使用适当的保留策略为所有项目配置了清理，并确保清理完全定期完成（请查看“管理/清理”页面）</p></li><li class="list__item" id="64f8783e"><p>考虑确保以下各项的良好IO性能： <code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/system/caches</code>目录，例如通过将其移动到单独的本地驱动器（或存储在本地驱动器上，您选择将TeamCity数据目录存储在网络存储上）</p></li><li class="list__item" id="a8982566"><p>定期存档过时的项目</p></li><li class="list__item" id="02eb8034"><p>定期检查已安装但未捆绑的插件，并删除那些对于服务器正常运行不重要的插件</p></li><li class="list__item" id="aa1c983e"><p>考虑尽可能使用代理方结帐</p></li><li class="list__item" id="678a3548"><p>确保构建日志不大（最多数十兆，最好小于10 Mb）</p></li><li class="list__item" id="43b8e73d"><p>如果在服务器上配置了很多VCS根目录，请考虑配置<a href="configuring-vcs-post-commit-hooks-for-teamcity.html">存储库提交挂钩，</a>而不是使用轮询进行更改，或者至少将<a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS轮询间隔</a>增加到300秒或更多</p></li><li class="list__item" id="fe742c30"><p>如果服务器经常被大量用户使用（例如，超过1000个），请考虑通过增加<a href="teamcity-tweaks.html#Web-Page-Refresh-Interval">UI刷新间隔来</a>减少后台UI请求的频率</p></li><li class="list__item" id="82b9ba1e"><p>当定期超过500个同时运行的内部版本记录大量数据时，请考虑使用“ <a href="multinode-setup.html">多个节点设置”</a></p></li></ul></div><a name="RetrieveAdministratorPassword"></a><a name="Retrieve-Administrator-Password"></a><div class="chapter"><h2 id="HowTo...-RetrieveAdministratorPassword">检索管理员密码</h2><p id="d9e9ad6f">在首次使用空数据库开始时，TeamCity将显示“管理员设置”页面，该页面允许创建具有完全管理权限的用户（分配<a href="role-and-permission.html#Per-Project-Authorization-Mode">系统管理员</a>角色）。</p><p id="b61c73a2">如果要重新获得对系统的访问权限，并且不能以具有系统管理员角色的用户身份登录，则可以以<a href="super-user.html">超级用户</a>身份登录并更改现有的管理员帐户密码，或者以系统管理员角色创建新帐户。</p><p id="a7e94697">也可以使用<a href="rest-api.html#Making-user-a-system-administrator">REST API</a>将系统管理员角色添加到任何现有用户。</p><p id="3b48c804">如果您使用内置身份验证并指定了正确的电子邮件，则可以从登录页面<a href="managing-your-user-account.html#Changing-Your-Password">重置密码</a> 。</p></div><a name="EstimateExternalDatabaseCapacity"></a><a name="Estimate-External-Database-Capacity"></a><div class="chapter"><h2 id="HowTo...-EstimateExternalDatabaseCapacity">估计外部数据库容量</h2><p id="623556c9">设置或迁移到外部数据库时，很难提供准确的数字，因为所需的容量会因TeamCity的使用方式而异。</p><p id="9e6376dc">数据库大小和数据库性能是要考虑的关键方面。</p><p id="b90cbb56"><b id="6ea8d20c">数据库大小</b></p><p id="adf835d8">数据库的大小取决于：</p><ul class="list _ul"><li class="list__item" id="fc737b4d"><p>每天开始多少次构建</p></li><li class="list__item" id="a1482f90"><p>生成报告了多少测试</p></li><li class="list__item" id="179b2855"><p><a href="clean-up.html">清理</a>规则（保留政策）</p></li><li class="list__item" id="d4d72845"><p>清理时间表</p></li></ul><p id="6fe1179d">我们建议数据空间的初始大小为4 GB。从内部数据库迁移时，建议至少将当前内部数据库的大小增加一倍。例如，JetBrains中内部TeamCity服务器的外部数据库（不包括重做日志文件）的大小约为50 GB。将数据库设置为自动增长有助于在必要时将文件大小增加到预定限制，从而最大程度地减少了监视磁盘空间的工作。</p><p id="78054dd8">在大多数情况下，为重做日志（请参阅下表）和撤消文件分配1 GB就足够了。</p><p id="530a8f57"><b id="ce52273b">数据库性能</b></p><p id="2e4b7226">要考虑以下因素：</p><ul class="list _ul"><li class="list__item" id="027bdead"><p>数据库类型（RDBMS）</p></li><li class="list__item" id="d28a8db4"><p>代理数量（实际上意味着并行运行的构建数量）</p></li><li class="list__item" id="42423594"><p>所有用户打开的网页数</p></li><li class="list__item" id="52ee3985"><p><a href="clean-up.html">清理</a>规则（保留政策）</p></li></ul><p id="73e8f25a">建议放置<a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a>和物理上不同的硬盘上的数据库数据文件（即使TeamCity服务器和RDBMS共享同一主机）。</p><p id="10e120a8">还建议将重做日志放在单独的物理磁盘上，特别是在代理数量过多（50个及更多）的情况下。</p><p id="343eddda"><b id="09d264db">特定于数据库的注意事项</b></p><p id="822c2381">为不同的RDBMS命名的<i id="0780919b">重做</i>日志（或类似实体）：</p><div class="table-wrapper"><table width="100%" id="34513444"><thead><tr id="60e94a6d" class="ijRowHead"><th id="a1ed6c25"><p id="bba03a70">关系数据库管理系统</p></th><th id="4c0abee1"><p id="e4a30fa8">日志名称</p></th></tr></thead><tbody><tr id="504bdcf8" class="ijRowOdd"><td id="dae1fc0f"><p id="89e95258">甲骨文</p></td><td id="6ad18508"><p id="9641f55e">重做日志</p></td></tr><tr id="c9f64e7a" class="ijRowEven"><td id="056a492c"><p id="32b3e39c">MS SQL服务器</p></td><td id="c2f18658"><p id="848efe5a">交易记录</p></td></tr><tr id="7f43f956" class="ijRowOdd"><td id="4174c081"><p id="e5053822">PostgreSQL的</p></td><td id="9fd9e6fe"><p id="c120141c">WAL（预写日志）</p></td></tr><tr id="c37675ca" class="ijRowEven"><td id="97a0d3a1"><p id="367e9456">MySQL + InnoDB和Percona</p></td><td id="e4189560"><p id="da38202c">重做日志</p></td></tr></tbody></table></div><p id="2f01619d">PostgreSQL：我们建议使用9.2+版本，该版本具有很多查询优化功能。另请参阅<a href="http://www.postgresql.org/docs/9.2/static/wal-internals.html" rel="noopener noreferrer" data-external="true" target="_blank">PostgreSQL文档</a>中有关预写日志（WAL）的<a href="http://www.postgresql.org/docs/9.2/static/wal-internals.html" rel="noopener noreferrer" data-external="true" target="_blank">信息。</a></p><p id="4ee08bcc">Oracle：建议保留统计信息：应启用所有自动收集的统计信息（从Oracle 10.0开始，这是默认设置）。另请参阅<a href="https://docs.oracle.com/cd/B14117_01/server.101/b10752/iodesign.htm#26022" rel="noopener noreferrer" data-external="true" target="_blank">Oracle文档中</a>有关重做日志文件的信息。</p><p id="806df37e">MS SQL Server：不建议使用jTDS驱动程序：不适用于<code class="code">nchar/nvarchar</code> ，并且要保留unicode流，这可能会导致查询花费很长时间并消耗大量IO。另请参阅<a href="https://support.microsoft.com/kb/2033523" rel="noopener noreferrer" data-external="true" target="_blank">Microsoft知识库中</a>有关重做日志的信息。如果您使用jTDS，请<a href="setting-up-an-external-database.html#jTDS-driver">迁移</a> 。</p><p id="bd41d981">MySQL：查询优化器可能效率低下：某些查询可能执行错误的计划，导致它们花费很长时间并消耗大量IO。</p></div><a name="EstimatetheNumberofRequiredBuildAgents"></a><a name="Estimate-the-Number-of-Required-Build-Agents"></a><div class="chapter"><h2 id="HowTo...-EstimatetheNumberofRequiredBuildAgents">估计所需的构建代理数量</h2><p id="4d03b261">没有精确的数据，所需的构建代理程序的数量在很大程度上取决于服务器使用模式，构建类型，团队规模，团队对CI流程的承诺等。<br>最好的方法是从默认的3个代理开始，并查看它们如何与已配置的项目一起使用，然后基于此进行进一步估计。</p><p id="311d3862">看到以下信息时，您可能希望增加座席数量：</p><ul class="list _ul"><li class="list__item" id="70fa191e"><p>在构建队列中等待空闲代理的构建；</p></li><li class="list__item" id="d80c2ce6"><p>每个构建中包含的更改多于您觉得舒适的程度（例如，构建失败分析）；</p></li><li class="list__item" id="44088140"><p>不同环境的必要性。我们已经看到了每20个构建配置（构建类型）中都有一个代理的模式。或每1-2个开发人员使用一个构建代理。</p></li></ul><p id="0b6b3669">另请参阅有关支持的最大代理数的<a href="#Estimate-Hardware-Requirements-for-TeamCity">注释</a> 。</p></div><a name="SetupTeamCityinReplication/ClusteringEnvironment"></a><a name="Setup-TeamCity-in-Replication/Clustering-Environment"></a><div class="chapter"><h2 id="HowTo...-SetupTeamCityinReplication/ClusteringEnvironment">在复制/群集环境中设置TeamCity</h2><p id="937ac023">TeamCity仅支持主服务器的单个实例，但是可以添加<a href="configuring-secondary-node.html">辅助节点</a>以在当前数据上提供仅查看的UI，并从代理收集运行中的构建数据。所有节点都需要连接到同一节点<a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a>和数据库。</p><p id="4cbb64d2">为了解决快速灾难恢复的情况，TeamCity支持活动-故障转移（冷备用）方法：可以复制TeamCity服务器使用的数据，并且可以采用一种解决方案，以在当前活动的服务器发生故障时使用相同的数据来启动新服务器。</p><p id="26ebbf50">对于数据，TeamCity服务器同时使用数据库和文件存储（数据目录）。您可以浏览<a href="teamcity-data-backup.html">TeamCity数据备份</a>和<a href="teamcity-data-directory.html">TeamCity数据目录</a>页面，以获取有关TeamCity数据存储的更多信息。基本上，磁盘上的TeamCity数据目录和TeamCity使用的数据库都必须保持一致状态，因此必须一起复制。<br>任何时候，只有一个TeamCity服务器实例应使用数据库和数据目录。</p><p id="1706151e">确保TeamCity故障转移/备份服务器的分发版本与主服务器的版本完全相同。确保相同的服务器环境/启动选项（如内存设置等）也很重要。</p><p id="dc81c469">TeamCity代理服务器场可以在主服务器和故障转移服务器之间重用。如果您使故障转移服务器通过旧服务器DNS名称进行解析，则代理将自动连接到新服务器，并且代理将使用DNS名称连接到服务器。另请参阅有关从一台服务器<a href="#Switching-from-one-server-to-another">切换</a>到另一台服务器的信息。<br>如果合适，可以像服务器一样复制代理。但是，除了conf \ buildAgent.properties文件外，无需在代理上复制任何TeamCity特定的数据，因为通常可以从服务器续订所有其余数据。如果是复制代理场，则只需将复制代理连接到故障转移服务器。</p><p id="8b732b66">如果出于冗余目的而安装了两个服务器，则它们可以使用同一组许可，因为在给定的时刻仅其中一个正在运行。</p></div><a name="TeamCitySecurityNotes"></a><a name="TeamCity-Security-Notes"></a><div class="chapter"><h2 id="HowTo...-TeamCitySecurityNotes">TeamCity安全说明</h2><p id="c3ab8abf">以下注释仅供参考，并不意味着它们是完整的或准确的。</p><p id="77c20035">开发TeamCity时会考虑安全问题，并已做出合理的努力以使系统不受各种类型的攻击。我们与第三方合作，使用安全扫描器和渗透测试评估TeamCity的安全性。<br>我们的目标是在最新的TeamCity主要版本的最近的错误修复版本中迅速解决新发现的安全问题。<br>但是，一般的假设和建议的设置是将TeamCity部署在受信任的环境中，恶意用户不可能对其进行访问。</p><p id="7b097999">连同这些准则一起，请查看有关配置TeamCity服务器以供生产使用的<a href="installing-and-configuring-the-teamcity-server.html#Configuring-Server-for-Production-Use">注释</a> 。有关已公开的与安全相关的问题的列表，请参见我们的<a href="https://youtrack.jetbrains.com/issues/TW?q=project:TeamCity type: {Security Problem} sort by: {Fix versions} desc" rel="noopener noreferrer" data-external="true" target="_blank">公共问题跟踪器</a>和发行说明中的“安全”部分。建议您尽快升级到新发布的TeamCity版本，因为它们可能包含与安全相关的修补程序。</p><p id="6ff472ed">请注意， <b id="9f4afc94">自TeamCity 2017.2起</b> ，TeamCity Windows安装程序将<a href="teamcity-home-directory.html">TeamCity安装目录的</a>权限修改为不使用可继承的权限，并明确授予对目录的访问权限给Administrators用户组和配置该服务在其下运行的accrount。<br>强烈建议将权限限制为<a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a>以同样的方式。</p><a name="Additionalsecurity-relatedsettings"></a><a name="Additional-security-related-settings"></a><div class="chapter"><h3 id="HowTo...-Additionalsecurity-relatedsettings">其他与安全性相关的设置</h3><p id="287fc6b4">考虑添加<code class="code">teamcity.installation.completed=true</code>线成<code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity Home Directory</code></a> <code class="code">>\conf\teamcity-startup.properties</code>文件-这将阻止以空数据库启动的服务器向第一个即将到来的用户授予对计算机的访问权限。</p><p id="388ff8fa">TeamCity没有针对DoS（拒绝服务）攻击的内置保护：高请求率可能会使服务器超载，并使其无响应。如果将TeamCity实例部署在允许此类服务滥用的环境中，请在反向代理级别上实施保护。</p><p id="6f97887b"><b id="5c9ef099">简短清单</b> （请参阅下面的完整说明）</p><ul class="list _ul"><li class="list__item" id="b2bd2b3a"><p>您正在运行最新发布的TeamCity版本，并准备在几周内升级到新发布的版本</p></li><li class="list__item" id="ccd9ebd1"><p>使用HTTPS（例如，借助<a href="#Configure-HTTPS-for-TeamCity-Web-UI">代理服务器（</a>如NGINX））可确保对TeamCity Web界面的访问安全。TeamCity Web界面采用了保护Web应用程序安全的最佳实践。例如：无法使用HTTP协议访问服务器。反向代理不会删除Referer请求标头</p></li><li class="list__item" id="17747bae"><p>TeamCity服务器计算机不运行代理（至少在允许读取代理<code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity server's home directory</code></a>和<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code> ）</p></li><li class="list__item" id="f8640f5a"><p>TeamCity服务器和代理进程在具有最小限度所需权限的受限用户下运行。安装目录只能由一组有限的OS用户读取和写入。的<code class="code">conf\buildAgent.properties</code>代表服务管理员的OS用户只能读取文件和服务器日志以及数据目录，因为读取这些位置可以分别接管代理或服务器。</p></li><li class="list__item" id="31188e78"><p>来宾用户和用户注册已禁用，或者已审核来宾和“ <a href="user-group.html#" all-user="-group" ="">所有用户”</a>组的角色</p></li><li class="list__item" id="4f9bfc47"><p>具有管理权限的TeamCity用户具有不平凡的密码</p></li><li class="list__item" id="6408b064"><p>如果您配置了外部身份验证（例如LDAP），则禁用<a href="configuring-authentication-settings.html#Built-in-Authentication">内置身份验证</a>模块</p></li><li class="list__item" id="1f25c78a"><p>密码不会打印到构建日志中，也不会存储在构建工件中，也不会存储在非<a href="typed-parameters.html#Adding-Parameter-Specification">密码参数中</a></p></li></ul></div><a name="Security-relatedRisksEvaluation"></a><a name="Security-related-Risks-Evaluation"></a><div class="chapter"><h3 id="HowTo...-Security-relatedRisksEvaluation">与安全相关的风险评估</h3><p id="1da79e79">以下是有关不同安全性方面的一些说明：</p><ul class="list _ul"><li class="list__item" id="5baec498">中间人关注<ul class="list _ul"><li class="list__item" id="dac555ed"><p>在TeamCity服务器和用户的Web浏览器之间：建议对TeamCity服务器<a href="using-https-to-access-teamcity-server.html">使用HTTPS</a> 。登录期间，TeamCity以中等加密级别的加密形式传输用户登录密码。</p></li><li class="list__item" id="f1bfa6a8"><p>在TeamCity代理和TeamCity服务器之间：请参阅<a href="setting-up-and-running-additional-build-agents.html#Agent-Server-Data-Transfers">本节</a> 。</p></li><li class="list__item" id="782876e8"><p>在TeamCity服务器和其他外部服务器（版本控制，问题跟踪器等）之间：一般规则适用于连接到外部服务器的客户端（在这种情况下为TeamCity服务器），请参阅所涉及服务器的准则。</p></li></ul></li><li class="list__item" id="3f8ea990"><p>有权访问TeamCity Web UI的用户：通过TeamCity <a href="role-and-permission.html">用户角色</a>定义了用户可访问的特定信息。</p></li><li class="list__item" id="711cdf81">可以更改TeamCity运行的构建中使用的代码的用户（包括任何分支/拉取请求中的提交者（如果它们基于TeamCity构建）：<ul class="list _ul"><li class="list__item" id="fb02cf1d"><p>可以执行运行TeamCity代理的系统用户可以执行的所有操作；有权访问可在其构建物上运行的代理计算机上安装的OS资源和其他应用程序。</p></li><li class="list__item" id="76177b16"><p>可以访问和更改在同一代理上构建的其他项目的源代码，修改TeamCity代理代码，将任何文件发布为在代理上运行的构建的工件（这意味着文件可以随后显示在TeamCity Web UI中并公开Web漏洞或可以在其他版本中使用）等。</p></li><li class="list__item" id="18a20957"><p>可以模拟TeamCity代理（运行与TeamCity服务器外观相同的新代理）。</p></li><li class="list__item" id="339a9551"><p>可以对服务器上的所有项目执行具有“查看内部配置设置”权限的用户所能执行的所有操作（请参见下文）。</p></li><li class="list__item" id="95c2d470"><p>可以检索运行构建的构建配置的设置，包括密码字段的值。</p></li><li class="list__item" id="fd122a63"><p>可以从服务器上的任何内部版本下载工件。<br>因此，建议在OS帐户下仅使用<a href="setting-up-and-running-additional-build-agents.html#Necessary-OS-and-environment-permissions">必要的权限集</a>运行TeamCity代理<a href="setting-up-and-running-additional-build-agents.html#Necessary-OS-and-environment-permissions">，</a>并使用<a href="agent-pools.html">代理池</a>功能来确保需要不同访问集的项目不会建立在同一代理上。</p></li></ul></li><li class="list__item" id="77519667"><p>具有“查看构建配置设置”权限的用户（默认情况下为“项目开发人员” TeamCity角色）可以查看服务器上的所有项目，但是由于TeamCity 9.0有一种限制方式，请参见相应问题<a href="https://youtrack.jetbrains.com/issue/TW-24904#comment=27-731107" rel="noopener noreferrer" data-external="true" target="_blank">TW- 24904</a> 。</p></li><li class="list__item" id="15579d1c"><p>在一个项目中具有“编辑项目”权限（默认情况下为“项目管理员” TeamCity角色）的用户，通过更改设置可以检索工件并从他们仅具有查看权限的任何构建配置中触发构建（ <a href="https://youtrack.jetbrains.com/issue/TW-39209" rel="noopener noreferrer" data-external="true" target="_blank">TW-39209</a> ）。用户可能还可以使TeamCity服务器运行服务器上的任何可执行文件。</p></li><li class="list__item" id="768594b1"><p>具有“更改服务器设置”权限的用户（默认情况下为“系统管理员” TeamCity角色）：假定用户还可以使用用于运行服务器进程的用户帐户访问运行TeamCity服务器的计算机。因此，用户可以使用该OS用户帐户获得对计算机的完全访问权限：浏览文件系统，更改文件，运行任意命令等。</p></li><li class="list__item" id="88a62977"><p>TeamCity服务器计算机管理员：具有对TeamCity存储的数据的完全访问权限，并且可以影响TeamCity执行的进程。在外部系统（如VCS，问题跟踪器等）中进行身份验证所需的密码以加扰的形式存储在<a href="teamcity-data-directory.html">TeamCity Data Directory中</a> ，也可以存储在数据库中。但是，这些值仅是加扰的，这意味着任何有权访问服务器文件系统或数据库的用户都可以检索它们。</p></li><li class="list__item" id="bf570863"><p>对TeamCity服务器日志（TeamCity服务器主目录）具有读取访问权限的用户可以将其访问权限升级为TeamCity服务器管理员。</p></li><li class="list__item" id="07f2b900"><p>具有读取权限的用户<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code>可以访问服务器上的所有设置，包括配置的密码。</p></li><li class="list__item" id="77f70410"><p>对以下版本的构建工件具有读取权限的用户： <code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/system/artifacts</code>获得具有“查看构建运行时参数和数据”权限的用户的相同权限（特别是可以访问构建中使用的所有密码参数的值）。</p></li><li class="list__item" id="7f001a36"><p>TeamCity代理计算机管理员：与“可以更改TeamCity运行的版本中使用的代码的用户”相同。</p></li><li class="list__item" id="04ec2754"><p>建议在代理之间分配项目，以使一个TeamCity代理不会运行多个项目的构建，这些项目的开发人员和管理员不应访问彼此的项目。推荐的分配项目的方法是使用<a href="agent-pools.html">代理程序池</a>功能，并确保“默认”代理程序池没有代理程序，因为在进行某些重新配置后（例如，当项目中没有其他池时）可以将项目分配给默认池被分配给）。</p></li><li class="list__item" id="ae59d4c2">当启用了<a href="storing-project-settings-in-version-control.html">在VCS中存储设置时</a> ：<ul class="list _ul"><li class="list__item" id="562d9440"><p>可以访问设置存储库的任何用户（包括使用同一VCS根目录对构建配置具有“查看文件内容”权限的用户）都可以查看设置并根据其存储的加扰形式检索实际密码</p></li><li class="list__item" id="99334bd3"><p>任何可以在VCS中针对服务器上构建的单个构建配置修改设置的用户，都可以通过更改设置来检索工件并从他们仅具有查看权限的任何构建配置中触发构建（ <a href="https://youtrack.jetbrains.com/issue/TW-39192" rel="noopener noreferrer" data-external="true" target="_blank">TW-39192</a> ）。</p></li><li class="list__item" id="1e07fd5c"><p>可以通过更改构建中的设置来基于每个构建自定义构建配置设置的用户（例如，当版本设置设置为“使用VCS中的设置”时可以运行个人构建的用户）可以检索工件并触发任何构建配置中的构建他们仅具有（ <a href="https://youtrack.jetbrains.com/issue/TW-46065" rel="noopener noreferrer" data-external="true" target="_blank">TW-46065</a> ）的查看权限。</p></li></ul></li><li class="list__item" id="4ce9c2f8">其他：<ul class="list _ul"><li class="list__item" id="a7be7b38"><p>TeamCity Web应用程序漏洞：一旦发现任何重大漏洞（如跨站点脚本编写的可能性），TeamCity开发团队就会做出合理的努力。请注意，任何可能影响构建文件的用户（“可以更改由TeamCity运行的构建中使用的代码的用户”或“ TeamCity代理计算机管理员”的用户）都可以将恶意文件用作构建工件，然后再利用网站脚本漏洞。（ <a href="http://youtrack.jetbrains.com/issue/TW-27206" rel="noopener noreferrer" data-external="true" target="_blank">TW-27206</a> ）</p></li><li class="list__item" id="f3737cc7"><p>TeamCity代理完全由TeamCity服务器控制：由于TeamCity代理支持从服务器下载自动更新，因此代理应仅连接到受信任的服务器。服务器计算机的管理员可以在连接的代理上强制执行任意代码。</p></li><li class="list__item" id="2d7a85bb"><p>任何可以访问服务器URL的人都可以使用服务器上安装的代理插件的二进制文件。</p></li></ul></li></ul></div></div><a name="WhatEncryptionisUsedbyTeamCity"></a><a name="What-Encryption-is-Used-by-TeamCity"></a><div class="chapter"><h2 id="HowTo...-WhatEncryptionisUsedbyTeamCity">TeamCity使用什么加密</h2><p id="4a329733">TeamCity尝试不通过Web UI（从浏览器到服务器）以明文形式传递密码值：相反，它使用具有1024位密钥的RSA对其进行加密。但是，建议仅通过HTTPS使用TeamCity Web UI，因此此预防措施应该无关紧要。TeamCity以加密形式将密码存储在设置中（在该密码中，原始密码值是在其他系统中执行身份验证所必需的）。使用带有固定密钥的3DES进行加扰。</p></div><a name="ConfigureNewlyInstalledMySQLServer"></a><a name="Configure-Newly-Installed-MySQL-Server"></a><div class="chapter"><h2 id="HowTo...-ConfigureNewlyInstalledMySQLServer">配置新安装的MySQL服务器</h2><p id="fb7ade7d">如果除了<a href="setting-up-an-external-database.html#MySQL">基本设置</a>之外，还要将MySQL服务器与TeamCity一起使用，则应查看并可能更改某些MySQL服务器设置。如果Windows上安装了MySQL，则设置位于<code class="code">my.ini</code>该文件通常可以在MySQL安装目录下找到。对于类Unix系统，该文件称为<code class="code">my.cnf</code>可以放在下面的某个地方<code class="code">/etc</code>目录。在<a href="http://dev.mysql.com/doc/refman/5.5/en/option-files.html" rel="noopener noreferrer" data-external="true" target="_blank">MySQL文档中</a>阅读有关配置文件位置的更多信息。注意：在中更改设置后，您需要重新启动MySQL服务器<code class="code">my.ini|my.cnf</code> 。</p><p id="930b6134">应检查和/或更改以下设置：</p><a name="InnoDBdatabaseengine"></a><a name="InnoDB-database-engine"></a><div class="chapter"><h3 id="HowTo...-InnoDBdatabaseengine">InnoDB数据库引擎</h3><p id="357fc86d">确保对TeamCity数据库中的表使用InnoDB数据库引擎。您可以在以下命令的帮助下检查使用哪种引擎：</p><div class="code-block" data-lang="bash">显示表格状态，例如“<table name=""><tbody><tr><td>';</td></tr></tbody></table></div><p id="0ccf9dc0">或一次所有表格：</p><div class="code-block" data-lang="bash">显示表格状态，如“％”；</div></div><a name="maxconnections"></a><a name="max-connections"></a><div class="chapter"><h3 id="HowTo...-maxconnections">max_connections</h3><p id="8c762681">你应该确保<code class="code">max_connections</code>参数的值大于TeamCity中指定的值<code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity Home Directory</code></a> <code class="code">>/config/database.properties</code>文件。</p></div><a name="innodbbufferpoolsizeandinnodblogfilesize"></a><a name="innodb-buffer-pool-size-and-innodb-log-file-size"></a><div class="chapter"><h3 id="HowTo...-innodbbufferpoolsizeandinnodblogfilesize">innodb_buffer_pool_size和innodb_log_file_size</h3><p id="2801d125">在中指定的值太小<code class="code">innodb_buffer_pool_size</code>可能会严重影响性能：</p><div class="code-block" data-lang="bash">＃InnoDB与MyISAM不同，它使用缓冲池缓存索引和＃行数据。设置得越大，＃表中的数据访问所需的磁盘I / O越少。在专用数据库服务器上，您可以将此参数最多设置为计算机物理内存大小的80％。但是，请勿将其设置为太大，因为物理内存的竞争可能会导致操作系统中的页面调度。请注意，在32位系统上，您＃可能每个进程只能使用2-3.5G的用户级内存，因此请＃不要将其设置得太高。innodb_buffer_pool_size = 2000M</div><p id="2acde6e5">我们建议从2Gb开始，如果速度变慢并且有足够的内存，请增加它。增加缓冲池大小后，还应该更改<a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_log_file_size" rel="noopener noreferrer" data-external="true" target="_blank">innodb_log_file_size</a>设置的大小（其值可以计算为<code class="code">innodb_log_file_size/N</code> ，其中N是该组中的日志文件数（默认为2））：</p><div class="code-block" data-lang="none">innodb_log_file_size = 1024M</div></div><a name="innodbfilepertable"></a><a name="innodb-file-per-table"></a><div class="chapter"><h3 id="HowTo...-innodbfilepertable">innodb_file_per_table</h3><p id="05d8cfd2">为了获得更好的性能，可以启用所谓的<a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-multiple-tablespaces.html" rel="noopener noreferrer" data-external="true" target="_blank">每表表空间</a> 。请注意，一旦添加<code class="code">innodb_file_per_table</code>选项将创建新表并将其放置在单独的文件中，但是在启用此选项之前创建的表仍将位于共享表空间中。您需要重新导入数据库，以便将它们放置在单独的文件中。</p></div><a name="innodbflushlogattrxcommit"></a><a name="innodb-flush-log-at-trx-commit"></a><div class="chapter"><h3 id="HowTo...-innodbflushlogattrxcommit">innodb_flush_log_at_trx_commit</h3><p id="9c494236">如果TeamCity是唯一使用MySQL数据库的应用程序，则可以通过设置<code class="code">innodb_flush_log_at_trx_commit</code>可变为<code class="code">2</code>要么<code class="code">0</code> ：</p><div class="code-block" data-lang="bash">＃如果设置为1，则InnoDB将在每次提交时将事务日志刷新（fsync）到＃磁盘上，从而提供完整的ACID行为。如果您＃愿意损害这种安全性，并且正在运行＃小事务，则可以将其设置为0或2以将磁盘I / O减少到＃日志中。值0表示仅将日志写入日志文件，并且＃日志文件大约每秒刷新一次到磁盘。值2＃表示在每次提交时将日志写入日志文件，但是log＃文件仅大约每秒刷新一次到磁盘。innodb_flush_log_at_trx_commit = 2</div><p id="604ff383">注意：数据库对数据库提供完整的ACID行为对于TeamCity并不重要，因此您可以安全地更改此变量。</p></div><a name="logfilesondifferentdisk"></a><a name="log-files-on-different-disk"></a><div class="chapter"><h3 id="HowTo...-logfilesondifferentdisk">记录不同磁盘上的文件</h3><p id="c1daa21c">将MySQL日志文件放在不同的磁盘上有时可以帮助提高性能。您可以在<a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-configuration.html" rel="noopener noreferrer" data-external="true" target="_blank">MySQL文档中</a>阅读有关<a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-configuration.html" rel="noopener noreferrer" data-external="true" target="_blank">内容</a> 。</p></div><a name="SettingTheBinaryLogFormat"></a><a name="Setting-The-Binary-Log-Format"></a><div class="chapter"><h3 id="HowTo...-SettingTheBinaryLogFormat">设置二进制日志格式</h3><p id="ded54df6">如果默认的MySQL二进制日志记录格式不是MIXED（取决于您使用<a href="http://dev.mysql.com/doc/refman/5.1/en/binary-log-setting.html" rel="noopener noreferrer" data-external="true" target="_blank">的MySQL版本</a> ），则应将其显式设置为<b id="31b4a0b4">MIXED</b> ：</p><div class="code-block" data-lang="bash">binlog-format =混合</div></div><a name="Enableadditionaldiagnostics"></a><a name="Enable-additional-diagnostics"></a><div class="chapter"><h3 id="HowTo...-Enableadditionaldiagnostics">启用其他诊断</h3><p id="5fe3a08c">要在某些特定于数据库的错误的情况下获取其他诊断数据，请通过SQL命令为TeamCity数据库用户授予更多权限：</p><div class="code-block" data-lang="sql">授予过程*。*至<teamcity-user-name>;</teamcity-user-name></div></div></div><a name="ConfigureNewlyInstalledPostgreSQLServer"></a><a name="Configure-Newly-Installed-PostgreSQL-Server"></a><div class="chapter"><h2 id="HowTo...-ConfigureNewlyInstalledPostgreSQLServer">配置新安装的PostgreSQL服务器</h2><p id="006147d3">为了获得更好的TeamCity服务器性能，建议更改新安装的PostgreSQL服务器的某些参数。您可以在<a href="https://wiki.postgresql.org/wiki/Performance_Optimization" rel="noopener noreferrer" data-external="true" target="_blank">PostgreSQL Wiki中</a>阅读有关PostgreSQL性能优化的更多<a href="https://wiki.postgresql.org/wiki/Performance_Optimization" rel="noopener noreferrer" data-external="true" target="_blank">信息</a> 。</p><p id="887332b5">可以在以下参数中更改以下参数<code class="code">postgresql.conf</code>文件位于PostgreSQL的数据目录中。</p><a name="sharedbuffers"></a><a name="shared-buffers"></a><div class="chapter"><h3 id="HowTo...-sharedbuffers">shared_buffers</h3><p id="3ea52204"><a href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-SHARED-BUFFERS" rel="noopener noreferrer" data-external="true" target="_blank">http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-SHARED-BUFFERS</a>参数的默认值太小，应增加：</p><div class="code-block" data-lang="bash">shared_buffers = 512MB</div><p id="da6f4609"><a name="checkpoint_segments"></a><a name="HowTo...-checkpoint_segments"></a></p></div><a name="checkpoint-relatedparameters"></a><a name="checkpoint-related-parameters"></a><div class="chapter"><h3 id="HowTo...-checkpoint-relatedparameters">检查点相关参数</h3><p id="44c37faa">对于TeamCity这样的写密集型应用程序，建议更改一些与<a href="http://www.postgresql.org/docs/current/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-CHECKPOINTS" rel="noopener noreferrer" data-external="true" target="_blank">检查点相关的参数</a> ：</p><p id="3b2c422e">对于<b id="0a997a01">PostgreSQL 9.5及更高版本</b> ：</p><div class="code-block" data-lang="bash">max_wal_size = 1500MB checkpoint_completion_target = 0.9</div><p id="0ac45806">对于<b id="735eba79">PostgreSQL 9.5之前的</b>版本：</p><div class="code-block" data-lang="bash">checkpoint_segments = 32 checkpoint_completion_target = 0.9</div></div><a name="synchronouscommit"></a><a name="synchronous-commit"></a><div class="chapter"><h3 id="HowTo...-synchronouscommit">同步提交</h3><p id="c8b2bfba">如果TeamCity是唯一使用PostgreSQL数据库的应用程序，我们建议禁用<a href="http://www.postgresql.org/docs/current/static/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT" rel="noopener noreferrer" data-external="true" target="_blank">http://www.postgresql.org/docs/current/static/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT</a>参数：</p><div class="code-block" data-lang="bash">sync_commit =关闭</div></div></div><a name="SetUpTeamCitybehindaProxyServer"></a><a name="Set-Up-TeamCity-behind-a-Proxy-Server"></a><div class="chapter"><h2 id="HowTo...-SetUpTeamCitybehindaProxyServer">在代理服务器后面设置TeamCity</h2><p id="e4fb5679">本节介绍在TeamCity服务器Web UI前面安装的反向代理服务器的建议设置。建议在代理级别配置HTTPS，但这不在这些说明的范围内-有关此信息，请参阅代理服务器的文档。</p><p id="a3d49002">考虑示例：<br>TeamCity服务器安装在URL（本地URL）： <a href="http://teamcity.local:8111/tc" rel="noopener noreferrer" data-external="true" target="_blank">http：//teamcity.local：8111 / tc上</a> 。<br>它以URL（公共URL）在外部可见： <a href="http://teamcity.public:400/tc" rel="noopener noreferrer" data-external="true" target="_blank">http：//teamcity.public：400 / tc</a> 。</p><p id="ce0dcfa7">您需要设置反向代理（请参阅下面的<a href="#Proxy-Server-Setup">代理服务器设置</a> ），还需要配置TeamCity捆绑的Tomcat服务器（请参见下面的<a href="#TeamCity-Tomcat-Configuration">TeamCity Tomcat配置</a> ），以确保TeamCity“知道”客户端用于访问资源的实际绝对URL。然后，这些URL用于在客户端重定向和其他响应中生成绝对URL。</p><p id="201100e2">注意：内部TeamCity服务器应该在<b id="ec9944eb">相同的上下文</b> （即主机名后面的URL的一部分）下工作，因为外部地址可以从外部看到它。另请参见TeamCity服务器<a href="installing-and-configuring-the-teamcity-server.html#Changing-Server-Context">上下文更改说明</a> 。如果仍然需要在不同的上下文中运行服务器，请注意，上下文更改代理应该对TeamCity隐藏这一事实：例如，它应该映射服务器重定向URL以及将cookie设置为原始（外部）上下文的路径。</p><a name="ProxyServerSetup"></a><a name="Proxy-Server-Setup"></a><div class="chapter"><h3 id="HowTo...-ProxyServerSetup">代理服务器设置</h3><p id="e2afb43c">应该在配置代理时考虑通用的Web安全性。例如，诸如Referer和Origin之类的标头通常应以未经修改的形式传递给TeamCity Web应用程序。另外，未知的HTTP请求标头应未经修改地传递到TeamCity Web应用程序。例如，TeamCity依赖于客户端添加的“ X-TC-CSRF-Token”标头。</p></div><a name="Apache"></a><a name="Apache"></a><div class="chapter"><h3 id="HowTo...-Apache">阿帕奇</h3><p id="5b112c63">建议使用2.4.5+版本。早期版本不支持WebSocket协议，因此请使用<a href="https://confluence.jetbrains.com/display/TCD8/How+To..." rel="noopener noreferrer" data-external="true" target="_blank">先前文档版本中</a>注明的设置。</p><p id="d805a17d">使用Apache时，请确保使用<a href="#Dedicated-" connecto="-node-approach" ="">专用的“连接器”节点方法</a>来配置TeamCity服务器。</p><div class="code-block" data-lang="bash">LoadModule proxy_module /usr/lib/apache2/modules/mod_proxy.so LoadModule proxy_http_module /usr/lib/apache2/modules/mod_proxy_http.so LoadModule headers_module /usr/lib/apache2/modules/mod_headers.so LoadModule proxy_wstunnel_module / usr / lib / apache2 /modules/mod_proxy_wstunnel.so ProxyRequests Off ProxyPreserveHost on ProxyPass / tc / app / subscriptions ws：//teamcity.local：8111 / tc / app / subscriptions connectiontimeout = 240 timeout = 1200 ProxyPassReverse / tc / app / subscriptions ws：// teamcity .local：8111 / tc / app / subscriptions ProxyPass / tc http：//teamcity.local：8111 / tc connectiontimeout = 240 timeout = 1200 ProxyPassReverse / tc http：//teamcity.local：8111 / tc</div><p id="f87b22c5">请注意<a href="https://httpd.apache.org/docs/2.4/mod/mod_proxy.html#proxypass" rel="noopener noreferrer" data-external="true" target="_blank">ProxyPass规则</a>的顺序：冲突的ProxyPass规则必须首先从最长的URL开始进行排序。</p><p id="d0f8b913">请注意，默认情况下，Apache仅允许有限数量的并行连接，这些并行连接在使用WebSocket协议时可能不足。例如，当许多客户端打开Web UI时，它可能导致TeamCity服务器不响应。要修复该问题，您可能需要微调Apache配置。</p><p id="0db0e14d">例如，在Unix上，您应该切换到<a href="http://httpd.apache.org/docs/2.4/mod/worker.html" rel="noopener noreferrer" data-external="true" target="_blank">mpm_worker</a>并配置最大同时连接数：</p><div class="code-block" data-lang="bash"><ifmodule mpm_worker_module="">ServerLimit 100个启动服务器3个MinSpareThreads 25个MaxSpareThreads 75个ThreadLimit 64个ThreadsPerChild 25个MaxClients 2500个MaxRequestsPerChild 0</ifmodule>

</div><p id="d8c99e25">在Windows上，您可能需要<a href="http://httpd.apache.org/docs/2.4/platform/windows.html" rel="noopener noreferrer" data-external="true" target="_blank">按照Apache文档中的说明</a>增加<a href="http://httpd.apache.org/docs/2.4/mod/mpm_common.html#threadsperchild" rel="noopener noreferrer" data-external="true" target="_blank">ThreadsPerChild</a>值。</p></div><a name="NGINX"></a><a name="NGINX"></a><div class="chapter"><h3 id="HowTo...-NGINX">NGINX</h3><p id="7ca8e5a0">对于以下NGINX配置，请使用<a href="#Proxy-Tomcat-RemoteIpValve">“ RemoteIpValve”方法</a>来配置TeamCity服务器。</p><p id="e02a9e8f">推荐使用1.3+版本。早期版本不支持WebSocket协议，因此请使用<a href="https://confluence.jetbrains.com/display/TCD8/How+To..." rel="noopener noreferrer" data-external="true" target="_blank">先前文档版本中</a>注明的设置。</p><div class="code-block" data-lang="java">http {＃...默认设置为此处proxy_read_timeout 1200; proxy_connect_timeout 240; client_max_body_size 0; ＃HTTP请求的最大大小。 0允许将大型工件上传到TeamCity地图$ http_upgrade $ connection_upgrade {＃WebSocket支持默认升级； ''; }服务器{收听400； ＃公共服务器端口server_name teamcity.public; ＃公共服务器主机名位置/ {＃公共上下文（应与内部上下文相同）proxy_pass http：//teamcity.local：8111; ＃完整的内部地址proxy_http_version 1.1; proxy_set_header主机$ server_name：$ server_port; proxy_set_header X转发的主机$ http_host; ＃正确的绝对重定向和TeamCity CSRF检查proxy_set_header X-Forwarded-Proto $ scheme所必需； proxy_set_header X-Forwarded-For $ remote_addr; proxy_set_header升级$ http_upgrade; ＃WebSocket支持proxy_set_header连接$ connection_upgrade; ＃WebSocket支持}}}</div></div><a name="Commonmisconfigurations"></a><a name="Common-misconfigurations"></a><div class="chapter"><h3 id="HowTo...-Commonmisconfigurations">常见配置错误</h3><p id="517cfdcb">检查您的反向代理（或类似工具）是否符合以下要求：</p><ul class="list _ul"><li class="list__item" id="98469801"><p>支持URL以点（“。”符号）开头的路径（隐藏工件的路径开始包含“ .teamcity”目录）</p></li><li class="list__item" id="f63b06ce"><p>支持带有冒号（“：”符号）的URL（许多TeamCity资源都使用冒号）。相关的<a href="https://docs.microsoft.com/en-us/dotnet/api/system.web.configuration.httpruntimesection.requestpathinvalidcharacters?view=netframework-4.7.2" rel="noopener noreferrer" data-external="true" target="_blank">IIS设置</a> 。症状：构建没有工件，并且“此构建中没有用户定义的工件”。文字，即使有人工痕迹。</p></li><li class="list__item" id="d85f6e99"><p>最大响应长度/时间没有太大限制（由于TeamCity可以提供大文件来减慢客户端速度，因此响应的大小和时间可以为Gb）</p></li><li class="list__item" id="9f3d0821"><p>完全支持gzip Content-Encoding。例如，某些IIS配置可能导致UI中出现“正在加载数据...”和500个HTTP响应（请参阅相关<a href="https://youtrack.jetbrains.com/issue/TW-56218" rel="noopener noreferrer" data-external="true" target="_blank">问题</a> ）</p></li></ul><p id="5b0a71f0"><a name="OtherServers"></a><a name="HowTo...-OtherServers"></a></p></div><a name="Otherservers"></a><a name="Other-servers"></a><div class="chapter"><h3 id="HowTo...-Otherservers">其他服务器</h3><p id="eb24047e">确保使用对请求（上传）和响应（下载）的大小和超时（根据代码库和工件的大小至少为数十分钟和千兆字节）的适当（高）限制的高性能代理。</p><p id="14805593">建议使用能够与WebSocket协议配合使用的代理，因为这有助于UI尽快刷新。</p><p id="596a22db">通常，您需要配置TeamCity服务器，以便它“了解”客户端使用的原始URL，并且可以生成可供客户端访问的正确的绝对URL。实现此目标的首选方法是将原始“ Host”标头传递给TeamCity。另一种方法是将“ X-Forwarded-Host”标头设置为原始“ Host”标头值。</p><p id="c81d5001">请注意，每当代理更改“主机”标头的值时（建议保留原始主机标头值），并且不提供具有原始主机值的“ X-Forwarded-Host”标头时，如果原始和引荐来源标头包含原始的主机标头值，则应进行对应映射（如果不包含原始标头和引荐标头，则不应设置它们，以便不避开TeamCity <a href="csrf-protection.html">CSRF保护</a> ）。</p><p id="a652012e">从下面的部分中选择适当的方法，并相应地配置代理。</p></div><a name="TeamCityTomcatConfiguration"></a><a name="TeamCity-Tomcat-Configuration"></a><div class="chapter"><h3 id="HowTo...-TeamCityTomcatConfiguration">TeamCity Tomcat配置</h3><p id="664bdba0">对于适当的TeamCity Tomcat配置，有两种选择：</p><ul class="list _ul"><li class="list__item" id="4203d23e"><p>在服务器配置中使用带有硬编码公共URL详细信息的<b id="fdb59a72">专用“连接器”节点</b> ，并确保仅对配置的公共URL的请求使用连接器中配置的端口。</p></li><li class="list__item" id="566fdeae"><p>配置代理以传递适当的请求标头：“主机”或“ X-Forwarded-Host”（原始请求主机），“ X-Forwarded-Proto”（原始请求协议），“ X-Forwarded-Port”（原始请求端口）并为TeamCity Tomcat配置<b id="e0a06195">配置“ RemoteIpValve”</b> 。</p></li></ul><p id="9acd523c"><a name="Proxy-Tomcat-Connector"></a><a name="HowTo...-Proxy-Tomcat-Connector"></a></p></div><a name="Dedicated" connecto="nodeapproach" =""></a><a name="Dedicated-" connecto="-node-approach" =""></a><div class="chapter"><h3 id="HowTo...-Dedicated" connecto="nodeapproach" ="">专用“连接器”节点方法</h3><p id="eb3be4b5">如果配置的端口仅接收对配置的公共URL的请求，则此方法可以与任何代理配置一起使用。</p><p id="d83d0dbc">设置代理服务器以将所有请求重定向到<code class="code">teamcity.public:400</code>到TeamCity服务器上的专用端口（ <code class="code">8111</code>在下面的示例中）并在以下位置更改“ Connector”节点<code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a> <code class="code">>/conf/server.xml</code>文件如下。请注意，只能通过配置的代理地址访问以这种方式配置的“连接器”端口。如果您还想直接访问TeamCity端口，请使用单独的“连接器”节点和专用<code class="code">port</code>价值。</p><div class="code-block" data-lang="bash">
<connector port="8111" protocol="org.apache.coyote.http11.Http11NioProtocol"                connectiontimeout="60000"                usebodyencodingforuri="true"                socket.txbufsize="64000"                socket.rxbufsize="64000"                tcpnodelay="1"                proxyname="teamcity.public"                proxyport="400"                secure="false"                scheme="http"                =""></connector>

</div><p id="a8204cb5">当公共服务器地址为<b id="f587d5fb">HTTPS时</b> ，请使用<code class="code">secure="true"</code>和<code class="code">scheme="https"</code>属性。</p><p id="dc0c0275"><a name="Proxy-Tomcat-RemoteIpValve"></a><a name="HowTo...-Proxy-Tomcat-RemoteIpValve"></a></p></div><a name="" remoteipvalv="approach" =""></a><a name="" remoteipvalv="-approach" =""></a><div class="chapter"><h3 id="HowTo...-" remoteipvalv="approach" ="">“ RemoteIpValve”方法</h3><p id="203dd826">当代理服务器将“ X-Forwarded-Proto”，“ X-Forwarded-Port”请求标头设置为原始URL的值时，可以使用此方法。同样，尽管对于大多数设置而言并不重要，但可以使用这种方法来确保将原始客户端IP正确传递到TeamCity服务器。这对于遗留代理的<a href="setting-up-and-running-additional-build-agents.html#Bidirectional-Communication">双向通信</a>很重要。</p><p id="3b18783b">添加以下到<host>的</host> Tomcat的主<host>节点<code class="code">conf\server.xml</code>文件（另请参见Tomcat <a href="http://tomcat.apache.org/tomcat-8.5-doc/api/org/apache/catalina/valves/RemoteIpValve.html" rel="noopener noreferrer" data-external="true" target="_blank">doc</a> ）：</host></p><div class="code-block" data-lang="bash">
<valve    classname="org.apache.catalina.valves.RemoteIpValve"    remoteipheader="x-forwarded-for"    protocolheader="x-forwarded-proto"    portheader="x-forwarded-port"    =""></valve>

</div><p id="1efa0c6a">也建议指定<code class="code">internalProxies</code>属性的正则表达式仅与代理服务器的IP地址匹配。例如<code class="code">internalProxies="192\.168\.0\.1"</code></p></div></div><a name="ConfigureHTTPSforTeamCityWebUI"></a><a name="Configure-HTTPS-for-TeamCity-Web-UI"></a><div class="chapter"><h2 id="HowTo...-ConfigureHTTPSforTeamCityWebUI">为TeamCity Web UI配置HTTPS</h2><p id="d96c6dba">TeamCity不为HTTPS访问提供现成的支持（请参阅<a href="http://youtrack.jetbrains.com/issue/TW-12976#comment=27-348823" rel="noopener noreferrer" data-external="true" target="_blank">TW-12976</a> ）。强烈建议在TeamCity之前设置一个反向代理，例如Nginx或Apache，该代理将处理HTTPS并将HTTP TeamCity服务器端口用作上游。代理的HTTPS相关配置并非特定于TeamCity，并且对于任何Web应用程序都是通用的。确保按照下面<a href="#Set-Up-TeamCity-behind-a-Proxy-Server">的建议</a>配置反向代理。通用的Web应用程序最佳做法适用（例如完全禁止对TeamCity的http访问）。</p><p id="c5a54e90">对于小型服务器，您可以通过内部<a href="http://tomcat.apache.org/tomcat-7.0-doc/ssl-howto.html" rel="noopener noreferrer" data-external="true" target="_blank">Tomcat手段</a>设置HTTPS，但是不建议这样做，因为这可能会大大增加CPU负载。</p><p id="4b778161">要配置客户端使用自签名证书时通过HTTPS访问TeamCity服务器，请查看<a href="using-https-to-access-teamcity-server.html">相关说明</a> 。</p></div><a name="ConfigureTeamCitytoUseProxyServerforOutgoingConnections"></a><a name="Configure-TeamCity-to-Use-Proxy-Server-for-Outgoing-Connections"></a><div class="chapter"><h2 id="HowTo...-ConfigureTeamCitytoUseProxyServerforOutgoingConnections">配置TeamCity以使用代理服务器进行传出连接</h2><p id="f51ed0f7">本节介绍将TeamCity配置为将代理服务器用于某些传出HTTP连接。要将代理后面的TeamCity连接到Amazon EC2云代理，请参阅<a href="setting-up-teamcity-for-amazon-ec2.html#Proxy-settings">本节</a> 。</p><p id="6d1b6de1">TeamCity可以将代理服务器用于TeamCity服务器与其他服务（例如问题跟踪器等）建立的某些传出HTTP连接。</p><p id="8f2e1cc7">要将TeamCity指向您的代理服务器： <b id="3d17fae3">自TeamCity 2017.1.5起</b> ，可以使用以下服务器<a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性</a> （有关以前的版本，请参见下面的替代方法）：</p><div class="code-block" data-lang="bash">＃对于HTTP协议##代理主机的域名或IP地址以及端口：teamcity.http.proxyHost = proxy.domain.com teamcity.http.proxyPort = 8080 ##无需通过访问即可访问的主机代理，通常是内部主机。提供主机列表，以“ |”分隔字符。可以使用通配符'*'：teamcity.http.nonProxyHosts = localhost | * .mydomain.com）##对于经过身份验证的代理，请添加以下属性：###身份验证类型。支持“基本”和“ ntlm”值。默认值为基本。teamcity.http.proxyAuthenticationType =基本###代理的登录名和密码：teamcity.http.proxyLogin =用户名teamcity.http.proxyPassword =密码＃对于HTTPS协议##代理主机的域名或IP地址以及端口：teamcity.https.proxyHost = proxy.domain.com teamcity.https.proxyPort = 8080 ##无需通过代理即可访问的主机，通常是内部主机。提供主机列表，以“ |”分隔字符。可以使用通配符'*'：teamcity.https.nonProxyHosts = localhost | * .mydomain.com ##对于经过身份验证的代理，请添加以下属性：###身份验证类型。支持“基本”和“ ntlm”值。默认值为基本。teamcity.https.proxyAuthenticationType =基本###代理的登录名和密码：teamcity.https.proxyLogin =登录teamcity.https.proxyPassword =密码</div><p id="c00290e3">适用于任何TeamCity版本的另一种方法是在启动时将额外的以空格分隔的<a href="configuring-teamcity-server-startup-properties.html#JVM-Options">附加JVM选项</a>传递给TeamCity服务器：</p><div class="code-block" data-lang="bash">-Dproxyset = true -Dhttp.proxyHost = proxy.domain.com -Dhttp.proxyPort = 8080 -Dhttp.nonProxyHosts = domain.com -Dhttps.proxyHost = proxy.domain.com -Dhttps.proxyPort = 8080 -Dhttps.nonProxyHosts = domain .com</div></div><a name="ConfigureTeamCityAgenttoUseProxyToConnecttoTeamCityServer"></a><a name="Configure-TeamCity-Agent-to-Use-Proxy-To-Connect-to-TeamCity-Server"></a><div class="chapter"><h2 id="HowTo...-ConfigureTeamCityAgenttoUseProxyToConnecttoTeamCityServer">配置TeamCity代理以使用代理连接到TeamCity服务器</h2><p id="9496e3c0">本节介绍用于TeamCity代理到服务器连接的代理服务器的配置（ <b id="e3d293f9">自TeamCity 2017.1开始</b> ）。</p><a name="agent-proxy-server"></a><p id="5348ef66">在TeamCity代理端，使用以下属性指定代理以连接到TeamCity服务器： <a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a>文件：</p><div class="code-block" data-lang="bash">##代理主机的域名或IP地址以及端口teamcity.http.proxyHost = 123.45.678.9 teamcity.http.proxyPort = 8080 ##如果代理服务器需要身份验证，请指定登录名和密码teamcity.http.proxyLogin =登录teamcity.http.proxyPassword =密码</div><p id="98794da5">请注意，必须将代理配置为不缓存任何TeamCity服务器响应。例如，如果您使用Squid，则将“ cache deny all”行添加到<code class="code">squid.conf</code>文件。</p></div><a name="InstallMultipleAgentsontheSameMachine"></a><a name="Install-Multiple-Agents-on-the-Same-Machine"></a><div class="chapter"><h2 id="HowTo...-InstallMultipleAgentsontheSameMachine">在同一台计算机上安装多个代理</h2><p id="aa76b186">请参阅代理程序安装文档下的<a href="setting-up-and-running-additional-build-agents.html#Installing-Several-Build-Agents-on-the-Same-Machine">相应部分</a> 。</p></div><a name="ChangeServerPort"></a><a name="Change-Server-Port"></a><div class="chapter"><h2 id="HowTo...-ChangeServerPort">更改服务器端口</h2><p id="ce4fb559">请参阅服务器安装说明中的<a href="installing-and-configuring-the-teamcity-server.html#Changing-Server-Port">相应部分</a> 。</p></div><a name="Test-driveNewerTeamCityVersionbeforeUpgrade"></a><a name="Test-drive-Newer-TeamCity-Version-before-Upgrade"></a><div class="chapter"><h2 id="HowTo...-Test-driveNewerTeamCityVersionbeforeUpgrade">升级前试用新版TeamCity版本</h2><p id="0d9db51a">建议在升级生产服务器之前尝试使用新的TeamCity版本。通常的过程是<a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">创建</a>生产TeamCity安装<a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">的副本</a> ，然后对其进行<a href="upgrade.html">升级</a> ，进行尝试，然后在检查完所有内容后放下测试服务器并升级主服务器。启动测试服务器时，请记住更改服务器URL，禁用电子邮件和Jabber通知程序以及新服务器上的<a href="#Copied-Server-Checklist">其他功能</a> 。</p></div><a name="CreateaCopyofTeamCityServerwithAllData"></a><a name="Create-a-Copy-of-TeamCity-Server-with-All-Data"></a><div class="chapter"><h2 id="HowTo...-CreateaCopyofTeamCityServerwithAllData">创建包含所有数据的TeamCity Server副本</h2><p id="34cf6dad">如果您想保留原始服务器及其副本，请确保检查<a href="#Licensing-issues">许可注意事项</a> 。</p><a name="CreateaServerCopy"></a><a name="Create-a-Server-Copy"></a><div class="chapter"><h3 id="HowTo...-CreateaServerCopy">创建服务器副本</h3><p id="6adce7d0">您可以使用TeamCity备份功能或手动创建服务器的副本。建议使用手动方法完成整个服务器的移动。</p></div><a name="UseTeamCityBackup"></a><a name="Use-TeamCity-Backup"></a><div class="chapter"><h3 id="HowTo...-UseTeamCityBackup">使用TeamCity备份</h3><ol class="list _decimal"><li class="list__item" id="92899446"><p>创建包括所有内容的<a href="teamcity-data-backup.html">备份</a> 。（当您移动工件时，可以跳过备份构建日志的选项，请参见下文）。</p></li><li class="list__item" id="36b6c543">安装与您已经在运行的相同版本的新TeamCity服务器。确保这件事：<ul class="list _ul"><li class="list__item" id="5ec34b8d"><p>配置了适当的环境（请参阅下面的注释）</p></li><li class="list__item" id="5872cca5"><p>服务器使用自己的<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code>和它自己的<a href="setting-up-an-external-database.html">数据库</a> （检查<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>config/database.properties</code>文件）</p></li></ul></li><li class="list__item" id="031e4f6a"><p><a href="restoring-teamcity-data-from-backup.html">恢复备份</a> 。</p></li><li class="list__item" id="e4d16f06"><p>通过移动以下内容移动工件（这些不包括在备份中） <code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/system/artifacts</code>目录从旧位置到新位置。由于工件的尺寸可能很大，因此可能要花费很多时间，因此请进行相应的计划。</p></li><li class="list__item" id="570abead"><p>执行必要的<a href="#Environment-transferring">环境转移</a> 。</p></li></ol><aside class="note " rel="942fa3dd" id="7127890b" data-title=""><p id="ed0b3308">为了确保完成服务器传输，建议将TeamCity数据目录的全部内容从原始复制到复制的服务器。建议在启动新服务器之前完成复制。</p></aside></div><a name="CopyManually"></a><a name="Copy-Manually"></a><div class="chapter"><h3 id="HowTo...-CopyManually">手动复制</h3><p id="90179b6d">如果您不想使用捆绑的备份功能或需要对该过程进行手动控制，则以下是手动创建服务器副本所需执行的一般步骤：</p><ol class="list _decimal"><li class="list__item" id="bb9bc356"><p>创建<a href="teamcity-data-backup.html">备份，</a>以便在出现任何问题时可以将其还原，</p></li><li class="list__item" id="8c7ba4c7"><p>确保服务器未运行，</p></li><li class="list__item" id="94a21d5d"><p>执行全新<a href="installing-and-configuring-the-teamcity-server.html">安装</a>或复制TeamCity二进制文件（ <a href="teamcity-home-directory.html"><code class="code">TeamCity Home Directory</code></a> ）移至新地方（ <code class="code">temp</code>和<code class="code">work</code>子目录可以在复制过程中省略）。使用完全相同的TeamCity版本。如果您打算在复制后升级，请仅在现有版本启动并运行后执行升级。</p></li><li class="list__item" id="7bc7a400">复制<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code> 。如果不需要完整副本，请参阅以下各项以获取选项。<ul class="list _ul"><li class="list__item" id="2520063a"><p><code class="code">.BuildServer/config</code>保留项目并建立配置设置</p></li><li class="list__item" id="37c5c903"><p><code class="code">.BuildServer/lib</code>和<code class="code">.BuildServer/plugins</code>如果你有他们</p></li><li class="list__item" id="017e4c82"><p>来自根目录的文件<code class="code">.BuildServer/system</code>如果您使用内部数据库，并且不想执行数据库移动。</p></li><li class="list__item" id="8db50a0e"><p><code class="code">.BuildServer/system/artifacts</code> （可选）是否要在新服务器上保留构建工件和构建日志（包括测试失败详细信息）</p></li><li class="list__item" id="72ac8789"><p><code class="code">.BuildServer/system/changes</code> （可选）如果要在新服务器上保留个人更改</p></li><li class="list__item" id="38421787"><p><code class="code">.BuildServer/system/pluginData</code> （可选）如果您想保留各种插件的状态，请构建触发器和设置审计差异</p></li><li class="list__item" id="83ec7960"><p><code class="code">.BuildServer/system/caches</code>和<code class="code">.BuildServer/system/caches</code> （可选）无需复制到新服务器，它们将在启动时重新创建，但是可能需要一些时间才能重建（预计会变慢）。</p></li></ul></li><li class="list__item" id="8ce66227"><p>Artifacts目录通常很大，如果在服务器移动的情况下需要最大程度地减少服务器的停机时间，则可以使用通用方法来复制数据：使用rsync，robocopy或类似工具复制原始服务器时的数据运行。重复执行几次同步，直到同步的数据量减少。在原始服务器关闭后运行最终同步。服务器移动的替代解决方案是使新服务器可以访问旧数据工件目录，并将其配置为<a href="teamcity-configuration-and-maintenance.html">工件的</a>第二个<a href="teamcity-configuration-and-maintenance.html">位置</a> 。然后在服务器运行时将文件从第二个位置复制到主位置，复制完成后重新启动服务器。</p></li><li class="list__item" id="20940c1d"><p>创建在新架构或新数据库服务器中TeamCity安装正在使用的<a href="setting-up-an-external-database.html">数据库的</a>副本。可以使用特定于数据库的工具或捆绑的keepDB工具来完成此任务，方法是<a href="creating-backup-via-maintaindb-command-line-tool.html">备份</a>数据库数据，然后<a href="restoring-teamcity-data-from-backup.html">还原</a>它。</p></li><li class="list__item" id="823416ae"><p>配置新的TeamCity安装以使用正确的<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code>和<a href="setting-up-an-external-database.html">数据库</a> （ <code class="code">.BuildServer/config/database.properties</code>指向数据库的副本）</p></li><li class="list__item" id="348f27b7"><p>执行必要的<a href="#Environment-transferring">环境转移</a> 。</p></li></ol><aside class="tip sideblock" rel="a992bceb" id="5211d054" data-title=""><p id="069f1b35">如果要快速检查并且不想在新服务器上保留构建历史记录，则可以跳过步骤6（克隆数据库），并将步骤5的所有项目标记为可选。</p></aside><p id="02736327"><a name="environment_transfer"></a><a name="HowTo...-environment_transfer"></a></p></div><a name="Environmenttransferring"></a><a name="Environment-transferring"></a><div class="chapter"><h3 id="HowTo...-Environmenttransferring">环境转移</h3><p id="d2371292">如果已针对现有TeamCity安装进行了专门修改，请考虑转移相关环境。这可能包括：</p><ul class="list _ul"><li class="list__item" id="459ec576"><p>使用适当的OS用户帐户通过正确配置的设置，全局和文件系统权限运行TeamCity服务器进程</p></li><li class="list__item" id="4d82ba99"><p>使用相同的<a href="configuring-teamcity-server-startup-properties.html">TeamCity进程启动选项</a> ，特别是从以下位置开始检查/复制环境变量<code class="code">TEAMCITY\_</code></p></li><li class="list__item" id="7adc57b1"><p>确保可以访问在TeamCity Web UI中使用绝对路径配置的任何文件/设置</p></li><li class="list__item" id="b406b654"><p>如果依靠操作系统级别的用户/机器设置（例如默认的ssh密钥，缓存的VCS访问凭据），也要进行传输</p></li><li class="list__item" id="d493a5c2"><p>考虑在网络配置等中复制与机器相关的任何特殊设置或例外。</p></li><li class="list__item" id="7c9302fb"><p>如果对TeamCity安装进行了任何修补（GrrovyPlug插件，用于MS SQL Server集成安全认证的本机驱动程序），请对安装副本进行相同的修改</p></li><li class="list__item" id="f4654a73"><p>如果在操作系统启动时运行TeamCity（例如Windows服务），请确保在新计算机上执行相同的配置</p></li><li class="list__item" id="9a348ccc"><p>查看并转移设置中的<code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a> <code class="code">>\conf\teamcity-startup.properties</code>文件</p></li><li class="list__item" id="8d4b5649"><p>考虑以下任何自定义设置<code class="code"><</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a><code class="code">>\conf\server.xml</code></p></li></ul><p id="d2a365e1"><a name="copy_server_license"></a><a name="HowTo...-copy_server_license"></a></p></div><a name="Licensingissues"></a><a name="Licensing-issues"></a><div class="chapter"><h3 id="HowTo...-Licensingissues">许可问题</h3><p id="e2579f9c">单个TeamCity许可证<b id="7580a2f2">不能同时在两个运行的服务器</b>上使用。</p><ul class="list _ul"><li class="list__item" id="12c0c5b6"><p>为冗余/备份目的而创建的服务器副本可以使用相同的许可证，因为一次只能运行其中一台服务器。</p></li><li class="list__item" id="b561db2b"><p>为测试目的而创建的服务器的副本需要附加许可证。您可以从TeamCity官方<a href="http://www.jetbrains.com/teamcity/download/" rel="noopener noreferrer" data-external="true" target="_blank">下载页面中</a>获得一次限时的TeamCity <a href="licensing-policy.html">评估许可证</a> 。如果您需要扩展许可证或已经评估了相同的TeamCity版本，请<a href="http://www.jetbrains.com/company/contacts/index.html#Contacts_?TeamCity" rel="noopener noreferrer" data-external="true" target="_blank">联系我们的销售部门</a> 。</p></li><li class="list__item" id="61935c89"><p>打算与主要服务器同时（出于生产目的）同时运行的服务器副本需要单独的许可证。</p></li></ul></div><a name="CopiedServerChecklist"></a><a name="Copied-Server-Checklist"></a><div class="chapter"><h3 id="HowTo...-CopiedServerChecklist">复制的服务器清单</h3><p id="f74309f7">如果要创建副本（而不是这种方式移动服务器），那么请仔细阅读以下清单：</p><ul class="list _ul"><li class="list__item" id="b70798d3"><p>确保新服务器配置为使用与原始服务器不同的其他数据目录和数据库；还要检查服务器的全局设置上的“工件目录”设置；</p></li><li class="list__item" id="9e01cd88"><p>通过从XML的XML中删除“ uuid”属性来更改服务器唯一ID <code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>\config\main-config.xml</code>第一次启动之前归档；</p></li><li class="list__item" id="6ca02f9f"><p>确保在多个服务器上不使用相同的许可证密钥（ <a href="#Licensing-issues">更多关于许可</a> ）；</p></li><li class="list__item" id="db6ea5da"><p>在<b id="6670813f">管理</b>上更新<a href="configuring-server-url.html">服务器URL</a> | <b id="54f00183">全局设置</b>页面到服务器的实际URL；</p></li><li class="list__item" id="02493123"><p>检查您是否可以在新服务器上成功进行身份验证，必要时使用<a href="super-user.html">超级用户</a>访问权限；</p></li><li class="list__item" id="d1ac6eae"><p>检查VCS服务器，问题跟踪服务器，电子邮件和Jabber服务器以及其他服务器访问的系统是否可访问；</p></li><li class="list__item" id="05ffa157"><p>检查是否配置了任何将事件推送到TeamCity服务器的系统（例如VCS挂钩，自动生成触发，监视器等），以了解新服务器；</p></li><li class="list__item" id="c3341352"><p>查看已安装插件的列表，以确定是否需要更改其设置；</p></li><li class="list__item" id="1160dafc"><p>安装新代理（或从现有代理中选择一些）并配置它们以连接到新服务器（使用新服务器URL）；</p></li><li class="list__item" id="f0efc431"><p>检查是否已重新配置从服务器读取的客户端（下载工件，使用服务器的REST API，NuGet feed等）。</p></li></ul><p id="4dfea2f1">如果要创建<b id="ac608c7d">测试服务器</b> ，则需要确保用户和生产系统不受影响。通常，这意味着您需要：</p><ul class="list _ul"><li class="list__item" id="50bcdfa3"><p>禁用电子邮件，Jabber（在“管理>通知程序”部分中），还可能禁用自定义通知程序，或更改其设置以防止新服务器发出通知；</p></li><li class="list__item" id="e0a29956"><p>禁用电子邮件验证（在“管理>身份验证”部分中）；</p></li><li class="list__item" id="717d225b"><p>确保不要运行任何会更改（例如部署到）生产环境的构建。这通常还包括部署到非本地存储库的Maven构建。您可以通过暂停<a href="build-queue.html">构建队列</a>来阻止任何构建；</p></li><li class="list__item" id="97317553"><p>禁用云集成（以使其不干扰主服务器）；</p></li><li class="list__item" id="af7c256a"><p>禁用外部工件存储（否则运行/删除构建和服务器清理将影响生产服务器可能使用的存储）；</p></li><li class="list__item" id="5a1c0560"><p>禁用Git注册表清理（或仅禁用服务器上的清理）；</p></li><li class="list__item" id="255a638b"><p>禁用提交状态发布； *禁用基于TeamCity事件将数据推送到其他非复制系统的任何插件； *禁用<a href="storing-project-settings-in-version-control.html">将项目设置存储在VCS中的功能</a> ：set <code class="code">teamcity.versionedSettings.enabled=false</code>内部财产；</p></li><li class="list__item" id="786af0e4"><p>考虑大幅增加<a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS检查更改间隔</a> （服务器范围的默认值，并在VCS根目录中覆盖）或更改VCS根目录的设置，以防止它们联系生产服务器。从TeamCity 10.0.3开始，另请参见<a href="https://youtrack.jetbrains.com/issue/TW-47324" rel="noopener noreferrer" data-external="true" target="_blank">TW-47324</a> 。</p></li></ul><p id="c6f1f972">另请参阅以下有关<a href="#Move-TeamCity-Installation-to-a-New-Machine">将服务器</a>从一台机器<a href="#Move-TeamCity-Installation-to-a-New-Machine">移动</a>到另一台机器的部分。</p></div></div><a name="MoveTeamCityProjectsfromOneServertoAnother"></a><a name="Move-TeamCity-Projects-from-One-Server-to-Another"></a><div class="chapter"><h2 id="HowTo...-MoveTeamCityProjectsfromOneServertoAnother">将TeamCity项目从一台服务器移动到另一台服务器</h2><p id="784cac08">如果需要将数据移动到没有现有数据的新服务器上，建议先<a href="#Move-TeamCity-Installation-to-a-New-Machine">移动服务器</a>或<a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">复制</a>它，然后删除新服务器上不需要的数据。</p><p id="eecbd41c">如果您需要将数据与新服务器上的现有数据结合在一起，则可以使用一项专用功能将包含大多数关联数据的项目从一台服务器移动到另一台服务器： <a href="projects-import.html">Projects Import</a> 。</p><p id="36c20229"><i id="7a702f6e">以下是有关手动移动设置的一些注意事项，以防您想要执行设置</i></p><p id="5a7dc9af">从TeamCity 8.0开始，可以通过简单的文件复制将项目或构建配置的<i id="5c00ed9f">设置</i>移动到另一台服务器。对于早期的TeamCity版本，请参阅<a href="http://youtrack.jetbrains.net/issue/TW-4124#comment=27-76834" rel="noopener noreferrer" data-external="true" target="_blank">注释</a> 。</p><p id="01c8bee5">两个TeamCity服务器（源服务器和目标服务器）应具有完全相同的版本（相同的内部版本）。</p><p id="c39942ff">两个服务器的所有项目，构建配置和VCS根目录中的所有<a href="identifier.html">标识符</a>均应唯一。如果不是，则可以通过Web UI进行更改。如果在不同的服务器上存在具有相同ID的实体，则假定这些实体相同。例如，这对于在所有服务器上具有一组全局的VCS根很有用。</p><p id="9a2ccb42">要将项目及其所有构建配置的设置从一台服务器移动到另一台服务器：</p><p id="7caf70f6">来自<a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> ，复制相应项目的目录（ <code class="code">.BuildServer\config\projects\<id></code> ）及其所有父项目<code class="code">.BuildServer\config\projects</code>目标服务器。这将移动项目设置，构建配置设置，在项目中定义的VCS根目录，并保留它们之间的链接。如果目标服务器上有与复制的文件同名的文件，则可能发生以下情况：a）id匹配：目标服务器上已经存在相同的实体，在这种情况下，可以将冲突文件排除在复制之外，或者b）id冲突：不同的实体碰巧具有相同的ID。在这种情况下，应通过更改源或目标服务器上的实体ID来满足唯一性要求来解决该问题。</p><p id="cbf53fc3">父项目集将根据Web UI或磁盘上的目录名称进行手动标识（默认情况下将具有相同的前缀）。</p><p id="b65b7d27">注意：保持<a href="project.html#Root-Project">根项目</a>的设置在所有服务器之间同步可能是有意义的（通过同步<code class="code">.BuildServer\config\projects_Root</code>目录）。例如，这将确保所有服务器上的默认清除策略设置相同。</p><p id="cc58a595">项目复制后的其他步骤可能是：</p><ul class="list _ul"><li class="list__item" id="0d853bf9"><p>删除目标服务器上已复制的父项目（如果有）中的未使用数据</p></li><li class="list__item" id="05a4b874"><p>使用“服务器运行状况”报告来识别由于复制而出现的重复VCS根（如果有）</p></li><li class="list__item" id="f17940fd"><p>在源服务器上存档项目并调整清理规则（以便在必要时能够查看构建的历史记录）</p></li></ul><p id="79477fb2">上面的方法<i id="5ec51646">没有</i>复制什么：</p><ul class="list _ul"><li class="list__item" id="d386da47"><p>暂停注释和暂停构建配置的用户</p></li><li class="list__item" id="67d5773d"><p>归档项目的用户</p></li><li class="list__item" id="5f477a79"><p>全局服务器设置（例如Maven settings.xml配置文件，工具（例如handle.exe），外部更改查看器，构建队列优先级，问题跟踪器）。这些存储在下面的各种文件下<code class="code">.BuildServer\config</code>目录，并且应该在文件级别或通过在服务器管理UI中配置相同的设置进行同步。</p></li><li class="list__item" id="f41fedc0"><p>与代理商池的项目关联</p></li><li class="list__item" id="f3c8d155"><p>不是复制项目的父项目的其他项目的模板。实际上，TeamCity 8.0中已弃用此配置，并且仅支持旧配置。在多个项目中使用的模板应移至公共父项目或根项目。</p></li><li class="list__item" id="f5290269"><p>没有为代理配置任何数据（允许在代理上运行的构建配置）。</p></li><li class="list__item" id="7897eb77"><p>没有与用户相关或与用户组相关的设置（例如角色和通知规则）</p></li><li class="list__item" id="4e28f13c"><p>没有与状态相关的数据，例如静音和调查等。</p></li></ul></div><a name="MoveTeamCityInstallationtoaNewMachine"></a><a name="Move-TeamCity-Installation-to-a-New-Machine"></a><div class="chapter"><h2 id="HowTo...-MoveTeamCityInstallationtoaNewMachine">将TeamCity安装移至新计算机</h2><p id="798c0ae6">如果您需要将现有的TeamCity安装移动到新硬件或干净的OS上，则可以在新计算机上安装相同的TeamCity版本，停止旧服务器，然后将新服务器连接到同一台计算机上。 <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a>并确保服务器使用<a href="#Environment-transferring">相同的环境</a> 。或者，您可以按照<a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">有关将</a>服务器从一台计算机<a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">复制</a>到另一台计算机<a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">上</a>的<a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">说明进行操作</a> 。</p><p id="859a0510">移动后，使客户端<a href="#Switching-from-one-server-to-another">使用新的服务器地址</a> （如果更改）。</p><p id="4f9e5af6">将服务器从一台计算机移动到另一台计算机时，可以使用现有的<a href="licensing-policy.html#Managing-Licenses">许可证密钥</a> （只要没有同时运行两个服务器）。由于许可证密钥存储在<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code> ，您将许可证密钥与所有其他TeamCity设置数据一起传输。</p><p id="0468b574">通常建议不要将TeamCity更新与任何其他操作（例如环境或硬件更改）结合使用，并且一次执行一次更改，以便在出现问题时可以轻松地找到原因。</p><a name="Switchingfromoneservertoanother"></a><a name="Switching-from-one-server-to-another"></a><div class="chapter"><h3 id="HowTo...-Switchingfromoneservertoanother">从一台服务器切换到另一台</h3><p id="0e6a2ad7">注意<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code>数据库应在任何给定时刻由单个TeamCity实例使用。如果您将新的TeamCity实例配置为使用相同的数据，请确保在启动新的TeamCity实例之前先关闭并禁用它。</p><p id="43be40d9">通常，建议使用域名访问服务器（在代理配置中以及用户访问TeamCity Web UI时）。这样，您可以更新DNS条目以使地址解析为新服务器的IP地址，并且所有缓存的DNS结果过期后，所有客户端将自动使用新服务器。您可能需要提前减少更改之前的DNS服务器缓存/租赁时间，以使客户端快速“理解”更改。</p><p id="7010e4e0">但是，如果需要使用其他服务器域地址，则需要：</p><ul class="list _ul"><li class="list__item" id="50670580"><p>将代理切换到新的网址（需要更新<code class="code">serverUrl</code>财产<code class="code">buildAgent.properties</code>在每个代理上）。如果要重新安装代理，但保留代理的名称和身份验证状态，则可以安装新的代理并复制<code class="code">conf\buildAgent.properties</code>来自旧代理的文件（检查其中的所有路径是否已相应更新）。</p></li><li class="list__item" id="56aa0497"><p>新服务器启动后，请记住在“ <b id="64eab148">管理”</b> |“更新”上更新<a href="configuring-server-url.html">服务器URL</a> 。 <b id="a660a681">全局设置</b>页面。</p></li><li class="list__item" id="7d8bbb1d"><p>在新地址上通知所有TeamCity用户</p></li><li class="list__item" id="a52dff4b"><p>如果外部服务的设置取决于请求的原始地址，请考虑更新它们</p></li></ul></div></div><a name="MoveTeamCityAgenttoaNewMachine"></a><a name="Move-TeamCity-Agent-to-a-New-Machine"></a><div class="chapter"><h2 id="HowTo...-MoveTeamCityAgenttoaNewMachine">将TeamCity Agent移至新计算机</h2><p id="2ab18cbb">除二进制文件外，TeamCity代理程序安装还存储其配置和运行时生成的数据。通常，以前版本的数据可以为将来的版本做准备，但是可以在必要时将其删除。配置存储在<code class="code">conf</code>和<code class="code">launcher\conf</code>目录。先前版本收集的数据存储在<code class="code">work</code>和<code class="code">system</code>目录。</p><p id="a7355b4a">将代理程序安装移至新计算机或新位置的最简单方法是：</p><ul class="list _ul"><li class="list__item" id="eba245ef"><p>停止现有代理</p></li><li class="list__item" id="1326ba54"><p>在新机器上<a href="setting-up-and-running-additional-build-agents.html">安装</a>新代理</p></li><li class="list__item" id="5ce06108"><p>复制<code class="code">conf/buildAgent.properties</code>从旧的安装到新的安装</p></li><li class="list__item" id="7845ddad"><p>启动新代理。通过这些步骤，TeamCity服务器将识别代理为相同代理，并将对所有构建执行<a href="clean-checkout.html">干净签</a>出。</p></li></ul><p id="2c6936e5">也请查看此<a href="agent-home-directory.html">部分</a>以获取可删除的目录列表，而不会影响版本一致性。</p></div><a name="SharetheBuildnumberforBuildsinaChainBuild"></a><a name="Share-the-Build-number-for-Builds-in-a-Chain-Build"></a><div class="chapter"><h2 id="HowTo...-SharetheBuildnumberforBuildsinaChainBuild">在链式构建中共享构建的内部版本号</h2><p id="f0e137d8">可以通过引用以下依赖项属性来共享由<a href="dependent-build.html#Snapshot-Dependency">快照依赖项</a>或<a href="dependent-build.html#Artifact-Dependency">工件依赖项</a>连接的内部版本号： <code class="code">%dep.&lt;btID&gt;.system.build.number%</code> 。</p><p id="987a0baf">例如，您具有要同步构建的构建配置A和B：使用相同的来源并采用相同的构建号。<br>请执行下列操作：</p><ol class="list _decimal"><li class="list__item" id="1774283c"><p>创建构建配置C，然后创建快照依赖项： <b id="ae405035">C</b> <b id="8c8bf253">上的</b> <b id="ae405035">A以及C上的</b> <b id="8c8bf253">B。</b></p></li><li class="list__item" id="b85f6dad"><p>在A和B中将<a href="configuring-general-settings.html#Build-Number-Format">内部版本号格式</a>设置为：</p></li></ol><div class="code-block" data-lang="bash">％dep。 <btid>.system.build.number％</btid></div><p id="a46a6e0f">哪里<code class="code"><btID></code>是<a href="build-configuration.html">构建配置</a> C的<a href="build-configuration.html">ID。</a>当通过将<a href="snapshot-dependencies.html">Snapshot Dependencies</a>快照依赖项选项设置为off来关闭生成重用时，该方法最有效。</p><p id="85501851"><a href="predefined-build-parameters.html#Configuration-Parameters">阅读</a>有关依赖属性的<a href="predefined-build-parameters.html#Configuration-Parameters">更多</a>信息。</p><p id="5729ae6c">请观看/评论有关共享内部版本号<a href="http://www.jetbrains.net/tracker/issue/TW-7745" rel="noopener noreferrer" data-external="true" target="_blank">TW-7745的问题</a> 。</p></div><a name="MakeTemporaryBuildFilesErasedbetweentheBuilds"></a><a name="Make-Temporary-Build-Files-Erased-between-the-Builds"></a><div class="chapter"><h2 id="HowTo...-MakeTemporaryBuildFilesErasedbetweentheBuilds">使生成之间删除临时生成文件</h2><p id="2c03be7b">更新您的构建脚本以使用存储在其中的路径<code class="code">${teamcity.build.tempDir}</code> （蚂蚁的样式名称）属性作为临时目录。TeamCity代理在构建之前创建<a href="agent-home-directory.html#temp-dir">目录，</a>并在构建之后立即将其删除。</p></div><a name="ClearBuildQueueifItHasTooManyBuildsduetoaConfigurationError"></a><a name="Clear-Build-Queue-if-It-Has-Too-Many-Builds-due-to-a-Configuration-Error"></a><div class="chapter"><h2 id="HowTo...-ClearBuildQueueifItHasTooManyBuildsduetoaConfigurationError">如果由于配置错误而导致构建数量过多，请清除构建队列</h2><p id="3c75b70b">尝试暂停将构建排队的构建配置。在构建配置暂停时，将从队列中删除其所有构建。<br>还可以在单个对话框中从构建队列中删除许多构建。</p></div><a name="AutomaticallycreateorchangeTeamCitybuildconfigurationsettings"></a><a name="Automatically-create-or-change-TeamCity-build-configuration-settings"></a><div class="chapter"><h2 id="HowTo...-AutomaticallycreateorchangeTeamCitybuildconfigurationsettings">自动创建或更改TeamCity构建配置设置</h2><p id="b48a9eef">如果您需要一定程度的自动化并且Web管理UI不能满足您的需求，则有几种可能性：</p><ul class="list _ul"><li class="list__item" id="13dc0783"><p>使用<a href="rest-api.html">REST API</a></p></li><li class="list__item" id="36e3bbb8"><p>直接在磁盘上更改配置文件（有关更多信息，请参见<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">></code> ）</p></li><li class="list__item" id="8060f0b5"><p>编写一个TeamCity Java插件，它将使用<a href="https://confluence.jetbrains.com/display/TCD18/Developing+TeamCity+Plugins" rel="noopener noreferrer" data-external="true" target="_blank">开放的API</a>执行任务。</p></li></ul></div><a name="AttachCucumberReportertoAntBuild"></a><a name="Attach-Cucumber-Reporter-to-Ant-Build"></a><div class="chapter"><h2 id="HowTo...-AttachCucumberReportertoAntBuild">将Cucumber Reporter附加到Ant Build</h2><p id="0b9e8cf9">如果将Cucumber用于Java应用程序测试，则应使用<code class="code">--expand</code>又特别<code class="code">--format</code>选项。此外，您还应该指定RUBYLIB环境变量，该变量指向必要的TeamCity Rake Runner红宝石脚本：</p><div class="code-block" data-lang="bash">< <target name="features"><java classname="org.jruby.Main" fork="true" failonerror="true"><classpath><pathelement path="${jruby.home}/lib/jruby.jar"></pathelement><pathelement path="${jruby.home}/lib/ruby/gems/1.8/gems/jvyaml-0.0.1/lib/jvyamlb.jar"></pathelement> ....
       </classpath>
       <jvmarg value="-Xmx512m"></jvmarg>
       <jvmarg value="-XX:+HeapDumpOnOutOfMemoryError"></jvmarg>
       <jvmarg value="-ea"></jvmarg>
       <jvmarg value="-Djruby.home=${jruby.home}"></jvmarg>
       <arg value="-S"></arg>
       <arg value="cucumber"></arg>
       <arg value="--format"></arg>
       <arg value="Teamcity::Cucumber::Formatter"></arg>
       <arg value="--expand"></arg>
       <arg value="."></arg>
       <env key="RUBYLIB"            value="${agent.home.dir}/plugins/rake-runner/rb/patch/common${path.separator}${agent.home.dir}/plugins/rake-runner/rb/patch/bdd"></env>
       <env value="buildserver" key="TEAMCITY_RAKE_RUNNER_MODE"></env>
     </java>
   </target>

</div><p id="f128d1dc">请检查RUBYLIB路径分隔符（为安全起见，对于Windows为';'，对于Linux为'：'或在蚂蚁中为'$ {path.separator}'）。<br>如果使用Rake构建语言启动Cucumber测试，TeamCity将自动添加所有必需的命令行参数和环境变量。此技巧在TeamCity版本> = 5.0中有效。</p></div><a name="GetLastSuccessfulBuildNumber"></a><a name="Get-Last-Successful-Build-Number"></a><div class="chapter"><h2 id="HowTo...-GetLastSuccessfulBuildNumber">获取上一个成功的内部版本号</h2><p id="29c0e92d">使用如下网址：</p><div class="code-block" data-lang="bash">http：// <your teamcity="" server="">/ app / rest / buildTypes / id： <id of="" build="" configuration="">/ builds / status：SUCCESS / number</id></your></div><p id="bb7e4ada">内部版本号将作为纯文本响应返回。<br>对于<code class="code"><ID of build configuration></code> ，请参阅<a href="identifier.html">标识符</a> 。<br><a href="rest-api.html">REST API</a>提供了此功能</p></div><a name="SetupDeploymentforMyApplicationinTeamCity"></a><a name="Set-up-Deployment-for-My-Application-in-TeamCity"></a><div class="chapter"><h2 id="HowTo...-SetupDeploymentforMyApplicationinTeamCity">在TeamCity中为我的应用程序设置部署</h2><p id="460c4647">TeamCity具有足够的功能，可以使用在构建脚本/构建运行器中配置的实际部署逻辑来处理部分编排流程。TeamCity支持各种通用的构建工具，因此可以在TeamCity中运行任何特定的工具。为了简化特定工具的使用，可以将其包装到meta-runner中或为此编写一个自定义插件。</p><p id="52676884">通常，用于配置部署的设置步骤为：</p><ol class="list _decimal"><li class="list__item" id="43ea5188"><p>编写一个构建脚本，该脚本将对磁盘上可用的二进制文件执行部署任务。 （例如，为此使用Ant或MSBuild。对于典型的部署传输，请使用<a href="deployers.html">Deployer运行程序</a> 。另请参阅<a href="#Integrate-with-Build-and-Reporting-Tools">与构建和报告工具集成</a> 。您可以使用<a href="working-with-meta-runner.html">Meta-Runner</a>通过方便的UI重用脚本。</p></li><li class="list__item" id="9e15a9bf"><p>在TeamCity中创建一个构建配置，该配置将执行构建脚本并执行实际部署。如果只有有限的一组用户可以看到或开始部署，则将构建配置放在单独的TeamCity项目中，并确保用户在项目中具有适当的权限。</p></li><li class="list__item" id="3c45a813"><p>在此构建配置中，配置<a href="dependent-build.html#Artifact-Dependency">工件依赖</a>于生成需要部署的二进制文件的构建配置。</p></li><li class="list__item" id="0de9686b"><p>如果您需要自动触发部署（例如，部署上一个固定的构建中的最后一个成功），或者在生成要部署的二进制文件的构建中使用“升级”操作，请在部署的构建配置中配置可用的触发器之一。</p></li><li class="list__item" id="13d67a39"><p>除了考虑工件<a href="dependent-build.html#Snapshot-Dependency">依赖之外</a> ，还考虑使用<a href="dependent-build.html#Snapshot-Dependency">快照依赖关系</a> ，并检查“ <a href="build-chain.html">构建链”</a>选项卡以获取构建概述。在这种情况下，工件依赖项应使用“从同一链构建”选项。</p></li><li class="list__item" id="761ec9d0"><p>如果需要对部署进行参数化（例如，在不同的运行中指定不同的目标计算机），请使用<a href="triggering-a-custom-build.html">自定义构建运行对话框</a>将参数传递给构建脚本。考虑使用<a href="typed-parameters.html">类型化参数</a>使自定义运行对话框更易于使用或处理密码。</p></li><li class="list__item" id="12591383"><p>如果手动触发部署构建，请考虑在构建脚本中添加命令以固定和标记正在部署的构建（通过发送<a href="rest-api.html#Build-Tags">REST API</a>请求）。您还可以<a href="#Share-the-Build-number-for-Builds-in-a-Chain-Build">使用</a>生成工件<a href="#Share-the-Build-number-for-Builds-in-a-Chain-Build">的内部版本号</a> 。</p></li></ol><p id="c09a7d0d">进一步建议：</p><ul class="list _ul"><li class="list__item" id="836c1ec1"><p>为每个目标环境设置单独的构建配置</p></li><li class="list__item" id="5f1e96c5"><p>使用内部版本的“依赖关系”选项卡在内部版本生成二进制文件和部署内部版本/任务之间进行导航</p></li><li class="list__item" id="51485986"><p>如有必要，请在“提示”显示模式下使用参数，以在运行构建时要求“ <a href="https://youtrack.jetbrains.com/issue/TW-8284#comment=27-290611" rel="noopener noreferrer" data-external="true" target="_blank">确认</a> ”</p></li><li class="list__item" id="791eddca"><p><a href="https://youtrack.jetbrains.com/issue/TW-20617#comment=27-527943" rel="noopener noreferrer" data-external="true" target="_blank">更改</a>构建配置的<a href="https://youtrack.jetbrains.com/issue/TW-20617#comment=27-527943" rel="noopener noreferrer" data-external="true" target="_blank">标题</a> “运行”按钮</p></li></ul><p id="201662f7">官方网站上的相关部分： <a href="http://www.jetbrains.com/teamcity/features/deployment.html" rel="noopener noreferrer" data-external="true" target="_blank">使用TeamCity进行持续部署</a></p></div><a name="UseanExternalToolthatMyBuildRelieson"></a><a name="Use-an-External-Tool-that-My-Build-Relies-on"></a><div class="chapter"><h2 id="HowTo...-UseanExternalToolthatMyBuildRelieson">使用我的构建所依赖的外部工具</h2><p id="1c9099af">如果需要使用特定的外部工具来安装在构建代理上以运行构建，则可以使用以下选项：</p><ul class="list _ul"><li class="list__item" id="ff418e4f">在TeamCity中安装并注册该工具：<ol class="list _decimal"><li class="list__item" id="a4e12b94"><p>在将运行该构建的所有代理上安装该工具。这可以手动完成，也可以通过自动脚本完成。对于简单的文件分发，另请参阅<a href="installing-agent-tools.html">安装代理工具</a></p></li><li class="list__item" id="faab2759"><p>将属性添加到<code class="code">buildAgent.properties</code>文件（或将环境变量添加到系统），并以工具起始位置作为值。</p></li><li class="list__item" id="d4a04aae"><p>在构建配置中为属性添加代理要求。</p></li><li class="list__item" id="4ffa0e7e"><p>使用构建脚本中的属性。</p></li></ol></li><li class="list__item" id="269ed6ea"><p>将工具签入版本控制并使用相对路径。</p></li><li class="list__item" id="6026aa0b"><p>将环境准备阶段添加到构建脚本中，以在其他位置获取工具表格。</p></li><li class="list__item" id="cdb82759"><p>使用单个“伪”构建创建一个单独的构建配置，该构建将包含所需文件作为工件，然后使用工件依赖关系将文件发送到目标构建。</p></li></ul></div><a name="IntegratewithBuildandReportingTools"></a><a name="Integrate-with-Build-and-Reporting-Tools"></a><div class="chapter"><h2 id="HowTo...-IntegratewithBuildandReportingTools">与构建和报告工具集成</h2><p id="c7d71b23">如果您拥有一个构建工具或一个生成一些报告/提供代码度量标准的工具，而<a href="teamcity-documentation.html#TeamCity-2019.x-Supported-Platforms-and-Environments">TeamCity</a>或任何<a href="https://plugins.jetbrains.com/teamcity" rel="noopener noreferrer" data-external="true" target="_blank">插件</a>尚不<a href="teamcity-documentation.html#TeamCity-2019.x-Supported-Platforms-and-Environments">支持</a>这些度量标准，那么即使没有专门的集成，您很可能也可以在TeamCity中使用它。</p><p id="9644b5bc">涉及的集成任务是在构建范围内收集数据，然后将数据报告给TeamCity，以便可以以构建结果或其他方式显示它们。</p><p id="52ba325e"><b id="7d7c4770">数据采集</b></p><p id="a292600d">最简单的开始方法是修改构建脚本，以使用选定的工具并收集所有必需的数据。<br>如果可以从命令行控制台运行该工具，则可以使用<a href="command-line.html">命令行</a>运行器在TeamCity中运行它。这将使您能够检测到打印到标准错误输出中的消息。如果退出代码不为零，或者通过<a href="build-failure-conditions.html">构建失败条件</a>输出到标准错误，则可以将该构建标记为失败。<br>如果该工具具有用于任何受支持的构建脚本引擎（如Ant，Maven或MSBuild）的启动器，则可以在TeamCity中使用相应的运行器来启动该工具。另请参阅<a href="#Use-an-External-Tool-that-My-Build-Relies-on">使用我的构建所依赖的外部工具，以</a>获取有关如何运行外部工具的建议。</p><p id="98c5d5ff">您也可以考虑创建一个<a href="working-with-meta-runner.html">Meta Runner，</a>以使该工具在TeamCity中具有专用的UI。</p><p id="f0cea82a">对于高级集成，可以使用Java开发自定义的<a href="https://plugins.jetbrains.com/docs/teamcity/build-runner-plugin.html" rel="noopener noreferrer" data-external="true" target="_blank">TeamCity插件</a> ，以简化工具的配置和运行。</p><p id="eb5c040c"><b id="649604c2">在TeamCity中呈现数据</b></p><p id="f2bf9aa1">可以通过<a href="build-script-interaction-with-teamcity.html#Reporting-Build-Progress">服务消息</a>将构建进度报告给TeamCity，还可以<a href="build-script-interaction-with-teamcity.html#Reporting-Build-Status">更新</a>构建状态文本。</p><p id="2a3099e4">对于测试工具，如果尚不<a href="testing-frameworks.html">支持</a>它们，则可以通过<a href="build-script-interaction-with-teamcity.html#Reporting-Tests">与测试相关的服务消息</a>将测试进度从构建报告给TeamCity，或者在构建中生成一个受支持的<a href="xml-report-processing.html">XML报告</a> ，然后通过配置的XML报告的服务消息将其导入。处理构建功能。</p><p id="e4b2ae16">为了显示通用报告的结果，该方法可能是在构建脚本中生成HTML报告，将其打包到存档中并作为构建工件发布。然后配置<a href="including-third-party-reports-in-the-build-results.html">报告选项卡，</a>以将HTML报告显示为构建结果的选项卡。</p><p id="40a03c40">度量值可以通过<a href="build-script-interaction-with-teamcity.html#Reporting-Build-Statistics">服务消息</a>作为TeamCity统计<a href="build-script-interaction-with-teamcity.html#Reporting-Build-Statistics">信息发布</a> ，然后显示在<a href="customizing-statistics-charts.html#Showing-Charts-Only-for-Specific-Build-Configurations-on-Project-Level">自定义图表中</a> 。您还可以根据指标配置<a href="build-failure-conditions.html#Fail-build-on-metric-change">构建失败条件</a> 。</p><p id="fc68d96b">如果该工具报告检查或重复等代码属性信息，则可以使用TeamCity捆绑的报告来显示结果。必须使用自定义插件才能将工具特定的报告处理为TeamCity特定的数据模型。可以在<a href="xml-report-processing.html">XML Test Reporting</a>插件和FXCop插件中找到此示例（请参阅<a href="https://confluence.jetbrains.com/display/TW/Open-source+Bundled+Plugins" rel="noopener noreferrer" data-external="true" target="_blank">开源捆绑插件</a>上的链接）。</p><p id="7a3daa15">另请参见<a href="#Import-coverage-results-in-TeamCity">TeamCity中的导入覆盖率结果</a> 。</p><p id="7388f62d">对于高级集成，将需要一个自定义插件来根据需要存储和显示数据。有关插件开发的更多信息，请参见<a href="https://confluence.jetbrains.com/display/TCD18/Developing+TeamCity+Plugins" rel="noopener noreferrer" data-external="true" target="_blank">开发TeamCity插件</a> 。</p></div><a name="RestoreJustDeletedProject"></a><a name="Restore-Just-Deleted-Project"></a><div class="chapter"><h2 id="HowTo...-RestoreJustDeletedProject">恢复刚刚删除的项目</h2><p id="a9ca75ed">TeamCity将已删除的项目设置目录（以项目ID命名）移至<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/config/_trash</code>目录添加<code class="code">"<internal ID>"</code>后缀到目录。</p><p id="cd680153">要还原项目，请在_trash目录中找到项目目录，然后将其移动到常规项目设置目录中： <code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/config/projects</code>同时删除<code class="code">".projectN"</code>目录名称的后缀。<br>您可以在服务器运行时执行此操作，它应自动选择还原的项目。</p><p id="d12325bd">请注意，TeamCity会在删除时间之后的5天内将生成的历史记录和其他存储在数据库中的数据保留在已删除的项目/生成配置中。在可<a href="clean-up.html#Deleted-Build-Configurations-Cleanup">配置</a> （默认为5天）超时过去之后，在下次清理期间将删除所有关联的数据（内部版本和测试历史记录，更改等）。</p><p id="1a222864">的<code class="code">config/_trash</code>如果您确定不需要删除的项目，则不会自动清除该目录，并且可以手动清空该目录。无需重新启动服务器。</p></div><a name="Transfer3DefaultAgentstoAnotherServer"></a><a name="Transfer-3-Default-Agents-to-Another-Server"></a><div class="chapter"><h2 id="HowTo...-Transfer3DefaultAgentstoAnotherServer">将3个默认代理传输到另一台服务器</h2><p id="b3be52b1">这是不可能的。</p><p id="796b11de">每个TeamCity服务器（专业版和企业版）允许使用绑定到该服务器的3个或更多代理，而无需任何代理许可证。对于Professional服务器，默认情况下，该服务器实例绑定了3个代理：用户不为这些代理付费，则没有针对它们的许可证密钥。<br>对于企业服务器，代理的数量取决于您的软件包，并且代理绑定到服务器许可证密钥。</p><p id="c6c4257d">因此，绑定到服务器的代理无法转移到另一台服务器。</p><p id="206a467b">如果您需要TeamCity服务器随附的更多构建代理，则可以购买附加的构建代理许可证，并连接服务器附带的代理之外的更多代理。</p><p id="44fd75b0">有关许可的<a href="licensing-policy.html">更多</a>信息。</p></div><a name="ImportcoverageresultsinTeamCity"></a><a name="Import-coverage-results-in-TeamCity"></a><div class="chapter"><h2 id="HowTo...-ImportcoverageresultsinTeamCity">在TeamCity中导入覆盖结果</h2><p id="46fea3fe">TeamCity与IntelliJ IDEA / Emma和Java的JaCoCo覆盖引擎以及.NET的dotCover / NCover / PartCover捆绑在一起。</p><p id="da54ccb0">但是，还有很多其他覆盖工具，例如<a href="http://cobertura.sourceforge.net/index.html" rel="noopener noreferrer" data-external="true" target="_blank">Cobertura</a>和TeamCity不直接支持的其他工具。</p><p id="1c8abdc1">为了使用这些工具获得类似的体验，您可以：</p><ul class="list _ul"><li class="list__item" id="26acd9ee"><p>将Coverage HTML报告发布为TeamCity工件：大多数工具以HTML格式生成Coverage报告，您可以将其发布为工件并<a href="including-third-party-reports-in-the-build-results.html">配置报告选项卡</a>以在TeamCity中显示它。如果工件在根工件目录中发布，并且其名称为<code class="code">coverage.zip</code>并且有<code class="code">index.html</code>文件中，“报告”标签将自动显示。至于运行外部工具，请选中<a href="#Integrate-with-Build-and-Reporting-Tools">与构建和报告工具集成</a> 。</p></li><li class="list__item" id="d8610845"><p>从覆盖率报告中提取覆盖率统计数据，并借助<a href="build-script-interaction-with-teamcity.html#Reporting-Build-Statistics">服务消息</a>将<a href="custom-chart.html#Default-Statistics-Values-Provided-by-TeamCity">统计值</a>发布到TeamCity：如果这样做，您将在构建配置“统计信息”选项卡上看到覆盖率图表，并且还可以通过以下方式使构建失败度量标准更改时构建失败的条件（例如，如果覆盖率下降，则构建失败）。</p></li></ul><aside class="note " rel="3a17e0a5" id="538fd65b" data-title=""><p id="5b4fbeaf">您不应发布代表块/行/方法/类覆盖率百分比的值CodeCoverageB，CodeCoverageL，CodeCoverageM，CodeCoverageC。TeamCity将使用它们的绝对值来计算这些值。例如，CodeCoverageL的计算方式为CodeCoverageAbsLCovered除以CodeCoverageAbsLTotal。您可以发布这些值，但是在这种情况下，它们将缺少小数部分，将无用。</p></aside></div><a name="Recoverfrom" dataformatofthedatadirectory(nnn)andthedatabase(mmm)donotmatc="error" =""></a><a name="Recover-from-" data-format-of-the-data-directory-(nnn)-and-the-database-(mmm)-do-not-matc="-error" =""></a><div class="chapter"><h2 id="HowTo...-Recoverfrom" dataformatofthedatadirectory(nnn)andthedatabase(mmm)donotmatc="error" ="">从“数据目录（NNN）的数据格式和数据库（MMM）的数据格式不匹配”中恢复</h2><p id="ff1f1330">如果得到“数据目录（NNN）的数据格式与数据库（MMM）的数据不匹配”。启动TeamCity时出现错误，这意味着数据库或TeamCity数据目录最近被更改为不一致状态，因此无法一起使用。仔细检查数据库和数据目录的位置，如果它们不是服务器用来存储数据的位置，请更改它们。</p><p id="344a8169">如果它们是正确的，则很可能意味着服务器已使用另一个数据库或数据目录进行了<a href="upgrade.html#Upgrading-TeamCity-Server">升级</a> ，并且主数据目录和数据库未达到<a href="upgrade.html#Upgrading-TeamCity-Server">一致的升级</a>要求。</p><p id="37647ab2">要从状态中恢复，您将需要备份升级前所做的一致状态。您将需要还原该备份，确保将正确的位置用于数据目录和数据库，然后执行TeamCity升级。</p></div><a name="DebugaBuildonaSpecificAgent"></a><a name="Debug-a-Build-on-a-Specific-Agent"></a><div class="chapter"><h2 id="HowTo...-DebugaBuildonaSpecificAgent">在特定代理上调试构建</h2><p id="a54748cf">如果某个代理上的构建失败，则可以在该代理上对其进行调试以调查特定于代理的问题。请执行下列操作：</p><ol class="list _decimal"><li class="list__item" id="0b079aa7"><p>进入TeamCity Web UI中的“ <b id="237c45ba">代理”</b>页面，然后<a href="viewing-build-agent-details.html">选择代理</a> 。</p></li><li class="list__item" id="3e8d5351"><p><a href="build-agents-configuration-and-maintenance.html#Enabling/Disabling-Agents-via-UI">禁用该代理</a>以将其暂时从<a href="build-grid.html">构建网格中</a>删除。添加评论（可选）。要在一定时间段后自动启用代理，请选中相应的框并指定时间。</p></li><li class="list__item" id="6f0df364"><p><a href="working-with-build-results.html">选择</a>要调试的版本。</p></li><li class="list__item" id="0102d2e5"><p>打开<a href="triggering-a-custom-build.html#Run-Custom-Build-dialog">``自定义运行''</a>对话框并指定以下选项：a。在<b id="d4283aee">代理</b>下拉列表中，选择禁用的<b id="d4283aee">代理</b> 。b。建议选择“ <b id="fe024a75">以<a href="personal-build.html">个人版本</a>运行”</b>选项，以避免与常规版本相交。</p></li><li class="list__item" id="6608db3b"><p>调试完成后，如果尚未配置自动重新启用，请手动启用代理。</p></li></ol><p id="2cabd86d">您还可以通过TeamCity的<a href="intellij-platform-plugin.html">IntelliJ IDEA插件</a>在代理上执行测试的<a href="remote-debug.html">远程调试</a> 。</p></div><a name="DebugaPartoftheBuild(abuildstep)"></a><a name="Debug-a-Part-of-the-Build-(a-build-step)"></a><div class="chapter"><h2 id="HowTo...-DebugaPartoftheBuild(abuildstep)">调试构建的一部分（构建步骤）</h2><p id="0db69db6">如果包含多个步骤的构建在某个步骤失败，则可以调试中断的步骤。请执行下列操作：</p><ol class="list _decimal"><li class="list__item" id="4623e51b"><p>转到构建配置并禁用要调试的构建步骤。</p></li><li class="list__item" id="00645c7e"><p><a href="working-with-build-results.html">选择</a>要调试的版本。</p></li><li class="list__item" id="09f08ff2"><p>打开“ <a href="triggering-a-custom-build.html#Run-Custom-Build-dialog">自定义运行”</a>对话框，然后选择<b id="77945d6f">将构建放入<a href="build-queue.html">队列顶部，</a></b>以赋予您构建优先权。</p></li><li class="list__item" id="581e13bc"><p>调试完成后，重新启用构建步骤。</p></li></ol></div><a name="Vulnerabilities"></a><a name="Vulnerabilities"></a><div class="chapter"><h2 id="HowTo...-Vulnerabilities">漏洞</h2><p id="4386a822">本节介绍与已宣布的安全漏洞有关的影响和必要的保护步骤。</p><a name="Heartbleed,ShellShock"></a><a name="Heartbleed,-ShellShock"></a><div class="chapter"><h3 id="HowTo...-Heartbleed,ShellShock">伤心欲绝，ShellShock</h3><p id="f75cf792">JetBrains提供的TeamCity发行版不包含软件/库，也不使用受Heart出血和Shell冲击漏洞影响的技术。仍需要评估的是特定的TeamCity安装实现，该实现可能使用JetBrains提供/推荐的组件后面的组件，并且可能容易受到上述漏洞的攻击。</p></div><a name="POODLE"></a><a name="POODLE"></a><div class="chapter"><h3 id="HowTo...-POODLE">泡菜</h3><p id="fbf44544">如果您配置了对TeamCity服务器的HTTPS访问，请检查用于HTTPS的解决方案，因为它可能会受到影响（例如Tomcat似乎<a href="http://wiki.apache.org/tomcat/Security/POODLE" rel="noopener noreferrer" data-external="true" target="_blank">受到影响</a> ）。目前，TeamCity发行版中没有默认包含HTTPS访问权限，并且调查/消除与HTTPS相关的漏洞不在TeamCity的范围内。</p><p id="7ea04d08">根据使用的设置，TeamCity服务器（和代理）可以建立与其他服务器（例如Subversion）的HTTPS连接。根据服务器设置，这些连接可能会回退到使用SSL 3.0协议。推荐的解决方案不是特定于TeamCity的，而是要在目标SSL服务器端禁用SSLv3。</p></div><a name="GHOST"></a><a name="GHOST"></a><div class="chapter"><h3 id="HowTo...-GHOST">鬼</h3><p id="ccf9946b">在glibc库中发现了CVE-2015-0235漏洞，TeamCity代码未直接使用该漏洞。在* nix平台下，TeamCity使用的Java / JRE使用它。由于Java没有与TeamCity发行版捆绑在一起，因此您应采用所用Java的供应商推荐的安全措施。目前，还没有发布相关的Java特定安全公告，因此更新OS应该足以消除漏洞利用的风险。</p></div><a name="FREAK"></a><a name="FREAK"></a><div class="chapter"><h3 id="HowTo...-FREAK">怪物</h3><p id="adb2c577">在OpenSSL实施中发现了CVE-2015-0204漏洞。TeamCity不捆绑OpenSSL产品的任何部分，因此不容易受到攻击。您可能仍需要查看设置TeamCity服务器和代理的环境，以及除TeamCity之外安装的工具，以采取可能的漏洞缓解步骤。</p></div><a name="ApacheStruts"></a><a name="Apache-Struts"></a><div class="chapter"><h3 id="HowTo...-ApacheStruts">Apache Struts</h3><p id="cef8d55b">CVE-2017-5638影响Apache Struts中的Jakarta Multipart解析器。CVE-2016-1181还影响某些旧版Apache Struts中的多部分请求处理。</p><p id="eb60d18c">TeamCity捆绑了IntelliJ IDEA，其中包含来自以下两个版本的jar：Apache Struts 1.x和Apache Struts2.x。仅当IntelliJ IDEA收集TeamCity代理上的项目检查时，IntelliJ IDEA Struts插件才使用这些jar。</p><p id="e883a279">在任何情况下，这些版本的Apache Struts都不用于处理任何HTTP请求。因此，TeamCity服务器和TeamCity代理均不受这些漏洞的影响。</p></div></div><a name="WatchSeveralTeamCityServerswithWindowsTrayNotifier"></a><a name="Watch-Several-TeamCity-Servers-with-Windows-Tray-Notifier"></a><div class="chapter"><h2 id="HowTo...-WatchSeveralTeamCityServerswithWindowsTrayNotifier">观看带有Windows托盘通知程序的多个TeamCity服务器</h2><p id="db931688">TeamCity托盘通知程序通常用于监视构建并从单个TeamCity服务器接收通知。但是，如果您有多个TeamCity服务器，并且希望同时使用Windows Tray Notifier对其进行监视，则需要使用以下命令从命令行为每个服务器启动一个单独的Tray Notifier实例： <code class="code">/allowMultiple</code>选项：</p><ul class="list _ul"><li class="list__item" id="fde30dea"><p>从TeamCity托盘通知程序安装文件夹（默认情况下， <code class="code">C:\Program Files\JetBrains\TeamCity</code> ），运行以下命令：</p></li></ul><div class="code-block" data-lang="bash">JetBrains。TrayNotifier.exe / allowMultiple</div><p id="0dfef7fd">（可选）对于每个纸盘通知程序实例，您可以使用来显式指定要连接的服务器的URL。 <code class="code">/server</code>选项。否则，对于每个其他的托盘通知程序实例，您将需要注销并通过UI更改服务器的URL。</p><div class="code-block" data-lang="bash">JetBrains。TrayNotifier.exe / allowMultiple / server：http：// myTeamCityServer</div><p id="f95f0ed8">另请参阅问题跟踪器中的<a href="http://jetbrains.net/tracker/issue/TW-4230#comment=27-14194" rel="noopener noreferrer" data-external="true" target="_blank">详细信息</a> 。</p></div><a name="PersonalUserDataProcessing"></a><a name="Personal-User-Data-Processing"></a><div class="chapter"><h2 id="HowTo...-PersonalUserDataProcessing">个人用户数据处理</h2><p id="4035925c">关于TeamCity产品，JetBrains不会收集本地TeamCity安装用户的任何个人数据。有关与JetBrains的客户关系的相关文档可在官方网站上找到： <a href="https://www.jetbrains.com/company/privacy.html" rel="noopener noreferrer" data-external="true" target="_blank">隐私政策</a> ， <a href="https://www.jetbrains.com/store/terms/" rel="noopener noreferrer" data-external="true" target="_blank">购买条款</a> ， <a href="https://www.jetbrains.com/teamcity/buy/license.html" rel="noopener noreferrer" data-external="true" target="_blank">TeamCity许可协议</a> 。</p><p id="b56a15af">当评估您对TeamCity的使用方式如何符合通用数据保护条例（GDPR）（EU）2016/679条例时，以下注释会很有用。这些说明旨在解决最基本的问题，并且可以作为评估特定TeamCity安装的输入。</p><p id="3c3498f3">这些说明基于TeamCity 2017.2.4，在GDPR实施之日即为实际。请至少将TeamCity实例更新为该版本，因为以前的版本可能包含与以下注释不符的问题。</p><a name="TeamCityandUsersPersonalData"></a><a name="TeamCity-and-Users--Personal-Data"></a><div class="chapter"><h3 id="HowTo...-TeamCityandUsersPersonalData">TeamCity和用户的个人数据</h3><p id="7a46343d">TeamCity存储的最重要的与用户相关的数据是：</p><ul class="list _ul"><li class="list__item" id="32dc18cd"><p>全名和用户名-存储在数据库中，并在用户的个人资料中以及在引用用户时显示。当用户触发构建时，这些也会存储在构建的参数中并传递到构建中</p></li><li class="list__item" id="131490bc"><p>用户的电子邮件-存储在数据库中并显示在用户的个人资料中，用于发送通知</p></li><li class="list__item" id="83561909"><p>访问服务器的客户端的IP地址-可以显示在<a href="teamcity-server-logs.html">内部日志中</a></p></li></ul><p id="32cc648f">TeamCity内部日志还可以记录一些非结构化的用户相关信息（例如，由用户提交或由浏览器发送的HTTP请求，这些请求是根据已配置的设置从LDAP等用户源中检索的）</p></div><a name="DeletingtheUserData"></a><a name="Deleting-the-User-Data"></a><div class="chapter"><h3 id="HowTo...-DeletingtheUserData">删除用户数据</h3><p id="3eb654c8">当您要删除特定用户的个人数据时，最好的方法是在TeamCity中删除该用户。这样，所有对用户的引用将继续存储数字用户ID，而不再存储所有其他用户信息。请注意，删除用户后， <a href="tracking-user-actions.html">审核</a>记录将提及内部数字用户ID。</p><p id="d8e45603">如果用户触发了任何构建（即在服务器上仍然存在的任何项目中都具有“运行构建”权限），则用户的用户名和全名将记录为构建的“ teamcity.build.triggeredBy”参数中，如下所示：作为构建“环境”一部分的文本值。如果需要删除它们，则可以删除相关的内部版本（以及所有依赖于工件或快照的内部版本），也可以删除那些受影响的内部版本的参数（这些参数存储在<teamcity data="" directory="">\ system \ artifacts</teamcity>下的存档文件中） <teamcity data="" directory="">***。teamcity \ properties目录）。</teamcity></p><p id="ec1a8af3">删除用户并清除其他数据后，请确保<a href="search.html#Resetting-Search-Index">将搜索索引重置</a>为从搜索索引中删除已删除用户的可能缓存数据。</p><p id="9fff85b9">还有其他几个地方可以保存与用户相关的数据</p><p id="f2269025">如果用户具有“编辑项目”权限，则全名/用户名可以显示在：</p><ul class="list _ul"><li class="list__item" id="e8acd36f"><p>一些审核条目（在2017.2.1之前与TeamCity版本一起保存）-TW <a href="https://youtrack.jetbrains.com/issue/TW-52215" rel="noopener noreferrer" data-external="true" target="_blank">-52215</a></p></li><li class="list__item" id="045c9fc2"><p>“等待等待的持久性任务完成”构建日志行中的一些构建日志（与2017.2.1之前的TeamCity版本一起保存）-TW <a href="https://youtrack.jetbrains.com/issue/TW-52872" rel="noopener noreferrer" data-external="true" target="_blank">-52872</a></p></li><li class="list__item" id="5c4ba4b7"><p>在存储版本化设置的存储库中提交注释，该版本存储了在UI中进行更改的用户的名称</p></li></ul><p id="a79148a7">与VCS相关的数据中的VCS用户名：</p><ul class="list _ul"><li class="list__item" id="cf8d6302"><p>VCS中的更改在UI中可见或存储在数据库中</p></li><li class="list__item" id="6cda1f38"><p>服务器和代理上的本地.git存储库中的克隆</p></li></ul><p id="5183a3c2">用户名也可以出现在以不同集成方式配置的访问凭据中，例如VCS根目录，问题跟踪器，数据库访问等。（这些存储在TeamCity数据目录中的设置文件和审核差异文件中，而VCS根用户名也存储在数据库中用于VCS根目录的当前版本和先前版本）</p><p id="6b39887f">为确保TeamCity不存储用户的详细信息，您可能需要检查TeamCity支持的存储，以确保未存储任何数据：数据库，数据目录和TeamCity主目录（日志和内存转储，通常放置在“ bin”目录）。</p></div><a name="UserAgreement"></a><a name="User-Agreement"></a><div class="chapter"><h3 id="HowTo...-UserAgreement">用户协议</h3><p id="2aa0d012">如果您希望用户在使用TeamCity实例之前接受特殊协议，则可以安装JetBrains为此目的开发的<a href="https://plugins.jetbrains.com/plugin/10722-terms-of-service" rel="noopener noreferrer" data-external="true" target="_blank">专用插件</a> 。有关更多详细信息，请参阅插件的文档。</p></div><a name="Encryption"></a><a name="Encryption"></a><div class="chapter"><h3 id="HowTo...-Encryption">加密</h3><p id="c42efaa4">如果您想对TeamCity使用的数据进行加密，则建议为此使用非TeamCity的通用工具，因为TeamCity不提供专用功能。TeamCity将数据存储在SQL数据库和文件系统中。您可以将数据库配置为以加密形式存储数据，并使用安全的JDBC支持的数据库连接（在<a href="setting-up-an-external-database.html"><code class="code">database.properties</code></a> ）。<br>另外，您可以在操作系统级别的磁盘存储上配置加密。</p></div><a name="LogsandDebuggingData"></a><a name="Logs-and-Debugging-Data"></a><div class="chapter"><h3 id="HowTo...-LogsandDebuggingData">日志和调试数据</h3><p id="d1431cb9">如果要确保内部TeamCity日志的存储时间不超过有限的几天，可以将<a href="teamcity-server-logs.html">内部日志</a>配置为每天轮换日志文件并限制要保留的文件数量。TeamCity代理通常不会以结构化方式处理任何与用户相关的数据，但是如果需要确保日志在代理上定期轮换，则需要以相同的方式配置<a href="viewing-build-agent-logs.html">代理日志</a> 。</p><p id="cf11cbbd">每天轮播可以通过添加配置<code class="code"><param name="rotateOnDayChange" value="true"/></code>所有必填项中的行<code class="code"><appender name="..." class="jetbrains.buildServer.util.TCRollingFileAppender"></code>追加器。将此更改更改为默认值<code class="code">conf\teamcity-server-log4j.xml</code>并记录存储在下面的预设<code class="code"><TeamCity Data Directory>\config\_logging</code> 。</p><p id="d4d10eb2">TeamCity还可以存储诊断数据，例如线程转储，可以以非结构化方式记录与用户相关的数据。建议检查一下内容<code class="code"><</code> <a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a> <code class="code">>\logs</code>定期目录，并确保其中不保留任何旧文件。另外，在记录定制会话（例如收集调试日志等）之后，应删除多余的日志。存在一个<a href="https://youtrack.jetbrains.com/issue/TW-22596" rel="noopener noreferrer" data-external="true" target="_blank">已知问题</a> <code class="code">logs\catalina.out</code>文件，如果根本没有自动旋转。建议建立自动程序以定期旋转文件。</p></div><a name="Customizations"></a><a name="Customizations"></a><div class="chapter"><h3 id="HowTo...-Customizations">客制化</h3><p id="d300b235">这些说明仅介绍捆绑的TeamCity功能以及最常见的记录设置。您应该考虑特定的定制来评估特定的TeamCity安装，例如配置的构建脚本，已安装的插件，通过API与TeamCity通信的外部系统等。</p></div></div><a name="TeamCityReleaseCycle"></a><a name="TeamCity-Release-Cycle"></a><div class="chapter"><h2 id="HowTo...-TeamCityReleaseCycle">TeamCity发布周期</h2><p id="a813e604">以下信息仅可用于参考目的。</p><p id="8ad65b47">以下的“主要”发行版本是指第一个或第二个版本号有所更改的版本（例如XXZ中的X）“错误修正”发行版本是指第三个版本号有所更改的版本（例如XXZ中的Z版本）</p><p id="ef38688b">我们通常拥有的发布阶段是：</p><ul class="list _ul"><li class="list__item" id="6c501608"><p><b id="9369a5e2">在EAP（早期访问计划）下</b>可用-通常仅适用于主要版本，在上一个主要版本之后的几个月开始，通常在下一个主要版本之前的几个月开始。通常，新的EAP版本每月或每两个月<a href="https://confluence.jetbrains.com/display/TW/TeamCity+EAP" rel="noopener noreferrer" data-external="true" target="_blank">发布</a>一次。</p></li><li class="list__item" id="b4a3943c"><p><b id="920d718e">常规发布</b> -通常，每8个月发布一个主要版本。在主要版本之后，有多个错误修正版本。在该版本的“销售终止”之前，将提供Bugfix版本和针对关键问题的支持修补程序（如果适用）。</p></li><li class="list__item" id="eb6d8906"><p><b id="9d3c7012">终止销售</b> -在发布新的主要版本时发生。在此时间之后，通常不会提供错误修正更新或补丁（异常是没有解决方法的关键问题，同时又允许相对简单的修复，并且由于重要原因客户也无法升级）。这些版本仅提供有限的支持。</p></li><li class="list__item" id="53480ade"><p><b id="a8db474a">支持终止</b> -随着两个较新的主要版本的发布而发生。此时，我们将停止为该发行版提供常规技术支持。</p></li></ul><p id="8cb9baa6">先前版本的日期和TeamCity版本的顺序在“ <a href="https://confluence.jetbrains.com/display/TW/Previous+Releases+Downloads" rel="noopener noreferrer" data-external="true" target="_blank">先前版本的下载”</a>页面<a href="https://confluence.jetbrains.com/display/TW/Previous+Releases+Downloads" rel="noopener noreferrer" data-external="true" target="_blank">上</a>列出。</p><hr id="e3fa1963"><p id="52dc9dde"><br></p><p id="d0abac6c"><br></p><p id="3229a49c"><br></p><p id="762857bb"><br></p><p id="10a0e998"><br></p><p id="82fb0faf"><br></p><p id="a5c184a3"><br></p><p id="281f985c"><br></p><p id="1ac52840"><br></p><p id="9feef9f4"><br></p></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>