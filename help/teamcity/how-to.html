<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>How To... - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="viewpage.actionpageId113084582" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/how-to.md|How To..." data-main-title="How To..." data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/how-to.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="viewpage.actionpageId113084582" id="how-to.md">How To...</h1><p id="76c79525">On this page:</p><p id="9b56c082"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#HowTo...-ChooseOS/PlatformforTeamCityServer">Choose OS/Platform for TeamCity Server</a></li><li class="list__item"><a href="#HowTo...-EstimateHardwareRequirementsforTeamCity">Estimate Hardware Requirements for TeamCity</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-NetworkTrafficbetweentheServerandtheAgents">Network Traffic between the Server and the Agents</a></li></ul></li><li class="list__item"><a href="#HowTo...-ConfiguringTeamCityServerforPerformance">Configuring TeamCity Server for Performance</a></li><li class="list__item"><a href="#HowTo...-RetrieveAdministratorPassword">Retrieve Administrator Password</a></li><li class="list__item"><a href="#HowTo...-EstimateExternalDatabaseCapacity">Estimate External Database Capacity</a></li><li class="list__item"><a href="#HowTo...-EstimatetheNumberofRequiredBuildAgents">Estimate the Number of Required Build Agents</a></li><li class="list__item"><a href="#HowTo...-SetupTeamCityinReplication/ClusteringEnvironment">Setup TeamCity in Replication/Clustering Environment</a></li><li class="list__item"><a href="#HowTo...-TeamCitySecurityNotes">TeamCity Security Notes</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-Additionalsecurity-relatedsettings">Additional security-related settings</a></li><li class="list__item"><a href="#HowTo...-Security-relatedRisksEvaluation">Security-related Risks Evaluation</a></li></ul></li><li class="list__item"><a href="#HowTo...-WhatEncryptionisUsedbyTeamCity">What Encryption is Used by TeamCity</a></li><li class="list__item"><a href="#HowTo...-ConfigureNewlyInstalledMySQLServer">Configure Newly Installed MySQL Server</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-InnoDBdatabaseengine">InnoDB database engine</a></li><li class="list__item"><a href="#HowTo...-maxconnections">max_connections</a></li><li class="list__item"><a href="#HowTo...-innodbbufferpoolsizeandinnodblogfilesize">innodb_buffer_pool_size and innodb_log_file_size</a></li><li class="list__item"><a href="#HowTo...-innodbfilepertable">innodb_file_per_table</a></li><li class="list__item"><a href="#HowTo...-innodbflushlogattrxcommit">innodb_flush_log_at_trx_commit</a></li><li class="list__item"><a href="#HowTo...-logfilesondifferentdisk">log files on different disk</a></li><li class="list__item"><a href="#HowTo...-SettingTheBinaryLogFormat">Setting The Binary Log Format</a></li><li class="list__item"><a href="#HowTo...-Enableadditionaldiagnostics">Enable additional diagnostics</a></li></ul></li><li class="list__item"><a href="#HowTo...-ConfigureNewlyInstalledPostgreSQLServer">Configure Newly Installed PostgreSQL Server</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-sharedbuffers">shared_buffers</a></li><li class="list__item"><a href="#HowTo...-checkpoint-relatedparameters">checkpoint-related parameters</a></li><li class="list__item"><a href="#HowTo...-synchronouscommit">synchronous_commit</a></li></ul></li><li class="list__item"><a href="#HowTo...-SetUpTeamCitybehindaProxyServer">Set Up TeamCity behind a Proxy Server</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-ProxyServerSetup">Proxy Server Setup</a></li><li class="list__item"><a href="#HowTo...-Apache">Apache</a></li><li class="list__item"><a href="#HowTo...-NGINX">NGINX</a></li><li class="list__item"><a href="#HowTo...-Commonmisconfigurations">Common misconfigurations</a></li><li class="list__item"><a href="#HowTo...-Otherservers">Other servers</a></li><li class="list__item"><a href="#HowTo...-TeamCityTomcatConfiguration">TeamCity Tomcat Configuration</a></li><li class="list__item"><a href="#HowTo...-Dedicated&#34;Connector&#34;NodeApproach">Dedicated "Connector" Node Approach</a></li><li class="list__item"><a href="#HowTo...-&#34;RemoteIpValve&#34;Approach">"RemoteIpValve" Approach</a></li></ul></li><li class="list__item"><a href="#HowTo...-ConfigureHTTPSforTeamCityWebUI">Configure HTTPS for TeamCity Web UI</a></li><li class="list__item"><a href="#HowTo...-ConfigureTeamCitytoUseProxyServerforOutgoingConnections">Configure TeamCity to Use Proxy Server for Outgoing Connections</a></li><li class="list__item"><a href="#HowTo...-ConfigureTeamCityAgenttoUseProxyToConnecttoTeamCityServer">Configure TeamCity Agent to Use Proxy To Connect to TeamCity Server</a></li><li class="list__item"><a href="#HowTo...-InstallMultipleAgentsontheSameMachine">Install Multiple Agents on the Same Machine</a></li><li class="list__item"><a href="#HowTo...-ChangeServerPort">Change Server Port</a></li><li class="list__item"><a href="#HowTo...-Test-driveNewerTeamCityVersionbeforeUpgrade">Test-drive Newer TeamCity Version before Upgrade</a></li><li class="list__item"><a href="#HowTo...-CreateaCopyofTeamCityServerwithAllData">Create a Copy of TeamCity Server with All Data</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-CreateaServerCopy">Create a Server Copy</a></li><li class="list__item"><a href="#HowTo...-UseTeamCityBackup">Use TeamCity Backup</a></li><li class="list__item"><a href="#HowTo...-CopyManually">Copy Manually</a></li><li class="list__item"><a href="#HowTo...-Environmenttransferring">Environment transferring</a></li><li class="list__item"><a href="#HowTo...-Licensingissues">Licensing issues</a></li><li class="list__item"><a href="#HowTo...-CopiedServerChecklist">Copied Server Checklist</a></li></ul></li><li class="list__item"><a href="#HowTo...-MoveTeamCityProjectsfromOneServertoAnother">Move TeamCity Projects from One Server to Another</a></li><li class="list__item"><a href="#HowTo...-MoveTeamCityInstallationtoaNewMachine">Move TeamCity Installation to a New Machine</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-Switchingfromoneservertoanother">Switching from one server to another</a></li></ul></li><li class="list__item"><a href="#HowTo...-MoveTeamCityAgenttoaNewMachine">Move TeamCity Agent to a New Machine</a></li><li class="list__item"><a href="#HowTo...-SharetheBuildnumberforBuildsinaChainBuild">Share the Build number for Builds in a Chain Build</a></li><li class="list__item"><a href="#HowTo...-MakeTemporaryBuildFilesErasedbetweentheBuilds">Make Temporary Build Files Erased between the Builds</a></li><li class="list__item"><a href="#HowTo...-ClearBuildQueueifItHasTooManyBuildsduetoaConfigurationError">Clear Build Queue if It Has Too Many Builds due to a Configuration Error</a></li><li class="list__item"><a href="#HowTo...-AutomaticallycreateorchangeTeamCitybuildconfigurationsettings">Automatically create or change TeamCity build configuration settings</a></li><li class="list__item"><a href="#HowTo...-AttachCucumberReportertoAntBuild">Attach Cucumber Reporter to Ant Build</a></li><li class="list__item"><a href="#HowTo...-GetLastSuccessfulBuildNumber">Get Last Successful Build Number</a></li><li class="list__item"><a href="#HowTo...-SetupDeploymentforMyApplicationinTeamCity">Set up Deployment for My Application in TeamCity</a></li><li class="list__item"><a href="#HowTo...-UseanExternalToolthatMyBuildRelieson">Use an External Tool that My Build Relies on</a></li><li class="list__item"><a href="#HowTo...-IntegratewithBuildandReportingTools">Integrate with Build and Reporting Tools</a></li><li class="list__item"><a href="#HowTo...-RestoreJustDeletedProject">Restore Just Deleted Project</a></li><li class="list__item"><a href="#HowTo...-Transfer3DefaultAgentstoAnotherServer">Transfer 3 Default Agents to Another Server</a></li><li class="list__item"><a href="#HowTo...-ImportcoverageresultsinTeamCity">Import coverage results in TeamCity</a></li><li class="list__item"><a href="#HowTo...-Recoverfrom&#34;DataformatoftheDataDirectory(NNN)andthedatabase(MMM)donotmatch&#34;error">Recover from "Data format of the Data Directory (NNN) and the database (MMM) do not match" error</a></li><li class="list__item"><a href="#HowTo...-DebugaBuildonaSpecificAgent">Debug a Build on a Specific Agent</a></li><li class="list__item"><a href="#HowTo...-DebugaPartoftheBuild(abuildstep)">Debug a Part of the Build (a build step)</a></li><li class="list__item"><a href="#HowTo...-Vulnerabilities">Vulnerabilities</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-Heartbleed,ShellShock">Heartbleed, ShellShock</a></li><li class="list__item"><a href="#HowTo...-POODLE">POODLE</a></li><li class="list__item"><a href="#HowTo...-GHOST">GHOST</a></li><li class="list__item"><a href="#HowTo...-FREAK">FREAK</a></li><li class="list__item"><a href="#HowTo...-ApacheStruts">Apache Struts</a></li></ul></li><li class="list__item"><a href="#HowTo...-WatchSeveralTeamCityServerswithWindowsTrayNotifier">Watch Several TeamCity Servers with Windows Tray Notifier</a></li><li class="list__item"><a href="#HowTo...-PersonalUserDataProcessing">Personal User Data Processing</a><ul class="list _bullet"><li class="list__item"><a href="#HowTo...-TeamCityandUsersPersonalData">TeamCity and Users' Personal Data</a></li><li class="list__item"><a href="#HowTo...-DeletingtheUserData">Deleting the User Data</a></li><li class="list__item"><a href="#HowTo...-UserAgreement">User Agreement</a></li><li class="list__item"><a href="#HowTo...-Encryption">Encryption</a></li><li class="list__item"><a href="#HowTo...-LogsandDebuggingData">Logs and Debugging Data</a></li><li class="list__item"><a href="#HowTo...-Customizations">Customizations</a></li></ul></li><li class="list__item"><a href="#HowTo...-TeamCityReleaseCycle">TeamCity Release Cycle</a></li></ul></p><a name="ChooseOS/PlatformforTeamCityServer"></a><a name="Choose-OS/Platform-for-TeamCity-Server"></a><div class="chapter"><h2 id="HowTo...-ChooseOS/PlatformforTeamCityServer">Choose OS/Platform for TeamCity Server</h2><p id="f48ed1ed">Once the server/OS fulfills the <a href="supported-platforms-and-environments.html#TeamCity-Server">requirements</a>, TeamCity can run on any system. Please also review the <a href="supported-platforms-and-environments.html">requirements</a> for the integrations you plan to use, for example the following functionality requires or works better when TeamCity server is installed under Windows:</p><ul class="list _ul"><li class="list__item" id="ec505df0"><p>VCS integration with TFS</p></li><li class="list__item" id="61c911d3"><p>VCS integration with VSS</p></li><li class="list__item" id="e2f06a60"><p>Windows domain logins (can also work under Linux, but may be less stable), especially NTLM HTTP authentication</p></li><li class="list__item" id="d4b4db07"><p>NuGet feed on the server (can also work under Linux, but may be less stable)</p></li><li class="list__item" id="37753373"><p>Agent push to Windows machines</p></li></ul><p id="f2eb216b">If you have no preference, Linux platforms may be more preferable due to more effective file system operations and the level of required general OS maintenance.</p><p id="f65086dc">Final Operating System choice should probably depend more on the available resources and established practices in your organization.</p><p id="9b8c3bb7">If you choose to install 64 bit OS, TeamCity can run under 64 bit JDK (both server and agent). However, unless you need to provide more than 1Gb memory for TeamCity, the recommended approach is to use 32 bit JVM even under 64 bit OS. Our experience suggests that using 64 bit JVM does not increase performance a great deal. At the same time it does increase memory requirements to almost the scale of 2. See a <a href="installing-and-configuring-the-teamcity-server.html#Setting-Up-Memory-settings-for-TeamCity-Server">note</a> on memory configuration.</p></div><a name="EstimateHardwareRequirementsforTeamCity"></a><a name="Estimate-Hardware-Requirements-for-TeamCity"></a><div class="chapter"><h2 id="HowTo...-EstimateHardwareRequirementsforTeamCity">Estimate Hardware Requirements for TeamCity</h2><p id="ce67fe76">The hardware requirements differ for the server and the agents.</p><p id="76615d0d">The <b id="c4562892">agent</b> hardware requirements are basically determined by the builds that are run. Running TeamCity agent software introduces a requirement for additional CPU time (but it can usually be neglected comparing to the build process CPU requirements) and additional memory: about 500Mb. The disk space required corresponds to the disk usage by the builds running on the agent (sources checkouts, downloaded artifacts, the disk space consumed during the build; all that combined for the regularly occurring builds). Although you can run a build agent on the same machine as the TeamCity server, the recommended approach is to use a separate machine (it may be virtual) for each build agent. If you chose to install several agents on the <a href="setting-up-and-running-additional-build-agents.html#Installing-Several-Build-Agents-on-the-Same-Machine">same machine</a>, consider the possible CPU, disk, memory or network bottlenecks that might occur. The <a href="performance-monitor.html">Performance Monitor</a> build feature can help you in analyzing live data.</p><p id="f3a7f0ea">The <b id="4a7c2d51">server</b> hardware requirements depend on the server load, which in its turn depends significantly on the type of the builds and server usage. Consider the following general guidelines.</p><aside class="tip sideblock" data-title="" rel="f3a7f0ea" id="67cfe486"><ul class="list _ul"><li class="list__item" id="c1168ad6"><p>If you decide to run an <a href="setting-up-an-external-database.html">external database</a> on the same machine as the server, take into account hardware requirements with database engine requirements in mind.</p></li><li class="list__item" id="ff0fc033"><p>If you face some TeamCity-related performance issues, they should probably be investigated and addressed individually. For example, if builds generate too much data, the server disk system might be needing an upgrade both in size and speed characteristics.</p></li></ul></aside><p id="88e24812"><b id="865bcf9e">Database Note:</b><br>When using the server extensively, the database performance starts to play a greater role.<br>For reliability and performance reasons you should use external database.<br>See the <a href="setting-up-an-external-database.html">notes</a> on choosing external database.<br>The database size requirements naturally vary based on the amount of data stored (number of builds, number of tests, and so on). The active server database usage can be estimated at several gigabytes of data per year.</p><p id="6158870c"><b id="c53ffa30">Overview of the TeamCity hardware resources usage:</b></p><ul class="list _ul"><li class="list__item" id="507bb42a"><p>CPU: TeamCity utilizes multiple cores of the CPU, so increasing number of cores makes sense. For non-trivial TeamCity usage at least 4 CPU cores are recommended.</p></li><li class="list__item" id="2b5dc5cf"><p>Memory: used by the TeamCity server main process and child processes (used for Maven integration, version control integration, Kotlin DSL execution). See the <a href="installing-and-configuring-the-teamcity-server.html#Setting-Up-Memory-settings-for-TeamCity-Server">notes</a> on the main process memory usage. Generally, you will probably not need to dedicate more than 4G of memory to TeamCity server if you do not plan to run more then 100 concurrent builds (agents), support more then 200 online users or work with large repositories.</p></li><li class="list__item" id="d8ab09ad"><p>HDD/disk usage: This sums up mainly from the temp directory usage (<code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a><code class="code">&gt;/temp</code> and OS default temp directory) and <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;/system</code> usage. Performance of the TeamCity server highly depends on the disk system performance. As TeamCity stores large amounts of data under <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;/system</code> (most notably, VCS caches and build results) it is important that the access to the disk is fast (in particular reading/writing files in multiple threads, listing files with attributes). Ensuring disk has good performance is especially important if you plan to store the Data Directory on a network drive. It is recommended to use local storage for <code class="code">TeamCity Data Directory/system/caches</code> directory. See also <a href="teamcity-data-directory.html#Recommendations-as-to-choosing-Data-Directory-Location">TeamCity Data Directory</a>.</p></li><li class="list__item" id="c86fe4eb"><p>Network: This mainly sums up from the traffic from VCS servers, to clients (web browsers, IDE, etc.) and to/from build agents (send sources, receive build results, logs and artifacts).</p></li></ul><p id="0ab3b8ac"><b id="569a0ee7">The load on the server depends on:</b></p><ul class="list _ul"><li class="list__item" id="29774347"><p>number of build configurations;</p></li><li class="list__item" id="000f744e"><p>number of builds in the history;</p></li><li class="list__item" id="aa5ed6d2"><p>number of the builds running daily;</p></li><li class="list__item" id="59a0e09f"><p>amount of data consumed and produced by the builds (size of the used sources and artifacts, size of the build log, number and output size of unit tests, number of inspections and duplicates hits, size and number of produced artifacts, and so on);</p></li><li class="list__item" id="35a84f82"><p>cleanup rules configured</p></li><li class="list__item" id="3c88b688"><p>number of agents and their utilization percentage;</p></li><li class="list__item" id="6536d67f"><p>number of users having TeamCity web pages open;</p></li><li class="list__item" id="6d6fbf15"><p>number of users logged in from IDE plugin;</p></li><li class="list__item" id="2af0dafb"><p>number and type of VCS roots as well as the configured checking for changes interval for the VCS roots. VCS checkout mode is relevant too: server checkout mode generates greater server load. Specific types of VCS also affect server load, but they can be roughly estimated based on native VCS client performance;</p></li><li class="list__item" id="c41f02d8"><p>number of changes detected by TeamCity per day in all the VCS roots;</p></li><li class="list__item" id="5652f8e7"><p>the size of the repositories TeamCity works with;</p></li><li class="list__item" id="383b9e96"><p>total size of the sources checked out by TeamCity daily.</p></li></ul><p id="d65aace3">A general example of hardware configuration capable to handle up to 100 concurrently running builds and running only TeamCity server can be:<br>Server-suitable modern multi-core CPU, 8Gb of memory, fast network connection, fast and reliable HDD, fast external database access.</p><p id="3af2bbab">Based on our experience, a modest hardware likeIntel 3.2 GHz dual core CPU, 3.2Gb memory under Windows, 1Gb network adapter, single HDDcan provide acceptable performance for the following setup:</p><ul class="list _ul"><li class="list__item" id="5f056a1e"><p>60 projects and 300 build configurations (with one forth being active and running regularly);</p></li><li class="list__item" id="718d4d08"><p>more than 300 builds a day;</p></li><li class="list__item" id="4aebe164"><p>about 2Mb log per build;</p></li><li class="list__item" id="95650c26"><p>50 build agents;</p></li><li class="list__item" id="30cb92d3"><p>50 web users and 30 IDE users;</p></li><li class="list__item" id="044e301f"><p>100 VCS roots (mainly Perforce and Subversion using server checkout), average checking for changes interval is 120 seconds;</p></li><li class="list__item" id="e3e194cd"><p>more than 150 changes per day;</p></li><li class="list__item" id="ace35d59"><p>Kotlin DSL is not used;</p></li><li class="list__item" id="a8e6f3d1"><p>the database (MySQL) is running on the same machine;</p></li><li class="list__item" id="33f1addc"><p>TeamCity server process has <code class="code">-Xmx1100m</code> JVM setting.</p></li></ul><p id="24991ce2">The following configuration can provide acceptable performance for a more loaded TeamCity server:<br>Intel Xeon E5520 2.2 GHz CPU (4 cores, 8 threads), 12Gb memory under Windows Server 2008 R2 x64, 1Gb network adapter, 3 HDD RAID1 disks (general, one for artifacts, logs and caches storage, and one for the database storage)</p><p id="3df371f9"><b id="c8e4f33d">Server load characteristics:</b></p><ul class="list _ul"><li class="list__item" id="fee2290e"><p>150 projects and 1500 build configurations (with one third being active and running regularly);</p></li><li class="list__item" id="0c228ec7"><p>more than 1500 builds a day;</p></li><li class="list__item" id="991717f3"><p>about 4Mb log per build;</p></li><li class="list__item" id="3e52ed1c"><p>100 build agents;</p></li><li class="list__item" id="191abf2c"><p>150 web users and 40 IDE users;</p></li><li class="list__item" id="2c83698e"><p>250 VCS roots (mainly Git, Hg, Perforce and Subversion using agent-side checkout), average checking for changes interval is 180 seconds;</p></li><li class="list__item" id="c3ac6208"><p>more than 1000 changes per day;</p></li><li class="list__item" id="2b60305b"><p>the database (MySQL) is running on the same machine;</p></li><li class="list__item" id="7216df81"><p>TeamCity server process has <code class="code">-Xmx3700m</code> x64 JVM setting.</p></li></ul><p id="de5e36d8">However, to ensure peak load can be handled well, more powerful hardware is recommended.</p><p id="b0dede76">HDD free space requirements are mainly determined by the number of builds stored on the server and the artifacts size/build log size in each. Server disk storage is also used to store VCS-related caches and you can estimate that at double the checkout size of all the VCS roots configured on the server.</p><p id="6e259972">If the builds generate large number of data (artifacts/build log/test data), using fast hard disk for storing <code class="code">.BuildServer/system</code> directory and fast network between agents and server are recommended.</p><p id="04e364b0">The general recommendation for deploying large-scale TeamCity installation is to start with a reasonable hardware while considering hardware upgrade. Then increase the load on the server (e.g. add more projects) gradually, monitoring the performance characteristics and deciding on necessary hardware or software improvements. There is also a <a href="https://confluence.jetbrains.com/display/TW/TeamCity+Benchmark" data-external="true" target="_blank" rel="noopener noreferrer">benchmark plugin</a> which can be used to estimate the number of simultaneous build the current server installation can handle. Anyway, best administration practices are recommended like keeping adequate disk defragmentation level, and so on.</p><p id="671fba1f">Starting with an adequately loaded system, if you then increase the number of concurrently running builds (agents) by some factor, be prepared to increase CPU, database and HDD access speeds, amount of memory by the same factor to achieve the same performance.<br>If you increase the number of builds per day, be prepared to increase the disk size.</p><p id="347c1c69">If you consider cloud deployment for TeamCity agents (for example, on Amazon EC2),  also review <a href="setting-up-teamcity-for-amazon-ec2.html#Estimating-EC2-Costs">Setting Up TeamCity for Amazon EC2</a></p><p id="24e876c4">A note on the agents setup in JetBrains internal TeamCity installation:<br>We use both separate machines each running a single agent and dedicated "servers" running several virtual machines each of them having a single agent installed. Experimenting with the hardware and software we settled on a configuration when each core7i physical machine runs 3 virtual agents, each using a separate hard disk. This stems form the fact that our (mostly Java) builds depend on HDD performance in the first place. But YMMV.</p><p id="3e9e71bb">TeamCity is known to work well with 500+ build agents (500 concurrently running builds actively logging build run-time data). In synthetic tests the server was functioning OK with as many as 1000 concurrent builds (the server with 8 cores, 32Gb of total memory running under Linux, and MySQL server running on a separate comparable machine). The load on the server produced by each build depends on the amount of data the build produces (build log, tests number and failure details, inspections/duplicates issues number, etc.). Keeping the amount of data reasonably constrained (publishing large outputs as build artifacts, not printing those into standard output; tweaking inspection profiles to report limited set of the most important inspection hits, etc.) will help scale the server to handle more concurrent builds.<br>If you need much more agents/parallel builds, it is recommended to use <a href="multinode-setup.html">several nodes setup</a>. If a substantially large amount of agents is required, it is recommended to consider using several separate TeamCity instances and distributing the projects between them. We constantly work on TeamCity performance improvements and are willing to work closely with organizations running large TeamCity installations to study any performance issues and improve TeamCity to handle larger loads. See also a related post on the <a href="http://blog.jetbrains.com/teamcity/2015/08/benchmarking-teamcity/" data-external="true" target="_blank" rel="noopener noreferrer">maximum number of agents which TeamCity can handle</a></p><p id="78d2ce0b">See also a related post: <a href="http://blogs.jetbrains.com/teamcity/2011/09/05/improving-performance-and-scalability-of-your-teamcity-server/" data-external="true" target="_blank" rel="noopener noreferrer">description of a substantial TeamCity setup</a>.</p><a name="NetworkTrafficbetweentheServerandtheAgents"></a><a name="Network-Traffic-between-the-Server-and-the-Agents"></a><div class="chapter"><h3 id="HowTo...-NetworkTrafficbetweentheServerandtheAgents">Network Traffic between the Server and the Agents</h3><p id="e15b26e6">The traffic mostly depends on the settings as some of them include transferring binaries between the agent and the server.<br>The most important flows of traffic between the agent and the server are:</p><ul class="list _ul"><li class="list__item" id="e52d13bd"><p>agent retrieves commands from the server: these are typically build start tasks which basically include a dump of the build configuration settings and the full set of build parameters. The latter can be large (e.g. megabytes) in case of a large build chain. The parameters can be reviewed on the build's <a href="working-with-build-results.html#Parameters">Parameters tab</a>;</p></li><li class="list__item" id="5b3a40bd"><p>agent periodically sends current status data to the server (this includes all the agents parameters which can be reviewed on the agent's <a href="viewing-build-agent-details.html#Agent-Parameters">Agent Parameters</a> tab);</p></li><li class="list__item" id="5184fa31"><p>during the build, the agent sends  build log messages and parameters data back to the server. These can be reviewed on the <a href="working-with-build-results.html#Build-Log">Build Log</a> and <a href="working-with-build-results.html#Parameters">Parameters</a> tabs of the build;</p></li><li class="list__item" id="a7714bd1"><p>(when the server-side checkout mode is used) the agent downloads the sources before the build (as a full or incremental patch) from the server;</p></li><li class="list__item" id="19d4266a"><p>(when an <a href="artifact-dependencies.html">artifact dependency</a> is configured) the agent downloads build artifacts of other builds from the server before starting a build;</p></li><li class="list__item" id="7a682590"><p>(when artifacts are configured for a build) the agent uploads build artifacts to the server;</p></li><li class="list__item" id="dc43b672"><p>some runners (like coverage or code analysis) include automatic uploading of their results' reports to the server.</p></li></ul></div></div><a name="ConfiguringTeamCityServerforPerformance"></a><a name="Configuring-TeamCity-Server-for-Performance"></a><div class="chapter"><h2 id="HowTo...-ConfiguringTeamCityServerforPerformance">Configuring TeamCity Server for Performance</h2><p id="a8c1a067">Here are some recommendations to tweak TeamCity server setup for better performance. The list for <a href="installing-and-configuring-the-teamcity-server.html#Configuring-Server-for-Production-Use">production server use</a> is a prerequisite:</p><ul class="list _ul"><li class="list__item" id="2cac8afa"><p>Regularly review reported Server Health reports (including hidden ones)</p></li><li class="list__item" id="c36f1ef9"><p>Use a separate <a href="#Set-Up-TeamCity-behind-a-Proxy-Server">reverse proxy</a> server (e.g. NGINX) to handle HTTPS</p></li><li class="list__item" id="e3249d82"><p>Use a separate server for the external database and monitor the database performance</p></li><li class="list__item" id="3053b9d3"><p>Monitor the server's CPU and IO performance, increase hardware resources as necessary (see also <a href="#Estimate-Hardware-Requirements-for-TeamCity">hardware notes</a>)</p></li><li class="list__item" id="eda7a114"><p>Make sure clean-up is configured for all the projects with a due retention policy, make sure clean-up completely finishes regularly (check Administration / Clean-Up page)</p></li><li class="list__item" id="64f8783e"><p>Consider ensuring good IO performance for the <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;/system/caches</code> directory, e.g. by moving it to a separate local drive (or storing on a local drive you choose to store the TeamCity Data Directory on a network storage)</p></li><li class="list__item" id="a8982566"><p>Regularly archive obsolete projects</p></li><li class="list__item" id="02eb8034"><p>Regularly review the installed not bundled plugins and remove those not essential for the server functioning</p></li><li class="list__item" id="aa1c983e"><p>Consider using agent-side checkout whenever possible</p></li><li class="list__item" id="678a3548"><p>Make sure the build logs are not huge (tens megabytes at most, better less than 10 Mb)</p></li><li class="list__item" id="43b8e73d"><p>If lots VCS roots are configured on the server, consider configuring <a href="configuring-vcs-post-commit-hooks-for-teamcity.html">repository commit hooks</a> instead of using polling for changes or at least increase <a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS polling interval</a> to 300 seconds or more</p></li><li class="list__item" id="fe742c30"><p>If the server is often used by large number of users (e.g. more than 1000), consider reducing the frequency of background UI requests their by increasing <a href="teamcity-tweaks.html#Web-Page-Refresh-Interval">UI refresh intervals</a></p></li><li class="list__item" id="82b9ba1e"><p>When regularly exceeding 500 concurrently running builds which log a lot of data, consider using <a href="multinode-setup.html">Several Nodes Setup</a></p></li></ul></div><a name="RetrieveAdministratorPassword"></a><a name="Retrieve-Administrator-Password"></a><div class="chapter"><h2 id="HowTo...-RetrieveAdministratorPassword">Retrieve Administrator Password</h2><p id="d9e9ad6f">On the first start with the empty database, TeamCity displays the Administrator Setup page which allows creating a user with full administrative permissions (assigning the <a href="role-and-permission.html#Per-Project-Authorization-Mode">System Administrator</a> role).</p><p id="b61c73a2">If you want to regain access to the system and you cannot log in as a user with the System Administrator role, you can log in as a <a href="super-user.html">super user</a> and change the existing administrator account password or create a new account with the System Administrator role.</p><p id="a7e94697">It is also possible to use <a href="rest-api.html#Making-user-a-system-administrator">REST API</a> to add the System Administrator role to any existing user.</p><p id="3b48c804">If you use built-in authentication and have correct email specified, you can <a href="managing-your-user-account.html#Changing-Your-Password">reset the password</a> from the login page.</p></div><a name="EstimateExternalDatabaseCapacity"></a><a name="Estimate-External-Database-Capacity"></a><div class="chapter"><h2 id="HowTo...-EstimateExternalDatabaseCapacity">Estimate External Database Capacity</h2><p id="623556c9">It is quite hard to provide the exact numbers when setting up or migrating to an external database, as the required capacity varies greatly depending on how TeamCity is used.</p><p id="9e6376dc">The database size and database performance are crucial aspects to consider.</p><p id="b90cbb56"><b id="6ea8d20c">Database Size</b></p><p id="adf835d8">The size of the database will depend on:</p><ul class="list _ul"><li class="list__item" id="fc737b4d"><p>how many builds are started every day</p></li><li class="list__item" id="a1482f90"><p>how many test are reported from builds</p></li><li class="list__item" id="179b2855"><p><a href="clean-up.html">clean-up</a> rules (retention policy)</p></li><li class="list__item" id="d4d72845"><p>cleanup schedule</p></li></ul><p id="6fe1179d">We recommend the initial size of data spaces to be 4 GB. When migrating from the internal database, we suggest at least doubling the size of the current internal database. For example, the size of the external database (without the Redo Log files) of the internal TeamCity server in JetBrains is about 50 GB. Setting your database to grow automatically helps to increase file sizes to a pre-determined limit when necessary, which minimizes the effort to monitor disk space.</p><p id="78054dd8">Allocating 1 GB for the redo log (see the table below) and undo files is sufficient in most cases.</p><p id="530a8f57"><b id="ce52273b">Database Performance</b></p><p id="2e4b7226">The following factors are to be taken into account:</p><ul class="list _ul"><li class="list__item" id="027bdead"><p>type of database (RDBMS)</p></li><li class="list__item" id="d28a8db4"><p>number of agents (which actually means the number of builds running in parallel)</p></li><li class="list__item" id="42423594"><p>number of web pages opened by all users</p></li><li class="list__item" id="52ee3985"><p><a href="clean-up.html">clean-up</a> rules (retention policy)</p></li></ul><p id="73e8f25a">It is advised to place the <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> and database data files on physically different hard disks (even when both the TeamCity server and RDBMS share the same host).</p><p id="10e120a8">Placing redo logs on a separate physical disk is also recommended especially in case of the high number of agents (50 and more).</p><p id="343eddda"><b id="09d264db">Database-specific considerations</b></p><p id="822c2381">The <i id="0780919b">redo</i> log (or a similar entity) naming for different RDBMS:</p><div class="table-wrapper"><table width="100%" id="34513444"><thead><tr id="60e94a6d" class="ijRowHead"><th id="a1ed6c25"><p id="bba03a70">RDBMS</p></th><th id="4c0abee1"><p id="e4a30fa8">Log name</p></th></tr></thead><tbody><tr id="504bdcf8" class="ijRowOdd"><td id="dae1fc0f"><p id="89e95258">Oracle</p></td><td id="6ad18508"><p id="9641f55e">Redo Log</p></td></tr><tr id="c9f64e7a" class="ijRowEven"><td id="056a492c"><p id="32b3e39c">MS SQL Server</p></td><td id="c2f18658"><p id="848efe5a">Transaction Log</p></td></tr><tr id="7f43f956" class="ijRowOdd"><td id="4174c081"><p id="e5053822">PostgreSQL</p></td><td id="9fd9e6fe"><p id="c120141c">WAL (write ahead log)</p></td></tr><tr id="c37675ca" class="ijRowEven"><td id="97a0d3a1"><p id="367e9456">MySQL + InnoDB and Percona</p></td><td id="e4189560"><p id="da38202c">Redo Log</p></td></tr></tbody></table></div><p id="2f01619d">PostgreSQL: We recommend using version 9.2+, which has a lot of query optimization features. Also see the information on the write-ahead-log (WAL) in the <a href="http://www.postgresql.org/docs/9.2/static/wal-internals.html" data-external="true" target="_blank" rel="noopener noreferrer">PostgreSQL documentation</a></p><p id="4ee08bcc">Oracle: it is recommended to keep statistics on: all automatically gathered statistics should be enabled (since Oracle 10.0, this is the default set-up). Also see the information on redo log files in the <a href="https://docs.oracle.com/cd/B14117_01/server.101/b10752/iodesign.htm#26022" data-external="true" target="_blank" rel="noopener noreferrer">Oracle documentation</a>.</p><p id="806df37e">MS SQL Server: it is NOT recommended to use the jTDS driver: it does not work with <code class="code">nchar/nvarchar</code>, and to preserve unicode streams it may cause queries to take a long time and consume a lot of IO. Also see the information on redo log in the <a href="https://support.microsoft.com/kb/2033523" data-external="true" target="_blank" rel="noopener noreferrer">Microsoft Knowledge base</a>. If you use jTDS, please <a href="setting-up-an-external-database.html#jTDS-driver">migrate</a>.</p><p id="bd41d981">MySQL: the query optimizer might be inefficient: some queries may get a wrong execution plan causing them to take a long time and consume huge IO.</p></div><a name="EstimatetheNumberofRequiredBuildAgents"></a><a name="Estimate-the-Number-of-Required-Build-Agents"></a><div class="chapter"><h2 id="HowTo...-EstimatetheNumberofRequiredBuildAgents">Estimate the Number of Required Build Agents</h2><p id="4d03b261">There are no precise data and the number of required build agents depends a lot on the server usage pattern, type of builds, team size, commitment of the team to CI process, etc.<br>The best way is to start with the default 3 agents and see how that plays with the projects configured, then estimate further based on that.</p><p id="311d3862">You might want to increase the number of agents when you see:</p><ul class="list _ul"><li class="list__item" id="70fa191e"><p>builds waiting for an idle agent in the build queue;</p></li><li class="list__item" id="d80c2ce6"><p>more changes included into each build than you find comfortable (e.g. for build failures analysis);</p></li><li class="list__item" id="44088140"><p>necessity for different environments.We've seen patterns of having an agent per each 20 build configurations (types of builds). Or a build agent per 1-2 developers.</p></li></ul><p id="0b6b3669">See also <a href="#Estimate-Hardware-Requirements-for-TeamCity">notes</a> on maximum supported number of agents.</p></div><a name="SetupTeamCityinReplication/ClusteringEnvironment"></a><a name="Setup-TeamCity-in-Replication/Clustering-Environment"></a><div class="chapter"><h2 id="HowTo...-SetupTeamCityinReplication/ClusteringEnvironment">Setup TeamCity in Replication/Clustering Environment</h2><p id="937ac023">TeamCity only supports a single instance of the main server, but it is possible to add a <a href="configuring-secondary-node.html">secondary node</a> to provide view-only UI over the current data and to collect the running builds data form the agents. All nodes need to be connected to the same <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> and the database.</p><p id="4cbb64d2">To address fast disaster recovery scenarios, TeamCity supports active - failover (cold standby) approach: the data that the TeamCity server uses can be replicated and a solution put in place to start a new server using the same data if the currently active server malfunctions.</p><p id="26ebbf50">As to the data, the TeamCity server uses both database and file storage (Data Directory). You can browse through <a href="teamcity-data-backup.html">TeamCity Data Backup</a> and <a href="teamcity-data-directory.html">TeamCity Data Directory</a> pages in to get more information on TeamCity data storing. Basically, both the TeamCity Data Directory on the disk and the database which TeamCity uses must remain in a consistent state and thus must be replicated together.<br>Only a single TeamCity server instance should use the database and Data Directory at any time.</p><p id="1706151e">Ensure that the distribution of the TeamCity failover/backup server is of exactly the same version as the main server. It is also important to ensure the same server environment/startup options like memory settings, etc.</p><p id="dc81c469">TeamCity agents farm can be reused between the main and the failover servers. Agents will automatically connect to the new server if you make the failover server to be resolved via the old server DNS name and agents connect to the server using the DNS name. See also information on <a href="#Switching-from-one-server-to-another">switching</a> from one server to another.<br>If appropriate, the agents can be replicated just as the server. However, there is no need to replicate any TeamCity-specific data on the agents except for the conf\buildAgent.properties file as all the rest of the data can typically be renewed from the server. In case of replicated agents farm, the replica agents just need to be connected to the failover server.</p><p id="8b732b66">In case of two servers installations for redundancy purposes, they can use the same set of licenses as only one of them is running at any given moment.</p></div><a name="TeamCitySecurityNotes"></a><a name="TeamCity-Security-Notes"></a><div class="chapter"><h2 id="HowTo...-TeamCitySecurityNotes">TeamCity Security Notes</h2><p id="c3ab8abf">The following notes are provided for your reference only and are not meant to be complete or accurate in their entirety.</p><p id="77c20035">TeamCity is developed with security concerns in mind, and reasonable efforts are made to make the system invulnerable to different types of attacks. We work with third-parties on assessing TeamCity security using security scanners and penetration tests.<br>We aim to promptly address newly discovered security issues in the nearest bug-fix releases for the most recent TeamCity major version.<br>However, the general assumption and recommended setup is to deploy TeamCity in a trusted environment with no possibility for it to be accessed by malicious users.</p><p id="7b097999">Along with these guidelines, please review <a href="installing-and-configuring-the-teamcity-server.html#Configuring-Server-for-Production-Use">notes</a> on configuring the TeamCity server for production use. For the list of disclosed security-related issues, see our <a href="https://youtrack.jetbrains.com/issues/TW?q=project:TeamCity%20type:%20%7BSecurity%20Problem%7D%20sort%20by:%20%7BFix%20versions%7D%20desc" data-external="true" target="_blank" rel="noopener noreferrer">public issue tracker</a> and the "Security" section in the release notes. It is recommended to upgrade to newly released TeamCity versions as soon as they become available as they can contain security-related fixes.</p><p id="6ff472ed">Note that <b id="9f4afc94">since TeamCity 2017.2</b> the TeamCity Windows installer modifies permisisons of the <a href="teamcity-home-directory.html">TeamCity installation directory</a> not to use inheritable permissions and explicitly grants access to the directory to the Administrators user group and the accrount under which the service is configured to run.<br>It is strongly recommended to restrict permissions to the <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> in the same way.</p><a name="Additionalsecurity-relatedsettings"></a><a name="Additional-security-related-settings"></a><div class="chapter"><h3 id="HowTo...-Additionalsecurity-relatedsettings">Additional security-related settings</h3><p id="287fc6b4">Consider adding the <code class="code">teamcity.installation.completed=true</code> line into the <code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home Directory</code></a><code class="code">&gt;\conf\teamcity-startup.properties</code> file - this will prevent the server started with the empty database from granting access to the machine for the first coming user.</p><p id="388ff8fa">TeamCity has no built-in protection against DoS (Denial-of-service) attack: high rate of requests can overload the server and make it not responsive. If your TeamCity instance is deployed in the environment which allows such service abuse, implement the protection on the reverse proxy level.</p><p id="6f97887b"><b id="5c9ef099">Short checklist</b> (see below for full notes)</p><ul class="list _ul"><li class="list__item" id="b2bd2b3a"><p>You are running the latest released TeamCity version and are ready to upgrade to the newly released versions within weeks</p></li><li class="list__item" id="ccd9ebd1"><p>Access to the TeamCity web interface is secured using HTTPS (e.g. with the help a <a href="#Configure-HTTPS-for-TeamCity-Web-UI">proxying server</a> like NGINX). Best practices for securing web applications are employed for the TeamCity web interface. e.g.: It is not possible to access the server using HTTP protocol. Reverse proxy does not strip Referer request header</p></li><li class="list__item" id="17747bae"><p>The TeamCity server machine does not run agents (at least under the user permitted to read the  <code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity server's home directory</code></a> and <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code>)</p></li><li class="list__item" id="f8640f5a"><p>TeamCity server and agents processes are run under limited users with minimal required permissions. Installation directories are readable and writable only by a limited set of OS users. The <code class="code">conf\buildAgent.properties</code> file and server logs as well as the Data Directory are only readable by OS users who represent administrators of the services, because reading those locations may allow taking over the agent or server respectively.</p></li><li class="list__item" id="31188e78"><p>Guest user and user registration is disabled or roles are reviewed for guest and the <a href="user-group.html#&#34;All-Users&#34;-Group">All Users</a> group</p></li><li class="list__item" id="4f9bfc47"><p>TeamCity users with administrative permissions have non-trivial passwords</p></li><li class="list__item" id="6408b064"><p>If you have external authentication configured (such as LDAP), the <a href="configuring-authentication-settings.html#Built-in-Authentication">built-in authentication</a> module is disabled</p></li><li class="list__item" id="1f25c78a"><p>Passwords are not printed into the build log, not stored in build artifacts, nor are they stored in non-<a href="typed-parameters.html#Adding-Parameter-Specification">password parameters</a></p></li></ul></div><a name="Security-relatedRisksEvaluation"></a><a name="Security-related-Risks-Evaluation"></a><div class="chapter"><h3 id="HowTo...-Security-relatedRisksEvaluation">Security-related Risks Evaluation</h3><p id="1da79e79">Here are some notes on different security-related aspects:</p><ul class="list _ul"><li class="list__item" id="5baec498">man-in-the middle concerns<ul class="list _ul"><li class="list__item" id="dac555ed"><p>between the TeamCity server and the user's web browser: It is advised to <a href="using-https-to-access-teamcity-server.html">use HTTPS</a> for the TeamCity server. During login, TeamCity transmits the user login password in an encrypted form with a moderate encryption level.</p></li><li class="list__item" id="f1bfa6a8"><p>between a TeamCity agent and the TeamCity server: see <a href="setting-up-and-running-additional-build-agents.html#Agent-Server-Data-Transfers">this section</a>.</p></li><li class="list__item" id="782876e8"><p>between the TeamCity server and other external servers (version control, issue tracker, etc.): the general rules apply as for a client (the TeamCity server in the case) connecting to the external server, see the guidelines for the server in question.</p></li></ul></li><li class="list__item" id="3f8ea990"><p>users that have access to the TeamCity web UI: the specific information accessible to the user is defined via TeamCity <a href="role-and-permission.html">user roles</a>.</p></li><li class="list__item" id="711cdf81">users who can change the code that is used in the builds run by TeamCity (including committers in any branches/pull requests if they are built on TeamCity):<ul class="list _ul"><li class="list__item" id="fb02cf1d"><p>can do everything the system user, under whom the TeamCity agent is running, can do; have access to OS resources and other applications installed on the agent machines where their builds can run.</p></li><li class="list__item" id="76177b16"><p>can access and change source code of other projects built on the same agent, modify the TeamCity agent code, publish any files as artifacts for the builds run on the agent (which means the files can be then displayed in the TeamCity web UI and expose web vulnerabilities or can be used in other builds), etc.</p></li><li class="list__item" id="18a20957"><p>can impersonate a TeamCity agent (run a new agent looking the same to the TeamCity server).</p></li><li class="list__item" id="339a9551"><p>can do everything that users with the "View build configuration settings" permission for all the projects on the server can do (see below).</p></li><li class="list__item" id="95c2d470"><p>can retrieve settings of the build configurations where the builds are run, including the values of the password fields.</p></li><li class="list__item" id="fd122a63"><p>can download artifacts from any build on the server.<br>Hence, it is advised to run TeamCity agents under an OS account with only <a href="setting-up-and-running-additional-build-agents.html#Necessary-OS-and-environment-permissions">necessary set of permissions</a> and use the <a href="agent-pools.html">agent pools</a> feature to ensure that projects requiring a different set of access are not built on the same agents.</p></li></ul></li><li class="list__item" id="77519667"><p>users with the "View build configuration settings" permission (the "Project developer" TeamCity role by default) can view all the projects on the server, but since TeamCity 9.0 there is a way to restrict this, see details in the corresponding issue <a href="https://youtrack.jetbrains.com/issue/TW-24904#comment=27-731107" data-external="true" target="_blank" rel="noopener noreferrer">TW-24904</a>.</p></li><li class="list__item" id="15579d1c"><p>users with the "Edit project" permission (the "Project Administrator" TeamCity role by default) in one project, by changing settings can retrieve artifacts and trigger builds from any build configuration they have only the view permission for (<a href="https://youtrack.jetbrains.com/issue/TW-39209" data-external="true" target="_blank" rel="noopener noreferrer">TW-39209</a>). The users might also be able to make the TeamCity server run any executable located on the server.</p></li><li class="list__item" id="768594b1"><p>users with the "Change server settings" permission (the "System Administrator" TeamCity role by default): It is assumed that the users also have access to the computer on which the TeamCity server is running under the user account used to run the server process. Thus, the users can get full access to the machine under that OS user account: browse file system, change files, run arbitrary commands, etc.</p></li><li class="list__item" id="88a62977"><p>TeamCity server computer administrators: have full access to TeamCity stored data and can affect TeamCity executed processes. Passwords that are necessary to authenticate in external systems (like VCS, issue trackers, etc.) are stored in a scrambled form in <a href="teamcity-data-directory.html">TeamCity Data Directory</a> and can also be stored in the database. However, the values are only scrambled, which means they can be retrieved by any user who has access to the server file system or database.</p></li><li class="list__item" id="bf570863"><p>Users who have read access to the TeamCity server logs (TeamCity server home directory) can escalate their access to TeamCity server administrator.</p></li><li class="list__item" id="07f2b900"><p>Users who have read access to <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code> can access all the settings on the server, including configured passwords.</p></li><li class="list__item" id="77f70410"><p>Users who have read access to the build artifacts in <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;/system/artifacts</code> get the same permissions as users with the "View build runtime parameters and data" permission (in particular, with access to the values of all the password parameters used in the build).</p></li><li class="list__item" id="7f001a36"><p>TeamCity agent computer administrators: same as "users who can change code that is used in the builds run by TeamCity".</p></li><li class="list__item" id="04ec2754"><p>It is recommended to distribute projects among agents, so that one TeamCity agent would not run builds of several projects whose developers and administrators should not get access to each other's projects. The recommended way to distribute projects is to use the <a href="agent-pools.html">agent pools</a> feature and make sure that the "Default" agent pool has no agents as a project can be assigned to the Default pool after a certain reconfiguration (i.e. when there is no other pool the project is assigned to).</p></li><li class="list__item" id="ae59d4c2">When <a href="storing-project-settings-in-version-control.html">storing settings in VCS</a> is enabled:<ul class="list _ul"><li class="list__item" id="562d9440"><p>any user who can access the settings repository (including users with "View file content" permission for the build configurations using the same VCS root) can see the settings and retrieve the actual passwords based on their stored scrambled form</p></li><li class="list__item" id="99334bd3"><p>any user who can modify settings in VCS for a single build configuration built on the server, via changing settings can retrieve artifacts and trigger builds from any build configuration they have only view permission for (<a href="https://youtrack.jetbrains.com/issue/TW-39192" data-external="true" target="_blank" rel="noopener noreferrer">TW-39192</a>).</p></li><li class="list__item" id="1e07fd5c"><p>users who can customize build configuration settings on a per-build basis (e.g. one who can run personal builds when versioned settings are set to "use settings from VCS") via changing settings in a build can retrieve artifacts and trigger builds from any build configuration they have only view permission for (<a href="https://youtrack.jetbrains.com/issue/TW-46065" data-external="true" target="_blank" rel="noopener noreferrer">TW-46065</a>).</p></li></ul></li><li class="list__item" id="4ce9c2f8">Other:<ul class="list _ul"><li class="list__item" id="a7be7b38"><p>TeamCity web application vulnerabilities: the TeamCity development team makes a reasonable effort to fix any significant vulnerabilities (like cross-site scripting possibilities) once they are uncovered. Please note that any user that can affect build files ("users who can change code that is used in the builds run by TeamCity" or "TeamCity agent computer administrators") can make a malicious file available as a build artifact that will then exploit cross-site scripting vulnerability. (<a href="http://youtrack.jetbrains.com/issue/TW-27206" data-external="true" target="_blank" rel="noopener noreferrer">TW-27206</a>)</p></li><li class="list__item" id="f3737cc7"><p>TeamCity agent is fully controlled by the TeamCity server: since TeamCity agents support automatic updates download from the server, agents should only connect to a trusted server. An administrator of the server computer can force execution of arbitrary code on a connected agent.</p></li><li class="list__item" id="2d7a85bb"><p>Binaries of the agent plugins installed on the server are available to anyone who can access the server URL</p></li></ul></li></ul></div></div><a name="WhatEncryptionisUsedbyTeamCity"></a><a name="What-Encryption-is-Used-by-TeamCity"></a><div class="chapter"><h2 id="HowTo...-WhatEncryptionisUsedbyTeamCity">What Encryption is Used by TeamCity</h2><p id="4a329733">TeamCity tries not to pass password values via the web UI (from a browser to the server) in clear text: instead, it uses RSA with 1024-bit key to encrypt them. However, it is recommended to use the TeamCity web UI only via HTTPS so this precaution should not be relevant. TeamCity stores passwords in the settings (where the original password value is necessary to perform authentication in other systems) in a scrambled form. The scrambling is done using 3DES with a fixed key.</p></div><a name="ConfigureNewlyInstalledMySQLServer"></a><a name="Configure-Newly-Installed-MySQL-Server"></a><div class="chapter"><h2 id="HowTo...-ConfigureNewlyInstalledMySQLServer">Configure Newly Installed MySQL Server</h2><p id="fb7ade7d">If MySQL server is going to be used with TeamCity in addition to the <a href="setting-up-an-external-database.html#MySQL">basic setup</a>, you should review and probably change some of the MySQL server settings. If MySQL is installed on Windows, the settings are located in <code class="code">my.ini</code> file which usually can be found under MySQL installation directory. For Unix-like systems the file is called <code class="code">my.cnf</code> and can be placed somewhere under <code class="code">/etc</code> directory. Read more about configuration file location in <a href="http://dev.mysql.com/doc/refman/5.5/en/option-files.html" data-external="true" target="_blank" rel="noopener noreferrer">MySQL documentation</a>. Note: you'll need to restart MySQL server after changing settings in <code class="code">my.ini|my.cnf</code>.</p><p id="930b6134">The following settings should be reviewed and/or changed:</p><a name="InnoDBdatabaseengine"></a><a name="InnoDB-database-engine"></a><div class="chapter"><h3 id="HowTo...-InnoDBdatabaseengine">InnoDB database engine</h3><p id="357fc86d">Make sure you're using InnoDB database engine for tables in TeamCity database. You can check what engine is used with help of this command:</p><div class="code-block" data-lang="bash">
show table status like '&lt;table name&gt;';

</div><p id="0ccf9dc0">or for all tables at once:</p><div class="code-block" data-lang="bash">
show table status like '%';

</div></div><a name="maxconnections"></a><a name="max-connections"></a><div class="chapter"><h3 id="HowTo...-maxconnections">max_connections</h3><p id="8c762681">You should ensure <code class="code">max_connections</code> parameter has bigger value than the one specified in TeamCity <code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home Directory</code></a><code class="code">&gt;/config/database.properties</code> file.</p></div><a name="innodbbufferpoolsizeandinnodblogfilesize"></a><a name="innodb-buffer-pool-size-and-innodb-log-file-size"></a><div class="chapter"><h3 id="HowTo...-innodbbufferpoolsizeandinnodblogfilesize">innodb_buffer_pool_size and innodb_log_file_size</h3><p id="2801d125">Specifying a too small value in <code class="code">innodb_buffer_pool_size</code> may significantly affect performance:</p><div class="code-block" data-lang="bash">
# InnoDB, unlike MyISAM, uses a buffer pool to cache both indexes and
# row data. The bigger you set this the less disk I/O is needed to
# access data in tables. On a dedicated database server you may set this
# parameter up to 80% of the machine physical memory size. Do not set it
# too large, though, because competition of the physical memory may
# cause paging in the operating system. Note that on 32bit systems you
# might be limited to 2-3.5G of user level memory per process, so do not
# set it too high.
innodb_buffer_pool_size=2000M

</div><p id="2acde6e5">We recommend to start with 2Gb and increase it if you experience slowness and have enough memory. After increasing buffer pool size you should also change size of the <a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_log_file_size" data-external="true" target="_blank" rel="noopener noreferrer">innodb_log_file_size</a> setting (its value can be calculated as <code class="code">innodb_log_file_size/N</code>, where N is the number of log files in the group (2 by default)):</p><div class="code-block" data-lang="none">innodb_log_file_size=1024M

</div></div><a name="innodbfilepertable"></a><a name="innodb-file-per-table"></a><div class="chapter"><h3 id="HowTo...-innodbfilepertable">innodb_file_per_table</h3><p id="05d8cfd2">For better performance you can enable the so-called <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-multiple-tablespaces.html" data-external="true" target="_blank" rel="noopener noreferrer">per-table tablespaces</a>. Note that once you add <code class="code">innodb_file_per_table</code> option new tables will be created and placed in separate files, but tables created before enabling this option will still be in the shared tablespace. You'll need to re-import database for them to be placed in separate files.</p></div><a name="innodbflushlogattrxcommit"></a><a name="innodb-flush-log-at-trx-commit"></a><div class="chapter"><h3 id="HowTo...-innodbflushlogattrxcommit">innodb_flush_log_at_trx_commit</h3><p id="9c494236">If TeamCity is the only application using MySQL database then you can improve performance by setting <code class="code">innodb_flush_log_at_trx_commit</code> variable to <code class="code">2</code> or <code class="code">0</code>:</p><div class="code-block" data-lang="bash">
# If set to 1, InnoDB will flush (fsync) the transaction logs to the
# disk at each commit, which offers full ACID behavior. If you are
# willing to compromise this safety, and you are running small
# transactions, you may set this to 0 or 2 to reduce disk I/O to the
# logs. Value 0 means that the log is only written to the log file and
# the log file flushed to disk approximately once per second. Value 2
# means the log is written to the log file at each commit, but the log
# file is only flushed to disk approximately once per second.
innodb_flush_log_at_trx_commit=2

</div><p id="604ff383">Note: it is not important for TeamCity that database offers full ACID behavior, so you can safely change this variable.</p></div><a name="logfilesondifferentdisk"></a><a name="log-files-on-different-disk"></a><div class="chapter"><h3 id="HowTo...-logfilesondifferentdisk">log files on different disk</h3><p id="c1daa21c">Placing the MySQL log files on different disk sometimes helps improving performance. You can read about it in <a href="http://dev.mysql.com/doc/refman/5.5/en/innodb-configuration.html" data-external="true" target="_blank" rel="noopener noreferrer">MySQL documentation</a>.</p></div><a name="SettingTheBinaryLogFormat"></a><a name="Setting-The-Binary-Log-Format"></a><div class="chapter"><h3 id="HowTo...-SettingTheBinaryLogFormat">Setting The Binary Log Format</h3><p id="ded54df6">If the default MySQL binary logging format is not MIXED (it depends on the <a href="http://dev.mysql.com/doc/refman/5.1/en/binary-log-setting.html" data-external="true" target="_blank" rel="noopener noreferrer">version of MySQL</a> you are using), then it should be explicitly set to <b id="31b4a0b4">MIXED</b>:</p><div class="code-block" data-lang="bash">
binlog-format=mixed

</div></div><a name="Enableadditionaldiagnostics"></a><a name="Enable-additional-diagnostics"></a><div class="chapter"><h3 id="HowTo...-Enableadditionaldiagnostics">Enable additional diagnostics</h3><p id="5fe3a08c">To get additional diagnostics data in case of some database-specific errors, grant more permissions for a TeamCity database user via SQL command:</p><div class="code-block" data-lang="sql">
GRANT PROCESS ON *.* TO &lt;teamcity-user-name&gt;;

</div></div></div><a name="ConfigureNewlyInstalledPostgreSQLServer"></a><a name="Configure-Newly-Installed-PostgreSQL-Server"></a><div class="chapter"><h2 id="HowTo...-ConfigureNewlyInstalledPostgreSQLServer">Configure Newly Installed PostgreSQL Server</h2><p id="006147d3">For better TeamCity server performance, it is recommended to change some of the parameters of the newly installed PostgreSQL server. You can read more about PostgreSQL performance optimization in <a href="https://wiki.postgresql.org/wiki/Performance_Optimization" data-external="true" target="_blank" rel="noopener noreferrer">PostgreSQL Wiki</a>.</p><p id="887332b5">The parameters below can be changed in the <code class="code">postgresql.conf</code> file located in the in PostgreSQL's data directory.</p><a name="sharedbuffers"></a><a name="shared-buffers"></a><div class="chapter"><h3 id="HowTo...-sharedbuffers">shared_buffers</h3><p id="3ea52204">The default value of <a href="http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-SHARED-BUFFERS" data-external="true" target="_blank" rel="noopener noreferrer">http://www.postgresql.org/docs/current/static/runtime-config-resource.html#GUC-SHARED-BUFFERS</a> parameter is too small and should be increased:</p><div class="code-block" data-lang="bash">
shared_buffers=512MB

</div><p id="da6f4609"><a name="checkpoint_segments"></a><a name="HowTo...-checkpoint_segments"></a></p></div><a name="checkpoint-relatedparameters"></a><a name="checkpoint-related-parameters"></a><div class="chapter"><h3 id="HowTo...-checkpoint-relatedparameters">checkpoint-related parameters</h3><p id="44c37faa">For write-intensive applications such as TeamCity, it is recommended to change some of the <a href="http://www.postgresql.org/docs/current/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-CHECKPOINTS" data-external="true" target="_blank" rel="noopener noreferrer">checkpoint-related parameters</a>:</p><p id="3b2c422e">For <b id="0a997a01">PostgreSQL 9.5 and later</b>:</p><div class="code-block" data-lang="bash">
max_wal_size = 1500MB
checkpoint_completion_target=0.9

</div><p id="0ac45806">For versions <b id="735eba79">prior to PostgreSQL 9.5</b>:</p><div class="code-block" data-lang="bash">
checkpoint_segments=32
checkpoint_completion_target=0.9

</div></div><a name="synchronouscommit"></a><a name="synchronous-commit"></a><div class="chapter"><h3 id="HowTo...-synchronouscommit">synchronous_commit</h3><p id="c8b2bfba">If TeamCity is the only application using the PostgreSQL database, we recommend disabling the <a href="http://www.postgresql.org/docs/current/static/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT" data-external="true" target="_blank" rel="noopener noreferrer">http://www.postgresql.org/docs/current/static/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT</a> parameter:</p><div class="code-block" data-lang="bash">
synchronous_commit=off

</div></div></div><a name="SetUpTeamCitybehindaProxyServer"></a><a name="Set-Up-TeamCity-behind-a-Proxy-Server"></a><div class="chapter"><h2 id="HowTo...-SetUpTeamCitybehindaProxyServer">Set Up TeamCity behind a Proxy Server</h2><p id="e4fb5679">This section covers the recommended setup of reverse-proxy servers installed in front of the TeamCity server web UI. Configuring HTTPS on the proxy level is recommended, but is out of the scope of these instructions - refer to the documentation of the proxy server for that.</p><p id="a3d49002">Consider the example:<br>TeamCity server is installed at URL (local URL): <a href="http://teamcity.local:8111/tc" data-external="true" target="_blank" rel="noopener noreferrer">http://teamcity.local:8111/tc</a>.<br>It is visible to the outside world as URL (public URL): <a href="http://teamcity.public:400/tc" data-external="true" target="_blank" rel="noopener noreferrer">http://teamcity.public:400/tc</a>.</p><p id="ce0dcfa7">You need to set up a reverse proxy (see <a href="#Proxy-Server-Setup">Proxy Server Setup</a> below) and also configure TeamCity's bundled Tomcat server (see <a href="#TeamCity-Tomcat-Configuration">TeamCity Tomcat Configuration</a> below) to make sure TeamCity "knows" the actual absolute URL used by the client to access the resources. These URLs are then used to generate absolute URLs in client redirects and other responses.</p><p id="201100e2">Note: An internal TeamCity server should work under the <b id="ec9944eb">same context</b> (i.e. part of the URL after the host name) as it is visible from outside by an external address. See also TeamCity server <a href="installing-and-configuring-the-teamcity-server.html#Changing-Server-Context">context changing instructions</a>. If you still need to run the server under a different context, note that context changing proxy should conceal this fact from the TeamCity: e.g. it should map server redirect URLs as well as cookies setting paths to the original (external) context.</p><a name="ProxyServerSetup"></a><a name="Proxy-Server-Setup"></a><div class="chapter"><h3 id="HowTo...-ProxyServerSetup">Proxy Server Setup</h3><p id="e2afb43c">The proxy should be configured with generic web security in mind. e.g. headers like Referer and Origin should usually be passed to the TeamCity web application in the unmodified form. Also, unknown HTTP request headers should be passed to the TeamCity web application unmodified. For example TeamCity relies on "X-TC-CSRF-Token" header added by the clients.</p></div><a name="Apache"></a><a name="Apache"></a><div class="chapter"><h3 id="HowTo...-Apache">Apache</h3><p id="5b112c63">Versions 2.4.5+ are recommended. Earlier versions do not support the WebSocket protocol, so use the settings noted in <a href="https://confluence.jetbrains.com/display/TCD8/How+To..." data-external="true" target="_blank" rel="noopener noreferrer">the previous documentation version</a>.</p><p id="d805a17d">When using Apache, make sure to use the <a href="#Dedicated-&#34;Connector&#34;-Node-Approach">Dedicated "Connector" node approach</a> for configuring TeamCity server.</p><div class="code-block" data-lang="bash">
LoadModule  proxy_module          /usr/lib/apache2/modules/mod_proxy.so
LoadModule  proxy_http_module     /usr/lib/apache2/modules/mod_proxy_http.so
LoadModule  headers_module        /usr/lib/apache2/modules/mod_headers.so
LoadModule  proxy_wstunnel_module /usr/lib/apache2/modules/mod_proxy_wstunnel.so

ProxyRequests       Off
ProxyPreserveHost   On
ProxyPass           /tc/app/subscriptions ws://teamcity.local:8111/tc/app/subscriptions connectiontimeout=240 timeout=1200
ProxyPassReverse    /tc/app/subscriptions ws://teamcity.local:8111/tc/app/subscriptions

ProxyPass           /tc http://teamcity.local:8111/tc connectiontimeout=240 timeout=1200
ProxyPassReverse    /tc http://teamcity.local:8111/tc

</div><p id="f87b22c5">Note the order of <a href="https://httpd.apache.org/docs/2.4/mod/mod_proxy.html#proxypass" data-external="true" target="_blank" rel="noopener noreferrer">ProxyPass rules</a>: conflicting ProxyPass rules must be sorted starting with the longest URLs first.</p><p id="d0f8b913">Note that by default Apache allows only a limited number of parallel connections that may be insufficient when using the WebSocket protocol. For instance, it may result in the TeamCity server not responding when a lot of clients open the Web UI.To fix it, you may need to fine-tune the Apache configuration.</p><p id="0db0e14d">For example, on Unix you should switch to <a href="http://httpd.apache.org/docs/2.4/mod/worker.html" data-external="true" target="_blank" rel="noopener noreferrer">mpm_worker</a> and configure the maximum number of simultaneous connections:</p><div class="code-block" data-lang="bash">&lt;IfModule mpm_worker_module&gt;
    ServerLimit 100
    StartServers 3
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadLimit 64
    ThreadsPerChild 25
    MaxClients 2500
    MaxRequestsPerChild 0
&lt;/IfModule&gt;

</div><p id="d8c99e25">On Windows you may need to increase the <a href="http://httpd.apache.org/docs/2.4/mod/mpm_common.html#threadsperchild" data-external="true" target="_blank" rel="noopener noreferrer">ThreadsPerChild</a> value as described <a href="http://httpd.apache.org/docs/2.4/platform/windows.html" data-external="true" target="_blank" rel="noopener noreferrer">in the Apache documentation</a>.</p></div><a name="NGINX"></a><a name="NGINX"></a><div class="chapter"><h3 id="HowTo...-NGINX">NGINX</h3><p id="7ca8e5a0">For the NGINX configuration below, use the <a href="#Proxy-Tomcat-RemoteIpValve">"RemoteIpValve" Approach</a> for configuring TeamCity server.</p><p id="e02a9e8f">Versions 1.3+ are recommended. Earlier versions do not support the WebSocket protocol, so use the settings noted in <a href="https://confluence.jetbrains.com/display/TCD8/How+To..." data-external="true" target="_blank" rel="noopener noreferrer">the previous documentation version</a>.</p><div class="code-block" data-lang="java">
http {
&nbsp;&nbsp;&nbsp;&nbsp;# ... default settings here
&nbsp;&nbsp;&nbsp;&nbsp;proxy_read_timeout&nbsp;&nbsp;&nbsp;&nbsp; 1200;
&nbsp;&nbsp;&nbsp;&nbsp;proxy_connect_timeout&nbsp; 240;
&nbsp;&nbsp;&nbsp;&nbsp;client_max_body_size&nbsp;&nbsp; 0;&nbsp;&nbsp;&nbsp; # maximum size of an HTTP request. 0 allows uploading large artifacts to TeamCity
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;map $http_upgrade $connection_upgrade { # WebSocket support
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default upgrade;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'' '';
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;server {
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 400; # public server port
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp; teamcity.public; # public server host name
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location / { # public context (should be the same as internal context)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_pass&nbsp;http://teamcity.local:8111; # full internal address
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_http_version&nbsp; 1.1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;&nbsp;&nbsp; Host $server_name:$server_port;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;&nbsp;&nbsp; X-Forwarded-Host $http_host;&nbsp;&nbsp;&nbsp; # necessary for proper absolute redirects and TeamCity CSRF check
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;&nbsp;&nbsp; X-Forwarded-Proto $scheme;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;&nbsp;&nbsp; X-Forwarded-For $remote_addr;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;&nbsp;&nbsp; Upgrade $http_upgrade; # WebSocket support
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxy_set_header&nbsp;&nbsp;&nbsp; Connection $connection_upgrade; # WebSocket support
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}

</div></div><a name="Commonmisconfigurations"></a><a name="Common-misconfigurations"></a><div class="chapter"><h3 id="HowTo...-Commonmisconfigurations">Common misconfigurations</h3><p id="517cfdcb">Check that your reverse proxy (or a similar tool) conforms to the following requirements:</p><ul class="list _ul"><li class="list__item" id="98469801"><p>URLs with paths starting with a dot (the "." symbol) are supported (path to hidden artifacts start contain the ".teamcity" directory)</p></li><li class="list__item" id="f63b06ce"><p>URLs with a colon (":" symbol) are supported (many TeamCity resources use the colon). Related <a href="https://docs.microsoft.com/en-us/dotnet/api/system.web.configuration.httpruntimesection.requestpathinvalidcharacters?view=netframework-4.7.2" data-external="true" target="_blank" rel="noopener noreferrer">IIS setting</a>. Symptom: build has no artifacts with "No user-defined artifacts in this build." text even if there are artifacts.</p></li><li class="list__item" id="d85f6e99"><p>maximum response length / time are not too restrictive (since TeamCity can serve large files to slow clients, the responses can be of Gb in size and hours in time)</p></li><li class="list__item" id="9f3d0821"><p>gzip Content-Encoding is fully supported. e.g. certain IIS configurations can result in the "Loading data..." in UI and 500 HTTP responses (see the related <a href="https://youtrack.jetbrains.com/issue/TW-56218" data-external="true" target="_blank" rel="noopener noreferrer">issue</a>)</p></li></ul><p id="5b0a71f0"><a name="OtherServers"></a><a name="HowTo...-OtherServers"></a></p></div><a name="Otherservers"></a><a name="Other-servers"></a><div class="chapter"><h3 id="HowTo...-Otherservers">Other servers</h3><p id="eb24047e">Make sure to use a performant proxy with due (high) limits on request (upload) and response (download) size and timeouts (at least tens of minutes and gigabyte, according to the sizes of the codebase and artifacts).</p><p id="14805593">It is recommended to use a proxy capable of working with the WebSocket protocol as that helps UI to refresh sooner.</p><p id="596a22db">Generally, you need to configure the TeamCity server so that it "knows" about the original URL used by the client and it can generate correct absolute URLs accessible for the client. Preferred way to achieve that is to pass original "Host" header to TeamCity. Alternative is to set "X-Forwarded-Host" header to the original "Host" header value.</p><p id="c81d5001">Note that whenever the value of the "Host" header is changed by the proxy (while it is recommended to preserve original Host header value) and no "X-Forwarded-Host" header with the original Host value is provided, the values of the Origin and Referer headers should be mapped correspondingly if they contain the original Host header value (if they do not, they should not be set in order not to circumvent TeamCity <a href="csrf-protection.html">CSRF protection</a>).</p><p id="a652012e">Select a proper approach from the section below and configure the proxy accordingly.</p></div><a name="TeamCityTomcatConfiguration"></a><a name="TeamCity-Tomcat-Configuration"></a><div class="chapter"><h3 id="HowTo...-TeamCityTomcatConfiguration">TeamCity Tomcat Configuration</h3><p id="664bdba0">For a due TeamCity Tomcat configuration, there are two options:</p><ul class="list _ul"><li class="list__item" id="4203d23e"><p>use a <b id="fdb59a72">dedicated "Connector" node</b> in the server configuration with hard-coded public URL details and make sure that the port configured in the connector is used only by the requests to the public URL configured.</p></li><li class="list__item" id="566fdeae"><p>configure proxy to pass due request headers: "Host" or "X-Forwarded-Host" (original request host), "X-Forwarded-Proto" (original request protocol), "X-Forwarded-Port" (original request port) and <b id="e0a06195">configure "RemoteIpValve"</b> for the TeamCity Tomcat configuration.</p></li></ul><p id="9acd523c"><a name="Proxy-Tomcat-Connector"></a><a name="HowTo...-Proxy-Tomcat-Connector"></a></p></div><a name="Dedicated&#34;Connector&#34;NodeApproach"></a><a name="Dedicated-&#34;Connector&#34;-Node-Approach"></a><div class="chapter"><h3 id="HowTo...-Dedicated&#34;Connector&#34;NodeApproach">Dedicated "Connector" Node Approach</h3><p id="eb3be4b5">This approach can be used with any proxy configuration, provided the configured port is receiving requests only to the configured public URL.</p><p id="d83d0dbc">Set up the proxying server to redirect all requests to <code class="code">teamcity.public:400</code> to a dedicated port on the TeamCity server (<code class="code">8111</code> in the example below) and change "Connector" node in <code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a><code class="code">&gt;/conf/server.xml</code> file as below. Note that the "Connector" port configured this way should only be accessible via the configured proxy's address. If you also want to make TeamCity port accessible directly, use a separate "Connector" node with a dedicated <code class="code">port</code> value for that.</p><div class="code-block" data-lang="bash">
&lt;Connector port="8111" protocol="org.apache.coyote.http11.Http11NioProtocol"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connectionTimeout="60000"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;useBodyEncodingForURI="true"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.txBufSize="64000"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.rxBufSize="64000"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcpNoDelay="1"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxyName="teamcity.public"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxyPort="400"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;secure="false"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scheme="http"
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/&gt;

</div><p id="a8204cb5">When the public server address is <b id="f587d5fb">HTTPS</b>, use the <code class="code">secure="true"</code> and <code class="code">scheme="https"</code> attributes.</p><p id="dc0c0275"><a name="Proxy-Tomcat-RemoteIpValve"></a><a name="HowTo...-Proxy-Tomcat-RemoteIpValve"></a></p></div><a name="&#34;RemoteIpValve&#34;Approach"></a><a name="&#34;RemoteIpValve&#34;-Approach"></a><div class="chapter"><h3 id="HowTo...-&#34;RemoteIpValve&#34;Approach">"RemoteIpValve" Approach</h3><p id="203dd826">This approach can be used when the proxy server sets  "X-Forwarded-Proto", "X-Forwarded-Port" request headers to the values of the original URL. Also, while not critical for the most setups, this approach can be used to make sure the original client IP is passed to the TeamCity server correctly. This is important for legacy agents' <a href="setting-up-and-running-additional-build-agents.html#Bidirectional-Communication">bidirectional communication</a>.</p><p id="3b18783b">Add the following into the Tomcat main &lt;Host&gt; node of the <code class="code">conf\server.xml</code> file (see also Tomcat <a href="http://tomcat.apache.org/tomcat-8.5-doc/api/org/apache/catalina/valves/RemoteIpValve.html" data-external="true" target="_blank" rel="noopener noreferrer">doc</a>):</p><div class="code-block" data-lang="bash">
&lt;Valve
&nbsp;&nbsp;&nbsp;className="org.apache.catalina.valves.RemoteIpValve"
&nbsp;&nbsp;&nbsp;remoteIpHeader="x-forwarded-for"
&nbsp;&nbsp;&nbsp;protocolHeader="x-forwarded-proto"
&nbsp;&nbsp;&nbsp;portHeader="x-forwarded-port"
&nbsp;&nbsp;&nbsp;/&gt;

</div><p id="1efa0c6a">It is also recommended to specify <code class="code">internalProxies</code> attribute with the regular expression matching only IP address of the proxy server. e.g. <code class="code">internalProxies="192\.168\.0\.1"</code></p></div></div><a name="ConfigureHTTPSforTeamCityWebUI"></a><a name="Configure-HTTPS-for-TeamCity-Web-UI"></a><div class="chapter"><h2 id="HowTo...-ConfigureHTTPSforTeamCityWebUI">Configure HTTPS for TeamCity Web UI</h2><p id="d96c6dba">TeamCity does not provide out-of-the-box support for HTTPS access (see <a href="http://youtrack.jetbrains.com/issue/TW-12976#comment=27-348823" data-external="true" target="_blank" rel="noopener noreferrer">TW-12976</a>). It is highly recommended to set up a reverse proxy like Nginx or Apache in front of TeamCity that would handle HTTPS and use HTTP TeamCity server port as the upstream. HTTPS-related configuration of the proxy is not specific for TeamCity and is generic as for any Web application. Make sure to configure the reverse proxy per <a href="#Set-Up-TeamCity-behind-a-Proxy-Server">our recommendations</a> below. Generic web application best practices apply (like disabling http access to TeamCity at all).</p><p id="c5a54e90">For small servers, you can set up HTTPS via the internal <a href="http://tomcat.apache.org/tomcat-7.0-doc/ssl-howto.html" data-external="true" target="_blank" rel="noopener noreferrer">Tomcat means</a>, but this is not recommended as it may significantly increase the CPU load.</p><p id="4b778161">For configuring clients to access TeamCity server via HTTPS while using self-signed certificate, check the <a href="using-https-to-access-teamcity-server.html">related instructions</a>.</p></div><a name="ConfigureTeamCitytoUseProxyServerforOutgoingConnections"></a><a name="Configure-TeamCity-to-Use-Proxy-Server-for-Outgoing-Connections"></a><div class="chapter"><h2 id="HowTo...-ConfigureTeamCitytoUseProxyServerforOutgoingConnections">Configure TeamCity to Use Proxy Server for Outgoing Connections</h2><p id="f51ed0f7">This section describes configuring TeamCity to use proxy server for certain outgoing HTTP connections. To connect TeamCity behind a proxy to Amazon EC2 cloud agents, see <a href="setting-up-teamcity-for-amazon-ec2.html#Proxy-settings">this section</a>.</p><p id="6d1b6de1">TeamCity can use proxy server for certain outgoing HTTP connections made by the TeamCity server to other services like issues trackers, and so on.</p><p id="8f2e1cc7">To point TeamCity to your proxy server: <b id="3d17fae3">Since TeamCity 2017.1.5</b> the following server <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal properties</a> are available (see the alternative approach below for the previous version):</p><div class="code-block" data-lang="bash">
# For HTTP protocol
## The domain name or the IP address of the proxy host and the port:
teamcity.http.proxyHost=proxy.domain.com
teamcity.http.proxyPort=8080
&nbsp;
## The hosts that should be accessed without going through the proxy, usually internal hosts. Provide a list of hosts, separated by the '|' character. The wildcard '*' can be used:
teamcity.http.nonProxyHosts=localhost|*.mydomain.com)
&nbsp;
## For an authenticated proxy add the following properties:
### Authentication type. "basic" and "ntlm" values are supported. The default is basic.
teamcity.http.proxyAuthenticationType=basic
### Login and Password for the proxy:
teamcity.http.proxyLogin=username
teamcity.http.proxyPassword=password
&nbsp;
# For HTTPS protocol
## The domain name or the IP address of the proxy host and the port:
teamcity.https.proxyHost=proxy.domain.com
teamcity.https.proxyPort=8080
&nbsp;
## The hosts that should be accessed without going through the proxy, usually internal hosts. Provide a list of hosts, separated by the '|' character. The wildcard '*' can be used:
teamcity.https.nonProxyHosts=localhost|*.mydomain.com
&nbsp;
## For an authenticated proxy add the following properties:
### Authentication type. "basic" and "ntlm" values are supported. The default is basic.
teamcity.https.proxyAuthenticationType=basic
### Login and Password for the proxy:
teamcity.https.proxyLogin=login
teamcity.https.proxyPassword=password

</div><p id="c00290e3">The alternative approach, which will work for any TeamCity version, is to pass additional space-delimited <a href="configuring-teamcity-server-startup-properties.html#JVM-Options">additional JVM options</a> to the TeamCity server on the start up:</p><div class="code-block" data-lang="bash">
-Dproxyset=true
-Dhttp.proxyHost=proxy.domain.com
-Dhttp.proxyPort=8080
-Dhttp.nonProxyHosts=domain.com
-Dhttps.proxyHost=proxy.domain.com
-Dhttps.proxyPort=8080
-Dhttps.nonProxyHosts=domain.com

</div></div><a name="ConfigureTeamCityAgenttoUseProxyToConnecttoTeamCityServer"></a><a name="Configure-TeamCity-Agent-to-Use-Proxy-To-Connect-to-TeamCity-Server"></a><div class="chapter"><h2 id="HowTo...-ConfigureTeamCityAgenttoUseProxyToConnecttoTeamCityServer">Configure TeamCity Agent to Use Proxy To Connect to TeamCity Server</h2><p id="9496e3c0">This section covers the configuration of a proxy server for TeamCity agent-to-server connections (<b id="e3d293f9">since TeamCity 2017.1</b>).</p><a name="agent-proxy-server"></a><p id="5348ef66">On the TeamCity agent side, specify the proxy to connect to TeamCity server using the following properties in the <a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a> file:</p><div class="code-block" data-lang="bash">
## The domain name or the IP address of the proxy host and the port
teamcity.http.proxyHost=123.45.678.9
teamcity.http.proxyPort=8080
&nbsp;
## If the proxy requires authentication, specify the login and password
teamcity.http.proxyLogin=login
teamcity.http.proxyPassword=password

</div><p id="98794da5">Note that the proxy has to be configured not to cache any TeamCity server responses; for example, if you use Squid, add "cache deny all" line to the <code class="code">squid.conf</code> file.</p></div><a name="InstallMultipleAgentsontheSameMachine"></a><a name="Install-Multiple-Agents-on-the-Same-Machine"></a><div class="chapter"><h2 id="HowTo...-InstallMultipleAgentsontheSameMachine">Install Multiple Agents on the Same Machine</h2><p id="aa76b186">See the <a href="setting-up-and-running-additional-build-agents.html#Installing-Several-Build-Agents-on-the-Same-Machine">corresponding section</a> under agent installation documentation.</p></div><a name="ChangeServerPort"></a><a name="Change-Server-Port"></a><div class="chapter"><h2 id="HowTo...-ChangeServerPort">Change Server Port</h2><p id="ce4fb559">See <a href="installing-and-configuring-the-teamcity-server.html#Changing-Server-Port">corresponding section</a> in server installation instructions.</p></div><a name="Test-driveNewerTeamCityVersionbeforeUpgrade"></a><a name="Test-drive-Newer-TeamCity-Version-before-Upgrade"></a><div class="chapter"><h2 id="HowTo...-Test-driveNewerTeamCityVersionbeforeUpgrade">Test-drive Newer TeamCity Version before Upgrade</h2><p id="0d9db51a">It's advised to try a new TeamCity version before upgrading your production server. The usual procedure is to <a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">create a copy</a> of your production TeamCity installation, then <a href="upgrade.html">upgrade</a> it, try the things out, and, when everything is checked, drop the test server and upgrade the main one. When you start the test server, remember to change the Server URL, disable Email and Jabber notifiers as well as <a href="#Copied-Server-Checklist">other features</a> on the new server.</p></div><a name="CreateaCopyofTeamCityServerwithAllData"></a><a name="Create-a-Copy-of-TeamCity-Server-with-All-Data"></a><div class="chapter"><h2 id="HowTo...-CreateaCopyofTeamCityServerwithAllData">Create a Copy of TeamCity Server with All Data</h2><p id="34cf6dad">In case you want to preserve the original server as well as the copy, make sure to check the <a href="#Licensing-issues">licensing considerations</a>.</p><a name="CreateaServerCopy"></a><a name="Create-a-Server-Copy"></a><div class="chapter"><h3 id="HowTo...-CreateaServerCopy">Create a Server Copy</h3><p id="6adce7d0">You can create a copy of the server using TeamCity backup functionality or manually. Manual approach is recommended for the complete server move.</p></div><a name="UseTeamCityBackup"></a><a name="Use-TeamCity-Backup"></a><div class="chapter"><h3 id="HowTo...-UseTeamCityBackup">Use TeamCity Backup</h3><ol class="list _decimal"><li class="list__item" id="92899446"><p>Create a <a href="teamcity-data-backup.html">backup</a> including everything. (You can skip the option to backup build logs is you are moving the artifacts, see below).</p></li><li class="list__item" id="36b6c543">Install a new TeamCity server of the same version that you are already running. Ensure that:<ul class="list _ul"><li class="list__item" id="5ec34b8d"><p>the appropriate environment is configured (see the notes below)</p></li><li class="list__item" id="5872cca5"><p>the server uses its own <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code> and its own <a href="setting-up-an-external-database.html">database</a> (check the <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;config/database.properties</code> file)</p></li></ul></li><li class="list__item" id="031e4f6a"><p><a href="restoring-teamcity-data-from-backup.html">Restore the backup</a>.</p></li><li class="list__item" id="e4d16f06"><p>Move the artifacts (these are not included into the backup) by moving the content of  <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;/system/artifacts</code> directory from the old location to the new one. Since the artifacts can be large in the size, this can take a lot of time, so plan accordingly.</p></li><li class="list__item" id="570abead"><p>Perform the necessary <a href="#Environment-transferring">environment transfer</a>.</p></li></ol><aside class="note " data-title="" rel="942fa3dd" id="7127890b"><p id="ed0b3308">In order to ensure complete server transfer, it is recommended to copy the entire content of the TeamCity Data Directory from the original to the copied server. It is recommended to complete the copying before starting the new server.</p></aside></div><a name="CopyManually"></a><a name="Copy-Manually"></a><div class="chapter"><h3 id="HowTo...-CopyManually">Copy Manually</h3><p id="90179b6d">If you do not want to use bundled backup functionality or need manual control over the process, here is a description of the general steps one would need to perform to manually create copy of the server:</p><ol class="list _decimal"><li class="list__item" id="bb9bc356"><p>Create a <a href="teamcity-data-backup.html">backup</a> so that you can restore it if anything goes wrong,</p></li><li class="list__item" id="8c7ba4c7"><p>Ensure the server is not running,</p></li><li class="list__item" id="94a21d5d"><p>Either perform clean <a href="installing-and-configuring-the-teamcity-server.html">installation</a> or copy the TeamCity binaries (<a href="teamcity-home-directory.html"><code class="code">TeamCity Home Directory</code></a>) into a new place (the <code class="code">temp</code> and <code class="code">work</code> subdirectories can be omitted during copying).  Use exactly the same TeamCity version. If you plan to upgrade after copying, perform the upgrade only after you have the existing version up and running.</p></li><li class="list__item" id="7bc7a400">Copy <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code>. If you do not need the full copy, refer to the items below for options.<ul class="list _ul"><li class="list__item" id="2520063a"><p><code class="code">.BuildServer/config</code> to preserve projects and build configurations settings</p></li><li class="list__item" id="37c5c903"><p><code class="code">.BuildServer/lib</code> and <code class="code">.BuildServer/plugins</code> if you have them</p></li><li class="list__item" id="017e4c82"><p>files from the root of <code class="code">.BuildServer/system</code> if you use internal database and you do not want to perform database move.</p></li><li class="list__item" id="8db50a0e"><p><code class="code">.BuildServer/system/artifacts</code> (optional) if you want build artifacts and build logs (including tests failure details) preserved on the new server</p></li><li class="list__item" id="72ac8789"><p><code class="code">.BuildServer/system/changes</code> (optional) if you want personal changes preserved on the new server</p></li><li class="list__item" id="38421787"><p><code class="code">.BuildServer/system/pluginData</code> (optional) if you want to preserve state of various plugins, build triggers and settings audit diff</p></li><li class="list__item" id="83ec7960"><p><code class="code">.BuildServer/system/caches</code> and <code class="code">.BuildServer/system/caches</code> (optional) are not necessary to copy to the new server, they will be recreated on startup, but can take some time to be rebuilt (expect some slow down).</p></li></ul></li><li class="list__item" id="8ce66227"><p>Artifacts directory is usually large and if you need to minimize the downtime of the server in case of the server move, you can use the generic approach for copying the data: use rsync, robocopy or alike tool to copy the data while the original server is running. Repeat the sync run several times until the amount of data synced reduces. Run the final sync after the original server shut down. Alternative solution for the server move is to make the old data artifacts directory accessible to the new server and configure it as second <a href="teamcity-configuration-and-maintenance.html">location of artifacts</a>. Then copy the files over from this second location to the main one while the server is running, restart the server after copying completion.</p></li><li class="list__item" id="20940c1d"><p>Create copy of the <a href="setting-up-an-external-database.html">database</a> that your TeamCity installation is using in new schema or new database server. This can be done with database-specific tools or with the bundled maintainDB tool by <a href="creating-backup-via-maintaindb-command-line-tool.html">backing up</a> database data and then <a href="restoring-teamcity-data-from-backup.html">restoring</a> it.</p></li><li class="list__item" id="823416ae"><p>Configure new TeamCity installation to use proper <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code> and <a href="setting-up-an-external-database.html">database</a> (<code class="code">.BuildServer/config/database.properties</code> points to a copy of the database)</p></li><li class="list__item" id="348f27b7"><p>Perform the necessary <a href="#Environment-transferring">environment transfer</a>.</p></li></ol><aside class="tip sideblock" data-title="" rel="a992bceb" id="5211d054"><p id="069f1b35">If you want to do a quick check and do not want to preserve builds history on the new server you can skip step 6 (cloning database) and all items of the step 5 marked as optional.</p></aside><p id="02736327"><a name="environment_transfer"></a><a name="HowTo...-environment_transfer"></a></p></div><a name="Environmenttransferring"></a><a name="Environment-transferring"></a><div class="chapter"><h3 id="HowTo...-Environmenttransferring">Environment transferring</h3><p id="d2371292">Consider transferring relevant environment if it was specially modified for an existing TeamCity installation. This might include:</p><ul class="list _ul"><li class="list__item" id="459ec576"><p>use the appropriate OS user account for running the TeamCity server process with properly configured settings, global and file system permissions</p></li><li class="list__item" id="4d82ba99"><p>use the same <a href="configuring-teamcity-server-startup-properties.html">TeamCity process launching options</a>, specifically check/copy environment variables starting with <code class="code">TEAMCITY\_</code></p></li><li class="list__item" id="7adc57b1"><p>ensure any files/settings that were configured in the TeamCity web UI with absolute paths are accessible</p></li><li class="list__item" id="b406b654"><p>if relying on the OS-level user/machine settings like default ssh keys, cached VCS access credentials, transfer them as well</p></li><li class="list__item" id="d493a5c2"><p>consider replicating any special settings or exceptions related to the machine in the network configuration, etc.</p></li><li class="list__item" id="7c9302fb"><p>If the TeamCity installation was patched in any way (GrrovyPlug plugin, native driver for MS SQL Server integrated security authentication), apply the same modifications to the installation copy</p></li><li class="list__item" id="f4654a73"><p>if you run TeamCity with the OS startup (e.g. Windows service), make sure the same configuration is performed on the new machine</p></li><li class="list__item" id="9a348ccc"><p>review and tranfer settings in the <code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a><code class="code">&gt;\conf\teamcity-startup.properties</code> file</p></li><li class="list__item" id="8d4b5649"><p>consider any custom settings in <code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a><code class="code">&gt;\conf\server.xml</code></p></li></ul><p id="d2a365e1"><a name="copy_server_license"></a><a name="HowTo...-copy_server_license"></a></p></div><a name="Licensingissues"></a><a name="Licensing-issues"></a><div class="chapter"><h3 id="HowTo...-Licensingissues">Licensing issues</h3><p id="e2579f9c">A single TeamCity license <b id="7580a2f2">cannot be used on two running servers</b> at the same time.</p><ul class="list _ul"><li class="list__item" id="12c0c5b6"><p>A copy of the server created for redundancy/backup purposes can use the same license as only one of the servers will be running at a time.</p></li><li class="list__item" id="b561db2b"><p>A copy of the server created for testing purposes requires an additional license. You can get the time-limited TeamCity <a href="licensing-policy.html">evaluation license</a> once from the official TeamCity <a href="http://www.jetbrains.com/teamcity/download/" data-external="true" target="_blank" rel="noopener noreferrer">download page</a>. If you need an extension of the license or you have already evaluated the same TeamCity version, please <a href="http://www.jetbrains.com/company/contacts/index.html#Contacts_?TeamCity" data-external="true" target="_blank" rel="noopener noreferrer">contact our sales department</a>.</p></li><li class="list__item" id="61935c89"><p>A copy of the server intended to run at the same time as the main one regularly/for production purposes requires a separate license.</p></li></ul></div><a name="CopiedServerChecklist"></a><a name="Copied-Server-Checklist"></a><div class="chapter"><h3 id="HowTo...-CopiedServerChecklist">Copied Server Checklist</h3><p id="f74309f7">If you are creating a copy (as opposed to moving the server this way), it is important to go through the checklist below:</p><ul class="list _ul"><li class="list__item" id="b70798d3"><p>ensure the new server is configured to use another Data Directory and another database than the original server; check also "Artifact directories" setting on server's Global Settings;</p></li><li class="list__item" id="9e01cd88"><p>change server unique id by removing "uuid" attribute from XML of <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;\config\main-config.xml</code> file before the first start;</p></li><li class="list__item" id="6ca02f9f"><p>ensure the same license keys are not used on several servers (<a href="#Licensing-issues">more on licensing</a>);</p></li><li class="list__item" id="db6ea5da"><p>update <a href="configuring-server-url.html">Server URL</a> on <b id="6670813f">Administration</b> | <b id="54f00183">Global Settings</b> page to the actual URL of the server;</p></li><li class="list__item" id="02493123"><p>check that you can successfully authenticate on the new server, use <a href="super-user.html">super user</a> access if necessary;</p></li><li class="list__item" id="d1ac6eae"><p>check that VCS servers, issue tracker servers, email and Jabber server and other server-accessed systems are accessible;</p></li><li class="list__item" id="05ffa157"><p>check that any systems configured to push events to TeamCity server (like VCS hooks, automated build triggering, monitors, etc.) are updated to know about the new server;</p></li><li class="list__item" id="c3341352"><p>review the list of installed plugins to determine if their settings need changes;</p></li><li class="list__item" id="1160dafc"><p>install new agents (or select some from the existing ones) and configure them to connect to the new server (using the new server URL);</p></li><li class="list__item" id="f0efc431"><p>check that clients reading from the server (downloading artifact, using server's REST API, NuGet feed, etc.) are reconfigured, if necessary.</p></li></ul><p id="4dfea2f1">If you are creating a <b id="ac608c7d">test server</b>, you need to ensure that the users and production systems are not affected. Typically, this means you need to:</p><ul class="list _ul"><li class="list__item" id="50bcdfa3"><p>disable Email, Jabber (in the "Administration &gt; Notifier" sections) and possibly also custom notifiers or change their settings to prevent the new server from sending out notifications;</p></li><li class="list__item" id="e0a29956"><p>disable email verification (in the  "Administration &gt; Authentication" section);</p></li><li class="list__item" id="717d225b"><p>be sure not to run any builds which change (e.g. deploy to) production environments. This also typically includes Maven builds deploying to non-local repositories. You can prevent any builds from starting by pausing the <a href="build-queue.html">build queue</a>;</p></li><li class="list__item" id="97317553"><p>disable cloud integration (so that it does not interfere with the main server);</p></li><li class="list__item" id="af7c256a"><p>disable external artifact storage (as otherwise running/deleting builds and server cleanup will affect the storage which might be used by the production server);</p></li><li class="list__item" id="5a1c0560"><p>disable Git registry cleanup (or just disable cleanup on the server);</p></li><li class="list__item" id="255a638b"><p>disable Commit Status Publishing;*disable any plugins which push data into other non-copied systems based on the TeamCity events;*disable functionality to <a href="storing-project-settings-in-version-control.html">store project settings in VCS</a>: set <code class="code">teamcity.versionedSettings.enabled=false</code> internal property;</p></li><li class="list__item" id="786af0e4"><p>consider significantly increasing <a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS checking for changes interval</a> (server-wide default and overridden in the VCS roots) or changing settings of the VCS roots to prevent them from contacting production servers. Since TeamCity 10.0.3, see also <a href="https://youtrack.jetbrains.com/issue/TW-47324" data-external="true" target="_blank" rel="noopener noreferrer">TW-47324</a>.</p></li></ul><p id="c6f1f972">See also the section below on <a href="#Move-TeamCity-Installation-to-a-New-Machine">moving the server</a> from one machine to another.</p></div></div><a name="MoveTeamCityProjectsfromOneServertoAnother"></a><a name="Move-TeamCity-Projects-from-One-Server-to-Another"></a><div class="chapter"><h2 id="HowTo...-MoveTeamCityProjectsfromOneServertoAnother">Move TeamCity Projects from One Server to Another</h2><p id="784cac08">If you need to move data to a fresh server without existing data, it is recommended to <a href="#Move-TeamCity-Installation-to-a-New-Machine">move the server</a> or <a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">copy</a> it and then delete the data which is not necessary on the new server.</p><p id="eecbd41c">If you need to join the data with already existing data on the new server, there is a dedicated feature to move projects with most of the associated data from one server to another: <a href="projects-import.html">Projects Import</a>.</p><p id="36c20229"><i id="7a702f6e">Here are some notes on manual move of the settings in case you ever want to perform it</i></p><p id="5a7dc9af">Since TeamCity 8.0 it is possible to move <i id="5c00ed9f">settings</i> of a project or a build configuration to another server with simple file copying. For earlier TeamCity versions see the <a href="http://youtrack.jetbrains.net/issue/TW-4124#comment=27-76834" data-external="true" target="_blank" rel="noopener noreferrer">comment</a>.</p><p id="01c8bee5">The two TeamCity servers (source and target) should be of exactly the same version (same build).</p><p id="c39942ff">All the <a href="identifier.html">identifiers</a> throughout all the projects, build configurations and VCS roots of both servers should be unique. If they are not, you can change them via web UI. If entities with the same id are present on different servers, the entities are assumed to be the same. For example this is useful for having global set of VCS roots on all the servers.</p><p id="9a2ccb42">To move settings of the project and all its build configuration from one server to another:</p><p id="7caf70f6">From the <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a>, copy the directories of corresponding projects (<code class="code">.BuildServer\config\projects\&lt;id&gt;</code>) and all its parent projects to <code class="code">.BuildServer\config\projects</code> of the target server. This moves project settings, build configuration settings, VCS roots defined in the projects preserving the links between them. If there are same-named files on the target server as those copied, this can happen in case ofa) id match: same entities already exist on the target server, in which case the clashing files can be excluded from copying, orb) id clash: different entities happen to have same ids. In this case it should be resolved either by changing entity id on the source or target server to fulfill the uniqueness requirement.</p><p id="cbf53fc3">The set of parent projects is to be identifiedmanually based on the web UI or the directory names on disk (which be default will have the same prefix).</p><p id="b65b7d27">Note: It might make sense to keep the settings of the <a href="project.html#Root-Project">root project</a> synchronized between all the servers (by synchronizing content of <code class="code">.BuildServer\config\projects_Root</code> directory). For example, this will ensure same settings for the default cleanup policy on all the servers.</p><p id="cc58a595">Further steps after projects copying might be:</p><ul class="list _ul"><li class="list__item" id="0d853bf9"><p>delete unused data in the copied parent projects (if any) on the target server</p></li><li class="list__item" id="05a4b874"><p>use "server health" reports to identify duplicate VCS roots appeared in result of copying, if any</p></li><li class="list__item" id="f17940fd"><p>archive the projects on the source server and adjust cleanup rules (to be able to see build's history, if necessary)</p></li></ul><p id="79477fb2">What is <i id="5ec51646">not</i> copied by the approach above:</p><ul class="list _ul"><li class="list__item" id="d386da47"><p>pausing comment and user of the paused build configurations</p></li><li class="list__item" id="67d5773d"><p>archiving user of the archived projects</p></li><li class="list__item" id="5f477a79"><p>global server settings (e.g. Maven settings.xml profiles, tools (e.g. handle.exe), external change viewers, build queue priorities, issue trackers). These are stored under various files under <code class="code">.BuildServer\config</code> directory and should be synchronized either on the file level or by configuring the same settings in the server administration UI.</p></li><li class="list__item" id="f41fedc0"><p>project association with agent pools</p></li><li class="list__item" id="f3c8d155"><p>templates from other projects which are not parents of the copied one. This configuration is actually deprecated in TeamCity 8.0 and is only supported as legacy. Templates used in several projects should be moved to the common parent project or root project.</p></li><li class="list__item" id="f5290269"><p>no data configured for the agents (build configurations that are allowed to run on the agent).</p></li><li class="list__item" id="7897eb77"><p>no user-related or user group-related settings (like roles and notification rules)</p></li><li class="list__item" id="4e28f13c"><p>no state-related data like mutes and investigations, etc.</p></li></ul></div><a name="MoveTeamCityInstallationtoaNewMachine"></a><a name="Move-TeamCity-Installation-to-a-New-Machine"></a><div class="chapter"><h2 id="HowTo...-MoveTeamCityInstallationtoaNewMachine">Move TeamCity Installation to a New Machine</h2><p id="798c0ae6">If you need to move an existing TeamCity installation to new hardware or a clean OS, you can install the same TeamCity version on the new machine, stop the old server, connect the new server to the same <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> and make sure the server uses the <a href="#Environment-transferring">same environment</a>. Alternatively, you can follow the <a href="#Create-a-Copy-of-TeamCity-Server-with-All-Data">instructions on copying</a> the server from one machine to another.</p><p id="859a0510">After the move, make the clients <a href="#Switching-from-one-server-to-another">use the new server address</a>, if changed.</p><p id="4f9e5af6">You can use the existing <a href="licensing-policy.html#Managing-Licenses">license keys</a> when you move the server from one machine to another (as long as there are no two servers running at the same time). As license keys are stored under <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code>, you transfer the license keys with all the other TeamCity settings data.</p><p id="0468b574">It is usually advised not to combine TeamCity update with any other actions, like environment or hardware changes, and perform the changes one at a time so that, if something goes wrong, the cause can be easily tracked.</p><a name="Switchingfromoneservertoanother"></a><a name="Switching-from-one-server-to-another"></a><div class="chapter"><h3 id="HowTo...-Switchingfromoneservertoanother">Switching from one server to another</h3><p id="0e6a2ad7">Note that <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code> and database should be used by a single TeamCity instance at any given moment. If you configured a new TeamCity instance to use the same data, ensure you shutdown and disable the old TeamCity instance before starting the new one.</p><p id="43be40d9">Generally it is recommended to use a domain name to access the server (in the agent configuration and when users access the TeamCity web UI). This way you can update the DNS entry to make the address resolve to the IP address of the new server and after all cached DNS results expire, all clients will automatically use the new server. You might need to reduce the DNS server cache/lease time in advance before the change to make the clients "understand" the change fast.</p><p id="7010e4e0">However, if you need to use another server domain address, you will need to:</p><ul class="list _ul"><li class="list__item" id="50670580"><p>Switch agents to the new URL (requires updating the <code class="code">serverUrl</code> property in <code class="code">buildAgent.properties</code> on each agent). If you want to install agents anew but preserve agent's name and authentication status, you can install a new agent and copy the <code class="code">conf\buildAgent.properties</code> file from an old agent (checking that any paths in it are updated accordingly).</p></li><li class="list__item" id="56aa0497"><p>Upon the new server startup, remember to update the <a href="configuring-server-url.html">Server URL</a> on <b id="64eab148">Administration</b> | <b id="a660a681">Global Settings</b> page.</p></li><li class="list__item" id="7d8bbb1d"><p>Notify all TeamCity users on the new address</p></li><li class="list__item" id="a52dff4b"><p>Consider updating settings of external services if they depend on the request originating address</p></li></ul></div></div><a name="MoveTeamCityAgenttoaNewMachine"></a><a name="Move-TeamCity-Agent-to-a-New-Machine"></a><div class="chapter"><h2 id="HowTo...-MoveTeamCityAgenttoaNewMachine">Move TeamCity Agent to a New Machine</h2><p id="2ab18cbb">Apart from the binaries, TeamCity agent installation stores its configuration and data left from the builds it run. Usually the data from the previous builds makes preparation for the future builds a bit faster, but it can be deleted if necessary. The configuration is stored under <code class="code">conf</code> and <code class="code">launcher\conf</code> directories. The data collected by previous build is stored under <code class="code">work</code> and <code class="code">system</code> directories.</p><p id="a7355b4a">The most simple way to move agent installation into a new machine or new location is to:</p><ul class="list _ul"><li class="list__item" id="eba245ef"><p>stop existing agent</p></li><li class="list__item" id="1326ba54"><p><a href="setting-up-and-running-additional-build-agents.html">install</a> a new agent on the new machine</p></li><li class="list__item" id="5ce06108"><p>copy <code class="code">conf/buildAgent.properties</code> from the old installation to a new one</p></li><li class="list__item" id="7845ddad"><p>start the new agent.With these steps the agent will be recognized by TeamCity server as the same and will perform <a href="clean-checkout.html">clean checkout</a> for all the builds.</p></li></ul><p id="2c6936e5">Please also review the <a href="agent-home-directory.html">section</a> for a list of directories that can be deleted without affecting builds consistency.</p></div><a name="SharetheBuildnumberforBuildsinaChainBuild"></a><a name="Share-the-Build-number-for-Builds-in-a-Chain-Build"></a><div class="chapter"><h2 id="HowTo...-SharetheBuildnumberforBuildsinaChainBuild">Share the Build number for Builds in a Chain Build</h2><p id="f0e137d8">A build number can be shared for builds connected by a <a href="dependent-build.html#Snapshot-Dependency">snapshot dependency</a> or an <a href="dependent-build.html#Artifact-Dependency">artifact dependency</a> using a reference to the following dependency property: <code class="code">%dep.&amp;lt;btID&amp;gt;.system.build.number%</code>.</p><p id="987a0baf">For example, you have build configurations A and B that you want to build in sync: use the same sources and take the same build number.<br>Do the following:</p><ol class="list _decimal"><li class="list__item" id="1774283c"><p>Create build configuration C, then snapshot dependencies: <b id="ae405035">A on C</b> and <b id="8c8bf253">B on C</b>.</p></li><li class="list__item" id="b85f6dad"><p>Set the <a href="configuring-general-settings.html#Build-Number-Format">Build number format</a> in A and B to:</p></li></ol><div class="code-block" data-lang="bash">
%dep.&lt;btID&gt;.system.build.number%

</div><p id="a46a6e0f">Where <code class="code">&lt;btID&gt;</code> is the <a href="build-configuration.html">ID of the build configuration</a> C. The approach works best when builds reuse is turned off via the <a href="snapshot-dependencies.html">Snapshot Dependencies</a> snapshot dependency option set to off.</p><p id="85501851"><a href="predefined-build-parameters.html#Configuration-Parameters">Read more</a> about dependency properties.</p><p id="5729ae6c">Please watch/comment the issue related to sharing a build number <a href="http://www.jetbrains.net/tracker/issue/TW-7745" data-external="true" target="_blank" rel="noopener noreferrer">TW-7745</a>.</p></div><a name="MakeTemporaryBuildFilesErasedbetweentheBuilds"></a><a name="Make-Temporary-Build-Files-Erased-between-the-Builds"></a><div class="chapter"><h2 id="HowTo...-MakeTemporaryBuildFilesErasedbetweentheBuilds">Make Temporary Build Files Erased between the Builds</h2><p id="2c03be7b">Update your build script to use path stored in <code class="code">${teamcity.build.tempDir}</code> (Ant's style name) property as the temp directory. TeamCity agent creates the <a href="agent-home-directory.html#temp-dir">directory</a> before the build and deletes it right after the build.</p></div><a name="ClearBuildQueueifItHasTooManyBuildsduetoaConfigurationError"></a><a name="Clear-Build-Queue-if-It-Has-Too-Many-Builds-due-to-a-Configuration-Error"></a><div class="chapter"><h2 id="HowTo...-ClearBuildQueueifItHasTooManyBuildsduetoaConfigurationError">Clear Build Queue if It Has Too Many Builds due to a Configuration Error</h2><p id="3c75b70b">Try pausing the build configuration that has the builds queued. On build configuration pausing all its builds are removed form the queue.<br>Also there is an ability to delete many builds from the build queue in a single dialog.</p></div><a name="AutomaticallycreateorchangeTeamCitybuildconfigurationsettings"></a><a name="Automatically-create-or-change-TeamCity-build-configuration-settings"></a><div class="chapter"><h2 id="HowTo...-AutomaticallycreateorchangeTeamCitybuildconfigurationsettings">Automatically create or change TeamCity build configuration settings</h2><p id="b48a9eef">If you need a level of automation and web administration UI does not suite your needs, there several possibilities:</p><ul class="list _ul"><li class="list__item" id="13dc0783"><p>use <a href="rest-api.html">REST API</a></p></li><li class="list__item" id="36e3bbb8"><p>change configuration files directly on disk (see more at <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;</code>)</p></li><li class="list__item" id="8060f0b5"><p>write a TeamCity Java plugin that will perform the tasks using <a href="https://confluence.jetbrains.com/display/TCD18/Developing+TeamCity+Plugins" data-external="true" target="_blank" rel="noopener noreferrer">open API</a>.</p></li></ul></div><a name="AttachCucumberReportertoAntBuild"></a><a name="Attach-Cucumber-Reporter-to-Ant-Build"></a><div class="chapter"><h2 id="HowTo...-AttachCucumberReportertoAntBuild">Attach Cucumber Reporter to Ant Build</h2><p id="0b9e8cf9">If you use Cucumber for Java applications testing you should run cucumber with <code class="code">--expand</code> and special <code class="code">--format</code> options. More over you should specify RUBYLIB environment variable pointing on necessary TeamCity Rake Runner ruby scripts:</p><div class="code-block" data-lang="bash">
&lt;&lt;target name="features"&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&lt;java classname="org.jruby.Main" fork="true" failonerror="true"&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;classpath&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pathelement path="${jruby.home}/lib/jruby.jar"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pathelement path="${jruby.home}/lib/ruby/gems/1.8/gems/jvyaml-0.0.1/lib/jvyamlb.jar"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;....
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/classpath&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;jvmarg value="-Xmx512m"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;jvmarg value="-XX:+HeapDumpOnOutOfMemoryError"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;jvmarg value="-ea"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;jvmarg value="-Djruby.home=${jruby.home}"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;arg value="-S"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;arg value="cucumber"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;arg value="--format"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;arg value="Teamcity::Cucumber::Formatter"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;arg value="--expand"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;arg value="."/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;env key="RUBYLIB"
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value="${agent.home.dir}/plugins/rake-runner/rb/patch/common${path.separator}${agent.home.dir}/plugins/rake-runner/rb/patch/bdd"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;env key="TEAMCITY_RAKE_RUNNER_MODE" value="buildserver"/&gt;
 &nbsp;&nbsp;&nbsp;&nbsp;&lt;/java&gt;
 &nbsp;&nbsp;&lt;/target&gt;

</div><p id="f128d1dc">Please check the RUBYLIB path separator (';' for Windows, ':' for Linux, or '${path.separator}' in ant for safety).<br>If you are launching Cucumber tests using the Rake build language, TeamCity will add all necessary command line parameters and environment variables automatically. This tip works in TeamCity version &gt;= 5.0.</p></div><a name="GetLastSuccessfulBuildNumber"></a><a name="Get-Last-Successful-Build-Number"></a><div class="chapter"><h2 id="HowTo...-GetLastSuccessfulBuildNumber">Get Last Successful Build Number</h2><p id="29c0e92d">Use URL like this:</p><div class="code-block" data-lang="bash">
http://&lt;your TeamCity server&gt;/app/rest/buildTypes/id:&lt;ID of build configuration&gt;/builds/status:SUCCESS/number

</div><p id="bb7e4ada">The build number will be returned as a plain-text response.<br>For <code class="code">&lt;ID of build configuration&gt;</code>, see <a href="identifier.html">Identifier</a>.<br>This functionality is provided by <a href="rest-api.html">REST API</a></p></div><a name="SetupDeploymentforMyApplicationinTeamCity"></a><a name="Set-up-Deployment-for-My-Application-in-TeamCity"></a><div class="chapter"><h2 id="HowTo...-SetupDeploymentforMyApplicationinTeamCity">Set up Deployment for My Application in TeamCity</h2><p id="460c4647">TeamCity has enough features to handle orchestration part of the deployments with the actual deployment logic configured in the build script / build runner. TeamCity supports a variety of generic build tools, so any specific tool can be run from within TeamCity. To ease specific tool usage, it is possible to wrap it into a meta-runner or write a custom plugin for that.</p><p id="52676884">In general, setup steps for configuring deployments are:</p><ol class="list _decimal"><li class="list__item" id="43ea5188"><p>Write a build script that will perform the deployment task for the binary files available on the disk. (e.g. use Ant or MSBuild for this. For typical deployment transports use <a href="deployers.html">Deployer</a> runners). See also <a href="#Integrate-with-Build-and-Reporting-Tools">Integrate with Build and Reporting Tools</a>. You can use <a href="working-with-meta-runner.html">Meta-Runner</a> to reuse a script with convenient UI.</p></li><li class="list__item" id="9e15a9bf"><p>Create a build configuration in TeamCity that will execute the build script and perform the actual deployment. If the deployment is to be visible or startable only by the limited set of users, place the build configuration in a separate TeamCity project and make sure the users have appropriate permissions in the project.</p></li><li class="list__item" id="3c45a813"><p>In this build configuration configure <a href="dependent-build.html#Artifact-Dependency">artifact dependency</a> on a build configuration that produces binaries that need to be deployed.</p></li><li class="list__item" id="0de9686b"><p>Configure one of the available triggers in the deploying build configuration if you need the deployment to be triggered automatically (e.g. to deploy last successful of last pinned build), or use "Promote" action in the build that produced the binaries to be deployed.</p></li><li class="list__item" id="13d67a39"><p>Consider using <a href="dependent-build.html#Snapshot-Dependency">snapshot dependencies</a> in addition to artifact ones and check <a href="build-chain.html">Build Chains</a> tab to get the overview of the builds. In this case artifact dependency should use "Build from the same chain" option.</p></li><li class="list__item" id="761ec9d0"><p>If you need to parametrize the deployment (e.g. specify different target machines in different runs), pass parameters to the build script using <a href="triggering-a-custom-build.html">custom build run dialog</a>. Consider using <a href="typed-parameters.html">Typed Parameters</a> to make the custom run dialog easier to use or handle passwords.</p></li><li class="list__item" id="12591383"><p>If the deploying build is triggered manually consider also adding commands in the build script to pin and tag the build being deployed (via sending a <a href="rest-api.html#Build-Tags">REST API</a> request). You can also <a href="#Share-the-Build-number-for-Builds-in-a-Chain-Build">use a build number</a> from the build that generated the artifact.</p></li></ol><p id="c09a7d0d">Further recommendations:</p><ul class="list _ul"><li class="list__item" id="836c1ec1"><p>Setup a separate build configurations for each target environment</p></li><li class="list__item" id="5f1e96c5"><p>Use build's Dependencies tab for navigation between build producing the binaries and deploying builds/tasks</p></li><li class="list__item" id="51485986"><p>If necessary, use parameter with "prompt" display mode to ask for "<a href="https://youtrack.jetbrains.com/issue/TW-8284#comment=27-290611" data-external="true" target="_blank" rel="noopener noreferrer">confirmation</a>" on running a build</p></li><li class="list__item" id="791eddca"><p><a href="https://youtrack.jetbrains.com/issue/TW-20617#comment=27-527943" data-external="true" target="_blank" rel="noopener noreferrer">Change title</a> of the build configuration "Run" button</p></li></ul><p id="201662f7">Related section on the official site: <a href="http://www.jetbrains.com/teamcity/features/deployment.html" data-external="true" target="_blank" rel="noopener noreferrer">Continuous Deployment with TeamCity</a></p></div><a name="UseanExternalToolthatMyBuildRelieson"></a><a name="Use-an-External-Tool-that-My-Build-Relies-on"></a><div class="chapter"><h2 id="HowTo...-UseanExternalToolthatMyBuildRelieson">Use an External Tool that My Build Relies on</h2><p id="1c9099af">If you need to use specific external tool to be installed on a build agent to run your builds, you have the following options:</p><ul class="list _ul"><li class="list__item" id="ff418e4f">Install and register the tool in TeamCity:<ol class="list _decimal"><li class="list__item" id="a4e12b94"><p>Install the tool on all the agents that will run the build. This can be done manually or via an automated script. For simple file distribution also see <a href="installing-agent-tools.html">Installing Agent Tools</a></p></li><li class="list__item" id="faab2759"><p>Add a property into <code class="code">buildAgent.properties</code> file (or add environment variable to the system) with the tool home location as the value.</p></li><li class="list__item" id="d4a04aae"><p>Add agent requirement for the property in the build configuration.</p></li><li class="list__item" id="4ffa0e7e"><p>Use the property in the build script.</p></li></ol></li><li class="list__item" id="269ed6ea"><p>Check in the tool into the version control and use relative paths.</p></li><li class="list__item" id="6026aa0b"><p>Add environment preparation stage into the build script to get the tool form elsewhere.</p></li><li class="list__item" id="cdb82759"><p>Create a separate build configuration with a single "fake" build which would contain required files as artifacts, then use artifact dependencies to send files to the target build.</p></li></ul></div><a name="IntegratewithBuildandReportingTools"></a><a name="Integrate-with-Build-and-Reporting-Tools"></a><div class="chapter"><h2 id="HowTo...-IntegratewithBuildandReportingTools">Integrate with Build and Reporting Tools</h2><p id="c7d71b23">If you have a build tool or a tool that generates some report/provides code metrics which is not yet <a href="teamcity-documentation.html#TeamCity-2019.x-Supported-Platforms-and-Environments">supported by TeamCity</a> or any of the <a href="https://plugins.jetbrains.com/teamcity" data-external="true" target="_blank" rel="noopener noreferrer">plugins</a>, most probably you can use it in TeamCity even without dedicated integration.</p><p id="9644b5bc">The integration tasks involved are collecting the data in the scope of a build and then reporting the data to TeamCity so that they can be presented in the build results or in other ways.</p><p id="52ba325e"><b id="7d7c4770">Data collection</b></p><p id="a292600d">The easiest way for a start is to modify your build scripts to make use of the selected tool and collect all the required data.<br>If you can run the tool from a command line console, then you can run it in TeamCity with a <a href="command-line.html">command line runner</a>. This will give you detection of the messages printed into standard error output. The build can be marked as failed is the exit code is not zero or there is output to standard error via <a href="build-failure-conditions.html">build failure condition</a>.<br>If the tool has launchers for any of the supported build scripting engines like Ant, Maven or MSBuild, then you can use corresponding runner in TeamCity to start the tool. See also <a href="#Use-an-External-Tool-that-My-Build-Relies-on">Use an External Tool that My Build Relies on</a> for the recommendations on how to run an external tool.</p><p id="98c5d5ff">You can also consider creating a <a href="working-with-meta-runner.html">Meta Runner</a> to let the tool have dedicated UI in TeamCity.</p><p id="f0cea82a">For an advanced integration a custom <a href="https://plugins.jetbrains.com/docs/teamcity/build-runner-plugin.html" data-external="true" target="_blank" rel="noopener noreferrer">TeamCity plugin</a> can be developed in Java to ease tool configuration and running.</p><p id="eb5c040c"><b id="649604c2">Presenting data in TeamCity</b></p><p id="f2bf9aa1">The build progress can be reported to TeamCity via <a href="build-script-interaction-with-teamcity.html#Reporting-Build-Progress">service messages</a> and build status text can also be <a href="build-script-interaction-with-teamcity.html#Reporting-Build-Status">updated</a>.</p><p id="2a3099e4">For testing tools, if they are not yet <a href="testing-frameworks.html">supported</a> you can report tests progress to TeamCity from the build via <a href="build-script-interaction-with-teamcity.html#Reporting-Tests">test-related service messages</a> or generate one of the supported <a href="xml-report-processing.html">XML reports</a> in the build and let it be imported via a service message of configured XML Report Processing build feature.</p><p id="e4b2ae16">To present the results for a generic report, the approach might be to generate HTML report in the build script, pack it into archive and publish as a build artifact. Then configure a <a href="including-third-party-reports-in-the-build-results.html">report tab</a> to display the HTML report as a tab on build's results.</p><p id="40a03c40">A metrics value can be published as TeamCity statistics via <a href="build-script-interaction-with-teamcity.html#Reporting-Build-Statistics">service message</a> and then displayed in a <a href="customizing-statistics-charts.html#Showing-Charts-Only-for-Specific-Build-Configurations-on-Project-Level">custom chart</a>. You can also configure <a href="build-failure-conditions.html#Fail-build-on-metric-change">build failure condition</a> based on the metric.</p><p id="fc68d96b">If the tool reports code-attributing information like Inspections or Duplicates, TeamCity-bundled report can be used to display the results. A custom plugin will be necessary to process the tool-specific report into TeamCity-specific data model. Example of this can be found in <a href="xml-report-processing.html">XML Test Reporting</a> plugin and FXCop plugin (see a link on <a href="https://confluence.jetbrains.com/display/TW/Open-source+Bundled+Plugins" data-external="true" target="_blank" rel="noopener noreferrer">Open-source Bundled Plugins</a>).</p><p id="7a3daa15">See also <a href="#Import-coverage-results-in-TeamCity">Import coverage results in TeamCity</a>.</p><p id="7388f62d">For advanced integration, a custom plugin will be necessary to store and present the data as required. See <a href="https://confluence.jetbrains.com/display/TCD18/Developing+TeamCity+Plugins" data-external="true" target="_blank" rel="noopener noreferrer">Developing TeamCity Plugins</a> for more information on plugin development.</p></div><a name="RestoreJustDeletedProject"></a><a name="Restore-Just-Deleted-Project"></a><div class="chapter"><h2 id="HowTo...-RestoreJustDeletedProject">Restore Just Deleted Project</h2><p id="a9ca75ed">TeamCity moves deleted projects settings directories (which are named after the project id) to <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;/config/_trash</code> directory adding <code class="code">"&lt;internal ID&gt;"</code> suffix to the directories.</p><p id="cd680153">To restore a project, find the project directory in the _trash directory and move it into regular projects settings directory: <code class="code">&lt;</code><a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a><code class="code">&gt;/config/projects</code> while removing the <code class="code">".projectN"</code> suffix from the directory name.<br>You can do this while server is running, it should pick up the restored project automatically.</p><p id="d12325bd">Note that TeamCity preserves builds history and other data stored in the database for deleted projects/build configurations for 5 days after the deletion time. All the associated data (builds and test history, changes, etc.) is removed during the next clean-up after the <a href="clean-up.html#Deleted-Build-Configurations-Cleanup">configurable</a> (5 days by default) timeout elapses.</p><p id="1a222864">The <code class="code">config/_trash</code> directory is not cleaned automatically and can be emptied manually if you are sure you do not need the deleted projects. No server restart is required.</p></div><a name="Transfer3DefaultAgentstoAnotherServer"></a><a name="Transfer-3-Default-Agents-to-Another-Server"></a><div class="chapter"><h2 id="HowTo...-Transfer3DefaultAgentstoAnotherServer">Transfer 3 Default Agents to Another Server</h2><p id="b3be52b1">This is not possible.</p><p id="796b11de">Each TeamCity server (Professional and Enterprise) allows using 3 or more agents bound to the server without any agent licenses. In case of the Professional server, by default 3 agents are bound to the server instance: users do not pay for these agents, there is no license key for them.<br>In case of the Enterprise server, the number of agents depends on your package and the agents are bound to the server license key.</p><p id="c6c4257d">So, the agents bound to the server cannot be transferred to another server.</p><p id="206a467b">If you need more build agents that are included with your TeamCity server, you can purchase additional build agent licenses and connect more agents in addition to those that come bound with the server.</p><p id="44fd75b0">See <a href="licensing-policy.html">more</a> on licensing.</p></div><a name="ImportcoverageresultsinTeamCity"></a><a name="Import-coverage-results-in-TeamCity"></a><div class="chapter"><h2 id="HowTo...-ImportcoverageresultsinTeamCity">Import coverage results in TeamCity</h2><p id="46fea3fe">TeamCity comes bundled with IntelliJ IDEA/Emma and, JaCoCo coverage engines for Java and dotCover/NCover/PartCover for .NET.</p><p id="da54ccb0">However, there are plenty of other coverage tools out there, like <a href="http://cobertura.sourceforge.net/index.html" data-external="true" target="_blank" rel="noopener noreferrer">Cobertura</a> and others which are not directly supported by TeamCity.</p><p id="1c8abdc1">In order to achieve similar experience with these tools you can:</p><ul class="list _ul"><li class="list__item" id="26acd9ee"><p>publish coverage HTML report as TeamCity artifact: most of the tools produce coverage report in HTML format, you can publish it as artifact and <a href="including-third-party-reports-in-the-build-results.html">configure report tab</a> to show it in TeamCity. If artifact is published in the root artifact directory and its name is <code class="code">coverage.zip</code> and there is <code class="code">index.html</code> file in it, report tab will be shown automatically. As to running an external tool, check <a href="#Integrate-with-Build-and-Reporting-Tools">Integrate with Build and Reporting Tools</a>.</p></li><li class="list__item" id="d8610845"><p>extract coverage statistics from coverage report and publish <a href="custom-chart.html#Default-Statistics-Values-Provided-by-TeamCity">statistics values</a> to TeamCity with help of <a href="build-script-interaction-with-teamcity.html#Reporting-Build-Statistics">service message</a>: if you do so, you'll see coverage chart on build configuration Statistics tab and also you'll be able to fail a build with the help of a build failure condition on a metric change (for example, you can fail build if the coverage drops).</p></li></ul><aside class="note " data-title="" rel="3a17e0a5" id="538fd65b"><p id="5b4fbeaf">You should not publish values CodeCoverageB, CodeCoverageL, CodeCoverageM, CodeCoverageC standing for block/line/method/class coverage percentage. TeamCity will calculate these values using their absolute parts. E.g. CodeCoverageL will be calculated as CodeCoverageAbsLCovered divided by CodeCoverageAbsLTotal. You could publish these values but in this case they will lack decimal parts and will not be useful.</p></aside></div><a name="Recoverfrom&#34;DataformatoftheDataDirectory(NNN)andthedatabase(MMM)donotmatch&#34;error"></a><a name="Recover-from-&#34;Data-format-of-the-Data-Directory-(NNN)-and-the-database-(MMM)-do-not-match&#34;-error"></a><div class="chapter"><h2 id="HowTo...-Recoverfrom&#34;DataformatoftheDataDirectory(NNN)andthedatabase(MMM)donotmatch&#34;error">Recover from "Data format of the Data Directory (NNN) and the database (MMM) do not match" error</h2><p id="ff1f1330">If you get "Data format of the Data Directory (NNN) and the database (MMM) do not match." error on starting TeamCity, it means either the database or the TeamCity Data Directory were recently changed to an inconsistent state so they cannot be used together. Double-check the database and Data Directory locations and change them if they are not those where the server used to store the data.</p><p id="344a8169">If they are right, most probably it means that the server was upgraded with another database or Data Directory and the <a href="upgrade.html#Upgrading-TeamCity-Server">consistent upgrade</a> requirement was not met for your main Data Directory and the database.</p><p id="37647ab2">To recover from the state you will need backup of the consistent state made prior to the upgrade. You will need to restore that backup, ensure the right locations are used for the Data Directory and the database and perform the TeamCity upgrade.</p></div><a name="DebugaBuildonaSpecificAgent"></a><a name="Debug-a-Build-on-a-Specific-Agent"></a><div class="chapter"><h2 id="HowTo...-DebugaBuildonaSpecificAgent">Debug a Build on a Specific Agent</h2><p id="a54748cf">In case a build fails on some agent, it is possible to debug it on this very agent to investigate agent-specific issues. Do the following:</p><ol class="list _decimal"><li class="list__item" id="0b079aa7"><p>Go to the <b id="237c45ba">Agents</b> page in the TeamCity web UI and <a href="viewing-build-agent-details.html">select the agent</a>.</p></li><li class="list__item" id="3e8d5351"><p><a href="build-agents-configuration-and-maintenance.html#Enabling/Disabling-Agents-via-UI">Disable the agent</a> to temporarily remove it from the <a href="build-grid.html">build grid</a>. Add a comment (optional). To enable the agent automatically after a certain time period, check the corresponding box and specify the time.</p></li><li class="list__item" id="6f0df364"><p><a href="working-with-build-results.html">Select the build</a> to debug.</p></li><li class="list__item" id="0102d2e5"><p>Open the <a href="triggering-a-custom-build.html#Run-Custom-Build-dialog">Custom Run</a> dialog and specify the following options:a. In the <b id="d4283aee">Agent</b> drop-down, select the disabled agent.b. It is recommended to select the <b id="fe024a75">run as <a href="personal-build.html">Personal Build</a></b> option to avoid intersection with regular builds.</p></li><li class="list__item" id="6608db3b"><p>When debugging is complete, enable the agent manually if automatic re-enabling has not been configured.</p></li></ol><p id="2cabd86d">You can also perform <a href="remote-debug.html">remote debugging</a> of tests on an agent via the <a href="intellij-platform-plugin.html">IntelliJ IDEA plugin</a> for TeamCity.</p></div><a name="DebugaPartoftheBuild(abuildstep)"></a><a name="Debug-a-Part-of-the-Build-(a-build-step)"></a><div class="chapter"><h2 id="HowTo...-DebugaPartoftheBuild(abuildstep)">Debug a Part of the Build (a build step)</h2><p id="0db69db6">If a build containing several steps fails at a certain step, it is possible to debug the step that breaks. Do the following:</p><ol class="list _decimal"><li class="list__item" id="4623e51b"><p>Go to the build configuration and disable the build steps up to the one you want to debug.</p></li><li class="list__item" id="00645c7e"><p><a href="working-with-build-results.html">Select the build</a> to debug.</p></li><li class="list__item" id="09f08ff2"><p>Open the <a href="triggering-a-custom-build.html#Run-Custom-Build-dialog">Custom Run</a> dialog and select the <b id="77945d6f">put the build to the <a href="build-queue.html">queue top</a></b> to give you build the priority.</p></li><li class="list__item" id="581e13bc"><p>When debugging is complete, re-enable the build steps.</p></li></ol></div><a name="Vulnerabilities"></a><a name="Vulnerabilities"></a><div class="chapter"><h2 id="HowTo...-Vulnerabilities">Vulnerabilities</h2><p id="4386a822">This section describes effect and necessary protection steps related to the announced security vulnerabilities.</p><a name="Heartbleed,ShellShock"></a><a name="Heartbleed,-ShellShock"></a><div class="chapter"><h3 id="HowTo...-Heartbleed,ShellShock">Heartbleed, ShellShock</h3><p id="f75cf792">TeamCity distributions provided by JetBrains do not contain software/libraries and do not use technologies affected by Heart bleed and Shell shock vulnerabilities. What might still need assessment is the specific TeamCity installation implementation which might use the components behind those provided/recommended by JetBrains and which can be vulnerable to the mentioned exploits.</p></div><a name="POODLE"></a><a name="POODLE"></a><div class="chapter"><h3 id="HowTo...-POODLE">POODLE</h3><p id="fbf44544">If you configured HTTPS access to the TeamCity server, inspect the solution used for HTTPS as that might be affected (e.g. Tomcat seems to be <a href="http://wiki.apache.org/tomcat/Security/POODLE" data-external="true" target="_blank" rel="noopener noreferrer">affected</a>). At this time none of TeamCity distributions include HTTPS access by default and investigating/eliminating HTTPS-related vulnerability is out of scope of TeamCity.</p><p id="7ea04d08">Depending on the settings used, TeamCity server (and agent) can establish HTTPS connections to other servers (e.g. Subversion). Depending on the server settings, those connections might fall back to using SSL 3.0 protocol. The recommended solution is not TeamCity specific and it is to disable SSLv3 on the target SSL-server side.</p></div><a name="GHOST"></a><a name="GHOST"></a><div class="chapter"><h3 id="HowTo...-GHOST">GHOST</h3><p id="ccf9946b">CVE-2015-0235 vulnerability is found in glibc library which is not directly used by TeamCity code. It is used by the Java/JRE used by TeamCity under *nix platforms. As Java is not bundled with TeamCity distributions, you should apply the security measures recommended by the vendor of the Java you use. At this time there are no related Java-specific security advisories released, so updating the OS should be enough to eliminate the risk of the vulnerability exploitation.</p></div><a name="FREAK"></a><a name="FREAK"></a><div class="chapter"><h3 id="HowTo...-FREAK">FREAK</h3><p id="adb2c577">CVE-2015-0204 vulnerability is found in the OpenSSL implementation. TeamCity does not bundle any parts of OpenSSL product and so is not vulnerable. You might still need to review the environment in which the TeamCity server and agents are set up, as well as the tools installed in addition to TeamCity for possible vulnerability mitigation steps.</p></div><a name="ApacheStruts"></a><a name="Apache-Struts"></a><div class="chapter"><h3 id="HowTo...-ApacheStruts">Apache Struts</h3><p id="cef8d55b">CVE-2017-5638 affects Jakarta Multipart parser in Apache Struts. CVE-2016-1181 also affects multipart requests processing in some older versions of Apache Struts.</p><p id="eb60d18c">TeamCity bundles IntelliJ IDEA which contains jars from both: Apache Struts 1.x and Apache Struts 2.x. These jars are only used by IntelliJ IDEA Struts plugin when IntelliJ IDEA collects inspections for a project on a TeamCity agent.</p><p id="e883a279">Under no circumstances these versions of Apache Struts are used to handle any HTTP requests. Thus neither TeamCity server, not TeamCity agent are affected by these vulnerabilities.</p></div></div><a name="WatchSeveralTeamCityServerswithWindowsTrayNotifier"></a><a name="Watch-Several-TeamCity-Servers-with-Windows-Tray-Notifier"></a><div class="chapter"><h2 id="HowTo...-WatchSeveralTeamCityServerswithWindowsTrayNotifier">Watch Several TeamCity Servers with Windows Tray Notifier</h2><p id="db931688">TeamCity Tray Notifier is used normally to watch builds and receive notifications from a single TeamCity server. However, if you have more than one TeamCity server and want to monitor them with Windows Tray Notifier simultaneously, you need to start a separate instance of Tray Notifier for each of the servers from the command line with the <code class="code">/allowMultiple</code> option:</p><ul class="list _ul"><li class="list__item" id="fde30dea"><p>From the TeamCity Tray Notifier installation folder (by default, it's <code class="code">C:\Program Files\JetBrains\TeamCity</code>) run the following command:</p></li></ul><div class="code-block" data-lang="bash">
JetBrains.TrayNotifier.exe /allowMultiple

</div><p id="0dfef7fd">Optionally, for each of the Tray Notifier instances you can explicitly specify the URL of the server to connect using the <code class="code">/server</code> option. Otherwise, for each further tray notifier instance you will need to log out and change the server's URL via the UI.</p><div class="code-block" data-lang="bash">
JetBrains.TrayNotifier.exe /allowMultiple /server:http://myTeamCityServer

</div><p id="f95f0ed8">See also <a href="http://jetbrains.net/tracker/issue/TW-4230#comment=27-14194" data-external="true" target="_blank" rel="noopener noreferrer">details</a> in the issue tracker.</p></div><a name="PersonalUserDataProcessing"></a><a name="Personal-User-Data-Processing"></a><div class="chapter"><h2 id="HowTo...-PersonalUserDataProcessing">Personal User Data Processing</h2><p id="4035925c">In relation to the TeamCity product, JetBrains does not collect any personal data of the on-premises TeamCity installation users. The related documents governing relationship of customers with JetBrains are available on the official web site: <a href="https://www.jetbrains.com/company/privacy.html" data-external="true" target="_blank" rel="noopener noreferrer">privacy policy</a>, <a href="https://www.jetbrains.com/store/terms/" data-external="true" target="_blank" rel="noopener noreferrer">terms of purchase</a>, <a href="https://www.jetbrains.com/teamcity/buy/license.html" data-external="true" target="_blank" rel="noopener noreferrer">TeamCity license agreement</a>.</p><p id="b56a15af">The notes below can be useful when assessing how your usage of TeamCity complies with the General Data Protection Regulation (GDPR) (EU) 2016/679 regulation. These notes are meant to address the most basic questions and can serve as an input to the assessment of your specific TeamCity installation.</p><p id="3c3498f3">The notes are based on TeamCity 2017.2.4 which is actual at the moment of GDPR enforcement date. Please update your TeamCity instance at least to the version as previous versions might contain issues not in line with the notes below.</p><a name="TeamCityandUsersPersonalData"></a><a name="TeamCity-and-Users--Personal-Data"></a><div class="chapter"><h3 id="HowTo...-TeamCityandUsersPersonalData">TeamCity and Users' Personal Data</h3><p id="7a46343d">The most important user-related data stored by TeamCity is:</p><ul class="list _ul"><li class="list__item" id="32dc18cd"><p>full name and username - stored in the database and shown on the user's profile and whenever the user is referenced. When a user triggers a build, these are also stored in the build's parameters and passed into the build</p></li><li class="list__item" id="131490bc"><p>user's email - stored in the database and shown on the user's profile, used to send out notifications</p></li><li class="list__item" id="83561909"><p>IP address of the clients accessing the server - can appear in the <a href="teamcity-server-logs.html">internal logs</a></p></li></ul><p id="32cc648f">TeamCity internal logs can also record some unstructured user-related information (e.g. submitted by the user or sent by the browser with the HTTP requests, retrieved according to the configured settings from the users source like LDAP)</p></div><a name="DeletingtheUserData"></a><a name="Deleting-the-User-Data"></a><div class="chapter"><h3 id="HowTo...-DeletingtheUserData">Deleting the User Data</h3><p id="3eb654c8">When you want to delete personal data of a specific user, the best way to do it is to delete the user in TeamCity. This way all the references to the user will continue to store the numeric user id, while all the other user information will not be stored anymore. Note that <a href="tracking-user-actions.html">Audit</a> records will mention internal numeric user id after the user deletion.</p><p id="d8e45603">If the user triggered any builds (i.e. had the "Run build" permission in any of the projects which are still present on the server), the user's username and full name were be recorded in the build's "teamcity.build.triggeredBy" parameters as text values as those were part of the build's "environment". If you need to remove those, you can either delete the related builds (and all the builds which artifact- or snapshot-depend on them), or delete parameters of those affected builds (the parameters are stored in archived files under &lt;TeamCity Data Directory&gt;\system\artifacts***.teamcity\properties directories).</p><p id="ec1a8af3">After the user deletion and other data cleaning, make sure to <a href="search.html#Resetting-Search-Index">reset search index</a> to prune possibly cached data of the deleted user from the search index.</p><p id="9fff85b9">There are several other places which can hold user-related data</p><p id="f2269025">If user had "Edit project" permission, the full name / username can appear in:</p><ul class="list _ul"><li class="list__item" id="e8acd36f"><p>some audit entries (saved with TeamCity versions before 2017.2.1) - <a href="https://youtrack.jetbrains.com/issue/TW-52215" data-external="true" target="_blank" rel="noopener noreferrer">TW-52215</a></p></li><li class="list__item" id="045c9fc2"><p>some build logs in "Wait for pending persist tasks to complete" build log line (saved with TeamCity versions before 2017.2.1) - <a href="https://youtrack.jetbrains.com/issue/TW-52872" data-external="true" target="_blank" rel="noopener noreferrer">TW-52872</a></p></li><li class="list__item" id="5c4ba4b7"><p>commit comments in the repository storing versioned settings store name of the user doing the change in UI</p></li></ul><p id="a79148a7">VCS usernames in VCS-related data :</p><ul class="list _ul"><li class="list__item" id="cf8d6302"><p>in VCS changes visible in UI or stored in the database</p></li><li class="list__item" id="6cda1f38"><p>in the local .git repository clones on the server and agents</p></li></ul><p id="5183a3c2">Username can also appear in access credentials configured in different integrations like VCS roots, issue tracker, database access, etc. (these are stored in the settings files and audit diff files in the TeamCity Data Directory and VCS roots usernames are also stored in the database for the current and previous versions of the VCS roots)</p><p id="6b39887f">To ensure user's details are not stored by TeamCity you might want to to check the TeamCity-backing storage that no occurrences of the data are stored: the database, Data Directory and the TeamCity home directory (logs, and memory dumps which are regularly placed under the "bin" directory).</p></div><a name="UserAgreement"></a><a name="User-Agreement"></a><div class="chapter"><h3 id="HowTo...-UserAgreement">User Agreement</h3><p id="2aa0d012">If you want the users to accept a special agreement before using your TeamCity instance, you can install a <a href="https://plugins.jetbrains.com/plugin/10722-terms-of-service" data-external="true" target="_blank" rel="noopener noreferrer">dedicated plugin</a> developed by JetBrains for this purpose. Refer to the plugin's documentation for more details.</p></div><a name="Encryption"></a><a name="Encryption"></a><div class="chapter"><h3 id="HowTo...-Encryption">Encryption</h3><p id="c42efaa4">If you want to encrypt the data used by TeamCity, it is recommended to use generic, non-TeamCity-specific tools for this as TeamCity does not provide dedicated functionality. TeamCity stores the data in the SQL database and on the file system. You can configure the database to store the data in encrypted form and use secure JDBC-backed connection to the database (configured in the <a href="setting-up-an-external-database.html"><code class="code">database.properties</code></a>).<br>Also, you can configure encryption on the disk storage on the OS level.</p></div><a name="LogsandDebuggingData"></a><a name="Logs-and-Debugging-Data"></a><div class="chapter"><h3 id="HowTo...-LogsandDebuggingData">Logs and Debugging Data</h3><p id="d1431cb9">If you want to ensure that you do not store the internal TeamCity logs for more than a limited amount of days, you can configure <a href="teamcity-server-logs.html">internal logging</a> to rotate the log files each day and limit the number of files to keep. TeamCity agents generally do not operate with any user-related data in a structural way, but if you need to ensure the logs are regularly rotated on the agent, you will need to configure <a href="viewing-build-agent-logs.html">agent logging</a> the same way.</p><p id="cf11cbbd">Per-day rotation can be configured by adding <code class="code">&lt;param name="rotateOnDayChange" value="true"/&gt;</code> line within all required <code class="code">&lt;appender name="..." class="jetbrains.buildServer.util.TCRollingFileAppender"&gt;</code> appenders. This change should be done to the default <code class="code">conf\teamcity-server-log4j.xml</code> and also logging presets stored under <code class="code">&lt;TeamCity Data Directory&gt;\config\_logging</code>.</p><p id="d4d10eb2">TeamCity can also store diagnostics data like thread dumps which can record user-related data in unstructured way. It is recommended to review the content of the <code class="code">&lt;</code><a href="teamcity-home-directory.html"><code class="code">TeamCity Home</code></a><code class="code">&gt;\logs</code> directory regularly and ensure that no old files are preserved in there. Also, the extra logs should be deleted after logging customization sessions like collecting debug logs, etc. There is a <a href="https://youtrack.jetbrains.com/issue/TW-22596" data-external="true" target="_blank" rel="noopener noreferrer">known issue</a> that <code class="code">logs\catalina.out</code> file if not rotated automatically at all. It is recommended to establish an automatic procedure to rotate the file regularly.</p></div><a name="Customizations"></a><a name="Customizations"></a><div class="chapter"><h3 id="HowTo...-Customizations">Customizations</h3><p id="d300b235">These notes only address bundled TeamCity functionality with the most common documented settings. You should assess your specific TeamCity installation considering customizations like the configured build scripts, installed plugins, external systems communicating with TeamCity via API, etc.</p></div></div><a name="TeamCityReleaseCycle"></a><a name="TeamCity-Release-Cycle"></a><div class="chapter"><h2 id="HowTo...-TeamCityReleaseCycle">TeamCity Release Cycle</h2><p id="a813e604">The information below can be used for reference purposes only.</p><p id="8ad65b47">"major" release below means any release with a change in first or second version number (e.g. X in X.X.Z)"bugfix" release means releases with a change in the third version number (e.g. Z in X.X.Z)</p><p id="ef38688b">Release stages that we generally have are:</p><ul class="list _ul"><li class="list__item" id="6c501608"><p><b id="9369a5e2">Available under EAP (Early Access Program)</b> - usually available only for major releases, starts several months after previous major release and usually months before the next major release. Typically new EAP releases are <a href="https://confluence.jetbrains.com/display/TW/TeamCity+EAP" data-external="true" target="_blank" rel="noopener noreferrer">published</a> on monthly or bi-monthly basis.</p></li><li class="list__item" id="b4a3943c"><p><b id="920d718e">General Availability</b> - as a rule, there is a major release each 8 months. There are multiple bugfix releases following the major release. Bugfix releases and support patches for critical issues (if applicable) are provided until "End of Sale" of the release.</p></li><li class="list__item" id="eb6d8906"><p><b id="9d3c7012">End of Sale</b> - occurs with the release of a new major version. After this time no bugfix updates or patches are usually provided (Exceptions are critical issues without a workaround which at the same time allow for relatively simple fix and inability for the customer to upgrade for an important reason). Only limited support is provided for these versions.</p></li><li class="list__item" id="53480ade"><p><b id="a8db474a">End of Support</b> - occurs with the release of two newer major versions. At this point we stop providing regular technical support for the release.</p></li></ul><p id="8cb9baa6">The dates of previous releases and the sequence of TeamCity versions are listed on the <a href="https://confluence.jetbrains.com/display/TW/Previous+Releases+Downloads" data-external="true" target="_blank" rel="noopener noreferrer">Previous Releases Downloads</a> page.</p><hr id="e3fa1963"><p id="52dc9dde"><br></p><p id="d0abac6c"><br></p><p id="3229a49c"><br></p><p id="762857bb"><br></p><p id="10a0e998"><br></p><p id="82fb0faf"><br></p><p id="a5c184a3"><br></p><p id="281f985c"><br></p><p id="1ac52840"><br></p><p id="9feef9f4"><br></p></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>