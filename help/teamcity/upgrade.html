<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>升级-帮助|团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Upgrade" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/upgrade.md|Upgrade" data-main-title="Upgrade" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/upgrade.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="upgrade.md" data-toc="Upgrade">升级</h1><aside class="warning " rel="upgrade.md" id="45ec5681" data-title=""><p id="0ee3bcb0">除非特别说明，否则TeamCity不支持主要版本/次要版本之间的降级（版本的前两个数字有所更改）。强烈建议<a href="teamcity-data-backup.html">您</a>在升级之前<a href="teamcity-data-backup.html">备份数据</a> 。</p></aside><p id="872bad60">TeamCity支持从任何先前版本升级到更高版本。除非在<a href="upgrade-notes.html">升级说明中</a>指出，否则所有设置和数据都将保留。</p><p id="d3e265d1">建议至少在发布多个错误修正更新之后，计划进行常规升级以运行最新的TeamCity版本。这样，您可以运行具有最新修复程序和安全补丁程序的完全<a href="how-to.html#TeamCity-Release-Cycle">受支持的版本</a> 。</p><p id="4d1cf93c">在此页：</p><p id="2e026ac7"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#Upgrade-BeforeUpgrade">升级前</a><ul class="list _bullet"><li class="list__item"><a href="#Upgrade-Licensing">发牌</a></li></ul></li><li class="list__item"><a href="#Upgrade-UpgradingTeamCityServer">升级TeamCity服务器</a><ul class="list _bullet"><li class="list__item"><a href="#Upgrade-AutomaticUpdate">自动更新</a></li><li class="list__item"><a href="#Upgrade-ManualUpgrade">手动升级</a><ul class="list _bullet"><li class="list__item"><a href="#Upgrade-UsingWindowsInstaller">使用Windows Installer</a></li><li class="list__item"><a href="#Upgrade-ManualUpgradingusing.tar.gzor.warDistributions">使用.tar.gz或.war发行版进行手动升级</a></li><li class="list__item"><a href="#Upgrade-UpgradingTeamCitystartedfromDockerimages">从Docker映像开始升级TeamCity</a></li><li class="list__item"><a href="#Upgrade-UpgradingTeamCitystartedfromAWSCloudFormationtemplate">从AWS CloudFormation模板开始升级TeamCity</a></li></ul></li></ul></li><li class="list__item"><a href="#Upgrade-IDEPlugins">IDE插件</a></li><li class="list__item"><a href="#Upgrade-UpgradingBuildAgents">升级构建代理</a><ul class="list _bullet"><li class="list__item"><a href="#Upgrade-AutomaticBuildAgentUpgrading">自动构建代理升级</a></li><li class="list__item"><a href="#Upgrade-UpgradingBuildAgentsManually">手动升级构建代理</a><ul class="list _bullet"><li class="list__item"><a href="#Upgrade-UpgradingtheBuildAgentWindowsServiceWrapper">升级Build Agent Windows服务包装器</a></li><li class="list__item"><a href="#Upgrade-UpgradingfromTeamCityversion1.x">从TeamCity版本1.x升级</a></li><li class="list__item"><a href="#Upgrade-UpgradingfromTeamCityversion2.x">从TeamCity版本2.x升级</a></li></ul></li></ul></li></ul><p></p><a name="BeforeUpgrade"></a><a name="Before-Upgrade"></a><div class="chapter"><h2 id="Upgrade-BeforeUpgrade">升级前</h2><p id="2f1e0f9b">升级TeamCity之前：</p><ol class="list _decimal"><li class="list__item" id="a926e4ec"><p>对于主要升级，请查看<a href="what-s-new-in-teamcity-2019-1.html">“新增功能”中的内容</a> （如果不从先前的主要版本进行升级，请遵循“ <a href="what-s-new-in-teamcity-2019-1.html">新增功能</a> ”底部的链接）。</p></li><li class="list__item" id="60ef083d"><p>除非在同一主要版本的错误修正版本中升级，否则请<a href="#Licensing">检查许可证密钥</a> <code class="code">X.X</code>版。</p></li><li class="list__item" id="df986617"><p><a href="http://www.jetbrains.com/teamcity/download/" rel="noopener noreferrer" data-external="true" target="_blank">下载</a>新的TeamCity版本（ <a href="https://confluence.jetbrains.com/display/TW/Previous+Releases+Downloads" rel="noopener noreferrer" data-external="true" target="_blank">扩展下载选项</a> ）。</p></li><li class="list__item" id="611b4dc8"><p>仔细查看<b id="40767477"><a href="upgrade-notes.html">升级说明</a></b> 。</p></li><li class="list__item" id="01943b16"><p>考虑在<a href="how-to.html#Test-drive-Newer-TeamCity-Version-before-Upgrade">测试服务器</a>上探测升级</p></li><li class="list__item" id="76c1efca"><p>如果您安装了非捆绑式插件，请检查插件页面与新版本的兼容性，并在必要时升级/卸载插件</p></li></ol><p id="88d4236c">要升级服务器：</p><ol class="list _decimal"><li class="list__item" id="067b0f5e"><p><a href="teamcity-data-backup.html">备份当前的TeamCity数据，</a>包括设置，数据库和补充数据。万一升级失败，您将需要备份来回滚到以前的版本。</p></li><li class="list__item" id="69aae645"><a href="#Upgrading-TeamCity-Server">执行升级步骤</a> ：<ul class="list _ul"><li class="list__item" id="cd0a49b4"><a href="#Using-Windows-Installer">使用Windows Installer升级</a></li><li class="list__item" id="9f5e2486"><a href="#Manual-Upgrading-using-.tar.gz-or-.war-Distributions">在Linux和WAR发行版上的手动升级</a></li></ul></li></ol><p id="6e144a41">如果您打算升级生产TeamCity的安装，建议在升级主<a href="how-to.html#Test-drive-Newer-TeamCity-Version-before-Upgrade">测试服务器</a>之前先安装<a href="how-to.html#Test-drive-Newer-TeamCity-Version-before-Upgrade">测试服务器</a>并在您的环境中检查其功能。</p><a name="Licensing"></a><a name="Licensing"></a><div class="chapter"><h3 id="Upgrade-Licensing">发牌</h3><p id="2e57e483">升级之前，请确保许可证的维护期限尚未结束（使用<b id="e7d8b905">管理|许可证</b> TeamCity服务器Web UI页面列出许可证密钥）。许可证仅对TeamCity版本有效，且有效期在维护期内。在<a href="https://confluence.jetbrains.com/display/TW/Previous+Releases+Downloads" rel="noopener noreferrer" data-external="true" target="_blank">发布列表中</a>检查有效发布日期。<br>通常，所有的错误修正更新（以<code class="code">Z</code>的一部分<code class="code">X.Y.Z</code> TeamCity版本）使用相同的有效发布日期（主要/次要发布日期）。<br>如果并非所有许可证都涵盖目标版本的发布日期，请考虑在升级之前<a href="/teamcity/buy/#license-type=renewal" rel="noopener noreferrer" data-external="true" target="_blank">续订许可证</a> （您甚至可以在升级之前用更新的许可证密钥替换旧的许可证密钥）。</p><p id="6fadd1f2">如果您仅评估较新的版本，则可以在<a href="http://www.jetbrains.com/teamcity/download/" rel="noopener noreferrer" data-external="true" target="_blank">下载页面</a>上获得评估许可证。请注意，每个TeamCity版本只能评估一次。要延长评估期限，请<a href="http://www.jetbrains.com/company/contacts/#contactSales" rel="noopener noreferrer" data-external="true" target="_blank">联系</a> JetBrains销售部门。</p><p id="76b05155">从TeamCity 4.x或更早版本升级时，请注意，TeamCity 5.0和更高版本中的许可策略与以前的TeamCity版本不同。查看官方网站上的“ <a href="licensing-policy.html">许可政策”</a>页面和“ <a href="http://www.jetbrains.com/teamcity/buy#upgradeuser" rel="noopener noreferrer" data-external="true" target="_blank">许可和升级”</a>部分。</p></div></div><a name="UpgradingTeamCityServer"></a><a name="Upgrading-TeamCity-Server"></a><div class="chapter"><h2 id="Upgrade-UpgradingTeamCityServer">升级TeamCity服务器</h2><p id="8e5d5d88">TeamCity支持从任何先前版本升级到当前版本。<br>除非特别说明，否则更改后将无法通过保留数据来降级<code class="code">major.minor</code>版本，并且可以在错误修正版本中使用（无需更改<code class="code">major.minor</code>版）。</p><p id="229d6fa0">一般政策是，错误修正会更新（由<code class="code">Z</code>的一部分<code class="code">X.Y.Z</code> TeamCity版本）不会更改数据格式，因此您可以在错误修正版本内自由升级/降级。但是，升级到下一个主要或次要版本时（已更改<code class="code">X</code>要么<code class="code">Y</code>在<code class="code">X.Y.Z</code> TeamCity版本），您将无法使用数据保存降级：您将需要<a href="restoring-teamcity-data-from-backup.html">还原</a>相应版本<a href="restoring-teamcity-data-from-backup.html">的备份</a> 。</p><p id="7b5b7f03">升级时，所有TeamCity配置设置和其他数据都会保留，除非在<a href="upgrade-notes.html">升级说明中</a>另有<a href="upgrade-notes.html">说明</a> 。如果您已自定义TeamCity安装（例如更改Tomcat服务器设置），则在升级后需要重复自定义。</p><p id="2f970585">升级的一般方法是删除TeamCity服务器主目录中先前安装的所有文件，并将新文件放置在同一位置。确保完整保留<a href="teamcity-data-directory.html">TeamCity数据目录</a>和数据库（事先进行备份），备份和还原以前的自定义设置（例如，在<code class="code">...\conf\server.xml</code> ， <code class="code">...\conf\web.xml</code>文件）也是必要的。日志目录（ <code class="code">...\logs</code> ）可以保留旧的安装文件。</p><p id="d3ef53d1">连接到服务器的代理会<a href="#Automatic-Build-Agent-Upgrading">自动</a>升级。</p><aside class="note " rel="d3ef53d1" id="5a0d05a6" data-title=""><p id="4a2552bc"><b id="64531a81">有关TeamCity数据结构升级的重要说明</b></p><p id="a0954cf5">TeamCity服务器将其数据存储在数据库中以及文件系统上的<a href="teamcity-data-directory.html">TeamCity数据目录中</a> 。不同的TeamCity版本使用数据库和数据目录的不同数据结构。启动新版本的TeamCity后，数据将以旧格式保存，直到您在Web UI的“维护”页面上确认升级和数据转换为止。在执行此操作之前，您可以备份旧数据。但是，升级完成后，数据将转换为新格式。<b id="09f64fa6">数据转换后，无法降级为使用其他数据格式的TeamCity以前的版本！</b><br>数据格式升级存在几个重要问题：</p><ul class="list _ul"><li class="list__item" id="ee895aa8"><p>无法进行数据结构降级。一旦新的TeamCity版本更改了数据库和数据目录的数据格式，就不能使用此数据运行旧的TeamCity版本。在升级TeamCity之前，请确保已<a href="teamcity-data-backup.html">备份</a>数据。</p></li><li class="list__item" id="392b6512"><p>数据库和数据目录都应同时升级。确保在较新服务器的首次启动期间，它使用正确的<a href="teamcity-data-directory.html">TeamCity数据目录</a> ，而该<a href="teamcity-data-directory.html">目录</a>又在< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > \ config \ database.properties文件中<a href="setting-up-an-external-database.html">配置</a>了正确的数据库。还要确保数据目录完整（例如，所有构建日志和工件都已放置），没有数据目录内容支持从较旧服务器版本的数据目录中复制。</p></li></ul></aside><p id="8dbc8f31">如果您不小心执行了不一致的升级，请查看<a href="how-to.html#Recover-from-" data-format-of-the-data-directory-(nnn)-and-the-database-(mmm)-do-not-matc="-error" ="">恢复说明</a> 。</p><a name="AutomaticUpdate"></a><a name="Automatic-Update"></a><div class="chapter"><h3 id="Upgrade-AutomaticUpdate">自动更新</h3><p id="9bef38f4">自TeamCity 2017.2起提供自动更新选项。为此，TeamCity服务器应该能够联系<a href="/" rel="noopener noreferrer" data-external="true" target="_blank">https://www.jetbrains.com</a>网站。<br>当检测到新版本的TeamCity时，服务器将为系统管理员显示相应的健康项。该项目指向服务器的<b id="e94c5487">管理|更新</b>页面，其中列出了可用于更新的所有版本。该页面包含有关许可证兼容性，新版本描述的注释，以及如果要使用自动升级而不是执行手动更新过程的控件，请执行自动升级。</p><p id="0d73154b">自动更新过程如下：</p><ol class="list _decimal"><li class="list__item" id="f9a59c8c"><p>TeamCity服务器已停止。</p></li><li class="list__item" id="4a928777">运行更新脚本以执行以下操作：<ol class="list _decimal"><li class="list__item" id="f467185b"><p>在< <a href="teamcity-home-directory.html">TeamCity主目录</a> > <a href="teamcity-home-directory.html">/。old目录中</a>创建当前安装的备份。</p></li><li class="list__item" id="d4fedc9e"><p>将已停止的服务器更新为新版本。</p></li></ol></li><li class="list__item" id="609be046"><p>接下来，更新的服务器启动。<br>更新进度将记录到< <a href="teamcity-home-directory.html">TeamCity主目录</a> > /logs/teamcity-update.log文件中。</p></li></ol><aside class="note " rel="cc8bf19e" id="4623658b" data-title=""><p id="6d3b54d5">如果自动更新失败，请执行以下操作将TeamCity还原到更新之前的状态：</p><ol class="list _decimal"><li class="list__item" id="9178e3c3"><p>如果您的TeamCity服务器正在运行，请停止它。</p></li><li class="list__item" id="7ae67391"><p>在您的<a href="teamcity-home-directory.html">TeamCity主目录</a>目录中，删除与< <a href="teamcity-home-directory.html">TeamCity主目录</a> > <a href="teamcity-home-directory.html">/。old目录中</a>相同名称的文件夹。</p></li><li class="list__item" id="3e89b8eb"><p>将< <a href="teamcity-home-directory.html">TeamCity主目录</a> > <a href="teamcity-home-directory.html">/。old目录</a>的内容复制到该<teamcity server="" home="">目录中。</teamcity></p></li><li class="list__item" id="328d9946"><p>启动TeamCity服务器。</p></li></ol></aside><p id="241a8fbf">当前的自动更新限制：</p><ul class="list _ul"><li class="list__item" id="c90d4cb6"><p>自动更新不支持某些自定义项，例如具有<a href="installing-and-configuring-the-teamcity-server.html#Changing-Server-Context">更改的服务器上下文的</a>安装</p></li><li class="list__item" id="fc5ec498"><p>如果从服务器上部署服务器，则只能进行手动升级。 <a href="#Manual-Upgrading-using-.tar.gz-or-.war-Distributions"><code class="code">.war distribution</code></a> ，或在正式的<a href="#Upgrading-TeamCity-started-from-Docker-images">TeamCity Docker容器</a>下运行，以<a href="running-teamcity-stack-in-aws.html">AWS CloudFormation模板</a>或Azure Resource Manager模板开始。</p></li><li class="list__item" id="915326f6"><p>Windows卸载程序在升级过程中不会更新，因此在进行几次更新后，旧的TeamCity版本仍会在Windows列表中注明。在卸载期间，可能不会删除所有TeamCity安装文件。</p></li><li class="list__item" id="8f2b2529"><p>捆绑的Java未更新</p></li><li class="list__item" id="e4e42c99"><p>如果安装了多个节点，则只能自动更新TeamCity主服务器，“运行构建”节点需要手动更新。</p></li></ul></div><a name="ManualUpgrade"></a><a name="Manual-Upgrade"></a><div class="chapter"><h3 id="Upgrade-ManualUpgrade">手动升级</h3><p id="954fcb3f"><a name="winUpgrading"></a><a name="Upgrade-winUpgrading"></a></p><a name="UsingWindowsInstaller"></a><a name="Using-Windows-Installer"></a><div class="chapter"><h4 id="Upgrade-UsingWindowsInstaller">使用Windows Installer</h4><aside class="tip sideblock" rel="Upgrade-UsingWindowsInstaller" id="448bcccd" data-title=""><p id="076d79ea">自上次安装以来未对主服务器配置文件< <a href="teamcity-home-directory.html">TeamCity主目录</a> > /conf/server.xml进行自动更新。如果进行了修改，安装程序将检测到它们并备份旧的<code class="code">server.xml</code>文件，其中显示有关覆盖和备份文件位置的警告。其他档案<code class="code">conf</code>也可以忽略它们的默认内容，因此，如果您在其中进行了手动修改，请在升级后进行检查。</p></aside><ol class="list _decimal"><li class="list__item" id="0acf9b89"><p><a href="teamcity-data-backup.html">创建一个备份</a> 。从TeamCity 6.0+升级时，您还将有机会在更新后的TeamCity开始的<a href="teamcity-maintenance-mode.html">TeamCity维护模式</a>页面上，使用“基本”配置文件创建备份。</p></li><li class="list__item" id="4dae1739"><p>请注意用于运行TeamCity服务器的用户名。在新版本安装期间将需要它。</p></li><li class="list__item" id="11ac9716"><p>如果您已自定义任何Windows服务设置，请存储它们以在以后重复自定义。</p></li><li class="list__item" id="ed08f879"><p>请注意，如果您使用64位Java来运行服务（例如，在服务器的“管理” |“诊断”或线程转储中的“ Java VM信息”中检查“ 64”），请考虑备份< <a href="teamcity-home-directory.html">TeamCity主目录</a> > \ jre目录。</p></li><li class="list__item" id="ebbb5c26"><p>（可选，因为升级不会覆盖这些内容。）如果您对捆绑的Tomcat服务器（如端口，https协议等），JRE等进行了任何自定义，请备份这些内容，以便以后重复自定义。</p></li><li class="list__item" id="65b4e4dd"><p>请注意，如果您已经安装了本地代理（尽管<a href="how-to.html#TeamCity-Security-Notes">不建议</a>安装本地代理），则可以在安装程序中选择相同的选项。</p></li><li class="list__item" id="cc36403f"><p>运行新的安装程序，然后将其指向安装TeamCity的相同位置（会自动记住用于安装的位置）。确认卸载先前的安装。TeamCity卸载程序可确保正确卸载，但您可能需要确保在卸载完成后， <a href="teamcity-home-directory.html">TeamCity服务器安装目录</a>中不包含任何非自定义文件。如果有，请在继续安装之前备份/删除它们。</p></li><li class="list__item" id="46b9e803"><p>如果出现提示，请指定先前安装使用的< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > /。</p></li><li class="list__item" id="075452f9"><p>（可选，因为升级不会覆盖这些内容。）确保已<a href="setting-up-an-external-database.html#General-Steps">安装</a>外部数据库驱动<a href="setting-up-an-external-database.html#General-Steps">程序</a> （仅在使用外部数据库时才适用）。</p></li><li class="list__item" id="7cb08136"><p>检查并还原所需的Windows服务和Tomcat配置的所有自定义项。从7.1及更早版本升级时，请确保将<a href="configuring-teamcity-server-startup-properties.html">服务器内存设置</a>传输到<a href="configuring-teamcity-server-startup-properties.html#Standard-TeamCity-Startup-Scripts">环境变量</a> 。</p></li><li class="list__item" id="6e7edfac"><p>如果使用64位Java运行服务器，请还原先前备份的< <a href="teamcity-home-directory.html">TeamCity主目录</a> > / \ jre目录，或重复执行64位Java <a href="installing-and-configuring-the-teamcity-server.html#Java-Installation">安装步骤</a> 。</p></li><li class="list__item" id="4eebaa92"><p>如果您在<code class="code">conf\teamcity-server-log4j.xml</code>文件并希望保留它（但是请注意，实际上不建议自定义文件，而应使用<a href="teamcity-server-logs.html#Logging-related-Diagnostics-UI">日志记录预设</a> ），比较并合并<code class="code">conf\teamcity-server-log4j.xml.backup</code>由安装程序从现有副本创建，并使用默认名称保存默认文件。比较<code class="code">conf\teamcity-*-log4j.xml.dist</code>带有相应文件的文件<code class="code">conf\teamcity-*-log4j.xml</code>归档并确保<code class="code">.xml</code>文件包含所有<code class="code">.dist</code>文件默认值。建议复制<code class="code">.dist</code>归档到相应的<code class="code">.xml</code>文件，直到您确实需要更改的日志记录配置为止。</p></li><li class="list__item" id="240dfd1b"><p>启动TeamCity服务器（和代理，如果已与安装程序一起安装）。</p></li><li class="list__item" id="2dac5728"><p>查看<a href="teamcity-maintenance-mode.html">TeamCity维护模式</a>页面以确保没有遇到任何问题，然后单击相应的按钮确认升级。只有在此之后，所有数据才会转换为较新的格式。</p></li></ol><p id="1f06622e">如果遇到无法解决的错误，请确保旧的TeamCity未运行/在启动时未启动，重新启动计算机，然后重复安装过程。</p></div><a name="ManualUpgradingusing.tar.gzor.warDistributions"></a><a name="Manual-Upgrading-using-.tar.gz-or-.war-Distributions"></a><div class="chapter"><h4 id="Upgrade-ManualUpgradingusing.tar.gzor.warDistributions">使用.tar.gz或.war发行版进行手动升级</h4><p id="30ba014f">注意，建议使用<code class="code">.tar.gz</code>要么<code class="code">.exe</code> TeamCity发行。使用<code class="code">.war</code>建议不要安装TeamCity。</p><ol class="list _decimal"><li class="list__item" id="4f47de9f"><p><a href="teamcity-data-backup.html">创建一个备份</a> 。</p></li><li class="list__item" id="f045b819"><p>自上次安装以来自定义的备份文件（很可能是<code class="code">[TOMCAT_HOME]/conf/server.xml</code> ）</p></li><li class="list__item" id="d4215c58"><p>删除旧的安装文件（整个<code class="code"><&gt;</code>要么<code class="code">[TOMCAT_HOME]/webapps/TeamCity/*</code>如果您是从<code class="code">war</code>文件）。建议事先备份目录。</p></li><li class="list__item" id="63c45bfd"><p>将新档案解压缩到先前安装TeamCity的位置。</p></li><li class="list__item" id="bef0d75b"><p>如果使用Tomcat服务器（您自己的服务器或捆绑在.tar.gz TeamCity发行版中的服务器），建议删除以下内容： <code class="code">work</code>目录。请注意，这可能会影响部署到同一Web服务器中的其他Web应用程序。</p></li><li class="list__item" id="5392754b"><p>恢复在上面的步骤2中备份的自定义设置。如果您有定制<code class="code">[TOMCAT_HOME]/conf/server.xml</code>文件，将您的更改应用到默认文件的相应部分。</p></li><li class="list__item" id="d9a5d6c3"><p>确保以前配置的<a href="configuring-teamcity-server-startup-properties.html">TeamCity服务器启动属性</a> （如果有）仍然是实际的。</p></li><li class="list__item" id="094ace01"><p>启动TeamCity服务器。</p></li><li class="list__item" id="7b3c35c6"><p>查看“ <a href="teamcity-maintenance-mode.html">TeamCity维护模式”</a>页面以确保没有遇到任何问题，然后单击相应的按钮确认升级。只有在此之后，TeamCity转换器才会更新所有配置数据和数据库方案。</p></li></ol></div><a name="UpgradingTeamCitystartedfromDockerimages"></a><a name="Upgrading-TeamCity-started-from-Docker-images"></a><div class="chapter"><h4 id="Upgrade-UpgradingTeamCitystartedfromDockerimages">从Docker映像开始升级TeamCity</h4><p id="58c94709">如果您未对容器进行任何更改，则可以停止运行中的容器，通过常规命令将<a href="https://hub.docker.com/r/jetbrains/teamcity-server/" rel="noopener noreferrer" data-external="true" target="_blank">官方</a>版本的<a href="https://hub.docker.com/r/jetbrains/teamcity-server/" rel="noopener noreferrer" data-external="true" target="_blank">TeamCity映像</a>及其服务器拉入新版本。如果更改了映像，则需要将更改复制到新的TeamCity服务器映像。</p></div><a name="UpgradingTeamCitystartedfromAWSCloudFormationtemplate"></a><a name="Upgrading-TeamCity-started-from-AWS-CloudFormation-template"></a><div class="chapter"><h4 id="Upgrade-UpgradingTeamCitystartedfromAWSCloudFormationtemplate">从AWS CloudFormation模板开始升级TeamCity</h4><p id="e7d74d8b">请参阅<a href="running-teamcity-stack-in-aws.html#Upgrading-TeamCity-in-AWS">专用页面</a> 。</p></div></div></div><a name="IDEPlugins"></a><a name="IDE-Plugins"></a><div class="chapter"><h2 id="Upgrade-IDEPlugins">IDE插件</h2><p id="e7454836">建议所有用户定期将其IDE插件更新为与所使用的TeamCity服务器版本兼容的最新版本。至少是用户配置文件上TeamCity服务器的“工具”部分提供的版本。<br>通常，IntelliJ IDEA TeamCity插件，Eclipse TeamCity插件和Visual Studio TeamCity插件的版本必须与TeamCity服务器版本相同。插件版本不匹配的用户会收到一条消息，提示您尝试使用版本不匹配的TeamCity服务器登录。<br>唯一的例外是TeamCity版本9.0-9.1.x，它使用兼容的协议，并且这些版本的任何插件都可以与这些版本的任何服务器一起使用。仍然建议将IDE插件更新为匹配的服务器版本。</p></div><a name="UpgradingBuildAgents"></a><a name="Upgrading-Build-Agents"></a><div class="chapter"><h2 id="Upgrade-UpgradingBuildAgents">升级构建代理</h2><ul class="list _ul"><li class="list__item" id="2ae8c4f7"><a href="#Automatic-Build-Agent-Upgrading">自动构建代理升级</a></li><li class="list__item" id="85c48649"><a href="#Upgrading-Build-Agents-Manually">手动升级构建代理</a><ul class="list _ul"><li class="list__item" id="ca2b51ff"><a href="#Upgrading-the-Build-Agent-Windows-Service-Wrapper">升级Build Agent Windows服务包装器</a></li></ul></li></ul><a name="AutomaticBuildAgentUpgrading"></a><a name="Automatic-Build-Agent-Upgrading"></a><div class="chapter"><h3 id="Upgrade-AutomaticBuildAgentUpgrading">自动构建代理升级</h3><p id="3e827c46">在启动TeamCity服务器（并更新服务器上的代理分发或插件）时，连接到服务器并<a href="setting-up-and-running-additional-build-agents.html#Necessary-OS-and-environment-permissions">正确安装的</a> TeamCity代理会自动更新为与服务器相对应的版本。服务器升级和降级都会发生这种情况。如果代理上有正在运行的构建，则构建完成。除非代理与服务器保持最新，否则不会在代理上启动新的构建。</p><p id="997e91b1"><b id="3afd962b">从TeamCity 2018.2</b>开始，在开始代理升级之前，将检查代理的可用磁盘空间，默认情况下为3 gb。要修改升级所需的值，请配置<code class="code">teamcity.agent.upgrade.ensure.free.space</code> <a href="build-agent-configuration.html">代理财产</a> 。</p><p id="2626e37b">代理更新过程如下：代理（ <code class="code">agent.bat</code> ， <code class="code">agent.sh</code> ，或代理服务）将从TeamCity服务器下载当前代理程序包。下载完成并且代理处于空闲状态时，它将启动升级过程（代理已停止，代理文件已更新，并且代理已重新启动）。此过程可能需要几分钟，具体取决于代理程序的硬件和网络带宽。<b id="945d99c6">不要中断升级过程</b> ，因为这样做可能会导致升级失败，您将需要手动重新安装代理。</p><p id="87214ff4">如果在TeamCity Web UI中看到一个代理被标识为“代理已断开连接（将升级）”，请不要关闭代理控制台或重新启动代理过程，而是要等待几分钟。</p><p id="40449ae7">在代理程序升级期间，可以打开和关闭各种控制台窗口。请耐心等待，在代理升级完成之前，请勿中断该过程。</p></div><a name="UpgradingBuildAgentsManually"></a><a name="Upgrading-Build-Agents-Manually"></a><div class="chapter"><h3 id="Upgrade-UpgradingBuildAgentsManually">手动升级构建代理</h3><p id="efda90f4">只要已正确<a href="setting-up-and-running-additional-build-agents.html">安装</a> ，所有连接的代理程序都会自动升级，因此无需手动升级。</p><p id="f2375fc7">如果需要手动升级代理，可以按照以下步骤操作：</p><p id="ec45c871">由于TeamCity代理不包含任何唯一信息，因此如果要升级到代理，最简单的方法是</p><ul class="list _ul"><li class="list__item" id="98bc138b"><p>备份<code class="code"><Agent Home>/conf/buildAgent.properties</code>文件。</p></li><li class="list__item" id="7a437bbc"><p>卸载/删除现有代理。</p></li><li class="list__item" id="4c167b52"><p>安装新的代理版本。</p></li><li class="list__item" id="a64d58f0"><p>恢复以前保存的<code class="code">buildAgent.properties</code>文件到同一位置。</p></li><li class="list__item" id="1dd914cf"><p>启动代理。</p></li></ul><p id="5f1058ca">如果您需要保留所有代理数据（例如，消除升级后的干净签出），则可以：</p><ul class="list _ul"><li class="list__item" id="9cbc2446"><p>停止代理。</p></li><li class="list__item" id="100a2c39"><p>删除代理.zip分发中存在的代理安装中的所有目录，除了<code class="code">conf</code> 。</p></li><li class="list__item" id="ae64b300"><p>打开包装<code class="code">.zip</code>分发到代理安装目录，跳过“ conf”目录。</p></li><li class="list__item" id="fa1ae90b"><p>启动代理。</p></li></ul><p id="ee082a45">在后一种情况下，如果你使用的服务在Windows下运行的代理，你可能还需要描述来升级Windows服务<a href="#Upgrading-from-TeamCity-version-2.x">下面</a> 。</p><a name="UpgradingtheBuildAgentWindowsServiceWrapper"></a><a name="Upgrading-the-Build-Agent-Windows-Service-Wrapper"></a><div class="chapter"><h4 id="Upgrade-UpgradingtheBuildAgentWindowsServiceWrapper">升级Build Agent Windows服务包装器</h4></div><a name="UpgradingfromTeamCityversion1.x"></a><a name="Upgrading-from-TeamCity-version-1.x"></a><div class="chapter"><h4 id="Upgrade-UpgradingfromTeamCityversion1.x">从TeamCity版本1.x升级</h4><p id="2e79d616">TeamCity的2.0版迁移到了用于管理构建代理的Windows服务（服务包装器）的新方法：Java Service Wrapper库。</p><p id="f6419792">使用新服务包装程序的优点之一是能够更改构建代理进程的任何JVM参数。</p><p id="78b21345">1.x版本以<b id="c9bc2c86">agentd</b>的名称安装了Windows服务，而2.x版本使用<b id="84c4c09f">TeamCity Build Agent Service。 <build number=""></build></b>名称。</p><p id="187b6fea">服务包装器不会自动迁移到新版本。除非需要新的服务包装器（例如更改代理的JVM参数），否则不需要使用它。</p><p id="51ab4af2">要使用新的服务包装程序，请卸载旧版本的代理（使用“ <b id="5d232bc7">控制面板” |“添加/删除程序”</b> ），然后安装新的代理。</p><p id="3e06792c">如果您对启动服务的用户进行了自定义，请不要忘记在新安装的服务中对其进行自定义。</p></div><a name="UpgradingfromTeamCityversion2.x"></a><a name="Upgrading-from-TeamCity-version-2.x"></a><div class="chapter"><h4 id="Upgrade-UpgradingfromTeamCityversion2.x">从TeamCity版本2.x升级</h4><p id="b015a7ea">如果服务包装程序需要更新，则将新版本下载到<code class="code"><agent>/launcher.latest</code>文件夹，但是更改不会自动应用。</p><p id="f4631883">要手动升级服务包装器，请执行以下操作：</p><ol class="list _decimal"><li class="list__item" id="4ab1604f"><p>确保<code class="code"><agent>/launcher.latest</code>文件夹存在。</p></li><li class="list__item" id="73895140"><p>使用停止服务<code class="code"><agent>\bin\service.stop.bat</code> 。</p></li><li class="list__item" id="39907cc1"><p>使用卸载服务<code class="code">service.uninstall.bat</code> 。</p></li><li class="list__item" id="aaddb35c"><p>备份<code class="code"><agent>/launcher/conf/wrapper.conf</code>文件。</p></li><li class="list__item" id="320b3a5d"><p>删除<code class="code"><agent>/launcher</code> 。</p></li><li class="list__item" id="b5861a8f"><p>改名<code class="code"><agent>/launcher.latest</code>至<code class="code"><agent>/launcher</code> 。</p></li><li class="list__item" id="00d45ef9"><p>编辑<code class="code"><agent>/launcher/conf/wrapper.conf</code>文件。检查<code class="code">wrapper.java.command</code>属性指向<code class="code">java.exe</code>文件。将其保留为空白以使用注册表查找Java。离开“ java.exe”进行查找<code class="code">java.exe</code>在<code class="code">PATH</code> 。对于独立代理，服务值应为<code class="code">../jre/bin/java</code> ，对于服务器上的代理安装，该值应为<code class="code">../../jre/bin/java</code> 。的备份版本<code class="code">wrapper.conf</code>文件可以使用。</p></li><li class="list__item" id="8b563ae9"><p>使用安装服务<code class="code"><agent>\bin\service.install.bat</code> 。</p></li><li class="list__item" id="e72666dc"><p>确保服务在正确的用户帐户下运行。请注意，使用SYSTEM可能导致使用MSBuild / Sln2005配置的构建失败。</p></li><li class="list__item" id="27bc4e45"><p>使用启动服务<code class="code"><agent>\bin\service.start.bat</code> 。</p></li></ol><aside class="note " rel="f85ef251" id="9309e9ad" data-title=""><p id="e00c043e">此过程仅适用于使用<i id="3fe2070c">新</i>服务包装程序运行的代理。确保您没有运行<b id="466d3387">代理</b>服务。</p></aside><hr id="01b9ea63"><p id="10ca0f59"><b id="bbee38fc">也可以看看：</b></p><p id="6b6e6e3b"><b id="b3c575d3">概念</b> ： <a href="teamcity-data-directory.html">TeamCity数据目录</a><br><b id="75cf539c">管理员指南</b> ： <a href="teamcity-maintenance-mode.html">TeamCity维护模式</a> | <a href="teamcity-data-backup.html">TeamCity数据备份</a></p><hr id="51547977"></div></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>