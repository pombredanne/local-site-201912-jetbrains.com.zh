<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>使用AWS Aurora数据库群集-帮助|帮助团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Using AWS Aurora Database Cluster" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/setting-up-an-external-database.md|Setting up an External Database/using-aws-aurora-database-cluster.md|Using AWS Aurora Database Cluster" data-main-title="Using AWS Aurora Database Cluster" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/using-aws-aurora-database-cluster.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="using-aws-aurora-database-cluster.md" data-toc="Using AWS Aurora Database Cluster">使用AWS Aurora数据库集群</h1><p id="924073c1">此页面提供有关将<a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Aurora.Overview.html" rel="noopener noreferrer" data-external="true" target="_blank">Amazon Aurora</a>群集用作TeamCity数据库服务器的详细信息。</p><p id="930000cd"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#UsingAWSAuroraDatabaseCluster-Overview">总览</a></li><li class="list__item"><a href="#UsingAWSAuroraDatabaseCluster-GeneralRecommendations">一般建议</a></li><li class="list__item"><a href="#UsingAWSAuroraDatabaseCluster-ForcingTeamCitytoConnecttoNewWriter">强制TeamCity连接到新作家</a></li></ul><p></p><a name="Overview"></a><a name="Overview"></a><div class="chapter"><h2 id="UsingAWSAuroraDatabaseCluster-Overview">总览</h2><p id="0e73be64">在将AWS Aurora群集与TeamCity指向<a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_Aurora.html#Aurora.Overview.Endpoints" rel="noopener noreferrer" data-external="true" target="_blank">群集端点</a>作为数据库服务器一起使用时，重要的是要了解AWS Aurora群集进行故障转移时会发生什么。</p><p id="80ecf987">两个AWS Aurora数据库实例均已重启（因此TeamCity在短时间内完全失去了与集群的连接），并且</p><ul class="list _ul"><li class="list__item" id="36cda642"><p>原始数据库实例以设置<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_read_only" rel="noopener noreferrer" data-external="true" target="_blank">innodb_read_only标志</a>启动（新的读取器实例）；</p></li><li class="list__item" id="50f9e513"><p>前一个故障转移实例是新编写者，并且群集端点DNS记录已更改为指向新编写者实例。默认情况下，TeamCity JVM缓存DNS名称查找，这实际上意味着TeamCity将保持与原始数据库实例的连接，直到DNS缓存过期。这进而导致在TeamCity侧的数据库连接池中填充到新阅读器的连接。</p></li></ul><p id="4896b11b">TeamCity中特定于JVM的缓存要到期并且要从池中清除无效的连接，需要一些时间。</p></div><a name="GeneralRecommendations"></a><a name="General-Recommendations"></a><div class="chapter"><h2 id="UsingAWSAuroraDatabaseCluster-GeneralRecommendations">一般建议</h2><p id="da559947">使用故障转移群集时，建议<a href="http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-jvm-ttl.html" rel="noopener noreferrer" data-external="true" target="_blank">通过将TTL设置为60来</a>减少TeamCity上的JVM特定的DNS缓存：</p><ol class="list _decimal"><li class="list__item" id="67994a4a"><p id="c5aa7604">添加<code class="code">-Dsun.net.inetaddr.ttl=60</code> JVM选项为<a href="configuring-teamcity-server-startup-properties.html#JVM-Options">环境变量</a> 。</p></li><li class="list__item" id="12d51b80"><p id="42c4df92">重新启动TeamCity，以使更改生效。</p></li></ol><aside class="note " rel="2c5c19d6" id="0aedb15e" data-title=""><p id="3ef92041">您可能还希望手动刷新特定于操作系统的DNS缓存，但这是每次Aurora故障转移时要执行的操作。</p></aside></div><a name="ForcingTeamCitytoConnecttoNewWriter"></a><a name="Forcing-TeamCity-to-Connect-to-New-Writer"></a><div class="chapter"><h2 id="UsingAWSAuroraDatabaseCluster-ForcingTeamCitytoConnecttoNewWriter">强制TeamCity连接到新作家</h2><p id="11649c3f">您可以强制TeamCity手动或自动连接到新编写器。</p><p id="90a3182d"><b id="3e452261">手动</b>强制连接：</p><ul class="list _ul"><li class="list__item" id="1e69ceba"><p>再次重新启动新的数据库读取器实例：重新启动最多需要2分钟，这足以使DNS缓存过期以及从池中清除无效连接</p></li><li class="list__item" id="9e019e6f"><p>或者，手动重新启动TeamCity，然后将重新创建所有连接。</p></li></ul><p id="900367e1">要强制TeamCity在新主实例启动并运行后立即<b id="e8ff7d3e">自动</b>连接到它：</p><aside class="note " rel="900367e1" id="0b58ef53" data-title=""><p id="55370849">以下选项可能会影响TeamCity服务器的性能。</p></aside><p id="8ec76b3e">将数据库连接池配置为使用特殊的验证查询，以便在使用之前和/或之后测试与数据库实例的连接，并且如果检测到与只读数据库的连接，则会将其从池中逐出。</p><ol class="list _decimal"><li class="list__item" id="b23217da"><p>将以下行添加到<code class="code"><TeamCity Data Directory>/config/</code> <a href="setting-up-an-external-database.html#Database-Configuration-Properties">文件</a> ：</p><div class="code-block" data-lang="bash">testOnBorrow = true testOnReturn = true testWhileIdle = true timeBetweenEvictionRunsMillis = 60000validationQuery =选择@@ read_only + @@ innodb_read_only \ = 0时的其他情况（否则，从information_schema.tables中选择table_name）以“ 1”结尾</div><p></p></li><li class="list__item" id="76cd8201">重新启动TeamCity。完成此操作后，将执行以下SQL查询：<div class="code-block" data-lang="bash">ase当@@ read_only + @@ innodb_read_only = 0时，则为1（从information_schema.tables中选择table_name）以1结尾。</div><p id="b5c2ed3f">无论何时从池中借用或返回到池中，所有连接都将执行，对于空闲连接也将每1分钟（60000毫秒）执行一次，从而<a href="https://dev.mysql.com/doc/refman/5.6/en/subquery-errors.html" rel="noopener noreferrer" data-external="true" target="_blank">导致</a>与只读数据库的每个连接产生<a href="https://dev.mysql.com/doc/refman/5.6/en/subquery-errors.html" rel="noopener noreferrer" data-external="true" target="_blank">错误1242（ER_SUBSELECT_NO_1_ROW）</a> 。</p></li></ol><hr id="6ca7299c"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>