<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Using AWS Aurora Database Cluster - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Using AWS Aurora Database Cluster" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/setting-up-an-external-database.md|Setting up an External Database/using-aws-aurora-database-cluster.md|Using AWS Aurora Database Cluster" data-main-title="Using AWS Aurora Database Cluster" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/using-aws-aurora-database-cluster.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Using AWS Aurora Database Cluster" id="using-aws-aurora-database-cluster.md">Using AWS Aurora Database Cluster</h1><p id="924073c1">This page provides details on using an <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Aurora.Overview.html" data-external="true" target="_blank" rel="noopener noreferrer">Amazon Aurora</a> cluster as the TeamCity database server.</p><p id="930000cd"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#UsingAWSAuroraDatabaseCluster-Overview">Overview</a></li><li class="list__item"><a href="#UsingAWSAuroraDatabaseCluster-GeneralRecommendations">General Recommendations</a></li><li class="list__item"><a href="#UsingAWSAuroraDatabaseCluster-ForcingTeamCitytoConnecttoNewWriter">Forcing TeamCity to Connect to New Writer</a></li></ul></p><a name="Overview"></a><a name="Overview"></a><div class="chapter"><h2 id="UsingAWSAuroraDatabaseCluster-Overview">Overview</h2><p id="0e73be64">When using an AWS Aurora cluster with TeamCity pointing to the <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_Aurora.html#Aurora.Overview.Endpoints" data-external="true" target="_blank" rel="noopener noreferrer">cluster end-point</a> as the database server, it is important to understand what happens when an AWS Aurora cluster fails over.</p><p id="80ecf987">Both AWS Aurora DB instances are rebooted (so for a short period of time TeamCity entirely loses connection to the cluster) and</p><ul class="list _ul"><li class="list__item" id="36cda642"><p>the original DB instance is started with <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-parameters.html#sysvar_innodb_read_only" data-external="true" target="_blank" rel="noopener noreferrer">innodb_read_only flag</a> set (the new reader instance);</p></li><li class="list__item" id="50f9e513"><p>the former failover instance is the new writer and the cluster endpoint DNS record is changed to point to the new writer instance.By default, TeamCity JVM caches DNS name lookups, which essentially means that TeamCity will stay connected to the original DB instance until DNS cache expires. This in turn leads to the database connection pool on the TeamCity side to be populated with the connections to the new reader.</p></li></ul><p id="4896b11b">It will take some time for the JVM-specific cache in TeamCity to expire and for the invalid connections to be evicted from the pool.</p></div><a name="GeneralRecommendations"></a><a name="General-Recommendations"></a><div class="chapter"><h2 id="UsingAWSAuroraDatabaseCluster-GeneralRecommendations">General Recommendations</h2><p id="da559947">When working with a failover cluster, it is recommended you decrease the JVM-specific DNS caching on TeamCity <a href="http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-jvm-ttl.html" data-external="true" target="_blank" rel="noopener noreferrer">by setting the TTL to 60</a>:</p><ol class="list _decimal"><li class="list__item" id="67994a4a"><p id="c5aa7604">Add the <code class="code">-Dsun.net.inetaddr.ttl=60</code>JVM option to the <a href="configuring-teamcity-server-startup-properties.html#JVM-Options">environment variable</a>.</p></li><li class="list__item" id="12d51b80"><p id="42c4df92">Restart TeamCity for the changes to take effect.</p></li></ol><aside class="note " data-title="" rel="2c5c19d6" id="0aedb15e"><p id="3ef92041">You may also wish to manually flush your OS-specific DNS cache, but this is the action to be taken each time Aurora fails over.</p></aside></div><a name="ForcingTeamCitytoConnecttoNewWriter"></a><a name="Forcing-TeamCity-to-Connect-to-New-Writer"></a><div class="chapter"><h2 id="UsingAWSAuroraDatabaseCluster-ForcingTeamCitytoConnecttoNewWriter">Forcing TeamCity to Connect to New Writer</h2><p id="11649c3f">You can force TeamCity to connect to the new writer either manually or automatically.</p><p id="90a3182d">To force the connection <b id="3e452261">manually</b> :</p><ul class="list _ul"><li class="list__item" id="1e69ceba"><p>reboot the new DB reader instance again: the reboot will take up to 2 minutes which is sufficient for the DNS cache to expire as well as for the invalid connections to be evicted from the pool</p></li><li class="list__item" id="9e019e6f"><p>alternatively, restart TeamCity manually and all the connections will be created anew.</p></li></ul><p id="900367e1">To force TeamCity to <b id="e8ff7d3e">automatically</b> connect to the new primary instance as soon as it's up and running:</p><aside class="note " data-title="" rel="900367e1" id="0b58ef53"><p id="55370849">The following options may affect your TeamCity server performance.</p></aside><p id="8ec76b3e">Configure the database connection pool to use a special validation query, so that the connections to the DB instance are tested before and/or after use and if a connection to the read-only database is detected, they are evicted from the pool.</p><ol class="list _decimal"><li class="list__item" id="b23217da"><p>Add the following lines to the <code class="code">&lt;TeamCity Data Directory&gt;/config/</code> <a href="setting-up-an-external-database.html#Database-Configuration-Properties">file</a>:<div class="code-block" data-lang="bash">testOnBorrow=true
testOnReturn=true
testWhileIdle=true
timeBetweenEvictionRunsMillis=60000
validationQuery=select case when @@read_only + @@innodb_read_only \= 0 then 1 else (select table_name from information_schema.tables) end as `1`

</div></p></li><li class="list__item" id="76cd8201">Restart TeamCity. Once you do that, the following SQL query:<div class="code-block" data-lang="bash">ase when @@read_only + @@innodb_read_only = 0 then 1 else (select table_name from information_schema.tables) end as `1`
</div><p id="b5c2ed3f">will be executed for all connections whenever they are borrowed from or returned to the pool, and also every 1 minute (60000 milliseconds) for idle connections, raising <a href="https://dev.mysql.com/doc/refman/5.6/en/subquery-errors.html" data-external="true" target="_blank" rel="noopener noreferrer">error 1242 (ER_SUBSELECT_NO_1_ROW )</a> for each connection to the read-only database.</p></li></ol><hr id="6ca7299c"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>