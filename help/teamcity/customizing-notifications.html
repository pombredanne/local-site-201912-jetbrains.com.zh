<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>自定义通知-帮助|团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Customizing Notifications" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/customizing-notifications.md|Customizing Notifications" data-main-title="Customizing Notifications" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/customizing-notifications.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="customizing-notifications.md" data-toc="Customizing Notifications">自定义通知</h1><p id="c392c15b">TeamCity用户可以<a href="subscribing-to-notifications.html">选择要通知的事件</a> 。可以在每个服务器的基础上全局自定义默认通知消息。自定义通过Atom / RSS联合供稿接收的通知需要一种<a href="#TeamCity-Notification-Properties">特殊的方法，</a>因为供稿使用“拉”模型来接收通知，而不是“推送”。</p><p id="bba73dc9">在此页：</p><p id="a9bb98d1"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#CustomizingNotifications-NotificationsLifecycle">通知生命周期</a></li><li class="list__item"><a href="#CustomizingNotifications-CustomizingNotificationsTemplates">自定义通知模板</a><ul class="list _bullet"><li class="list__item"><a href="#CustomizingNotifications-NotificationTemplatesLocation">通知模板位置</a></li><li class="list__item"><a href="#CustomizingNotifications-SupportedOutputValues">支持的输出值</a></li><li class="list__item"><a href="#CustomizingNotifications-CustomizationExamples">定制实例</a><ul class="list _bullet"><li class="list__item"><a href="#CustomizingNotifications-IncludingERRORSfromthelog">包括日志中的错误</a></li><li class="list__item"><a href="#CustomizingNotifications-Listingbuildartifacts">列出构建工件</a></li><li class="list__item"><a href="#CustomizingNotifications-Listingbuildparameters">列出构建参数</a></li></ul></li><li class="list__item"><a href="#CustomizingNotifications-DefaultDataModel">默认数据模型</a></li><li class="list__item"><a href="#CustomizingNotifications-TeamCityNotificationProperties">TeamCity通知属性</a></li><li class="list__item"><a href="#CustomizingNotifications-SyndicationFeedTemplate">联合供稿模板</a></li></ul></li></ul><p></p><a name="NotificationsLifecycle"></a><a name="Notifications-Lifecycle"></a><div class="chapter"><h2 id="CustomizingNotifications-NotificationsLifecycle">通知生命周期</h2><p id="86ebf9fd">TeamCity支持一组事件，这些事件可以生成用户通知（例如，构建失败，调查状态更改等）。事件发生时，对于每种通知程序类型，TeamCity都会为所有用户处理通知设置，以确定要通知的用户。</p><p id="a359cbe7">确定用户集后，TeamCity将填充通知模型（与通知相关的对象，例如“构建”，调查数据等），并评估与通知事件相对应的通知模板。<br>该模板使用数据模型对象生成输出值（例如，通知消息文本）。然后，通知程序将使用输出值来发送消息。每个通知程序都支持一组特定的输出值。</p><p id="02f5a97e">请注意，模板将针对事件进行一次评估，这意味着无法基于每个用户调整通知属性。</p><p id="af4f62df">然后，通知程序使用模板定义的输出值将警报发送给选定的用户。</p></div><a name="CustomizingNotificationsTemplates"></a><a name="Customizing-Notifications-Templates"></a><div class="chapter"><h2 id="CustomizingNotifications-CustomizingNotificationsTemplates">自定义通知模板</h2><a name="NotificationTemplatesLocation"></a><a name="Notification-Templates-Location"></a><div class="chapter"><h3 id="CustomizingNotifications-NotificationTemplatesLocation">通知模板位置</h3><p id="801c8bb0">每个捆绑的<a href="notifier.html">通知程序</a>在< <a href="teamcity-data-directory.html">TeamCity数据目录</a> > / config_notifications /中都有一个目录，该目录存储<a href="http://freemarker.sourceforge.net/" rel="noopener noreferrer" data-external="true" target="_blank">FreeMarker</a> （ <code class="code">.ftl</code> ）模板。也有<a href="teamcity-data-directory.html#.dist-Template-Configuration-Files"><code class="code">.dist</code></a>存储默认模板的文件。每种通知类型都会评估具有相应名称的模板文件。可以在服务器运行时修改模板文件。</p><p id="244d1284">默认情况下，服务器每60秒检查一次文件更改，但是可以通过设置<code class="code">teamcity.notification.template.update.interval</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性</a>设置为所需的秒数。</p><p id="3ac89145">如果在模板评估期间发生错误，TeamCity会将错误详细信息记录到<code class="code">teamcity-notifications.log</code> 。可能存在导致忽略模板部分的非严重错误，或者导致根本无法发送通知的严重错误。每当您对通知模板进行更改时，请确保仍然可以发送通知。</p><p id="7330a1e4">本文档未介绍FreeMarker模板语言，因此，如果您需要有关FreeMarker语法的指南，请参阅<a href="http://freemarker.org/docs/dgui.html" rel="noopener noreferrer" data-external="true" target="_blank">http://freemarker.org/docs/dgui.html</a>上的相应模板手册。</p></div><a name="SupportedOutputValues"></a><a name="Supported-Output-Values"></a><div class="chapter"><h3 id="CustomizingNotifications-SupportedOutputValues">支持的输出值</h3><p id="17c050dd">TeamCity通知程序使用模板评估输出值（全局模板变量），然后按名称检索它们。支持以下输出值：</p><p id="edf092ac"><b id="fd9e0528">电子邮件通知者</b></p><ul class="list _ul"><li class="list__item" id="7c8cfeeb"><p><b id="8ee9ee5c">主题</b> -要发送的电子邮件的主题</p></li><li class="list__item" id="b012e521"><p><b id="e1f58059">正文</b> -要发送的电子邮件的纯文本</p></li><li class="list__item" id="d4d2cc13"><p><b id="8c84381d">bodyHtml-</b>这是要发送的电子邮件的可选HTML文本。它将与消息的纯文本部分一起包括在内。但是，如果模板中存在它，则也应该对其进行自定义。</p></li><li class="list__item" id="d836f484"><p><b id="4fa8f1b5">标头</b> -（可选）要包含在电子邮件中的其他标头的原始列表。每行一个标题。例如：</p></li></ul><div class="code-block" data-lang="markup"><#global headers> X优先级：1（最高）重要性：高<!--#global-->

</div><p id="40c69ad7"><b id="41ed94e7">贾伯</b></p><ul class="list _ul"><li class="list__item" id="5f614cd0"><p><b id="e1768525">消息</b> -消息的纯文本发送<b id="eb0a9060">IDE通知</b>和<b id="1b060ddf">Windows任务栏通知</b></p></li><li class="list__item" id="7afa65a0"><p><b id="225d22d3">消息</b> -要发送的消息的纯文本</p></li><li class="list__item" id="f02cceb1"><p><b id="73fa8595">链接</b> -TeamCity页面的URL，其中包含有关事件的详细信息（i）Atom / RSS提要模板与其他模板有所不同。有关详细信息，请参阅<a href="#TeamCity-Notification-Properties">专用部分</a> 。</p></li></ul></div><a name="CustomizationExamples"></a><a name="Customization-Examples"></a><div class="chapter"><h3 id="CustomizingNotifications-CustomizationExamples">定制实例</h3><p id="1a4a468c">本节提供了可用于自定义通知的Freemaker代码段：</p><a name="IncludingERRORSfromthelog"></a><a name="Including-ERRORS-from-the-log"></a><div class="chapter"><h4 id="CustomizingNotifications-IncludingERRORSfromthelog">包括日志中的错误</h4><div class="code-block" data-lang="markup"><#list build.buildLog.messages[1..] as message> <#-- skipping the first message (it is a root node)--> <#if message.status == "ERROR" || message.status == "FAILURE" > $ {message.text} <!--#if--> <!--#list-->

</div><p id="1689da4a">以下示例显示了包含在<code class="code">build_failed.ftl</code>模板：错误将在电子邮件的纯文本和html部分中列出：</p><div class="code-block" data-lang="markup"><#-- Uses FreeMarker template syntax, template guide can be found at http://freemarker.org/docs/dgui.html --> <#import "common.ftl" as common> <#global subject> [ <@common.subjMarker/> FAILED] $ {project.name}：$ {buildType.name}-构建：$ {build.buildNumber} <!--#global--> <#global body> TeamCity建立：$$。 $ {build.buildNumber}失败$ {var.buildShortStatusDescription}。代理：$ {} AGENTNAME构建结果：$ {link.buildResultsLink} $ {var.buildCompilationErrors} $ {var.buildFailedTestsErrors} $ {} var.buildChanges <#list build.buildLog.messages[1..] as message> <#-- skipping the first message (it is a root node)--> <#if message.status == "ERROR" || message.status == "FAILURE" > $ {} message.text <!--#if--> <!--#list--> <@common.footer/> <!--#global--> <#global bodyHtml>
<div>
  <div>TeamCity构建： <i>$ {project.name}：$ {buildType.name}- <a href="${link.buildResultsLink}">构建：$ {build.buildNumber}</a></i>失败$ {var.buildShortStatusDescription}</div>
  <@common.build_agent build/>
  <@common.build_comment build/>
  <br>
  <@common.build_changes var.changesBean/> <@common.compilation_errors var.compilationBean/> <@common.test_errors var.failedTestsBean/> <#list build.buildLog.messages[1..] as message> <#-- skipping the first message (it is a root node)--> <#if message.status == "ERROR" || message.status == "FAILURE" > $ {message.text} <!--#if--> <!--#list--> <@common.footerHtml/>
</div>
<!--#global-->

</div></div><a name="Listingbuildartifacts"></a><a name="Listing-build-artifacts"></a><div class="chapter"><h4 id="CustomizingNotifications-Listingbuildartifacts">列出构建工件</h4><p id="0cdf35cd">目前，没有默认的方法可以在电子邮件模板中列出构建工件。通过一个简单的插件查看<a href="https://youtrack.jetbrains.com/issue/TW-50431" rel="noopener noreferrer" data-external="true" target="_blank">相关问题</a> ，该插件可让您通过相关API列出工件。</p><p id="212ab913"><b id="e370c0e4">当前解决方法</b></p><p id="595e13b5">假定从模板直接访问磁盘，并且忽略了外部工件存储（如S3）以及工件浏览策略（未显示内部工件）。而且，这种方式在将来的TeamCity版本中可能会被弃用。</p><div class="code-block" data-lang="markup"><p>构建工件：</p>
  <#list build.artifactsDirectory.listFiles() as file> <a href="${webLinks.getDownloadArtefactUrl(build.buildTypeExternalId, build.buildId, file.name)}">$ {file.name}</a> （$ {file.length（）} B）<br>
  <!--#list-->

</div><p id="6c8d9995">这将仅列出根工件，并包括<code class="code">.teamcity</code>目录，可以通过修改代码来更改。</p></div><a name="Listingbuildparameters"></a><a name="Listing-build-parameters"></a><div class="chapter"><h4 id="CustomizingNotifications-Listingbuildparameters">列出构建参数</h4><div class="code-block" data-lang="markup"><#list build.parametersProvider.all?keys as param> $ {param}-$ {build.parametersProvider.all [param]}<br>
<!--#list-->

</div><p id="6cd10d17">这将列出从服务器传递到内部版本的参数。</p></div></div><a name="DefaultDataModel"></a><a name="Default-Data-Model"></a><div class="chapter"><h3 id="CustomizingNotifications-DefaultDataModel">默认数据模型</h3><p id="202ff0ef">对于模板评估，TeamCity提供了可在模板内部使用的默认数据模型。该模型中公开的对象是<a href="https://plugins.jetbrains.com/docs/teamcity/server-side-object-model.html" rel="noopener noreferrer" data-external="true" target="_blank">TeamCity服务器端开放API中</a>相应类的实例。<br>可用对象模型的集合针对不同事件而有所不同。您也可以通过插件将自己的对象添加到模型中。有关详细信息，请参见<a href="https://plugins.jetbrains.com/docs/teamcity/extending-notification-templates-model.html" rel="noopener noreferrer" data-external="true" target="_blank">扩展通知模板模型</a> 。</p><p id="92800b07">这是模型的示例说明（可在IntelliJ IDEA中使用该代码完整地编辑模板）。请注意，并非以下列出的所有实体都可以在任何模板中使用，例如，所有测试职责都在项目范围中分配，并且可以将有关测试职责的通知配置为指向分配了调查的项目（而不是构建配置） ）。</p><div class="code-block" data-lang="markup"><#-- @ftlvariable name="project" type="jetbrains.buildServer.serverSide.SProject" -->
<#-- @ftlvariable name="buildType" type="jetbrains.buildServer.serverSide.SBuildType" -->
<#-- @ftlvariable name="build" type="jetbrains.buildServer.serverSide.SBuild" -->
<#-- @ftlvariable name="agentName" type="java.lang.String" -->
<#-- @ftlvariable name="buildServer" type="jetbrains.buildServer.serverSide.SBuildServer" -->
<#-- @ftlvariable name="webLinks" type="jetbrains.buildServer.serverSide.WebLinks" -->
 
<#-- @ftlvariable name="var.buildFailedTestsErrors" type="java.lang.String" -->
<#-- @ftlvariable name="var.buildShortStatusDescription" type="java.lang.String" -->
<#-- @ftlvariable name="var.buildChanges" type="java.lang.String" -->
<#-- @ftlvariable name="var.buildCompilationErrors" type="java.lang.String" -->
 
<#-- @ftlvariable name="link.editNotificationsLink" type="java.lang.String" -->
<#-- @ftlvariable name="link.buildResultsLink" type="java.lang.String" -->
<#-- @ftlvariable name="link.buildChangesLink" type="java.lang.String" -->
<#-- @ftlvariable name="responsibility" type="jetbrains.buildServer.responsibility.ResponsibilityEntry" -->
<#-- @ftlvariable name="oldResponsibility" type="jetbrains.buildServer.responsibility.ResponsibilityEntry" -->

</div></div><a name="TeamCityNotificationProperties"></a><a name="TeamCity-Notification-Properties"></a><div class="chapter"><h3 id="CustomizingNotifications-TeamCityNotificationProperties">TeamCity通知属性</h3><p id="8ed38bcf">以下<a href="configuring-teamcity-server-startup-properties.html">属性</a>对于自定义通知行为很有用：</p><ul class="list _ul"><li class="list__item" id="8411b37a"><p><code class="code">teamcity.notification.template.update.interval</code> –系统重新读取模板的频率（整数，以秒为单位，默认为60）</p></li><li class="list__item" id="ca40de6d"><p><code class="code">teamcity.notification.includeDebugInfo</code> –如果模板处理错误（布尔值，默认为false），则在消息中包括调试信息</p></li><li class="list__item" id="ce2d96d0"><p><code class="code">teamcity.notification.maxChangesNum</code> –电子邮件中列表更改的最大数量（整数，默认为10）</p></li><li class="list__item" id="2a484c29"><p><code class="code">teamcity.notification.maxCompilationDataSize</code> –包含在电子邮件中的编译错误数据的最大大小（以字节为单位）（整数，默认为20480）</p></li><li class="list__item" id="0c0419fa"><p><code class="code">teamcity.notification.maxFailedTestNum</code> –在电子邮件中列出的失败测试的最大数量（整数，默认为50）</p></li><li class="list__item" id="64dc6aea"><p><code class="code">teamcity.notification.maxFailedTestStacktraces</code> –电子邮件中的最大测试堆栈跟踪数（整数，默认为5）</p></li><li class="list__item" id="42615f43"><p><code class="code">teamcity.notification.maxFailedTestDataSize</code> –失败的测试输出数据的最大大小（以字节为单位），以包含在单个电子邮件中（整数，默认为10240）</p></li></ul></div><a name="SyndicationFeedTemplate"></a><a name="Syndication-Feed-Template"></a><div class="chapter"><h3 id="CustomizingNotifications-SyndicationFeedTemplate">联合供稿模板</h3><p id="f0924b23">该模板使用与其他通知引擎不同的配置方法。</p><p id="08485699">默认模板存储在文件中： <code class="code"><TeamCity Data Directory>/config/default-feed-item-template.ftl</code> 。永远不要编辑该文件：每次启动服务器时，该文件都会被默认副本覆盖。要指定要使用的新模板，请复制名为<code class="code">feed-item-template.ftl</code>到同一个目录。该文件可以编辑，不会被覆盖。如果存在，它将由引擎使用。</p><p id="3a5e5cde">该模板是<a href="http://freemarker.org/docs/dgui.html" rel="noopener noreferrer" data-external="true" target="_blank">FreeMarker</a>模板，可以自由编辑。</p><p id="33eb30dd">您可以在单个服务器上使用多个模板。可以将模板名称作为提要URL的<a href="subscribing-to-notifications.html#Additional-Supported-URL-Parameters">URL参数</a>传递。</p><p id="7c0b3d19">在提要渲染期间，对模板进行评估以获取提要内容。结果内容由模板中定义的全局变量定义。</p><p id="c6090e62">有关可用输入变量和输出变量的示例，请参见默认模板。</p><hr id="5db4c166"><p id="c9c3c461"><b id="738161eb">也可以看看：</b></p><p id="5ac1ddf0"><b id="54cced85">用户指南</b> ： <a href="subscribing-to-notifications.html">订阅通知</a></p><hr id="e83b34b9"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>