<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>在AWS中运行TeamCity Stack-帮助|帮助团队城市</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Running TeamCity Stack in AWS" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/installing-and-configuring-the-teamcity-server.md|Installing and Configuring the TeamCity Server/running-teamcity-stack-in-aws.md|Running TeamCity Stack in AWS" data-main-title="Running TeamCity Stack in AWS" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/running-teamcity-stack-in-aws.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="running-teamcity-stack-in-aws.md" data-toc="Running TeamCity Stack in AWS">在AWS中运行TeamCity Stack</h1><p id="56b2f185">您可以使用官方<a href="https://github.com/JetBrains/teamcity-cloudformation-template" rel="noopener noreferrer" data-external="true" target="_blank">CloudFormation模板</a>在AWS中运行TeamCity堆栈。请注意，这是一个实验性选项，目前正在进行中。</p><p id="282e2021">在此页：</p><p id="dde4efc3"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#RunningTeamCityStackinAWS-StackOverview">堆栈概述</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-Prerequisites">先决条件</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-UsingTemplate">使用范本</a><ul class="list _bullet"><li class="list__item"><a href="#RunningTeamCityStackinAWS-TemplateParameters">模板参数</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-BuildAgents">建立代理</a></li></ul></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-Connectingtoserverandviewinglogs">连接到服务器并查看日志</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-NextSteps">下一步</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-UpgradingTeamCityinAWS">在AWS中升级TeamCity</a></li></ul><p></p><a name="StackOverview"></a><a name="Stack-Overview"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-StackOverview">堆栈概述</h2><p id="755361e8">当前设置使用2个子网，一个公共子网和一个私有子网。</p><ul class="list _ul"><li class="list__item" id="11d2619b">专用子网包括所有重要项目：<ul class="list _ul"><li class="list__item" id="f239ae34"><p>CoreOS EC2实例的ECS集群，其中包含来自Docker Hub的指定版本的官方TeamCity服务器和一个TeamCity Build Agent。使用TeamCity服务器和构建代理的官方Docker映像。</p></li><li class="list__item" id="743c1715"><p>RDS MySQL数据库</p></li></ul></li><li class="list__item" id="45a57c84">公共子网包括：<ul class="list _ul"><li class="list__item" id="f823ea33"><p>应用程序负载均衡器</p></li><li class="list__item" id="874fb0a9"><p>NAT网关确保公共可用IP</p></li></ul></li></ul><p id="5e5afaa1">两个子网都放置在完全安全的虚拟私有云（VPC）中。该数据库仅允许VPC内部进行内部连接，并且只能通过HTTP或SSH连接到服务器。</p></div><a name="Prerequisites"></a><a name="Prerequisites"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-Prerequisites">先决条件</h2><p id="3f6e7408">要创建TeamCity堆栈并连接到它，您将需要：</p><ul class="list _ul"><li class="list__item" id="0bca25c3"><p><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html" rel="noopener noreferrer" data-external="true" target="_blank">EC2 KeyPair</a>与TeamCity堆栈位于同一区域</p></li><li class="list__item" id="63b4118c"><p>已安装SSH客户端以连接到TeamCity服务器并查看日志</p></li><li class="list__item" id="a77bc7c1"><p>IAM权限，用于创建服务链接的角色，并为创建堆栈的IAM实体对其应用策略</p></li></ul></div><a name="UsingTemplate"></a><a name="Using-Template"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-UsingTemplate">使用范本</h2><p id="895c0801">1。在“ <i id="e4fd4403">选择模板”</i>页面上，选择默认的TeamCity模板，然后单击“ <b id="37c9f954">下一步”</b> 。</p><p id="67b83010">2。指定模板提供的堆栈名称和参数：</p><a name="TemplateParameters"></a><a name="Template-Parameters"></a><div class="chapter"><h3 id="RunningTeamCityStackinAWS-TemplateParameters">模板参数</h3><hr id="fe404c43"><div class="table-wrapper"><table width="100%" id="41a07b7a"><thead><tr id="8a504ca1" class="ijRowHead"><th id="6de2a260"><p id="5609c5a6">设置</p></th><th id="39f7ce98"><p id="393bd9fe">描述</p></th></tr></thead><tbody><tr id="cb281ead" class="ijRowOdd"><td id="d834b9f1"><p id="d991792f">名称</p></td><td id="761c527b"><p id="1c285366">TeamCity服务器的名称，默认情况下设置为<i id="70edee30">test</i> 。</p></td></tr><tr id="284a6485" class="ijRowEven"><td id="e958af0e"><p id="f8dfc8f3">TeamCity版本</p></td><td id="747f4770"><p id="ce94aa3d">默认情况下，模板将创建最新版本的TeamCity安装。您还可以在此处指定确切的版本号，例如2017.1.5、2017.2。</p></td></tr><tr id="eef3eb4f" class="ijRowOdd"><td id="98cf779c"><p id="6761e934">面向互联网的堆栈</p></td><td id="dd31e6c9"><p id="10b91311">默认情况下，设置为<code class="code">false</code> 。此设置会影响应用程序负载平衡器：默认情况下，它没有公共IP地址，仅在VPC内部接收流量。要创建公共可用的TeamCity实例，请将其设置为<code class="code">true</code> 。</p></td></tr><tr id="c5e9aeea" class="ijRowEven"><td id="a194bf06"><p id="6d397c86">EC2 KeyPair（必填）</p></td><td id="098a0ffe"><p id="afa18c89">指定一个现有的EC2 KeyPair，以通过SSH访问TeamCity Server EC2实例。如果无法提供密钥对，则堆栈创建将失败，并显示以下错误：“模板验证错误：参数'KeyName'必须与模式。+匹配”</p></td></tr><tr id="7e11ca9c" class="ijRowOdd"><td id="31bb3bb1"><p id="a39c992a">SSL证书域</p></td><td id="5fa737b5"><p id="f24b1714">可选的。如果您是域所有者，则可以在此处指定域并获取将在负载均衡器中自动注册的证书。您的堆栈创建将被暂停，直到您验证电子邮件为止。</p></td></tr><tr id="fa2c0d18" class="ijRowEven"><td id="a517bd2b"><p id="9a97a7e5">EC2实例类型</p></td><td id="21cc66f8"><p id="15ba1212">指定TeamCity服务器<a href="https://aws.amazon.com/ec2/instance-types/" rel="noopener noreferrer" data-external="true" target="_blank">的实例类型</a></p></td></tr><tr id="62102b16" class="ijRowOdd"><td id="58779793"><p id="4c6ec16a">容器CPU</p></td><td id="124a22b7"><p id="006d13c7">虚拟CPU单元中的容器CPU</p></td></tr><tr id="400193f0" class="ijRowEven"><td id="e69eb8a0"><p id="6b83ad36">容器内存</p></td><td id="98d17b89"><p id="f8a29087">默认情况下设置为3700 MiB。</p></td></tr><tr id="98275199" class="ijRowOdd"><td id="e55e02eb"><p id="5a3008ea">RDS数据库实例类型</p></td><td id="2de37fc4"><p id="df48e84a">指定用作TeamCity的外部数据库的RDS MySQL实例的类型。默认： <code class="code">db.t2.medium</code> 。</p></td></tr><tr id="27ef061a" class="ijRowEven"><td id="2984ed74"><p id="0af6881e">TeamCity数据库密码（必填）</p></td><td id="d150c4f5"><p id="67d330a3">指定TeamCity数据库的任何密码</p></td></tr></tbody></table></div></div><a name="BuildAgents"></a><a name="Build-Agents"></a><div class="chapter"><h3 id="RunningTeamCityStackinAWS-BuildAgents">建立代理</h3><div class="table-wrapper"><table width="100%" id="8d9788ff"><thead><tr id="ad46312f" class="ijRowHead"><th id="d12b5293"><p id="5f0dfb63">设置</p></th><th id="1a2c428c"><p id="b3aef733">描述</p></th></tr></thead><tbody><tr id="8ba43e7b" class="ijRowOdd"><td id="18e7c182"><p id="0dfb461d">代理商编号</p></td><td id="d14ec10f"><p id="fb0a8734">指定要启动的代理数。每个代理都将在单独的计算机上启动。如果指定0，则不会启动任何代理。</p></td></tr><tr id="d86a3187" class="ijRowEven"><td id="6ac841d9"><p id="c44e19c6">EC2实例类型</p></td><td id="afb99d4d"><p id="b4cbc44b">指定TeamCity代理<a href="https://aws.amazon.com/ec2/instance-types/" rel="noopener noreferrer" data-external="true" target="_blank">的实例类型</a></p></td></tr><tr id="07e7f2b7" class="ijRowOdd"><td id="dbc224d8"><p id="d78cbf2e">容器CPU</p></td><td id="b4253897"><p id="5f707456">虚拟CPU单元中的容器CPU</p></td></tr><tr id="cf3363b7" class="ijRowEven"><td id="6a1095b8"><p id="b3b7ffe2">容器内存</p></td><td id="1a040f31"><p id="a9be6b55">默认情况下设置为2048 MiB。</p></td></tr></tbody></table></div><p id="0bf9e4b6">3。单击<b id="cf2cf2e6">下一步</b> 。（可选）在出现的对话框中，根据需要提供其他选项。</p><p id="025eb594">4。单击<b id="b1633835">下一步</b> ，查看您的设置，接受创建AWS角色。</p><aside class="note " rel="025eb594" id="f684e56c" data-title=""><p id="9ef4e348">在大多数情况下，Amazon ECS（如果尚不存在）会为您创建与服务相关的角色。如果创建堆栈的用户帐户缺少适当的权限，则堆栈创建将失败，并显示以下错误：“无法承担服务链接角色。验证是否存在ECS服务链接角色”。<br>在这种情况下，您可以使用以下命令创建服务链接角色：</p><div class="code-block" data-lang="bash">AWS IAM创建服务链接的角色--aws服务名称ecs.amazonaws.com</div></aside><p id="4ef70d84">5，点击<b id="e5021edf">Сreate</b> 。无需其他操作。模板大约需要15分钟才能部署整个堆栈。部署准备就绪后，您将在“ <i id="80777926">输出”</i>部分中看到TeamCity服务器端点，该端点指向您的TeamCity安装。</p><p id="3b587410">6。从浏览器访问TeamCity实例，创建管理员帐户并开始使用TeamCity。</p></div></div><a name="Connectingtoserverandviewinglogs"></a><a name="Connecting-to-server-and-viewing-logs"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-Connectingtoserverandviewinglogs">连接到服务器并查看日志</h2><p id="422a8453">要连接到服务器控制台，您需要使用实例私钥：</p><div class="code-block" data-lang="bash">ssh -i <path to="" private="" key\privatekey.pem="">ec2-user @ <server_ip_address>

</server_ip_address></path></div><p id="dcce60d3">查看<code class="code">teamcity-agent.log</code>要么<code class="code">teamcity-server.log</code> ，只需运行<code class="code">docker logs</code>所需容器的命令。例如，对于服务器日志，运行：</p><div class="code-block" data-lang="bash">码头工人日志teamcity服务器</div></div><a name="NextSteps"></a><a name="Next-Steps"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-NextSteps">下一步</h2><p id="129407e9">一旦启动并运行TeamCity，请考虑以下步骤：</p><ul class="list _ul"><li class="list__item" id="2b0bf1de"><p>使用<a href="setting-up-teamcity-for-amazon-ec2.html">为Amazon EC2设置TeamCity</a>来运行更多构建代理并将其连接到服务器</p></li><li class="list__item" id="db8966da"><p>配置TeamCity以将S3存储桶用作<a href="configuring-artifacts-storage.html#Amazon-S3-Support">配置工件存储</a> 。</p></li></ul></div><a name="UpgradingTeamCityinAWS"></a><a name="Upgrading-TeamCity-in-AWS"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-UpgradingTeamCityinAWS">在AWS中升级TeamCity</h2><p id="15e69505">要从CloudFormation模板开始更新TeamCity：</p><ol class="list _decimal"><li class="list__item" id="30ff0e59"><p>在<a href="https://console.aws.amazon.com/cloudformation" rel="noopener noreferrer" data-external="true" target="_blank">AWS CloudFormation控制台</a>的堆栈列表中，选择正在运行的TeamCity堆栈，然后使用<a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-direct.html" rel="noopener noreferrer" data-external="true" target="_blank">Update Stack</a>选项。</p></li><li class="list__item" id="3a48be6b"><p>您将被重定向到<i id="84dbb276">Select Template</i>页面：使用<i id="43978b63">Current Template</i>选项，然后单击<b id="606baa55">Next</b> 。</p></li><li class="list__item" id="a8de10b3"><p>在模板设置页面上，输入要更新到的TeamCity版本。请注意，如果您以前使用的是标记为最新的TeamCity版本，则现在需要提供实际的版本号作为<code class="code">latest</code>标记只能应用于服务器一次。</p></li><li class="list__item" id="0aebb48e"><p>单击<b id="3eeee68b">下一步</b> ，根据需要提供其他选项，查看新设置并单击<b id="595dbdbe">更新</b> 。更新完成后，从浏览器访问TeamCity Web UI。</p></li><li class="list__item" id="7c378658"><p>如果需要，请提供<a href="super-user.html">超级用户令牌</a> ：要获取它，您需要连接到服务器实例， <a href="#Connecting-to-server-and-viewing-logs">如上所述</a>获取TeamCity服务器日志，然后检索维护令牌。</p></li><li class="list__item" id="eec9be8c"><p>等待服务器升级，登录到TeamCity服务器，然后等待代理升级并连接到服务器。</p></li></ol><hr id="9053a960"><p id="b284daa1"><b id="d16419e6">也可以看看：</b></p><p id="acb028d1"><b id="e08e3398">TeamCity博客</b> ： <a href="https://blog.jetbrains.com/teamcity/2017/10/teamcity-aws/" rel="noopener noreferrer" data-external="true" target="_blank">TeamCity CloudFormation官方模板</a></p><hr id="8585e074"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>