<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Running TeamCity Stack in AWS - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Running TeamCity Stack in AWS" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/installing-and-configuring-the-teamcity-server.md|Installing and Configuring the TeamCity Server/running-teamcity-stack-in-aws.md|Running TeamCity Stack in AWS" data-main-title="Running TeamCity Stack in AWS" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/running-teamcity-stack-in-aws.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Running TeamCity Stack in AWS" id="running-teamcity-stack-in-aws.md">Running TeamCity Stack in AWS</h1><p id="56b2f185">You can run the TeamCity stack in AWS using the official <a href="https://github.com/JetBrains/teamcity-cloudformation-template" data-external="true" target="_blank" rel="noopener noreferrer">CloudFormation template</a>. Note that this is an experimental option, which is currently in progress.</p><p id="282e2021">On this page:</p><p id="dde4efc3"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#RunningTeamCityStackinAWS-StackOverview">Stack Overview</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-Prerequisites">Prerequisites</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-UsingTemplate">Using Template</a><ul class="list _bullet"><li class="list__item"><a href="#RunningTeamCityStackinAWS-TemplateParameters">Template Parameters</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-BuildAgents">Build Agents</a></li></ul></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-Connectingtoserverandviewinglogs">Connecting to server and viewing logs</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-NextSteps">Next Steps</a></li><li class="list__item"><a href="#RunningTeamCityStackinAWS-UpgradingTeamCityinAWS">Upgrading TeamCity in AWS</a></li></ul></p><a name="StackOverview"></a><a name="Stack-Overview"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-StackOverview">Stack Overview</h2><p id="755361e8">The current setup uses 2 subnets, a public and a private one.</p><ul class="list _ul"><li class="list__item" id="11d2619b">The private subnet includes all the essential items:<ul class="list _ul"><li class="list__item" id="f239ae34"><p>ECS cluster of a CoreOS EC2 instance with the official TeamCity server of the specified version from Docker Hub and one TeamCity Build Agent. The official Docker images with the TeamCity server and build agent are used.</p></li><li class="list__item" id="743c1715"><p>RDS MySQL database</p></li></ul></li><li class="list__item" id="45a57c84">The public subnet includes:<ul class="list _ul"><li class="list__item" id="f823ea33"><p>Application Load Balancer</p></li><li class="list__item" id="874fb0a9"><p>NAT gateway ensuring the publicly available IPs</p></li></ul></li></ul><p id="5e5afaa1">Both subnets are placed into a Virtual Private Cloud (VPC) which is completely secure. The database allows only internal connections within the VPC and its possible to connect to the Server via HTTP(s) or SSH only.</p></div><a name="Prerequisites"></a><a name="Prerequisites"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-Prerequisites">Prerequisites</h2><p id="3f6e7408">To create a TeamCity stack and connect to it, you will need:</p><ul class="list _ul"><li class="list__item" id="0bca25c3"><p><a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html" data-external="true" target="_blank" rel="noopener noreferrer">EC2 KeyPair</a> in the same region as the TeamCity stack</p></li><li class="list__item" id="63b4118c"><p>Installed SSH client to connect to the TeamCity server and view the logs</p></li><li class="list__item" id="a77bc7c1"><p>IAM permissions to create the service-linked role and apply a policy to it for the IAM entity creating the stack</p></li></ul></div><a name="UsingTemplate"></a><a name="Using-Template"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-UsingTemplate">Using Template</h2><p id="895c0801">1.  On the <i id="e4fd4403">Select Template</i> page, select the default TeamCity Template and click <b id="37c9f954">Next</b>.</p><p id="67b83010">2.  Specify the stack name and parameters provided by the template:</p><a name="TemplateParameters"></a><a name="Template-Parameters"></a><div class="chapter"><h3 id="RunningTeamCityStackinAWS-TemplateParameters">Template Parameters</h3><hr id="fe404c43"><div class="table-wrapper"><table width="100%" id="41a07b7a"><thead><tr id="8a504ca1" class="ijRowHead"><th id="6de2a260"><p id="5609c5a6">Setting</p></th><th id="39f7ce98"><p id="393bd9fe">Description</p></th></tr></thead><tbody><tr id="cb281ead" class="ijRowOdd"><td id="d834b9f1"><p id="d991792f">Name</p></td><td id="761c527b"><p id="1c285366">The name for your TeamCity server, set to <i id="70edee30">test</i> by default.</p></td></tr><tr id="284a6485" class="ijRowEven"><td id="e958af0e"><p id="f8dfc8f3">TeamCity Version</p></td><td id="747f4770"><p id="ce94aa3d">By default, the template will create a TeamCity installation of the latest version. You can also specify the exact version number here, for example, 2017.1.5, 2017.2.</p></td></tr><tr id="eef3eb4f" class="ijRowOdd"><td id="98cf779c"><p id="6761e934">Internet-Facing Stack</p></td><td id="dd31e6c9"><p id="10b91311">By default, set to <code class="code">false</code>.  This setting affects the Application Load Balancer: by default it has no public IP address and only receives traffic inside VPC. To create a publicly available TeamCity instance, set it to <code class="code">true</code>.</p></td></tr><tr id="c5e9aeea" class="ijRowEven"><td id="a194bf06"><p id="6d397c86">EC2 KeyPair (required)</p></td><td id="098a0ffe"><p id="afa18c89">Specify an existing EC2 KeyPair for SSH access to the TeamCity Server EC2 instance. If you fail to provide the key pair, the stack creation will fail with the following error: "Template validation error: Parameter 'KeyName' must match pattern .+"</p></td></tr><tr id="7e11ca9c" class="ijRowOdd"><td id="31bb3bb1"><p id="a39c992a">SSL Certificate Domain</p></td><td id="5fa737b5"><p id="f24b1714">Optional. If you are a domain owner, you can specify the domain here and get the certificate that will be automatically registered in your load balancer. Your stack creation will be paused until you validate your email.</p></td></tr><tr id="fa2c0d18" class="ijRowEven"><td id="a517bd2b"><p id="9a97a7e5">EC2 instance Type</p></td><td id="21cc66f8"><p id="15ba1212">Specify the <a href="https://aws.amazon.com/ec2/instance-types/" data-external="true" target="_blank" rel="noopener noreferrer">type of instance</a> for the TeamCity server</p></td></tr><tr id="62102b16" class="ijRowOdd"><td id="58779793"><p id="4c6ec16a">Container CPU</p></td><td id="124a22b7"><p id="006d13c7">Container CPU in virtual CPU units</p></td></tr><tr id="400193f0" class="ijRowEven"><td id="e69eb8a0"><p id="6b83ad36">Container Memory</p></td><td id="98d17b89"><p id="f8a29087">Set to 3700 MiB by default.</p></td></tr><tr id="98275199" class="ijRowOdd"><td id="e55e02eb"><p id="5a3008ea">RDS Database Instance Type</p></td><td id="2de37fc4"><p id="df48e84a">Specify the type for the RDS MySQL instance used as the external database for TeamCity. Default: <code class="code">db.t2.medium</code>.</p></td></tr><tr id="27ef061a" class="ijRowEven"><td id="2984ed74"><p id="0af6881e">TeamCity Database Password (required)</p></td><td id="d150c4f5"><p id="67d330a3">Specify any password for the TeamCity database</p></td></tr></tbody></table></div></div><a name="BuildAgents"></a><a name="Build-Agents"></a><div class="chapter"><h3 id="RunningTeamCityStackinAWS-BuildAgents">Build Agents</h3><div class="table-wrapper"><table width="100%" id="8d9788ff"><thead><tr id="ad46312f" class="ijRowHead"><th id="d12b5293"><p id="5f0dfb63">Setting</p></th><th id="1a2c428c"><p id="b3aef733">Description</p></th></tr></thead><tbody><tr id="8ba43e7b" class="ijRowOdd"><td id="18e7c182"><p id="0dfb461d">Agents number</p></td><td id="d14ec10f"><p id="fb0a8734">Specify how many agents you want to start. Every agent will be launched on a separate machine. If 0 is specified, no agent will start.</p></td></tr><tr id="d86a3187" class="ijRowEven"><td id="6ac841d9"><p id="c44e19c6">EC2 instance Type</p></td><td id="afb99d4d"><p id="b4cbc44b">Specify the <a href="https://aws.amazon.com/ec2/instance-types/" data-external="true" target="_blank" rel="noopener noreferrer">type of instance</a> for the TeamCity agents</p></td></tr><tr id="07e7f2b7" class="ijRowOdd"><td id="dbc224d8"><p id="d78cbf2e">Container CPU</p></td><td id="b4253897"><p id="5f707456">Container CPU in virtual CPU units</p></td></tr><tr id="cf3363b7" class="ijRowEven"><td id="6a1095b8"><p id="b3b7ffe2">Container Memory</p></td><td id="1a040f31"><p id="a9be6b55">Set to 2048 MiB by default.</p></td></tr></tbody></table></div><p id="0bf9e4b6">3. Click <b id="cf2cf2e6">Next</b>. (Optional) In the dialog that appears, provide additional options if required.</p><p id="025eb594">4. Click <b id="b1633835">Next</b>, review  your settings, accept the creation of AWS roles.</p><aside class="note " data-title="" rel="025eb594" id="f684e56c"><p id="9ef4e348">In most cases Amazon ECS creates the service-linked role for you, if it does not already exist. If a user account creating the stack misses the appropriate permissions, the stack creating will fail with the following error: "Unable to assume the service linked role. Verify that the ECS service linked role exists".<br>In this case you can create a service linked role with the following command:</p><div class="code-block" data-lang="bash">
 aws iam create-service-linked-role --aws-service-name ecs.amazonaws.com

</div></aside><p id="4ef70d84">5. Click <b id="e5021edf">Сreate</b>. No other actions are required. It takes about 15 minutes for the template to deploy the whole stack. Once the deployment is ready, you will see the TeamCity server endpoint in the <i id="80777926">Output</i> section which points you to your TeamCity installation.</p><p id="3b587410">6. Access the TeamCity instance from your browser, create the administrators account and start using your TeamCity.</p></div></div><a name="Connectingtoserverandviewinglogs"></a><a name="Connecting-to-server-and-viewing-logs"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-Connectingtoserverandviewinglogs">Connecting to server and viewing logs</h2><p id="422a8453">To connect to the servers console, you need to use your instance private key:</p><div class="code-block" data-lang="bash">ssh -i &lt;path to private key\privatekey.pem&gt; ec2-user@&lt;server_IP_address&gt;

</div><p id="dcce60d3">To see  <code class="code">teamcity-agent.log</code> or <code class="code">teamcity-server.log</code>, just run the <code class="code">docker logs</code> command for the desired container. For example, for the server logs, run:</p><div class="code-block" data-lang="bash">
docker logs teamcity-server

</div></div><a name="NextSteps"></a><a name="Next-Steps"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-NextSteps">Next Steps</h2><p id="129407e9">Once you have TeamCity up and running, consider the following steps:</p><ul class="list _ul"><li class="list__item" id="2b0bf1de"><p>Use the <a href="setting-up-teamcity-for-amazon-ec2.html">Setting Up TeamCity for Amazon EC2</a> to run and connect more build agents to your server</p></li><li class="list__item" id="db8966da"><p>Configure TeamCity to use the S3 bucket as <a href="configuring-artifacts-storage.html#Amazon-S3-Support">Configuring Artifacts Storage</a>.</p></li></ul></div><a name="UpgradingTeamCityinAWS"></a><a name="Upgrading-TeamCity-in-AWS"></a><div class="chapter"><h2 id="RunningTeamCityStackinAWS-UpgradingTeamCityinAWS">Upgrading TeamCity in AWS</h2><p id="15e69505">To update TeamCity started from the CloudFormation template:</p><ol class="list _decimal"><li class="list__item" id="30ff0e59"><p>In the <a href="https://console.aws.amazon.com/cloudformation" data-external="true" target="_blank" rel="noopener noreferrer">AWS CloudFormation console</a>, from the list of stacks, select the running TeamCity stack and use the <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks-direct.html" data-external="true" target="_blank" rel="noopener noreferrer">Update Stack</a> option.</p></li><li class="list__item" id="3a48be6b"><p>You will be redirected to the <i id="84dbb276">Select Template</i> page: use the <i id="43978b63">Current Template</i> option and click <b id="606baa55">Next</b>.</p></li><li class="list__item" id="a8de10b3"><p>On the template settings page, enter the TeamCity version you want to update to. Note that if you previously used the TeamCity version tagged latest, you will now need to provide the actual version number as the <code class="code">latest</code> tag can be applied to the server only once.</p></li><li class="list__item" id="0aebb48e"><p>Click <b id="3eeee68b">Next</b>, provide additional options if required, review the new settings and click <b id="595dbdbe">Update</b>. Once the Update is complete, access the TeamCity web UI from the browser.</p></li><li class="list__item" id="7c378658"><p>If required, provide the <a href="super-user.html">Super User token</a>: to obtain it, you need to connect to your server instance, get the TeamCity server log as described <a href="#Connecting-to-server-and-viewing-logs">above</a>, and retrieve the maintenance token.</p></li><li class="list__item" id="eec9be8c"><p>Wait for the server to upgrade, log in to the TeamCity server and wait for the agent to upgrade and connect to the server.</p></li></ol><hr id="9053a960"><p id="b284daa1"><b id="d16419e6">See also:</b></p><p id="acb028d1"><b id="e08e3398">TeamCity blog</b>: <a href="https://blog.jetbrains.com/teamcity/2017/10/teamcity-aws/" data-external="true" target="_blank" rel="noopener noreferrer">The official TeamCity CloudFormation template</a></p><hr id="8585e074"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>