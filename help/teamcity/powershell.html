<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>PowerShell - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="PowerShell" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/managing-projects-and-build-configurations.md|Managing Projects and Build Configurations/creating-and-editing-build-configurations.md|Creating and Editing Build Configurations/configuring-build-steps.md|Configuring Build Steps/powershell.md|PowerShell" data-main-title="PowerShell" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/powershell.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="PowerShell" id="powershell.md">PowerShell</h1><p id="f7e17ec1">The <i id="2e67c33a">PowerShell</i> <a href="build-runner.html">build runner</a> is specifically designed to run PowerShell scripts.</p><p id="411980ec">The plugin responsible for PowerShell integration has been open-sourced <a href="https://github.com/JetBrains/teamcity-powershell" data-external="true" target="_blank" rel="noopener noreferrer">on GitHub</a>.</p><aside class="tip sideblock" data-title="" rel="411980ec" id="5a572132"><p id="0c819838">If you need to run a PowerShell script with elevated permissions, consider using the TeamCity <a href="https://github.com/JetBrains/teamcity-runas-plugin" data-external="true" target="_blank" rel="noopener noreferrer">RunAs plugin</a>.</p></aside><p id="0642ca11">On this page:</p><p id="2c8937ec"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#PowerShell-Cross-PlatformPowerShell">Cross-Platform PowerShell</a></li><li class="list__item"><a href="#PowerShell-DetectionofInstalledPowerShellonBuildAgents">Detection of Installed PowerShell on Build Agents</a></li><li class="list__item"><a href="#PowerShell-PowerShellSettings">PowerShell Settings</a></li><li class="list__item"><a href="#PowerShell-DockerSettings">Docker Settings</a><ul class="list _bullet"><li class="list__item"><a href="#PowerShell-CurrentLimitations">Current Limitations</a></li></ul></li><li class="list__item"><a href="#PowerShell-InteractionwithTeamCity">Interaction with TeamCity</a></li><li class="list__item"><a href="#PowerShell-ErrorHandling">Error Handling</a></li><li class="list__item"><a href="#PowerShell-HandlingOutput">Handling Output</a></li><li class="list__item"><a href="#PowerShell-TemporaryFiles">Temporary Files</a></li><li class="list__item"><a href="#PowerShell-DevelopmentLinks">Development Links</a></li></ul></p><a name="Cross-PlatformPowerShell"></a><a name="Cross-Platform-PowerShell"></a><div class="chapter"><h2 id="PowerShell-Cross-PlatformPowerShell">Cross-Platform PowerShell</h2><ul class="list _ul"><li class="list__item" id="f7de07ed"><p>Cross-platform PowerShell (<a href="https://blogs.msdn.microsoft.com/powershell/2018/01/10/powershell-core-6-0-generally-available-ga-and-supported/" data-external="true" target="_blank" rel="noopener noreferrer">PowerShell Core</a>) is supported on Windows, MacOS, and Linux: <a href="https://github.com/PowerShell/PowerShell#get-powershell" data-external="true" target="_blank" rel="noopener noreferrer">download a PowerShell package</a> for your platform and install it on the TeamCity agent.</p></li><li class="list__item" id="49997593"><p>Side-by-side installation of PowerShell Desktop and PowerShell Core is supported under Windows.</p></li></ul></div><a name="DetectionofInstalledPowerShellonBuildAgents"></a><a name="Detection-of-Installed-PowerShell-on-Build-Agents"></a><div class="chapter"><h2 id="PowerShell-DetectionofInstalledPowerShellonBuildAgents">Detection of Installed PowerShell on Build Agents</h2><p id="aae0c449">During startup, a TeamCity agent searches for the PowerShell installation in standard locations, such as <code class="code">Program Files</code> and <code class="code">Windows</code> directories. You can specify a custom location in the <code class="code">teamcity.powershell.detector.search.paths</code> <a href="predefined-build-parameters.html#Agent-Properties">agent property</a>, so the agent can detect PowerShell in this directory (and its children) as well.<br>To list multiple locations, separate their paths with <code class="code">;</code>.</p></div><a name="PowerShellSettings"></a><a name="PowerShell-Settings"></a><div class="chapter"><h2 id="PowerShell-PowerShellSettings">PowerShell Settings</h2><div class="table-wrapper"><table width="100%" id="50e709b4"><thead><tr id="f0b49dd3" class="ijRowHead"><th id="da7dede5"><p id="0b8141ba">Option</p></th><th id="9de14e52"><p id="444ecfcd">Description</p></th></tr></thead><tbody><tr id="6fc022e7" class="ijRowOdd"><td id="922ddb8c"><p id="838d0675">Version</p></td><td id="6c0e6ede"><p id="c5b9106d">List of PowerShell versions supported by TeamCity. It is passed to <code class="code">powershell.exe</code> as the <code class="code">-Version</code> command line argument.</p></td></tr><tr id="5d5e4483" class="ijRowEven"><td id="dea9a8fa"><p id="e9e697dc">PowerShell run mode</p></td><td id="a7cd618c"><p id="29d97d6c">Select the desired execution mode on a x64 machine:</p><p id="8ef0da83"><b id="148ae96a">Version</b></p><p id="edcb3065">Specify a version (for example, 1.0 or 2.0). It will be compared to the version installed on the agent, and an appropriate requirement will be added. For Core editions, it will be used as the lower bound. On Desktop editions, the exact version will be used (<code class="code">-Version</code> command line argument will be added).</p><p id="173586f5">If the version field is left blank, no lower bound on the version requirement will be added, no <code class="code">-Version</code> argument will be used on Desktop editions of PowerShell.</p><p id="b2a17eb1"><b id="51365d30">Platform</b></p><p id="689e5047">Select platform bitness:</p><ul class="list _ul"><li class="list__item" id="7b8008c1"><p><code class="code">x64</code> - 64-bit,  default, the corresponding requirement will be added</p></li><li class="list__item" id="c3588f34"><p><code class="code">x86</code> - 32-bit, the corresponding requirement will be added</p></li><li class="list__item" id="4fdab91e"><p><code class="code">Auto</code> - when it is selected, no platform requirement will be added to the build configuration, and if both 32-bit and 64-bit PowerShells are installed, 64-bit will be preferred.</p></li></ul><p id="63d524a9"><b id="9feb199d">Edition</b></p><p id="95d09c72">Select a PowerShell edition to be used: (<b id="67f91935">since TeamCity 2017.1</b>)</p><ul class="list _ul"><li class="list__item" id="0a1eec35"><p>Desktop - closed-source edition bundled with Windows, available only on Windows platforms.</p></li><li class="list__item" id="8801528f"><p>Core - open-source edition based on .NET Core, cross-platform, 64-bit only</p></li></ul></td></tr><tr id="ce5c4b6e" class="ijRowOdd"><td id="e6ae0fb3"><p id="3d00db73">Format stderr output as:</p></td><td id="459a4a6d"><p id="2a4911ba">Specify how the error output is handled by the runner:</p><ul class="list _ul"><li class="list__item" id="8b2ce5d9"><p><b id="8d9b6cc0">error</b>: any output to <code class="code">stderr</code> is handled as an error</p></li><li class="list__item" id="204a3054"><p><b id="21232347">warning</b>: default; any output to <code class="code">stderr</code> is handled as a warning</p></li></ul><aside class="tip sideblock" data-title="" rel="3ff51afc" id="4f5d77b2"><p id="6c991d67">To fail a build if "an error message is logged by build runner" (see <a href="build-failure-conditions.html">Build Failure Conditions</a>), change the default setting of the Error Output selector from <b id="378dcf8b">warning</b> to <b id="6549c40b">error</b>.</p></aside></td></tr><tr id="f5a1368d" class="ijRowEven"><td id="5c6e3278"><p id="37005185">Working directory</p></td><td id="838e684f"><p id="42f22d00">Specify the path to the <a href="build-working-directory.html">build working directory</a>.</p></td></tr><tr id="f627e302" class="ijRowOdd"><td id="b9fb2944"><p id="448d14d1">Script</p></td><td id="4469274a"><p id="7efc1245">Select whether you want to enter the script right in TeamCity, or specify a path to the script:</p><ul class="list _ul"><li class="list__item" id="be9d839f"><p><b id="22998691">File</b>: Enter the path to a PowerShell file. The path has to be relative to the checkout directory.</p></li><li class="list__item" id="f92fa87e"><p><b id="cfa89d43">Source</b>: Enter the PowerShell script source. Note that TeamCity <a href="configuring-build-parameters.html#Using-Build-Parameters-in-Build-Configuration-Settings">parameter references</a> will be replaced in the code.</p></li></ul><aside class="note " data-title="" rel="3d014f68" id="509febc0"><p id="92fa067e">There is an issue with PowerShell 2.0 not returning the correct exit code when the script contains explicitly defined parameters. As a <a href="https://youtrack.jetbrains.com/issue/TW-42996" data-external="true" target="_blank" rel="noopener noreferrer">workaround</a>, either upgrade your PowerShell or to use <code class="code">[Environment]::Exit(code)</code>.</p></aside></td></tr><tr id="801a7f23" class="ijRowEven"><td id="01740724"><p id="033cd679">Script execution mode</p></td><td id="1be093eb"><p id="e5931b21">Specify the PowerShell script execution mode. By default, PowerShell may not allow execution of arbitrary <code class="code">.ps1</code> files. TeamCity will try to supply the <code class="code">-ExecutionPolicy ByPass</code> argument. If you've selected <b id="8cae7fd0">Execute .ps1 script from external file</b>, your script should be signed or you should make PowerShell allow execution of arbitrary <code class="code">.ps1</code> files.  If the execution policy doesn't allow running your scripts, select <b id="f0ecabdf">Put script into PowerShell stdin</b> mode to avoid this issue.</p><p id="447d5eb8">The <code class="code">-Command</code> mode is deprecated and is not recommended for use with PowerShell of version greater than 1.0</p></td></tr><tr id="c7d37e91" class="ijRowOdd"><td id="25b2fc53"><p id="5b21659b">Script arguments</p></td><td id="60da290b"><p id="d0933105"><i id="c541d0e5">Available if "Script execution mode" option is set to "Execute .ps1 script from external file".</i></p><p id="7a3b8f96">Specify build parameters to be passed as arguments into the PowerShell script.<br>When using named arguments, follow this pattern: <code class="code">-&lt;script_argument1&gt; %build_parameter1% -&lt;script_argument2&gt; %build_parameter2%</code>.</p><aside class="note " data-title="" rel="7a3b8f96" id="b55a1e61"><p id="cc8dab81"><b id="608c7a3b">Escaping special symbols</b></p><p id="fe6e1d5d">TeamCity calls <code class="code">powershell.exe</code> from the console of your operating system (command prompt on Windows, bash or other on Linux).</p><p id="809ab2b4">If parameters containing special symbols are passed to your PowerShell script in double quotes, make sure these characters are properly escaped: use the escape rules depending on your interpreter, for example, on Windows, if a PowerShell script argument ends with a backslash, use the backslash as the escape symbol for TeamCity to correctly interpret it: <code class="code">"foo\\"</code>.</p></aside></td></tr><tr id="0ef9ee8d" class="ijRowEven"><td id="d825edba"><p id="2e8ba014">Additional command line parameters</p></td><td id="e346e38d"><p id="df9d9c50">Specify parameters to be passed to <code class="code">powershell.exe</code>.</p></td></tr></tbody></table></div></div><a name="DockerSettings"></a><a name="Docker-Settings"></a><div class="chapter"><h2 id="PowerShell-DockerSettings">Docker Settings</h2><p id="0c49aaaa">To enable support for Docker in PowerShell steps, run the TeamCity server with the <code class="code">-Dteamcity.docker.runners=jetbrains_powershell</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal property</a>.</p><p id="6b8e05b5">In this section, you can specify a Docker image which will be <a href="docker-wrapper.html">used to run the build step</a>.</p><a name="CurrentLimitations"></a><a name="Current-Limitations"></a><div class="chapter"><h3 id="PowerShell-CurrentLimitations">Current Limitations</h3><ul class="list _ul"><li class="list__item" id="f0a67f17"><p>Execution under Docker requires the PowerShell executable to be added to PATH</p></li><li class="list__item" id="f76291f0"><p>When using Docker to run the build step, only Docker-related build agent requirements are applied to the build</p></li><li class="list__item" id="d879608f"><p>Selection of Edition in PowerShell build step affects the executable being used (powershell.exe for Desktop, pwsh for Core)</p></li><li class="list__item" id="c8b69e63"><p>&lt;Auto&gt; defaults to <code class="code">pwsh</code> (Core)</p></li><li class="list__item" id="048a49c7"><p>To specify a custom PowerShell executable, the <code class="code">teamcity.powershell.virtual.executable</code> configuration parameter must be set to the full path of this executable inside the provided image</p></li><li class="list__item" id="b5eb6a03"><p>Current limitations of the Docker wrapper do not allow Linux containers running under Windows systems</p></li></ul></div></div><a name="InteractionwithTeamCity"></a><a name="Interaction-with-TeamCity"></a><div class="chapter"><h2 id="PowerShell-InteractionwithTeamCity">Interaction with TeamCity</h2><p id="fdb3817b">Attention must be paid when using PowerShell to interact with TeamCity through service messages. PowerShell tends to wrap strings written to the console with commands like <code class="code">Write-Output</code>, <code class="code">Write-Error</code> and similar (see <a href="http://youtrack.jetbrains.com/issue/TW-15080" data-external="true" target="_blank" rel="noopener noreferrer">TW-15080</a>). To avoid this behavior, either use the <code class="code">Write-Host</code> command, or adjust the buffer length manually:</p><div class="code-block" data-lang="bash">function Set-PSConsole {
  if (Test-Path env:TEAMCITY_VERSION) {
    try {
      $rawUI = (Get-Host).UI.RawUI
      $m = $rawUI.MaxPhysicalWindowSize.Width
      $rawUI.BufferSize = New-Object Management.Automation.Host.Size ([Math]::max($m, 500), $rawUI.BufferSize.Height)
      $rawUI.WindowSize = New-Object Management.Automation.Host.Size ($m, $rawUI.WindowSize.Height)
    } catch {}
  }
}

</div></div><a name="ErrorHandling"></a><a name="Error-Handling"></a><div class="chapter"><h2 id="PowerShell-ErrorHandling">Error Handling</h2><p id="2b701230">Due to <a href="http://connect.microsoft.com/PowerShell/feedback/details/777375/powershell-exe-does-not-set-an-exit-code-when-file-is-used" data-external="true" target="_blank" rel="noopener noreferrer">this issue</a> in PowerShell itself that causes zero exit code to be always returned to a caller, TeamCity cannot always detect whether the script has executed correctly or not. We recommend several approaches that can help in detecting script execution failures:</p><ul class="list _ul"><li class="list__item" id="5dcade83"><p id="3fe6107d"><i id="f73809b8">Manually catching exceptions and explicitly returning exit code</i><br>The PowerShell plugin does not use the cmd wrapper around <code class="code">powershell.exe</code>. It makes returning the explicit exit code possible.</p><div class="code-block" data-lang="bash">try {
# your code here
} Catch {
$ErrorMessage = $_.Exception.Message
Write-Output $ErrorMessage
exit(1)
}
</div></li><li class="list__item" id="3c9c1e6f"><p id="c68319be"><i id="2cff888c">Setting  to  and adding a build failure condition</i>:<br>In case syntax errors and exceptions are present, PowerShell writes them to <code class="code">stderr</code>. To make TeamCity fail the build, set <b id="37957bed">Error Output</b> option to <code class="code">Error</code> and add a <a href="build-failure-conditions.html#Common-build-failure-conditions">build failure condition</a> that will fail the build on any error output.</p></li><li class="list__item" id="b426df9a"><p id="e56d9481"><i id="dc82cc8d">Failing build on certain message in build log</i>:<br>Add a <a href="build-failure-conditions.html#Common-build-failure-conditions">build failure condition</a> that will fail the build on a certain message (say "POWERSHELL ERROR") in the build log.</p><div class="code-block" data-lang="bash">$ErrorMessage = "POWERSHELL ERROR"
try {
  # your code here
} Catch {
  Write-Output $ErrorMessage
  exit(1)
}
</div></li></ul></div><a name="HandlingOutput"></a><a name="Handling-Output"></a><div class="chapter"><h2 id="PowerShell-HandlingOutput">Handling Output</h2><p id="88ee43a8">To properly handle non-ASCII output from PowerShell, the correct encoding must be set both on the PowerShell side and on the TeamCity side.</p><ul class="list _ul"><li class="list__item" id="6769149b"><p id="03780559">To set the output encoding for PowerShell to UTF-8, add the following line to the beginning of your PowerShell script:</p><div class="code-block" data-lang="bash">[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
</div></li><li class="list__item" id="548b0b48"><p id="0be0088f">To set the encoding on the TeamCity agent side, either set the Java launch option <code class="code">-Dfile.encoding=UTF-8</code>, or set the build <a href="configuring-build-parameters.html">configuration parameter</a> <code class="code">teamcity.runner.commandline.stdstreams.encoding</code> value to <code class="code">UTF-8</code>.</p></li></ul></div><a name="TemporaryFiles"></a><a name="Temporary-Files"></a><div class="chapter"><h2 id="PowerShell-TemporaryFiles">Temporary Files</h2><p id="d70787b7">The TeamCity PowerShell plugin uses temporary files as an entry point; these files are created in the build temporary folder and removed after the PowerShell build step is finished. To keep the files, set the <code class="code">powershell.keep.generated</code> or <code class="code">teamcity.dont.delete.temp.files</code> configuration parameter to <code class="code">true</code>.</p></div><a name="DevelopmentLinks"></a><a name="Development-Links"></a><div class="chapter"><h2 id="PowerShell-DevelopmentLinks">Development Links</h2><p id="8fddadfa">The PowerShell support is implemented as an open-source plugin. For development links refer to the <a href="https://plugins.jetbrains.com/plugin/9041-powershell-runner" data-external="true" target="_blank" rel="noopener noreferrer">plugin's page</a>.</p><hr id="3ca5c0c6"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>