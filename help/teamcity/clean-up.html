<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>清理-帮助|团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Clean-Up" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/concepts.md|Concepts/clean-up.md|Clean-Up" data-main-title="Clean-Up" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/clean-up.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="clean-up.md" data-toc="Clean-Up">清理</h1><p id="cbb945f0">在此页</p><p id="4793c8cc"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#Clean-Up-ServerClean-upSettings">服务器清理设置</a><ul class="list _bullet"><li class="list__item"><a href="#Clean-Up-ManualClean-upLaunch">手动清理启动</a></li></ul></li><li class="list__item"><a href="#Clean-Up-ProjectClean-upRules">项目清理规则</a><ul class="list _bullet"><li class="list__item"><a href="#Clean-Up-Clean-upforDependentBuilds">清理相关构建</a></li><li class="list__item"><a href="#Clean-Up-Clean-upinBuildConfigurationswithFeatureBranches">具有功能分支的构建配置中的清理</a></li><li class="list__item"><a href="#Clean-Up-Clean-upofPersonalBuilds">清理个人建筑</a></li><li class="list__item"><a href="#Clean-Up-DeletedBuildConfigurationsCleanup">删除的生成配置清理</a></li></ul></li></ul><p></p><p id="9aedbdb6">TeamCity中的清理功能可自动删除属于旧版本的数据。</p><p id="ff0306f8">服务器清理配置可在服务器<b id="840dbf20">管理|管理中找到。清理设置</b> 。</p><p id="ff8f2a0a">与项目相关的清理设置在“ <b id="e620f2e0">项目设置” |“</b>配置”中进行配置。 <b id="e620f2e0">清理规则</b> 。</p><p id="f2a8ae29">建议配置清理规则，以删除过时的版本及其工件，从数据库和缓存中清除不必要的数据以释放磁盘空间，从TeamCity UI中删除版本并减少TeamCity的工作量。</p><p id="7df4738b">清理将删除存储在<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/system</code>并在数据库中。此外，在清理期间，服务器将执行各种维护任务（例如，重置VCS完整修补程序缓存）。</p><a name="ServerClean-upSettings"></a><a name="Server-Clean-up-Settings"></a><div class="chapter"><h2 id="Clean-Up-ServerClean-upSettings">服务器清理设置</h2><p id="16e83841">服务器设置在“ <b id="6f9c1f75">管理” |“</b>配置”中配置。 <b id="6f9c1f75">服务器管理|清理设置</b> 。</p><p id="8a122344">构建历史记录清理是作为后台进程运行的，这意味着没有服务器维护停机时间。</p><aside class="note " rel="8a122344" id="c513e216" data-title=""><p id="4c6a6987">如果使用默认的HSQL数据库，则在压缩HSQL数据库时会有短暂的服务器不可用时间。</p></aside><p id="6c7552d7">根据要清理的数据量，该过程可能会花费大量时间，在此期间服务器的性能可能会降低。因此，建议安排在非高峰时间进行清理。默认情况下，TeamCity将每天凌晨3.00开始清理。也可以<a href="#Manual-Clean-up-Launch">手动开始清理</a> 。</p><p id="362f91af">您还可以指定清理过程的时间限制。如果不是在指定的时间范围内清除了所有数据，则在下一个清理过程中将删除剩余的数据。</p><p id="9d606d22">启用清除功能后，TeamCity默认将服务器<a href="tracking-user-actions.html">审计记录</a>保留一年（365天）。</p><a name="ManualClean-upLaunch"></a><a name="Manual-Clean-up-Launch"></a><div class="chapter"><h3 id="Clean-Up-ManualClean-upLaunch">手动清理启动</h3><p id="3250a933">服务器清理设置的“ <b id="35d151ce">先前清理”</b>部分使您能够：</p><ul class="list _ul"><li class="list__item" id="345acd81"><p>查看有关先前服务器清理日期和持续时间的信息，以帮助您决定是否在给定时刻启动清理过程</p></li><li class="list__item" id="3d8932d9"><p>使用“立即<b id="8c7ab226">开始清理”</b>按钮手动运行清理。在清理过程中，TeamCity报告进度。如果需要，您可以停止清理过程，并且在下次清理期间将删除其余数据。</p></li></ul></div></div><a name="ProjectClean-upRules"></a><a name="Project-Clean-up-Rules"></a><div class="chapter"><h2 id="Clean-Up-ProjectClean-upRules">项目清理规则</h2><p id="fa5eab16">每个项目都配置<i id="4b03b0b4">了清理</i>规则，并定义了清理数据的时间和内容。</p><p id="d3630e08">要管理规则，请使用“ <b id="12cc9df1">项目设置” |</b> “ <b id="12cc9df1">项目设置”。 “清理规则”</b>页面，您可以在其中为项目或构建配置指定不同的规则。您也可以为模板指定它们，然后它们将被使用此模板的所有构建配置所继承。</p><p id="790ade9d">适用以下继承规则：</p><ul class="list _ul"><li class="list__item" id="a4182f82"><p>如果将清理规则分配给项目，则该规则将成为该项目中所有构建配置或子项目的默认规则</p></li><li class="list__item" id="267aa36a"><p>如果将清除规则分配给模板，则从该模板继承的所有配置都将成为默认规则，但是如果将清除规则分配给模板和项目，则该项目中的规则将覆盖该规则中的规则。模板</p></li><li class="list__item" id="230206aa"><p>如果将清理规则分配给构建配置，它将覆盖项目或基于其的模板中的清理规则。</p></li></ul><p id="a73c9976">在每个规则中，您可以定义要保留的成功构建的数量，和/或将构建保留在历史记录中的时间（例如，将构建保留7天）。</p><p id="6aad52e1">提供以下清理级别：</p><ul class="list _ul"><li class="list__item" id="2993f24a"><p><b id="b28e5224">工件</b> （保留所有其他数据，包括构建日志。<a href="build-artifact.html#Hidden-Artifacts">隐藏的文物</a>也被保留）；</p></li><li class="list__item" id="8c7ed650"><p><b id="0cccd6ef">历史记录</b> （删除所有构建数据，但<a href="statistic-charts.html">统计图表</a>中可见的构建统计值除外）；</p></li><li class="list__item" id="9df3b783"><p><b id="d52d1174">一切</b> （TeamCity中没有任何构建数据）。</p></li></ul><p id="6124dc23">每个级别都包括上面列出的一个或多个级别。</p><p id="155a7789">默认情况下，所有内容将永久保留。选择自定义设置时，可以为上述每个项目指定：</p><ul class="list _ul"><li class="list__item" id="69ca0bab"><p>天数。超过指定天数的内部版本将以指定级别进行清理。起点是上次构建的日期，而不是当前日期。一天等于24小时，而不是日历日；</p></li><li class="list__item" id="1a93d079"><p>成功构建的数量。只有早于最后一个匹配的成功构建的版本才会以指定的级别进行清理（保留所有成功构建之间的所有失败构建）。仅当构建配置中的构建成功时才考虑该规则。</p></li></ul><p id="9fc0b704">当同时指定了两个条件时，实际上将仅删除必须根据所有规则进行清理的内部版本：TeamCity根据每个规则查找要保留的最旧的内部版本，然后清除比找到的两个中最旧的版本更旧的所有内部版本。</p><p id="47259d36">对于<b id="dcce1136">工件</b>级别，您还可以指定工件名称的模式：与指定模式匹配的工件将被清除/排除在清除之外。<a href="http://ant.apache.org/manual/dirtasks.html#patterns" rel="noopener noreferrer" data-external="true" target="_blank">在类似Ant的模式</a>下使用换行符分隔的规则。例如：</p><ul class="list _ul"><li class="list__item" id="d0a8018e"><p>要使用“文件”作为名称的一部分来清理工件，请使用以下语法： <code class="code">+:**/file*.*</code> 。</p></li><li class="list__item" id="36e83e01"><p>排除<code class="code">*.jar</code>与神器<code class="code">file</code>作为清理工作的一部分名称，请使用<code class="code">-:**/file*.jar</code> 。</p></li></ul><p id="77041730">有些构建会保留其所有数据，并且在清理过程中不会受到影响。这些是：</p><ul class="list _ul"><li class="list__item" id="ba22865a"><p><a href="pinned-build.html">固定建筑</a> ;</p></li><li class="list__item" id="ba911558"><p>当在构建配置中启用依赖项的“防止清理”选项时，在其他构建<a href="configuring-dependencies.html">中将其</a>用作<a href="configuring-dependencies.html">shanpshot依赖项</a>的<a href="configuring-dependencies.html">构件</a> 。请参阅下面的<a href="#Clean-up-for-Dependent-Builds">从属构建清理</a> 。这样的版本标有<img alt="link.png" title="link.png" src="/help/img/teamcity/2019.1/link.png" id="6c24e05e" width="16" height="16" class="inline-icon-16">构建历史记录列表中的图标；</p></li><li class="list__item" id="62e39351"><p>不到一天前删除的构建配置的构建。</p></li></ul><a name="Clean-upforDependentBuilds"></a><a name="Clean-up-for-Dependent-Builds"></a><div class="chapter"><h3 id="Clean-Up-Clean-upforDependentBuilds">清理相关构建</h3><p id="b46aa271">“ <b id="e798c2a6">编辑清理规则”</b>对话框的“ <b id="6974b861">依赖关系”</b>部分中的设置会影响当前构建配置的构建所依赖的构建中工件的清理。</p><p id="66a56113">TeamCity始终保留在其他版本中用作<a href="dependent-build.html#Snapshot-Dependency">快照依赖项</a>的版本。在删除依赖的构建之前，不会通过清理过程从构建历史中删除这些构建。可以根据以下选项删除这些构建的工件。TeamCity可以选择保留构建及其工件，这些工件及其工件由<a href="dependent-build.html#Artifact-Dependency">工件依赖关系使用</a> 。</p><ul class="list _ul"><li class="list__item" id="ce17aa30"><p><b id="af39ec2b">使用默认</b>选择使用默认清除规则中配置的选项。</p></li><li class="list__item" id="56f87039"><p><b id="aaa5d74f">防止清除</b>选择可以保护被用作当前构建配置的构件或快照依赖项的源的构件（及其构件）。</p></li><li class="list__item" id="cbf0317d"><p><b id="5f76f699">不阻止清除</b> （默认）选项会使依赖项构建的与清理相关的处理无视当前构建配置的构建使用它们的事实。</p></li></ul><p id="a4dfd33e">例：</p><p id="3d5aec9f">例如，从属构建配置A对B具有工件依赖关系。如果对A使用了“ <b id="130bcd80">防止清理”</b>选项，则在清洁构建时将不会处理为A的构建提供工件的B的构建。他们的文物将被保留。</p><p id="13b3577e">存在一个<a href="https://youtrack.jetbrains.com/issue/TW-59344" rel="noopener noreferrer" data-external="true" target="_blank">已知的问题</a> ：如果具有快照依赖关系的构建通过工件依赖关系使用构建，则即使依赖构建的构建配置中设置了“ <b id="28fae954">请勿阻止清理”</b>选项，原始工件依赖关系也是如此。不会清除内部版本及其工件，就像在从属内部版本配置中设置了“ <b id="2cc2f44d">防止清除”</b>选项一样。</p></div><a name="Clean-upinBuildConfigurationswithFeatureBranches"></a><a name="Clean-up-in-Build-Configurations-with-Feature-Branches"></a><div class="chapter"><h3 id="Clean-Up-Clean-upinBuildConfigurationswithFeatureBranches">具有功能分支的构建配置中的清理</h3><p id="40dc2920">如果构建配置具有多个<a href="working-with-feature-branches.html">分支的</a>构建，则在应用清理规则之前，TeamCity将该配置的构建历史分为几组。TeamCity为每个<a href="working-with-feature-branches.html#Active-branches">活动分支</a>创建一个组，并为非活动分支的所有构建创建一个组。然后将清理规则独立地应用于每个组。</p></div><a name="Clean-upofPersonalBuilds"></a><a name="Clean-up-of-Personal-Builds"></a><div class="chapter"><h3 id="Clean-Up-Clean-upofPersonalBuilds">清理个人建筑</h3><p id="edc6141a">清理规则分别适用于非个人版本，然后适用于个人版本。也就是说，如果您有保留3个成功构建的规则，则将保留3个非个人构建和3个个人构建（按照上述说明，在每个分支组中）。</p></div><a name="DeletedBuildConfigurationsCleanup"></a><a name="Deleted-Build-Configurations-Cleanup"></a><div class="chapter"><h3 id="Clean-Up-DeletedBuildConfigurationsCleanup">删除的生成配置清理</h3><p id="4a47f9f3">删除项目或构建配置时，仅在清除后经过5天（432、000秒）的情况下，才会在清理过程中删除相应的构建数据。要更改超时，请设置<code class="code">teamcity.deletedBuildTypes.cleanupTimeout</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性</a>到所需的秒数，以保护数据不被删除。</p><hr id="b11895d5"><p id="bd9cd2f6"><b id="62c3d504">也可以看看：</b></p><p id="3e373725"><b id="699a04f7">概念</b> ： <a href="dependent-build.html">依赖构建</a></p><hr id="8c69c68a"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>