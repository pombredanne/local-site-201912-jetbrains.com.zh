<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>设置和运行其他构建代理-帮助|帮助团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Setting up and Running Additional Build Agents" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/setting-up-and-running-additional-build-agents.md|Setting up and Running Additional Build Agents/build-agent-configuration.md|Build Agent Configuration" data-main-title="Setting up and Running Additional Build Agents" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/setting-up-and-running-additional-build-agents.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="setting-up-and-running-additional-build-agents.md" data-toc="Setting up and Running Additional Build Agents">设置并运行其他构建代理</h1><p id="e4e36b96">在开始定制项目和创建构建配置之前，需要配置<a href="build-agent.html">构建代理</a> 。在继续进行代理程序安装之前，请查看<a href="#Agent-Server-Data-Transfers">代理程序-服务器通信</a>和<a href="#Prerequisites">前提条件</a>部分。</p><p id="138519c9">在此页：</p><p id="ec993288"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Prerequisites">先决条件</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-NecessaryOSandenvironmentpermissions">必要的操作系统和环境权限</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Common">共同</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Windows">视窗</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Linux">的Linux</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Build-relatedPermissions">与构建相关的权限</a></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Agent-ServerDataTransfers">代理服务器数据传输</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-UnidirectionalAgent-to-ServerCommunication">单向代理到服务器通信</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-BidirectionalCommunication">双向通讯</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ChangingCommunicationProtocol">更改通讯协议</a></li></ul></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingAdditionalBuildAgents">安装其他构建代理</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaWindowsinstaller">通过Windows安装程序进行安装</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaDockerAgentImage">通过Docker Agent映像安装</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaZIPFile">通过ZIP文件安装</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaAgentPush">通过Agent Push安装</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-RemoteHostRequirements">远程主机要求</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Installation">安装</a></li></ul></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-StartingtheBuildAgent">启动构建代理</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ManualStart">手动启动</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticStart">自动启动</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderWindows">Windows下自动启动代理</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-BuildAgentasaWindowsService">Build Agent作为Windows服务</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderLinux">在Linux下自动启动代理</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartundermacOS">在macOS下自动启动代理</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-LaunchAgentApproach">LaunchAgent方法</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ConfigureaSecondBuildAgentonMacOS">在Mac OS上配置第二个Build Agent</a></li></ul></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-StoppingtheBuildAgent">停止构建代理</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-StoppingtheAgentServiceonMacOS">在Mac OS上停止代理服务</a></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ConfiguringJava">配置Java</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-UpgradingJavaonAgents">在代理上升级Java</a></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingSeveralBuildAgentsontheSameMachine">在同一台计算机上安装多个构建代理</a></li></ul><p></p><aside class="tip sideblock" rel="ec993288" id="34a7aeae" data-title=""><p id="6ba58f49">如果您安装与Tomcat Servlet容器捆绑在一起的TeamCity，或者使用Windows的TeamCity安装程序，则服务器和一个构建代理都安装在同一台计算机上。由于<a href="installing-and-configuring-the-teamcity-server.html#Configuring-Server-for-Production-Use">出于</a> <a href="how-to.html#TeamCity-Security-Notes">安全考虑，</a>并且由于构建过程会降低Web UI和整个TeamCity服务器功能的响应速度，因此不建议将其用于<a href="installing-and-configuring-the-teamcity-server.html#Configuring-Server-for-Production-Use">生产目的</a> 。如果需要更多的构建代理，请执行以下步骤。如果您需要代理运行不同于TeamCity服务器的操作系统，请执行以下步骤。对于生产安装，建议调整<a href="configuring-build-agent-startup-properties.html">代理的JVM参数</a>以包括<code class="code">-server</code>选项。</p></aside><a name="Prerequisites"></a><a name="Prerequisites"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-Prerequisites">先决条件</h2><a name="NecessaryOSandenvironmentpermissions"></a><a name="Necessary-OS-and-environment-permissions"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-NecessaryOSandenvironmentpermissions">必要的操作系统和环境权限</h3><p id="5b1009d9">在安装之前，请查看“ <a href="known-issues.html#Conflicting-Software">软件冲突”部分</a> 。如有任何问题，请确保未使用任何冲突的软件。</p><p id="161d54c7">请注意，要运行TeamCity构建代理，用于运行代理的环境和用户帐户必须符合以下要求：</p><p id="06515ffb"><a name="Network"></a><a name="SettingupandRunningAdditionalBuildAgents-Network"></a></p><a name="Common"></a><a name="Common"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Common">共同</h4><p id="597dcaaf">代理程序（java）必须</p><ul class="list _ul"><li class="list__item" id="2eb8974e"><p>能够打开通过服务器配置的服务器URL的出站HTTP连接<code class="code">serverUrl</code>物业<a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a>文件（通常与您在浏览器中用来查看TeamCity UI的地址相同）。将请求发送到配置的URL下的路径不应受到限制。另请参阅推荐的<a href="how-to.html#Set-Up-TeamCity-behind-a-Proxy-Server">反向代理设置</a> 。确保代理或服务器计算机上安装的所有防火墙，网络配置和代理（如果有）均符合这些要求。</p></li><li class="list__item" id="14263da5"><p>递归对以下目录具有完全权限（读/写/删除）： <a href="agent-home-directory.html"><code class="code"><agent home></code></a> （自动代理升级和代理工具支持所必需）， <a href="agent-work-directory.html"><code class="code"><agent work></code></a> ， <a href="agent-home-directory.html#Agent-Directories"><code class="code"><agent temp></code></a>和代理系统目录（由<code class="code">workDir</code> ， <code class="code">tempDir</code>和<code class="code">systemDir</code>中的参数<code class="code">buildAgent.properties</code>文件）</p></li><li class="list__item" id="3ec3c227"><p>能够启动流程（运行构建）。</p></li><li class="list__item" id="ba4aa6f8"><p>能够使用以下父进程出口启动嵌套进程（在代理升级期间使用）</p></li></ul><p id="500dd139"><a name="Windows"></a><a name="SettingupandRunningAdditionalBuildAgents-Windows"></a></p></div><a name="Windows"></a><a name="Windows"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Windows">视窗</h4><ul class="list _ul"><li class="list__item" id="df2471f4"><p>作为服务登录（作为Windows服务运行）</p></li><li class="list__item" id="1f79786b"><p>启动/停止服务（要作为Windows服务运行，代理升级才能正常运行，另请参阅<a href="https://support.microsoft.com/en-us/help/325349/how-to-grant-users-rights-to-manage-services-in-windows-server-2003" rel="noopener noreferrer" data-external="true" target="_blank">Microsoft KB文章</a> ）</p></li><li class="list__item" id="96d07856"><p>调试程序（需要执行进程转储功能）</p></li><li class="list__item" id="83d14f70"><p>重新启动计算机（代理重新启动功能需要）</p></li><li class="list__item" id="9988c5c4"><p>为了能够<a href="performance-monitor.html">监视</a>作为Windows <a href="#Build-Agent-as-a-Windows-Service">服务</a>运行的构建代理的<a href="performance-monitor.html">性能</a> ，启动代理的用户必须是Performance Monitor Users组的成员。</p></li></ul><aside class="note " rel="08812599" id="9f1887dc" data-title=""><p id="a37c46c8">要为非特权用户授予必要的权限，请参阅<a href="https://support.microsoft.com/en-us/kb/325349" rel="noopener noreferrer" data-external="true" target="_blank">Microsoft文档</a> 。您可以使用Microsoft <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=e8ba3e56-d8fe-4a91-93cf-ed6985e3927b&displaylang=en" rel="noopener noreferrer" data-external="true" target="_blank">SubInACL</a>实用程序（用于使管理员直接编辑安全信息的命令行工具）来分配管理服务的权限。该工具使用以下语法：</p><div class="code-block" data-lang="bash">SUBINACL / SERVICE \\ MachineName \ ServiceName / GRANT = [DomainName] UserName [= Access]</div><p id="40092229">例如，要授予启动/停止权限，您可能需要执行以下命令：</p><div class="code-block" data-lang="bash">subinacl.exe / service TCBuildAgent / grant = <user name="" login="">= PTO</user></div></aside></div><a name="Linux"></a><a name="Linux"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Linux">的Linux</h4><ul class="list _ul"><li class="list__item" id="4750e8d7"><p>用户必须能够运行<code class="code">shutdown</code>命令（用于在云环境中运行时的代理计算机重新启动功能和计算机关闭功能）</p></li><li class="list__item" id="3e0d66bb"><p>使用systemd时，不应杀死主进程出口上的进程（使用<a href="https://serverfault.com/questions/660063/teamcity-build-agent-gets-killed-by-systemd-when-upgrading" rel="noopener noreferrer" data-external="true" target="_blank">RemainAfterExit = yes</a> ）</p></li></ul></div><a name="Build-relatedPermissions"></a><a name="Build-related-Permissions"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Build-relatedPermissions">与构建相关的权限</h4><p id="dd9a3873">构建过程由TeamCity代理启动，因此共享环境，并在TeamCity代理使用的OS用户下执行。确保已相应配置TeamCity代理。有关相关的Windows服务限制，请参阅<a href="known-issues.html">已知问题</a> 。</p></div></div><a name="Agent-ServerDataTransfers"></a><a name="Agent-Server-Data-Transfers"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-Agent-ServerDataTransfers">代理服务器数据传输</h3><p id="016ae604">TeamCity代理通过配置为URL的URL连接到TeamCity服务器。 <code class="code">serverUrl</code>代理属性。这称为<a href="#Unidirectional-Agent-to-Server-Communication">单向</a>代理到服务器连接。如果进行了专门配置，TeamCity代理可以使用旧版<a href="#Bidirectional-Communication">双向通信</a> ，这也需要建立从服务器到代理的连接。要查看特定服务器的代理服务器通信是单向还是双向，请导航至“ <b id="d0865dd5">代理|代理”。 <agent name="">| “代理摘要”</agent></b>选项卡的“ <b id="0c044eb8">详细信息”</b>部分的“ <b id="cf6acc63">通信协议”</b> 。</p><a name="UnidirectionalAgent-to-ServerCommunication"></a><a name="Unidirectional-Agent-to-Server-Communication"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-UnidirectionalAgent-to-ServerCommunication">单向代理到服务器通信</h4><p id="756566e8">代理通过轮询协议使用单向代理到服务器的连接：代理建立与TeamCity Server的HTTP（S）连接，并定期轮询服务器以获取服务器命令。</p><p id="2f4868bf">建议使用<b id="b8eb0f04">HTTPS</b>进行代理到服务器的通信（请参阅相关的<a href="how-to.html#Configure-HTTPS-for-TeamCity-Web-UI">服务器配置说明</a> ）。如果将代理程序和服务器部署到安全环境中，则可以将代理程序配置为使用纯HTTP URL来连接到服务器，因为这样可以减少传输开销。请注意，通过从代理建立的连接到服务器的连接传输的数据包括构建设置，存储库访问凭证和密钥，存储库源，构建工件，构建进度消息和构建日志。如果使用HTTP协议，则可以通过“中间人”攻击来破坏数据。</p></div><a name="BidirectionalCommunication"></a><a name="Bidirectional-Communication"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-BidirectionalCommunication">双向通讯</h4><p id="4456f9b4">双向通信是代理程序与服务器之间的传统连接，需要专门启用它（请参见下面的示例）。启用后，它要求代理通过HTTP（或HTTPS）连接到服务器，服务器需要通过HTTP连接到代理。</p><p id="9f8776e8">通过服务器建立的连接传递给代理的数据会通过不安全的HTTP通道传递，因此可能会暴露给任何可能监听服务器和代理之间流量的第三方。此外，由于代理和服务器可以相互发送“命令”，因此可以发送HTTP请求和捕获响应的攻击者从理论上讲可以诱使代理执行任意命令并执行其他具有安全影响的动作。</p><p id="421bc93e">TeamCity代理使用的通信协议由以下值确定： <code class="code">teamcity.agent.communicationProtocols</code>服务器<a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性</a> 。该属性接受以逗号分隔的协议的有序列表（ <code class="code">polling</code>和<code class="code">xml-rpc</code>支持的协议名称），并设置为<code class="code">teamcity.agent.communicationProtocols=polling</code>默认。如果指定了多个协议，则代理将尝试使用此列表中的第一个协议进行连接，如果失败，它将尝试通过列表中的第二个协议进行连接。 <code class="code">polling</code>表示单向协议， <code class="code">xml-rpc</code> -较旧的双向通讯。</p></div><a name="ChangingCommunicationProtocol"></a><a name="Changing-Communication-Protocol"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-ChangingCommunicationProtocol">更改通讯协议</h4><ul class="list _ul"><li class="list__item" id="559e0eff"><p>要更改<b id="2f3eb968">所有座席</b>的通信协议，请设置TeamCity服务器<code class="code">teamcity.agent.communicationProtocols</code>服务器<a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性</a> 。更改后，所有连接到服务器的代理将使用新设置。要更改现有连接的协议，请重新启动TeamCity服务器。</p></li><li class="list__item" id="85d54273"><p>默认情况下，未配置代理的属性。当代理首次连接到服务器时，它会从TeamCity服务器接收它。要在初始代理配置后更改<b id="b6112e70">单个代理</b>的协议，请更改<code class="code">teamcity.agent.communicationProtocols</code> <a href="build-agent-configuration.html">代理</a>属性中<a href="build-agent-configuration.html">的属性</a> 。代理的属性将覆盖服务器属性。更改后，代理将在完成正在运行的构建（如果有）时自动重新启动。</p></li><li class="list__item" id="82f374ab"><p>将版本为2018.1+的TeamCity代理连接到9.1之前的版本的TeamCity服务器时（例如，在升级后回滚之后），将需要更新代理以使用<code class="code">xml-rpc</code>协议（或可以重新安装），以便能够连接到较旧的服务器以执行自我更新过程。</p></li></ul></div></div></div><a name="InstallingAdditionalBuildAgents"></a><a name="Installing-Additional-Build-Agents"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-InstallingAdditionalBuildAgents">安装其他构建代理</h2><p id="c63f235d">1。使用以下任一选项安装构建代理：</p><ul class="list _ul"><li class="list__item" id="db7dcf4b"><p><a href="#Installing-via-Windows-installer">使用Windows安装程序</a> （仅Windows）</p></li><li class="list__item" id="ef84b60b"><p><a href="#Installing-via-ZIP-File">通过下载zip文件并手动安装</a> （在任何平台上）</p></li><li class="list__item" id="b218789f"><p>通过<a href="#Installing-via-Docker-Agent-Image">Docker Agent Image</a>选项基于官方<a href="https://hub.docker.com/r/jetbrains/teamcity-agent/" rel="noopener noreferrer" data-external="true" target="_blank">TeamCity Agent映像</a>准备Docker容器</p></li></ul><p id="0ac4f854">2。安装后，配置代理，在其中指定其名称和TeamCity服务器的地址。 <a href="build-agent-configuration.html"><code class="code">conf/buildAgent.properties</code></a>文件。</p><p id="9c4a3ee2">3。<a href="#Starting-the-Build-Agent">启动</a>代理。如果代理似乎无法正常运行，请检查<a href="viewing-build-agent-logs.html">代理日志</a> 。</p><p id="0cd262ea">当新安装的代理程序首次连接到服务器时，它将出现在<code class="code">Agents</code>页， <code class="code">Unauthorized agents</code>拥有授权权限的管理员/用户可以看到的标签。除非在TeamCity Web UI中得到授权，否则代理将不会运行构建。默认情况下，与服务器在同一计算机上运行的代理是经过授权的。</p><p id="c54b519f">授权代理的数量受服务器上代理许可证数量的限制。请参阅“ <a href="licensing-policy.html">许可政策”</a>下的更多内容。</p><a name="InstallingviaWindowsinstaller"></a><a name="Installing-via-Windows-installer"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaWindowsinstaller">通过Windows安装程序进行安装</h3><ol class="list _decimal"><li class="list__item" id="7a5a9540"><p>在TeamCity Web UI中，导航到“ <b id="9ad7c27f">代理”</b>选项卡。</p></li><li class="list__item" id="1e4a6d70"><p>单击“ <b id="42b5f0b9">安装构建代理”</b>链接，然后选择“ <b id="e6280672">Windows Installer”</b>以下载安装程序。</p></li><li class="list__item" id="04ee7388"><p>在代理上，运行<code class="code">agentInstaller.exe</code> Windows Installer，然后按照安装说明进行操作。</p></li></ol><aside class="note " rel="2f81fec7" id="c6fbd55b" data-title=""><p id="c666e3d8">确保用于运行代理服务的用户帐户具有适当的<a href="#Necessary-OS-and-environment-permissions">权限</a></p></aside></div><a name="InstallingviaDockerAgentImage"></a><a name="Installing-via-Docker-Agent-Image"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaDockerAgentImage">通过Docker Agent映像安装</h3><ol class="list _decimal"><li class="list__item" id="b6afc615"><p>在TeamCity Web UI中，导航到“ <b id="5bd315bd">代理”</b>选项卡。</p></li><li class="list__item" id="d9e4b442"><p>点击<b id="0ece0f95">Install Build Agents</b>链接，然后选择<i id="74e68bf1">Docker Agent Image</i> 。</p></li><li class="list__item" id="c7cdebb1"><p>请按照打开的<a href="https://hub.docker.com/r/jetbrains/teamcity-agent/" rel="noopener noreferrer" data-external="true" target="_blank">页面</a>上的说明进行操作。</p></li></ol></div><a name="InstallingviaZIPFile"></a><a name="Installing-via-ZIP-File"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaZIPFile">通过ZIP文件安装</h3><ol class="list _decimal"><li class="list__item" id="ab8b8125"><p>确保在代理计算机上正确安装了JDK（JRE）1.8.0_161或更高版本（支持Java 6-10，但建议使用1.8.0_161 +）。</p></li><li class="list__item" id="c4d97058"><p>在代理计算机上，确保<code class="code">JRE_HOME</code>要么<code class="code">JAVA_HOME</code>设置了环境变量（分别指向已安装的JRE或JDK目录）。</p></li><li class="list__item" id="3d578f0c"><p>在TeamCity Web UI中，导航到“ <b id="f0e58a83">代理”</b>选项卡。</p></li><li class="list__item" id="639becf3"><p>单击“ <b id="510b4fa9">安装构建代理”</b>链接，然后选择“ <b id="6ad81876">Zip文件分发”</b>以下载存档。</p></li><li class="list__item" id="74d03f93"><p>将下载的文件解压缩到所需目录。</p></li><li class="list__item" id="aee79587"><p>导航到<code class="code"><installation path>\conf</code>目录中，找到名为<code class="code">buildAgent.dist.properties</code>并将其重命名为<code class="code">buildAgent.properties</code> 。</p></li><li class="list__item" id="cb5dc4a5"><p>编辑<code class="code">buildAgent.properties</code>文件以指定TeamCity服务器URL（建议使用HTTPS，请参阅<a href="#Agent-Server-Data-Transfers">注释</a> ）和代理名称。有关<a href="build-agent-configuration.html">代理配置</a>的详细信息，请参阅“ <a href="build-agent-configuration.html">构建代理配置”</a>部分。</p></li><li class="list__item" id="40c2a9c3"><p>在Linux下，您可能需要授予执行权限<code class="code">bin/agent.sh</code>外壳脚本。</p></li></ol><aside class="tip sideblock" rel="bd24e8b1" id="dab15784" data-title=""><p id="0364d810">在Windows上，您可能还想安装<a href="#Build-Agent-as-a-Windows-Service">构建代理程序Windows服务，</a>而不是手动启动代理程序。</p></aside></div><a name="InstallingviaAgentPush"></a><a name="Installing-via-Agent-Push"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaAgentPush">通过Agent Push安装</h3><p id="df97608a">TeamCity提供的功能允许将构建代理安装到远程主机。当前支持的服务器主机平台和构建代理目标的组合是：</p><ul class="list _ul"><li class="list__item" id="44783bb8"><p>从基于Unix的TeamCity服务器上，只能将构建代理安装到Unix主机（通过SSH）</p></li><li class="list__item" id="77fe767e"><p>从基于Windows的TeamCity服务器，可以将构建代理安装到Unix（通过SSH）或Windows（通过psexec）主机</p></li></ul><aside class="note " rel="624aae60" id="a5944b20" data-title=""><p id="2cc7648a"><b id="d88a24b7">SSH注意</b></p><p id="587b221f">确保根据首选的身份验证方法在目标主机上启用了“密码”或“公钥”身份验证。</p></aside><a name="RemoteHostRequirements"></a><a name="Remote-Host-Requirements"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-RemoteHostRequirements">远程主机要求</h4><p id="8c823d5e">远程主机有一些要求：</p><div class="table-wrapper"><table width="100%" id="a0197b14"><thead><tr id="5012d794" class="ijRowHead"><th id="6341e94b"><p id="148c8b31">平台</p></th><th id="be8c63ff"><p id="f642cf64">先决条件</p></th></tr></thead><tbody><tr id="f76b649a" class="ijRowOdd"><td id="b226cfb7"><p id="95270547">的Linux</p></td><td id="420f1ea4"><p id="a84e56f5">1。已安装JDK（JRE）6-10（ <b id="ad6ba0d8">建议使用1.8.0_161或更高版本</b> ）。JVM应该可以通过<code class="code">JAVA_HOME</code> （ <code class="code">JRE_HOME</code> ）全局环境变量或位于全局路径中（即不在用户的.bashrc文件中，依此类推）</p><p id="d79a1329">2。的<code class="code">unzip</code>效用。</p><p id="07b7b0fe">3。要么<code class="code">wget</code>要么<code class="code">curl</code> 。</p></td></tr><tr id="a6051499" class="ijRowEven"><td id="67baa088"><p id="a73f4bde">视窗</p></td><td id="9850272f"><p id="0554eb0d">1。已安装JDK / JRE 6-10（ <b id="71c28f83">建议使用</b> <b id="325fbed8">1.8.0_161或更高版本</b> ）。</p><p id="b549ba9d">2。 <code class="code">Sysinternals psexec.exe</code>在TeamCity服务器上。它必须在路径中可访问。您可以使用<b id="836d0f96">管理</b> |安装。 <b id="2012311b">工具</b>页面。请注意，PsExec将其他要求应用于远程Windows主机（例如，必须可以访问<a href="http://en.wikipedia.org/wiki/Administrative_share#How_to_enable_in_Windows_Vista_and_Windows_7" rel="noopener noreferrer" data-external="true" target="_blank">远程主机上的管理共享</a> ）。了解有关<a href="http://technet.microsoft.com/en-us/sysinternals/bb897553" rel="noopener noreferrer" data-external="true" target="_blank">PsExec的</a>更多信息。</p></td></tr></tbody></table></div></div><a name="Installation"></a><a name="Installation"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Installation">安装</h4><ol class="list _decimal"><li class="list__item" id="efa5c62c"><p>在TeamCity Server Web UI中，导航到“ <b id="b0d9d5d3">代理”</b> |“ <b id="b0d9d5d3">代理”</b> 。 <b id="1bea1962">代理推送</b>选项卡，然后单击<b id="54358157">安装代理...。</b><br>如果要对多个目标主机使用相同的设置，则可以使用这些设置<b id="1267602f">创建一个预设</b> ，并在每次将代理安装到另一个远程主机时都使用该<b id="1267602f">预设</b> 。</p></li><li class="list__item" id="aebd4d97"><p>在“ <b id="841871bc">安装代理”</b>对话框中，选择一个保存的预设或选择“使用自定义设置”，指定目标主机平台并配置相应的设置。通过SSH将代理推送到Linux系统支持指定为<b id="9b85ce8c">SSH端口</b>参数的自定义端口（默认为22）。预设中指定的端口可以在主机名中覆盖，例如<code class="code">hostname.domain:2222</code> ，在实际安装代理程序期间。</p></li><li class="list__item" id="2f7a685e"><p>您可能需要下载<code class="code">Sysinternals psexec.exe</code> ，在这种情况下，您会看到相应的警告以及指向<b id="3916f123">管理</b> |链接的链接。您可以在“ <b id="06f6501a">工具”</b>页面上下载它。</p></li></ol><p id="b1cf5fbc">您可以在“ <a href="agent-cloud-profile.html">代理程序云”配置文件</a>设置中使用“代理程序推送”预设来将构建代理<a href="agent-cloud-profile.html">程序</a>自动安装到已启动的云实例。</p></div></div></div><a name="StartingtheBuildAgent"></a><a name="Starting-the-Build-Agent"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-StartingtheBuildAgent">启动构建代理</h2><p id="4a9d602e">TeamCity构建代理可以手动启动，也可以配置为自动启动。</p><a name="ManualStart"></a><a name="Manual-Start"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-ManualStart">手动启动</h3><p id="ba7d1092"><b id="ff051525">要手动启动代理</b> ，请运行以下脚本：</p><ul class="list _ul"><li class="list__item" id="2106808e"><p>对于Windows：<code class="code"><installation path>\bin\agent.bat start</code></p></li><li class="list__item" id="c1396152"><p>对于Linux和macOS：<code class="code"><installation path>\bin\agent.sh start</code></p></li></ul></div><a name="AutomaticStart"></a><a name="Automatic-Start"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-AutomaticStart">自动启动</h3><p id="5f217f70">要将代理配置为<b id="c09657db">自动启动</b> ，请参见相应部分：</p><ul class="list _ul"><li class="list__item" id="2088e90a"><a href="#Automatic-Agent-Start-under-Windows">视窗</a></li><li class="list__item" id="6b0f7c8f"><p><a href="#Automatic-Agent-Start-under-Linux">Linux</a> ：使用以下命令配置守护进程<code class="code">agent.sh start</code>命令启动它并<code class="code">agent.sh stop</code>命令停止它。</p></li><li class="list__item" id="d8399783"><a href="#Automatic-Agent-Start-under-macOS">苹果系统</a></li></ul><a name="AutomaticAgentStartunderWindows"></a><a name="Automatic-Agent-Start-under-Windows"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderWindows">Windows下自动启动代理</h4><p id="d1b9a05c">要在Windows下的计算机启动时自动运行代理，可以将代理设置为作为Windows服务运行，也可以使用另一种自动启动进程的方式。<br>使用Windows服务方法是最简单的方法，但是Windows将<a href="known-issues.html#Agent-running-as-Windows-Service-Limitations">某些约束</a>应用于以这种方式运行的进程。<br>只要满足所有<a href="#Necessary-OS-and-environment-permissions">要求</a> ，TeamCity代理就可以在Windows服务下可靠地工作，但是配置为在代理上运行的生成过程通常不是这种情况。</p><p id="53003a9c">这就是为什么仅在所有构建脚本都支持的情况下才建议将TeamCity代理作为Windows服务运行的原因。否则，建议使用特定于操作系统的替代方法来自动启动TeamCity代理。<br>一种方法是在Windows启动时配置<a href="https://support.microsoft.com/en-us/help/324737/how-to-turn-on-automatic-logon-in-windows" rel="noopener noreferrer" data-external="true" target="_blank">自动用户登录</a> ，然后配置TeamCity代理启动（通过<code class="code">agent.bat start</code> ）（例如，通过Windows <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383614(v=vs.85).aspx" rel="noopener noreferrer" data-external="true" target="_blank">Task Scheduler</a> ）。</p></div><a name="BuildAgentasaWindowsService"></a><a name="Build-Agent-as-a-Windows-Service"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-BuildAgentasaWindowsService">Build Agent作为Windows服务</h4><p id="806132fa">在Windows中，您可能希望将TeamCity代理作为Windows服务运行，以使其在没有任何用户登录的情况下运行。如果使用Windows代理安装程序，则可以选择在安装向导中安装该服务。</p><aside class="warning " rel="806132fa" id="ae66f116" data-title=""><p id="1ba846e6">要运行构建，必须在具有足够权限来执行构建和<a href="#Windows">管理</a>服务的用户下启动构建代理。默认情况下，Windows服务在SYSTEM帐户下启动，由于该帐户使用扩展的权限，因此不建议将其用于生产。要对其进行更改，请使用标准的Windows Services小程序（“控制面板” |“管理工具” |“服务”），然后将用户更改为<code class="code">TeamCity Build Agent</code>服务。</p></aside><aside class="tip sideblock" rel="SettingupandRunningAdditionalBuildAgents-BuildAgentasaWindowsService" id="4e23576b" data-title=""><p id="36115874">如果您将Amazon EC2云代理作为Windows服务启动，请查看<a href="setting-up-teamcity-for-amazon-ec2.html#Preparing-Image-with-Installed-TeamCity-Agent">相关说明</a> 。</p></aside><p id="cabf77fe">以下说明可用于手动安装Windows服务（例如， <code class="code">.zip</code>代理安装）。还应执行此过程，以在同一台计算机上为<a href="#Installing-Several-Build-Agents-on-the-Same-Machine">第二个及后续代理</a>创建Windows服务。</p><p id="263f21e2"><b id="672fde90">要安装服务：</b></p><ol class="list _decimal"><li class="list__item" id="98207b46"><p>检查服务是否具有所需的名称和ID（请参阅下面的＃4，服务名称为<code class="code">TeamCity Build Agent</code>默认情况下）不存在；如果已安装，请将其删除。</p></li><li class="list__item" id="7311bbf8"><p>检查<code class="code">wrapper.java.command</code>物业<code class="code"><agent home>\launcher\conf\wrapper.conf</code>文件在JDK安装目录中包含Java可执行文件的有效路径。您可以使用<code class="code">wrapper.java.command=../jre/bin/java</code>与Windows发行版一起安装的代理。确保指定java.exe文件的路径，且不带引号。</p></li><li class="list__item" id="2d49ac60"><p>如果要以用户帐户（推荐）而不是“系统”身份运行代理，请添加<code class="code">wrapper.ntservice.account</code>和<code class="code">wrapper.ntservice.password</code>的属性<code class="code"><agent home>\launcher\conf\wrapper.conf</code>具有适当凭证的文件</p></li><li class="list__item" id="a9c87442"><p>（适用于第二和后续安装）修改<code class="code"><agent>\launcher\conf\wrapper.conf</code>文件，以便<code class="code">wrapper.console.title</code> ， <code class="code">wrapper.ntservice.name</code> ， <code class="code">wrapper.ntservice.displayname</code>和<code class="code">wrapper.ntservice.description</code>属性在计算机内具有唯一值。</p></li><li class="list__item" id="bebf0edb"><p>跑过<code class="code"><agent home>\bin\service.install.bat</code>具有足够特权的用户下的脚本来注册新代理服务。确保仅在按照说明进行配置后才第一次启动代理。</p></li></ol><p id="94d16606"><b id="83695611">要启动服务：</b></p><ul class="list _ul"><li class="list__item" id="52a55f42"><p>跑<code class="code"><agent home>/bin/service.start.bat</code> （或使用标准的Windows Services小程序）</p></li></ul><p id="db7b950a"><b id="0fc62220">要停止服务：</b></p><ul class="list _ul"><li class="list__item" id="51920475"><p>跑<code class="code"><agent home>/bin/service.stop.bat</code> （或使用标准的Windows Services小程序）</p></li></ul><p id="4e8cefa1">您也可以使用标准Windows <code class="code">net.exe</code>实用程序，用于在安装服务后对其进行管理。<br>例如（假设默认服务名称）：</p><div class="code-block" data-lang="bash">净启动TCBuildAgent</div><p id="8df90a1e">的<code class="code"><agent home>\launcher\conf\wrapper.conf</code>该文件还可以用于更改代理JVM参数。</p><p id="9a9e5d2b">用于运行构建代理服务的用户帐户必须具有足够的权限来启动/停止代理服务，如描述<a href="#Windows">上面</a> 。</p></div><a name="AutomaticAgentStartunderLinux"></a><a name="Automatic-Agent-Start-under-Linux"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderLinux">在Linux下自动启动代理</h4><p id="3ece3734">要在Linux下的计算机引导上自动运行代理，请使用以下命令配置守护进程<code class="code">agent.sh start</code>命令启动它并<code class="code">agent.sh stop</code>命令停止它。</p><p id="0e0cb50b">对于systemd，请参见示例<code class="code">teamcityagent.service</code>配置文件：</p><div class="code-block" data-lang="bash">[Unit]描述= TeamCity Build Agent After = network.target [Service]类型= oneshot用户= teamcityagent组= teamcityagent ExecStart = / home / teamcityagent / agent / bin / agent.sh start ExecStop =-/ home / teamcityagent / agent / bin / agent.sh stop＃支持代理升级，因为主进程启动子进程并退出，然后退出RemainAfterExit = yes＃支持代理升级，因为主进程在升级过程中获取SIGTERM，并且映射到退出代码143 SuccessExitStatus = 0 143 [Install] WantedBy = default.target</div><p id="fa9fe3af">对于<code class="code">init.d</code> ，请参考示例过程：</p><p id="8bf4100f">1。导航到服务启动/停止服务脚本目录：</p><div class="code-block" data-lang="bash">cd /etc/init.d/</div><p id="3b771931">2。打开构建代理服务脚本：</p><div class="code-block" data-lang="bash">须藤vim buildAgent</div><p id="77865004">3。将以下内容粘贴到文件中：</p><div class="code-block" data-lang="none">＃！/ bin / sh ### BEGIN INIT INFO＃提供：TeamCity Build Agent＃必需的开始：$ remote_fs $ syslog＃必需的停止：$ remote_fs $ syslog＃缺省的开始：2 3 4 5＃缺省的停止：0 1 6＃简短描述：在引导时启动构建代理守护程序＃描述：启用守护程序提供的服务。### END INIT INFO＃提供正确的用户名：USER =“ agentuser”大小写“ $ 1”，开始）su-$ USER -c“ cd BuildAgent / bin; ./agent.sh start” ;;停止）su-$ USER -c“ cd BuildAgent / bin; ./agent.sh停止” ;; *）回显“使用开始/停止”出口1 ;; esac出口0</div><p id="cedc1269">4。设置执行文件的权限：</p><div class="code-block" data-lang="bash">须藤chmod 755 buildAgent</div><p id="707b7035">5，建立链接以使用适当的工具在计算机启动和重新启动时启动代理服务：</p><ul class="list _ul"><li class="list__item" id="a0d59b0e"><p>对于Debian / Ubuntu：</p></li></ul><div class="code-block" data-lang="bash">sudo update-rc.d buildAgent默认</div><ul class="list _ul"><li class="list__item" id="889ab248"><p>对于Red Hat / CentOS：</p></li></ul><div class="code-block" data-lang="bash">sudo chkconfig buildAgent在</div></div><a name="AutomaticAgentStartundermacOS"></a><a name="Automatic-Agent-Start-under-macOS"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartundermacOS">在macOS下自动启动代理</h4><p id="4fdffd5f">对于macOS / Mac OS X，TeamCity提供了在构建用户登录时自动加载构建代理的功能。</p></div><a name="LaunchAgentApproach"></a><a name="LaunchAgent-Approach"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-LaunchAgentApproach">LaunchAgent方法</h4><p id="7ad70713">通过配置自动构建代理启动<code class="code">LaunchAgent</code> ， 跟着这些步骤：</p><p id="de30e03f">1。通过Mac在Mac上安装构建代理<code class="code">buildAgent.zip</code> 。</p><p id="78d47a2d">2。准备<code class="code">conf/buildAgent.properties</code>文件（至少在此设置代理名称）。</p><p id="97edbeae">3。确保下的所有文件<code class="code">buildAgent</code>目录归拥有者所有<code class="code">your_build_user</code>以确保适当的代理升级过程。</p><p id="37f1e885">4。通过以下命令加载构建代理：</p><div class="code-block" data-lang="bash">mkdir buildAgent / logs＃目录应在your_build_user用户下创建sh buildAgent / bin / mac.launchd.sh load</div><p id="ea2ac72e">在下面运行这些命令<code class="code">your_build_user</code>帐户。</p><p id="7b6b57f4">您必须<b id="b676a794">等待几分钟</b> ，构建代理才能从TeamCity服务器自动升级。您可以在日志中查看该过程：</p><div class="code-block" data-lang="bash">tail -f buildAgent / logs / teamcity-agent.log</div><p id="c928d1f9">5，当构建代理升级并成功连接到TeamCity服务器后，停止代理：</p><div class="code-block" data-lang="bash">sh buildAgent / bin / mac.launchd.sh卸载</div><p id="ce3bade0">6。从TeamCity服务器升级构建代理后，复制<code class="code">buildAgent/bin/jetbrains.teamcity.BuildAgent.plist</code>归档到<code class="code">$HOME/Library/LaunchAgents/</code>目录。</p><p id="1e1058d8">7。配置您的Mac系统<b id="f89d19c2">自动登录</b>的用户打造，如所描述<a href="https://support.apple.com/en-us/HT201476" rel="noopener noreferrer" data-external="true" target="_blank">这里</a> 。</p><p id="06dfbc44">8。重启。</p><p id="21595593">在系统启动时，构建用户应自动登录，并且构建代理应启动。</p><p id="2f375129">要快速检查构建代理程序是否正在运行，请使用以下命令：</p><div class="code-block" data-lang="bash">launchctl列表| grep BuildAgent 69722 0 jetbrains.teamcity。BuildAgent</div></div><a name="ConfigureaSecondBuildAgentonMacOS"></a><a name="Configure-a-Second-Build-Agent-on-Mac-OS"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-ConfigureaSecondBuildAgentonMacOS">在Mac OS上配置第二个Build Agent</h4><p id="e10ccafe">如果要启动多个构建代理，请通过以下更改重复安装和启动构建代理的过程：</p><ul class="list _ul"><li class="list__item" id="11c0ec34"><p>在另一个目录中安装第二个构建代理。</p></li><li class="list__item" id="c531dfd2"><p>在<code class="code">conf/buildAgent.properties</code>指定其他代理名称。</p></li><li class="list__item" id="fb30ca7e">别跑<code class="code">buildAgent/bin/mac.launchd.sh</code> ;代替<ul class="list _ul"><li class="list__item" id="d2ce6ce7"><p>创建副本<code class="code">$HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent.plist</code>归档为<code class="code">$HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent2.plist</code> 。</p></li><li class="list__item" id="5a8420a4">编辑<code class="code">$HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent2.plist</code>文件并设置以下参数：<ul class="list _ul"><li class="list__item" id="3b818124"><p>的<code class="code">Label</code>参数<code class="code">jetbrains.teamcity.BuildAgent2</code></p></li><li class="list__item" id="6f140373"><p>的<code class="code">WorkingDirectory</code>参数到第二个构建代理主目录的正确路径</p></li></ul></li><li class="list__item" id="bd45140b"><p>使用命令启动第二个代理<code class="code">launchctl load $HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent2.plist</code></p></li></ul></li></ul><p id="005a9fc9">要检查两个构建代理程序是否都在运行，请使用以下命令：</p><div class="code-block" data-lang="bash">launchctl列表| grep BuildAgent 70599 0 jetbrains.teamcity。BuildAgent2 69722 0 jetbrains.teamcity。BuildAgent</div></div></div></div><a name="StoppingtheBuildAgent"></a><a name="Stopping-the-Build-Agent"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-StoppingtheBuildAgent">停止构建代理</h2><p id="8ac00d29"><b id="d6dba82d">要手动停止代理</b> ，请运行<code class="code"><Agent home>\agent</code>带一个脚本<code class="code">stop</code>参数。</p><p id="792072a2">使用<code class="code">stop</code>请求在当前构建完成后停止。<br>使用<code class="code">stop force</code>请求立即停止（如果构建正在代理上运行，它将被突然停止（取消））。<br>在Linux下，您还有另外一种选择<code class="code">stop kill</code>杀死代理程序。</p><p id="0205c5b2">如果代理程序在连接控制台的情况下运行，则您也可以在控制台中按<b id="11800818">Ctrl + C组合</b>键以停止代理程序（如果正在运行内部版本，它将被取消）。</p><a name="StoppingtheAgentServiceonMacOS"></a><a name="Stopping-the-Agent-Service-on-Mac-OS"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-StoppingtheAgentServiceonMacOS">在Mac OS上停止代理服务</h3><p id="132e1d65">如果构建代理已作为<code class="code">LaunchAgent</code>服务，可以使用<code class="code">launchctl</code>效用：</p><div class="code-block" data-lang="bash">launchctl卸载$ HOME / Library / LaunchAgents / jetbrains.teamcity。BuildAgent.plist＃或launchctl删除jetbrains.teamcity。BuildAgent</div></div></div><a name="ConfiguringJava"></a><a name="Configuring-Java"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-ConfiguringJava">配置Java</h2><p id="46ba9616">TeamCity构建代理是一个Java应用程序，需要JDK 8-10版本才能工作。OpenJDK 8（例如，通过<a href="https://adoptopenjdk.net/" rel="noopener noreferrer" data-external="true" target="_blank">AdoptOpenJDK</a> ）1.8.0_161或更高版本，建议使用32位。还支持<a href="http://www.oracle.com/technetwork/java/javase/downloads/" rel="noopener noreferrer" data-external="true" target="_blank">Oracle Java 8</a> 。</p><p id="8fdeb537">生成代理包含两个过程：</p><ul class="list _ul"><li class="list__item" id="859594ca"><p>代理启动器–启动代理进程的Java进程</p></li><li class="list__item" id="e9e7dbb7"><p>代理-构建代理的主要过程；作为代理启动器的子进程运行</p></li></ul><p id="bdddd9a5">（Windows） <code class="code">.exe</code> TeamCity发行版与OpenJDK 1.8.0_161捆绑在一起。<br>如果运行TeamCity代理的早期版本，则需要重复安装代理以更新JVM。</p><p id="ce3f5527">建议使用x32位JDK（而非JRE）。对于某些生成器，例如<a href="intellij-idea-project.html">IntelliJ IDEA项目</a> ，Java <a href="inspections.html">Inspections</a>和<a href="duplicates-finder-java.html">Duplicates</a> ，都需要JDK。如果没有Java构建，则可以安装JRE而不是JDK。<br>可以使用x64位Java，但您可能需要将<code class="code">-Xmx</code>主代理进程的内存值（参见<a href="configuring-build-agent-startup-properties.html">配置生成代理启动属性</a>和一致好评<a href="installing-and-configuring-the-teamcity-server.html#Setting-Up-Memory-settings-for-TeamCity-Server">部分</a>服务器）。</p><p id="09ea92e0"><a name="java-paths"></a><a name="SettingupandRunningAdditionalBuildAgents-java-paths"></a></p><p id="c395f960">为了<code class="code">.zip</code>代理安装，您需要安装相应的Java版本。通过以下方式使其可用<code class="code">PATH</code>或在以下位置之一可用：</p><ul class="list _ul"><li class="list__item" id="90658e8b"><p>的<code class="code"><Agent home>/jre</code>目录</p></li><li class="list__item" id="8c79ba6a"><p>在指向的目录中<code class="code">TEAMCITY_JRE</code> ， <code class="code">JAVA_HOME</code>要么<code class="code">JRE_HOME</code>环境变量（检查是否仅定义了其中一个变量）。</p></li><li class="list__item" id="33f42647"><p>如果您打算通过Windows服务运行代理，请确保设置<code class="code">wrapper.java.command</code>物业<code class="code"><agent home>\launcher\conf\wrapper.conf</code>文件到Java可执行文件的有效路径</p></li></ul><a name="UpgradingJavaonAgents"></a><a name="Upgrading-Java-on-Agents"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-UpgradingJavaonAgents">在代理上升级Java</h3><p id="6a4fbc48">如果您尝试启动代理，但无法在任何<a href="#java-paths">默认位置中</a>找到所需的Java版本（当前为Java 6），则代理将报告启动错误，进程将无法启动，并且代理在TeamCity UI中将显示为断开连接。</p><p id="ea2130fc">如果构建代理使用的Java版本低于Java 8，则您将在代理页面上看到相应的警告，并在Web UI中看到<a href="server-health.html">运行状况项</a> 。</p><aside class="note " rel="ea2130fc" id="6150d126" data-title=""><p id="e8eaa1e3"><b id="48cbab95">TeamCity 2019.2中将不再支持代理版本8之前的Java</b> 。如果看到警告，请考虑在代理上升级Java。<br>代理计算机可以安装多个Java版本，并且代理可以使用一个Java版本，而构建任务使用其他Java版本。</p><p id="f4d69d30">如果您的安装依赖于Java的旧版本，并且由于某种原因而无法升级到版本8，请通过任何一种<a href="https://confluence.jetbrains.com/display/TW/Feedback" rel="noopener noreferrer" data-external="true" target="_blank">支持渠道</a>告知我们。</p></aside><p id="93d13b84">建议使用最新的Java 8、32位版本。OpenJDK 8（例如，通过<a href="https://adoptopenjdk.net/" rel="noopener noreferrer" data-external="true" target="_blank">AdoptOpenJDK</a> ）1.8.0_161或更高版本，建议使用32位。还支持<a href="http://www.oracle.com/technetwork/java/javase/downloads/" rel="noopener noreferrer" data-external="true" target="_blank">Oracle Java 8</a> 。</p><p id="e23d90ae">要在代理上更新Java，请执行以下一项操作：</p><ul class="list _ul"><li class="list__item" id="341488b6"><p>如果TeamCity UI中的座席详细信息页面显示具有相应操作的Java版本注释，则可以切换到使用较新的Java：如果在座席上检测到与当前位数相同的适当Java版本，则座席页面将提供自动切换为使用该Java的操作。在操作调用后，使用新的Java重新启动代理进程（一旦代理变为空闲，即完成当前构建，则完成）。</p></li><li class="list__item" id="a59180fa"><p>（Windows）由于构建代理Windows安装程序与必需的Java捆绑在一起，因此您可以使用Windows安装程序手动重新安装该代理（ <code class="code">.exe</code> ）从TeamCity服务器“ <b id="dfa6dbc7">代理”</b>页面获得。请参阅<a href="#InstallingviaWindowsinstaller">安装说明</a> 。在安装更新的代理之前，请先卸载该代理的先前版本，这一点很重要： <code class="code">Uninstall.exe</code>在代理主目录中，清除所有“ <i id="4937056a">删除...</i> ”复选框，然后单击“ <b id="64ecee85">卸载”</b> 。</p></li><li class="list__item" id="2228c1d9"><p>在代理上将所需的Java安装到标准位置之一，然后重新启动代理-代理随后应检测到它并提供操作以在Web UI中使用较新的Java（请参见上文）。</p></li><li class="list__item" id="3e49a4c2"><p>在代理上安装所需的Java并将代理<a href="#Configuring-Java">配置</a>为使用它。</p></li></ul><aside class="note " rel="1e93a657" id="e1ee3838" data-title=""><p id="7f08ebfb">在为启动TeamCity代理的进程更新Java的极少数情况下，请使用代理Java升级的选项之一。将Build Agent作为<b id="f92a8429">Windows服务</b>启动的另一种方法是停止该服务，更改<code class="code">wrapper.java.command</code>可变的<code class="code">buildAgent\launcher\conf\wrapper.conf</code>指向新<code class="code">java.exe</code>二进制文件，然后重新启动服务。</p></aside></div></div><a name="InstallingSeveralBuildAgentsontheSameMachine"></a><a name="Installing-Several-Build-Agents-on-the-Same-Machine"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-InstallingSeveralBuildAgentsontheSameMachine">在同一台计算机上安装多个构建代理</h2><p id="f8de671a">如果计算机能够同时运行多个构建，则可以在同一台计算机上安装多个TeamCity代理。但是，我们建议每（虚拟）台计算机运行一个代理，以最大程度地减少构建的交叉影响并使构建更可预测。当安装多个代理时，建议将它们安装在不同的OS用户下，以使用户级资源（例如Maven / Gradle / NuGet本地工件高速缓存）不会冲突。</p><p id="bc497182">TeamCity平等对待所有代理，无论它们是安装在同一台机器上还是安装在不同机器上。<br>在同一台计算机上安装多个TeamCity构建代理时，请考虑以下事项：</p><ul class="list _ul"><li class="list__item" id="c47037f6"><p>在此类代理上运行的构建不应与任何资源（公用磁盘目录，OS进程，OS临时目录）冲突。</p></li><li class="list__item" id="0cdb313e"><p>根据硬件和内部版本，您可能会体验到内部版本性能下降。同时运行多个构建时，请确保没有磁盘，内存或CPU瓶颈。</p></li><li class="list__item" id="e68e774c"><p>建议将代理设置为在不同的OS用户下运行</p></li></ul><p id="b79a3ac9">安装一个代理后，可以按照常规安装过程安装其他代理（请参阅下面的Windows服务例外），但请确保：</p><ul class="list _ul"><li class="list__item" id="f97d05a1"><p>代理安装在单独的目录中。</p></li><li class="list__item" id="7800c2fe"><p>代理商具有特色<code class="code">workDir</code>和<code class="code">tempDir</code>目录中的<a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a>文件。</p></li><li class="list__item" id="ad52e0bd"><p>的值<code class="code">name</code>和<code class="code">ownPort</code>的性质<a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a>是独一无二的</p></li><li class="list__item" id="699e95aa"><p>没有在代理上运行的内部版本指定绝对签出目录。</p></li></ul><p id="09c83175">确保没有指定绝对<a href="build-checkout-directory.html">检查目录的</a>构建配置（或者，确保此类构建配置启用了“ <a href="clean-checkout.html">clean checkout</a> ”选项，并且它们不能并行运行）。</p><p id="13948aa6">通常，对于新的代理程序安装，您只需将现有代理程序的目录复制到新位置即可， <code class="code">temp</code> ， <code class="code">work</code> ， <code class="code">logs</code>和<code class="code">system</code>目录。然后，修改<code class="code">conf/buildAgent.properties</code>与新<code class="code">name</code> ， <code class="code">ownPort</code>价值观。清除（删除或删除值） <code class="code">authorizationToken</code>属性，并确保<code class="code">workDir</code>和<code class="code">tempDir</code>是亲戚/不与其他特工发生冲突。</p><p id="1e50c439">如果要在Mac OS上安装第二个构建代理，请参见<a href="#Configure-a-Second-Build-Agent-on-Mac-OS">此处的</a>其他详细信息。</p><p id="6489964c">如果您使用Windows Installer安装其他代理程序并希望将代理程序作为服务运行，则将需要执行手动步骤，因为安装程序不支持在同一台计算机上将第二个代理程序作为服务安装：现有服务会被覆盖（另请参阅<a href="http://youtrack.jetbrains.net/issue/TW-4962" rel="noopener noreferrer" data-external="true" target="_blank">功能请求</a> ）。<br>为了安装第二个代理，建议<a href="#Installing-via-ZIP-File">手动</a>安装第二个代理（使用.zip代理分发）。您可以使用Windows代理安装程序，并且不选择服务安装，但是这种方式将丢失初始安装的代理的卸载选项。<br>安装第二个代理后，如上一<a href="#Build-Agent-as-a-Windows-Service">节所述</a>为其注册一个新服务。</p><aside class="tip sideblock" rel="6489964c" id="338eae5b" data-title=""><p id="d77c3014">有关将第二个Windows代理作为服务安装的分步说明，请参阅相关的<a href="https://handcraftsman.wordpress.com/2010/07/20/multiple-teamcity-build-agents-on-one-server/" rel="noopener noreferrer" data-external="true" target="_blank">外部博客文章</a> 。</p></aside><hr id="4b301f2a"><p id="1ba2e471"><b id="b63b0d8e">也可以看看：</b></p><p id="a1a3358d"><b id="2c217f9d">概念</b> ： <a href="build-agent.html">生成代理</a></p><hr id="dd989faf"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>