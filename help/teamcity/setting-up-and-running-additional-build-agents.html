<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Setting up and Running Additional Build Agents - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Setting up and Running Additional Build Agents" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/setting-up-and-running-additional-build-agents.md|Setting up and Running Additional Build Agents/build-agent-configuration.md|Build Agent Configuration" data-main-title="Setting up and Running Additional Build Agents" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/setting-up-and-running-additional-build-agents.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Setting up and Running Additional Build Agents" id="setting-up-and-running-additional-build-agents.md">Setting up and Running Additional Build Agents</h1><p id="e4e36b96">Before you can start customizing projects and creating build configurations, you need to configure <a href="build-agent.html">build agents</a>. Review the <a href="#Agent-Server-Data-Transfers">agent-server communication</a> and <a href="#Prerequisites">Prerequisites</a> sections before proceeding with agent installation.</p><p id="138519c9">On this page:</p><p id="ec993288"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Prerequisites">Prerequisites</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-NecessaryOSandenvironmentpermissions">Necessary OS and environment permissions</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Common">Common</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Windows">Windows</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Linux">Linux</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Build-relatedPermissions">Build-related Permissions</a></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Agent-ServerDataTransfers">Agent-Server Data Transfers</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-UnidirectionalAgent-to-ServerCommunication">Unidirectional Agent-to-Server Communication</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-BidirectionalCommunication">Bidirectional Communication</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ChangingCommunicationProtocol">Changing Communication Protocol</a></li></ul></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingAdditionalBuildAgents">Installing Additional Build Agents</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaWindowsinstaller">Installing via Windows installer</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaDockerAgentImage">Installing via Docker Agent Image</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaZIPFile">Installing via ZIP File</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingviaAgentPush">Installing via Agent Push</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-RemoteHostRequirements">Remote Host Requirements</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-Installation">Installation</a></li></ul></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-StartingtheBuildAgent">Starting the Build Agent</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ManualStart">Manual Start</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticStart">Automatic Start</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderWindows">Automatic Agent Start under Windows</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-BuildAgentasaWindowsService">Build Agent as a Windows Service</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderLinux">Automatic Agent Start under Linux</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartundermacOS">Automatic Agent Start under macOS</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-LaunchAgentApproach">LaunchAgent Approach</a></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ConfigureaSecondBuildAgentonMacOS">Configure a Second Build Agent on Mac OS</a></li></ul></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-StoppingtheBuildAgent">Stopping the Build Agent</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-StoppingtheAgentServiceonMacOS">Stopping the Agent Service on Mac OS</a></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-ConfiguringJava">Configuring Java</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-UpgradingJavaonAgents">Upgrading Java on Agents</a></li></ul></li><li class="list__item"><a href="#SettingupandRunningAdditionalBuildAgents-InstallingSeveralBuildAgentsontheSameMachine">Installing Several Build Agents on the Same Machine</a></li></ul></p><aside class="tip sideblock" data-title="" rel="ec993288" id="34a7aeae"><p id="6ba58f49">If you install TeamCity bundled with a Tomcat servlet container, or use the TeamCity installer for Windows, both the server and one build agent are installed on the same machine. This is not a recommended setup for <a href="installing-and-configuring-the-teamcity-server.html#Configuring-Server-for-Production-Use">production purposes</a> because of <a href="how-to.html#TeamCity-Security-Notes">security concerns</a> and since the build procedure can slow down the responsiveness of the web UI and overall TeamCity server functioning. If you need more build agents, perform the procedure described below.If you need the agent to run an operating system different from the TeamCity server, perform the procedure described below.For production installations, it is recommended to adjust the <a href="configuring-build-agent-startup-properties.html">Agent's JVM parameters</a> to include the <code class="code">-server</code> option.</p></aside><a name="Prerequisites"></a><a name="Prerequisites"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-Prerequisites">Prerequisites</h2><a name="NecessaryOSandenvironmentpermissions"></a><a name="Necessary-OS-and-environment-permissions"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-NecessaryOSandenvironmentpermissions">Necessary OS and environment permissions</h3><p id="5b1009d9">Before the installation, review the <a href="known-issues.html#Conflicting-Software">Conflicting Software section</a>. In case of any issues, make sure no conflicting software is used.</p><p id="161d54c7">Note that to run a TeamCity build agent, the environment and user account used to run the Agent need to comply with the following requirements:</p><p id="06515ffb"><a name="Network"></a><a name="SettingupandRunningAdditionalBuildAgents-Network"></a></p><a name="Common"></a><a name="Common"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Common">Common</h4><p id="597dcaaf">The agent process (java) must</p><ul class="list _ul"><li class="list__item" id="2eb8974e"><p>be able to open outbound HTTP connections to the server URL configured via the <code class="code">serverUrl</code> property in the <a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a> file (typically the same address you use in the browser to view the TeamCity UI). Sending requests to the paths under the configured URL should not be limited. See also the recommended <a href="how-to.html#Set-Up-TeamCity-behind-a-Proxy-Server">reverse proxy settings</a>. Ensure that any firewalls installed on the agent or server machines, network configuration and proxies (if any) comply with these requirements.</p></li><li class="list__item" id="14263da5"><p>have full permissions (read/write/delete) to the following directories recursively: <a href="agent-home-directory.html"><code class="code">&lt;agent home&gt;</code></a> (necessary for automatic agent upgrade and agent tools support), <a href="agent-work-directory.html"><code class="code">&lt;agent work&gt;</code></a>, <a href="agent-home-directory.html#Agent-Directories"><code class="code">&lt;agent temp&gt;</code></a>, and agent system directory (set by <code class="code">workDir</code>, <code class="code">tempDir</code>, and <code class="code">systemDir</code> parameters in the <code class="code">buildAgent.properties</code> file)</p></li><li class="list__item" id="3ec3c227"><p>be able to launch processes (to run builds).</p></li><li class="list__item" id="ba4aa6f8"><p>be able to launch nested processes with the following parent process exit (this is used during agent upgrade)</p></li></ul><p id="500dd139"><a name="Windows"></a><a name="SettingupandRunningAdditionalBuildAgents-Windows"></a></p></div><a name="Windows"></a><a name="Windows"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Windows">Windows</h4><ul class="list _ul"><li class="list__item" id="df2471f4"><p>Log on as a service (to run as Windows service)</p></li><li class="list__item" id="1f79786b"><p>Start/Stop service (to run as Windows service, necessary for the agent upgrade to work, see also <a href="https://support.microsoft.com/en-us/help/325349/how-to-grant-users-rights-to-manage-services-in-windows-server-2003" data-external="true" target="_blank" rel="noopener noreferrer">Microsoft KB article</a>)</p></li><li class="list__item" id="96d07856"><p>Debug programs (required for take process dump functionality)</p></li><li class="list__item" id="83d14f70"><p>Reboot the machine (required for agent reboot functionality)</p></li><li class="list__item" id="9988c5c4"><p>To be able to <a href="performance-monitor.html">monitor performance</a> of a build agent run as a Windows <a href="#Build-Agent-as-a-Windows-Service">service</a>, the user starting the agent must be a member of the Performance Monitor Users group</p></li></ul><aside class="note " data-title="" rel="08812599" id="9f1887dc"><p id="a37c46c8">For granting necessary permissions for unprivileged users, see <a href="https://support.microsoft.com/en-us/kb/325349" data-external="true" target="_blank" rel="noopener noreferrer">Microsoft documentation</a>.You can assign rights to manage services with Microsoft <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=e8ba3e56-d8fe-4a91-93cf-ed6985e3927b&amp;displaylang=en" data-external="true" target="_blank" rel="noopener noreferrer">SubInACL</a> utility, a command-line tool enabling administrators to directly edit security information. The tool uses the following syntax:</p><div class="code-block" data-lang="bash">SUBINACL /SERVICE \\MachineName\ServiceName /GRANT=[DomainName]UserName[=Access]

</div><p id="40092229">For example, to grant Start/Stop rights, you might need to execute the command:</p><div class="code-block" data-lang="bash">subinacl.exe /service TCBuildAgent /grant=&lt;user login name&gt;=PTO

</div></aside></div><a name="Linux"></a><a name="Linux"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Linux">Linux</h4><ul class="list _ul"><li class="list__item" id="4750e8d7"><p>the user must be able to run the <code class="code">shutdown</code> command (for the agent machine reboot functionality and the machine shutdown functionality when running in a cloud environment)</p></li><li class="list__item" id="3e0d66bb"><p>when using systemd, it should not kill the processes on the main process exit (use <a href="https://serverfault.com/questions/660063/teamcity-build-agent-gets-killed-by-systemd-when-upgrading" data-external="true" target="_blank" rel="noopener noreferrer">RemainAfterExit=yes</a>)</p></li></ul></div><a name="Build-relatedPermissions"></a><a name="Build-related-Permissions"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Build-relatedPermissions">Build-related Permissions</h4><p id="dd9a3873">The build process is launched by a TeamCity agent and thus shares the environment and is executed under the OS user used by the TeamCity agent. Ensure that the TeamCity agent is configured accordingly. See <a href="known-issues.html">Known Issues</a> for related Windows Service Limitations.</p></div></div><a name="Agent-ServerDataTransfers"></a><a name="Agent-Server-Data-Transfers"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-Agent-ServerDataTransfers">Agent-Server Data Transfers</h3><p id="016ae604">A TeamCity agent connects to the TeamCity server via the URL configured as the <code class="code">serverUrl</code> agent property. This is called <a href="#Unidirectional-Agent-to-Server-Communication">unidirectional</a> agent-to-server connection. If specifically configured, TeamCity agent can use legacy <a href="#Bidirectional-Communication">bidirectional communication</a> which also requires establishing a connection from the server to the agents. To view whether the agent-server communication is unidirectional or bidirectional for a particular agent, navigate to <b id="d0865dd5">Agents | &lt;Agent Name&gt; | Agent Summary</b> tab, the <b id="0c044eb8">Details</b> section, <b id="cf6acc63">Communication Protocol</b>.</p><a name="UnidirectionalAgent-to-ServerCommunication"></a><a name="Unidirectional-Agent-to-Server-Communication"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-UnidirectionalAgent-to-ServerCommunication">Unidirectional Agent-to-Server Communication</h4><p id="756566e8">Agents use unidirectional agent-to-server connection via the polling protocol: the agent establishes an HTTP(S) connection to the TeamCity Server, and polls the server periodically for server commands.</p><p id="2f4868bf">It is recommended to use <b id="b8eb0f04">HTTPS</b> for agent to server communications (check related <a href="how-to.html#Configure-HTTPS-for-TeamCity-Web-UI">server configuration notes</a>). If the agents and the server are deployed into a secure environment, agents can be configured to use plain HTTP URL for connections to the server as this reduces transfer overhead. Note that the data travelling through the connection established from an agent to the server includes build settings, repository access credentials and keys, repository sources, build artifacts, build progress messages and build log. In case of using the HTTP protocol that data can be compromised via the "man in the middle" attack.</p></div><a name="BidirectionalCommunication"></a><a name="Bidirectional-Communication"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-BidirectionalCommunication">Bidirectional Communication</h4><p id="4456f9b4">The bidirectional communication is a legacy connection between the agent and the server and it needs to be specifically enabled (see the example below). When enabled, it requires the agent to connect to the server via HTTP (or HTTPS) and the server to connect to the agent via HTTP.</p><p id="9f8776e8">The data that is transferred via the connections established by the server to agents is passed via an unsecured HTTP channel and thus is potentially exposed to any third party that may listen to the traffic between the server and the agents. Moreover, since the agent and server can send "commands" to each other, an attacker that can send HTTP requests and capture responses may in theory trick the agent into executing an arbitrary command and perform other actions with a security impact.</p><p id="421bc93e">The communication protocol used by TeamCity agents is determined by the value of the <code class="code">teamcity.agent.communicationProtocols</code> server <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal property</a>. The property accepts a comma-separated ordered list of protocols (<code class="code">polling</code>  and <code class="code">xml-rpc</code> are supported protocol names) and is set to <code class="code">teamcity.agent.communicationProtocols=polling</code> by default. If several protocols are specified, the agent tries to connect using the first protocol from this list and if it fails, it will try to connect via the second protocol in the list. <code class="code">polling</code> means unidirectional protocol, <code class="code">xml-rpc</code> - older, bidirectional communication.</p></div><a name="ChangingCommunicationProtocol"></a><a name="Changing-Communication-Protocol"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-ChangingCommunicationProtocol">Changing Communication Protocol</h4><ul class="list _ul"><li class="list__item" id="559e0eff"><p>To change the communication protocol <b id="2f3eb968">for all agents</b>, set the TeamCity server <code class="code">teamcity.agent.communicationProtocols</code> server <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal property</a>. The new setting will be used by all agents which will connect to the server after the change. To change the protocol for the existing connections, restart the TeamCity server.</p></li><li class="list__item" id="85d54273"><p>By default, the agent's property is not configured; when the agent first connects to the server, it receives it from the TeamCity server. To change the protocol <b id="b6112e70">for an individual agent</b> after the initial agent configuration, change the value of the <code class="code">teamcity.agent.communicationProtocols</code> property in the <a href="build-agent-configuration.html">agent's properties</a>. The agent's property overrides the server property. After the change the agent will restart automatically upon finishing a running build, if any.</p></li><li class="list__item" id="82f374ab"><p>When connecting TeamCity agents of version 2018.1+ to TeamCity server of version before 9.1 (e.g. after roll back following an upgrade), the agents will need to be updated to use <code class="code">xml-rpc</code> protocol (or they can be reinstalled) to be able to connect to an older server to perform the self-update procedure.</p></li></ul></div></div></div><a name="InstallingAdditionalBuildAgents"></a><a name="Installing-Additional-Build-Agents"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-InstallingAdditionalBuildAgents">Installing Additional Build Agents</h2><p id="c63f235d">1. Install a build agent using any of the following options:</p><ul class="list _ul"><li class="list__item" id="db7dcf4b"><p><a href="#Installing-via-Windows-installer">Using Windows installer</a> (Windows only)</p></li><li class="list__item" id="ef84b60b"><p><a href="#Installing-via-ZIP-File">By downloading a zip file and installing manually</a> (any platform)</p></li><li class="list__item" id="b218789f"><p>Via the <a href="#Installing-via-Docker-Agent-Image">Docker Agent Image</a> option to prepare a Docker container based on the official <a href="https://hub.docker.com/r/jetbrains/teamcity-agent/" data-external="true" target="_blank" rel="noopener noreferrer">TeamCity Agent image</a></p></li></ul><p id="0ac4f854">2. After installation, configure the agent specifying its name and the address of the TeamCity server in the <a href="build-agent-configuration.html"><code class="code">conf/buildAgent.properties</code></a> file.</p><p id="9c4a3ee2">3. <a href="#Starting-the-Build-Agent">Start</a> the agent. If the agent does not seem to run correctly, check the <a href="viewing-build-agent-logs.html">agent logs</a>.</p><p id="0cd262ea">When the newly installed agent connects to the server for the first time, it appears on the <code class="code">Agents</code> page, <code class="code">Unauthorized agents</code> tab visible to administrators/users with the permissions to authorize it. Agents will not run builds until they are authorized in the TeamCity web UI. The agent running on the same computer as the server is authorized by default.</p><p id="c54b519f">The number of authorized agents is limited by the number of agents licenses on the server. See more under <a href="licensing-policy.html">Licensing Policy</a>.</p><a name="InstallingviaWindowsinstaller"></a><a name="Installing-via-Windows-installer"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaWindowsinstaller">Installing via Windows installer</h3><ol class="list _decimal"><li class="list__item" id="7a5a9540"><p>In the TeamCity web UI, navigate to the <b id="9ad7c27f">Agents</b> tab.</p></li><li class="list__item" id="1e4a6d70"><p>Click the <b id="42b5f0b9">Install Build Agents</b> link and select <b id="e6280672">Windows Installer</b> to download the installer.</p></li><li class="list__item" id="04ee7388"><p>On the agent, run the <code class="code">agentInstaller.exe</code> Windows Installer and follow the installation instructions.</p></li></ol><aside class="note " data-title="" rel="2f81fec7" id="c6fbd55b"><p id="c666e3d8">Ensure that the user account used to run the agent service has appropriate <a href="#Necessary-OS-and-environment-permissions">permissions</a></p></aside></div><a name="InstallingviaDockerAgentImage"></a><a name="Installing-via-Docker-Agent-Image"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaDockerAgentImage">Installing via Docker Agent Image</h3><ol class="list _decimal"><li class="list__item" id="b6afc615"><p>In the TeamCity web UI, navigate to the <b id="5bd315bd">Agents</b> tab.</p></li><li class="list__item" id="d9e4b442"><p>Click the <b id="0ece0f95">Install Build Agents</b> link and select <i id="74e68bf1">Docker Agent Image</i>.</p></li><li class="list__item" id="c7cdebb1"><p>Follow the instructions on the opened <a href="https://hub.docker.com/r/jetbrains/teamcity-agent/" data-external="true" target="_blank" rel="noopener noreferrer">page</a>.</p></li></ol></div><a name="InstallingviaZIPFile"></a><a name="Installing-via-ZIP-File"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaZIPFile">Installing via ZIP File</h3><ol class="list _decimal"><li class="list__item" id="ab8b8125"><p>Make sure a JDK (JRE) 1.8.0_161 or later (Java 6-10 are supported, but 1.8.0_161+ is recommended) is properly installed on the agent computer.</p></li><li class="list__item" id="c4d97058"><p>On the agent computer, make sure the <code class="code">JRE_HOME</code> or <code class="code">JAVA_HOME</code> environment variables are set (pointing to the installed JRE or JDK directory respectively).</p></li><li class="list__item" id="3d578f0c"><p>In the TeamCity web UI, navigate to the <b id="f0e58a83">Agents</b> tab.</p></li><li class="list__item" id="639becf3"><p>Click the <b id="510b4fa9">Install Build Agents</b> link and select <b id="6ad81876">Zip file distribution</b> to download the archive.</p></li><li class="list__item" id="74d03f93"><p>Unzip the downloaded file into the desired directory.</p></li><li class="list__item" id="aee79587"><p>Navigate to the <code class="code">&lt;installation path&gt;\conf</code> directory, locate the file called <code class="code">buildAgent.dist.properties</code> and rename it to <code class="code">buildAgent.properties</code>.</p></li><li class="list__item" id="cb5dc4a5"><p>Edit the <code class="code">buildAgent.properties</code> file to specify the TeamCity server URL (HTTPS is recommended, see the <a href="#Agent-Server-Data-Transfers">notes</a>) and the name of the agent. Refer to the <a href="build-agent-configuration.html">Build Agent Configuration</a> section for details on agent configuration.</p></li><li class="list__item" id="40c2a9c3"><p>Under Linux, you may need to give execution permissions to the <code class="code">bin/agent.sh</code> shell script.</p></li></ol><aside class="tip sideblock" data-title="" rel="bd24e8b1" id="dab15784"><p id="0364d810">On Windows you may also want to install the <a href="#Build-Agent-as-a-Windows-Service">build agent windows service</a> instead of the manual agent startup.</p></aside></div><a name="InstallingviaAgentPush"></a><a name="Installing-via-Agent-Push"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-InstallingviaAgentPush">Installing via Agent Push</h3><p id="df97608a">TeamCity provides functionality that allows installing a build agent to a remote host. Currently supported combinations of the server host platform and targets for build agents are:</p><ul class="list _ul"><li class="list__item" id="44783bb8"><p>from the Unix-based TeamCity server, build agents can be installed to Unix hosts only (via SSH)</p></li><li class="list__item" id="77fe767e"><p>from the Windows-based TeamCity server, build agents can be installed to Unix (via SSH) or Windows (via psexec) hosts</p></li></ul><aside class="note " data-title="" rel="624aae60" id="a5944b20"><p id="2cc7648a"><b id="d88a24b7">SSH note</b></p><p id="587b221f">Make sure the "Password" or "Public key" authentication is enabled on the target host according to preferred authentication method.</p></aside><a name="RemoteHostRequirements"></a><a name="Remote-Host-Requirements"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-RemoteHostRequirements">Remote Host Requirements</h4><p id="8c823d5e">There are several requirements for the remote host:</p><div class="table-wrapper"><table width="100%" id="a0197b14"><thead><tr id="5012d794" class="ijRowHead"><th id="6341e94b"><p id="148c8b31">Platform</p></th><th id="be8c63ff"><p id="f642cf64">Prerequisites</p></th></tr></thead><tbody><tr id="f76b649a" class="ijRowOdd"><td id="b226cfb7"><p id="95270547">Linux</p></td><td id="420f1ea4"><p id="a84e56f5">1. Installed JDK(JRE) 6-10 (<b id="ad6ba0d8">1.8.0_161 or later is recommended</b>). The JVM should be reachable with the <code class="code">JAVA_HOME</code> (<code class="code">JRE_HOME</code>) global environment variable or be in the global path (i.e. not in user's .bashrc file, and so on)</p><p id="d79a1329">2. The <code class="code">unzip</code> utility.</p><p id="07b7b0fe">3. Either <code class="code">wget</code> or <code class="code">curl</code>.</p></td></tr><tr id="a6051499" class="ijRowEven"><td id="67baa088"><p id="a73f4bde">Windows</p></td><td id="9850272f"><p id="0554eb0d">1. Installed JDK/JRE 6-10 (<b id="325fbed8">1.8.0_161 or later</b> <b id="71c28f83">is recommended</b>).</p><p id="b549ba9d">2. <code class="code">Sysinternals psexec.exe</code> on the TeamCity server. It has to be accessible in paths. You can install it using the <b id="836d0f96">Administration</b> | <b id="2012311b">Tools</b> page. Note that PsExec applies additional requirements to a remote Windows host (for example, <a href="http://en.wikipedia.org/wiki/Administrative_share#How_to_enable_in_Windows_Vista_and_Windows_7" data-external="true" target="_blank" rel="noopener noreferrer">administrative share on remote host</a> must be accessible). Read more about <a href="http://technet.microsoft.com/en-us/sysinternals/bb897553" data-external="true" target="_blank" rel="noopener noreferrer">PsExec</a>.</p></td></tr></tbody></table></div></div><a name="Installation"></a><a name="Installation"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-Installation">Installation</h4><ol class="list _decimal"><li class="list__item" id="efa5c62c"><p>In the TeamCity Server web UI navigate to the <b id="b0d9d5d3">Agents</b> | <b id="1bea1962">Agent Push</b> tab, and click <b id="54358157">Install Agent...</b>.<br>If you are going to use same settings for several target hosts, you can <b id="1267602f">create a preset</b> with these settings, and use it each time when installing an agent to another remote host.</p></li><li class="list__item" id="aebd4d97"><p>In the <b id="841871bc">Install agent</b> dialog, either select a saved preset or choose "Use custom settings", specify the target host platform and configure corresponding settings. Agent push to a Linux system via SSH supports custom ports (the default is 22) specified as the <b id="9b85ce8c">SSH port</b> parameter. The port specified in a preset can be overridden in the host name, e.g. <code class="code">hostname.domain:2222</code>, during the actual agent installation.</p></li><li class="list__item" id="2f7a685e"><p>You may need to download <code class="code">Sysinternals psexec.exe</code>, in which case you will see the corresponding warning and a link to the <b id="3916f123">Administration</b> | <b id="06f6501a">Tools</b> page where you can download it.</p></li></ol><p id="b1cf5fbc">You can use Agent Push presets in <a href="agent-cloud-profile.html">Agent Cloud profile</a> settings to automatically install a build agent to a started cloud instance.</p></div></div></div><a name="StartingtheBuildAgent"></a><a name="Starting-the-Build-Agent"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-StartingtheBuildAgent">Starting the Build Agent</h2><p id="4a9d602e">TeamCity build agents can be started manually or configured to start automatically.</p><a name="ManualStart"></a><a name="Manual-Start"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-ManualStart">Manual Start</h3><p id="ba7d1092"><b id="ff051525">To start the agent manually</b>, run the following script:</p><ul class="list _ul"><li class="list__item" id="2106808e"><p>for Windows: <code class="code">&lt;installation path&gt;\bin\agent.bat start</code></p></li><li class="list__item" id="c1396152"><p>for Linux and macOS: <code class="code">&lt;installation path&gt;\bin\agent.sh start</code></p></li></ul></div><a name="AutomaticStart"></a><a name="Automatic-Start"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-AutomaticStart">Automatic Start</h3><p id="5f217f70">To configure the agent to be <b id="c09657db">started automatically</b>, see the corresponding sections:</p><ul class="list _ul"><li class="list__item" id="2088e90a"><a href="#Automatic-Agent-Start-under-Windows">Windows</a></li><li class="list__item" id="6b0f7c8f"><p><a href="#Automatic-Agent-Start-under-Linux">Linux</a>: configure daemon process with <code class="code">agent.sh start</code> command to start it and <code class="code">agent.sh stop</code> command to stop it.</p></li><li class="list__item" id="d8399783"><a href="#Automatic-Agent-Start-under-macOS">macOS</a></li></ul><a name="AutomaticAgentStartunderWindows"></a><a name="Automatic-Agent-Start-under-Windows"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderWindows">Automatic Agent Start under Windows</h4><p id="d1b9a05c">To run an agent automatically on the machine boot under Windows, you can either set up the agent to be run as a Windows service or use another way of the automatic process start.<br>Using the Windows service approach is the easiest way, but Windows applies <a href="known-issues.html#Agent-running-as-Windows-Service-Limitations">some constraints</a> to the processes run this way.<br>A TeamCity agent works reliably under Windows service provided all the <a href="#Necessary-OS-and-environment-permissions">requirements</a> are met, but is often not the case for the build processes configured to be run on the agent.</p><p id="53003a9c">That is why it is recommended to run a TeamCity agent as a Windows service only if all the build scripts support this. Otherwise, it is advised to use alternative OS-specific ways to start a TeamCity agent automatically.<br>One of the ways is to configure an <a href="https://support.microsoft.com/en-us/help/324737/how-to-turn-on-automatic-logon-in-windows" data-external="true" target="_blank" rel="noopener noreferrer">automatic user logon</a> on Windows start and then configure the TeamCity agent start (via <code class="code">agent.bat start</code>) on the user logon (for example, via Windows <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa383614(v=vs.85).aspx" data-external="true" target="_blank" rel="noopener noreferrer">Task Scheduler</a>).</p></div><a name="BuildAgentasaWindowsService"></a><a name="Build-Agent-as-a-Windows-Service"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-BuildAgentasaWindowsService">Build Agent as a Windows Service</h4><p id="806132fa">In Windows, you may want to run TeamCity agent as a Windows service to allow it running without any user logged on. If you use the Windows agent installer, you have an option to install the service in the installation wizard.</p><aside class="warning " data-title="" rel="806132fa" id="ae66f116"><p id="1ba846e6">To run builds, the build agent must be started under a user with sufficient permissions for performing a build and <a href="#Windows">managing</a> the service. By default, a Windows service is started under the SYSTEM account which is not recommended for production use due to extended permissions the account uses. To change it, use the standard Windows Services applet (Control Panel|Administrative Tools|Services) and change the user for the <code class="code">TeamCity Build Agent</code> service.</p></aside><aside class="tip sideblock" data-title="" rel="SettingupandRunningAdditionalBuildAgents-BuildAgentasaWindowsService" id="4e23576b"><p id="36115874">If you start an Amazon EC2 cloud agent as a Windows service, check the <a href="setting-up-teamcity-for-amazon-ec2.html#Preparing-Image-with-Installed-TeamCity-Agent">related notes</a>.</p></aside><p id="cabf77fe">The following instructions can be used to install the Windows service manually (for example, after <code class="code">.zip</code> agent installation). This procedure should also be performed to create Windows services for the <a href="#Installing-Several-Build-Agents-on-the-Same-Machine">second and following agents</a> on the same machine.</p><p id="263f21e2"><b id="672fde90">To install the service:</b></p><ol class="list _decimal"><li class="list__item" id="98207b46"><p>Check if the service with the required name and id (see #4 below, service name is <code class="code">TeamCity Build Agent</code> by default) is not present; if installed, remove it.</p></li><li class="list__item" id="7311bbf8"><p>Check that the <code class="code">wrapper.java.command</code> property in the <code class="code">&lt;agent home&gt;\launcher\conf\wrapper.conf</code> file contains a valid path to the Java executable in the JDK installation directory. You can use <code class="code">wrapper.java.command=../jre/bin/java</code> for the agent installed with the Windows distribution. Make sure to specify the path of the java.exe file without any quotes.</p></li><li class="list__item" id="2d49ac60"><p>If you want to run the agent under user account (recommended) and not "System", add the <code class="code">wrapper.ntservice.account</code> and <code class="code">wrapper.ntservice.password</code> properties to the <code class="code">&lt;agent home&gt;\launcher\conf\wrapper.conf</code> file with appropriate credentials</p></li><li class="list__item" id="a9c87442"><p>(for second and following installations) modify the <code class="code">&lt;agent&gt;\launcher\conf\wrapper.conf</code> file so that the <code class="code">wrapper.console.title</code>, <code class="code">wrapper.ntservice.name</code>, <code class="code">wrapper.ntservice.displayname</code>, and <code class="code">wrapper.ntservice.description</code> properties have unique values within the computer.</p></li><li class="list__item" id="bebf0edb"><p>Run the <code class="code">&lt;agent home&gt;\bin\service.install.bat</code> script under a user with sufficient privileges to register the new agent service. Make sure to start the agent for the first time only after it is configured as described.</p></li></ol><p id="94d16606"><b id="83695611">To start the service:</b></p><ul class="list _ul"><li class="list__item" id="52a55f42"><p>Run <code class="code">&lt;agent home&gt;/bin/service.start.bat</code> (or use standard Windows Services applet)</p></li></ul><p id="db7b950a"><b id="0fc62220">To stop the service:</b></p><ul class="list _ul"><li class="list__item" id="51920475"><p>Run <code class="code">&lt;agent home&gt;/bin/service.stop.bat</code> (or use standard Windows Services applet)</p></li></ul><p id="4e8cefa1">You can also use the standard Windows <code class="code">net.exe</code> utility to manage the service once it is installed.<br>For example (assuming the default service name):</p><div class="code-block" data-lang="bash">net start TCBuildAgent

</div><p id="8df90a1e">The <code class="code">&lt;agent home&gt;\launcher\conf\wrapper.conf</code> file can also be used to alter the agent JVM parameters.</p><p id="9a9e5d2b">The user account used to run the build agent service must have enough rights to start/stop the agent service, as described <a href="#Windows">above</a>.</p></div><a name="AutomaticAgentStartunderLinux"></a><a name="Automatic-Agent-Start-under-Linux"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartunderLinux">Automatic Agent Start under Linux</h4><p id="3ece3734">To run an agent automatically on the machine boot under Linux, configure daemon process with the <code class="code">agent.sh start</code> command to start it and <code class="code">agent.sh stop</code> command to stop it.</p><p id="0e0cb50b">For systemd, see the example <code class="code">teamcityagent.service</code> configuration file:</p><div class="code-block" data-lang="bash">[Unit]
Description=TeamCity Build Agent
After=network.target

[Service]
Type=oneshot

User=teamcityagent
Group=teamcityagent
ExecStart=/home/teamcityagent/agent/bin/agent.sh start
ExecStop=-/home/teamcityagent/agent/bin/agent.sh stop

# Support agent upgrade as the main process starts a child and exits then
RemainAfterExit=yes
# Support agent upgrade as the main process gets SIGTERM during upgrade and that maps to exit code 143
SuccessExitStatus=0 143

[Install]
WantedBy=default.target

</div><p id="fa9fe3af">For <code class="code">init.d</code>, refer to an example procedure:</p><p id="8bf4100f">1. Navigate to the services start/stop services scripts directory:</p><div class="code-block" data-lang="bash">cd /etc/init.d/

</div><p id="3b771931">2. Open the build agent service script:</p><div class="code-block" data-lang="bash">sudo vim buildAgent

</div><p id="77865004">3. Paste the following into the file :</p><div class="code-block" data-lang="none">#!/bin/sh
### BEGIN INIT INFO
# Provides:          TeamCity Build Agent
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start build agent daemon at boot time
# Description:       Enable service provided by daemon.
### END INIT INFO
#Provide the correct user name:
USER="agentuser"
 
case "$1" in
start)
 su - $USER -c "cd BuildAgent/bin ; ./agent.sh start"
;;
stop)
 su - $USER -c "cd BuildAgent/bin ; ./agent.sh stop"
;;
*)
  echo "usage start/stop"
  exit 1
 ;;
 
esac
 
exit 0

</div><p id="cedc1269">4. Set the permissions to execute the file:</p><div class="code-block" data-lang="bash">sudo chmod 755 buildAgent

</div><p id="707b7035">5. Make links to start the agent service on the machine boot and on restarts using the appropriate tool:</p><ul class="list _ul"><li class="list__item" id="a0d59b0e"><p>For Debian/Ubuntu:</p></li></ul><div class="code-block" data-lang="bash">sudo update-rc.d buildAgent defaults

</div><ul class="list _ul"><li class="list__item" id="889ab248"><p>For Red Hat/CentOS:</p></li></ul><div class="code-block" data-lang="bash">sudo chkconfig buildAgent on

</div></div><a name="AutomaticAgentStartundermacOS"></a><a name="Automatic-Agent-Start-under-macOS"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-AutomaticAgentStartundermacOS">Automatic Agent Start under macOS</h4><p id="4fdffd5f">For macOS/Mac OS X, TeamCity provides the ability to load a build agent automatically when a build user logs in.</p></div><a name="LaunchAgentApproach"></a><a name="LaunchAgent-Approach"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-LaunchAgentApproach">LaunchAgent Approach</h4><p id="7ad70713">To configure an automatic build agent startup via <code class="code">LaunchAgent</code>, follow these steps:</p><p id="de30e03f">1. Install a build agent on a Mac via <code class="code">buildAgent.zip</code>.</p><p id="78d47a2d">2. Prepare the <code class="code">conf/buildAgent.properties</code> file (set agent name there, at least).</p><p id="97edbeae">3. Make sure that all files under the <code class="code">buildAgent</code> directory are owned by <code class="code">your_build_user</code> to ensure a proper agent upgrade process.</p><p id="37f1e885">4. Load the build agent via command:</p><div class="code-block" data-lang="bash">mkdir buildAgent/logs&nbsp; # Directory should be created under your_build_user user
sh buildAgent/bin/mac.launchd.sh load

</div><p id="ea2ac72e">Run these commands under <code class="code">your_build_user</code> account.</p><p id="7b6b57f4">You have to <b id="b676a794">wait several minutes</b> for the build agent to auto-upgrade from the TeamCity server. You can watch the process in the logs:</p><div class="code-block" data-lang="bash">tail -f buildAgent/logs/teamcity-agent.log

</div><p id="c928d1f9">5. When the build agent upgrades and successfully connects to TeamCity server, stop the agent:</p><div class="code-block" data-lang="bash">sh buildAgent/bin/mac.launchd.sh unload

</div><p id="ce3bade0">6. After the build agent upgrades from the TeamCity server, copy the <code class="code">buildAgent/bin/jetbrains.teamcity.BuildAgent.plist</code> file to <code class="code">$HOME/Library/LaunchAgents/</code> directory.</p><p id="1e1058d8">7. Configure your Mac system to <b id="f89d19c2">automatically login</b> as a build user, as described <a href="https://support.apple.com/en-us/HT201476" data-external="true" target="_blank" rel="noopener noreferrer">here</a>.</p><p id="06dfbc44">8. Reboot.</p><p id="21595593">On the system startup, the build user should automatically log in, and the build agent should start.</p><p id="2f375129">To quickly check that the build agent is running, use the following command:</p><div class="code-block" data-lang="bash">launchctl list | grep BuildAgent 
69722	0	jetbrains.teamcity.BuildAgent

</div></div><a name="ConfigureaSecondBuildAgentonMacOS"></a><a name="Configure-a-Second-Build-Agent-on-Mac-OS"></a><div class="chapter"><h4 id="SettingupandRunningAdditionalBuildAgents-ConfigureaSecondBuildAgentonMacOS">Configure a Second Build Agent on Mac OS</h4><p id="e10ccafe">If you want to start several build agents, repeat the procedure of installing and starting build agent with the following changes:</p><ul class="list _ul"><li class="list__item" id="11c0ec34"><p>Install the second build agent in a different directory.</p></li><li class="list__item" id="c531dfd2"><p>In <code class="code">conf/buildAgent.properties</code> specify a different agent name.</p></li><li class="list__item" id="fb30ca7e">Do not run <code class="code">buildAgent/bin/mac.launchd.sh</code>; instead<ul class="list _ul"><li class="list__item" id="d2ce6ce7"><p>Create a copy of the <code class="code">$HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent.plist</code> file as <code class="code">$HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent2.plist</code>.</p></li><li class="list__item" id="5a8420a4">Edit the <code class="code">$HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent2.plist</code> file and set the following parameters:<ul class="list _ul"><li class="list__item" id="3b818124"><p>the <code class="code">Label</code> parameter to <code class="code">jetbrains.teamcity.BuildAgent2</code></p></li><li class="list__item" id="6f140373"><p>the <code class="code">WorkingDirectory</code> parameter to the correct path to the second build agent home</p></li></ul></li><li class="list__item" id="bd45140b"><p>Start the second agent with the command <code class="code">launchctl load $HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent2.plist</code></p></li></ul></li></ul><p id="005a9fc9">To check that both build agents are running, use the following command:</p><div class="code-block" data-lang="bash">launchctl list | grep BuildAgent 
70599	0	jetbrains.teamcity.BuildAgent2
69722	0	jetbrains.teamcity.BuildAgent

</div></div></div></div><a name="StoppingtheBuildAgent"></a><a name="Stopping-the-Build-Agent"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-StoppingtheBuildAgent">Stopping the Build Agent</h2><p id="8ac00d29"><b id="d6dba82d">To stop the agent manually</b>, run the <code class="code">&lt;Agent home&gt;\agent</code> script with a <code class="code">stop</code> parameter.</p><p id="792072a2">Use <code class="code">stop</code> to request stopping after the current build finished.<br>Use <code class="code">stop force</code> to request an immediate stop (if a build is running on the agent, it will be stopped abruptly (canceled)).<br>Under Linux, you have one more option top use <code class="code">stop kill</code> to kill the agent process.</p><p id="0205c5b2">If the agent runs with a console attached, you may also press <b id="11800818">Ctrl+C</b> in the console to stop the agent (if a build is running, it will be canceled).</p><a name="StoppingtheAgentServiceonMacOS"></a><a name="Stopping-the-Agent-Service-on-Mac-OS"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-StoppingtheAgentServiceonMacOS">Stopping the Agent Service on Mac OS</h3><p id="132e1d65">If a build agent has been started as a <code class="code">LaunchAgent</code> service, it can be stopped using the <code class="code">launchctl</code> utility:</p><div class="code-block" data-lang="bash">launchctl unload $HOME/Library/LaunchAgents/jetbrains.teamcity.BuildAgent.plist
# or  
launchctl remove jetbrains.teamcity.BuildAgent

</div></div></div><a name="ConfiguringJava"></a><a name="Configuring-Java"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-ConfiguringJava">Configuring Java</h2><p id="46ba9616">A TeamCity build agent is a Java application that requires JDK version 8-10 to work. OpenJDK 8 (for example, by <a href="https://adoptopenjdk.net/" data-external="true" target="_blank" rel="noopener noreferrer">AdoptOpenJDK</a>) 1.8.0_161 or later, 32-bit is recommended. <a href="http://www.oracle.com/technetwork/java/javase/downloads/" data-external="true" target="_blank" rel="noopener noreferrer">Oracle Java 8</a> is also supported.</p><p id="8fdeb537">A build agent contains two processes:</p><ul class="list _ul"><li class="list__item" id="859594ca"><p>Agent Launcher – a Java process that launches the agent process</p></li><li class="list__item" id="e9e7dbb7"><p>Agent – the main process for a Build Agent; runs as a child process for the agent launcher</p></li></ul><p id="bdddd9a5">The (Windows) <code class="code">.exe</code> TeamCity distribution comes bundled with OpenJDK 1.8.0_161.<br>If you run a previous version of the TeamCity agent, you will need to repeat the agent installation to update the JVM.</p><p id="ce3f5527">Using x32 bit JDK (not JRE) is recommended. JDK is required for some build runners like <a href="intellij-idea-project.html">IntelliJ IDEA Project</a>, Java <a href="inspections.html">Inspections</a>, and <a href="duplicates-finder-java.html">Duplicates</a>. If you do not have Java builds, you can install JRE instead of JDK.<br>Using of x64 bit Java is possible, but you might need to double the <code class="code">-Xmx</code> memory value for the main agent process (see <a href="configuring-build-agent-startup-properties.html">Configuring Build Agent Startup Properties</a> and alike <a href="installing-and-configuring-the-teamcity-server.html#Setting-Up-Memory-settings-for-TeamCity-Server">section</a> for the server).</p><p id="09ea92e0"><a name="java-paths"></a><a name="SettingupandRunningAdditionalBuildAgents-java-paths"></a></p><p id="c395f960">For the <code class="code">.zip</code> agent installation you need to install the appropriate Java version. Make it available via <code class="code">PATH</code> or available in one of the following places:</p><ul class="list _ul"><li class="list__item" id="90658e8b"><p>the <code class="code">&lt;Agent home&gt;/jre</code> directory</p></li><li class="list__item" id="8c79ba6a"><p>in the directory pointed to by the <code class="code">TEAMCITY_JRE</code>, <code class="code">JAVA_HOME</code> or <code class="code">JRE_HOME</code> environment variables (check that you only have one of the variables defined).</p></li><li class="list__item" id="33f42647"><p>if you plan to run the agent via Windows service, make sure to set the <code class="code">wrapper.java.command</code> property in the <code class="code">&lt;agent home&gt;\launcher\conf\wrapper.conf</code> file to a valid path to the Java executable</p></li></ul><a name="UpgradingJavaonAgents"></a><a name="Upgrading-Java-on-Agents"></a><div class="chapter"><h3 id="SettingupandRunningAdditionalBuildAgents-UpgradingJavaonAgents">Upgrading Java on Agents</h3><p id="6a4fbc48">If you are trying to launch an agent, and it is not able to find the required Java version (currently Java 6) in any of the <a href="#java-paths">default locations</a>, the agent will report an error on starting, the process will not launch, and the agent will be shown as disconnected in the TeamCity UI.</p><p id="ea2130fc">If a build agent uses a Java version older than Java 8, you will see the corresponding warning on the agent's page and a <a href="server-health.html">health item</a> in the web UI.</p><aside class="note " data-title="" rel="ea2130fc" id="6150d126"><p id="e8eaa1e3"><b id="48cbab95">Support for Java prior to version 8 on agents will be dropped in TeamCity 2019.2</b>. Consider upgrading Java on the agent if you see the warning.<br>An agent machine can have multiple Java versions installed, and the agent can use one Java version while the build tasks use other Java versions.</p><p id="f4d69d30">Please let us know using any of our <a href="https://confluence.jetbrains.com/display/TW/Feedback" data-external="true" target="_blank" rel="noopener noreferrer">support channels</a> if your setup depends on the older version of Java and if you will not be able to upgrade to version 8 for some reason.</p></aside><p id="93d13b84">It is recommended to use latest Java 8, 32 bit version.OpenJDK 8 (for example, by <a href="https://adoptopenjdk.net/" data-external="true" target="_blank" rel="noopener noreferrer">AdoptOpenJDK</a>) 1.8.0_161 or later, 32-bit is recommended. <a href="http://www.oracle.com/technetwork/java/javase/downloads/" data-external="true" target="_blank" rel="noopener noreferrer">Oracle Java 8</a> is also supported.</p><p id="e23d90ae">To update Java on agents, do one of the following:</p><ul class="list _ul"><li class="list__item" id="341488b6"><p>If the agent details page in the TeamCity UI displays a Java version note with the corresponding action, you can switch to using newer Java: if the appropriate Java version of the same bitness as the current one is detected on the agent, the agent page provides an action to switch to using that Java automatically. Upon the action invocation, the agent process is restarted (once the agent becomes idle, i.e. finishes the current build if there is one) using the new Java.</p></li><li class="list__item" id="a59180fa"><p>(Windows) Since the build agent Windows installer comes bundled with the required Java, you can just manually reinstall the agent using the Windows installer (<code class="code">.exe</code>) obtained from the TeamCity server <b id="dfa6dbc7">Agents</b> page. See <a href="#InstallingviaWindowsinstaller">installation instructions</a>. It is important to uninstall the previous version of the agent before installing the updated agent: invoke <code class="code">Uninstall.exe</code> in the agent home directory, clear all the "<i id="4937056a">Remove...</i>" checkboxes, and click <b id="64ecee85">Uninstall</b>.</p></li><li class="list__item" id="2228c1d9"><p>Install a required Java on the agent into one of the standard locations, and restart the agent - the agent should then detect it and provide an action to use a newer Java in the web UI (see above).</p></li><li class="list__item" id="3e49a4c2"><p>Install a required Java on the agent and <a href="#Configuring-Java">configure the agent</a> to use it.</p></li></ul><aside class="note " data-title="" rel="1e93a657" id="e1ee3838"><p id="7f08ebfb">In a rare case of updating the Java for the process that launches the TeamCity agent, use one of the options for the agent Java upgrade. Another way for Build Agent started as a <b id="f92a8429">Windows service</b>, is to stop the service, change the <code class="code">wrapper.java.command</code> variable in <code class="code">buildAgent\launcher\conf\wrapper.conf</code> to point to the new <code class="code">java.exe</code> binary, and restart the service.</p></aside></div></div><a name="InstallingSeveralBuildAgentsontheSameMachine"></a><a name="Installing-Several-Build-Agents-on-the-Same-Machine"></a><div class="chapter"><h2 id="SettingupandRunningAdditionalBuildAgents-InstallingSeveralBuildAgentsontheSameMachine">Installing Several Build Agents on the Same Machine</h2><p id="f8de671a">You can install several TeamCity agents on the same machine if the machine is capable of running several builds at the same time. However, we recommend running a single agent per (virtual) machine to minimize builds cross-influence and making builds more predictable. When installing several agents, it is recommended to install them under different OS users so that user-level resources (like Maven/Gradle/NuGet local artifact caches) do not conflict.</p><p id="bc497182">TeamCity treats all agents equally regardless of whether they are installed on the same or on different machines.<br>When installing several TeamCity build agents on the same machine, consider the following:</p><ul class="list _ul"><li class="list__item" id="c47037f6"><p>The builds running on such agents should not conflict by any resource (common disk directories, OS processes, OS temp directories).</p></li><li class="list__item" id="0cdb313e"><p>Depending on the hardware and the builds, you may experience degraded builds' performance. Ensure there are no disk, memory, or CPU bottlenecks when several builds are run at the same time.</p></li><li class="list__item" id="e68e774c"><p>It is recommended to set up the agents to be run under different OS users</p></li></ul><p id="b79a3ac9">After having one agent installed, you can install additional agents by following the regular installation procedure (see an exception for the Windows service below), but make sure that:</p><ul class="list _ul"><li class="list__item" id="f97d05a1"><p>The agents are installed in separate directories.</p></li><li class="list__item" id="7800c2fe"><p>The agents have the distinctive <code class="code">workDir</code> and <code class="code">tempDir</code> directories in the <a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a> file.</p></li><li class="list__item" id="ad52e0bd"><p>Values for the <code class="code">name</code> and <code class="code">ownPort</code> properties of <a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a> are unique.</p></li><li class="list__item" id="699e95aa"><p>No builds running on the agents have the absolute checkout directory specified.</p></li></ul><p id="09c83175">Make sure there are no build configurations with the absolute <a href="build-checkout-directory.html">checkout directory</a> specified (alternatively, make sure such build configurations have the "<a href="clean-checkout.html">clean checkout</a>" option enabled and they cannot be run in parallel).</p><p id="13948aa6">Usually, for a new agent installation you can just copy the directory of the existing agent to a new place with the exception of its <code class="code">temp</code>, <code class="code">work</code>, <code class="code">logs</code>, and <code class="code">system</code> directories. Then, modify <code class="code">conf/buildAgent.properties</code> with the new <code class="code">name</code>, <code class="code">ownPort</code> values. Clear (delete or remove the value) the <code class="code">authorizationToken</code> property and make sure the <code class="code">workDir</code> and <code class="code">tempDir</code> are relative/do not clash with another agent.</p><p id="1e50c439">If you are installing a second build agent on Mac OS, see additional details <a href="#Configure-a-Second-Build-Agent-on-Mac-OS">here</a>.</p><p id="6489964c">If you use Windows installer to install additional agents and want to run the agent as a service, you will need to perform manual steps as installing second agent as a service on the same machine is not supported by the installer: the existing service is overwritten (see also a <a href="http://youtrack.jetbrains.net/issue/TW-4962" data-external="true" target="_blank" rel="noopener noreferrer">feature request</a>).<br>In order to install the second agent, it is recommended to install the second agent <a href="#Installing-via-ZIP-File">manually</a> (using .zip agent distribution). You can use Windows agent installer and do not opt for service installation, but you will lose uninstall option for the initially installed agent this way.<br>After the second agent is installed, register a new service for it as mentioned in the <a href="#Build-Agent-as-a-Windows-Service">section above</a>.</p><aside class="tip sideblock" data-title="" rel="6489964c" id="338eae5b"><p id="d77c3014">For step-by-step instructions on installing a second Windows agent as a service, see a related <a href="https://handcraftsman.wordpress.com/2010/07/20/multiple-teamcity-build-agents-on-one-server/" data-external="true" target="_blank" rel="noopener noreferrer">external blog post</a>.</p></aside><hr id="4b301f2a"><p id="1ba2e471"><b id="b63b0d8e">See also:</b></p><p id="a1a3358d"><b id="2c217f9d">Concepts</b>: <a href="build-agent.html">Build Agent</a></p><hr id="dd989faf"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>