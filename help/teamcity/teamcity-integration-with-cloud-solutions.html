<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>TeamCity Integration with Cloud Solutions - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="TeamCity Integration with Cloud Solutions" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/teamcity-integration-with-cloud-solutions.md|TeamCity Integration with Cloud Solutions/setting-up-teamcity-for-amazon-ec2.md|Setting Up TeamCity for Amazon EC2/setting-up-teamcity-for-vmware-vsphere-and-vcenter.md|Setting Up TeamCity for VMware vSphere and vCenter" data-main-title="TeamCity Integration with Cloud Solutions" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/teamcity-integration-with-cloud-solutions.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="TeamCity Integration with Cloud Solutions" id="teamcity-integration-with-cloud-solutions.md">TeamCity Integration with Cloud Solutions</h1><p id="9468aa8b">On this page:</p><p id="e5885db7"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-GeneralDescription">General Description</a></li><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-AvailableIntegrations">Available Integrations</a></li><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-TeamCitySetupforCloudIntegration">TeamCity Setup for Cloud Integration</a><ul class="list _bullet"><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-PreparingavirtualmachinewithaninstalledTeamCityagent">Preparing a virtual machine with an installed TeamCity agent</a></li><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-Preparingavirtualmachine">Preparing a virtual machine</a></li><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-Capturinganimagefromavirtualmachine">Capturing an image from a virtual machine</a></li><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-ConfiguringacloudprofileinTeamCity">Configuring a cloud profile in TeamCity</a></li></ul></li><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-EstimatingCosts">Estimating Costs</a><ul class="list _bullet"><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-TrafficEstimate">Traffic Estimate</a></li><li class="list__item"><a href="#TeamCityIntegrationwithCloudSolutions-RunningCosts">Running Costs</a></li></ul></li></ul></p><p id="fa275e6e">TeamCity integration with cloud (IAAS) solutions allows TeamCity to provision virtual machines running TeamCity agents on-demand based on the build queue state.</p><p id="8a46e864">This page covers <b id="2c393f39">general information</b> about the configuration of integration. For the list of currently supported solutions, refer to <a href="#Available-Integrations">Available Integrations</a> below.</p><a name="GeneralDescription"></a><a name="General-Description"></a><div class="chapter"><h2 id="TeamCityIntegrationwithCloudSolutions-GeneralDescription">General Description</h2><p id="eecea6a3">In a large TeamCity setup with many projects, it can be difficult to predict the load on build agents, and the number of agents we need to be running. With the cloud agent integration configured, TeamCity will leverage clouds elasticity to provision additional build agents on-demand.</p><p id="9aeb4272">For each queued build TeamCity first tries to start it on one of the regular, non-cloud agents. If there are no usual agents available, TeamCity finds a matching cloud image with a compatible agent and starts a new instance for the image. TeamCity ensures that number of running cloud instances limit is not exceeded.</p><p id="7de672bb">The integration requires:</p><ul class="list _ul"><li class="list__item" id="61e968ad"><p>a configured virtual machine with an installed TeamCity agent in your cloud pre-configured to start the TeamCity agent on boot</p></li><li class="list__item" id="94bec972"><p>a configured cloud <a href="agent-cloud-profile.html">profile in TeamCity</a></p></li></ul><p id="295c46b4">Once a cloud profile is configured in TeamCity with one or several images, TeamCity does a test start of one instance for all the newly added images to learn about the agents configured on them. When the agents are connected, TeamCity stores their parameters to be able to correctly process build configurations-to-agents compatibility. An agent connected from a cloud instance started by TeamCity is automatically authorized, provided there are available agent licenses: the number of cloud agents is limited by the total number of agent licenses you have in TeamCity. After that the agent is processed as a regular agent.</p><p id="78b660ff">Depending on the profile settings, when TeamCity realizes it needs more agents, it can either:</p><ul class="list _ul"><li class="list__item" id="9272eda6"><p>start an existing virtual machine and stop it (after the build is finished or an idle timeout elapses). The machines that are stopped will be deallocated so the virtual machine fee does not apply when the agent is not active. The storage cost for this type of TeamCity agent will still apply.</p></li><li class="list__item" id="613314fa"><p>create a new virtual machine from an image. Such machines will be destroyed (after the build is finished or an idle timeout elapses). This ensures that the machines will incur no further running costs.</p></li></ul><p id="52f10414">The disconnected agent will be removed from the authorized agents list and deleted from the system to free up TeamCity build agent licenses.</p></div><a name="AvailableIntegrations"></a><a name="Available-Integrations"></a><div class="chapter"><h2 id="TeamCityIntegrationwithCloudSolutions-AvailableIntegrations">Available Integrations</h2><p id="f5fdfb9e">Integrations with cloud solutions are implemented as plugins. The platform-specific details are covered on the following pages:</p><ul class="list _ul"><li class="list__item" id="489ab9ad"><a href="setting-up-teamcity-for-amazon-ec2.html">Amazon EC2</a></li><li class="list__item" id="ca801d12"><a href="setting-up-teamcity-for-vmware-vsphere-and-vcenter.html">VMWare vSphere</a></li></ul><p id="516d3c63">Also available as non-bundled plugins are:</p><ul class="list _ul"><li class="list__item" id="6ad9434f"><a href="https://plugins.jetbrains.com/plugin/9260-azure-resource-manager-cloud-support" data-external="true" target="_blank" rel="noopener noreferrer">Windows Azure</a></li><li class="list__item" id="ae860d86"><a href="https://plugins.jetbrains.com/plugin/9704-google-cloud-agents" data-external="true" target="_blank" rel="noopener noreferrer">Google Cloud</a></li><li class="list__item" id="2e384cab"><a href="https://plugins.jetbrains.com/plugin/9818-kubernetes-support" data-external="true" target="_blank" rel="noopener noreferrer">Kubernetes</a></li></ul><p id="09bffc27">and <a href="https://plugins.jetbrains.com/category/102-cloud-support/teamcity" data-external="true" target="_blank" rel="noopener noreferrer">others</a>.</p><p id="784edb56">New integrations can be implemented as a TeamCity plugin, see <a href="https://confluence.jetbrains.com/display/TW/Implementing+Cloud+support" data-external="true" target="_blank" rel="noopener noreferrer">Implementing Cloud support</a>.</p></div><a name="TeamCitySetupforCloudIntegration"></a><a name="TeamCity-Setup-for-Cloud-Integration"></a><div class="chapter"><h2 id="TeamCityIntegrationwithCloudSolutions-TeamCitySetupforCloudIntegration">TeamCity Setup for Cloud Integration</h2><p id="4e9cad45">This section describes general steps required for cloud integration.</p><a name="PreparingavirtualmachinewithaninstalledTeamCityagent"></a><a name="Preparing-a-virtual-machine-with-an-installed-TeamCity-agent"></a><div class="chapter"><h3 id="TeamCityIntegrationwithCloudSolutions-PreparingavirtualmachinewithaninstalledTeamCityagent">Preparing a virtual machine with an installed TeamCity agent</h3><p id="ffa1dece">The requirements for a virtual machine/image to be used for TeamCity cloud integration:</p><ul class="list _ul"><li class="list__item" id="7319db80"><p>The TeamCity agent must be correctly <a href="setting-up-and-running-additional-build-agents.html">installed</a> and configured to start <a href="setting-up-and-running-additional-build-agents.html#Automatic-Start">automatically</a> on the machine startup.</p></li><li class="list__item" id="f40725b2"><p>to skip the update attempts on each agent connection to the server, make sure that the agent is up to date: start and wait for the update to complete. The agent state changes each time a plugin or tool is installed/updated/removed on the server.</p></li><li class="list__item" id="8c8c1434"><p>the <a href="project-and-agent-level-build-parameters.html"><code class="code">buildAgent.properties</code></a> file can be left "as is". The <code class="code">serverUrl</code>, <code class="code">name</code>, and <code class="code">authorizationToken</code> properties can be left empty or set to any value, they are ignored when TeamCity starts the instance <b id="ea81d1e7">unless otherwise specifically stated</b> in <a href="https://confluence.jetbrains.com/display/TW/Microsoft+Azure+cloud" data-external="true" target="_blank" rel="noopener noreferrer">the platform-specific documentation</a>.</p></li></ul><p id="4cf061a5">Provided these requirements are met, the usual TeamCity agent installation and cloud-provider image bundling procedures are applicable.</p><p id="808fe360">If you need the <a href="setting-up-and-running-additional-build-agents.html#Agent-Server-Data-Transfers">connection</a> between the server and the agent machine to be secure, you will need to set up the agent machine to establish a secure tunnel (for example, VPN) to the server on boot so that the TeamCity agent receives data via the secure channel. Keep in mind that communication between TeamCity agent and server is bi-directional and requires an open port on the agent as well as on the server.</p></div><a name="Preparingavirtualmachine"></a><a name="Preparing-a-virtual-machine"></a><div class="chapter"><h3 id="TeamCityIntegrationwithCloudSolutions-Preparingavirtualmachine">Preparing a virtual machine</h3><ol class="list _decimal"><li class="list__item" id="58bda878"><p>Create and start a virtual machine with desired OS installed.</p></li><li class="list__item" id="9e03f2ca"><p>Connect and log in to the virtual machine.</p></li><li class="list__item" id="569a98bb">Configure the running instance:<ol class="list _decimal"><li class="list__item" id="4257a5b5"><a href="setting-up-and-running-additional-build-agents.html">Install</a> and configure build agent.<ul class="list _ul"><li class="list__item" id="9f58738c"><p>Configure the server name and agent name in the <a href="project-and-agent-level-build-parameters.html"><code class="code">buildAgent.properties</code></a> file — this is optional if TeamCity will be configured to launch the image, but it is useful to test the agent is configured correctly.</p></li><li class="list__item" id="124e4a8b"><p>It usually makes sense to specify <code class="code">tempDir</code> and <code class="code">workDir</code> in <code class="code">conf/buildAgent.properties</code> to use a non-system drive (for example, <code class="code">D</code> drive under Windows)</p></li></ul></li><li class="list__item" id="bcb8af77"><p>Install any additional software necessary for the builds on the machine (for example, Java or .NET)</p></li><li class="list__item" id="942b070a"><p>Start the agent and wait until it connects to server, ensure it is working OK and is compatible with all necessary build configurations (in the TeamCity web UI, go to the <b id="d10483c9">Agents</b> page, select the build agent and view the <b id="be664cab">Compatible Configurations</b> tab), and so on.</p></li><li class="list__item" id="e58f9945"><p>Configure the system so that the agent is <a href="setting-up-and-running-additional-build-agents.html#Automatic-Start">started on the machine boot</a> (and make sure TeamCity server is accessible on the machine boot).</p></li><li class="list__item" id="ba2af3f2"><p>Check the port on which the build agent will listen for incoming data from TeamCity and open the required firewall ports (usually 9090).</p></li></ol></li><li class="list__item" id="f3a8c239"><p>Test the setup by rebooting machine and checking that the agent connects normally to the server. Once the agent connects, it will automatically update all the plugins. Wait until the agent is connected completely so that all plugins are downloaded to the agent machine.</p></li></ol><p id="7602afd5">If you want TeamCity to start an existing virtual machine and stop it after the build is finished or an idle timeout elapses, the setup above is all you need. If you want TeamCity to create and start virtual machines from an image and terminate the machine after use, the image should be captured from the virtual machine that was created.</p></div><a name="Capturinganimagefromavirtualmachine"></a><a name="Capturing-an-image-from-a-virtual-machine"></a><div class="chapter"><h3 id="TeamCityIntegrationwithCloudSolutions-Capturinganimagefromavirtualmachine">Capturing an image from a virtual machine</h3><p id="a49f8683">Do the following:</p><ol class="list _decimal"><li class="list__item" id="e75ca9dd">Complete the steps for <a href="#Preparing-a-virtual-machine">creating a virtual machine</a>.<ul class="list _ul"><li class="list__item" id="067f11a8"><p>Remove any temporary/history information in the system.</p></li><li class="list__item" id="15d893c3"><p>Stop the agent (under Windows, stop the service but leave it in the <i id="f6377c01">Automatic</i> startup type)</p></li><li class="list__item" id="ade75760"><p>(optional) Delete the content of the <code class="code">logs</code> and <code class="code">temp</code> directories in the <a href="agent-home-directory.html">agent home</a></p></li><li class="list__item" id="2762cc1b"><p>(optional) Clean up the <code class="code">&lt;Agent Home&gt;/conf/</code> directory from platform-specific files</p></li><li class="list__item" id="5c8f49c1"><p>(optional) Change the <a href="project-and-agent-level-build-parameters.html"><code class="code">buildAgent.properties</code></a> file to remove the <code class="code">name</code>, <code class="code">serverUrl</code>, and <code class="code">authorizationToken</code> properties <b id="13d68057">unless otherwise specifically stated</b> in the <a href="https://confluence.jetbrains.com/display/TW/Microsoft+Azure+cloud" data-external="true" target="_blank" rel="noopener noreferrer">platform-specific documentation</a>.</p></li></ul></li><li class="list__item" id="ef8e3230"><p>Make a new image from the running instance. Refer the cloud documentation on how to do this.</p></li></ol><aside class="note " data-title="" rel="702effbe" id="838574f1"><p id="ea83e049">TeamCity agent auto-upgrades whenever distribution of agent (for example, after TeamCity upgrade) or agent plugins on the server changes. If you want to reduce the agent startup time, you might want to capture a new virtual machine image after the agent distribution or plugins have been updated.</p></aside></div><a name="ConfiguringacloudprofileinTeamCity"></a><a name="Configuring-a-cloud-profile-in-TeamCity"></a><div class="chapter"><h3 id="TeamCityIntegrationwithCloudSolutions-ConfiguringacloudprofileinTeamCity">Configuring a cloud profile in TeamCity</h3><p id="e18c7783">A cloud profile is a collection of settings for TeamCity to start virtual machines with installed TeamCity agents on-demand. <b id="bd947ded">Prior to TeamCity 2017.1</b>, profiles are configured on the <b id="9462a55c">TeamCity | Administration | Agent Cloud</b> page. In the later versions, cloud profiles are configured in the <b id="9bb8668b">Cloud Profiles</b> section of the <b id="111cc1f0">Project Settings</b>.</p></div></div><a name="EstimatingCosts"></a><a name="Estimating-Costs"></a><div class="chapter"><h2 id="TeamCityIntegrationwithCloudSolutions-EstimatingCosts">Estimating Costs</h2><p id="aac734c1">The cloud provider pricing applies. Note that the charges can depend on the specific configuration implemented to deploy TeamCity. We advise you to check your configuration and the cloud account data regularly in order to discover and prevent unexpected charges as early as possible.</p><p id="56ffc8e6">Note that traffic volumes and necessary server and agent machines characteristics depend a big deal on the TeamCity setup and nature of the builds run.</p><a name="TrafficEstimate"></a><a name="Traffic-Estimate"></a><div class="chapter"><h3 id="TeamCityIntegrationwithCloudSolutions-TrafficEstimate">Traffic Estimate</h3><p id="c549e56d">Here are some points to help you estimate TeamCity-related traffic:</p><p id="2b0c4f2d">If the TeamCity server is not located within the same region or affinity group as the agent, the traffic between the server and agent is subject to usual external traffic charges imposed by your provider. When estimating traffic, remember that there are many types of traffic related to TeamCity (see the non-complete list below).</p><p id="cf1fedba"><b id="47a3d6bc">External connections originated by server</b>:</p><ul class="list _ul"><li class="list__item" id="88fd7669"><p>VCS servers</p></li><li class="list__item" id="638fbb39"><p>Email and Jabber servers</p></li><li class="list__item" id="62e62316"><p>Maven repositories</p></li><li class="list__item" id="f3200239"><p>NuGet repositories</p></li></ul><p id="af768b43"><b id="4fefe86b">Internal connections originated by server</b>:</p><ul class="list _ul"><li class="list__item" id="2ee42872"><p>TeamCity agents (checking status, sending commands, retrieving information like thread dumps, and so on)</p></li></ul><p id="5eb637f3"><b id="7c775780">External connections originated by agent</b>:</p><ul class="list _ul"><li class="list__item" id="fe1dcb1b"><p>VCS servers (in case of agent-side checkout)</p></li><li class="list__item" id="997223de"><p>Maven repositories</p></li><li class="list__item" id="d6e9271d"><p>NuGet repositories</p></li><li class="list__item" id="cd3d96b5"><p>any connections performed from the build process itself</p></li></ul><p id="7a284590"><b id="b421a942">Internal connections originated by agent</b>:</p><ul class="list _ul"><li class="list__item" id="1f239283"><p>TeamCity server (retrieving build sources in case of server-side checkout or personal builds, downloading artifacts, and so on)</p></li></ul><p id="984677db"><b id="687bc40b">Usual connections used by the server</b>:</p><ul class="list _ul"><li class="list__item" id="cc48b3d6"><p>Web browsers</p></li><li class="list__item" id="cceb0f1b"><p>IDE plugins</p></li></ul></div><a name="RunningCosts"></a><a name="Running-Costs"></a><div class="chapter"><h3 id="TeamCityIntegrationwithCloudSolutions-RunningCosts">Running Costs</h3><p id="f064491d">Cloud providers calculate costs based on the virtual machine uptime, so it is recommended to adjust the timeout setting according to your usual builds length. This reduces the amount of time a virtual machine is running. It is also highly recommended to set an execution timeout for all your builds so that a build hanging does not cause prolonged instance running with no payload.</p><hr id="ab9b9b9a"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>