<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>将TeamCity与Docker集成-帮助|帮助团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Integrating TeamCity with Docker" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/integrating-teamcity-with-other-tools.md|Integrating TeamCity with Other Tools/integrating-teamcity-with-docker.md|Integrating TeamCity with Docker/docker-wrapper.md|Docker Wrapper/configuring-connections-to-docker.md|Configuring Connections to Docker" data-main-title="Integrating TeamCity with Docker" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/integrating-teamcity-with-docker.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="integrating-teamcity-with-docker.md" data-toc="Integrating TeamCity with Docker">将TeamCity与Docker集成</h1><p id="81bda841">TeamCity附带Docker支持，以捆绑<a href="https://plugins.jetbrains.com/plugin/10062-docker-support" rel="noopener noreferrer" data-external="true" target="_blank">插件的形式实现</a> 。</p><p id="ea88d602">在此页：</p><p id="fde963a9"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-Requirements">要求</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-SupportedEnvironments">支持的环境</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ParametersReportedbyAgent">代理报告的参数</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-Features">特征</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerSupportBuildFeature">Docker支持构建功能</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-Clean-upofimages">图像清理</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-AutomaticLoginto/LogoutofDockerRegistry">自动登录/注销Docker Registry</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerConnectionforaProject">项目的Docker连接</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-RegistryAddressFormat">注册表地址格式</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ConnectingtoPrivateCloudRegistry">连接到私有云注册表</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ConnectingtoInsecureRegistry">连接到不安全的注册表</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerRunner">码头工人</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerCommand">Docker命令</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-RunningDockerviasudo">通过sudo运行Docker</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerComposeRunner">Docker Compose Runner</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerWrapper">Docker包装器</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerSettings">Docker设置</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-HowItWorks">怎么运行的</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-EnvironmentVariablesHandling">环境变量处理</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerDiskSpaceCleaner">Docker磁盘空间清理器</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ServiceMessagetoReportPushedImage">服务消息以报告推送的图像</a></li></ul></li></ul><p></p><a name="Requirements"></a><a name="Requirements"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-Requirements">要求</h2><p id="b8679bc9">集成需要将<a href="https://docs.docker.com/engine/installation/" rel="noopener noreferrer" data-external="true" target="_blank">Docker</a>安装在构建代理上。要使用<a href="docker-compose.html">Docker Compose</a>构建运行器，请同时安装<a href="https://docs.docker.com/compose/install/" rel="noopener noreferrer" data-external="true" target="_blank">Docker Compose</a> 。</p><a name="reqs-supported-env"></a></div><a name="SupportedEnvironments"></a><a name="Supported-Environments"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-SupportedEnvironments">支持的环境</h2><p id="d5fdff68">TeamCity Docker支持可以在Mac，Linux和Windows构建代理上运行。它使用<code class="code">docker</code>可执行文件在构建代理机器上，因此它应该可由构建代理用户运行。</p><aside class="note " rel="d5fdff68" id="2a56f582" data-title=""><ul class="list _ul"><li class="list__item" id="1a91ac3e"><p>在Linux上，如果检测到已安装的Docker，则集成将运行。</p></li><li class="list__item" id="8a52fa7f"><p>在Windows上，该集成适用于Linux和Windows容器模式。</p></li><li class="list__item" id="91e71a99"><p>在macOS上，应该为运行构建代理的用户安装对<a href="https://docs.docker.com/docker-for-mac/install/" rel="noopener noreferrer" data-external="true" target="_blank">Mac</a>的官方<a href="https://docs.docker.com/docker-for-mac/install/" rel="noopener noreferrer" data-external="true" target="_blank">Docker支持</a> 。</p></li></ul></aside></div><a name="ParametersReportedbyAgent"></a><a name="Parameters-Reported-by-Agent"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-ParametersReportedbyAgent">代理报告的参数</h2><p id="d2d2ab6b">在构建过程中，构建代理报告以下参数：</p><div class="table-wrapper"><table width="100%" id="cffd3539"><thead><tr id="eb04a19c" class="ijRowHead"><th id="4351b669"><p id="50f9f48e">参数</p></th><th id="e33c8b8f"><p id="25680781">描述</p></th></tr></thead><tbody><tr id="ece5abc7" class="ijRowOdd"><td id="95927df7"><p id="7e79c2e6"><code class="code">docker.version</code></p></td><td id="cbb6ecb7"><p id="0da98848"><a href="https://docs.docker.com/engine/reference/commandline/docker/" rel="noopener noreferrer" data-external="true" target="_blank">Docker CLI</a>版本</p></td></tr><tr id="a072c5aa" class="ijRowEven"><td id="85722f93"><p id="ab6e9202"><code class="code">dockerCompose.version</code></p></td><td id="4c7e1937"><p id="f9240b28">Docker Compose文件版本（如果使用了<a href="docker-compose.html">Docker Compose</a>构建步骤）。</p></td></tr><tr id="e1f76072" class="ijRowOdd"><td id="cbdfeea9"><p id="8e19b067"><code class="code">docker.server.version</code></p></td><td id="55783369"><p id="bdbd08f0"><a href="https://docs.docker.com/engine/reference/commandline/dockerd/" rel="noopener noreferrer" data-external="true" target="_blank">Docker Engine</a>版本</p></td></tr><tr id="72a156b6" class="ijRowEven"><td id="d994d854"><p id="286d1861"><code class="code">docker.server.osType</code></p></td><td id="e59da3d2"><p id="cd377fc6">Docker Engine OS平台可以具有<code class="code">linux</code>要么<code class="code">windows</code>值。</p></td></tr></tbody></table></div><p id="97259962">如果使用<a href="command-line.html">命令行</a>构建步骤（而不是TeamCity提供的Docker步骤），则可以将这些参数用作<a href="agent-requirements.html">代理要求，</a>以确保仅在安装了Docker的代理上运行构建。</p></div><a name="Features"></a><a name="Features"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-Features">特征</h2><p id="ddc99189">TeamСity-Docker集成提供以下功能，这些功能有助于在TeamCity下使用Docker：</p><a name="DockerSupportBuildFeature"></a><a name="Docker-Support-Build-Feature"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerSupportBuildFeature">Docker支持构建功能</h3><a name="docker-support"></a><p id="1edd9389"><a href="adding-build-features.html">添加此构建功能</a>将启用Docker事件监视： <code class="code">docker pull</code>和<code class="code">docker run</code>将被检测到。<br>构建功能将<i id="ae165812" origin="teamcity-help">Docker Info</i>选项卡添加到<a href="working-with-build-results.html">构建结果</a>页面，提供有关Docker相关操作的信息。它还提供以下选项：</p><ul class="list _ul"><li class="list__item" id="1a37ad01"><p>清理图像的能力</p></li><li class="list__item" id="43cd6ecf"><p>在构建之前自动登录到经过身份验证的注册表，并在构建之后注销该注册表</p></li></ul><p id="1a0561a3">这些选项需要配置到Docker注册表的连接：</p><p id="0afbebf3"></p><figure><img alt="Docker支持构建功能" title="Docker支持构建功能" src="/help/img/teamcity/2019.1/docker-support.png" id="798189b3" width="1056" height="944"></figure><p></p><a name="Clean-upofimages"></a><a name="Clean-up-of-images"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-Clean-upofimages">图像清理</h4><p id="07e05b28">如果您具有发布图像的构建配置，则需要在某些时候将其删除。您可以选择相应的选项，并指示TeamCity在<a href="clean-up.html">清理</a>构建本身时删除某个构建发布的图像。它的工作方式如下：发布图像时，TeamCity存储有关内部版本发布的图像注册表的信息。运行<a href="clean-up.html">服务器清理</a>并删除内部版本时，将在所有配置的连接中搜索该注册表的地址，并使用在找到的连接中指定的凭据来清除内部版本发布的映像。</p></div><a name="AutomaticLoginto/LogoutofDockerRegistry"></a><a name="Automatic-Login-to/Logout-of-Docker-Registry"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-AutomaticLoginto/LogoutofDockerRegistry">自动登录/注销Docker Registry</h4><p id="9c5b443a">如果需要在构建之前登录到需要身份验证的注册表，请选择相应的选项，并选择在<b id="1983384d" origin="teamcity-help">Project Settings中</b>配置的Docker连接。<br>构建完成后将执行自动注销。</p></div></div><a name="DockerConnectionforaProject"></a><a name="Docker-Connection-for-a-Project"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerConnectionforaProject">项目的Docker连接</h3><a name="docker-connection"></a><p id="a049965e"><b id="39ac6d96" origin="teamcity-help">项目设置|连接</b>页面允许您配置到<a href="http://docker.io/" rel="noopener noreferrer" data-external="true" target="_blank">docker.io</a> （默认）或私有Docker注册表的连接。可以将多个连接添加到项目中。该连接将在所有子项目和当前项目的构建配置中可用。</p><a name="RegistryAddressFormat"></a><a name="Registry-Address-Format"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-RegistryAddressFormat">注册表地址格式</h4><p id="4c4e1239">默认情况下，使用<a href="https://docker.io/" rel="noopener noreferrer" data-external="true" target="_blank">https://docker.io</a> 。</p><p id="06da460e">要连接到注册表，请使用以下格式： <code class="code">[http(s)://]hostname:port</code> 。</p><p id="c0f7e075">如果未指定协议，则连接结束<code class="code">https</code>默认情况下使用。</p></div><a name="ConnectingtoPrivateCloudRegistry"></a><a name="Connecting-to-Private-Cloud-Registry"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-ConnectingtoPrivateCloudRegistry">连接到私有云注册表</h4><ul class="list _ul"><li class="list__item" id="f1869233"><p>TeamCity支持存储Docker映像的Azure容器注册表；您可以使用<a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication#service-principal" rel="noopener noreferrer" data-external="true" target="_blank">服务主体</a> （主体ID和密码用作连接凭据）或<a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication#admin-account" rel="noopener noreferrer" data-external="true" target="_blank">Admin帐户进行</a>身份验证。</p></li><li class="list__item" id="fa3f0844"><p>支持Amazon Elastic Container Registry（AWS ECR）：配置连接时，请指定AWS区域和您的AWS安全凭证。</p></li></ul></div><a name="ConnectingtoInsecureRegistry"></a><a name="Connecting-to-Insecure-Registry"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-ConnectingtoInsecureRegistry">连接到不安全的注册表</h4><p id="bac063d9">要连接到不安全的注册表：</p><ol class="list _decimal"><li class="list__item" id="94ff8679"><p>按照<a href="https://docs.docker.com/registry/insecure/#deploying-a-plain-http-registry" rel="noopener noreferrer" data-external="true" target="_blank">Docker文档中</a>所述，配置安装了Docker的所有TeamCity代理以使用不安全的存储库。这足以允许通过HTTP连接到私有注册表。</p></li><li class="list__item" id="863a223c"><p>要使用自签名证书通过HTTPS连接到不安全的注册表，除了上述步骤外，请按<a href="using-https-to-access-teamcity-server.html#Configuring-client-JVM-for-trusting-server-certificate">此处</a>所述将自签名证书导入TeamCity服务器的JVM。您可以查阅Docker文档中有关<a href="https://docs.docker.com/registry/insecure/#using-self-signed-certificates" rel="noopener noreferrer" data-external="true" target="_blank">使用自签名证书的信息</a> 。</p></li></ol></div></div><a name="DockerRunner"></a><a name="Docker-Runner"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerRunner">码头工人</h3><a name="docker-runner"></a><p id="dcde103d">Docker运行程序支持<code class="code">build</code> ， <code class="code">push</code>和<code class="code">tag</code> Docker命令。</p><p id="5cc21e22">从存储库URL创建TeamCity项目/构建配置时，如果VCS存储库中存在Dockerfile，则会在自动检测过程中将运行器作为构建步骤提供。</p></div><a name="DockerCommand"></a><a name="Docker-Command"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerCommand">Docker命令</h3><a name="docker-command"></a><p id="733c5f8b">这是Docker命令的列表。根据选择的命令，以下设置将有所不同。</p><div class="table-wrapper"><table class=" wide" width="100%" id="7d87440d"><thead><tr id="56d86aa4" class="ijRowHead"><th id="8ca41146"><p id="0289156f">命令</p></th><th id="98457fff"><p id="3d487e5d">参数</p></th><th id="4ff7db88"><p id="ab7b0fce">描述</p></th></tr></thead><tbody><tr id="0292eb7a" class="ijRowOdd"><td rowspan="8" id="bf981c9a"><p id="b228e5eb">建立</p></td><td id="2b4207bc"><p id="44d01492">Dockerfile源</p></td><td id="804737e5"><p id="c01134a0">根据选择的来源，以下设置将有所不同。可用选项包括文件，URL或文件内容。</p></td></tr><tr id="d98b5900" class="ijRowEven"><td id="0cc9cc12"><p id="18ac5ad6">文件路径</p></td><td id="c12a3eae"><p id="e6761e53"><i id="860cab49" origin="teamcity-help">如果选择文件作为源，则可用</i> 。指定Docker文件的路径。该路径应相对于<a href="build-checkout-directory.html">checkout目录</a> 。</p></td></tr><tr id="baeec5fc" class="ijRowOdd"><td id="ca268b67"><p id="f1bae498">上下文文件夹</p></td><td id="0cdbfd26"><p id="e858de9f"><i id="d42a3569" origin="teamcity-help">如果选择文件作为源，则可用</i> 。指定Docker构建的上下文。如果为空，将使用Dockerfile的封闭文件夹。</p></td></tr><tr id="c6bbf758" class="ijRowEven"><td id="63f0cd4b"><p id="9271aaff">档案网址</p></td><td id="4c503a62"><p id="2191ac61"><i id="591f614c" origin="teamcity-help">如果选择URL作为源，则可用</i> 。该URL可以引用三种资源：Git存储库，预打包的tarball上下文和纯文本文件。有关详细信息，请参阅<a href="https://docs.docker.com/engine/reference/commandline/build/#extended-description" rel="noopener noreferrer" data-external="true" target="_blank">Docker文档</a> 。</p></td></tr><tr id="7d63ea71" class="ijRowOdd"><td id="6f4fdaa8"><p id="52fbacd3">文件内容</p></td><td id="f2db3a10"><p id="ce8318b7"><i id="7da581ee" origin="teamcity-help">如果文件cis选择为源，则可用</i> 。您可以在字段中输入Dockerfile的内容。</p></td></tr><tr id="18c001fd" class="ijRowEven"><td id="869fc7e2"><p id="e69b99d9">影像平台</p></td><td id="71a5b908"><p id="882ef9ac">选择<any>（默认），Linux或Windows。</any></p></td></tr><tr id="4c126f8a" class="ijRowOdd"><td id="1771ba00"><p id="d9fd2c64">图片名称：标签</p></td><td id="b7e7f101"><p id="f6f1b2be">提供以换行符分隔的图像名称列表：标签</p></td></tr><tr id="e393e1bb" class="ijRowEven"><td id="00a4cbaa"><p id="9a32c6b4">的其他参数<code class="code">build</code>命令</p></td><td id="a7a3ca56"><p id="0242526e">向docker build命令提供其他参数。有关详细信息，请参见<a href="https://docs.docker.com/engine/reference/commandline/build/" rel="noopener noreferrer" data-external="true" target="_blank">Docker文档</a> 。</p></td></tr><tr id="f6437078" class="ijRowOdd"><td rowspan="2" id="bda030aa"><p id="a1943d70">推</p></td><td id="3cca59c0"><p id="e1c95468">推送后从代理删除图像</p></td><td id="f317f7d4"><p id="faf01801">如果选择，TeamCity将使用<code class="code">docker rmi</code>在步骤结束时</p></td></tr><tr id="d9cda31f" class="ijRowEven"><td id="4c6e8fc3"><p id="955d8a02">图片名称：标签</p></td><td id="ab6d8e35"><p id="3c175059">提供以换行符分隔的图像名称列表：标签</p></td></tr><tr id="fc17667f" class="ijRowOdd"><td rowspan="3" id="b799e62e"><p id="e790740c">其他</p></td><td id="0abf0565"><p id="6bf01ece">指令名称</p></td><td id="c022915f"><p id="65b63196">Docker子命令，例如<code class="code">push</code>要么<code class="code">tag</code> 。要运行，请使用<a href="docker-wrapper.html">Docker Wrapper</a></p></td></tr><tr id="a17af26a" class="ijRowEven"><td id="31076a4d"><p id="939a7213">工作目录</p></td><td id="f0411405"></td></tr><tr id="7fcabfa8" class="ijRowOdd"><td id="915b13c9"><p id="21ff4e26">命令的其他参数</p></td><td id="bf1363d4"><p id="b97f0b5a">将传递给Docker命令的其他参数。</p></td></tr></tbody></table></div><a name="RunningDockerviasudo"></a><a name="Running-Docker-via-sudo"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-RunningDockerviasudo">通过sudo运行Docker</h4><p id="064946a6"><b id="c835ddd5" origin="teamcity-help">从TeamCity 2019.1.2开始</b> ，您可以通过以下方式在TeamCity代理上强制启动Docker命令<code class="code">sudo</code> 。添加<code class="code">teamcity.docker.use.sudo=true</code>设置在<a href="build-agent-configuration.html">构建代理配置文件中</a>或作为代理的系统属性。在代理启动时，TeamCity代理日志将通知您<code class="code">sudo</code>前缀用于运行Docker命令。</p><p id="d685a9db">配置<code class="code">sudoers</code>的档案<code class="code">sudo</code>命令，使用<a href="https://www.sudo.ws/man/1.8.17/visudo.man.html" rel="noopener noreferrer" data-external="true" target="_blank">visudo</a>如下：</p><div class="code-block" data-lang="bash">buildagentuser ALL =（全部）NOPASSWD：SETENV： <full_path_to_docker>

</full_path_to_docker></div><p id="f783c4d6">我们建议删除（或注释掉） <code class="code">Defaults requiretty</code>从的行<code class="code">sudoers</code>文件以防止<a href="https://youtrack.jetbrains.com/issue/TW-60990" rel="noopener noreferrer" data-external="true" target="_blank">docker login问题</a> 。</p></div></div><a name="DockerComposeRunner"></a><a name="Docker-Compose-Runner"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerComposeRunner">Docker Compose Runner</h3><a name="docker-compose"></a><p id="d5ba1120">运行程序允许启动<a href="https://docs.docker.com/compose/" rel="noopener noreferrer" data-external="true" target="_blank">Docker Compose</a>构建服务，并在构建结束时关闭这些服务。</p><p id="2c125c56">Docker Compose运行器支持一个或多个<a href="https://docs.docker.com/compose/compose-file/compose-file-v2/" rel="noopener noreferrer" data-external="true" target="_blank">Docker Compose YAML文件</a> ，并描述了在构建期间要使用的服务。通往的道路<code class="code">docker-compose.yml</code>文件应相对于<a href="build-checkout-directory.html">checkout目录</a> 。指定多个文件时，请用空格隔开。</p><p id="06d9ac2d">执行的命令是：</p><div class="code-block" data-lang="bash">＃这些命令在docker-compose文件所在的当前工作目录中执行。docker-compose -f <docker-compose.yml>[-f <docker-compose2.yml>] up -d＃在构建结束时，对于每个docker compose构建步骤，构建代理将运行：docker-compose -f <docker-compose.yml>[-f <docker-compose2.yml>] down -v</docker-compose2.yml></docker-compose.yml></docker-compose2.yml></docker-compose.yml></div><p id="d70de0df">如果<b id="ed096f7c" origin="teamcity-help">明确</b>启用了复选框<b id="ed096f7c" origin="teamcity-help">拉取图像</b> ， <code class="code">docker-compose pull</code>将在<code class="code">docker-compose up</code>命令。</p><p id="9e6afbb1">当将Docker Compose与支持<a href="https://docs.docker.com/engine/reference/builder/#healthcheck" rel="noopener noreferrer" data-external="true" target="_blank">HEALTHCHECK的</a>映像<a href="https://docs.docker.com/engine/reference/builder/#healthcheck" rel="noopener noreferrer" data-external="true" target="_blank">一起使用时</a> ，TeamCity将等待<code class="code">healthy</code>支持此参数的所有容器的状态。</p><p id="b5765338">如果Docker Compose启动成功，TeamCity代理将注册<code class="code">TEAMCITY_DOCKER_NETWORK</code>环境变量，其中包含Docker Compose默认网络的名称。在某些构建运行<a href="#Docker-Wrapper">器中</a>使用时，该网络将透明地传递给<a href="#Docker-Wrapper">Docker包装器</a> 。</p></div><a name="DockerWrapper"></a><a name="Docker-Wrapper"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerWrapper">Docker包装器</h3><p id="9de8fb7f">TeamCity为<a href="command-line.html">命令行</a> ， <a href="maven.html">Maven</a> ， <a href="ant.html">Ant</a>和<a href="gradle.html">Gradle运行</a>器提供了Docker Wrapper扩展。每个受支持的运行器都有专用的Docker设置部分。</p><a name="DockerSettings"></a><a name="Docker-Settings"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-DockerSettings">Docker设置</h4><a name="docker-settings"></a><p id="5dd68ee8">在构建步骤设置的“ <i id="c602e299" origin="teamcity-help">Docker设置”</i>部分中，您可以指定将用于运行构建步骤的Docker映像。指定图像后，以下所有选项将变为可用。</p><div class="table-wrapper"><table width="100%" id="60bc9138"><thead><tr id="99643f10" class="ijRowHead"><th id="a6a78f69"><p id="b29e0aed">设置</p></th><th id="c5ca8228"><p id="65d96ae0">描述</p></th></tr></thead><tbody><tr id="26da35ff" class="ijRowOdd"><td id="b06843ff"><p id="2bb461db">在Docker容器中运行步骤</p></td><td id="afa5c11c"><p id="6604ef15">按照Docker Hub中所述指定Docker映像名称。TeamCity将从指定的映像启动一个容器，并将尝试在该容器中运行此构建步骤。</p><p id="323718a2">例如， <code class="code">ruby:2.4</code>将在Ruby容器2.4版中运行该步骤。</p></td></tr><tr id="6811d7ea" class="ijRowEven"><td id="a192ea51"><p id="8771ebdf">Docker映像平台</p></td><td id="459f98f8"><p id="ffa40598">选择<any>（默认），Linux或Windows。</any></p></td></tr><tr id="1c6f3298" class="ijRowOdd"><td id="83d18ab1"><p id="c0ba05f0">显式拉取图像</p></td><td id="f449c141"><p id="06d4b3d0">如果启用，映像将通过以下方式从集线器存储库中提取<code class="code">docker pull <imageName></code>之前<code class="code">docker run</code>命令启动。</p></td></tr><tr id="b6650106" class="ijRowEven"><td id="6b3ccff7"><p id="8bd38e21">其他Docker运行参数</p></td><td id="414688aa"><p id="5f8954fe">允许指定其他选项<code class="code">docker run</code> 。默认参数是<code class="code">--rm</code> ，但您可以提供更多，例如，添加其他卷映射。</p><aside class="note " rel="5f8954fe" id="238006ee" data-title=""><p id="a173c0f5">在此字段中，无法使用以下命令引用环境变量<code class="code">%env.FOO_BAR%</code>语法，因为TeamCity不会将环境变量从构建代理传递到Docker容器中。</p><p id="95885c60">如果需要在代理上引用环境变量，请定义配置参数<code class="code">system.FOO_BAR=env_var_value</code>在<code class="code">buildAgent.properties</code>并通过引用<code class="code">%system.FOO_BAR%</code> 。</p></aside></td></tr></tbody></table></div></div><a name="HowItWorks"></a><a name="How-It-Works"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-HowItWorks">怎么运行的</h4><a name="docker-settings-how"></a><p id="9f184caa">从技术上讲，构建运行器的命令包装在shell脚本中，并且该脚本在Docker容器内执行， <code class="code">docker run</code>命令。有关启动过程，脚本文本等的所有详细信息都被写入到构建日志中（ <i id="81225c8f" origin="teamcity-help">详细</i>模式使您可以查看它们）。</p><p id="a1f05faf"><a href="build-checkout-directory.html">checkout目录</a>和大多数构建代理目录都映射在Docker进程内部。</p><p id="fa2864be">在使用Docker包装器的构建步骤结束时，一个构建代理运行<code class="code">chown</code>命令以恢复对<code class="code">buildAgent</code>用户到检出目录。当使用Docker容器创建Docker容器中的文件时，这可以缓解可能的问题<code class="code">root</code>所有权，以后不能由构建代理删除。</p><p id="55b82a41">如果流程环境包含<code class="code">TEAMCITY_DOCKER_NETWORK</code>由上一个<a href="docker-compose.html">Docker Compose</a>构建步骤设置的环境变量，此网络将传递给已启动的<code class="code">docker run</code>用命令<code class="code">--network</code>开关。</p></div><a name="EnvironmentVariablesHandling"></a><a name="Environment-Variables-Handling"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-EnvironmentVariablesHandling">环境变量处理</h4><a name="docker-settings-env-var"></a><p id="efb34704">TeamCity将环境变量从<a href="build-configuration.html">构建配置</a>传递到Docker进程中，但不会将环境变量从<a href="build-agent.html">构建代理</a>传递到Docker进程中，因为它们可能与Docker容器环境无关。可以在构建日志的<a href="build-log.html#Viewing-Build-Log">详细模式下</a>查看传递的环境变量的列表。</p></div></div><a name="DockerDiskSpaceCleaner"></a><a name="Docker-Disk-Space-Cleaner"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerDiskSpaceCleaner">Docker磁盘空间清理器</h3><p id="3c1b151f">Docker Disk Space Cleaner是<a href="free-disk-space.html">Free Disk Space</a>构建功能的扩展，可确保构建需要一定数量的磁盘空间。</p><p id="deae056e">TeamCity定期清理与TeamCity相关的Docker映像：</p><ul class="list _ul"><li class="list__item" id="2100d37a"><p>TeamCity代理会跟踪在构建过程中标记或提取的Docker映像（映像列表存储在<code class="code">buildAgent/system/docker-used-images.dat</code>文件）。</p></li><li class="list__item" id="33f59d74"><p>在清理/释放磁盘空间期间，如果在随后尝试释放磁盘空间的3天（1天零）内未使用这些映像，TeamCity代理将尝试删除这些映像。</p></li></ul><p id="09111ee8">除此之外，TeamCity使用以下命令清除本地Docker缓存：</p><ul class="list _ul"><li class="list__item" id="ada738ab"><p><b id="97e924df">从2018.1.2开始</b> ： <code class="code">docker system prune --volumes</code> 。适用于Docker v.17.06.1或更高版本。</p></li><li class="list__item" id="dbe7ba98"><p><b id="834fe77a">在2018.1.2之前</b> ：<code class="code">docker system prune -a</code></p></li></ul></div><a name="ServiceMessagetoReportPushedImage"></a><a name="Service-Message-to-Report-Pushed-Image"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-ServiceMessagetoReportPushedImage">服务消息以报告推送的图像</h3><p id="752d8a18">如果TeamCity（由于某种原因）无法确定已推送图像，则用户可以发送特殊的<a href="build-script-interaction-with-teamcity.html">服务消息</a>以将该信息报告给TeamCity服务器：</p><div class="code-block" data-lang="bash">## teamcity [dockerMessage type ='dockerImage.push'value =' <full_image_tag>，size： <size in="" bytes="">，digest： <hash>']</hash></size></full_image_tag></div><p id="6f05030e">例如：</p><div class="code-block" data-lang="bash">## teamcity [dockerMessage type ='dockerImage.push'value ='myRegistry / repo-test：17，size：2632，digest：sha256：8dc5a195c3dcdc7c288d16288ff3f9ab1d8a5a230e09afb9c8dc9215e861aa55']</div><hr id="38bbea18"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>