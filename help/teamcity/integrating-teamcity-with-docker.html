<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Integrating TeamCity with Docker - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Integrating TeamCity with Docker" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/integrating-teamcity-with-other-tools.md|Integrating TeamCity with Other Tools/integrating-teamcity-with-docker.md|Integrating TeamCity with Docker/docker-wrapper.md|Docker Wrapper/configuring-connections-to-docker.md|Configuring Connections to Docker" data-main-title="Integrating TeamCity with Docker" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/integrating-teamcity-with-docker.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Integrating TeamCity with Docker" id="integrating-teamcity-with-docker.md">Integrating TeamCity with Docker</h1><p id="81bda841">TeamCity comes with Docker Support, implemented as a bundled <a href="https://plugins.jetbrains.com/plugin/10062-docker-support" data-external="true" target="_blank" rel="noopener noreferrer">plugin</a>.</p><p id="ea88d602">On this page:</p><p id="fde963a9"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-Requirements">Requirements</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-SupportedEnvironments">Supported Environments</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ParametersReportedbyAgent">Parameters Reported by Agent</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-Features">Features</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerSupportBuildFeature">Docker Support Build Feature</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-Clean-upofimages">Clean-up of images</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-AutomaticLoginto/LogoutofDockerRegistry">Automatic Login to/Logout of Docker Registry</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerConnectionforaProject">Docker Connection for a Project</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-RegistryAddressFormat">Registry Address Format</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ConnectingtoPrivateCloudRegistry">Connecting to Private Cloud Registry</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ConnectingtoInsecureRegistry">Connecting to Insecure Registry</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerRunner">Docker Runner</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerCommand">Docker Command</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-RunningDockerviasudo">Running Docker via sudo</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerComposeRunner">Docker Compose Runner</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerWrapper">Docker Wrapper</a><ul class="list _bullet"><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerSettings">Docker Settings</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-HowItWorks">How It Works</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-EnvironmentVariablesHandling">Environment Variables Handling</a></li></ul></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-DockerDiskSpaceCleaner">Docker Disk Space Cleaner</a></li><li class="list__item"><a href="#IntegratingTeamCitywithDocker-ServiceMessagetoReportPushedImage">Service Message to Report Pushed Image</a></li></ul></li></ul></p><a name="Requirements"></a><a name="Requirements"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-Requirements">Requirements</h2><p id="b8679bc9">The integration requires <a href="https://docs.docker.com/engine/installation/" data-external="true" target="_blank" rel="noopener noreferrer">Docker</a> installed on the build agents. To use the <a href="docker-compose.html">Docker Compose</a> build runner, install <a href="https://docs.docker.com/compose/install/" data-external="true" target="_blank" rel="noopener noreferrer">Docker Compose</a> as well.</p><a name="reqs-supported-env"></a></div><a name="SupportedEnvironments"></a><a name="Supported-Environments"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-SupportedEnvironments">Supported Environments</h2><p id="d5fdff68">TeamCity Docker Support can run on Mac, Linux, and Windows build agents. It uses the <code class="code">docker</code> executable on the build agent machine, so it should be runnable by the build agent user.</p><aside class="note " data-title="" rel="d5fdff68" id="2a56f582"><ul class="list _ul"><li class="list__item" id="1a91ac3e"><p>On Linux, the integration will run if the installed Docker is detected.</p></li><li class="list__item" id="8a52fa7f"><p>On Windows, the integration works for Linux and Windows container modes.</p></li><li class="list__item" id="91e71a99"><p>On macOS, the official <a href="https://docs.docker.com/docker-for-mac/install/" data-external="true" target="_blank" rel="noopener noreferrer">Docker support for Mac</a> should be installed for the user running the build agent.</p></li></ul></aside></div><a name="ParametersReportedbyAgent"></a><a name="Parameters-Reported-by-Agent"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-ParametersReportedbyAgent">Parameters Reported by Agent</h2><p id="d2d2ab6b">During the build, the build agent reports the following parameters:</p><div class="table-wrapper"><table width="100%" id="cffd3539"><thead><tr id="eb04a19c" class="ijRowHead"><th id="4351b669"><p id="50f9f48e">Parameter</p></th><th id="e33c8b8f"><p id="25680781">Description</p></th></tr></thead><tbody><tr id="ece5abc7" class="ijRowOdd"><td id="95927df7"><p id="7e79c2e6"><code class="code">docker.version</code></p></td><td id="cbb6ecb7"><p id="0da98848"><a href="https://docs.docker.com/engine/reference/commandline/docker/" data-external="true" target="_blank" rel="noopener noreferrer">Docker CLI</a> version</p></td></tr><tr id="a072c5aa" class="ijRowEven"><td id="85722f93"><p id="ab6e9202"><code class="code">dockerCompose.version</code></p></td><td id="4c7e1937"><p id="f9240b28">The Docker Compose file version, if the <a href="docker-compose.html">Docker Compose</a> build step is used.</p></td></tr><tr id="e1f76072" class="ijRowOdd"><td id="cbdfeea9"><p id="8e19b067"><code class="code">docker.server.version</code></p></td><td id="55783369"><p id="bdbd08f0"><a href="https://docs.docker.com/engine/reference/commandline/dockerd/" data-external="true" target="_blank" rel="noopener noreferrer">Docker Engine</a> version</p></td></tr><tr id="72a156b6" class="ijRowEven"><td id="d994d854"><p id="286d1861"><code class="code">docker.server.osType</code></p></td><td id="e59da3d2"><p id="cd377fc6">The Docker Engine OS platform, can have the <code class="code">linux</code> or <code class="code">windows</code> value.</p></td></tr></tbody></table></div><p id="97259962">If you are using the <a href="command-line.html">Command Line</a> build step (and not the TeamCity-provided Docker steps), these parameters can be used as <a href="agent-requirements.html">agent requirements</a> to ensure your build is run only on the agents with Docker installed.</p></div><a name="Features"></a><a name="Features"></a><div class="chapter"><h2 id="IntegratingTeamCitywithDocker-Features">Features</h2><p id="ddc99189">Team–°ity-Docker integration provides the following features which facilitate working with Docker under TeamCity:</p><a name="DockerSupportBuildFeature"></a><a name="Docker-Support-Build-Feature"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerSupportBuildFeature">Docker Support Build Feature</h3><a name="docker-support"></a><p id="1edd9389"><a href="adding-build-features.html">Adding this build feature</a> will enable Docker events monitoring: such operations as <code class="code">docker pull</code> and <code class="code">docker run</code> will be detected.<br>The build feature adds the <i origin="teamcity-help" id="ae165812">Docker Info</i> tab to the <a href="working-with-build-results.html">build results</a> page providing information on Docker-related operations. It also provides the following options:</p><ul class="list _ul"><li class="list__item" id="1a37ad01"><p>ability to clean-up the images</p></li><li class="list__item" id="43cd6ecf"><p>automatic login to an authenticated registry before the build and logout of it after the build</p></li></ul><p id="1a0561a3">These options require a configured connection to a docker registry:</p><p id="0afbebf3"><figure><img alt="Docker Support build feature" title="Docker Support build feature" src="/help/img/teamcity/2019.1/docker-support.png" id="798189b3" width="1056" height="944"></figure></p><a name="Clean-upofimages"></a><a name="Clean-up-of-images"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-Clean-upofimages">Clean-up of images</h4><p id="07e05b28">If you have a build configuration which publishes images, you need to remove them at some point. You can select the corresponding option and instruct TeamCity to remove the images published by a certain build when the build itself is <a href="clean-up.html">cleaned up</a>. It works as follows: when an image is published, TeamCity stores the information about the registry of the images published by the build. When the <a href="clean-up.html">server clean-up</a> is run and it deletes the build, all the configured connections are searched for the address of this registry, and the images published by the build are cleaned up using the credentials specified in the connection found.</p></div><a name="AutomaticLoginto/LogoutofDockerRegistry"></a><a name="Automatic-Login-to/Logout-of-Docker-Registry"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-AutomaticLoginto/LogoutofDockerRegistry">Automatic Login to/Logout of Docker Registry</h4><p id="9c5b443a">If you need to log in to a registry requiring authentication before a build, select the corresponding option and a connection to Docker configured in the <b origin="teamcity-help" id="1983384d">Project Settings</b>.<br>Automatic logout will be performed after the build finishes.</p></div></div><a name="DockerConnectionforaProject"></a><a name="Docker-Connection-for-a-Project"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerConnectionforaProject">Docker Connection for a Project</h3><a name="docker-connection"></a><p id="a049965e">The <b origin="teamcity-help" id="39ac6d96">Project Settings | Connections</b> page allows you to configure a connection to <a href="http://docker.io/" data-external="true" target="_blank" rel="noopener noreferrer">docker.io</a> (default) or a private Docker registry. More than one connection can be added to the project. The connection will be available in all the subprojects and build configurations of the current project.</p><a name="RegistryAddressFormat"></a><a name="Registry-Address-Format"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-RegistryAddressFormat">Registry Address Format</h4><p id="4c4e1239">By default, <a href="https://docker.io/" data-external="true" target="_blank" rel="noopener noreferrer">https://docker.io</a> is used.</p><p id="06da460e">To connect to a registry, use the following format: <code class="code">[http(s)://]hostname:port</code>.</p><p id="c0f7e075">If the protocol is not specified, the connection over <code class="code">https</code> is used by default.</p></div><a name="ConnectingtoPrivateCloudRegistry"></a><a name="Connecting-to-Private-Cloud-Registry"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-ConnectingtoPrivateCloudRegistry">Connecting to Private Cloud Registry</h4><ul class="list _ul"><li class="list__item" id="f1869233"><p>TeamCity supports the Azure container registry storing Docker images; you can authenticate using <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication#service-principal" data-external="true" target="_blank" rel="noopener noreferrer">Service principal</a> (the principal ID and password are used as connection credentials) or <a href="https://docs.microsoft.com/en-us/azure/container-registry/container-registry-authentication#admin-account" data-external="true" target="_blank" rel="noopener noreferrer">Admin account</a>.</p></li><li class="list__item" id="fa3f0844"><p>Amazon Elastic Container Registry (AWS ECR) is supported: specify the AWS region and your AWS Security Credentials when configuring the connection.</p></li></ul></div><a name="ConnectingtoInsecureRegistry"></a><a name="Connecting-to-Insecure-Registry"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-ConnectingtoInsecureRegistry">Connecting to Insecure Registry</h4><p id="bac063d9">To connect to an insecure registry:</p><ol class="list _decimal"><li class="list__item" id="94ff8679"><p>Configure all TeamCity agents where Docker is installed to work with insecure repositories as stated in the <a href="https://docs.docker.com/registry/insecure/#deploying-a-plain-http-registry" data-external="true" target="_blank" rel="noopener noreferrer">Docker documentation</a>. This is sufficient to allow the connection to the private registry over HTTP.</p></li><li class="list__item" id="863a223c"><p>To connect to an insecure registry over HTTPS with a self-signed certificate, in addition to the step above, import the self-signed certificate to the JVM of the TeamCity server as described <a href="using-https-to-access-teamcity-server.html#Configuring-client-JVM-for-trusting-server-certificate">here</a>. You can consult the Docker documentation on <a href="https://docs.docker.com/registry/insecure/#using-self-signed-certificates" data-external="true" target="_blank" rel="noopener noreferrer">using self-signed certificates</a>.</p></li></ol></div></div><a name="DockerRunner"></a><a name="Docker-Runner"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerRunner">Docker Runner</h3><a name="docker-runner"></a><p id="dcde103d">The Docker runner supports the <code class="code">build</code>, <code class="code">push</code>, and <code class="code">tag</code> Docker commands.</p><p id="5cc21e22">When creating TeamCity projects / build configurations from a repository URL, the runner is offered as build step during auto-detection, provided a Dockerfile is present in the VCS repository.</p></div><a name="DockerCommand"></a><a name="Docker-Command"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerCommand">Docker Command</h3><a name="docker-command"></a><p id="733c5f8b">Here is the list of the Docker commands. Depending on the selected command, the settings below will vary.</p><div class="table-wrapper"><table class=" wide" width="100%" id="7d87440d"><thead><tr id="56d86aa4" class="ijRowHead"><th id="8ca41146"><p id="0289156f">Command</p></th><th id="98457fff"><p id="3d487e5d">Parameter</p></th><th id="4ff7db88"><p id="ab7b0fce">Description</p></th></tr></thead><tbody><tr id="0292eb7a" class="ijRowOdd"><td rowspan="8" id="bf981c9a"><p id="b228e5eb">build</p></td><td id="2b4207bc"><p id="44d01492">Dockerfile source</p></td><td id="804737e5"><p id="c01134a0">Depending on the selected source, the settings below will vary. The available options include File, a URL or File content.</p></td></tr><tr id="d98b5900" class="ijRowEven"><td id="0cc9cc12"><p id="18ac5ad6">Path to file</p></td><td id="c12a3eae"><p id="e6761e53"><i origin="teamcity-help" id="860cab49">Available if File is selected as the source</i>. Specify the path to the Docker file. The path should be relative to the <a href="build-checkout-directory.html">checkout directory</a>.</p></td></tr><tr id="baeec5fc" class="ijRowOdd"><td id="ca268b67"><p id="f1bae498">Context folder</p></td><td id="0cdbfd26"><p id="e858de9f"><i origin="teamcity-help" id="d42a3569">Available if File is selected as the source</i>. Specify the context for the Docker build. If blank, the enclosing folder for Dockerfile will be used.</p></td></tr><tr id="c6bbf758" class="ijRowEven"><td id="63f0cd4b"><p id="9271aaff">URL to file</p></td><td id="4c503a62"><p id="2191ac61"><i origin="teamcity-help" id="591f614c">Available if URL is selected as the source</i>. The URL can refer to three kinds of resources: Git repositories, pre-packaged tarball contexts, and plain text files. See the <a href="https://docs.docker.com/engine/reference/commandline/build/#extended-description" data-external="true" target="_blank" rel="noopener noreferrer">Docker documentation</a> for details.</p></td></tr><tr id="7d63ea71" class="ijRowOdd"><td id="6f4fdaa8"><p id="52fbacd3">File Content</p></td><td id="f2db3a10"><p id="ce8318b7"><i origin="teamcity-help" id="7da581ee">Available if the file cis selected as the source</i>. You can enter the content of the Dockerfile into the field.</p></td></tr><tr id="18c001fd" class="ijRowEven"><td id="869fc7e2"><p id="e69b99d9">Image platform</p></td><td id="71a5b908"><p id="882ef9ac">Select &lt;Any&gt; (default), Linux or Windows.</p></td></tr><tr id="4c126f8a" class="ijRowOdd"><td id="1771ba00"><p id="d9fd2c64">Image name:tag</p></td><td id="b7e7f101"><p id="f6f1b2be">Provide a newline-separated list of image name:tag(s)</p></td></tr><tr id="e393e1bb" class="ijRowEven"><td id="00a4cbaa"><p id="9a32c6b4">Additional arguments for the <code class="code">build</code> command</p></td><td id="a7a3ca56"><p id="0242526e">Supply additional arguments to the docker build command. See <a href="https://docs.docker.com/engine/reference/commandline/build/" data-external="true" target="_blank" rel="noopener noreferrer">Docker documentation</a> for details.</p></td></tr><tr id="f6437078" class="ijRowOdd"><td rowspan="2" id="bda030aa"><p id="a1943d70">push</p></td><td id="3cca59c0"><p id="e1c95468">Remove image from agent after push</p></td><td id="f317f7d4"><p id="faf01801">If selected, TeamCity will remove the image with <code class="code">docker rmi</code> at the end of the step</p></td></tr><tr id="d9cda31f" class="ijRowEven"><td id="4c6e8fc3"><p id="955d8a02">Image name:tag</p></td><td id="ab6d8e35"><p id="3c175059">Provide a newline-separated list of image name:tag(s)</p></td></tr><tr id="fc17667f" class="ijRowOdd"><td rowspan="3" id="b799e62e"><p id="e790740c">other</p></td><td id="0abf0565"><p id="6bf01ece">Command name</p></td><td id="c022915f"><p id="65b63196">Docker sub-command, like <code class="code">push</code> or <code class="code">tag</code>. For run, use <a href="docker-wrapper.html">Docker Wrapper</a></p></td></tr><tr id="a17af26a" class="ijRowEven"><td id="31076a4d"><p id="939a7213">Working directory</p></td><td id="f0411405"></td></tr><tr id="7fcabfa8" class="ijRowOdd"><td id="915b13c9"><p id="21ff4e26">Additional arguments for the command</p></td><td id="bf1363d4"><p id="b97f0b5a">Additional arguments that will be passed to the Docker command.</p></td></tr></tbody></table></div><a name="RunningDockerviasudo"></a><a name="Running-Docker-via-sudo"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-RunningDockerviasudo">Running Docker via sudo</h4><p id="064946a6"><b origin="teamcity-help" id="c835ddd5">Since TeamCity 2019.1.2</b>, you can enforce starting Docker commands on a TeamCity agent via <code class="code">sudo</code>. Add the <code class="code">teamcity.docker.use.sudo=true</code> setting in the <a href="build-agent-configuration.html">build agent configuration file</a> or as an agent's system property. On an agent start, the TeamCity agent log will inform that the <code class="code">sudo</code> prefix is used to run Docker commands.</p><p id="d685a9db">To configure the <code class="code">sudoers</code> file for the <code class="code">sudo</code> command, use <a href="https://www.sudo.ws/man/1.8.17/visudo.man.html" data-external="true" target="_blank" rel="noopener noreferrer">visudo</a> as follows:</p><div class="code-block" data-lang="bash">buildagentuser ALL=(ALL) NOPASSWD:SETENV:&lt;full_path_to_docker&gt;

</div><p id="f783c4d6">We recommend removing (or commenting out) the <code class="code">Defaults requiretty</code> line from the <code class="code">sudoers</code> file to prevent the <a href="https://youtrack.jetbrains.com/issue/TW-60990" data-external="true" target="_blank" rel="noopener noreferrer">problem with docker login</a>.</p></div></div><a name="DockerComposeRunner"></a><a name="Docker-Compose-Runner"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerComposeRunner">Docker Compose Runner</h3><a name="docker-compose"></a><p id="d5ba1120">The runner allows starting <a href="https://docs.docker.com/compose/" data-external="true" target="_blank" rel="noopener noreferrer">Docker Compose</a> build services and shutting down those services at the end of the build.</p><p id="2c125c56">The Docker Compose runner supports one or several <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/" data-external="true" target="_blank" rel="noopener noreferrer">Docker Compose YAML file(s)</a> with a description of the services to be used during the build. The path to the <code class="code">docker-compose.yml</code> file(s) should be relative to the <a href="build-checkout-directory.html">checkout directory</a>. When specifying several files, separate them with a space.</p><p id="06d9ac2d">The executed commands are:</p><div class="code-block" data-lang="bash">
# The commands are executed with the current working directory, where the docker-compose file resides.
docker-compose -f &lt;docker-compose.yml&gt; [-f &lt;docker-compose2.yml&gt;] up -d

# At the end of the build, for each docker compose build step the build agent will run:
docker-compose -f &lt;docker-compose.yml&gt; [-f &lt;docker-compose2.yml&gt;] down -v

</div><p id="d70de0df">If the checkbox <b origin="teamcity-help" id="ed096f7c">pull image explicitly</b> is enabled, <code class="code">docker-compose pull</code> will be run before the <code class="code">docker-compose up</code> command.</p><p id="9e6afbb1">When using Docker Compose with images which support <a href="https://docs.docker.com/engine/reference/builder/#healthcheck" data-external="true" target="_blank" rel="noopener noreferrer">HEALTHCHECK</a>, TeamCity will wait for the <code class="code">healthy</code> status of all containers that support this parameter.</p><p id="b5765338">If the start of Docker Compose was successful, the TeamCity agent will register the <code class="code">TEAMCITY_DOCKER_NETWORK</code> environment variable containing the name of the Docker Compose default network. This network will be passed transparently to the <a href="#Docker-Wrapper">Docker Wrapper</a> when used in some build runners.</p></div><a name="DockerWrapper"></a><a name="Docker-Wrapper"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerWrapper">Docker Wrapper</h3><p id="9de8fb7f">TeamCity provides the Docker Wrapper extension for <a href="command-line.html">Command Line</a>, <a href="maven.html">Maven</a>, <a href="ant.html">Ant</a>, and <a href="gradle.html">Gradle</a> runners. Each of the supported runners has the dedicated Docker settings section.</p><a name="DockerSettings"></a><a name="Docker-Settings"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-DockerSettings">Docker Settings</h4><a name="docker-settings"></a><p id="5dd68ee8">In the <i origin="teamcity-help" id="c602e299">Docker Settings</i> section of the build step settings, you can specify a Docker image which will be used to run the build step. Once an image is specified, all the following options become available.</p><div class="table-wrapper"><table width="100%" id="60bc9138"><thead><tr id="99643f10" class="ijRowHead"><th id="a6a78f69"><p id="b29e0aed">Setting</p></th><th id="c5ca8228"><p id="65d96ae0">Description</p></th></tr></thead><tbody><tr id="26da35ff" class="ijRowOdd"><td id="b06843ff"><p id="2bb461db">Run step within Docker container</p></td><td id="afa5c11c"><p id="6604ef15">Specify a Docker image name as stated in the Docker Hub. TeamCity will start a container from the specified image and will try to run this build step within this container.</p><p id="323718a2">For example, <code class="code">ruby:2.4</code> will run the step within the Ruby container, version 2.4.</p></td></tr><tr id="6811d7ea" class="ijRowEven"><td id="a192ea51"><p id="8771ebdf">Docker image platform</p></td><td id="459f98f8"><p id="ffa40598">Select &lt;Any&gt; (default), Linux, or Windows.</p></td></tr><tr id="1c6f3298" class="ijRowOdd"><td id="83d18ab1"><p id="c0ba05f0">Pull image explicitly</p></td><td id="f449c141"><p id="06d4b3d0">If enabled, the image will be pulled from the Hub repository via <code class="code">docker pull &lt;imageName&gt;</code> before the <code class="code">docker run</code> command is launched.</p></td></tr><tr id="b6650106" class="ijRowEven"><td id="6b3ccff7"><p id="8bd38e21">Additional docker run arguments</p></td><td id="414688aa"><p id="5f8954fe">Allows specifying additional options for <code class="code">docker run</code>. The default argument is <code class="code">--rm</code>, but you can provide more, for instance, add an additional volume mapping.</p><aside class="note " data-title="" rel="5f8954fe" id="238006ee"><p id="a173c0f5">In this field, you cannot reference environment variablesusing <code class="code">%env.FOO_BAR%</code> syntax because TeamCity does not pass environment variablesfrom a build agent into a Docker container.</p><p id="95885c60">If you need to reference an environment variable on an agent,define the configuration parameter <code class="code">system.FOO_BAR=env_var_value</code> in <code class="code">buildAgent.properties</code>and reference it via <code class="code">%system.FOO_BAR%</code>.</p></aside></td></tr></tbody></table></div></div><a name="HowItWorks"></a><a name="How-It-Works"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-HowItWorks">How It Works</h4><a name="docker-settings-how"></a><p id="9f184caa">Technically, the command of the build runner is wrapped in a shell script, and this script is executed inside a Docker container with the <code class="code">docker run</code> command. All the details about the started process, text of the script, and so on, are written into the build log (the <i origin="teamcity-help" id="81225c8f">Verbose</i> mode enables viewing them).</p><p id="a1f05faf">The <a href="build-checkout-directory.html">checkout directory</a> and most build agent directories are mapped inside the Docker process.</p><p id="fa2864be">At the end of the build step with the Docker wrapper, a build agent runs the <code class="code">chown</code> command to restore access of the <code class="code">buildAgent</code> user to the checkout directory. This mitigates a possible problem when the files from a Docker container are created with the <code class="code">root</code> ownership and cannot be removed by the build agent later.</p><p id="55b82a41">If the process environment contains the <code class="code">TEAMCITY_DOCKER_NETWORK</code> environment variable set by the previous <a href="docker-compose.html">Docker Compose</a> build step, this network is passed to the started <code class="code">docker run</code> command with the <code class="code">--network</code> switch.</p></div><a name="EnvironmentVariablesHandling"></a><a name="Environment-Variables-Handling"></a><div class="chapter"><h4 id="IntegratingTeamCitywithDocker-EnvironmentVariablesHandling">Environment Variables Handling</h4><a name="docker-settings-env-var"></a><p id="efb34704">TeamCity passes environment variables from the <a href="build-configuration.html">build configuration</a> into the Docker process, but it does not pass environment variables from the <a href="build-agent.html">build agent</a>, as they may not be relevant to the Docker container environment. The list of the passed environment variables can be seen in <a href="build-log.html#Viewing-Build-Log">Verbose mode</a> in the build log.</p></div></div><a name="DockerDiskSpaceCleaner"></a><a name="Docker-Disk-Space-Cleaner"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-DockerDiskSpaceCleaner">Docker Disk Space Cleaner</h3><p id="3c1b151f">Docker Disk Space Cleaner is an extension to the <a href="free-disk-space.html">Free Disk Space</a> build feature ensuring a certain amount of disk space for a build.</p><p id="deae056e">TeamCity performs regular clean-up of Docker images, related to TeamCity:</p><ul class="list _ul"><li class="list__item" id="2100d37a"><p>The TeamCity agent tracks Docker images tagged or pulled during builds (the list of images is stored in the <code class="code">buildAgent/system/docker-used-images.dat</code> file).</p></li><li class="list__item" id="33f59d74"><p>During cleanup / freeing disk space, TeamCity agent tries to remove these images if they were not used within 3 days, 1 day, 0 on subsequent attempts to free disk space.</p></li></ul><p id="09111ee8">Besides that, TeamCity cleans local Docker Caches using the command:</p><ul class="list _ul"><li class="list__item" id="ada738ab"><p><b id="97e924df">Since 2018.1.2</b>: <code class="code">docker system prune --volumes</code>. Works for Docker v.17.06.1 or later.</p></li><li class="list__item" id="dbe7ba98"><p><b id="834fe77a">Before 2018.1.2</b>: <code class="code">docker system prune -a</code></p></li></ul></div><a name="ServiceMessagetoReportPushedImage"></a><a name="Service-Message-to-Report-Pushed-Image"></a><div class="chapter"><h3 id="IntegratingTeamCitywithDocker-ServiceMessagetoReportPushedImage">Service Message to Report Pushed Image</h3><p id="752d8a18">If TeamCity (for some reason) cannot determine that an image has been pushed, a user can send a special <a href="build-script-interaction-with-teamcity.html">Service Message</a> to report this information to the TeamCity server:</p><div class="code-block" data-lang="bash">
##teamcity[dockerMessage type='dockerImage.push' value='&lt;full_image_tag&gt;,size:&lt;size in bytes&gt;,digest:&lt;hash&gt;']

</div><p id="6f05030e">For example:</p><div class="code-block" data-lang="bash">
##teamcity[dockerMessage type='dockerImage.push' value='myRegistry/repo-test:17,size:2632,digest:sha256:8dc5a195c3dcdc7c288d16288ff3f9ab1d8a5a230e09afb9c8dc9215e861aa55']

</div><hr id="38bbea18"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>