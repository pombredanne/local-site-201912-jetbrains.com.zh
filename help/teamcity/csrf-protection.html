<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>CSRF保护-帮助|帮助团队城市</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="CSRF Protection" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/installing-and-configuring-the-teamcity-server.md|Installing and Configuring the TeamCity Server/csrf-protection.md|CSRF Protection" data-main-title="CSRF Protection" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/csrf-protection.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="csrf-protection.md" data-toc="CSRF Protection">CSRF保护</h1><p id="31a6ee2d">在此页：</p><p id="df660001"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#CSRFProtection-Generalinformation">一般信息</a></li><li class="list__item"><a href="#CSRFProtection-Implicationsforreverseproxyconfiguration">反向代理配置的含义</a></li><li class="list__item"><a href="#CSRFProtection-Implicationsfornon-browserHTTPclients">对非浏览器HTTP客户端的影响</a></li><li class="list__item"><a href="#CSRFProtection-CSRFchecksforHTTPrequest">CSRF检查HTTP请求</a><ul class="list _bullet"><li class="list__item"><a href="#CSRFProtection-Trusteddomain">受信任的域</a></li></ul></li><li class="list__item"><a href="#CSRFProtection-Troubleshooting">故障排除</a></li></ul><p></p><a name="Generalinformation"></a><a name="General-information"></a><div class="chapter"><h2 id="CSRFProtection-Generalinformation">一般信息</h2><p id="2f10b0a2">自TeamCity 2017.1（ <a href="https://youtrack.jetbrains.com/issue/TW-17762" rel="noopener noreferrer" data-external="true" target="_blank">发行</a> ）以来，已在TeamCity中实施CSRF保护。这种保护意味着对HTTP请求有许多要求。</p></div><a name="Implicationsforreverseproxyconfiguration"></a><a name="Implications-for-reverse-proxy-configuration"></a><div class="chapter"><h2 id="CSRFProtection-Implicationsforreverseproxyconfiguration">反向代理配置的含义</h2><p id="bd5e32ff">当TeamCity服务器前面有一个反向代理（Nginx，IIS，Apache）时，应将该代理配置为将头从原始请求传递到TeamCity服务器。</p><p id="0130f13b">的<code class="code">Origin</code>和<code class="code">Referer</code>标头（如果存在）必须未经修改地传递。</p><p id="9a5aa3c8">的<code class="code">Host</code>标头也应传递，如果由于某种原因无法传递标头， <code class="code">X-Forwarded-Host</code>必须设置为原始值<code class="code">Host</code>标头。</p><p id="3c48d769">这是我们<a href="how-to.html#Set-Up-TeamCity-behind-a-Proxy-Server">为TeamCity</a>进行<a href="how-to.html#Set-Up-TeamCity-behind-a-Proxy-Server">反向代理配置的</a>建议。</p></div><a name="Implicationsfornon-browserHTTPclients"></a><a name="Implications-for-non-browser-HTTP-clients"></a><div class="chapter"><h2 id="CSRFProtection-Implicationsfornon-browserHTTPclients">对非浏览器HTTP客户端的影响</h2><p id="86afb607">非浏览器HTTP客户端，通过提供身份验证以将身份验证重用于REST脚本<code class="code">TCSESSIONID</code>需要更新带有请求的Cookie，以提供<code class="code">Origin</code>与请求发送到的主机具有相同值的HTTP标头。</p></div><a name="CSRFchecksforHTTPrequest"></a><a name="CSRF-checks-for-HTTP-request"></a><div class="chapter"><h2 id="CSRFProtection-CSRFchecksforHTTPrequest">CSRF检查HTTP请求</h2><p id="c3efead8">从TeamCity角度考虑HTTP请求安全性时，将依次进行以下检查：</p><ol class="list _decimal"><li class="list__item" id="a98cf630"><p>如果HTTP请求是非修改请求（例如<code class="code">GET</code> ），它被认为是安全的。</p></li><li class="list__item" id="db34f8c4"><p>如果HTTP请求在参数或HTTP标头中具有安全的CSRF令牌，并且此令牌与用户会话中存储的令牌匹配，则认为它是安全的。</p></li><li class="list__item" id="e41b90e5"><p>如果HTTP请求包含<code class="code">Origin</code>标头中，它<b id="9c08bbb8">必须</b>与<i id="ba77de26">受信任域中</i>的主机匹配（请参见下文），否则，请求将被拒绝，而无需进一步处理。</p></li><li class="list__item" id="fea08e88"><p>如果HTTP请求包含<code class="code">Referer</code>标头与<code class="code">Host</code>标头或<code class="code">X-Forwarded-Host</code>标头，则被认为是安全的。</p></li><li class="list__item" id="5ca88f4e"><p>如果HTTP请求包含<code class="code">X-Requested-With=XMLHttpRequest</code>标头，则被认为是安全的。</p></li><li class="list__item" id="82879a96"><p>如果HTTP请求使用基于令牌的身份验证，并且TeamCity会话/ cookie中没有用户，则该请求被认为是安全的。</p></li><li class="list__item" id="72d3f8b3"><p>如果HTTP请求使用基本身份验证，并且TeamCity会话/ cookie中没有用户，则该请求被认为是安全的。</p></li></ol><a name="Trusteddomain"></a><a name="Trusted-domain"></a><div class="chapter"><h3 id="CSRFProtection-Trusteddomain">受信任的域</h3><p id="8e311a8a">TeamCity认为以下域/主机是可信的：</p><ul class="list _ul"><li class="list__item" id="73465057"><p><code class="code">Host</code>标头值</p></li><li class="list__item" id="c47016e7"><p><code class="code">X-Forwarded-Host</code>标头值（在代理配置的情况下可以单独设置）</p></li><li class="list__item" id="11f1ed82"><p>CORS起源之一， <a href="rest-api.html#CORS-Support">配置</a>用于REST访问。</p></li></ul></div></div><a name="Troubleshooting"></a><a name="Troubleshooting"></a><div class="chapter"><h2 id="CSRFProtection-Troubleshooting">故障排除</h2><p id="21b9b929">当您遇到有关TeamCity中CSRF保护的问题时（例如，您从服务器收到“由于CSRF检查失败而响应403状态代码”响应），可以按照以下步骤操作：</p><ul class="list _ul"><li class="list__item" id="618ec710"><p>如果使用反向代理，请确保如上所述正确配置主机/来源标头。同时，您可能希望将服务器的公共URL添加到<a href="rest-api.html#CORS-Support">启用</a>了<a href="rest-api.html#CORS-Support">CORS的origin中</a> 。</p></li><li class="list__item" id="517611ee"><p>您可以通过设置以下选项暂时完全禁用CSRF保护：<code class="code">teamcity.csrf.origin.check.enabled=logOnly internal property.</code></p></li><li class="list__item" id="ed935ce3"><p>有关失败的CSRF尝试的信息已登录<code class="code">TeamCity/logs/teamcity-auth.log</code>文件。有关请求的详细诊断，请启用<a href="reporting-issues.html#Logging-events">debug-auth日志记录预设</a> 。</p></li></ul><hr id="1679a9be"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>