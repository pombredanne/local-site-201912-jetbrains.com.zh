<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>CSRF Protection - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="CSRF Protection" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/installation.md|Installation/installing-and-configuring-the-teamcity-server.md|Installing and Configuring the TeamCity Server/csrf-protection.md|CSRF Protection" data-main-title="CSRF Protection" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/csrf-protection.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="CSRF Protection" id="csrf-protection.md">CSRF Protection</h1><p id="31a6ee2d">On this page:</p><p id="df660001"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#CSRFProtection-Generalinformation">General information</a></li><li class="list__item"><a href="#CSRFProtection-Implicationsforreverseproxyconfiguration">Implications for reverse proxy configuration</a></li><li class="list__item"><a href="#CSRFProtection-Implicationsfornon-browserHTTPclients">Implications for non-browser HTTP clients</a></li><li class="list__item"><a href="#CSRFProtection-CSRFchecksforHTTPrequest">CSRF checks for HTTP request</a><ul class="list _bullet"><li class="list__item"><a href="#CSRFProtection-Trusteddomain">Trusted domain</a></li></ul></li><li class="list__item"><a href="#CSRFProtection-Troubleshooting">Troubleshooting</a></li></ul></p><a name="Generalinformation"></a><a name="General-information"></a><div class="chapter"><h2 id="CSRFProtection-Generalinformation">General information</h2><p id="2f10b0a2">CSRF protection in TeamCity has been implemented since TeamCity 2017.1 (<a href="https://youtrack.jetbrains.com/issue/TW-17762" data-external="true" target="_blank" rel="noopener noreferrer">issue</a>). This protection implies a number of requirements on HTTP requests.</p></div><a name="Implicationsforreverseproxyconfiguration"></a><a name="Implications-for-reverse-proxy-configuration"></a><div class="chapter"><h2 id="CSRFProtection-Implicationsforreverseproxyconfiguration">Implications for reverse proxy configuration</h2><p id="bd5e32ff">When a TeamCity server has a reverse proxy in front of it (Nginx, IIS, Apache), this proxy should be configured to pass headers from the original request to the TeamCity server.</p><p id="0130f13b">The <code class="code">Origin</code> and <code class="code">Referer</code> headers must be passed unmodified, when present.</p><p id="9a5aa3c8">The  <code class="code">Host</code> header should be passed as well, and if it is not possible due to some reason, <code class="code">X-Forwarded-Host</code> must be set to the value of the original <code class="code">Host</code> header.</p><p id="3c48d769">Here are our recommendations for <a href="how-to.html#Set-Up-TeamCity-behind-a-Proxy-Server">reverse proxy configuration for TeamCity</a>.</p></div><a name="Implicationsfornon-browserHTTPclients"></a><a name="Implications-for-non-browser-HTTP-clients"></a><div class="chapter"><h2 id="CSRFProtection-Implicationsfornon-browserHTTPclients">Implications for non-browser HTTP clients</h2><p id="86afb607">Non-browser HTTP clients which reuse authentication for REST scripting by supplying the <code class="code">TCSESSIONID</code> cookie with the request need to be updated to supply the <code class="code">Origin</code> HTTP header with the same value as the host the request is being sent to.</p></div><a name="CSRFchecksforHTTPrequest"></a><a name="CSRF-checks-for-HTTP-request"></a><div class="chapter"><h2 id="CSRFProtection-CSRFchecksforHTTPrequest">CSRF checks for HTTP request</h2><p id="c3efead8">When considering HTTP request safety from the TeamCity perspective, the following checks are sequentially made:</p><ol class="list _decimal"><li class="list__item" id="a98cf630"><p>If an HTTP request is a non-modifying one (such as <code class="code">GET</code>), it is considered safe.</p></li><li class="list__item" id="db34f8c4"><p>If an HTTP request has a secure CSRF token either in the parameter or in the HTTP header and this token matches the one stored in user session, it is considered safe.</p></li><li class="list__item" id="e41b90e5"><p>If an HTTP request has the <code class="code">Origin</code> header, it <b id="9c08bbb8">must</b> match a host from a <i id="ba77de26">trusted domain</i> (see below), otherwise, the request is rejected without further processing.</p></li><li class="list__item" id="fea08e88"><p>If an HTTP request has the <code class="code">Referer</code> header which matches the <code class="code">Host</code> header or <code class="code">X-Forwarded-Host</code> header, it is considered safe.</p></li><li class="list__item" id="5ca88f4e"><p>If an HTTP request has the <code class="code">X-Requested-With=XMLHttpRequest</code> header, it is considered safe.</p></li><li class="list__item" id="82879a96"><p>If an HTTP request uses token-based authentication and there is no user in TeamCity session/cookies, the request is considered safe.</p></li><li class="list__item" id="72d3f8b3"><p>If an HTTP request uses basic authentication and there is no user in TeamCity session/cookies, the request is considered safe.</p></li></ol><a name="Trusteddomain"></a><a name="Trusted-domain"></a><div class="chapter"><h3 id="CSRFProtection-Trusteddomain">Trusted domain</h3><p id="8e311a8a">TeamCity considers the following domains/hosts as trusted:</p><ul class="list _ul"><li class="list__item" id="73465057"><p><code class="code">Host</code> header value</p></li><li class="list__item" id="c47016e7"><p><code class="code">X-Forwarded-Host</code> header value (can be set separately in case of proxy configuration)</p></li><li class="list__item" id="11f1ed82"><p>One of the CORS origins, <a href="rest-api.html#CORS-Support">configured</a> for REST access.</p></li></ul></div></div><a name="Troubleshooting"></a><a name="Troubleshooting"></a><div class="chapter"><h2 id="CSRFProtection-Troubleshooting">Troubleshooting</h2><p id="21b9b929">When you face problems regarding CSRF protection in TeamCity (for example, you get the "Responding with 403 status code due to failed CSRF check" response from the server), you can follow these steps:</p><ul class="list _ul"><li class="list__item" id="618ec710"><p>If you use a reverse proxy, make sure you correctly configure Host/Origin headers, as described above. In the meantime, you may want to add the public URL of your server to <a href="rest-api.html#CORS-Support">CORS-enabled origins</a>.</p></li><li class="list__item" id="517611ee"><p>You can temporary disable CSRF protection at all by setting the <code class="code">teamcity.csrf.origin.check.enabled=logOnly internal property.</code></p></li><li class="list__item" id="ed935ce3"><p>Information about failed CSRF attempts are logged into <code class="code">TeamCity/logs/teamcity-auth.log</code> files. For more detailed diagnostics of the requests, enable <a href="reporting-issues.html#Logging-events">debug-auth logging preset</a>.</p></li></ul><hr id="1679a9be"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>