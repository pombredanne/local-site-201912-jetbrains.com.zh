<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>使用MS SQL Server设置TeamCity-帮助|帮助团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Setting up TeamCity with MS SQL Server" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/installation-and-upgrade.md|Installation and Upgrade/setting-up-an-external-database.md|Setting up an External Database/setting-up-teamcity-with-ms-sql-server.md|Setting up TeamCity with MS SQL Server" data-main-title="Setting up TeamCity with MS SQL Server" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/setting-up-teamcity-with-ms-sql-server.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="setting-up-teamcity-with-ms-sql-server.md" data-toc="Setting up TeamCity with MS SQL Server">使用MS SQL Server设置TeamCity</h1><p id="3ad5171f">在此页：</p><p id="0136a818"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-Prerequisites">先决条件</a></li><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-ConfigureMSSQLservertobeusedwithTeamCity">配置MS SQL Server与TeamCity一起使用</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-EnableTCP/IPprotocolforyourSQLserver">为您的SQL Server启用TCP / IP协议</a></li><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-Createnewdatabase">建立新资料库</a></li><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-SetupTeamCitydatabaseuser">设置TeamCity数据库用户</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-CreatededicateduserforTeamCitywithSQLserverauthentication">使用SQL Server身份验证为TeamCity创建专用用户</a></li><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-CreateSQLdatabaseuserwithWindowsauthentication">使用Windows身份验证创建SQL数据库用户</a></li></ul></li><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-SetupJDBCDriverforSQLServerdatabase">为SQL Server数据库设置JDBC驱动程序</a><ul class="list _bullet"><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-AdditionalsettingsforWindowsauthentication(MSSQLintegratedsecurity)">Windows身份验证的其他设置（MS SQL集成安全性）</a></li></ul></li></ul></li><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-StartTeamCity">启动TeamCity</a></li><li class="list__item"><a href="#SettingupTeamCitywithMSSQLServer-Post-Setupnotes">设置后注意事项</a></li></ul><p></p><a name="Prerequisites"></a><a name="Prerequisites"></a><div class="chapter"><h2 id="SettingupTeamCitywithMSSQLServer-Prerequisites">先决条件</h2><ul class="list _ul"><li class="list__item" id="96b2e1ab"><p>MS SQL服务器</p></li><li class="list__item" id="1447b9aa"><p>MS SQL Server管理工作室</p></li><li class="list__item" id="12681c99"><a href="installation-quick-start.html">已安装的TeamCity服务器</a></li></ul></div><a name="ConfigureMSSQLservertobeusedwithTeamCity"></a><a name="Configure-MS-SQL-server-to-be-used-with-TeamCity"></a><div class="chapter"><h2 id="SettingupTeamCitywithMSSQLServer-ConfigureMSSQLservertobeusedwithTeamCity">配置MS SQL Server与TeamCity一起使用</h2><a name="EnableTCP/IPprotocolforyourSQLserver"></a><a name="Enable-TCP/IP-protocol-for-your-SQL-server"></a><div class="chapter"><h3 id="SettingupTeamCitywithMSSQLServer-EnableTCP/IPprotocolforyourSQLserver">为您的SQL Server启用TCP / IP协议</h3><p id="dd0360eb">打开SQL Server配置管理器，然后执行以下操作：</p><ol class="list _decimal"><li class="list__item" id="00c14c9a"><p>展开“ <i id="e3120ad4">SQL Server网络配置”</i> ，单击<i id="9dcf0d3b">“ MS SQL协议”</i> 。</p></li><li class="list__item" id="e574c473"><p>在右窗格中，右键单击“ <i id="3954c865">TCP / IP”</i> ，然后单击“ <i id="0a9c74c6">启用”</i> ，然后选择“ <i id="7cd15dc1">是”</i> 。（MS SQL默认情况下禁用TCP / IP。）单击<b id="0da0ea23">确定</b> 。</p><figure><img alt="enableTCP.png" title="enableTCP.png" src="/help/img/teamcity/2019.1/enableTCP.png" id="b423b332" width="1044" height="842"></figure><p></p></li><li class="list__item" id="526dbbac"><p>您需要重新启动MSSQL服务器才能使更改生效：在左窗格中，单击<i id="ccf028b3">SQL Server服务</i> ，在右窗格中，右键单击<i id="d00168e9">SQL Server</i> ，然后单击<b id="10fe7b85">重新启动</b> 。</p></li><li class="list__item" id="0cdc5dc2"><p>检查SQL Server浏览器是否正在运行。</p><figure><img alt="SQLServerBrowser.png" title="SQLServerBrowser.png" src="/help/img/teamcity/2019.1/SQLServerBrowser.png" id="c988cd1a" width="1038" height="251"></figure><p></p></li></ol></div><a name="Createnewdatabase"></a><a name="Create-new-database"></a><div class="chapter"><h3 id="SettingupTeamCitywithMSSQLServer-Createnewdatabase">建立新资料库</h3><p id="472a3f39">在MS SQL Server Management Studio中：</p><ol class="list _decimal"><li class="list__item" id="a7615fc2"><p>连接到数据库服务器，右键单击“对象资源管理器”中的“ <i id="4ab67632">数据库”</i>节点，然后选择“ <i id="adcb644e">新建数据库”</i> 。</p></li><li class="list__item" id="f87660db"><p>在“ <i id="a229ec06">常规”</i>页面上，在下图中指定数据库名称“ TeamCity”，并分配足够的<a href="https://msdn.microsoft.com/en-us/library/ms365418.aspx" rel="noopener noreferrer" data-external="true" target="_blank">事务日志</a>空间。下图建议的最小值为1Gb（1024 Mb）。要求取决于服务器使用的强度。</p><figure><img alt="createDB_new.png" title="createDB_new.png" src="/help/img/teamcity/2019.1/createDB_new.png" id="6ebcf50c" width="1144" height="795"></figure><p></p></li><li class="list__item" id="a5f73a7a"><p>接下来指定主要排序规则。转到左侧窗格中的“ <i id="5375489e">选项”</i>节点，然后在右侧选择一个排序规则。我们建议区分大小写的排序规则（排序规则名称以<code class="code">_CS_AS</code> ）对应于您的语言环境，然后单击<b id="69611a0f">确定</b>以保存设置：</p><figure><img alt="collation_new_new.png" title="collation_new_new.png" src="/help/img/teamcity/2019.1/collation_new_new.png" id="01be48c7" width="2044" height="1513"></figure><p></p></li><li class="list__item" id="bf57cb92"><p>现在确保<code class="code">no count</code>设置被禁用，如下所示：在对象资源管理器中右键单击服务器实例，转到“ <i id="3e859d1c">属性” |“连接”</i> 。在“ <i id="d5724f04">默认连接选项”</i>框中，“ <code class="code">no count</code> ”必须关闭。保存更改（如果有）。</p><figure><img alt="noCount.png" title="noCount.png" src="/help/img/teamcity/2019.1/noCount.png" id="329b8007" width="1440" height="900"></figure><p></p></li></ol></div><a name="SetupTeamCitydatabaseuser"></a><a name="Set-up-TeamCity-database-user"></a><div class="chapter"><h3 id="SettingupTeamCitywithMSSQLServer-SetupTeamCitydatabaseuser">设置TeamCity数据库用户</h3><p id="5662c6b9">SQL Server支持两种身份验证方式：SQL Server身份验证和Windows身份验证模式。</p><ul class="list _ul"><li class="list__item" id="4748b23b"><p>SQL身份验证要求在数据库设置中指定用户名和密码。建议您先尝试使用此身份验证，然后再尝试使用Windows身份验证。</p></li><li class="list__item" id="03a20138"><p>Windows身份验证（MS SQL集成安全性）允许在特定Windows用户下运行的TeamCity服务器以该用户身份连接到SQL Server，而无需提供用户名和密码。但是，它需要<a href="#Additional-settings-for-Windows-authentication-(MS-SQL-integrated-security)">其他设置</a></p></li></ul><a name="CreatededicateduserforTeamCitywithSQLserverauthentication"></a><a name="Create-dedicated-user-for-TeamCity-with-SQL-server-authentication"></a><div class="chapter"><h4 id="SettingupTeamCitywithMSSQLServer-CreatededicateduserforTeamCitywithSQLserverauthentication">使用SQL Server身份验证为TeamCity创建专用用户</h4><ol class="list _decimal"><li class="list__item" id="0c8952a8"><p>转到“ <i id="237ee642">安全性”</i>节点，右键单击“ <i id="aa7d79c5">登录名”</i> ，选择“ <i id="e2352474">新登录名”</i> ，然后在打开的“ <i id="0426c44b">常规”</i>窗口中提供登录名（下图为“ TeamCity”），选择SQL Server身份验证并提供用户密码。将默认数据库设置为TeamCity。</p><figure><img alt="defaultDBTC.png" title="defaultDBTC.png" src="/help/img/teamcity/2019.1/defaultDBTC.png" id="afcf6d56" width="1152" height="798"></figure><p></p></li><li class="list__item" id="206b0133"><p>接下来，在左窗格中选择“ <i id="3fca2197">用户映射</i> ”，在右上窗格中，检查列表中的TeamCity数据库，在下窗格中，授予用户TeamCity数据库所有者权限：选中“ <code class="code">db_owner</code> ”框。单击<b id="6406e14b">确定</b> 。</p><figure><img alt="dbowner_new1.png" title="dbowner_new1.png" src="/help/img/teamcity/2019.1/dbowner_new1.png" id="c3f7dbb4" width="1152" height="796"></figure><p></p></li></ol></div><a name="CreateSQLdatabaseuserwithWindowsauthentication"></a><a name="Create-SQL-database-user-with-Windows-authentication"></a><div class="chapter"><h4 id="SettingupTeamCitywithMSSQLServer-CreateSQLdatabaseuserwithWindowsauthentication">使用Windows身份验证创建SQL数据库用户</h4><ol class="list _decimal"><li class="list__item" id="b09eb056"><p>转到“ <i id="89a2c411">安全性”</i>节点，右键单击“ <i id="bc45b473">登录名”</i> ，选择“ <i id="d463e380">新登录名”</i> ，然后在打开的“ <i id="2baab4ee">常规”</i>窗口中提供登录名，选择Windows身份验证，然后单击搜索按钮。</p></li><li class="list__item" id="607aa9e9"><p>在“ <i id="56aea849">选择用户或组”</i>对话框中，指定将用于运行TeamCity的用户帐户。单击<b id="783198ef">检查名称</b> 。找到用户后，单击<b id="45677796">确定</b> 。</p><figure><img alt="6WinAuthNewSQLUser.png" title="6WinAuthNewSQLUser.png" src="/help/img/teamcity/2019.1/6WinAuthNewSQLUser.png" id="fef2aa89" width="1149" height="803"></figure><p></p></li><li class="list__item" id="966fbd49"><p>向该用户授予数据库所有者权限：在左窗格中选择“ <i id="a9321d6b">用户映射</i> ”，在右上方窗格中，检查列表中的TeamCity数据库，在下窗格中，向用户授予“ TeamCity数据库所有者”权限：选中“ <code class="code">db_owner</code> ”框。单击<b id="d6da58ca">确定</b> 。</p><figure><img alt="7WinAuthNewSQLUser.png" title="7WinAuthNewSQLUser.png" src="/help/img/teamcity/2019.1/7WinAuthNewSQLUser.png" id="0ecfeb3d" width="1150" height="797"></figure><p></p></li></ol></div></div><a name="SetupJDBCDriverforSQLServerdatabase"></a><a name="Set-up-JDBC-Driver-for-SQL-Server-database"></a><div class="chapter"><h3 id="SettingupTeamCitywithMSSQLServer-SetupJDBCDriverforSQLServerdatabase">为SQL Server数据库设置JDBC驱动程序</h3><ol class="list _decimal"><li class="list__item" id="1b9e5ea6"><p>下载<a href="https://docs.microsoft.com/en-us/sql/connect/jdbc/download-microsoft-jdbc-driver-for-sql-server" rel="noopener noreferrer" data-external="true" target="_blank">Microsoft JDBC驱动程序6.0或更高版本</a> （选择<code class="code">.exe</code>要么<code class="code">.tar.gz</code>取决于您的TeamCity服务器平台）。</p></li><li class="list__item" id="e5aa05a7"><p>将下载的软件包解压缩到一个临时目录中。</p></li><li class="list__item" id="41ae3133"><p>复制<code class="code">sqljdbc42.jar</code> （要么<code class="code">mssql-jdbc-<version>.jre8.jar</code>在6.0版以上的版本中） <code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/lib/jdbc</code>目录。</p></li></ol><aside class="note " rel="f4d5b7cf" id="d928010c" data-title=""><p id="5f1917fa">请注意，Microsoft JDBC驱动程序v6.0 +具有与Microsoft SQL Server 2005的兼容性问题。对于MS SQL Server 2005，请使用<a href="https://docs.microsoft.com/en-us/sql/connect/jdbc/download-microsoft-jdbc-driver-for-sql-server" rel="noopener noreferrer" data-external="true" target="_blank">JDBC驱动程序v4.x</a> （ <code class="code">exe</code>要么<code class="code">.tar.gz</code>取决于您的TeamCity服务器平台）。</p></aside><p id="4972611b"><a name="integratedSecurityAuth"></a><a name="SettingupTeamCitywithMSSQLServer-integratedSecurityAuth"></a></p><a name="AdditionalsettingsforWindowsauthentication(MSSQLintegratedsecurity)"></a><a name="Additional-settings-for-Windows-authentication-(MS-SQL-integrated-security)"></a><div class="chapter"><h4 id="SettingupTeamCitywithMSSQLServer-AdditionalsettingsforWindowsauthentication(MSSQLintegratedsecurity)">Windows身份验证的其他设置（MS SQL集成安全性）</h4><p id="2a7731b2">对于Windows身份验证（MS SQL集成安全性），除了JDBC驱动程序外，还必须安装本机驱动程序库<code class="code">sqljdbc_auth.dll</code>从JDBC驱动程序包中。库的所需版本取决于服务器使用的Java版本的位数。</p><p id="09bdb2a5">对于与TeamCity服务器捆绑在一起的默认32位JVM，请复制<code class="code"><sql_jdbc_home>/enu/auth/x86/sqljdbc_auth.dll</code>归档到<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/lib/jdbc/native/windows-i386</code> 。<br>对于用于运行TeamCity服务器的<a href="installing-and-configuring-the-teamcity-server.html">64位JVM</a> ，请使用<code class="code"><sql_jdbc_home>/enu/auth/x64/sqljdbc_auth.dll</code>并将其放入<code class="code"><</code> <a href="teamcity-data-directory.html"><code class="code">TeamCity Data Directory</code></a> <code class="code">>/lib/jdbc/native/windows-amd64</code>目录。</p></div></div></div><a name="StartTeamCity"></a><a name="Start-TeamCity"></a><div class="chapter"><h2 id="SettingupTeamCitywithMSSQLServer-StartTeamCity">启动TeamCity</h2><ol class="list _decimal"><li class="list__item" id="15d9ddd1"><p>启动TeamCity服务器。对于Windows身份验证（MS SQL集成安全性），请确保服务器<a href="#Create-SQL-database-user-with-Windows-authentication">在此步骤配置</a>的用户下运行。</p></li><li class="list__item" id="59cf8a30"><p>选择“ MS SQL”作为数据库。</p></li><li class="list__item" id="c52d0cd4"><p>如果要求，请单击“刷新JDBC驱动程序”。</p></li><li class="list__item" id="362efc00">指定连接设置：<ul class="list _ul"><li class="list__item" id="a3f535b1"><p>数据库主机-您的SQL Server主机</p></li><li class="list__item" id="a0602b32"><p>端口-可选</p></li><li class="list__item" id="30824040"><p>数据库实例名称-默认SQL Server实例保留空白。如果使用命名实例，请在此处提供其名称。</p></li><li class="list__item" id="ee867bdd"><p>数据库名称-新创建的数据库的名称</p></li></ul></li><li class="list__item" id="e9460668"><p>选择所需的身份验证类型，对于SQL Server身份验证，请提供<a href="#Create-dedicated-user-for-TeamCity-with-SQL-server-authentication">在此步骤中配置</a>的专用SQL用户的凭据。</p><figure><img alt="DB_SQLAuth.png" title="DB_SQLAuth.png" src="/help/img/teamcity/2019.1/DB_SQLAuth.png" id="8a90eeec" width="687" height="775"></figure><p></p></li><li class="list__item" id="8167b395"><p>继续进行设置。初始化数据库架构和组件将需要一些时间。</p></li></ol></div><a name="Post-Setupnotes"></a><a name="Post-Setup-notes"></a><div class="chapter"><h2 id="SettingupTeamCitywithMSSQLServer-Post-Setupnotes">设置后注意事项</h2><p id="59d2148f">建议定期监视数据库性能。例如，每隔几个月执行一次<a href="https://msdn.microsoft.com/en-us/library/ms189858.aspx#Fragmentation" rel="noopener noreferrer" data-external="true" target="_blank">重新索引</a> 。</p><hr id="e104c87b"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>