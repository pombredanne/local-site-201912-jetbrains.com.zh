<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Perforce Workspace Handling in TeamCity - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Perforce Workspace Handling in TeamCity" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/managing-projects-and-build-configurations.md|Managing Projects and Build Configurations/configuring-vcs-settings.md|Configuring VCS Settings/configuring-vcs-roots.md|Configuring VCS Roots/perforce.md|Perforce/perforce-workspace-handling-in-teamcity.md|Perforce Workspace Handling in TeamCity" data-main-title="Perforce Workspace Handling in TeamCity" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/perforce-workspace-handling-in-teamcity.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Perforce Workspace Handling in TeamCity" id="perforce-workspace-handling-in-teamcity.md">Perforce Workspace Handling in TeamCity</h1><p id="99955f2b">On this page:</p><p id="7c97f082"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Overview">Overview</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceName">Perforce Workspace Name</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceParameters">Perforce Workspace Parameters</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-WorkspaceDeletion">Workspace Deletion</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Perforcesync-fandworkspacereuse">Perforce sync -f and workspace reuse</a><ul class="list _bullet"><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Errorsduringcheckout">Errors during checkout</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-VCSRootclientmappingmodification">VCS Root client mapping modification</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Forcedprotectionagainstcleancheckout">Forced protection against clean checkout</a></li></ul></li></ul></p><a name="Overview"></a><a name="Overview"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-Overview">Overview</h2><p id="9c174180">To perform Perforce-related operations, TeamCity usually operates in a "no-workspace" mode, i.e. it executes Perforce commands without workspace context. For instance, checking for changes operations and creating server-side patches do not require Perforce workspaces creation.</p><p id="850391a2">The cases when a workspace is created are:</p><ul class="list _ul"><li class="list__item" id="47bc9a48"><p><a href="vcs-checkout-mode.html#agent-checkout">Agent-side checkout</a>, the default mode. In this case TeamCity creates a Perforce workspace to checkout the sources</p></li><li class="list__item" id="3f18325b"><p>Using <a href="storing-project-settings-in-version-control.html">versioned settings</a> with Perforce VCS.</p></li></ul></div><a name="PerforceWorkspaceName"></a><a name="Perforce-Workspace-Name"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceName">Perforce Workspace Name</h2><p id="dc2a2750">The names of the created workspaces start with the <code class="code">TC_p4_</code> prefix. It is possible to provide an additional prefix for the workspace name using the <code class="code">teamcity.perforce.workspace.prefix</code> <a href="configuring-build-parameters.html">configuration parameter</a>.</p><p id="b438e500">The name of the workspace also includes the build agent name and a hash value built from the checkout directory and (optionally) checkout rules.</p></div><a name="PerforceWorkspaceParameters"></a><a name="Perforce-Workspace-Parameters"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceParameters">Perforce Workspace Parameters</h2><p id="4593f5f0">With <a href="vcs-checkout-mode.html#agent-checkout">agent-side checkout</a>, TeamCity provides environment variables describing the Perforce workspace created during the checkout process.<br>If several Perforce VCS Roots are used for the checkout, the variables are created for the <b id="94bc8358">first</b> VCS root in the list of the build's VCS Roots.<br>The variables are:</p><ul class="list _ul"><li class="list__item" id="796c9201"><p><code class="code">P4USER</code> - same as <code class="code">vcsroot.&lt;VCS root ID&gt;.user</code> <a href="predefined-build-parameters.html#VCS-Properties">parameter</a></p></li><li class="list__item" id="4c4d7e19"><p><code class="code">P4PORT</code>- same as <code class="code">vcsroot.&lt;VCS root ID&gt;.port</code> <a href="predefined-build-parameters.html#VCS-Properties">parameter</a></p></li><li class="list__item" id="a81d3006"><p><code class="code">P4CLIENT</code> - the name of the generated P4 workspace on the agent</p></li></ul><p id="d298ee2c">These variables can be used to perform custom p4 commands after the checkout.</p></div><a name="WorkspaceDeletion"></a><a name="Workspace-Deletion"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-WorkspaceDeletion">Workspace Deletion</h2><p id="89de5ebe">TeamCity deletes the Perforce workspaces it created in different situations:</p><ul class="list _ul"><li class="list__item" id="e81ff347"><p>Immediately after a versioned settings commit (a workspace is created for each commit)</p></li><li class="list__item" id="d0133cab"><p>For the agent-side checkout - when a <a href="clean-checkout.html">clean checkout</a> is performed (TeamCity will also run <code class="code">p4 sync -f</code> in this case, see details <a href="#Perforce-sync--f-and-workspace-reuse">below</a>)</p></li><li class="list__item" id="735ca735"><p>In the background of the agent process (between builds), when it detects a non-existing workspace directory for a workspace associated with the current agent. A TeamCity agent performs a cleanup of unused <a href="build-checkout-directory.html">checkout directories</a> (the default timeout is 8 days, can be changed with the <code class="code">system.teamcity.build.checkoutDir.expireHours</code> <a href="configuring-build-parameters.html#Defining-Build-Parameters-in-Build-Configuration">system property</a>). When a checkout directory is deleted, and this directory is associated with a Perforce workspace, this workspace is deleted as well. Cleaning Perforce workspaces can be disabled via the <code class="code">teamcity.perforce.workspace.cleanup=false</code>setting, either in the <a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a> file or globally at the server level as a Root project <a href="configuring-build-parameters.html">configuration parameter</a>.</p></li></ul><p id="ec7edff5">When deleting a Perforce workspace which contains pending changes or opened files, TeamCity tries to revert the changes and remove pending changelists, and after that repeats the operation. If the second attempt fails as well, TeamCity tries to run the <code class="code">p4 client -d -f</code>operation (forced). All those actions are logged to <code class="code">teamcity-vcs.log</code>.</p><p id="3ca26e72">Also, TeamCity does not force workspace deletion when a Perforce edge/replica server is used.</p></div><a name="Perforcesync-fandworkspacereuse"></a><a name="Perforce-sync--f-and-workspace-reuse"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-Perforcesync-fandworkspacereuse">Perforce sync -f and workspace reuse</h2><p id="93af681e">When <a href="vcs-checkout-mode.html#agent-checkout">agent-side checkout</a> is used, the TeamCity Perforce plugin creates a workspace which is bound to the checkout directory on an agent. The checkout is performed with an incremental <b id="9de6bc82">p4 sync</b> command (both for personal and non-personal builds).</p><p id="aa21b070">When a VCS Root is configured to use <code class="code">p4 sync -p</code>, the Perforce plugin always runs this command to checkout the sources.</p><p id="332db699">Usually, each <a href="clean-checkout.html">clean checkout</a> build results in <code class="code">p4 sync -f</code> command with cleaning the sources. But for the Perforce agent checkout there are exceptions described below.</p><a name="Errorsduringcheckout"></a><a name="Errors-during-checkout"></a><div class="chapter"><h3 id="PerforceWorkspaceHandlinginTeamCity-Errorsduringcheckout">Errors during checkout</h3><p id="6c71bc79">When an error occurs during the checkout, or a build is interrupted/stopped during the checkout, or a timeout occurs, no <a href="clean-checkout.html">clean checkout</a> will occur for the subsequent builds on the same build agent. Instead, TeamCity will rely on the Perforce ability to recover from the state.</p></div><a name="VCSRootclientmappingmodification"></a><a name="VCS-Root-client-mapping-modification"></a><div class="chapter"><h3 id="PerforceWorkspaceHandlinginTeamCity-VCSRootclientmappingmodification">VCS Root client mapping modification</h3><p id="30259863">Usually, when a project administrator modifies a VCS Root client mapping specified in the VCS Root, this is considered as a change in VCS Root settings and results in a <a href="clean-checkout.html">clean checkout</a>. This clean checkout behaviour can be disabled using the <code class="code">teamcity.perforce.enable-no-clean-checkout=true</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal property</a>.</p><aside class="note " data-title="" rel="30259863" id="94d23a65"><p id="9828da0e">Changing <code class="code">teamcity.perforce.enable-no-clean-checkout</code><a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">internal property</a> results in one-time clean checkout for all affected build configurations.</p></aside><p id="03147c0c">When a VCS Root is configured to use Client Name, or Stream, no clean checkout will occur when the client mapping of the corresponding client/stream is edited in Perforce. The corresponding TeamCity issue is <a href="https://youtrack.jetbrains.com/issue/TW-25344" data-external="true" target="_blank" rel="noopener noreferrer">TW-25344</a>.</p></div><a name="Forcedprotectionagainstcleancheckout"></a><a name="Forced-protection-against-clean-checkout"></a><div class="chapter"><h3 id="PerforceWorkspaceHandlinginTeamCity-Forcedprotectionagainstcleancheckout">Forced protection against clean checkout</h3><p id="a58343c9">There is a <a href="configuring-build-parameters.html">configuration parameter</a> which protects a build configuration from the TeamCity-initiated clean checkout, <code class="code">teamcity.agent.failBuildOnCleanCheckout</code>. When this parameter is set to <code class="code">true</code>, TeamCity will fail a build instead of running a clean checkout. It will never clean the workspace, unless it is explicitly requested via the <a href="clean-checkout.html#Enforcing-Clean-Checkout">Enforce clean checkout</a> action or if the "Clean all files in the checkout directory before the build" option is enabled in the checkout options of the version control settings for a build configuration.</p><p id="b4c09c59">When using a custom checkout path, TeamCity will not clean the checkout directory when VCS settings are changed, and it will fail a build instead. To ignore clean checkout and proceed with incremental checkout, use the <code class="code">teamcity.agent.failBuildOnCleanCheckout=ignoreAndContinue</code> <a href="configuring-build-parameters.html">parameter</a> for a project or build configuration. Do this only if you're absolutely sure that the sources in the checkout directory are in the correct state.</p><p id="e2b7fe76">The same applies to the broken personal builds. When the sources become dirty and the option is set, TeamCity will fail the build instead of running a clean checkout. You can clean the working copy via <code class="code">p4 clean</code>, for instance, and try to continue with the <code class="code">ignoreAndContinue</code> value after this (you can run a custom build with the specified <a href="configuring-build-parameters.html">configuration parameter</a>).</p><p id="cf608eb1">The corresponding TeamCity issue is <a href="https://youtrack.jetbrains.com/issue/TW-33168" data-external="true" target="_blank" rel="noopener noreferrer">TW-33168</a>.</p><hr id="e5bf6f62"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>