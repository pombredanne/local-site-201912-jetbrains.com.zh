<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>TeamCity中的Perforce工作区处理-帮助|帮助团队城市</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Perforce Workspace Handling in TeamCity" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/managing-projects-and-build-configurations.md|Managing Projects and Build Configurations/configuring-vcs-settings.md|Configuring VCS Settings/configuring-vcs-roots.md|Configuring VCS Roots/perforce.md|Perforce/perforce-workspace-handling-in-teamcity.md|Perforce Workspace Handling in TeamCity" data-main-title="Perforce Workspace Handling in TeamCity" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/perforce-workspace-handling-in-teamcity.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="perforce-workspace-handling-in-teamcity.md" data-toc="Perforce Workspace Handling in TeamCity">TeamCity中的Perforce工作区处理</h1><p id="99955f2b">在此页：</p><p id="7c97f082"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Overview">总览</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceName">Perforce工作区名称</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceParameters">Perforce工作区参数</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-WorkspaceDeletion">工作区删除</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Perforcesync-fandworkspacereuse">Perforce sync -f和工作空间重用</a><ul class="list _bullet"><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Errorsduringcheckout">结帐时出错</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-VCSRootclientmappingmodification">VCS Root客户端映射修改</a></li><li class="list__item"><a href="#PerforceWorkspaceHandlinginTeamCity-Forcedprotectionagainstcleancheckout">强制保护免于结帐</a></li></ul></li></ul><p></p><a name="Overview"></a><a name="Overview"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-Overview">总览</h2><p id="9c174180">为了执行与Perforce相关的操作，TeamCity通常在“无工作区”模式下运行，即，它在没有工作区上下文的情况下执行Perforce命令。例如，检查更改操作和创建服务器端修补程序不需要Perforce工作区创建。</p><p id="850391a2">创建工作空间的情况是：</p><ul class="list _ul"><li class="list__item" id="47bc9a48"><p><a href="vcs-checkout-mode.html#agent-checkout">代理方结帐</a> ，默认模式。在这种情况下，TeamCity创建一个Perforce工作区以签出源代码</p></li><li class="list__item" id="3f18325b"><p>在Perforce VCS中使用<a href="storing-project-settings-in-version-control.html">版本设置</a> 。</p></li></ul></div><a name="PerforceWorkspaceName"></a><a name="Perforce-Workspace-Name"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceName">Perforce工作区名称</h2><p id="dc2a2750">创建的工作空间的名称以<code class="code">TC_p4_</code>字首。可以使用以下命令为工作空间名称提供其他前缀<code class="code">teamcity.perforce.workspace.prefix</code> <a href="configuring-build-parameters.html">配置参数</a> 。</p><p id="b438e500">工作空间的名称还包括生成代理名称和从检出目录以及（可选）检出规则生成的哈希值。</p></div><a name="PerforceWorkspaceParameters"></a><a name="Perforce-Workspace-Parameters"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-PerforceWorkspaceParameters">Perforce工作区参数</h2><p id="4593f5f0">通过<a href="vcs-checkout-mode.html#agent-checkout">代理端检出</a> ，TeamCity提供环境变量来描述在检出过程中创建的Perforce工作区。<br>如果将多个Perforce VCS根目录用于签出，则会为构建的VCS根目录列表中的<b id="94bc8358">第一个</b> VCS根目录创建变量。<br>变量是：</p><ul class="list _ul"><li class="list__item" id="796c9201"><p><code class="code">P4USER</code> - 和...一样<code class="code">vcsroot.<VCS root ID>.user</code> <a href="predefined-build-parameters.html#VCS-Properties">参数</a></p></li><li class="list__item" id="4c4d7e19"><p><code class="code">P4PORT</code> - 和...一样<code class="code">vcsroot.<VCS root ID>.port</code> <a href="predefined-build-parameters.html#VCS-Properties">参数</a></p></li><li class="list__item" id="a81d3006"><p><code class="code">P4CLIENT</code> -代理上生成的P4工作区的名称</p></li></ul><p id="d298ee2c">这些变量可在签出后用于执行自定义p4命令。</p></div><a name="WorkspaceDeletion"></a><a name="Workspace-Deletion"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-WorkspaceDeletion">工作区删除</h2><p id="89de5ebe">TeamCity会删除在不同情况下创建的Perforce工作空间：</p><ul class="list _ul"><li class="list__item" id="e81ff347"><p>在版本化设置提交之后立即（为每个提交创建一个工作区）</p></li><li class="list__item" id="d0133cab"><p>对于代理方结帐-执行<a href="clean-checkout.html">干净结帐</a>时（TeamCity也将运行<code class="code">p4 sync -f</code>在这种情况下，请参见<a href="#Perforce-sync--f-and-workspace-reuse">下面的</a>详细信息）</p></li><li class="list__item" id="735ca735"><p>在代理进程的后台（在两次构建之间），当它检测到与当前代理关联的工作空间的不存在的工作空间目录时。TeamCity代理会清除未使用的<a href="build-checkout-directory.html">签出目录</a> （默认超时为8天，可以使用<code class="code">system.teamcity.build.checkoutDir.expireHours</code> <a href="configuring-build-parameters.html#Defining-Build-Parameters-in-Build-Configuration">系统属性</a> ）。当删除签出目录，并且此目录与Perforce工作空间相关联时，该工作空间也将被删除。可通过以下方式禁用清洁Perforce工作区<code class="code">teamcity.perforce.workspace.cleanup=false</code>设置，在<a href="build-agent-configuration.html"><code class="code">buildAgent.properties</code></a>文件或在服务器级别上作为根项目<a href="configuring-build-parameters.html">配置参数</a>在全局范围内。</p></li></ul><p id="ec7edff5">删除包含暂挂的更改或打开的文件的Perforce工作区时，TeamCity尝试还原更改并删除暂挂的更改列表，然后重复该操作。如果第二次尝试也失败，TeamCity将尝试运行<code class="code">p4 client -d -f</code>操作（强制）。所有这些动作均已记录到<code class="code">teamcity-vcs.log</code> 。</p><p id="3ca26e72">另外，使用Perforce边缘/副本服务器时，TeamCity不会强制删除工作区。</p></div><a name="Perforcesync-fandworkspacereuse"></a><a name="Perforce-sync--f-and-workspace-reuse"></a><div class="chapter"><h2 id="PerforceWorkspaceHandlinginTeamCity-Perforcesync-fandworkspacereuse">Perforce sync -f和工作空间重用</h2><p id="93af681e">当使用<a href="vcs-checkout-mode.html#agent-checkout">代理端检出时</a> ，TeamCity Perforce插件会创建一个工作空间，该工作空间绑定到代理上的检出目录。使用增量<b id="9de6bc82">p4同步</b>命令（适用于个人和非个人构建）执行检出。</p><p id="aa21b070">将VCS Root配置为使用时<code class="code">p4 sync -p</code> ，Perforce插件始终运行此命令以检出源。</p><p id="332db699">通常，每次<a href="clean-checkout.html">清理结帐都会</a>导致<code class="code">p4 sync -f</code>命令与清理源。但是对于Perforce代理结帐，下面描述了一些例外情况。</p><a name="Errorsduringcheckout"></a><a name="Errors-during-checkout"></a><div class="chapter"><h3 id="PerforceWorkspaceHandlinginTeamCity-Errorsduringcheckout">结帐时出错</h3><p id="6c71bc79">如果在签出过程中发生错误，或者在签出过程中构建被中断/停止，或者发生了超时，则对于同一构建代理上的后续构建，将不会进行<a href="clean-checkout.html">干净的签</a>出。相反，TeamCity将依靠Perforce从状态中恢复的能力。</p></div><a name="VCSRootclientmappingmodification"></a><a name="VCS-Root-client-mapping-modification"></a><div class="chapter"><h3 id="PerforceWorkspaceHandlinginTeamCity-VCSRootclientmappingmodification">VCS Root客户端映射修改</h3><p id="30259863">通常，当项目管理员修改VCS Root中指定的VCS Root客户端映射时，这被视为VCS Root设置的更改，并导致<a href="clean-checkout.html">干净签出</a> 。可以使用<code class="code">teamcity.perforce.enable-no-clean-checkout=true</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部财产</a> 。</p><aside class="note " rel="30259863" id="94d23a65" data-title=""><p id="9828da0e">改变中<code class="code">teamcity.perforce.enable-no-clean-checkout</code> <a href="configuring-teamcity-server-startup-properties.html#TeamCity-internal-properties">内部属性可</a>对所有受影响的构建配置进行一次性的干净签出。</p></aside><p id="03147c0c">将VCS根目录配置为使用客户端名称或流时，在Perforce中编辑相应客户端/流的客户端映射时，不会进行干净签出。相应的TeamCity问题是<a href="https://youtrack.jetbrains.com/issue/TW-25344" rel="noopener noreferrer" data-external="true" target="_blank">TW-25344</a> 。</p></div><a name="Forcedprotectionagainstcleancheckout"></a><a name="Forced-protection-against-clean-checkout"></a><div class="chapter"><h3 id="PerforceWorkspaceHandlinginTeamCity-Forcedprotectionagainstcleancheckout">强制保护免于结帐</h3><p id="a58343c9">有一个<a href="configuring-build-parameters.html">配置参数</a>可保护构建配置免受TeamCity启动的干净签出的影响， <code class="code">teamcity.agent.failBuildOnCleanCheckout</code> 。当此参数设置为<code class="code">true</code> ，TeamCity将使构建失败，而不是运行干净的签出。除非通过<a href="clean-checkout.html#Enforcing-Clean-Checkout">Enforce clean checkout</a>操作明确要求它，或者在版本配置设置的版本控制设置的checkout选项中启用了“在build之前清除checkout目录中的所有文件”选项，否则它将永远不会清理工作区。</p><p id="b4c09c59">使用自定义签出路径时，更改VCS设置后，TeamCity将不会清除签出目录，而将导致构建失败。要忽略干净签出并继续进行增量签出，请使用<code class="code">teamcity.agent.failBuildOnCleanCheckout=ignoreAndContinue</code>项目或构建配置的<a href="configuring-build-parameters.html">参数</a> 。仅在绝对确定checkout目录中的源处于正确状态时，才执行此操作。</p><p id="e2b7fe76">破碎的个人建筑也是如此。当源变得肮脏并且设置了选项时，TeamCity将使构建失败，而不是运行干净的签出。您可以通过以下方式清理工作副本<code class="code">p4 clean</code> ，例如，尝试继续<code class="code">ignoreAndContinue</code>之后的值（您可以使用指定的<a href="configuring-build-parameters.html">配置参数</a>运行自定义构建）。</p><p id="cf608eb1">相应的TeamCity问题是<a href="https://youtrack.jetbrains.com/issue/TW-33168" rel="noopener noreferrer" data-external="true" target="_blank">TW-33168</a> 。</p><hr id="e5bf6f62"></div></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>