<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Multinode Setup - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Multinode Setup" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/multinode-setup.md|Multinode Setup/configuring-secondary-node.md|Configuring Secondary Node" data-main-title="Multinode Setup" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/multinode-setup.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Multinode Setup" id="multinode-setup.md">Multinode Setup</h1><p id="a6d28e6a">TeamCity allows configuring and starting one or more secondary server instances (nodes) in addition to the main one. The main and secondary nodes operate under the same license and share the TeamCity Data Directory and the database.</p><p id="819a2e3d">Using the multinode setup, you can:</p><ul class="list _ul"><li class="list__item" id="3fc6b7ad"><p>Set up a high-availability TeamCity installation that will have zero read downtime. A secondary node will allow users read operations during the downtime of the main server (for example, during the upgrade).</p></li><li class="list__item" id="d4776b9f"><p>Improve the performance of the main server by delegating tasks to the secondary nodes. A secondary node can detect new commits and process data produced by running builds (build logs, artifacts, statistic values).</p></li></ul><p id="85196c03">The following diagram shows an example of a TeamCity installation with one main node and two secondary nodes, where each secondary node has a certain <a href="configuring-secondary-node.html#Assigning-Responsibilities">responsibility</a> assigned to it:</p><p id="d3790b39"><figure><img alt="TeamCity setup with two nodes" title="TeamCity setup with two nodes" src="/help/img/teamcity/2019.1/multinode-setup.png" id="3a0095bd" width="800" height="954"></figure></p><aside class="note " data-title="" rel="d3790b39" id="924b130f"><p id="d7e9d478">Since TeamCity 2019.1.2, the <a href="https://confluence.jetbrains.com/display/TCD18/Configuring+Running+Builds+Node" data-external="true" target="_blank" rel="noopener noreferrer">Running Builds Node</a> is deprecated, and it will be discontinued in TeamCity 2019.2. If you have Running Builds Nodes set up in your TeamCity installation, we highly recommend replacing these nodes with the regular secondary nodes. If you assign the "<a href="configuring-secondary-node.html#Processing-Data-Produced-by-Builds-on-Secondary-Node">Processing data produced by running builds</a>" responsibility to a secondary node, this node will be processing traffic coming from TeamCity agents, similarly to Running Builds Node.<br>Note that the secondary node offers more features than the Running Builds Node and thus might require as many hardware resources as a regular TeamCity server. Refer to <a href="how-to.html#Estimate-Hardware-Requirements-for-TeamCity">Estimate Hardware Requirements for TeamCity</a> for notes on the recommended hardware.</p></aside><p id="147247de">On this page:</p><p id="218a8355"><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#MultinodeSetup-PrerequisitesforMultinodeSetup">Prerequisites for Multinode Setup</a><ul class="list _bullet"><li class="list__item"><a href="#MultinodeSetup-SharedDataDirectory">Shared Data Directory</a><ul class="list _bullet"><li class="list__item"><a href="#MultinodeSetup-Node-SpecificDataDirectory">Node-Specific Data Directory</a></li></ul></li><li class="list__item"><a href="#MultinodeSetup-ProxyConfiguration">Proxy Configuration</a></li><li class="list__item"><a href="#MultinodeSetup-FirewallSettings">Firewall Settings</a></li></ul></li><li class="list__item"><a href="#MultinodeSetup-Upgrade&amp;Downgrade">Upgrade &amp; Downgrade</a></li><li class="list__item"><a href="#MultinodeSetup-SecondaryNodesLimitations">Secondary Nodes Limitations</a></li></ul></p><a name="PrerequisitesforMultinodeSetup"></a><a name="Prerequisites-for-Multinode-Setup"></a><div class="chapter"><h2 id="MultinodeSetup-PrerequisitesforMultinodeSetup">Prerequisites for Multinode Setup</h2><p id="c2f929ec">This section describes configuration requirements for setting up multiple TeamCity nodes.</p><a name="SharedDataDirectory"></a><a name="Shared-Data-Directory"></a><div class="chapter"><h3 id="MultinodeSetup-SharedDataDirectory">Shared Data Directory</h3><p id="4271260b">The main TeamCity server and secondary nodes require access to the same <a href="teamcity-data-directory.html">TeamCity Data Directory</a> (which must be shared) and to the same database.</p><p id="8246c91b">For a high availability setup, we recommend storing the TeamCity Data Directory on a separate machine. In this case, even if the main server goes down, the secondary nodes will be able to connect to the shared Data Directory.</p><p id="e4d8ab79">Ensure that all machines where TeamCity server nodes will be installed can access the Data Directory in the read/write mode. Using a dedicated network file storage with good performance is recommended.</p><p id="bf370b97">The typical Data Directory mounting options are SMB and NFS. TeamCity uses the Data Directory as a regular file system so all basic file system operations should be supported. The backing storage and way of mounting should not impose strict I/O operations count or I/O volume limits.</p><p id="289a1554">We recommend tuning storage and network performance: make sure to review performance guidelines for your storage solution. For example, increasing MTU for the network connection between the server and the storage usually increases the artifacts transferring speed.</p><p id="783551e3">Note that on Windows, a node might not be able to access the TeamCity Data Directory via a mapped network drive if TeamCity is running as a service. This happens because Windows services cannot work with mapped network drives, and TeamCity does not support the UNC format (<code class="code">\\host\directory</code>) for the Data Directory path. To workaround this problem, you can use <code class="code">mklink</code> as it allows making a symbolic link on a network drive:</p><div class="code-block" data-lang="none">mklink /d "C:\&lt;path to mount point&gt;" "\\&lt;host&gt;\&lt;shared directory name&gt;\"

</div><aside class="note " data-title="" rel="a1dd3476" id="f485303c"><p id="6b095816"><b id="844cef0d">Important!</b></p><p id="8c24274b">If the Data Directory is shared via the SMB protocol, and main and secondary nodes are installed on Windows, make sure that all registry keys mentioned in <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-7/ff686200(v=ws.10)" data-external="true" target="_blank" rel="noopener noreferrer">this article</a> are set to 0 on all of the TeamCity nodes. Otherwise, you can run into stability issues: for example, a build log corruption.</p></aside><a name="Node-SpecificDataDirectory"></a><a name="Node-Specific-Data-Directory"></a><div class="chapter"><h4 id="MultinodeSetup-Node-SpecificDataDirectory">Node-Specific Data Directory</h4><p id="da1a0028">Besides the Data Directory shared with the main server, a secondary node requires a <i id="33f4e0dc">local</i> Data Directory where it stores some caches, unpacked external plugins, and other configuration.</p><p id="566dd241">On the first start of the node, the local Data Directory is automatically created as <code class="code">&lt;TeamCity Data Directory&gt;/nodes/&lt;node_ID&gt;</code>. This is usually the location of the shared Data Directory, the directory used by all nodes.</p><p id="98215099">To reduce the load caused by extra IO requests from all nodes to the shared TeamCity Data Directory and to speed up the nodes' access to data, we highly recommend redefining the location of the node-specific Data Directory to use the node's local disk.</p><p id="4068e9c6">To define a new path to a local directory, use the <code class="code">-Dteamcity.node.data.path</code> property in the TeamCity <a href="configuring-teamcity-server-startup-properties.html#Standard-TeamCity-Startup-Scripts">start-up scripts</a>. Read more in <a href="configuring-secondary-node.html#Installing-Secondary-Node">Configuring Secondary Node</a>.</p></div></div><a name="ProxyConfiguration"></a><a name="Proxy-Configuration"></a><div class="chapter"><h3 id="MultinodeSetup-ProxyConfiguration">Proxy Configuration</h3><p id="cf422eab">To set up a high-availability TeamCity installation, you need to install both the main server and the secondary node behind a reverse proxy and configure it to route requests to the main server while it's available and to the secondary one in other cases. If you are about to set up the TeamCity server behind a reverse proxy for the first time, make sure to review our <a href="how-to.html#Proxy-Server-Setup">notes</a> on this topic.</p><p id="4a29e19e">The following <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check" data-external="true" target="_blank" rel="noopener noreferrer">NGINX</a> configuration will route requests to the secondary node only when the main server is unavailable or when the main server responds with the 503 status code (when starting or upgrading).</p><div class="code-block" data-lang="none">http {
    upstream backend {
        server teamcity-main.local:8111 max_fails=0; # full internal address of the main server;
        server teamcity-ro.local:8111 backup; # full internal address of the secondary node;
    }
  
    server {
        location / {
            proxy_pass      	http://backend;
            proxy_next_upstream error timeout http_503 non_idempotent;
         }
    }
}

</div><p id="d570b7ff">Note that <a href="http://nginx.org/en/" data-external="true" target="_blank" rel="noopener noreferrer">NGINX Open Source</a> does not support active <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/" data-external="true" target="_blank" rel="noopener noreferrer">health checks</a> (which is a better way to configure High Availability installation) and may experience DNS resolution issues. Consider using <a href="https://www.nginx.com/products/nginx/" data-external="true" target="_blank" rel="noopener noreferrer">NGINX Plus</a> or <a href="http://www.haproxy.org/" data-external="true" target="_blank" rel="noopener noreferrer">HA Proxy</a>.</p><p id="a241afde">The HA Proxy configuration example:</p><div class="code-block" data-lang="none">resolvers dns
   nameserver dns %IP%:%PORT%
   resolve_retries       3
   timeout resolve   	1s
   timeout retry     	1s
defaults
   mode http
frontend http-in
   bind *:80
   default_backend tc-ha
backend tc-ha
   option httpchk GET /login.html
   default-server inter 2s fall 2 rise 2
   server tc_main_node %TC_MAIN_NODE_URL:8111% check resolvers dns
   server tc_ro_node %TC_RO_NODE_URL:8111% backup check resolvers dns

</div></div><a name="FirewallSettings"></a><a name="Firewall-Settings"></a><div class="chapter"><h3 id="MultinodeSetup-FirewallSettings">Firewall Settings</h3><p id="f0e174d8">Firewall settings should allow accessing secondary nodes from the agents and from the main TeamCity server (the main server also communicates with the nodes by HTTP).</p></div></div><a name="Upgrade&amp;Downgrade"></a><a name="Upgrade-&amp;-Downgrade"></a><div class="chapter"><h2 id="MultinodeSetup-Upgrade&amp;Downgrade">Upgrade & Downgrade</h2><p id="6d0aab31">It is recommended that the main TeamCity server and all secondary nodes have the same version. However, the main server and the secondary nodes can be running different versions, for example, when the main server is being upgraded. When the versions of the secondary node and the main server are different, the corresponding health report will be displayed on both nodes.</p><p id="c4b7737b">When <b id="3b5e9a86">upgrading to a minor version</b> (a bugfix release), the main and the secondary nodes should be running without issues as the TeamCity data has the same format.</p><p id="dfc02134">When <b id="a68f6e61">upgrading</b> the main server <b id="c0f2a152">to the major version</b>, its TeamCity data format will change. The data will be upgraded while the secondary nodes are running provided they are not performing any write operations. If writing operations are detected on a secondary node, a warning will be displayed, and the main server upgrade will be suspended until the secondary node is stopped.</p><p id="3ad44704">After the main server is upgraded to a new major version, the secondary nodes will detect that the data has been upgraded, show health reports, and stop processing tasks according to their responsibilities. All secondary nodes must be upgraded after the main server upgrade to be able to process tasks.</p><p id="94a070fc">To upgrade nodes in a multinode setup, follow these steps:</p><ol class="list _decimal"><li class="list__item" id="1dcc3666"><p>Stop all secondary nodes (if you forget to do that, you will be warned during the upgrade).</p></li><li class="list__item" id="74ddd709"><p>Start the <a href="upgrade.html">upgrade</a> on the main TeamCity server as usual.</p></li><li class="list__item" id="ae6133e4"><p>Proceed with the upgrade.</p></li><li class="list__item" id="e7516e70"><p>Check that everything works properly and agents are connecting (the agents will reroute the data, that was supposed to be routed to the secondary nodes, to the main server).</p></li><li class="list__item" id="e8638d1e"><p>Upgrade the TeamCity installation on the secondary nodes to the same version.</p></li><li class="list__item" id="e2256601"><p>Start the secondary nodes and check that they are connected on the <b id="b8e6505b">Administration | Server Administration | Nodes Configuration</b> page on the main server.</p></li></ol><p id="e0a03c55">To <b id="7a3939a2">downgrade</b> nodes in a multinode setup, follow these steps:</p><ol class="list _decimal"><li class="list__item" id="24bb9788"><p>Shutdown the main server and the secondary nodes.</p></li><li class="list__item" id="0dc73640"><p><a href="restoring-teamcity-data-from-backup.html">Restore the data</a> from backup (only if the data format has been changed during the upgrade).</p></li><li class="list__item" id="3a38f8a3"><p>Downgrade the TeamCity software on the main server.</p></li><li class="list__item" id="7706ec2b"><p>Start the main TeamCity server and check that everything works properly.</p></li><li class="list__item" id="60a538cf"><p>Downgrade the TeamCity software on the secondary nodes to the same version as the main server.</p></li><li class="list__item" id="0be86bc3"><p>Start the secondary nodes.</p></li></ol><p id="7a75699e">TeamCity agents will perform upgrade/downgrade automatically.</p></div><a name="SecondaryNodesLimitations"></a><a name="Secondary-Nodes-Limitations"></a><div class="chapter"><h2 id="MultinodeSetup-SecondaryNodesLimitations">Secondary Nodes Limitations</h2><p id="ffcda418">A secondary server has a few limitations compared to the main server:</p><ul class="list _ul"><li class="list__item" id="a4c66295"><p>A secondary node does not allow changing the server configuration and state. The pages are served in the read-only mode, and not all administration pages and actions are available.</p></li><li class="list__item" id="09ca9051"><p>Currently, only bundled plugins and a limited set of some other plugins can be loaded by a secondary server. Some functionality provided by external plugins can be missing. Read more in <a href="configuring-secondary-node.html#Using-Plugins">Configuring Secondary Node</a>.</p></li><li class="list__item" id="97773a2c"><p>Users may need to relogin when they are routed to a secondary node if they did not select the <i id="463777bf">Remember Me</i> option.</p></li></ul><hr id="ed298771"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>