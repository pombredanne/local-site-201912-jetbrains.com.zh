<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>多节点设置-帮助|团队城市</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Multinode Setup" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/multinode-setup.md|Multinode Setup/configuring-secondary-node.md|Configuring Secondary Node" data-main-title="Multinode Setup" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/multinode-setup.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="multinode-setup.md" data-toc="Multinode Setup">多节点设置</h1><p id="a6d28e6a">除主要实例外，TeamCity还允许配置和启动一个或多个辅助服务器实例（节点）。主节点和辅助节点在相同的许可证下运行，并共享TeamCity数据目录和数据库。</p><p id="819a2e3d">使用多节点设置，您可以：</p><ul class="list _ul"><li class="list__item" id="3fc6b7ad"><p>设置一个高可用性TeamCity安装，其读取停机时间为零。辅助节点将允许用户在主服务器停机期间（例如，在升级期间）读取操作。</p></li><li class="list__item" id="d4776b9f"><p>通过将任务委派给辅助节点来提高主服务器的性能。辅助节点可以检测新的提交并处理通过运行构建生成的数据（构建日志，工件，统计值）。</p></li></ul><p id="85196c03">下图显示了一个TeamCity安装示例，其中有一个主节点和两个辅助节点，其中每个辅助节点都分配有一定的<a href="configuring-secondary-node.html#Assigning-Responsibilities">职责</a> ：</p><p id="d3790b39"></p><figure><img alt="具有两个节点的TeamCity设置" title="具有两个节点的TeamCity设置" src="/help/img/teamcity/2019.1/multinode-setup.png" id="3a0095bd" width="800" height="954"></figure><p></p><aside class="note " rel="d3790b39" id="924b130f" data-title=""><p id="d7e9d478">从TeamCity 2019.1.2开始，不建议<a href="https://confluence.jetbrains.com/display/TCD18/Configuring+Running+Builds+Node" rel="noopener noreferrer" data-external="true" target="_blank">运行构建节点</a> ，并且在TeamCity 2019.2中将不再使用该节点。如果在TeamCity安装中设置了“正在运行的构建节点”，我们强烈建议将这些节点替换为常规的辅助节点。如果您将“ <a href="configuring-secondary-node.html#Processing-Data-Produced-by-Builds-on-Secondary-Node">处理通过运行构建产生的数据</a> ”职责分配给辅助节点，则该节点将处理来自TeamCity代理的流量，类似于“运行构建节点”。<br>请注意，辅助节点提供的功能比“运行中的构建节点”更多，因此可能需要与常规TeamCity服务器一样多的硬件资源。有关建议的硬件的说明，请参阅<a href="how-to.html#Estimate-Hardware-Requirements-for-TeamCity">TeamCity的估计硬件要求</a> 。</p></aside><p id="147247de">在此页：</p><p id="218a8355"></p><ul class="list" data-skip-index="skip"><li class="list__item"><a href="#MultinodeSetup-PrerequisitesforMultinodeSetup">多节点设置的先决条件</a><ul class="list _bullet"><li class="list__item"><a href="#MultinodeSetup-SharedDataDirectory">共享数据目录</a><ul class="list _bullet"><li class="list__item"><a href="#MultinodeSetup-Node-SpecificDataDirectory">特定于节点的数据目录</a></li></ul></li><li class="list__item"><a href="#MultinodeSetup-ProxyConfiguration">代理配置</a></li><li class="list__item"><a href="#MultinodeSetup-FirewallSettings">防火墙设定</a></li></ul></li><li class="list__item"><a href="#MultinodeSetup-Upgrade&Downgrade">升级与降级</a></li><li class="list__item"><a href="#MultinodeSetup-SecondaryNodesLimitations">辅助节点限制</a></li></ul><p></p><a name="PrerequisitesforMultinodeSetup"></a><a name="Prerequisites-for-Multinode-Setup"></a><div class="chapter"><h2 id="MultinodeSetup-PrerequisitesforMultinodeSetup">多节点设置的先决条件</h2><p id="c2f929ec">本节描述了设置多个TeamCity节点的配置要求。</p><a name="SharedDataDirectory"></a><a name="Shared-Data-Directory"></a><div class="chapter"><h3 id="MultinodeSetup-SharedDataDirectory">共享数据目录</h3><p id="4271260b">主TeamCity服务器和辅助节点需要访问同一<a href="teamcity-data-directory.html">TeamCity数据目录</a> （必须共享）和同一数据库。</p><p id="8246c91b">对于高可用性设置，我们建议将TeamCity数据目录存储在单独的计算机上。在这种情况下，即使主服务器出现故障，辅助节点也将能够连接到共享数据目录。</p><p id="e4d8ab79">确保将要安装TeamCity服务器节点的所有计算机都可以以读/写模式访问数据目录。建议使用性能良好的专用网络文件存储。</p><p id="bf370b97">典型的数据目录安装选项是SMB和NFS。 TeamCity将数据目录用作常规文件系统，因此应支持所有基本文件系统操作。后备存储和安装方式不应施加严格的I / O操作计数或I / O体积限制。</p><p id="289a1554">我们建议调整存储和网络性能：确保查看存储解决方案的性能准则。例如，增加服务器和存储之间的网络连接的MTU通常会增加工件传输速度。</p><p id="783551e3">请注意，在Windows上，如果TeamCity作为服务运行，则节点可能无法通过映射的网络驱动器访问TeamCity数据目录。发生这种情况是因为Windows服务无法与映射的网络驱动器一起使用，并且TeamCity不支持UNC格式（ <code class="code">\\host\directory</code> ）作为数据目录路径。要变通解决此问题，您可以使用<code class="code">mklink</code>因为它允许在网络驱动器上建立符号链接：</p><div class="code-block" data-lang="none">mklink / d“ C：\ <path to="" mount="" point="">”“ \\ <host>\ <shared name="" directory="">\”</shared></host></path></div><aside class="note " rel="a1dd3476" id="f485303c" data-title=""><p id="6b095816"><b id="844cef0d">重要！</b></p><p id="8c24274b">如果数据目录是通过SMB协议共享的，并且主节点和辅助节点都安装在Windows上，请确保在所有TeamCity节点上将<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-7/ff686200(v=ws.10)" rel="noopener noreferrer" data-external="true" target="_blank">本文</a>中提到的所有注册表项都设置为0。否则，您可能会遇到稳定性问题：例如，构建日志损坏。</p></aside><a name="Node-SpecificDataDirectory"></a><a name="Node-Specific-Data-Directory"></a><div class="chapter"><h4 id="MultinodeSetup-Node-SpecificDataDirectory">特定于节点的数据目录</h4><p id="da1a0028">除了与主服务器共享的数据目录外，辅助节点还需要一个<i id="33f4e0dc">本地</i>数据目录，在其中存储一些缓存，未打包的外部插件和其他配置。</p><p id="566dd241">在节点的第一个起点，本地数据目录将自动创建为<code class="code"><TeamCity Data Directory>/nodes/<node_ID></code> 。这通常是共享数据目录（所有节点使用的目录）的位置。</p><p id="98215099">为了减少所有节点对共享TeamCity Data Directory的额外IO请求造成的负载并加快节点对数据的访问，我们强烈建议重新定义特定于节点的Data Directory的位置，以使用节点的本地磁盘。</p><p id="4068e9c6">要定义本地目录的新路径，请使用<code class="code">-Dteamcity.node.data.path</code> TeamCity <a href="configuring-teamcity-server-startup-properties.html#Standard-TeamCity-Startup-Scripts">启动脚本</a>中的属性。在<a href="configuring-secondary-node.html#Installing-Secondary-Node">配置辅助节点中</a>了解更多信息。</p></div></div><a name="ProxyConfiguration"></a><a name="Proxy-Configuration"></a><div class="chapter"><h3 id="MultinodeSetup-ProxyConfiguration">代理配置</h3><p id="cf422eab">要设置高可用性TeamCity安装，您需要在反向代理后面安装主服务器和辅助节点，并将其配置为将请求路由到可用的主服务器，在其他情况下将请求路由到辅助服务器。如果你是即将成立的背后，首次反向代理的TeamCity的服务器，请务必仔细阅读我们的<a href="how-to.html#Proxy-Server-Setup">注意事项</a>对这个话题。</p><p id="4a29e19e">以下<a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check" rel="noopener noreferrer" data-external="true" target="_blank">NGINX</a>配置仅在主服务器不可用或主服务器以503状态代码响应时（启动或升级时）才将请求路由到辅助节点。</p><div class="code-block" data-lang="none">http {上游后端{服务器teamcity-main.local：8111 max_fails = 0; ＃主服务器的完整内部地址；服务器teamcity-ro.local：8111备份； ＃辅助节点的完整内部地址； }服务器{位置/ {proxy_pass http：// backend; proxy_next_upstream错误超时http_503 non_idempotent; }}}</div><p id="d570b7ff">请注意， <a href="http://nginx.org/en/" rel="noopener noreferrer" data-external="true" target="_blank">NGINX开源</a>不支持主动<a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check/" rel="noopener noreferrer" data-external="true" target="_blank">运行状况检查</a> （这是配置高可用性安装的更好方法），并且可能会遇到DNS解析问题。考虑使用<a href="https://www.nginx.com/products/nginx/" rel="noopener noreferrer" data-external="true" target="_blank">NGINX Plus</a>或<a href="http://www.haproxy.org/" rel="noopener noreferrer" data-external="true" target="_blank">HA代理</a> 。</p><p id="a241afde">HA代理配置示例：</p><div class="code-block" data-lang="none">解析器dns名称服务器dns％IP％：％PORT％resolve_retries 3超时解析1s超时重试1s默认模式http前端http-in绑定*：80 default_backend tc-ha后端tc-ha选项httpchk GET /login.html default-server inter 2s下降2上升2服务器tc_main_node％TC_MAIN_NODE_URL：8111％检查解析器dns服务器tc_ro_node％TC_RO_NODE_URL：8111％备份检查解析器dns</div></div><a name="FirewallSettings"></a><a name="Firewall-Settings"></a><div class="chapter"><h3 id="MultinodeSetup-FirewallSettings">防火墙设定</h3><p id="f0e174d8">防火墙设置应允许从代理和主TeamCity服务器访问辅助节点（主服务器还通过HTTP与节点通信）。</p></div></div><a name="Upgrade&Downgrade"></a><a name="Upgrade-&-Downgrade"></a><div class="chapter"><h2 id="MultinodeSetup-Upgrade&Downgrade">升级与降级</h2><p id="6d0aab31">建议主TeamCity服务器和所有辅助节点具有相同版本。但是，例如，在升级主服务器时，主服务器和辅助节点可以运行不同的版本。当辅助节点和主服务器的版本不同时，相应的运行状况报告将显示在两个节点上。</p><p id="c4b7737b"><b id="3b5e9a86">升级到次要版本</b> （错误修正版本）时，由于TeamCity数据具有相同的格式，因此主节点和辅助节点应运行正常。</p><p id="dfc02134">将主服务器<b id="a68f6e61">升级</b>到主<b id="c0f2a152">版本时</b> ，其TeamCity数据格式将更改。如果辅助节点未执行任何写操作，则它们将在运行时升级数据。如果在辅助节点上检测到写入操作，将显示警告，并且主服务器升级将被挂起，直到辅助节点停止。</p><p id="3ad44704">主服务器升级到新的主版本后，辅助节点将检测到数据已升级，显示运行状况报告并根据其职责停止处理任务。必须在主服务器升级之后升级所有辅助节点，才能处理任务。</p><p id="94a070fc">要升级多节点设置中的节点，请按照下列步骤操作：</p><ol class="list _decimal"><li class="list__item" id="1dcc3666"><p>停止所有辅助节点（如果忘记这样做，将在升级过程中警告您）。</p></li><li class="list__item" id="74ddd709"><p>照常在主TeamCity服务器上开始<a href="upgrade.html">升级</a> 。</p></li><li class="list__item" id="ae6133e4"><p>继续升级。</p></li><li class="list__item" id="e7516e70"><p>检查一切正常，并检查代理是否正在连接（代理将把应该路由到辅助节点的数据重新路由到主服务器）。</p></li><li class="list__item" id="e8638d1e"><p>将辅助节点上的TeamCity安装升级到相同版本。</p></li><li class="list__item" id="e2256601"><p>启动辅助节点，并在“ <b id="b8e6505b">管理” |“</b>检查”中检查它们是否已连接。 <b id="b8e6505b">服务器管理|</b>主服务器上的“ <b id="b8e6505b">节点配置”</b>页面。</p></li></ol><p id="e0a03c55">要<b id="7a3939a2">降级</b>多节点设置中的节点，请按照下列步骤操作：</p><ol class="list _decimal"><li class="list__item" id="24bb9788"><p>关闭主服务器和辅助节点。</p></li><li class="list__item" id="0dc73640"><p>从备份<a href="restoring-teamcity-data-from-backup.html">还原数据</a> （仅在升级过程中更改了数据格式时）。</p></li><li class="list__item" id="3a38f8a3"><p>降级主服务器上的TeamCity软件。</p></li><li class="list__item" id="7706ec2b"><p>启动主TeamCity服务器，并检查一切是否正常。</p></li><li class="list__item" id="60a538cf"><p>将辅助节点上的TeamCity软件降级为与主服务器相同的版本。</p></li><li class="list__item" id="0be86bc3"><p>启动辅助节点。</p></li></ol><p id="7a75699e">TeamCity代理将自动执行升级/降级。</p></div><a name="SecondaryNodesLimitations"></a><a name="Secondary-Nodes-Limitations"></a><div class="chapter"><h2 id="MultinodeSetup-SecondaryNodesLimitations">辅助节点限制</h2><p id="ffcda418">与主服务器相比，辅助服务器有一些限制：</p><ul class="list _ul"><li class="list__item" id="a4c66295"><p>辅助节点不允许更改服务器配置和状态。这些页面以只读模式提供，并且并非所有管理页面和操作均可用。</p></li><li class="list__item" id="09ca9051"><p>当前，辅助服务器只能加载捆绑的插件和一些其他插件的有限集合。外部插件提供的某些功能可能会丢失。在<a href="configuring-secondary-node.html#Using-Plugins">配置辅助节点中</a>了解更多信息。</p></li><li class="list__item" id="97773a2c"><p>如果用户未选择“ <i id="463777bf">记住我”</i>选项，则在将其路由到辅助节点时可能需要重新登录。</p></li></ul><hr id="ed298771"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>