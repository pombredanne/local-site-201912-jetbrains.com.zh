<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>为TeamCity配置VCS提交后挂接-帮助|帮助团队城市</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body  data-id="Configuring VCS Post-Commit Hooks for TeamCity" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/managing-projects-and-build-configurations.md|Managing Projects and Build Configurations/configuring-vcs-settings.md|Configuring VCS Settings/configuring-vcs-roots.md|Configuring VCS Roots/configuring-vcs-post-commit-hooks-for-teamcity.md|Configuring VCS Post-Commit Hooks for TeamCity" data-main-title="Configuring VCS Post-Commit Hooks for TeamCity" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/configuring-vcs-post-commit-hooks-for-teamcity.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索TeamCity帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="configuring-vcs-post-commit-hooks-for-teamcity.md" data-toc="Configuring VCS Post-Commit Hooks for TeamCity">为TeamCity配置VCS提交后挂接</h1><a name="Overview"></a><a name="Overview"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Overview">总览</h2><p id="f92a1ee5">默认情况下，TeamCity使用轮询方法来检测VCS存储库中的更改，也就是说，对于每个VCS根目录，它都会定期将请求发送到版本控制存储库服务器，以查找是否有新修订。对于具有数百个VCS根目录的大型安装，这可能会在VCS服务器和TeamCity本身上造成明显的负载。</p><p id="be5e4e23">为避免后台轮询，可以在VCS服务器上设置提交后挂接，该挂接将通知TeamCity开始检查更改过程。这样，TeamCity仅在可用更改时才发出后台请求以进行更改检测。</p><p id="2f092ab3">即使已配置提交挂钩并正常工作，TeamCity仍会在服务器启动和每个构建队列（或启动）上发出更改请求，以确保即使提交挂钩停止运行也要使用最新更改。</p><p id="69ff7ce6">提交落实挂接调用时，TeamCity自动增加<a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS轮询间隔</a> （增加后的最小值为15分钟，最大值为4小时，每次成功检查均增加2倍）。如果提交挂钩停止工作（例如，TeamCity在未收到提交挂钩调用的VCS根目录中找到更改），则<a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS轮询间隔</a>值将重置为默认值。</p><p id="e4933929">提交挂钩是通过TeamCity REST API <a href="rest-api.html#VCS-Roots">请求</a>接收的，通常应将其配置为在提交后存储库触发器中：</p><p id="16708fc2"><code class="code">POST .../app/rest/vcs-root-instances/commitHookNotification?locator=<vcsRootInstancesLocator></code></p><p id="6f0abdb7">该请求返回有关已执行操作的文本详细信息或错误消息。</p><p id="3301f3e9">重要的是要找到<code class="code"><vcsRootInstancesLocator></code>请求仅匹配TeamCity实例中配置的受影响的VCS根目录。如果使用提交挂钩中配置的请求匹配了太多的VCS根，则与使用默认轮询方法相比，它将导致更多的请求和更多的VCS存储库和TeamCity过载。下面提供了“定位器”的一些示例。<br>该请求应由对定义了VCS根目录的所有项目具有“查看项目和所有父项目”权限的用户执行。<br>请注意，默认情况下， <a href="rest-api.html#VCS-Roots">request</a>只会匹配前100个匹配的“ VCS根实例”。要匹配更多，可以如下添加“ count：9999”。</p><p id="32f50985">最常见的形式<code class="code"><vcsRootInstancesLocator></code>是：</p><div class="code-block" data-lang="bash">vcsRoot：（type： <type>，count：99999），property：（name： <url_property_name>，value： <vcs_repository_url_part>，matchType：contains，ignoreCase：true），count：99999</vcs_repository_url_part></url_property_name></type></div><p id="55801037">但是，对于没有参数的VCS根目录<code class="code">%-references</code> ，可以使用性能更高的方差：</p><div class="code-block" data-lang="bash">vcsRoot：（type： <type>，property：（name： <url_property_name>，value： <vcs_repository_url_part>，matchType：contains，ignoreCase：true），count：99999），count：99999</vcs_repository_url_part></url_property_name></type></div><p id="373401ed">下面介绍基于UNIX的VCS服务器的提交挂钩示例。</p></div><a name="Post-commitgenericscript"></a><a name="Post-commit-generic-script"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Post-commitgenericscript">提交后的通用脚本</h2><p id="90e365f7">将以下脚本在VCS服务器上另存为<code class="code">teamcity-trigger.sh</code> （您需要生成一个个人<a href="managing-your-user-account.html#Managing-Access-Tokens">访问令牌</a> ）：</p><div class="code-block" data-lang="bash">SERVER = https：// buildserver-url ACCESS_TOKEN =“ <access-token>” LOCATOR = $ 1＃以下是单行：（sleep 10; curl --header“ Authorization：Bearer $ ACCESS_TOKEN” -X POST“ $ SERVER / app / rest / vcs-root-instances / commitHookNotification？locator = $ LOCATOR“ -o / dev / null）> / dev / null 2>＆1 <＆1＆退出0</access-token></div><p id="e81d3082">根据您的TeamCity服务器设置变量。用户必须对定义了VCS根的项目具有“ <b id="41393b16">查看构建配置设置”</b>权限。默认情况下，此权限包含在<b id="ded43a02">项目开发人员</b>角色中。</p><aside class="note " rel="e81d3082" id="b1d4278e" data-title=""><p id="082b61d9">如果您的TeamCity服务器使用自定义SSL证书，则需要通过<code class="code">-k</code>要么<code class="code">--cacert /path/to/correct/internal/CACertificate</code>的参数<code class="code">curl</code>上面的命令。</p></aside></div><a name="Settinguppost-receivehookonGitserver"></a><a name="Setting-up-post-receive-hook-on-Git-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Settinguppost-receivehookonGitserver">在Git服务器上设置接收后挂钩</h2><p id="1362336a">1。在目标VCS服务器上找到Git存储库根目录。它应该包含<code class="code">.git/hooks</code>目录和一些模板。</p><p id="9258758a">2。创建<code class="code">.git/hooks/post-receive</code>带有一行的文件：</p><div class="code-block" data-lang="bash">/path/to/teamcity-trigger.sh'vcsRoot：（type：jetbrains.git，count：99999），property：（name：url，value：，matchType：contains，ignoreCase：true），count：99999 <vcs root="" repository="" url="">'</vcs></div><p id="4dfc3542">哪里<code class="code"><VCS root repository URL></code>必须替换为在相应TeamCity VCS根目录中指定的存储库URL，并且值应转义为URL。请注意，定位器具有<code class="code">matchType:contains</code>在其中，这意味着您可以指定URL的某些部分<code class="code">too.file</code> 。</p><p id="4abd23f6">3。确保两者<code class="code">teamcity-trigger.sh</code>和<code class="code">hooks/post-receive</code>脚本可以由Git用户读取和执行。您可能需要执行以下命令：</p><div class="code-block" data-lang="bash">chmod 755 /path/to/teamcity-trigger.sh /path/to/git_root/.git/hooks/post-receive</div></div><a name="SettinguphookonMercurialserver"></a><a name="Setting-up-hook-on-Mercurial-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-SettinguphookonMercurialserver">在Mercurial服务器上设置挂钩</h2><p id="76c5e66d">1。在目标VCS服务器上找到Mercurial存储库根目录。</p><p id="9d8b74f6">2。创建或编辑<code class="code">.hg/hgrc config</code>并添加以下代码段：</p><div class="code-block" data-lang="bash">[钩] changegroup = /path/to/teamcity-trigger.sh“vcsRoot：（类型：水银，计数：99999），属性：（名称：repositoryPath，值<vcs root="" repository="" url="">：，使用MatchType：含有IGNORECASE：真），计数：99999 '</vcs></div><p id="b04bc67c">哪里<code class="code"><VCS root repository URL></code>必须替换为在相应TeamCity VCS根目录中指定的存储库URL，并且值应转义为URL。请注意，定位器具有<code class="code">matchType:contains</code>在其中，这意味着您也可以指定URL的某些部分。</p><p id="46b15e27">3。确保<code class="code">teamcity-trigger.sh</code>是可执行的。您可能需要执行以下命令：</p><div class="code-block" data-lang="bash">chmod 755 /路径/到/teamcity-trigger.sh</div></div><a name="Settinguppost-commithookonSubversionserver"></a><a name="Setting-up-post-commit-hook-on-Subversion-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Settinguppost-commithookonSubversionserver">在Subversion服务器上设置提交后挂钩</h2><p id="aca7eee4">1。找到包含版本号的Subversion存储库根目录<code class="code">db</code> ， <code class="code">hooks</code> ， <code class="code">locks</code>和其他目录。我们需要<code class="code">hooks</code>目录。</p><p id="b94ebd8c">2。创建<code class="code">hooks/post-commit</code>带有一行的文件：</p><div class="code-block" data-lang="bash">/path/to/teamcity-trigger.sh'vcsRoot：（type：svn，count：99999），property：（name：url，value：，matchType：contains，ignoreCase：true），count：99999 <vcs root="" repository="" url="">'</vcs></div><p id="9ff0c1f7">哪里<code class="code"><VCS root repository URL></code>必须替换为在相应TeamCity VCS根目录中指定的存储库URL，并且值应转义为URL。请注意，定位器具有<code class="code">matchType:contains</code>在其中，这意味着您也可以指定URL的某些部分。</p><p id="aee6f9b1">3。确保两者<code class="code">teamcity-trigger.sh</code>和<code class="code">hooks/post-commit</code>脚本可以由Subversion服务器的进程读取和执行。您可能需要执行以下命令：</p><div class="code-block" data-lang="bash">chmod 755 /path/to/teamcity-trigger.sh / path / to / svn_repository_root / hooks / post-commit</div></div><a name="Settinguppost-committriggeronPerforceserver"></a><a name="Setting-up-post-commit-trigger-on-Perforce-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Settinguppost-committriggeronPerforceserver">在Perforce服务器上设置提交后触发器</h2><p id="8e641428">设置一个<code class="code">change-commit</code>在<a href="https://www.perforce.com/perforce/r15.1/manuals/p4sag/chapter.scripting.html#scripting.trigger.table.fields" rel="noopener noreferrer" data-external="true" target="_blank">编辑规范</a>时通过添加一行或多行来触发（以下文本必须放在一行中，每个VCS根目录下一行）：</p><div class="code-block" data-lang="bash">check-for-changes-teamcity更改提交// depot / project1 / ...“ /path/teamcity-trigger.sh' <vcs root="" locator="">'”</vcs></div><p id="fe26dc5e">哪里<code class="code"><VCS Root locator></code>可以是以下之一：</p><ul class="list _ul"><li class="list__item" id="edd2d644"><p>对于基于流的VCS根目录：</p></li></ul><div class="code-block" data-lang="bash">vcsRoot：（type：perforce，count：99999），property：（name：stream，value：// streamdepot / streamname，matchType：contains，ignoreCase：true），count：99999</div><ul class="list _ul"><li class="list__item" id="24d896b6"><p>对于基于客户端的VCS根目录：</p></li></ul><div class="code-block" data-lang="bash">vcsRoot：（type：perforce，count：99999），property：（name：client，value： <client name="">，matchType：contains，ignoreCase：true），count：99999</client></div><ul class="list _ul"><li class="list__item" id="c6796668"><p>对于客户端映射的VCS根目录：</p></li></ul><div class="code-block" data-lang="bash">vcsRoot：（type：perforce，count：99999），property：（name：client-mapping，value： <some unique="" part="" of="" client="" mapping="">，matchType：contains，ignoreCase：true），count：99999</some></div></div><a name="SettingupservicehookonTeamFoundationServerforTFVCandGit"></a><a name="Setting-up-service-hook-on-Team-Foundation-Server-for-TFVC-and-Git"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-SettingupservicehookonTeamFoundationServerforTFVCandGit">在Team Foundation Server上为TFVC和Git设置服务挂钩</h2><p id="b1ca80b5">最新的Azure DevOps服务器（以前称为Team Foundation Server）和Azure DevOps服务为代码提交事件提供服务挂钩。要创建一个挂钩，请执行以下步骤：</p><p id="cb78d203">1。在Web访问中打开团队项目的管理页面。</p><p id="b3bc57cf">2。通过运行向导创建订阅。</p><p id="48788e6c">3。选择要与之集成的“ Web Hooks”服务。</p><p id="82482024">4。选择“已签入代码”事件并指定过滤器。</p><p id="a10ff545">5，填写以下格式的TeamCity用户名，密码和服务器URL：</p><div class="code-block" data-lang="bash">“ $ SERVER / app / rest / vcs-root-instances / commitHookNotification？locator = $ LOCATOR“</div><p id="44d5eca2">在哪里<code class="code">$LOCATOR</code>值取决于TFS存储库类型，如以下各节所述。</p><a name="TFVCRepository"></a><a name="TFVC-Repository"></a><div class="chapter"><h3 id="ConfiguringVCSPost-CommitHooksforTeamCity-TFVCRepository">TFVC资料库</h3><div class="code-block" data-lang="bash">vcsRoot：{type：tfs，count：99999），property：{name：tfs-url，value： <tfs server="" url="">，matchType：contains，ignoreCase：true），property：{name：tfs-root，value： <tfs project="">，matchType：contains，ignoreCase ：true），计数：99999</tfs></tfs></div><p id="7173854b">哪里<code class="code"><TFS server url></code>必须替换为TFS VCS根URL和路径属性中指定的值。例：</p><div class="code-block" data-lang="bash">http：// teamcity / app / rest / vcs-root-instances / commitHookNotification？locator = vcsRoot：（type：tfs，count：99999），property：（name：tfs-url，value：http％3A％2F％2Ftfs ％3Aport％2Ftfs％2Fcollection，matchType：contains，ignoreCase：true），属性：（name：tfs-root，value：Project，matchType：contains，ignoreCase：true），count：99999</div></div><a name="GitRepository"></a><a name="Git-Repository"></a><div class="chapter"><h3 id="ConfiguringVCSPost-CommitHooksforTeamCity-GitRepository">Git存储库</h3><div class="code-block" data-lang="bash">vcsRoot：（type：jetbrains.git，count：99999），property：（name：url，value： <vcs root="" repository="" url="">，matchType：contains，ignoreCase：true），count：99999</vcs></div><p id="20db0819">哪里<code class="code"><VCS root repository URL></code>必须替换为在相应TeamCity VCS根目录中指定的存储库URL，并且值应转义为URL。例：</p><div class="code-block" data-lang="bash">http：// teamcity / app / rest / vcs-root-instances / commitHookNotification？locator = vcsRoot：（type：jetbrains.git，count：99999），property：（name：url，value：https％3A％2F％2Faccount .visualstudio.com％2FDefaultCollection％2FProject％2F_git％2FRepository，matchType：包含，ignoreCase：true），计数：99999</div><p id="ac5c7f11">6。单击<b id="3c71fd6c">完成</b>以创建服务挂钩。</p></div></div><a name="Troubleshooting"></a><a name="Troubleshooting"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Troubleshooting">故障排除</h2><p id="568aa030">建议在配置实际的钩子之前尝试从命令行执行以下命令：</p><div class="code-block" data-lang="bash">curl --header“授权：承载$ ACCESS_TOKEN” -X POST“ $ SERVER / app / rest / vcs-root-instances / commitHookNotification？locator = $ LOCATOR“</div><p id="5c1c98ef">如果提交挂钩与服务器上的VCS根目录正确匹配，则应该看到类似以下的输出：</p><div class="code-block" data-lang="bash">计划检查1个VCS根的更改。（服务器时间：20160719T192540.787 + 0300）</div><p id="fd436aa1">如果提交挂钩尚未找到任何VCS根目录，它将报告错误：</p><div class="code-block" data-lang="bash">找不到VCS根...

</div><p id="46cabf4d">此输出的可能原因：</p><ul class="list _ul"><li class="list__item" id="7ad6497c"><p>指定的定位器不正确，与服务器上的任何VCS根目录都不匹配</p></li><li class="list__item" id="312a05b3"><p>指定的用户对至少一个匹配的VCS根没有足够的权限。</p></li></ul><p id="7ed96ad3">要检查实际匹配的根，请使用请求（另请参阅<a href="rest-api.html#VCS-Roots">详细信息</a> ）：</p><div class="code-block" data-lang="bash">curl --header“授权：承载$ ACCESS_TOKEN” -X POST“ $ SERVER / app / rest / vcs-root-instances？locator = $ LOCATOR“</div><aside class="note " rel="867ebd48" id="6287f612" data-title=""><p id="db06ac08">提交挂钩支持匹配多个VCS根，但强烈建议将匹配的VCS根仅限制为受生成事件的更改影响的根。</p><p id="b47da5a0">建议为每个VCS存储库设置一个提交挂钩。在这种情况下，在检入某些存储库时，TeamCity将不会花费资源来尝试在其他不相关的VCS根目录中查找也与提交钩子匹配的提交。</p><p id="91ae8943">默认情况下，TeamCity中与提交挂钩匹配的VCS根数限制为100。如果要匹配100个以上的VCS根，请添加count参数： <code class="code"><locator>,count:1000</code> 。检查相应的<a href="rest-api.html#VCS-Roots">请求描述</a> 。</p></aside><hr id="95e095cc"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>