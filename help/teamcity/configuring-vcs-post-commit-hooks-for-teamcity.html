<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><title>Configuring VCS Post-Commit Hooks for TeamCity - Help | TeamCity</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Configuring VCS Post-Commit Hooks for TeamCity" data-breadcrumbs="teamcity-documentation.md|TeamCity Documentation/administrator-s-guide.md|Administrator's Guide/managing-projects-and-build-configurations.md|Managing Projects and Build Configurations/configuring-vcs-settings.md|Configuring VCS Settings/configuring-vcs-roots.md|Configuring VCS Roots/configuring-vcs-post-commit-hooks-for-teamcity.md|Configuring VCS Post-Commit Hooks for TeamCity" data-main-title="Configuring VCS Post-Commit Hooks for TeamCity" data-edit-url="https://github.com/JetBrains/teamcity-documentation/edit/2019.1/topics/configuring-vcs-post-commit-hooks-for-teamcity.md"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search TeamCity Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>TeamCity 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Configuring VCS Post-Commit Hooks for TeamCity" id="configuring-vcs-post-commit-hooks-for-teamcity.md">Configuring VCS Post-Commit Hooks for TeamCity</h1><a name="Overview"></a><a name="Overview"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Overview">Overview</h2><p id="f92a1ee5">By default TeamCity uses a polling approach to detect changes in a VCS repository, that is for each VCS Root, it periodically sends requests to the version control repository server to find out whether there are new revisions. For large installations with hundreds of VCS roots, this may create a noticeable load on the VCS server and on TeamCity itself.</p><p id="be5e4e23">To avoid background polling, it is possible to set up a post-commit hook on the VCS server, which will notify TeamCity to start checking for changes procedure. This way TeamCity will make background requests for changes detection only when such changes are available.</p><p id="2f092ab3">Even with commit hooks configured and working properly TeamCity still makes requests for changes on the server start and on each build queuing (or starting) to ensure the latest changes are used even if commit hooks stopped to function.</p><p id="69ff7ce6">When a commit hook call comes in, TeamCity automatically increases the <a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS polling interval</a> (the minimum after the increase is 15 minutes, maximum is 4 hours, increased by 2 times on each successful check). If the commit hook stops working (for example, TeamCity finds a change in a VCS root which it did not receive a commit hook call for), the <a href="configuring-vcs-roots.html#Common-VCS-Root-Properties">VCS polling interval</a> value is reset to default.</p><p id="e4933929">Commit hooks are received via TeamCity REST API <a href="rest-api.html#VCS-Roots">requests</a> which should typically be configured to in the post-commit repository triggers:</p><p id="16708fc2"><code class="code">POST .../app/rest/vcs-root-instances/commitHookNotification?locator=&lt;vcsRootInstancesLocator&gt;</code></p><p id="6f0abdb7">The request returns textual details as to the performed operation or an error message.</p><p id="3301f3e9">It is important to find the <code class="code">&lt;vcsRootInstancesLocator&gt;</code> for the request to match only the affected VCS roots from those configured in the TeamCity instance. If too many VCS roots are matched by the request configured in the commit hook, it will lead to more requests and more overload on the VCS repository and TeamCity than using default polling approach. Some examples of the "locator" are provided below.<br>The request should be performed by a user who has "View project and all parent projects" permission for all the projects where VCS root is defined.<br>Note that by default only the first 100 matched "VCS root instances" will be matched by the <a href="rest-api.html#VCS-Roots">request</a>. To match more, "count:9999" can be added as below.</p><p id="32f50985">The most common form of the <code class="code">&lt;vcsRootInstancesLocator&gt;</code> is:</p><div class="code-block" data-lang="bash">vcsRoot:(type:&lt;TYPE&gt;,count:99999),property:(name:&lt;URL_PROPERTY_NAME&gt;,value:&lt;VCS_REPOSITORY_URL_PART&gt;,matchType:contains,ignoreCase:true),count:99999

</div><p id="55801037">However, for VCS roots without parameter <code class="code">%-references</code>, a more performant variance can be used:</p><div class="code-block" data-lang="bash">vcsRoot:(type:&lt;TYPE&gt;,property:(name:&lt;URL_PROPERTY_NAME&gt;,value:&lt;VCS_REPOSITORY_URL_PART&gt;,matchType:contains,ignoreCase:true),count:99999),count:99999

</div><p id="373401ed">Commit hooks examples for UNIX-based VCS servers are described below.</p></div><a name="Post-commitgenericscript"></a><a name="Post-commit-generic-script"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Post-commitgenericscript">Post-commit generic script</h2><p id="90e365f7">Save the script below on a VCS server as <code class="code">teamcity-trigger.sh</code> (you'll need to generate a personal <a href="managing-your-user-account.html#Managing-Access-Tokens">access token</a>):</p><div class="code-block" data-lang="bash">SERVER=https://buildserver-url
ACCESS_TOKEN="&lt;access-token&gt;"
 
LOCATOR=$1
 
# The following is one-line:
(sleep 10;  curl --header "Authorization: Bearer $ACCESS_TOKEN" -X POST "$SERVER/app/rest/vcs-root-instances/commitHookNotification?locator=$LOCATOR" -o /dev/null) &gt;/dev/null 2&gt;&amp;1 &lt;&amp;1 &amp;
 
exit 0

</div><p id="e81d3082">Set the  variables according to your TeamCity server. The user must have <b id="41393b16">View build configuration settings</b> permission for projects where VCS root is defined. This permission is included in the <b id="ded43a02">Project developer</b> role by default.</p><aside class="note " data-title="" rel="e81d3082" id="b1d4278e"><p id="082b61d9">If your TeamCity server uses a custom SSL certificate, you'll need to pass <code class="code">-k</code> or  <code class="code">--cacert /path/to/correct/internal/CACertificate</code> parameter to the <code class="code">curl</code> command above.</p></aside></div><a name="Settinguppost-receivehookonGitserver"></a><a name="Setting-up-post-receive-hook-on-Git-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Settinguppost-receivehookonGitserver">Setting up post-receive hook on Git server</h2><p id="1362336a">1. Locate the Git repository root on the target VCS server. It should contain the <code class="code">.git/hooks</code> directory with some templates.</p><p id="9258758a">2. Create the <code class="code">.git/hooks/post-receive</code> file with a line:</p><div class="code-block" data-lang="bash">/path/to/teamcity-trigger.sh 'vcsRoot:(type:jetbrains.git,count:99999),property:(name:url,value:&lt;VCS root repository URL&gt;,matchType:contains,ignoreCase:true),count:99999'

</div><p id="4dfc3542">where <code class="code">&lt;VCS root repository URL&gt;</code> must be replaced with the repository URL specified in the corresponding TeamCity VCS root and the value should be URL-escaped. Note that locator has <code class="code">matchType:contains</code> in it, which means you can specify some part of URL <code class="code">too.file</code>.</p><p id="4abd23f6">3. Make sure that both <code class="code">teamcity-trigger.sh</code> and <code class="code">hooks/post-receive</code> scripts can be read and executed by Git user(s). You may need to execute the following command:</p><div class="code-block" data-lang="bash">chmod 755 /path/to/teamcity-trigger.sh /path/to/git_root/.git/hooks/post-receive

</div></div><a name="SettinguphookonMercurialserver"></a><a name="Setting-up-hook-on-Mercurial-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-SettinguphookonMercurialserver">Setting up hook on Mercurial server</h2><p id="76c5e66d">1. Locate the Mercurial repository root on the target VCS server.</p><p id="9d8b74f6">2. Create or edit the <code class="code">.hg/hgrc config</code> and add the following snippet:</p><div class="code-block" data-lang="bash">[hooks]
changegroup = /path/to/teamcity-trigger.sh 'vcsRoot:(type:mercurial,count:99999),property:(name:repositoryPath,value:&lt;VCS root repository url&gt;,matchType:contains,ignoreCase:true),count:99999'

</div><p id="b04bc67c">where <code class="code">&lt;VCS root repository URL&gt;</code> must be replaced with the repository URL specified in the corresponding TeamCity VCS root and the value should be URL-escaped. Note that the locator has <code class="code">matchType:contains</code> in it, which means you can specify some part of the URL too.</p><p id="46b15e27">3. Make sure that <code class="code">teamcity-trigger.sh</code> is executable. You may need to execute the following command:</p><div class="code-block" data-lang="bash">chmod 755 /path/to/teamcity-trigger.sh

</div></div><a name="Settinguppost-commithookonSubversionserver"></a><a name="Setting-up-post-commit-hook-on-Subversion-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Settinguppost-commithookonSubversionserver">Setting up post-commit hook on Subversion server</h2><p id="aca7eee4">1. Locate the Subversion repository root containing the <code class="code">db</code>, <code class="code">hooks</code>, <code class="code">locks</code>, and other directories. We need the <code class="code">hooks</code> directory.</p><p id="b94ebd8c">2. Create the <code class="code">hooks/post-commit</code> file with a line:</p><div class="code-block" data-lang="bash">/path/to/teamcity-trigger.sh 'vcsRoot:(type:svn,count:99999),property:(name:url,value:&lt;VCS root repository url&gt;,matchType:contains,ignoreCase:true),count:99999'

</div><p id="9ff0c1f7">where <code class="code">&lt;VCS root repository URL&gt;</code> must be replaced with the repository URL specified in the corresponding TeamCity VCS root and the value should be URL-escaped. Note that the locator has <code class="code">matchType:contains</code> in it, which means you can specify some part of URL too.</p><p id="aee6f9b1">3. Make sure that both <code class="code">teamcity-trigger.sh</code> and <code class="code">hooks/post-commit</code> script can be read and executed by the process of the Subversion server. You may need to execute the following command:</p><div class="code-block" data-lang="bash">chmod 755 /path/to/teamcity-trigger.sh /path/to/svn_repository_root/hooks/post-commit

</div></div><a name="Settinguppost-committriggeronPerforceserver"></a><a name="Setting-up-post-commit-trigger-on-Perforce-server"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Settinguppost-committriggeronPerforceserver">Setting up post-commit trigger on Perforce server</h2><p id="8e641428">Set up a <code class="code">change-commit</code> trigger by adding one or several lines when <a href="https://www.perforce.com/perforce/r15.1/manuals/p4sag/chapter.scripting.html#scripting.trigger.table.fields" data-external="true" target="_blank" rel="noopener noreferrer">editing specification</a> (the text below must be placed in one line, one line per a VCS Root):</p><div class="code-block" data-lang="bash">check-for-changes-teamcity change-commit //depot/project1/... "/path/teamcity-trigger.sh '&lt;VCS Root locator&gt;'"

</div><p id="fe26dc5e">where <code class="code">&lt;VCS Root locator&gt;</code> can be one of the following:</p><ul class="list _ul"><li class="list__item" id="edd2d644"><p>for Stream-based VCS roots:</p></li></ul><div class="code-block" data-lang="bash">vcsRoot:(type:perforce,count:99999),property:(name:stream,value://streamdepot/streamname,matchType:contains,ignoreCase:true),count:99999

</div><ul class="list _ul"><li class="list__item" id="24d896b6"><p>for Client-based VCS roots:</p></li></ul><div class="code-block" data-lang="bash">vcsRoot:(type:perforce,count:99999),property:(name:client,value:&lt;client name&gt;,matchType:contains,ignoreCase:true),count:99999

</div><ul class="list _ul"><li class="list__item" id="c6796668"><p>for Client-mapping VCS roots:</p></li></ul><div class="code-block" data-lang="bash">vcsRoot:(type:perforce,count:99999),property:(name:client-mapping,value:&lt;some unique part of client mapping&gt;,matchType:contains,ignoreCase:true),count:99999

</div></div><a name="SettingupservicehookonTeamFoundationServerforTFVCandGit"></a><a name="Setting-up-service-hook-on-Team-Foundation-Server-for-TFVC-and-Git"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-SettingupservicehookonTeamFoundationServerforTFVCandGit">Setting up service hook on Team Foundation Server for TFVC and Git</h2><p id="b1ca80b5">The latest Azure DevOps Server (formerly, Team Foundation Server) and Azure DevOps Services provide service hooks for code commit events. To create a hook, perform the following steps:</p><p id="cb78d203">1. Open the admin page for a team project in web access.</p><p id="b3bc57cf">2. Create a subscription by running the wizard.</p><p id="48788e6c">3. Select the "Web Hooks" service to integrate with.</p><p id="82482024">4. Select the "Code checked in" event and specify a filter.</p><p id="a10ff545">5. Fill in the TeamCity username, password, and server URL in the format:</p><div class="code-block" data-lang="bash">"$SERVER/app/rest/vcs-root-instances/commitHookNotification?locator=$LOCATOR"

</div><p id="44d5eca2">where the <code class="code">$LOCATOR</code> value depends on the TFS repository type as described in the sections below.</p><a name="TFVCRepository"></a><a name="TFVC-Repository"></a><div class="chapter"><h3 id="ConfiguringVCSPost-CommitHooksforTeamCity-TFVCRepository">TFVC Repository</h3><div class="code-block" data-lang="bash">
vcsRoot:(type:tfs,count:99999),property:(name:tfs-url,value:&lt;TFS server url&gt;,matchType:contains,ignoreCase:true),property:(name:tfs-root,value:&lt;TFS project&gt;,matchType:contains,ignoreCase:true),count:99999

</div><p id="7173854b">where <code class="code">&lt;TFS server url&gt;</code> must be replaced with the value specified in the TFS VCS root URL and path properties. Example:</p><div class="code-block" data-lang="bash">
http://teamcity/app/rest/vcs-root-instances/commitHookNotification?locator=vcsRoot:(type:tfs,count:99999),property:(name:tfs-url,value:http%3A%2F%2Ftfs%3Aport%2Ftfs%2Fcollection,matchType:contains,ignoreCase:true),property:(name:tfs-root,value:Project,matchType:contains,ignoreCase:true),count:99999

</div></div><a name="GitRepository"></a><a name="Git-Repository"></a><div class="chapter"><h3 id="ConfiguringVCSPost-CommitHooksforTeamCity-GitRepository">Git Repository</h3><div class="code-block" data-lang="bash">vcsRoot:(type:jetbrains.git,count:99999),property:(name:url,value:&lt;VCS root repository URL&gt;,matchType:contains,ignoreCase:true),count:99999

</div><p id="20db0819">where <code class="code">&lt;VCS root repository URL&gt;</code> must be replaced with the repository URL specified in the corresponding TeamCity VCS root and the value should be URL-escaped. Example:</p><div class="code-block" data-lang="bash">http://teamcity/app/rest/vcs-root-instances/commitHookNotification?locator=vcsRoot:(type:jetbrains.git,count:99999),property:(name:url,value:https%3A%2F%2Faccount.visualstudio.com%2FDefaultCollection%2FProject%2F_git%2FRepository,matchType:contains,ignoreCase:true),count:99999

</div><p id="ac5c7f11">6. Click <b id="3c71fd6c">Finish</b> to create the service hook.</p></div></div><a name="Troubleshooting"></a><a name="Troubleshooting"></a><div class="chapter"><h2 id="ConfiguringVCSPost-CommitHooksforTeamCity-Troubleshooting">Troubleshooting</h2><p id="568aa030">It is recommended to try executing the following command from the command line before configuring the actual hook:</p><div class="code-block" data-lang="bash">curl --header "Authorization: Bearer $ACCESS_TOKEN" -X POST "$SERVER/app/rest/vcs-root-instances/commitHookNotification?locator=$LOCATOR"

</div><p id="5c1c98ef">If the commit hook matches the VCS root on the server correctly, you should see the output similar to this:</p><div class="code-block" data-lang="bash">Scheduled checking for changes for 1 VCS roots. (Server time: 20160719T192540.787+0300)

</div><p id="fd436aa1">If the commit hook has not found any VCS roots, it will report an error:</p><div class="code-block" data-lang="bash">No VCS roots are found ...

</div><p id="46cabf4d">Possible reasons for this output:</p><ul class="list _ul"><li class="list__item" id="7ad6497c"><p>the specified locator is incorrect, it does not match any VCS root on the server</p></li><li class="list__item" id="312a05b3"><p>the specified user does not have enough permission for at least one of the matched VCS roots.</p></li></ul><p id="7ed96ad3">To check what roots are actually matched, use the request (see also <a href="rest-api.html#VCS-Roots">details</a>):</p><div class="code-block" data-lang="bash">curl --header "Authorization: Bearer $ACCESS_TOKEN" -X POST "$SERVER/app/rest/vcs-root-instances?locator=$LOCATOR"

</div><aside class="note " data-title="" rel="867ebd48" id="6287f612"><p id="db06ac08">A commit hook supports matching more than one VCS root, but it is highly recommended to limit the matched VCS roots only to those affected by the change generating the event.</p><p id="b47da5a0">It is recommended to set up a commit hook per a VCS repository. In this case on a check-in to some repository, TeamCity will not spend resources trying to find commits in other non-related VCS roots which were also matched by the commit hook.</p><p id="91ae8943">By default, the number of VCS roots matched by a commit hook in TeamCity is limited by 100. If you want to match more than 100 VCS roots, add the count parameter: <code class="code">&lt;locator&gt;,count:1000</code>. Check the corresponding <a href="rest-api.html#VCS-Roots">request description</a>.</p></aside><hr id="95e095cc"></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>