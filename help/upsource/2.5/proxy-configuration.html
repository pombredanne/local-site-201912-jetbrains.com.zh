<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta name="robots" content="noindex"></meta><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><title>Upsource 2.5 Help :: Proxy configuration</title><link rel="stylesheet" href="/help/app/app.css"></head><body data-id="proxy_configuration"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><div class="wrapper"><section class="panel _nav"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search Upsource Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header"><div class="container"><h3>Upsource 2.5 Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="default" selected>Default (Windows/Linux)</option><option data-group="primary" value="default_for_gnome">GNOME</option><option data-group="primary" value="default_for_kde">KDE</option><option data-group="primary" value="default_for_xwin">XWindow</option><option data-group="primary" value="emacs">Emacs</option><option data-group="primary" value="visual_studio">Visual Studio</option><option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option><option data-group="primary" value="eclipse">Eclipse</option><option data-group="secondary" value="mac_os_x_10.5_">Default (Mac OS X 10.5+)</option><option data-group="secondary" value="mac_os_x">OS X</option><option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option><option data-group="secondary" value="intellij_idea_classic_os_x">IntelliJ IDEA Classic (OS X)</option><option data-group="secondary" value="xcode">Xcode</option><option data-group="secondary" value="visual_studio">Visual Studio</option><option data-group="secondary" value="resharper">ReSharper</option><option data-group="secondary" value="resharper_osx">ReSharper OSX</option><option data-group="secondary" value="emacs">Emacs</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="false"><div class="navigation-links _top"><a class="navigation-links__prev" href="things-to-configure-before-starting-upsource.html">Things to Configure Before Starting Upsource</a><a class="navigation-links__next" href="in-cloud-installation.html">In-Cloud Installation</a></div><h1>Proxy configuration</h1><aside class="note sideblock"><a name="d7451e4"></a><p><code class="code" data-lang="Java">&lt;upsource_home&gt;\directory_name</code> should be read as "open the console and change directory to <code class="code" data-lang="Java">directory_name</code> under Upsource home directory."</p></aside><aside class="note sideblock"><a name="d7451e13"></a><p>All commands listed here are Windows commands. If you're working on a Linux or Mac OS X server, simply replace <code class="code" data-lang="Java">.bat</code> with <code class="code" data-lang="Java">.sh</code>.</p></aside><a name="d7451e22"></a><p>You can set up Upsource to work behind a reverse proxy server. There are two requirements that your environment should meet to make this possible:</p><ul class="list _ul"><li class="list__item"><a name="d7451e27"></a> Your proxy server must support WebSockets. For example, <a name="d7451e29"></a><a href="http://nginx.org" data-external="true"><span>Nginx</span></a> supports WebSockets since version 1.3.13.</li><li class="list__item"><a name="d7451e33"></a> Upsource should be hosted under root URL (<code class="code" data-lang="Java">/</code>) on your virtual host.</li></ul><a name="d7451e40"></a><p>If these requirements are met, start with configuring Upsource to use a base URL (the URL that end users will request for to access your Upsource installation):</p><a name="d7451e44"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="o">&lt;</span><span class="n">upsource_home</span><span class="o">&gt;</span><span class="err">\</span><span class="n">bin</span><span class="err">\</span><span class="n">upsource</span><span class="o">.</span><span class="na">bat</span> <span class="n">configure</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">port</span> <span class="mi">1111</span> <span class="o">--</span><span class="n">base</span><span class="o">-</span><span class="n">url</span> <span class="n">http</span><span class="o">:</span><span class="c1">//upsource.mydomain.com:2222</span></code></div><a name="d7451e47"></a><p>where:</p><ul class="list _ul"><li class="list__item"><a name="d7451e52"></a>
         <code class="code" data-lang="Java">1111</code> is the port number Upsource will listen to</li><li class="list__item"><a name="d7451e58"></a>
         <code class="code" data-lang="Java">http://upsource.mydomain.com</code> is the address of your proxy server</li><li class="list__item"><a name="d7451e64"></a> and <code class="code" data-lang="Java">2222</code> is the port number your proxy will listen to</li></ul><a name="Nginx configuration"></a><h2>Nginx configuration</h2><a name="d7451e74"></a><p>To ensure support for WebSockets, please use <a name="d7451e76"></a><a href="http://nginx.org" data-external="true"><span>Nginx</span></a> 1.3.13 or later.</p><a name="d7451e80"></a><p>Here's a sample Nginx header configuration (non SSL):</p><a name="d7451e84"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">server</span> <span class="o">{</span>
         <span class="n">listen</span>  <span class="mi">2222</span><span class="o">;</span>
         <span class="n">server_name</span>  <span class="n">localhost</span><span class="o">;</span>
         <span class="n">location</span>  <span class="o">/</span> <span class="o">{</span>
            <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Host</span> <span class="n">$http_host</span><span class="o">;</span>
            <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="n">$proxy_add_x_forwarded_for</span><span class="o">;</span>
            <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Proto</span> <span class="n">$scheme</span><span class="o">;</span>
            <span class="n">proxy_http_version</span> <span class="mf">1.1</span><span class="o">;</span>

            <span class="err">#</span> <span class="n">to</span> <span class="n">proxy</span> <span class="n">WebSockets</span> <span class="n">in</span> <span class="n">nginx</span>
            <span class="n">proxy_set_header</span> <span class="n">Upgrade</span> <span class="n">$http_upgrade</span><span class="o">;</span>
            <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="s">&quot;upgrade&quot;</span><span class="o">;</span>
            <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//upsourcemachine.domain.local:1111;</span>
            <span class="n">proxy_pass_header</span> <span class="n">Sec</span><span class="o">-</span><span class="n">Websocket</span><span class="o">-</span><span class="n">Extensions</span><span class="o">;</span>
         <span class="o">}</span>
      <span class="o">}</span></code></div><a name="d7451e87"></a><p>where:</p><ul class="list _ul"><li class="list__item"><a name="d7451e92"></a>
         <code class="code" data-lang="Java">listen 2222</code> is the port that you have previously specified as a <code class="code" data-lang="Java">--base-url</code> parameter</li><li class="list__item"><a name="d7451e101"></a>
         <code class="code" data-lang="Java">proxy_pass http://upsourcemachine.domain.local:1111/</code> is the path to your Upsource machine with the port that you have previously specified using the <code class="code" data-lang="Java">-–listen-port</code> command</li></ul><a name="d7451e111"></a><p>Nginx SSL configuration goes as follows:</p><ul class="list _ul"><li class="list__item"><a name="d7451e116"></a> Configure base url:
         <a name="d7451e118"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="o">&lt;</span><span class="n">upsource_home</span><span class="o">&gt;</span><span class="err">\</span><span class="n">bin</span><span class="err">\</span><span class="n">upsource</span><span class="o">.</span><span class="na">bat</span> <span class="n">configure</span> <span class="o">--</span><span class="n">listen</span><span class="o">-</span><span class="n">port</span> <span class="mi">1111</span> <span class="o">--</span><span class="n">base</span><span class="o">-</span><span class="n">url</span> <span class="n">https</span><span class="o">:</span><span class="c1">//upsource.mydomain.com/</span></code></div>
      </li><li class="list__item"><a name="d7451e122"></a>
         Nginx configuration file:
         <a name="d7451e124"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">server</span> <span class="o">{</span>
               <span class="n">listen</span> <span class="mi">443</span> <span class="n">ssl</span><span class="o">;</span>

               <span class="n">ssl_certificate</span> <span class="o">&lt;</span><span class="n">path_to_certificate</span><span class="o">&gt;;</span>
               <span class="n">ssl_certificate_key</span> <span class="o">&lt;</span><span class="n">path_to_key</span><span class="o">&gt;;</span>

               <span class="n">server_name</span>  <span class="n">localhost</span><span class="o">;</span>

               <span class="n">location</span>  <span class="o">/</span> <span class="o">{</span>
                  <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Host</span> <span class="n">$http_host</span><span class="o">;</span>
                  <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="n">$proxy_add_x_forwarded_for</span><span class="o">;</span>
                  <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Proto</span> <span class="n">$scheme</span><span class="o">;</span>
                  <span class="n">proxy_http_version</span> <span class="mf">1.1</span><span class="o">;</span>

                  <span class="err">#</span> <span class="n">to</span> <span class="n">proxy</span> <span class="n">WebSockets</span> <span class="n">in</span> <span class="n">nginx</span>
                  <span class="n">proxy_set_header</span> <span class="n">Upgrade</span> <span class="n">$http_upgrade</span><span class="o">;</span>
                  <span class="n">proxy_set_header</span> <span class="n">Connection</span> <span class="s">&quot;upgrade&quot;</span><span class="o">;</span>
                  <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//upsourcemachine.domain.local:1111/;</span>
                  <span class="n">proxy_pass_header</span> <span class="n">Sec</span><span class="o">-</span><span class="n">Websocket</span><span class="o">-</span><span class="n">Extensions</span><span class="o">;</span>
               <span class="o">}</span>
            <span class="o">}</span></code></div>
      </li></ul><a name="d7451e129"></a><p>Please refer to the corresponding Nginx documentation pages for a description of <a name="d7451e131"></a><a href="http://nginx.org/en/docs/http/server_names.html" data-external="true"><span>server_name</span></a>, <a name="d7451e134"></a><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" data-external="true"><span>proxy_set_header</span></a>, <a name="d7451e137"></a><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass" data-external="true"><span>proxy_pass</span></a>.</p><a name="Apache HTTP server configuration"></a><h2>Apache HTTP server configuration</h2><a name="d7451e145"></a><p>To ensure support for WebSockets, please use <a name="d7451e147"></a><a href="http://httpd.apache.org/" data-external="true"><span>Apache HTTP Server</span></a> 2.4.10 or later.</p><a name="d7451e151"></a><p>Make sure to enable<code class="code" data-lang="Java">proxy_wstunnel</code>, <code class="code" data-lang="Java">proxy_http</code>, <code class="code" data-lang="Java">rewrite</code> modules  (and optionally <code class="code" data-lang="Java">headers</code> if you want to use SSL) using the <code class="code" data-lang="Java">a2enmod</code> script:</p><a name="d7451e169"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">$</span> <span class="n">a2enmod</span> <span class="n">headers</span>
      <span class="n">$</span> <span class="n">a2enmod</span> <span class="n">rewrite</span>
      <span class="n">$</span> <span class="n">a2enmod</span> <span class="n">proxy_wstunnel</span>
      <span class="n">$</span> <span class="n">a2enmod</span> <span class="n">proxy_http</span></code></div><a name="d7451e172"></a><p>Add the following directives to the <code class="code" data-lang="Java">VirtualHost</code> section of a relevant <code class="code" data-lang="Java">.conf</code> file:</p><a name="d7451e181"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">RewriteEngine</span> <span class="n">on</span>
      <span class="n">AllowEncodedSlashes</span> <span class="n">on</span>

      <span class="n">RewriteCond</span> <span class="o">%{</span><span class="n">QUERY_STRING</span><span class="o">}</span> <span class="n">transport</span><span class="o">=</span><span class="n">polling</span>
      <span class="n">RewriteRule</span> <span class="o">/(.*)</span><span class="n">$</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:1111/$1 [P]</span>

      <span class="n">ProxyRequests</span> <span class="n">off</span>
      <span class="n">ProxyPass</span> <span class="o">/~</span><span class="n">socket</span><span class="o">.</span><span class="na">io</span><span class="o">/</span> <span class="n">ws</span><span class="o">:</span><span class="c1">//127.0.0.1:1111/~socket.io/</span>
      <span class="n">ProxyPassReverse</span> <span class="o">/~</span><span class="n">socket</span><span class="o">.</span><span class="na">io</span><span class="o">/</span> <span class="n">ws</span><span class="o">:</span><span class="c1">//127.0.0.1:1111/~socket.io/</span>

      <span class="n">ProxyPass</span> <span class="o">/</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:1111/</span>
      <span class="n">ProxyPassReverse</span> <span class="o">/</span> <span class="n">http</span><span class="o">:</span><span class="c1">//127.0.0.1:1111/</span></code></div><a name="d7451e185"></a><p>where <code class="code" data-lang="Java">1111</code> is the port number you configured Upsource to listen to.</p><a name="d7451e191"></a><p>If you want to use SSL, additionally add the following directives to the<code class="code" data-lang="Java">VirtualHost</code> section:</p><a name="d7451e197"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">RequestHeader</span> <span class="n">set</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Proto</span> <span class="s">&quot;https&quot;</span></code></div><a name="IIS reverse proxy"></a><h2>IIS reverse proxy</h2><a name="d7451e203"></a><a name="dynaProc0"></a><section class="procedure-steps"><h2>To use IIS and ARR as a reverse proxy:</h2><ol class=".list _decimal"><li class="list__item">
         Install ARR from the <a name="d7451e207"></a><a href="http://www.iis.net/downloads/microsoft/application-request-routing" data-external="true"><span>IIS site</span></a> .
      </li><li class="list__item">
         Make sure your IIS server supports WebSockets. <a name="d7451e213"></a><a href="http://www.iis.net/learn/get-started/whats-new-in-iis-8/iis-80-websocket-protocol-support" data-external="true"><span>This IIS instruction</span></a> explains how to install a WebSockets support module.
      </li><li class="list__item">
         In IIS Manager, connect to the IIS server - in this case, localhost
      </li><li class="list__item">
         Highlight the server in the <a name="d7451e222"></a><span class="control">Connections</span> pane
      </li><li class="list__item">
         Double-click <a name="d7451e228"></a><span class="control">URL Rewrite</span>
      </li><li class="list__item">
         Click <a name="d7451e235"></a><span class="control">View server variables</span> on the right pane
      </li><li class="list__item">
         Add
         <a name="d7451e241"></a><div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">HTTP_X_FORWARDED_HOST</span>
            <span class="n">HTTP_X_FORWARDED_SCHEME</span>
            <span class="n">HTTP_X_FORWARDED_PROTO</span></code></div>
         to the list
      </li><li class="list__item">
         Highlight the server in the <a name="d7451e247"></a><span class="control">Connections</span> pane.
      </li><li class="list__item">
         Double-click <a name="d7451e253"></a><span class="control">Application Request Routing Cache</span>.
      </li><li class="list__item">
         Click <a name="d7451e259"></a><span class="control">Server Proxy Settings</span> under the Proxy heading in the <a name="d7451e262"></a><span class="control">Actions</span> pane.
      </li><li class="list__item">
         Tick the <a name="d7451e268"></a><span class="control">Enable proxy</span> checkbox and then click <a name="d7451e271"></a><span class="control">Apply</span>. Leave the default values in place.
      </li><li class="list__item">
         Clear the <a name="d7451e278"></a><span class="control">Reverse rewrite host in response headers</span> checkbox and then click <a name="d7451e281"></a><span class="control">Apply</span>.
      </li><li class="list__item">
         In the <a name="d7451e287"></a><span class="control">Connections</span> pane, under <a name="d7451e290"></a><span class="control">Sites</span>, highlight <a name="d7451e293"></a><span class="control">Default Web Site</span>.
      </li><li class="list__item">
         Double-click the <a name="d7451e299"></a><span class="control">URL Rewrite</span> feature, and click <a name="d7451e302"></a><span class="control">Add Rule(s)…</span> in the <a name="d7451e305"></a><span class="control">Actions</span> pane.
      </li><li class="list__item">
         Add a reverse proxy rule, with server name: localhost:1111 (replace with real location and port of your Upsource service).
      </li><li class="list__item">
         Open created rule, check rewrite url, add server variables:
         <ul class="list _ul"><li class="list__item"><a name="d7451e316"></a>
               set HTTP_X_FORWARDED_HOST to {HTTP_HOST}
            </li><li class="list__item"><a name="d7451e319"></a>
               set HTTP_X_FORWARDED_SCHEME to https (if the IIS site is configured to https, else set to http)
            </li><li class="list__item"><a name="d7451e322"></a>
               set HTTP_X_FORWARDED_PROTO to https (if the IIS site is configured to https, else set to http)
            </li></ul>
      </li><li class="list__item">
         Make sure that Anonymous Authentication is enabled:
         <ul class="list _ul"><li class="list__item"><a name="d7451e331"></a>
               In the <a name="d7451e333"></a><span class="control">Connections</span> pane, under <a name="d7451e336"></a><span class="control">Sites</span>, highlight <a name="d7451e339"></a><span class="control">Default Web Site</span>.
            </li><li class="list__item"><a name="d7451e343"></a>
               Double click <a name="d7451e345"></a><span class="control">Authentication</span>, Select <a name="d7451e348"></a><span class="control">Anonymous</span>, Click <a name="d7451e351"></a><span class="control">Enable</span> in the right pane.
            </li></ul>
      </li><li class="list__item">
         <a name="d7451e360"></a><p>Optional (not required for HTTP only access): if HTTPS access is desired, add a new SSL binding to the Default Web Site.</p>
         <ul class="list _ul"><li class="list__item"><a name="d7451e365"></a>The address that SSL binding listens to (Host URL) should match Upsource base URL.</li><li class="list__item"><a name="d7451e368"></a>The certificate you choose should correspond to the server DNS address.</li></ul>
      </li></ol></section><div class="last-modified">Last modified: 14 September 2016 </div></article><div id="disqus_thread"></div></div></section></main></div><script src="/help/app/app.js"></script></body></html>