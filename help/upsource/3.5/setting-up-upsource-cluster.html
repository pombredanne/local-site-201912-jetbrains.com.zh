<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><meta charset="UTF-8"><meta name="robots" content="noindex"><title>Upsource 3.5 Help :: Setting up Upsource cluster</title><link rel="stylesheet" href="/help/app/app.css"></head><body data-id="Setting_up_Upsource_cluster"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search Upsource Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header"><div class="container"><h3>Upsource 3.5 Help</h3><div class="shortcuts-switcher"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="default" selected>Default (Windows/Linux)</option><option data-group="primary" value="default_for_gnome">GNOME</option><option data-group="primary" value="default_for_kde">KDE</option><option data-group="primary" value="default_for_xwin">XWindow</option><option data-group="primary" value="emacs">Emacs</option><option data-group="primary" value="visual_studio">Visual Studio</option><option data-group="primary" value="netbeans_6.5">NetBeans 6.5</option><option data-group="primary" value="eclipse">Eclipse</option><option data-group="secondary" value="mac_os_x_10.5_">Default (Mac OS X 10.5+)</option><option data-group="secondary" value="mac_os_x">OS X</option><option data-group="secondary" value="eclipse_mac_os_x">OS X Eclipse</option><option data-group="secondary" value="intellij_idea_classic_os_x">IntelliJ IDEA Classic (OS X)</option><option data-group="secondary" value="xcode">Xcode</option><option data-group="secondary" value="visual_studio">Visual Studio</option><option data-group="secondary" value="resharper">ReSharper</option><option data-group="secondary" value="resharper_osx">ReSharper OSX</option><option data-group="secondary" value="emacs">Emacs</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="false"><div class="navigation-links _top"><a class="navigation-links__prev" href="upsource-cluster-hardware-requirements.html">Upsource cluster hardware requirements</a><a class="navigation-links__next" href="importing-a-hub-certificate-to-upsource.html">Importing a Hub certificate to Upsource</a></div><h1>Setting up Upsource cluster</h1><a name="d1888e3"></a><p>This is a step-by-step instruction on how to install Upsource in a distributed multi-node cluster. The installation procedure should only be performed once. After it's completed, the services will be managed by a standard docker-compose tool (or more accurately by <a name="d1888e5"></a><i id="d1888e5">cluster.sh</i> - a JetBrains provided docker-compose wrapper that has the same command line format).</p><a name="what's-included"></a><h2>What's included</h2>
        <a name="d1888e11"></a><p>Upsource cluster consists of the following services:</p>
        <table class="no_header             " width="100%" id="d1888e14"><tbody><tr id="d1888e16" class="ijRowOdd"><a name="d1888e16"></a><td><a name="d1888e18"></a><a name="d1888e19"></a><p><a name="d1888e20"></a><b id="d1888e20">frontend</b></p></td><td><a name="d1888e23"></a><a name="d1888e24"></a><p>Upsource web-based UI.</p></td></tr><tr id="d1888e28" class="ijRowEven"><a name="d1888e28"></a><td><a name="d1888e30"></a><a name="d1888e31"></a><p><a name="d1888e32"></a><b id="d1888e32">psi</b></p></td><td><a name="d1888e35"></a><a name="d1888e36"></a><p>Provides code model services (code intelligence) based on IntelliJ IDEA.</p></td></tr><tr id="d1888e40" class="ijRowOdd"><a name="d1888e40"></a><td><a name="d1888e42"></a><a name="d1888e43"></a><p><a name="d1888e44"></a><b id="d1888e44">analyzer</b></p></td><td><a name="d1888e47"></a><a name="d1888e48"></a><p>Imports revisions from VCS to Cassandra database.</p></td></tr><tr id="d1888e52" class="ijRowEven"><a name="d1888e52"></a><td><a name="d1888e54"></a><a name="d1888e55"></a><p><a name="d1888e56"></a><b id="d1888e56">opscenter</b></p></td><td><a name="d1888e59"></a><a name="d1888e60"></a><p>Provides cluster monitoring facilities.</p></td></tr><tr id="d1888e64" class="ijRowOdd"><a name="d1888e64"></a><td><a name="d1888e66"></a><a name="d1888e67"></a><p><a name="d1888e68"></a><b id="d1888e68">haproxy</b></p></td><td><a name="d1888e71"></a><a name="d1888e72"></a><p>Entry point of the distributed Upsource cluster. Proxies all incoming requests to services.</p></td></tr></tbody></table>
        <a name="d1888e77"></a><p>The cluster structure is defined by the <a name="d1888e79"></a><i id="d1888e79">docker-compose.yml</i> file and is parametrized by the properties defined in the <a name="d1888e82"></a><i id="d1888e82">upsource.env</i> file. Both files are included in the <a name="d1888e85"></a><i id="d1888e85">cluster-config</i> artifact (you can download the latest version from <a name="d1888e88"></a><a href="/upsource/download/download-thanks.html?platform=upsourceClusterConfig" data-external="true"><span>here</span></a>).</p>
        <a name="d1888e92"></a><p>Upsource cluster doesn't include:</p>
        <ul class="list _ul"><li class="list__item"><a name="d1888e97"></a><a name="d1888e98"></a><a href="/hub/" data-external="true"><span>JetBrains Hub</span></a></li><li class="list__item"><a name="d1888e101"></a>Cassandra database</li></ul>
    <a name="d1888e106"></a><h2>Prerequisites</h2>
                <ol class="list _decimal"><li class="list__item"><a name="d1888e110"></a>Install <a name="d1888e112"></a><a href="/help/hub/2.5/Install-and-Configure-Hub.html" data-external="true"><span>JetBrains Hub</span></a> or use existing <a name="d1888e115"></a><b id="d1888e115">standalone</b> instance.</li><li class="list__item"><a name="d1888e119"></a>Install Cassandra database (see <a name="d1888e121"></a><a href="https://www.digitalocean.com/community/tutorials/how-to-run-a-multi-node-cluster-database-with-cassandra-on-ubuntu-14-04" data-external="true"><span>Cassandra installation guide</span></a>)</li><li class="list__item"><a name="d1888e125"></a> <a name="d1888e127"></a><p>Setup Docker Swarm Cluster, including:</p>
                        <ul class="list _bullet"><li class="list__item"><a name="d1888e132"></a>swarm manager (master)</li><li class="list__item"><a name="d1888e135"></a>work instances (nodes)</li><li class="list__item"><a name="d1888e138"></a>key-value storage (consul)</li></ul>
                        <a name="d1888e142"></a><p>Refer to <a name="d1888e144"></a><a href="https://docs.docker.com/swarm/install-manual/#/step-2-create-your-instances" data-external="true"><span>this instruction</span></a> to setup a key-value based swarm cluster. </p>
                        <a name="d1888e148"></a><p>Notes to the instruction above:</p>
                        <ul class="list _ul"><li class="list__item"><a name="d1888e153"></a>Install the docker engine of version 1.12 and higher on every swarm node. </li><li class="list__item"><a name="d1888e156"></a>Docker engine swarm mode introduced in 1.12 is not fully integrated with the docker-compose, hence the swarm should be created with the help of swarm docker images.</li><li class="list__item"><a name="d1888e159"></a>Check that the swarm cluster is operational.</li></ul>
                    </li><li class="list__item"><a name="d1888e164"></a><a name="d1888e165"></a><p>Make sure that time between all cluster nodes, and Hub and Cassandra nodes is synchronized (<a name="d1888e167"></a><a href="https://wiki.archlinux.org/index.php/Systemd/Timers" data-external="true"><span>systemd/Timers</span></a> may be suggested as one of the ways to synchronize time).</p>
                    </li></ol>
    <a name="d1888e174"></a><h2>Configure Upsource Cluster</h2>

                <ol class="list _decimal"><li class="list__item"><a name="d1888e178"></a><a name="d1888e179"></a><p>Unpack <a name="d1888e181"></a><a href="/upsource/download/download-thanks.html?platform=upsourceClusterConfig" data-external="true"><span>cluster-config.zip</span></a> to a host from which you're going to manage Upsource cluster - we'll be referring to it as the <a name="d1888e184"></a><i id="d1888e184">cluster admin host</i>.</p> <a name="d1888e188"></a><p>You can use any server, not necessarily a swarm manager or a swarm node. Just make sure that once you've selected it, the cluster is managed from that admin host only.</p>


                    </li><li class="list__item"><a name="d1888e192"></a> Make sure all of these files are located in the same directory:
                        <ul class="list _alpha-lower"><li class="list__item"><a name="d1888e196"></a><a name="d1888e197"></a><i id="d1888e197">cluster.sh</i> a wrapper of the standard docker-compose tool. <a name="d1888e200"></a><i id="d1888e200">cluster.sh</i> defines some variables substituted in <a name="d1888e203"></a><i id="d1888e203">docker-compose.yml</i></li><li class="list__item"><a name="d1888e206"></a><a name="d1888e207"></a><i id="d1888e207">docker-compose.yml</i>  defines Upsource cluster structure. </li><li class="list__item"><a name="d1888e211"></a><a name="d1888e212"></a><i id="d1888e212">upsource.env</i> defines properties passed to the upsource services running inside docker containers.</li><li class="list__item"><a name="d1888e216"></a><a name="d1888e217"></a><i id="d1888e217">docker-compose-params.env</i> defines parameters used in docker-compose.yml (it is assumed that cluster.sh defines default values of the parameters, and docker-compose-params.env overrides defaults if needed depending on the environment).</li></ul>
                    </li><li class="list__item"><a name="d1888e223"></a><a name="d1888e224"></a><p>The port Upsource cluster listens to is defined by the property UPSOURCE_EXPOSED_PROXY_PORT in <a name="d1888e226"></a><i id="d1888e226">cluster.sh</i> and is equal to 8080. This property might be overridden in <a name="d1888e229"></a><i id="d1888e229">docker-compose-params.env</i>.</p>
                    <code class="code" data-lang="Java">UPSOURCE_EXPOSED_PROXY_PORT=&lt;The port number Upsource should listen to&gt;</code> </li><li class="list__item"><a name="d1888e237"></a><a name="d1888e238"></a><p>Define a swarm node on which <a name="d1888e240"></a><i id="d1888e240">opscenter</i> should be deployed by specifying a value for the variable UPSOURCE_OPSCENTER_NODE located in <a name="d1888e243"></a><i id="d1888e243">docker-compose-params.env:</i></p>
                    <a name="d1888e246"></a><p><code class="code" data-lang="Java">UPSOURCE_OPSCENTER_NODE=&lt;opscenter_nodeId&gt;</code> </p>
                    <a name="d1888e251"></a><p>where <a name="d1888e253"></a><i id="d1888e253">opscenter_nodeId</i> is the name of the swarm worker node you're defining.</p></li><li class="list__item"><a name="d1888e257"></a><a name="d1888e258"></a><p>
                        On the node you specified in the previous step (opscenter_nodeId), create a folder for backups and give read-write access permissions to the user with ID 13001 (Upsource service runs under the user <a name="d1888e260"></a><i id="d1888e260">jetbrains with ID 13001</i> inside a container, and will have no access to the mapped volume on the host machine otherwise).</p>
                        <a name="d1888e264"></a><p>Although the backups volume is mapped to the folder <a name="d1888e266"></a><i id="d1888e266">/opt/upsource/backups</i> on the host machine by default, it can be customized in the docker-compose-params.env by editing the UPSOURCE_BACKUPS_PATH_ON_HOST_SYSTEM property. The following commands should be executed on the swarm node (opscenter_nodeId) assuming that the property UPSOURCE_BACKUPS_PATH_ON_HOST_SYSTEM was not changed (otherwise commands should be run against the overridden backups directory):</p>
                    <a name="d1888e270"></a><p><a name="d1888e271"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper">mkdir -p -m <span class="m">750</span> /opt/upsource/backups
chown 13001:13001 /opt/upsource/backups</code></div></p>
                    </li><li class="list__item"><a name="d1888e276"></a>
                        <a name="d1888e278"></a><p>Define a swarm node on which <a name="d1888e280"></a><i id="d1888e280">haproxy</i> service should be deployed by specifying a value for the variable UPSOURCE_PROXY_NODE located in <a name="d1888e283"></a><i id="d1888e283">docker-compose-params.env:</i></p>
                        <a name="d1888e286"></a><p><code class="code" data-lang="Java">UPSOURCE_PROXY_NODE=&lt;haproxy_nodeId&gt;</code> </p>
                        <a name="d1888e291"></a><p>Where <a name="d1888e293"></a><i id="d1888e293">haproxy_nodeId</i> is the name of the swarm worker node you're defining.</p>
                        <a name="d1888e297"></a><p>Note: it is recommended to deploy the haproxy and opscenter services on the same node. Otherwise in some environments, there might be connectivity problems between the haproxy and opscenter containers (when routing a request to the opencenter service, haproxy addresses it by its network alias, not by an overlay network's raw IP address).</p>
                    </li><li class="list__item"><a name="d1888e301"></a>
                        <a name="d1888e303"></a><p>On all the swarm nodes, pre-create service logs directories and give the user with id 13001 read-write access to them (Upsource service runs under the user <a name="d1888e305"></a><i id="d1888e305">jetbrains with ID 13001</i> inside a container, and will have no access to the mapped volume on the host machine otherwise):</p>
                        <a name="d1888e309"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper">mkdir -p -m <span class="m">750</span> /var/log/upsource/psi
chown 13001:13001 /var/log/upsource/psi
mkdir -p -m <span class="m">750</span> /var/log/upsource/analyzer
chown 13001:13001 /var/log/upsource/analyzer
mkdir -p -m <span class="m">750</span> /var/log/upsource/frontend
chown 13001:13001 /var/log/upsource/frontend
mkdir -p -m <span class="m">750</span> /var/log/upsource/opscenter
chown 13001:13001 /var/log/upsource/opscenter
mkdir -p -m <span class="m">750</span> /var/log/upsource/cluster-init
chown 13001:13001 /var/log/upsource/cluster-init</code></div>
                    </li><li class="list__item"><a name="d1888e313"></a>
                        <a name="d1888e315"></a><p>Set variables in <a name="d1888e317"></a><i id="d1888e317">upsource.env</i></p>
                        <ul class="list _alpha-lower"><li class="list__item"><a name="d1888e322"></a>
                                <a name="d1888e324"></a><p>Set CASSANDRA_HOSTS and CASSANDRA_PORT properties:</p>
                                <a name="d1888e327"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper"><span class="nv">CASSANDRA_HOSTS</span><span class="o">=</span>&lt;comma-separated list of cassandra cluster hosts&gt;</code></div><a name="d1888e329"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper"><span class="nv">CASSANDRA_PORT</span><span class="o">=</span>&lt;node port number in cassandra cluster&gt;</code></div>
                            </li><li class="list__item"><a name="d1888e333"></a>Define Hub related properties:
                                <ol class="list _decimal"><li class="list__item"><a name="d1888e337"></a>
                                        <a name="d1888e339"></a><p>HUB_URL</p>
                                        <code class="code" data-lang="Java">HUB_URL=&lt;URL of external Hub&gt;</code>
                                    </li><li class="list__item"><a name="d1888e346"></a>
                                        <a name="d1888e348"></a><p><a name="d1888e349"></a><a href="importing-a-hub-certificate-to-upsource.html"><span>Import a Hub certificate to Upsource</span></a>. Skip this step unless Hub is available through HTTPS via a self-signed certificate or a certificate signed by a private CA.</p>
                                    </li></ol>
                            </li><li class="list__item"><a name="d1888e356"></a>
                                <a name="d1888e358"></a><p> Set the property UPSOURCE_URL to the URL the end users will use to access Upsource.</p>
                                <a name="d1888e361"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper"><span class="nv">UPSOURCE_URL</span><span class="o">=</span>&lt;URL <span class="k">for</span> end users to access Upsource&gt;</code></div>
                                <a name="d1888e364"></a><p>The default URL Upsource is available at is:
                                    http://&lt;haproxy_nodeId.address&gt;:${UPSOURCE_EXPOSED_PROXY_PORT}/</p>
                                <a name="haproxy_nodeId"></a><p>where haproxy_nodeId is the node to which haproxy service is deployed.</p>
                                <a name="d1888e370"></a><p>Your production environment will most likely be set up behind an SSL-terminating proxy (See <a name="d1888e372"></a><a href="proxy-configuration.html"><span>how to configure proxy for Upsource</span></a>. The only difference with cluster is that there is no need to run Upsource configure command, instead Upsource cluster base-url is defined as a value of the property UPSOURCE_URL). In this case, set proxy address as a value of the variable UPSOURCE_URL.</p>
                                <a name="d1888e377"></a><p>Let's assume the value of variable UPSOURCE_URL was set to some &lt;upsource.url&gt;. In this case you should:</p>
                            </li><li class="list__item"><a name="serviceId"></a>
                                <a name="d1888e383"></a><p>Create <a name="d1888e385"></a><a href="/help/hub/2.5/Managing-Services.html" data-external="true"><span>a trusted service in Hub</span></a> (the page &lt;hub.url&gt;/hub/services) for Upsource cluster (note the service id and secret as you will need them <a name="d1888e388"></a><a href="#UpsServeId"><span>in Step e</span></a> to set in the <a name="d1888e391"></a><i id="d1888e391">upsource.env</i> file).</p>
                                        <a name="d1888e395"></a><p>This service will be used by all Upsource services in order to communicate with Hub.</p>
                                <a name="d1888e398"></a><p>Add redirect URLs for the created service:</p>
                                        <ul class="list _ul"><li class="list__item"><a name="d1888e403"></a>&lt;upsource.url&gt;</li><li class="list__item"><a name="d1888e406"></a>&lt;upsource.url&gt;/~download</li><li class="list__item"><a name="d1888e409"></a>&lt;upsource.url&gt;/~generatedTree</li><li class="list__item"><a name="d1888e412"></a>&lt;upsource.url&gt;/~oauth/github</li><li class="list__item"><a name="d1888e415"></a>&lt;upsource.url&gt;/~unsubscribe</li><li class="list__item"><a name="d1888e419"></a>&lt;upsource.url&gt;/~uploads</li><li class="list__item"><a name="d1888e422"></a>&lt;upsource.url&gt;/monitoring </li></ul>
                                <a name="d1888e426"></a><p>Set Upsource service home URL to &lt;upsource.url&gt;</p>
                            </li><li class="list__item"><a name="d1888e430"></a>
                                <a name="UpsServeId"></a><p> Set UPSOURCE_SERVICE_ID and UPSOURCE_SERVICE_SECRET to the values defined in <a name="d1888e434"></a><a href="#serviceId"><span>the Hub trusted service you've created</span></a>:</p>
                                <a name="d1888e438"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper"><span class="nv">UPSOURCE_SERVICE_ID</span><span class="o">=</span>&lt;Key of the trusted service pre-configured in Hub &gt;</code></div>
                                <a name="d1888e441"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper"><span class="nv">UPSOURCE_SERVICE_SECRET</span><span class="o">=</span>&lt;Secret of the trusted service pre-configured in Hub&gt;</code></div>
                            </li></ul>
                    </li><li class="list__item"><a name="d1888e447"></a>
                        <a name="d1888e449"></a><p>Start Upsource cluster init service that will initialize Upsource data structures in the Cassandra instance:</p>
                        <a name="d1888e452"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper">docker -H &lt;swarm.master.host&gt;:&lt;swarm.master.port&gt; run -v /var/log/upsource/cluster-init:/opt/upsource-cluster-init/logs -v /opt/hub/cert:/opt/upsource-cluster-init/conf/cert --env-file<span class="o">=</span>upsource.env jetbrains/upsource-cluster-init:&lt;major.minor.buildNumber&gt;</code></div>
                    </li><li class="list__item"><a name="d1888e456"></a>
                        <a name="d1888e458"></a><p>Check that upsource-cluster-init has started successfully:</p>
                        <a name="d1888e461"></a><p> The logs of the cluster-init execution are located in the <a name="d1888e463"></a><i id="d1888e463">/var/log/upsource/cluster-init</i> directory of the node where the container was started. The following command will give a clue on which node the cluster-init was executed:</p>
                        <a name="d1888e467"></a><div class="code-block" data-lang="Console"><code class="code-block__wrapper">docker -H tcp://&lt;swarm.master.host&gt;:&lt;swarm.master.port&gt; ps -a --format <span class="s2">&quot;{{.ID}}: {{.Names}} {{.Image}}&quot;</span></code></div>
                    </li></ol>
    <a name="d1888e473"></a><h2>Start Upsource cluster</h2>
        <ol class="list _decimal"><li class="list__item"><a name="d1888e477"></a>
                <a name="d1888e479"></a><p> Make sure your external Hub is started and available prior to Upsource cluster startup.</p>
            </li><li class="list__item"><a name="d1888e483"></a>
                <a name="d1888e485"></a><p>Make sure the <a name="d1888e487"></a><a href="https://docs.docker.com/compose/install/" data-external="true"><span>docker-compose</span></a> (version 1.8.1 or higher) is installed on the node where you'd like to manage the cluster from:</p>
                <code class="code" data-lang="Java">docker-compose -v</code>
            </li><li class="list__item"><a name="d1888e495"></a>
                <a name="d1888e497"></a><p>Launch Upsource cluster:</p>
                <code class="code" data-lang="Java">./cluster.sh -H tcp://&lt;swarm.master.host&gt;:&lt;swarm.master.port&gt; up</code>
                <a name="d1888e503"></a><p>The <a name="d1888e505"></a><i id="d1888e505">cluster.sh</i> has the same <a name="d1888e508"></a><a href="https://docs.docker.com/compose/reference/" data-external="true"><span>command line format</span></a> as docker-compose since <a name="d1888e511"></a><i id="d1888e511">cluster.sh</i> is simply a wrapper of <a name="d1888e514"></a><i id="d1888e514">docker-compose</i>.</p>
            </li></ol>
    <div class="navigation-links _bottom"><a class="navigation-links__prev" href="upsource-cluster-hardware-requirements.html">Upsource cluster hardware requirements</a><a class="navigation-links__next" href="importing-a-hub-certificate-to-upsource.html">Importing a Hub certificate to Upsource</a></div><section class="seealso"><div class="seealso__header"><h2>See Also</h2></div><div class="seealso__content">```
                <div class="seealso__col"><h3>How tos:</h3><ul class="list"><li class="list__item"><a name="d1888e531"></a><a href="scaling-upsource-services-in-the-cluster.html"><span>Scaling Upsource services in the cluster</span></a></li></ul></div><div class="seealso__col"><h3>Reference:</h3><ul class="list"><li class="list__item"><a name="d1888e526"></a><a href="upsource-cluster-hardware-requirements.html"><span>Upsource cluster hardware requirements</span></a></li></ul></div></div></section><div class="last-modified">Last modified: 21 February 2017 </div></article><div id="disqus_thread"></div></div></section></main></div><script></script><script src="/help/app/app.js"></script></body></html>