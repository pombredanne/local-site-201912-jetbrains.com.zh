<html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><meta charset="UTF-8"><title>代理配置-帮助|上游</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="proxy_configuration"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索上游帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>上载2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option value="default" data-group="primary" selected>默认（Windows / Linux）</option><option value="mac_os_x_10.5_" data-group="secondary">默认（Mac OS X 10.5+）</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="proxy_configuration.xml" data-toc="proxy_configuration">代理配置</h1>    <div class="chapter"><h2 id="Overview" data-toc="proxy_configuration#Overview">总览</h2>        <aside class="note " rel="Overview" id="5039a5dd" data-title="">            <p id="12dbc815">如果使用第三方代理的唯一原因是要在Upsource服务器与其客户端之间建立安全的HTTPS / TLS连接，请考虑改用Upsource的内置TLS。您可以在安装或升级过程中在“ <a href="configuration-wizard.html">配置向导”</a>中配置和启用它。您还可以使用命令行将<a href="configuring-tls.html">模式配置为HTTP</a>并<a href="configuring-tls.html">从HTTP切换为HTTPS</a> ，然后再将<a href="configuring-tls.html">其切换</a>回当前的Upsource安装中。</p>        </aside>        <p id="1fe18dc1">您可以将Upsource设置为在反向代理服务器后面工作。为了使之成为可能，您的环境必须满足两个要求：</p>        <ul class="list _ul"><li class="list__item" id="aa86c17b"><p>您的代理服务器必须支持WebSockets。例如， <a href="http://nginx.org" rel="noopener noreferrer" data-external="true" target="_blank">Nginx</a>从版本1.11.7开始完全支持WebSocket。</p></li><li class="list__item" id="991e3734"><p>上游应该托管在根URL下（ <code class="code">/</code> ）在您的虚拟主机上。</p></li></ul>        <p id="74c4cb50">如果满足这些要求，请首先将Upsource配置为使用基本URL（最终用户将要求访问运行的Upsource安装的URL）：</p>        <div class="code-block" data-lang="nginx">
        <upsource_home>\ bin \ upsource.bat配置--listen-port 1111 --base-url http://upsource.mydomain.com:2222</upsource_home></div>        <p id="a9466cb0">哪里：</p>        <ul class="list _ul"><li class="list__item" id="4d63efaa"><p>                <code class="code">1111</code>上游将监听的端口号</p></li><li class="list__item" id="ae9f23e8"><p>                <code class="code">http://upsource.mydomain.com</code>是您的代理服务器的地址</p></li><li class="list__item" id="08fcf5ec"><p>和<code class="code">2222</code>是您的代理将监听的端口号</p></li></ul>        <aside class="note " rel="cdb0c708" id="38b8dfe6" data-title="">            <p id="01d09b8d">                <code class="code"><upsource_home>\directory_name</code>应该读为“打开控制台并将目录更改为<code class="code">directory_name</code>在上游主目录下。”</p>            <p id="b281b6af">此处列出的所有命令都是Windows命令。如果您使用的是Linux或macOS，只需更换<code class="code">.bat</code>与<code class="code">.sh</code> 。</p>        </aside>    </div>    <div class="chapter"><h2 id="NginxConfiguration" data-toc="proxy_configuration#NginxConfiguration">Nginx配置</h2>        <p id="18bf52ee">为了确保支持WebSocket，请使用<a href="http://nginx.org" rel="noopener noreferrer" data-external="true" target="_blank">Nginx</a> 1.11.7或更高版本。</p>        <p id="87c761b1">这是Nginx标头配置示例（非SSL）：</p>        <div class="code-block" data-lang="nginx">服务器{收听2222; server_name localhost;位置/ {proxy_set_header X-Forwarded-Host $ http_host; proxy_set_header X-Forwarded-For $ proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $ scheme; proxy_http_version 1.1; ＃代理Nginx中的WebSockets proxy_set_header Upgrade $ http_upgrade; proxy_set_header连接“升级”； proxy_pass http：//upsourcemachine.domain.local：1111; proxy_pass_header Sec-Websocket-Extensions; }}</div>        <p id="07fac99a">哪里：</p>        <ul class="list _ul"><li class="list__item" id="5220caaa"><p>                <code class="code">listen 2222</code>是您先前指定为端口的端口<code class="code">--base-url</code>参数</p></li><li class="list__item" id="fd328c68"><p>                <code class="code">proxy_pass http://upsourcemachine.domain.local:1111/</code>是您使用以下命令先前指定的端口到您的上游计算机的路径<code class="code">-–listen-port</code>命令</p></li></ul>        <p id="b04f7790">Nginx SSL配置如下：</p>        <ul class="list _ul"><li class="list__item" id="cdb1acf9"><p>配置基本网址：</p><div class="code-block" data-lang="nginx">
                <upsource_home>\ bin \ upsource.bat配置--listen-port 1111 --base-url https://upsource.mydomain.com/</upsource_home></div>            <p></p></li><li class="list__item" id="f60f9adf"><p>Nginx配置文件：</p><div class="code-block" data-lang="nginx">服务器{监听443 ssl; ssl_certificate <path_to_certificate>; ssl_certificate_key <path_to_key>; server_name localhost;位置/ {proxy_set_header X-Forwarded-Host $ http_host; proxy_set_header X-Forwarded-For $ proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $ scheme; proxy_http_version 1.1; ＃代理Nginx中的WebSockets proxy_set_header Upgrade $ http_upgrade; proxy_set_header连接“升级”； proxy_pass http：//upsourcemachine.domain.local：1111 /; proxy_pass_header Sec-Websocket-Extensions; }}</path_to_key></path_to_certificate></div>            <p></p></li></ul>        <aside class="note " rel="e339fca9" id="4629523c" data-title="">            <p id="e2db185c">为了加快Upsource的初始加载速度，您可以指示Nginx使用<i id="92221fa0">http2</i>协议。只需添加<code class="code">http2</code>到Nginx配置文件的第二行： <code class="code">listen 443 ssl http2;</code> 。</p>            <p id="9b1953a4"><i id="d320c936">http2</i>协议仅适用于<i id="7f8b37c6">https</i>连接。Nginx版本应为1.11.7或更高版本。</p>        </aside>        <p id="1f7fc957">请参考相应的Nginx文档页面以获取<a href="http://nginx.org/en/docs/http/server_names.html" rel="noopener noreferrer" data-external="true" target="_blank">server_name</a> ， <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" rel="noopener noreferrer" data-external="true" target="_blank">proxy_set_header</a> ， <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass" rel="noopener noreferrer" data-external="true" target="_blank">proxy_pass</a>的描述。</p>    </div>    <div class="chapter"><h2 id="ApacheHTTPserverConfiguration" data-toc="proxy_configuration#ApacheHTTPserverConfiguration">Apache HTTP服务器配置</h2>        <p id="d9b1a0d2">为了确保对WebSocket的支持，请使用<a href="http://httpd.apache.org/" rel="noopener noreferrer" data-external="true" target="_blank">Apache HTTP Server</a> 2.4.10或更高版本。</p>        <p id="b8b5a214">确保启用<code class="code">proxy_wstunnel</code> ， <code class="code">proxy_http</code> ， <code class="code">rewrite</code>模块（以及可选的<code class="code">headers</code>如果您想使用SSL），请使用<code class="code">a2enmod</code>脚本：</p>        <div class="code-block" data-lang="nginx">$ a2enmod标头$ a2enmod重写$ a2enmod proxy_wstunnel $ a2enmod proxy_http</div>        <p id="ce9868c0">将以下指令添加到<code class="code">VirtualHost</code>相关部分<code class="code">.conf</code>文件：</p>        <div class="code-block" data-lang="nginx">RewriteCond％{QUERY_STRING}上的AllowEncodedSlashes上的RewriteEngine传输=轮询RewriteRule /(.*)$ http://127.0.0.1:1111/$1 [P] ProxyPass off ProxyPass /~socket.io/ ws：//127.0.0.1： 1111 /〜socket.io / ProxyPassReverse /~socket.io/ ws：//127.0.0.1：1111 /〜socket.io / ProxyPass / http://127.0.0.1:1111/ ProxyPassReverse / http://127.0.0.1 ：1111 /</div>        <p id="6d0722be">哪里<code class="code">1111</code>是您将“上游”配置为侦听的端口号。</p>        <p id="dab3979b">如果您想使用SSL，请在以下命令中另外添加以下指令： <code class="code">VirtualHost</code>部分：</p>        <div class="code-block" data-lang="nginx">RequestHeader设置X-Forwarded-Proto“ https”</div>        <p id="b5bae6db">为了加快Upsource的初始加载速度，您可以指示Apache使用<i id="2ada70b3">http2</i>协议-将以下指令添加到<code class="code">VirtualHost</code>部分：</p>        <div class="code-block" data-lang="nginx">协议h2 http / 1.1</div>        <p id="b4d44d8e">同时确保模块<code class="code">mod_http2</code>已安装并启用。<i id="7dc2203d">http2</i>协议仅适用于<i id="e2740009">https</i>连接。Apache HTTP版本应为2.4.17或更高版本。</p>        <p id="fa33b33c">            <b id="107a408e">在非root用户上下文中配置Upsource</b> （即<code class="code">http://somesite.com/upsource/</code> ），请使用以下示例：</p>        <div class="code-block" data-lang="nginx">RewriteCond％{QUERY_STRING}上RewriteEngine上的AllowEncodedSlashes transport =轮询Polling RewriteRule /(.*)$ http：// upsource_machine：1111 / upsource / $ 1 [P] ProxyRequests off RequestHeader设置了X-Forwarded-Proto“ https” <location upsource=""></location> ProxyPass http：// upsource_machine：1111 / upsource / ProxyPassReverse http：// upsource_machine：1111 / upsource / <location upsource="" ~socket.io=""></location> ProxyPass ws：// upsource_machine：1111 / upsource /〜socket.io / ProxyPassReverse ws：// upsource_machine：1111 / upsource /〜socket.io /</div>        <p id="e6660092">哪里<code class="code">http://somesite.com/upsource/</code>是基本网址</p>        <p id="8c72473f">和<code class="code">http://upsource_machine:1111/upsource</code>是您的上游计算机的路径。</p>    </div>    <div class="chapter"><h2 id="IISreverseProxy" data-toc="proxy_configuration#IISreverseProxy">IIS反向代理</h2>        <section class="procedure-steps"><h3 id="870b654e">要将IIS和ARR用作反向代理，请执行以下操作：</h3><ol class="list _decimal"><li class="list__item" id="a5eb5b09"><p>从<a href="http://www.iis.net/downloads/microsoft/application-request-routing" rel="noopener noreferrer" data-external="true" target="_blank">IIS站点</a>安装ARR。</p></li><li class="list__item" id="4cd66fa4"><p>确保您的IIS服务器支持WebSocket。<a href="http://www.iis.net/learn/get-started/whats-new-in-iis-8/iis-80-websocket-protocol-support" rel="noopener noreferrer" data-external="true" target="_blank">该IIS指令</a>说明了如何安装WebSockets支持模块。</p></li><li class="list__item" id="c2043cc6"><p>在IIS管理器中，连接到IIS服务器-在本例中为localhost</p></li><li class="list__item" id="a2f04b88"><p>在“ <span class="control">连接”</span>窗格中突出显示服务器</p></li><li class="list__item" id="018d44d2"><p>双击<span class="control">URL重写</span>            </p></li><li class="list__item" id="1a7edbad"><p>单击右侧窗格上的<span class="control">查看服务器变量</span> 。</p></li><li class="list__item" id="7d43eb09"><p>加</p><div class="code-block" data-lang="nginx">HTTP_X_FORWARDED_HOST HTTP_X_FORWARDED_SCHEME HTTP_X_FORWARDED_PROTO</div>到清单<p></p></li><li class="list__item" id="2299f46d"><p>在“ <span class="control">连接”</span>窗格中突出显示服务器。</p></li><li class="list__item" id="e95b07a1"><p>双击“ <span class="control">应用程序请求路由缓存”</span> 。</p></li><li class="list__item" id="da49e5c2"><p>单击<span class="control">“</span> <span class="control">操作”</span>窗格中“代理”标题下的“ <span class="control">服务器代理设置”</span> 。</p></li><li class="list__item" id="b27e67ab"><p>勾选<span class="control">启用代理</span>复选框，然后单击<span class="control">应用</span> 。保留默认值。</p></li><li class="list__item" id="757a4cba"><p>清除“ <span class="control">在响应标头中反向重写主机”</span>复选框，然后单击“ <span class="control">应用”</span> 。</p></li><li class="list__item" id="c056aa06"><p>在“ <span class="control">连接”</span>窗格中的“ <span class="control">站点”</span>下，突出显示“ <span class="control">默认网站”</span> 。</p></li><li class="list__item" id="6e91a68e"><p>双击<span class="control">URL重写</span>功能，然后在“ <span class="control">操作”</span>窗格中单击“ <span class="control">添加规则”</span> 。</p></li><li class="list__item" id="840566bb"><p>添加一个反向代理规则，其服务器名称为：localhost：1111（替换为您的Upsource服务的实际位置和端口）。</p></li><li class="list__item" id="d41a9ba0">                <p id="ea6b1307">打开创建的规则，检查重写URL，添加服务器变量：</p>                <ul class="list _ul"><li class="list__item" id="082c33b3"><p>将HTTP_X_FORWARDED_HOST设置为{HTTP_HOST}</p></li><li class="list__item" id="087196fa"><p>将HTTP_X_FORWARDED_SCHEME设置为https（如果IIS站点配置为https，否则设置为http）</p></li><li class="list__item" id="685fcfc2"><p>将HTTP_X_FORWARDED_PROTO设置为https（如果IIS站点配置为https，否则设置为http）</p></li></ul>            </li><li class="list__item" id="fc6ea4fb">                <p id="68b217b7">确保启用了匿名身份验证：</p>                <ul class="list _ul"><li class="list__item" id="60ecf3bc"><p>在“ <span class="control">连接”</span>窗格中的“ <span class="control">站点”</span>下，突出显示“ <span class="control">默认网站”</span> 。</p></li><li class="list__item" id="f94d9570"><p>双击<span class="control">身份验证</span> ，选择<span class="control">匿名</span> ，在右窗格中单击<span class="control">启用</span> 。</p></li></ul>            </li><li class="list__item" id="a9d7b002">                <p id="0f156f43">可选（对于仅HTTP访问不是必需的）：如果需要HTTPS访问，请将新的SSL绑定添加到默认网站。</p>                <ul class="list _ul"><li class="list__item" id="a17a5996"><p>SSL绑定侦听的地址（主机URL）应与Upsource基本URL相匹配。</p></li><li class="list__item" id="e6b4fe1b"><p>您选择的证书应与服务器DNS地址相对应。</p></li></ul>            </li><li class="list__item" id="fecc8f98">                <p id="e0806792">IIS不支持Websocket压缩，应在Upsource启动时将其禁用。当您准备启动Upsource时，请使用以下命令将其启动以禁用websocket压缩：</p>                <code class="code">upsource.bat start --J-Dbundle.websocket.compression.enabled=false</code>            </li></ol></section>    </div>    <div class="chapter"><h2 id="ELBreverseProxy" data-toc="proxy_configuration#ELBreverseProxy">AWS Elastic Load Balancer反向代理</h2>        <p id="1469e636">为了确保支持WebSocket，请使用<a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" rel="noopener noreferrer" data-external="true" target="_blank">Application Load Balancer</a>类型。</p>        <section class="procedure-steps"><h3 id="40c989ff">要将Application Load Balancer用作反向代理，请执行以下操作：</h3><p id="72c3add7">                </p><p id="87acc958">启动应用程序负载平衡器创建向导，然后执行以下步骤：</p>                <ol class="list _decimal"><li class="list__item" id="01707e30">                        <p id="548aa4a7">                            <span class="control">配置负载均衡器</span> ：使用默认的SSL端口<span class="control">443</span>或您选择的任何其他端口添加HTTPS侦听器。</p>                    </li><li class="list__item" id="dc2eb3aa">                        <p id="58871181">                            <span class="control">配置安全性设置</span> ：从AWS申请证书或上传现有证书。</p>                    </li><li class="list__item" id="74d76dc8">                        <p id="931a49dc">                            <span class="control">配置安全组</span> ：选择与部署Upsource的计算机相关联的现有安全组。</p>                    </li><li class="list__item" id="8038b5a3">                        <p id="86c924d6">                            <span class="control">配置路由</span> ：继续使用HTTP协议和通过定义的端口进行新的组创建<code class="code">--listen-port</code>属性（在我们的示例中为端口1111-参见下文）。</p>                    </li><li class="list__item" id="166123e2">                        <p id="872ca821">                            <span class="control">注册目标</span> ：将Upsource实例添加到“ <span class="control">注册目标</span> ”列表中。</p>                    </li></ol>            <p></p></section>        <p id="26ffe28d">创建Application Load Balancer之后，配置Upsource基本URL：</p><div class="code-block" data-lang="bash">
            <upsource_home>/bin/upsource.sh配置--listen-port 1111 --base-url https://upsource.mydomain.com/</upsource_home></div>        <p></p>        <p id="97155cef">哪里：</p>        <ul class="list _ul"><li class="list__item" id="8ef02c4b"><p>                <code class="code">1111</code>是Upsource会监听的端口号，它是在步骤4 <span class="control">配置路由中</span>指定的            </p></li><li class="list__item" id="e8e632cd"><p>                <code class="code">upsource.mydomain.com</code>是负载均衡器的DNS名称，可以在“负载均衡器<span class="control">描述”</span>选项卡上找到。</p></li></ul>    </div>    <div class="chapter"><h2 id="Limitations" data-toc="proxy_configuration#Limitations">自定义代理规则限制</h2>        <p id="1a6e562d">如果使用<a href="hub.html">外部集线器</a>实例进行设置，则Upsource可能需要CORS对集线器进行某些调用。前述配置可以正常工作，不需要任何进一步的调整。但是，其他自定义代理规则可能会干扰CORS，因此无法登录到Upsource。</p>        <p id="d5abef91">当外部集线器在反向代理后面工作时，应考虑以下因素：</p>        <ol class="list _decimal"><li class="list__item" id="0d1c9e3a">                <p id="c38752e6">代理规则不应阻止与CORS相关的HTTP标头：</p>                <ul class="list _bullet"><li class="list__item" id="7efee6e0"><p>访问控制请求方法</p></li><li class="list__item" id="ac80dbe1"><p>访问控制请求标头</p></li><li class="list__item" id="ea492fd5"><p>访问控制允许来源</p></li><li class="list__item" id="9f65585d"><p>访问控制允许凭证</p></li><li class="list__item" id="fb76aac5"><p>访问控制公开标头</p></li><li class="list__item" id="020743fa"><p>访问控制最大年龄</p></li><li class="list__item" id="6e05add5"><p>访问控制允许方法</p></li><li class="list__item" id="47e97e69"><p>访问控制允许标题</p></li></ul>            </li><li class="list__item" id="e4dd2f69"><p>代理应允许HTTP OPTIONS请求。</p></li><li class="list__item" id="55b744e3"><p>HTTP OPTIONS请求不应是代理强制身份验证的主题（如果有）。例如，可能要设置基于证书的身份验证以符合企业安全策略。在这种情况下，如果传入请求为OPTIONS类型，则应跳过身份验证检查。OPTIONS请求不能单独返回任何与客户相关的数据，因此可以安全地将它们放回去。</p></li></ol>    </div><div class="last-modified" data-skip-index="skip">上次修改时间：2019年8月9日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="in-cloud-installation.html">云端安装</a> <a class="navigation-links__next" href="configuration-wizard.html">首次启动后需要配置的内容</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>