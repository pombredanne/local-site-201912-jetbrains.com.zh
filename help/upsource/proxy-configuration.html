<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><meta charset="UTF-8"><title>Proxy configuration - Help | Upsource</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body data-id="proxy_configuration"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search Upsource Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>Upsource 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="default" selected>Default (Windows/Linux)</option><option data-group="secondary" value="mac_os_x_10.5_">Default (Mac OS X 10.5+)</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="proxy_configuration" id="proxy_configuration.xml">Proxy configuration</h1>    <div class="chapter"><h2 id="Overview" data-toc="proxy_configuration#Overview">Overview</h2>        <aside class="note " data-title="" rel="Overview" id="5039a5dd">            <p id="12dbc815">If your only reason for using a third-party proxy is to set up a secure HTTPS/TLS connection between your                Upsource server and its clients, consider using the Upsource's built-in TLS instead. You can configure                and enable it in <a href="configuration-wizard.html">Configuration Wizard</a> during the installation or                upgrade procedures. You can also <a href="configuring-tls.html">configure and switch the modes from HTTP                    to HTTPS                </a> and back in your current Upsource installation using the command line.            </p>        </aside>        <p id="1fe18dc1">You can set up Upsource to work behind a reverse proxy server. There are two requirements that your            environment should meet to make this possible:        </p>        <ul class="list _ul"><li class="list__item" id="aa86c17b"><p>Your proxy server must support WebSockets. For example, <a href="http://nginx.org" data-external="true" target="_blank" rel="noopener noreferrer">Nginx</a> fully supports                WebSockets starting with version 1.11.7.            </p></li><li class="list__item" id="991e3734"><p>Upsource should be hosted under root URL (<code class="code">/</code>) on your virtual host.            </p></li></ul>        <p id="74c4cb50">If these requirements are met, start with configuring Upsource to use a base URL (the URL that end users will            request to access your running Upsource installation):        </p>        <div class="code-block" data-lang="nginx">
        &lt;upsource_home&gt;\bin\upsource.bat configure --listen-port 1111 --base-url http://upsource.mydomain.com:2222
        </div>        <p id="a9466cb0">where:</p>        <ul class="list _ul"><li class="list__item" id="4d63efaa"><p>                <code class="code">1111</code>                is the port number Upsource will listen to            </p></li><li class="list__item" id="ae9f23e8"><p>                <code class="code">http://upsource.mydomain.com</code>                is the address of your proxy server            </p></li><li class="list__item" id="08fcf5ec"><p>and <code class="code">2222</code> is the port number your proxy will listen to            </p></li></ul>        <aside class="note " data-title="" rel="cdb0c708" id="38b8dfe6">            <p id="01d09b8d">                <code class="code">&lt;upsource_home&gt;\directory_name</code>                should be read as "open the console and change directory to <code class="code">directory_name</code> under Upsource                home directory."            </p>            <p id="b281b6af">All commands listed here are Windows commands. If you're working on a Linux or macOS, simply replace <code class="code">.bat</code> with <code class="code">.sh</code>.            </p>        </aside>    </div>    <div class="chapter"><h2 id="NginxConfiguration" data-toc="proxy_configuration#NginxConfiguration">Nginx configuration</h2>        <p id="18bf52ee">To ensure support for WebSockets, please use <a href="http://nginx.org" data-external="true" target="_blank" rel="noopener noreferrer">Nginx</a> 1.11.7 or later.        </p>        <p id="87c761b1">Here's a sample Nginx header configuration (non SSL):</p>        <div class="code-block" data-lang="nginx">
        server {
            listen 2222;
            server_name localhost;
            location / {
                proxy_set_header X-Forwarded-Host $http_host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_http_version 1.1;

                # to proxy WebSockets in nginx
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection "upgrade";
                proxy_pass http://upsourcemachine.domain.local:1111;
                proxy_pass_header Sec-Websocket-Extensions;
            }
        }
        </div>        <p id="07fac99a">where:</p>        <ul class="list _ul"><li class="list__item" id="5220caaa"><p>                <code class="code">listen 2222</code>                is the port that you have previously specified as a <code class="code">--base-url</code> parameter            </p></li><li class="list__item" id="fd328c68"><p>                <code class="code">proxy_pass http://upsourcemachine.domain.local:1111/</code>                is the path to your Upsource machine with the port that you have previously specified using the <code class="code">-–listen-port</code> command            </p></li></ul>        <p id="b04f7790">Nginx SSL configuration goes as follows:</p>        <ul class="list _ul"><li class="list__item" id="cdb1acf9"><p>Configure base url:                <div class="code-block" data-lang="nginx">
                &lt;upsource_home&gt;\bin\upsource.bat configure --listen-port 1111 --base-url https://upsource.mydomain.com/
                </div>            </p></li><li class="list__item" id="f60f9adf"><p>                Nginx configuration file:                <div class="code-block" data-lang="nginx">
                server {
                    listen 443 ssl;

                    ssl_certificate &lt;path_to_certificate&gt;;
                    ssl_certificate_key &lt;path_to_key&gt;;

                    server_name localhost;

                    location / {
                        proxy_set_header X-Forwarded-Host $http_host;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                        proxy_http_version 1.1;

                        # to proxy WebSockets in nginx
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "upgrade";
                        proxy_pass http://upsourcemachine.domain.local:1111/;
                        proxy_pass_header Sec-Websocket-Extensions;
                    }
                }
                </div>            </p></li></ul>        <aside class="note " data-title="" rel="e339fca9" id="4629523c">            <p id="e2db185c">To speed up Upsource's initial loading, you can instruct Nginx to use the <i id="92221fa0">http2</i> protocol. Just add <code class="code">http2</code> to the second line of the Nginx config file: <code class="code">listen 443 ssl http2;</code>.            </p>            <p id="9b1953a4">The <i id="d320c936">http2</i> protocol will work for <i id="7f8b37c6">https</i> connections only. The Nginx version should be 1.11.7                or newer.            </p>        </aside>        <p id="1f7fc957">Please refer to the corresponding Nginx documentation pages for a description of <a href="http://nginx.org/en/docs/http/server_names.html" data-external="true" target="_blank" rel="noopener noreferrer">server_name</a>, <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" data-external="true" target="_blank" rel="noopener noreferrer">proxy_set_header</a>, <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass" data-external="true" target="_blank" rel="noopener noreferrer">proxy_pass</a>.        </p>    </div>    <div class="chapter"><h2 id="ApacheHTTPserverConfiguration" data-toc="proxy_configuration#ApacheHTTPserverConfiguration">Apache HTTP server configuration</h2>        <p id="d9b1a0d2">To ensure support for WebSockets, please use <a href="http://httpd.apache.org/" data-external="true" target="_blank" rel="noopener noreferrer">Apache HTTP Server</a> 2.4.10            or later.        </p>        <p id="b8b5a214">Make sure to enable <code class="code">proxy_wstunnel</code>, <code class="code">proxy_http</code>, <code class="code">rewrite</code> modules (and            optionally <code class="code">headers</code> if you want to use SSL) using the <code class="code">a2enmod</code> script:        </p>        <div class="code-block" data-lang="nginx">
        $ a2enmod headers
        $ a2enmod rewrite
        $ a2enmod proxy_wstunnel
        $ a2enmod proxy_http
        </div>        <p id="ce9868c0">Add the following directives to the <code class="code">VirtualHost</code> section of a relevant <code class="code">.conf</code> file:        </p>        <div class="code-block" data-lang="nginx">
        RewriteEngine on
        AllowEncodedSlashes on

        RewriteCond %{QUERY_STRING} transport=polling
        RewriteRule /(.*)$ http://127.0.0.1:1111/$1 [P]

        ProxyRequests off
        ProxyPass /~socket.io/ ws://127.0.0.1:1111/~socket.io/
        ProxyPassReverse /~socket.io/ ws://127.0.0.1:1111/~socket.io/

        ProxyPass / http://127.0.0.1:1111/
        ProxyPassReverse / http://127.0.0.1:1111/
        </div>        <p id="6d0722be">where <code class="code">1111</code> is the port number you configured Upsource to listen to.        </p>        <p id="dab3979b">If you want to use SSL, additionally add the following directives to the <code class="code">VirtualHost</code> section:        </p>        <div class="code-block" data-lang="nginx">
        RequestHeader set X-Forwarded-Proto "https"
        </div>        <p id="b5bae6db">To speed up Upsource's initial loading, you can instruct Apache to use the <i id="2ada70b3">http2</i> protocol — add            the following directive to the <code class="code">VirtualHost</code> section:        </p>        <div class="code-block" data-lang="nginx">
        Protocols h2 http/1.1
        </div>        <p id="b4d44d8e">Also make sure the module <code class="code">mod_http2</code> is installed and enabled. The <i id="7dc2203d">http2</i> protocol will            work for <i id="e2740009">https</i> connections only. The Apache HTTP version should be 2.4.17 or newer.        </p>        <p id="fa33b33c">            <b id="107a408e">To configure Upsource in a non-root context</b>            (i.e. <code class="code">http://somesite.com/upsource/</code>), use the following example:        </p>        <div class="code-block" data-lang="nginx">
          AllowEncodedSlashes on
          RewriteEngine on
          RewriteCond %{QUERY_STRING} transport=polling
          RewriteRule /(.*)$ http://upsource_machine:1111/upsource/$1 [P]
          ProxyRequests off
          RequestHeader set X-Forwarded-Proto "https"

          &lt;Location /upsource/&gt;
          ProxyPass http://upsource_machine:1111/upsource/
          ProxyPassReverse http://upsource_machine:1111/upsource/
          &lt;/Location&gt;

          &lt;Location /upsource/~socket.io/&gt;
          ProxyPass ws://upsource_machine:1111/upsource/~socket.io/
          ProxyPassReverse ws://upsource_machine:1111/upsource/~socket.io/
          &lt;/Location&gt;
        </div>        <p id="e6660092">where <code class="code">http://somesite.com/upsource/</code> is the Base URL        </p>        <p id="8c72473f">and <code class="code">http://upsource_machine:1111/upsource</code> is the path to your Upsource machine.        </p>    </div>    <div class="chapter"><h2 id="IISreverseProxy" data-toc="proxy_configuration#IISreverseProxy">IIS reverse proxy</h2>        <section class="procedure-steps"><h3 id="870b654e">To use IIS and ARR as a reverse proxy:</h3><ol class="list _decimal"><li class="list__item" id="a5eb5b09"><p>                Install ARR from the <a href="http://www.iis.net/downloads/microsoft/application-request-routing" data-external="true" target="_blank" rel="noopener noreferrer">IIS site</a>.            </p></li><li class="list__item" id="4cd66fa4"><p>                Make sure your IIS server supports WebSockets. <a href="http://www.iis.net/learn/get-started/whats-new-in-iis-8/iis-80-websocket-protocol-support" data-external="true" target="_blank" rel="noopener noreferrer">This IIS instruction</a> explains how to install a WebSockets support module.            </p></li><li class="list__item" id="c2043cc6"><p>                In IIS Manager, connect to the IIS server — in this case, localhost            </p></li><li class="list__item" id="a2f04b88"><p>                Highlight the server in the <span class="control">Connections</span> pane            </p></li><li class="list__item" id="018d44d2"><p>                Double-click                <span class="control">URL Rewrite</span>            </p></li><li class="list__item" id="1a7edbad"><p>                Click <span class="control">View server variables</span> on the right pane            </p></li><li class="list__item" id="7d43eb09"><p>                Add                <div class="code-block" data-lang="nginx">

                    HTTP_X_FORWARDED_HOST
                    HTTP_X_FORWARDED_SCHEME
                    HTTP_X_FORWARDED_PROTO
                </div>                to the list            </p></li><li class="list__item" id="2299f46d"><p>                Highlight the server in the <span class="control">Connections</span> pane.            </p></li><li class="list__item" id="e95b07a1"><p>                Double-click <span class="control">Application Request Routing Cache</span>.            </p></li><li class="list__item" id="da49e5c2"><p>                Click <span class="control">Server Proxy Settings</span> under the Proxy heading in the <span class="control">Actions</span> pane.            </p></li><li class="list__item" id="b27e67ab"><p>                Tick the <span class="control">Enable proxy</span> checkbox and then click <span class="control">Apply</span>. Leave the                default values in place.            </p></li><li class="list__item" id="757a4cba"><p>                Clear the <span class="control">Reverse rewrite host in response headers</span> checkbox and then click <span class="control">                Apply</span>.            </p></li><li class="list__item" id="c056aa06"><p>                In the <span class="control">Connections</span> pane, under <span class="control">Sites</span>, highlight <span class="control">Default                Web Site</span>.            </p></li><li class="list__item" id="6e91a68e"><p>                Double-click the <span class="control">URL Rewrite</span> feature, and click <span class="control">Add Rule(s)…</span> in                the <span class="control">Actions</span> pane.            </p></li><li class="list__item" id="840566bb"><p>                Add a reverse proxy rule, with server name: localhost:1111 (replace with real location and port of your                Upsource service).            </p></li><li class="list__item" id="d41a9ba0">                <p id="ea6b1307">                    Open created rule, check rewrite url, add server variables:                </p>                <ul class="list _ul"><li class="list__item" id="082c33b3"><p>                        set HTTP_X_FORWARDED_HOST to {HTTP_HOST}                    </p></li><li class="list__item" id="087196fa"><p>                        set HTTP_X_FORWARDED_SCHEME to https (if the IIS site is configured to https, else set to http)                    </p></li><li class="list__item" id="685fcfc2"><p>                        set HTTP_X_FORWARDED_PROTO to https (if the IIS site is configured to https, else set to http)                    </p></li></ul>            </li><li class="list__item" id="fc6ea4fb">                <p id="68b217b7">                    Make sure that Anonymous Authentication is enabled:                </p>                <ul class="list _ul"><li class="list__item" id="60ecf3bc"><p>                        In the <span class="control">Connections</span> pane, under <span class="control">Sites</span>, highlight <span class="control">                        Default Web Site</span>.                    </p></li><li class="list__item" id="f94d9570"><p>                        Double click <span class="control">Authentication</span>, Select <span class="control">Anonymous</span>, Click <span class="control">                        Enable                    </span> in the right pane.                    </p></li></ul>            </li><li class="list__item" id="a9d7b002">                <p id="0f156f43">Optional (not required for HTTP only access): if HTTPS access is desired, add a new SSL binding to                    the Default Web Site.                </p>                <ul class="list _ul"><li class="list__item" id="a17a5996"><p>The address that SSL binding listens to (Host URL) should match Upsource base URL.</p></li><li class="list__item" id="e6b4fe1b"><p>The certificate you choose should correspond to the server DNS address.</p></li></ul>            </li><li class="list__item" id="fecc8f98">                <p id="e0806792">Websocket compression is not supported by IIS and should be disabled upon Upsource start-up. When you                    are ready to start Upsource, start it with the following command to disable websocket compression:                </p>                <code class="code">upsource.bat start --J-Dbundle.websocket.compression.enabled=false</code>            </li></ol></section>    </div>    <div class="chapter"><h2 id="ELBreverseProxy" data-toc="proxy_configuration#ELBreverseProxy">AWS Elastic Load Balancer reverse proxy</h2>        <p id="1469e636">To ensure support for WebSockets, please use <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" data-external="true" target="_blank" rel="noopener noreferrer">Application Load Balancer</a> type.        </p>        <section class="procedure-steps"><h3 id="40c989ff">To use Application Load Balancer as a reverse proxy:</h3><p id="72c3add7">                <p id="87acc958">Launch Application Load Balancer creation wizard and follow its steps:</p>                <ol class="list _decimal"><li class="list__item" id="01707e30">                        <p id="548aa4a7">                            <span class="control">Configure Load Balancer</span>: Add HTTPS listener either with the default SSL                            port <span class="control">443</span> or any other port of your choice.                        </p>                    </li><li class="list__item" id="dc2eb3aa">                        <p id="58871181">                            <span class="control">Configure Security Settings</span>: Either request a certificate from AWS or                            upload an existing one.                        </p>                    </li><li class="list__item" id="74d76dc8">                        <p id="931a49dc">                            <span class="control">Configure Security Groups</span>: Select an existing security group which is                            associated with the machine where Upsource is deployed.                        </p>                    </li><li class="list__item" id="8038b5a3">                        <p id="86c924d6">                            <span class="control">Configure Routing</span>: Proceed with the new group creation with HTTP protocol                            and the port that is defined via <code class="code">--listen-port</code> property (port 1111 in our                            example - see below).                        </p>                    </li><li class="list__item" id="166123e2">                        <p id="872ca821">                            <span class="control">Register Targets</span>: Add Upsource instance to the list of <span class="control">                            Registered Targets</span>.                        </p>                    </li></ol>            </p></section>        <p id="26ffe28d">After Application Load Balancer is created, configure Upsource base URL:            <div class="code-block" data-lang="bash">
            &lt;upsource_home&gt;/bin/upsource.sh configure --listen-port 1111 --base-url https://upsource.mydomain.com/
    </div>        </p>        <p id="97155cef">where:</p>        <ul class="list _ul"><li class="list__item" id="8ef02c4b"><p>                <code class="code">1111</code>                is the port number Upsource will listen to and which was specified in Step 4                <span class="control">Configure Routing</span>            </p></li><li class="list__item" id="e8e632cd"><p>                <code class="code">upsource.mydomain.com</code>                is the DNS name of the load balancer, which can be found on the Load Balancer <span class="control">Description            </span> tab.            </p></li></ul>    </div>    <div class="chapter"><h2 id="Limitations" data-toc="proxy_configuration#Limitations">Custom proxy rules limitations</h2>        <p id="1a6e562d">If set up with an <a href="hub.html">external Hub</a> instance, Upsource may require CORS to make certain            calls to Hub. The aforementioned configurations work fine and don't require any further tuning. Additional            custom proxy rules, however, may interfere with CORS, making login to Upsource impossible.        </p>        <p id="d5abef91">The following should be taken into account when external Hub is going to work behind a reverse proxy:</p>        <ol class="list _decimal"><li class="list__item" id="0d1c9e3a">                <p id="c38752e6">Proxy rules should not block CORS-related HTTP headers:</p>                <ul class="list _bullet"><li class="list__item" id="7efee6e0"><p>Access-Control-Request-Method</p></li><li class="list__item" id="ac80dbe1"><p>Access-Control-Request-Headers</p></li><li class="list__item" id="ea492fd5"><p>Access-Control-Allow-Origin</p></li><li class="list__item" id="9f65585d"><p>Access-Control-Allow-Credentials</p></li><li class="list__item" id="fb76aac5"><p>Access-Control-Expose-Headers</p></li><li class="list__item" id="020743fa"><p>Access-Control-Max-Age</p></li><li class="list__item" id="6e05add5"><p>Access-Control-Allow-Methods</p></li><li class="list__item" id="47e97e69"><p>Access-Control-Allow-Headers</p></li></ul>            </li><li class="list__item" id="e4dd2f69"><p>Proxy should allow HTTP OPTIONS requests.</p></li><li class="list__item" id="55b744e3"><p>HTTP OPTIONS requests should not be a subject of proxy-enforced authentication, if any. For example, one                may want to set up certificate-based authentication to comply with enterprise security policy. In that                case authentication check should be skipped if incoming request is of OPTIONS type. OPTIONS requests                cannot return any customer related data by itself, so it's safe to let them in.            </p></li></ol>    </div><div class="last-modified" data-skip-index="skip">Last modified: 9 August 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="in-cloud-installation.html">In-cloud installation</a><a class="navigation-links__next" href="configuration-wizard.html">Things to configure after the first start</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>