<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><meta charset="UTF-8"><title>Setting up Upsource cluster - Help | Upsource</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body data-id="Setting_up_Upsource_cluster"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search Upsource Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>Upsource 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="default" selected>Default (Windows/Linux)</option><option data-group="secondary" value="mac_os_x_10.5_">Default (Mac OS X 10.5+)</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Setting_up_Upsource_cluster" id="Setting_up_Upsource_cluster.xml">Setting up Upsource cluster</h1>    <p id="0dbe01b1">This is a step-by-step instruction on how to install Upsource in a distributed multi-node cluster. The        installation procedure should only be performed once. After it's completed, the services will be managed by a        standard docker-compose tool (or more accurately by <i id="65469a96">cluster.sh</i> — a JetBrains provided        docker-compose wrapper that supports the same command line format for managing cluster services, but has        additional commands for cluster initialization and upgrade).    </p>    <div class="chapter"><h2 id="what-s-included" data-toc="Setting_up_Upsource_cluster#what-s-included">What's included</h2>        <p id="95e1e96f">Upsource cluster consists of the following services:</p>        <div class="table-wrapper"><table class=" no_header" width="100%" id="3aa5a1d8"><tbody><tr id="bae2d4d2" class="ijRowOdd"><td id="4226d6ab">                    <p id="4f9e8644">                        <b id="14d544de">cassandra</b>                    </p>                </td><td id="68271893">                    <p id="89b19019">Manages Cassandra database included with Upsource.</p>                </td></tr><tr id="da2c8916" class="ijRowEven"><td id="5205515f">                    <p id="0dd062b8">                        <b id="2b6bee8a">frontend</b>                    </p>                </td><td id="c6286658">                    <p id="c8935014">Upsource web-based UI.</p>                </td></tr><tr id="e634b0bd" class="ijRowOdd"><td id="bfa1e596">                    <p id="82b4263e">                        <b id="e9521bbc">psi-agent</b>                    </p>                </td><td id="308bcd36">                    <p id="cad1cd71">Provides code model services (code intelligence) based on IntelliJ IDEA.</p>                </td></tr><tr id="58864258" class="ijRowEven"><td id="b40719b2">                    <p id="8bb7a6a6">                        <b id="c4391d01">psi-broker</b>                    </p>                </td><td id="062f8155">                    <p id="fadce428">Manages psi-agent tasks.</p>                </td></tr><tr id="16db8743" class="ijRowOdd"><td id="5baa153a">                    <p id="addd8ccb">                        <b id="79ee8119">analyzer</b>                    </p>                </td><td id="cb94f627">                    <p id="6302d3ff">Imports revisions from VCS to Cassandra database.</p>                </td></tr><tr id="715b8c9e" class="ijRowEven"><td id="2fd9cf50">                    <p id="4bd7fc8d">                        <b id="53519500">opscenter</b>                    </p>                </td><td id="16e4e246">                    <p id="4aa7bf33">Provides cluster monitoring facilities.</p>                </td></tr><tr id="f70c95aa" class="ijRowOdd"><td id="c963170d">                    <p id="8eba3c8b">                        <b id="aec90e16">haproxy</b>                    </p>                </td><td id="8029ad19">                    <p id="c7ec7fa6">Entry point of the distributed Upsource cluster. Proxies all incoming requests to services.</p>                </td></tr><tr id="a1a3265a" class="ijRowEven"><td id="77e057d6">                    <p id="d3d08ef1">                        <b id="54f8d991">file-clustering</b>                    </p>                </td><td id="91a114e9">                    <p id="320854c1">Provides comparative analysis for Upsource "smart" features (suggestions, reminders, etc.) by                        computing file and revision similarity indices.                    </p>                </td></tr></tbody></table></div>        <p id="97f8d68d">The cluster structure is defined by the <i id="e0315079">docker-compose.yml</i> file and is parametrized by the properties            defined in the <i id="0bbdbaaa">upsource.env</i> file. Both files are included in the <i id="cf1088f1">cluster-config</i> artifact (you            can download the latest version from <a href="https://www.jetbrains.com/upsource/download/download-thanks.html?platform=upsourceClusterConfig" data-external="true" target="_blank" rel="noopener noreferrer">here</a>).        </p>        <p id="40399793">Upsource cluster <b id="ed33171c">doesn't include</b>            <a href="https://www.jetbrains.com/hub/" data-external="true" target="_blank" rel="noopener noreferrer">JetBrains Hub</a>        </p>    </div>    <div class="chapter"><h2 id="Prerequisites" data-toc="Setting_up_Upsource_cluster#Prerequisites">Prerequisites</h2>        <ol class="list _decimal"><li class="list__item" id="11f3d6b5"><p>Install <a href="https://www.jetbrains.com/help/hub/Install-and-Configure-Hub.html" data-external="true" target="_blank" rel="noopener noreferrer">JetBrains Hub</a> or                use existing <b id="e36343e2">standalone</b> instance.            </p></li><li class="list__item" id="6ff2ec9b">                <p id="50fbf1c7">Setup Docker Swarm Cluster, including:</p>                <ul class="list _bullet"><li class="list__item" id="e3a0c8fb"><p>swarm manager (master)</p></li><li class="list__item" id="c3b40818"><p>work instances (nodes)</p></li><li class="list__item" id="a3464473"><p>key-value storage (consul)</p></li></ul>                <p id="04d135a1">Refer to <a href="https://docs.docker.com/swarm/install-manual/#/step-2-create-your-instances" data-external="true" target="_blank" rel="noopener noreferrer">this instruction</a> to setup a key-value based swarm cluster.                </p>                <p id="f790ad65">Notes to the instruction above:</p>                <ul class="list _ul"><li class="list__item" id="5119bf48"><p>Install the docker engine of version 1.12 and higher on every swarm node.</p></li><li class="list__item" id="1055278b"><p>Docker engine swarm mode originally introduced in 1.12 is not fully integrated with the                        docker-compose, hence the swarm should be created with the help of swarm docker images.                    </p></li><li class="list__item" id="60d27248"><p>Check that the swarm cluster is operational.</p></li></ul>            </li><li class="list__item" id="13808218">                <p id="c71e20c3">Make sure that time between all cluster nodes, and Hub and Cassandra nodes is synchronized (<a href="https://wiki.archlinux.org/index.php/Systemd/Timers" data-external="true" target="_blank" rel="noopener noreferrer">systemd/Timers</a> may be suggested as one of the ways to synchronize time).                </p>            </li></ol>    </div>    <div class="chapter"><h2 id="ConfigureUpsourceCluster" data-toc="Setting_up_Upsource_cluster#ConfigureUpsourceCluster">Configure Upsource cluster</h2>        <ol class="list _decimal"><li class="list__item" id="70a89fc0">                <p id="68b75f40">Unpack <a href="https://www.jetbrains.com/upsource/download/download-thanks.html?platform=upsourceClusterConfig" data-external="true" target="_blank" rel="noopener noreferrer">cluster-config.zip</a> to a host from which you're going to manage Upsource cluster — we'll be referring to it as                    the <i id="2243d0ae">cluster admin host</i>.                </p>                <p id="c013c77e">You can use any server, not necessarily a swarm manager or a swarm node. Just make sure that once                    you've selected it, the cluster is managed from that admin host only.                </p>            </li><li class="list__item" id="cd50e8d4">                <p id="9f74ea7f">Make sure all of these files are located in the same directory:                </p>                <ul class="list _alpha-lower"><li class="list__item" id="c5929ad7"><p>                        <i id="9bf52fd1">cluster.sh</i>                        a wrapper of the standard docker-compose tool. <i id="e984620a">cluster.sh</i> defines some variables                        substituted in                        <i id="e4d33267">docker-compose.yml</i>                    </p></li><li class="list__item" id="a8e4587e"><p>                        <i id="79de3fd9">docker-compose.yml</i>                        defines Upsource cluster structure.                    </p></li><li class="list__item" id="e64a7946"><p>                        <i id="e896cfcd">upsource.env</i>                        defines properties passed to the upsource services running inside docker containers.                    </p></li><li class="list__item" id="9048b556"><p>                        <i id="95fe3bc1">docker-compose-params.env</i>                        defines parameters used in docker-compose.yml (it is assumed that cluster.sh defines default                        values of the parameters, and docker-compose-params.env overrides defaults if needed depending                        on the environment).                    </p></li><li class="list__item" id="68f7e515"><p>                        <i id="b57eeafe">docker-compose-cluster-init.yml</i>                        defines parameters of the service activated at installation and upgrade.                    </p></li><li class="list__item" id="cdee528b"><p>                        <i id="ab7afb4d">docker-compose-cluster-upgrade.yml</i>                        defines parameters of the service activated at upgrade.                    </p></li></ul>            </li><li class="list__item" id="f03d5487">                <p id="91ae5b9f">The port Upsource cluster listens to is defined by the property UPSOURCE_EXPOSED_PROXY_PORT in <i id="5cbc32e5">                    cluster.sh                </i> and is equal to 8080. This property might be overridden in <i id="59445ac0">docker-compose-params.env</i>.                </p>                <code class="code">UPSOURCE_EXPOSED_PROXY_PORT=&lt;The port number Upsource should listen to&gt;</code>            </li><li class="list__item" id="1e3a6794">                <p id="b75fd057">Define a swarm node on which <i id="74fda7c2">opscenter</i> should be deployed by specifying a value for the                    variable UPSOURCE_OPSCENTER_NODE located in                    <i id="c9f8c1b2">docker-compose-params.env:</i>                </p>                <p id="c1062854">                    <code class="code">UPSOURCE_OPSCENTER_NODE=&lt;opscenter_nodeId&gt;</code>                </p>                <p id="dd919864">where <i id="b6549cd9">opscenter_nodeId</i> is the name of the swarm worker node you're defining.                </p>            </li><li class="list__item" id="937ab6af">                <p id="4d4e1ad4">                    On the node you specified in the previous step (opscenter_nodeId), create a folder for backups and                    give read-write access permissions to the user with ID 13001 (Upsource service runs under the user <i id="8bf6f861">                    jetbrains with ID 13001                </i> inside a container, and will have no access to the mapped volume on the host machine otherwise).                </p>                <p id="320931bc">Although the backups volume is mapped to the folder <i id="a0d0a8b4">/opt/upsource/backups</i> on the host machine                    by default, it can be customized in the docker-compose-params.env by editing the                    UPSOURCE_BACKUPS_PATH_ON_HOST_SYSTEM property. The following commands should be executed on the                    swarm node (opscenter_nodeId) assuming that the property UPSOURCE_BACKUPS_PATH_ON_HOST_SYSTEM was                    not changed (otherwise commands should be run against the overridden backups directory):                </p>                <p id="f957a491">                    <div class="code-block" data-lang="bash">
                        mkdir -p -m 750 /opt/upsource/backups
                        chown 13001:13001 /opt/upsource/backups
    </div>                </p>            </li><li class="list__item" id="152bd267">                <p id="f021e5cb">Define a swarm node on which <i id="b0581abc">haproxy</i> service should be deployed by specifying a value for the                    variable UPSOURCE_PROXY_NODE located in                    <i id="af161111">docker-compose-params.env:</i>                </p>                <p id="809a6a54">                    <code class="code">UPSOURCE_PROXY_NODE=&lt;haproxy_nodeId&gt;</code>                </p>                <p id="a9cb5e62">Where <i id="981e2a9f">haproxy_nodeId</i> is the name of the swarm worker node you're defining.                </p>            </li><li class="list__item" id="486f4c87">                <p id="6c0774f4">Define a swarm node on which <i id="6730052a">cassandra</i> service should be deployed by specifying a value for                    the variable UPSOURCE_CASSANDRA_NODE located in                    <i id="bbe7838f">docker-compose-params.env:</i>                </p>                <p id="4a8bd434">                    <code class="code">UPSOURCE_CASSANDRA_NODE=&lt;cassandra_nodeId&gt;</code>                </p>                <p id="0ba853a4">Where <i id="888f7822">cassandra_nodeId</i> is the name of the swarm worker node you're defining.                </p>            </li><li class="list__item" id="98ead99f">                <p id="2df3c1dc">Define a swarm node on which <i id="f2727631">cluster-init</i> service should be deployed by specifying a value for                    the variable UPSOURCE_CLUSTER-INIT_NODE located in                    <i id="d06043db">docker-compose-params.env:</i>                </p>                <p id="4ee53cfc">                    <code class="code">UPSOURCE_CLUSTER_INIT_NODE=&lt;cluster_init_nodeId&gt;</code>                </p>                <p id="8987a3ad">Where <i id="41afbaef">cluster_init_nodeId</i> is the name of the swarm worker node you're defining.                </p>            </li><li class="list__item" id="70adaae9">                <p id="290bbb52">On all the swarm nodes, pre-create service logs directories and give the user with id 13001                    read-write access to them (Upsource service runs under the user <i id="33a83fb2">jetbrains with ID 13001</i> inside                    a container, and will have no access to the mapped volume on the host machine otherwise):                </p>                <div class="code-block" data-lang="bash">
                    mkdir -p -m 750 /var/log/upsource/psi-agent
                    chown 13001:13001 /var/log/upsource/psi-agent
                    mkdir -p -m 750 /var/log/upsource/psi-broker
                    chown 13001:13001 /var/log/upsource/psi-broker
                    mkdir -p -m 750 /var/log/upsource/analyzer
                    chown 13001:13001 /var/log/upsource/analyzer
                    mkdir -p -m 750 /var/log/upsource/frontend
                    chown 13001:13001 /var/log/upsource/frontend
                    mkdir -p -m 750 /var/log/upsource/opscenter
                    chown 13001:13001 /var/log/upsource/opscenter
                    mkdir -p -m 750 /var/log/upsource/cluster-init
                    chown 13001:13001 /var/log/upsource/cluster-init
                    mkdir -p -m 750 /var/log/upsource/file-clustering
                    chown 13001:13001 /var/log/upsource/file-clustering
    </div>            </li><li class="list__item" id="4372be73">                <p id="965a3b01">Set variables in                    <i id="de496e05">upsource.env</i>                </p>                <ul class="list _alpha-lower"><li class="list__item" id="a9d712db">                        <p id="2ee3c562">Define Hub related properties:                        </p>                        <ol class="list _decimal"><li class="list__item" id="050315d3">                                <p id="5a25c1fc">HUB_URL</p>                                <code class="code">HUB_URL=&lt;URL of external Hub&gt;</code>                            </li><li class="list__item" id="9da2ec12">                                <p id="54d26bbf"><a href="importing-a-hub-certificate-to-upsource.html">Import a Hub certificate to                                    Upsource</a>. Skip this step unless Hub is available through HTTPS via a self-signed                                    certificate or a certificate signed by a private CA.                                </p>                            </li></ol>                    </li><li class="list__item" id="4088f552">                        <p id="f4ab0a23">Add the following line to <i id="879565c9">upsource.env</i>:</p>                        <div class="code-block" data-lang="bash">
                            UPSOURCE_MONITORING_RECORD_HOURS=1
    </div>                    </li><li class="list__item" id="7e4b6efa">                        <p id="f24d5792">Set the property UPSOURCE_URL to the URL the end users will use to access Upsource.</p>                        <div class="code-block" data-lang="bash">
                            UPSOURCE_URL=&lt;URL for end users to access Upsource&gt;
    </div>                        <p id="a3115b16">The default URL Upsource is available at is:                            http://&lt;haproxy_nodeId.address&gt;:${UPSOURCE_EXPOSED_PROXY_PORT}/                        </p>                        <p id="haproxy_nodeId">where haproxy_nodeId is the node to which haproxy service is deployed.                        </p>                        <p id="8fb741cb">Your production environment will most likely be set up behind an SSL-terminating proxy                            (See <a href="proxy-configuration.html">how to configure proxy for Upsource</a>. The only                            difference with cluster is that there is no need to run Upsource configure command, instead                            Upsource cluster base-url is defined as a value of the property UPSOURCE_URL). In this case,                            set proxy address as a value of the variable UPSOURCE_URL.                        </p>                        <p id="0e04ecd6">Let's assume the value of variable UPSOURCE_URL was set to some &lt;upsource.url&gt;. In this                            case you should:                        </p>                    </li><li class="list__item" id="serviceId">                        <p id="483664fe">Create <a href="https://www.jetbrains.com/help/hub/Managing-Services.html" data-external="true" target="_blank" rel="noopener noreferrer">a trusted service in Hub</a> (the page &lt;hub.url&gt;/hub/services) for Upsource cluster (note the service id and                            secret as you will need them <a href="#UpsServeId">in Step e</a> to set in the <i id="24fd83e5">                                upsource.env                            </i> file).                        </p>                        <p id="98258142">This service will be used by all Upsource services in order to communicate with Hub.</p>                        <p id="a9f6ec3d">Add redirect URLs for the created service:</p>                        <ul class="list _ul"><li class="list__item" id="06c0efaf"><p>&lt;upsource.url&gt;</p></li><li class="list__item" id="5605dde5"><p>&lt;upsource.url&gt;/~download</p></li><li class="list__item" id="46d7e599"><p>&lt;upsource.url&gt;/~generatedTree</p></li><li class="list__item" id="79e13e29"><p>&lt;upsource.url&gt;/~oauth/github</p></li><li class="list__item" id="492d3f70"><p>&lt;upsource.url&gt;/~unsubscribe</p></li><li class="list__item" id="faf3adec"><p>&lt;upsource.url&gt;/~uploads</p></li><li class="list__item" id="81735220"><p>&lt;upsource.url&gt;/monitoring</p></li></ul>                        <p id="22f0412f">Set Upsource service home URL to &lt;upsource.url&gt;</p>                    </li><li class="list__item" id="c45fb055">                        <p id="UpsServeId">Set UPSOURCE_SERVICE_ID and UPSOURCE_SERVICE_SECRET to the values defined in <a href="#serviceId">the Hub trusted service you've created</a>:                        </p>                        <div class="code-block" data-lang="bash">
                            UPSOURCE_SERVICE_ID=&lt;Key of the trusted service pre-configured in Hub &gt;
    </div>                        <div class="code-block" data-lang="bash">
                            UPSOURCE_SERVICE_SECRET=&lt;Secret of the trusted service pre-configured in Hub&gt;
    </div>                    </li></ul>            </li></ol>    </div>    <div class="chapter"><h2 id="StartUpsourceCluster" data-toc="Setting_up_Upsource_cluster#StartUpsourceCluster">Start Upsource cluster</h2>        <ol class="list _decimal"><li class="list__item" id="364311c1">                <p id="41fa65f5">Make sure your external Hub is started and available prior to Upsource cluster startup.</p>            </li><li class="list__item" id="87e9edaf">                <p id="e0222cd4">Prepare the Cassandra database:</p>                <div class="code-block" data-lang="bash">
                    ./cluster.sh init-cluster -H tcp://&lt;swarm.master.host&gt;:&lt;swarm.master.port&gt;
    </div>                <p id="53cebac0">This command launches Cassandra, configures its structure, then stops it.</p>            </li><li class="list__item" id="110edc1b">                <p id="a2c1dde2">Check that upsource-cluster-init has started successfully:</p>                <p id="dac6ef6a">The logs of the cluster-init execution are located in the <i id="5ca26d4e">/var/log/upsource/cluster-init</i> directory                    of the node where the container was started. The following command will give a clue on which node                    the cluster-init was executed:                </p>                <div class="code-block" data-lang="bash">
                    docker -H tcp://&lt;swarm.master.host&gt;:&lt;swarm.master.port&gt;
                    ps -a --format "{{.ID}}: {{.Names}} {{.Image}}"
    </div>            </li><li class="list__item" id="4a628f30">                <p id="044cf02d">Make sure the <a href="https://docs.docker.com/compose/install/" data-external="true" target="_blank" rel="noopener noreferrer">docker-compose</a> (version 1.10 or                    higher) is installed on the node where you'd like to manage the cluster from:                </p>                <div class="code-block" data-lang="bash">docker-compose -v</div>            </li><li class="list__item" id="456de564">                <p id="e4d4e2c3">Launch Upsource cluster:</p>                <div class="code-block" data-lang="bash">
                    ./cluster.sh -H tcp://&lt;swarm.master.host&gt;:&lt;swarm.master.port&gt; up
    </div>                <p id="4c0e0380">The <i id="f572cb5f">cluster.sh</i> has the same <a href="https://docs.docker.com/compose/reference/" data-external="true" target="_blank" rel="noopener noreferrer">command line format</a> as docker-compose since <i id="2febeb6c">cluster.sh</i> is simply a wrapper of <i id="7dbecbb7">docker-compose</i>.                </p>            </li></ol>    </div>    <div class="last-modified" data-skip-index="skip">Last modified: 9 August 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="upsource-cluster-hardware-requirements.html">Upsource cluster hardware requirements</a><a class="navigation-links__next" href="importing-a-hub-certificate-to-upsource.html">Importing a Hub certificate to Upsource</a></div><section class="seealso" data-skip-index="skip"><div class="seealso__header"><h2>See Also</h2></div><div class="seealso__content"><div class="seealso__col" data-skip-index="skip"><h3>How tos:</h3><ul class="list"><li class="list__item"><a href="scaling-upsource-services-in-the-cluster.html">Scaling Upsource services in the cluster</a></li></ul></div><div class="seealso__col" data-skip-index="skip"><h3>Reference:</h3><ul class="list"><li class="list__item"><a href="upsource-cluster-hardware-requirements.html">Upsource cluster hardware requirements</a></li></ul></div></div></section></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>