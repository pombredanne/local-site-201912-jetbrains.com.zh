<html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><meta charset="UTF-8"><title>设置上游集群-帮助|帮助上游</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="Setting_up_Upsource_cluster"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索上游帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>上载2019.1帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option value="default" data-group="primary" selected>默认（Windows / Linux）</option><option value="mac_os_x_10.5_" data-group="secondary">默认（Mac OS X 10.5+）</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="Setting_up_Upsource_cluster.xml" data-toc="Setting_up_Upsource_cluster">设置上游集群</h1>    <p id="0dbe01b1">这是有关如何在分布式多节点群集中安装Upsource的分步说明。安装过程仅应执行一次。完成后，服务将由标准的docker-compose工具（或更准确地说，由<i id="65469a96">cluster.sh进行管理）</i> — JetBrains提供的docker-compose包装器，支持相同的命令行格式来管理集群服务，但具有用于集群的其他命令初始化和升级）。</p>    <div class="chapter"><h2 id="what-s-included" data-toc="Setting_up_Upsource_cluster#what-s-included">包含什么</h2>        <p id="95e1e96f">上游集群包含以下服务：</p>        <div class="table-wrapper"><table class=" no_header" width="100%" id="3aa5a1d8"><tbody><tr id="bae2d4d2" class="ijRowOdd"><td id="4226d6ab">                    <p id="4f9e8644">                        <b id="14d544de">卡桑德拉</b>                    </p>                </td><td id="68271893">                    <p id="89b19019">管理Upsource随附的Cassandra数据库。</p>                </td></tr><tr id="da2c8916" class="ijRowEven"><td id="5205515f">                    <p id="0dd062b8">                        <b id="2b6bee8a">前端</b>                    </p>                </td><td id="c6286658">                    <p id="c8935014">基于Web的上游UI。</p>                </td></tr><tr id="e634b0bd" class="ijRowOdd"><td id="bfa1e596">                    <p id="82b4263e">                        <b id="e9521bbc">psi代理</b>                    </p>                </td><td id="308bcd36">                    <p id="cad1cd71">提供基于IntelliJ IDEA的代码模型服务（代码智能）。</p>                </td></tr><tr id="58864258" class="ijRowEven"><td id="b40719b2">                    <p id="8bb7a6a6">                        <b id="c4391d01">经纪人</b>                    </p>                </td><td id="062f8155">                    <p id="fadce428">管理psi代理任务。</p>                </td></tr><tr id="16db8743" class="ijRowOdd"><td id="5baa153a">                    <p id="addd8ccb">                        <b id="79ee8119">分析仪</b>                    </p>                </td><td id="cb94f627">                    <p id="6302d3ff">将修订版从VCS导入到Cassandra数据库。</p>                </td></tr><tr id="715b8c9e" class="ijRowEven"><td id="2fd9cf50">                    <p id="4bd7fc8d">                        <b id="53519500">视心</b>                    </p>                </td><td id="16e4e246">                    <p id="4aa7bf33">提供群集监视功能。</p>                </td></tr><tr id="f70c95aa" class="ijRowOdd"><td id="c963170d">                    <p id="8eba3c8b">                        <b id="aec90e16">hapoxy</b>                    </p>                </td><td id="8029ad19">                    <p id="c7ec7fa6">分布式Upsource群集的入口点。代理对服务的所有传入请求。</p>                </td></tr><tr id="a1a3265a" class="ijRowEven"><td id="77e057d6">                    <p id="d3d08ef1">                        <b id="54f8d991">文件聚类</b>                    </p>                </td><td id="91a114e9">                    <p id="320854c1">通过计算文件和修订相似性索引，提供对上游“智能”功能（建议，提醒等）的比较分析。</p>                </td></tr></tbody></table></div>        <p id="97f8d68d">群集结构由<i id="e0315079">docker-compose.yml</i>文件定义， <i id="0bbdbaaa">并由upsource.env</i>文件中定义的属性参数化。这两个文件都包含在<i id="cf1088f1">cluster-config</i>工件中（您可以从<a href="/upsource/download/download-thanks.html?platform=upsourceClusterConfig" rel="noopener noreferrer" data-external="true" target="_blank">此处</a>下载最新版本）。</p>        <p id="40399793">上游群集<b id="ed33171c">不包括</b> <a href="/hub/" rel="noopener noreferrer" data-external="true" target="_blank">JetBrains Hub</a>        </p>    </div>    <div class="chapter"><h2 id="Prerequisites" data-toc="Setting_up_Upsource_cluster#Prerequisites">先决条件</h2>        <ol class="list _decimal"><li class="list__item" id="11f3d6b5"><p>安装<a href="/help/hub/Install-and-Configure-Hub.html" rel="noopener noreferrer" data-external="true" target="_blank">JetBrains Hub</a>或使用现有的<b id="e36343e2">独立</b>实例。</p></li><li class="list__item" id="6ff2ec9b">                <p id="50fbf1c7">设置Docker Swarm集群，包括：</p>                <ul class="list _bullet"><li class="list__item" id="e3a0c8fb"><p>群经理（大师）</p></li><li class="list__item" id="c3b40818"><p>工作实例（节点）</p></li><li class="list__item" id="a3464473"><p>键值存储（领事）</p></li></ul>                <p id="04d135a1">请参阅<a href="https://docs.docker.com/swarm/install-manual/#/step-2-create-your-instances" rel="noopener noreferrer" data-external="true" target="_blank">此说明</a>来设置基于键值的群集集群。</p>                <p id="f790ad65">以上说明的注意事项：</p>                <ul class="list _ul"><li class="list__item" id="5119bf48"><p>在每个群集节点上安装版本1.12及更高版本的Docker引擎。</p></li><li class="list__item" id="1055278b"><p>最初在1.12中引入的Docker引擎群模式未与docker-compose完全集成，因此应在docker镜像群的帮助下创建该群。</p></li><li class="list__item" id="60d27248"><p>检查群集集群是否可运行。</p></li></ul>            </li><li class="list__item" id="13808218">                <p id="c71e20c3">确保所有群集节点与集线器节点和Cassandra节点之间的时间都已同步（建议使用<a href="https://wiki.archlinux.org/index.php/Systemd/Timers" rel="noopener noreferrer" data-external="true" target="_blank">systemd / Timers</a>作为同步时间的方法之一）。</p>            </li></ol>    </div>    <div class="chapter"><h2 id="ConfigureUpsourceCluster" data-toc="Setting_up_Upsource_cluster#ConfigureUpsourceCluster">配置上游集群</h2>        <ol class="list _decimal"><li class="list__item" id="70a89fc0">                <p id="68b75f40">将<a href="/upsource/download/download-thanks.html?platform=upsourceClusterConfig" rel="noopener noreferrer" data-external="true" target="_blank">cluster-config.zip</a>解压缩到要用于管理Upsource集群的主机上-我们将其称为<i id="2243d0ae">集群管理主机</i> 。</p>                <p id="c013c77e">您可以使用任何服务器，而不必使用群集管理器或群集节点。只要确保选择了它，就只能从该管理主机管理集群。</p>            </li><li class="list__item" id="cd50e8d4">                <p id="9f74ea7f">确保所有这些文件都位于同一目录中：</p>                <ul class="list _alpha-lower"><li class="list__item" id="c5929ad7"><p>                        <i id="9bf52fd1">cluster.sh</i>是标准docker-compose工具的包装器。 <i id="e984620a">cluster.sh</i>定义了一些在<i id="e4d33267">docker-compose.yml中</i>替换的变量                    </p></li><li class="list__item" id="a8e4587e"><p>                        <i id="79de3fd9">docker-compose.yml</i>定义了上游集群结构。</p></li><li class="list__item" id="e64a7946"><p>                        <i id="e896cfcd">upsource.env</i>定义传递给在Docker容器中运行的上游服务的属性。</p></li><li class="list__item" id="9048b556"><p>                        <i id="95fe3bc1">docker-compose-params.env</i>定义了<i id="95fe3bc1">docker-compose.yml中</i>使用的参数（假定cluster.sh定义了这些参数的默认值，而docker-compose-params.env视环境而定会覆盖默认值）。</p></li><li class="list__item" id="68f7e515"><p>                        <i id="b57eeafe">docker-compose-cluster-init.yml</i>定义在安装和升级时激活的服务的参数。</p></li><li class="list__item" id="cdee528b"><p>                        <i id="ab7afb4d">docker-compose-cluster-upgrade.yml</i>定义了在升级时激活的服务的参数。</p></li></ul>            </li><li class="list__item" id="f03d5487">                <p id="91ae5b9f">Upsource集群侦听的端口由<i id="5cbc32e5">cluster.sh中</i>的属性UPSOURCE_EXPOSED_PROXY_PORT定义，等于8080。该属性可能在<i id="59445ac0">docker-compose-params.env中</i>被覆盖。</p>                <code class="code">UPSOURCE_EXPOSED_PROXY_PORT=<The port number Upsource should listen to></code>            </li><li class="list__item" id="1e3a6794">                <p id="b75fd057">通过为位于docker <i id="c9f8c1b2">-compose-params.env中</i>的变量UPSOURCE_OPSCENTER_NODE指定一个值，定义应在其上部署<i id="74fda7c2">opscenter</i>的群体节点<i id="c9f8c1b2">：</i>                </p>                <p id="c1062854">                    <code class="code">UPSOURCE_OPSCENTER_NODE=<opscenter_nodeId></code>                </p>                <p id="dd919864">其中<i id="b6549cd9">opscenter_nodeId</i>是您正在定义的swarm worker节点的名称。</p>            </li><li class="list__item" id="937ab6af">                <p id="4d4e1ad4">在上一步中指定的节点（opscenter_nodeId）上，创建一个备份文件夹，并为ID为13001的用户提供读写访问权限（容器中<i id="8bf6f861">ID为13001</i>的用户<i id="8bf6f861">jetbrains会</i>运行上游服务，并且该服务不会否则，请访问主机上的映射卷。</p>                <p id="320931bc">尽管默认情况下备份卷已映射到主机上的文件夹<i id="a0d0a8b4">/ opt / upsource / backups</i> ，但可以通过编辑UPSOURCE_BACKUPS_PATH_ON_HOST_SYSTEM属性在docker-compose-params.env中对其进行自定义。假设属性UPSOURCE_BACKUPS_PATH_ON_HOST_SYSTEM未被更改，则应在swarm节点（opscenter_nodeId）上执行以下命令（否则，应对覆盖的备份目录运行命令）：</p>                <p id="f957a491">                    </p><div class="code-block" data-lang="bash">mkdir -p -m 750 / opt / upsource / backups chown 13001：13001 / opt / upsource / backups</div>                <p></p>            </li><li class="list__item" id="152bd267">                <p id="f021e5cb">通过为位于docker <i id="af161111">-compose-params.env中</i>的变量UPSOURCE_PROXY_NODE指定一个值，定义应在其上部署<i id="b0581abc">haproxy</i>服务的swarm节点<i id="af161111">：</i>                </p>                <p id="809a6a54">                    <code class="code">UPSOURCE_PROXY_NODE=<haproxy_nodeId></code>                </p>                <p id="a9cb5e62">其中<i id="981e2a9f">haproxy_nodeId</i>是您正在定义的swarm worker节点的名称。</p>            </li><li class="list__item" id="486f4c87">                <p id="6c0774f4">通过为位于docker <i id="bbe7838f">-compose-params.env中</i>的变量UPSOURCE_CASSANDRA_NODE指定一个值，定义应在其上部署<i id="6730052a">cassandra</i>服务的群集节点<i id="bbe7838f">：</i>                </p>                <p id="4a8bd434">                    <code class="code">UPSOURCE_CASSANDRA_NODE=<cassandra_nodeId></code>                </p>                <p id="0ba853a4">其中<i id="888f7822">cassandra_nodeId</i>是您要定义的swarm worker节点的名称。</p>            </li><li class="list__item" id="98ead99f">                <p id="2df3c1dc">通过为位于docker <i id="d06043db">-compose-params.env中</i>的变量UPSOURCE_CLUSTER-INIT_NODE指定一个值，定义应在其上部署<i id="f2727631">集群初始</i>服务的<i id="f2727631">集群</i>节点<i id="d06043db">：</i>                </p>                <p id="4ee53cfc">                    <code class="code">UPSOURCE_CLUSTER_INIT_NODE=<cluster_init_nodeId></code>                </p>                <p id="8987a3ad">其中<i id="41afbaef">cluster_init_nodeId</i>是您正在定义的swarm worker节点的名称。</p>            </li><li class="list__item" id="70adaae9">                <p id="290bbb52">在所有群集节点上，预先创建服务日志目录，并为ID为13001的用户提供对它们的读写访问权限（上载服务在容器内<i id="33a83fb2">ID为13001</i>的用户<i id="33a83fb2">jetbrains</i>下运行，并且将无法访问目录中的映射卷否则为主机）：</p>                <div class="code-block" data-lang="bash">mkdir -p -m 750 / var / log / upsource / psi-agent chown 13001：13001 / var / log / upsource / psi-agent chok 13001：13001 / var / log / upsource / psi-broker mkdir -p -m 750 / var / log / upsource / analyzer chown 13001：13001 / var / log / upsource / analyzer mkdir -p -m 750 / var / log / upsource / frontend chown 13001：13001 / var / log / upsource /前端mkdir -p -m 750 / var / log / upsource / opscenter mkdir -p -m 750 / var / log / upsource / opscenter mkdir -p 750 / var / log / upsource / opscenter / cluster-init chown 13001：13001 / var / log / upsource / cluster-init mkdir -p -m 750 / var / log / upsource / file-clustering chown 13001：13001 / var / log / upsource / file-clustering</div>            </li><li class="list__item" id="4372be73">                <p id="965a3b01">在<i id="de496e05">upsource.env中</i>设置变量                </p>                <ul class="list _alpha-lower"><li class="list__item" id="a9d712db">                        <p id="2ee3c562">定义中心相关的属性：</p>                        <ol class="list _decimal"><li class="list__item" id="050315d3">                                <p id="5a25c1fc">HUB_URL</p>                                <code class="code">HUB_URL=<URL of external Hub></code>                            </li><li class="list__item" id="9da2ec12">                                <p id="54d26bbf"><a href="importing-a-hub-certificate-to-upsource.html">将集线器证书导入到Upsource</a> 。除非通过自签名证书或专用CA签名的证书通过HTTPS可用集线器，否则请跳过此步骤。</p>                            </li></ol>                    </li><li class="list__item" id="4088f552">                        <p id="f4ab0a23"><i id="879565c9">将以下行</i>添加到<i id="879565c9">upsource.env</i> ：</p>                        <div class="code-block" data-lang="bash">UPSOURCE_MONITORING_RECORD_HOURS = 1</div>                    </li><li class="list__item" id="7e4b6efa">                        <p id="f24d5792">将属性UPSOURCE_URL设置为最终用户将用来访问Upsource的URL。</p>                        <div class="code-block" data-lang="bash">UPSOURCE_URL = <url for="" end="" users="" to="" access="" upsource="">
    </url></div>                        <p id="a3115b16">可用的默认URL Upsource是：http：// <haproxy_nodeid.address>：$ {UPSOURCE_EXPOSED_PROXY_PORT} /</haproxy_nodeid.address></p>                        <p id="haproxy_nodeId">其中haproxy_nodeId是将haproxy服务部署到的节点。</p>                        <p id="8fb741cb">您的生产环境很可能将在SSL终止代理后面建立（请参阅<a href="proxy-configuration.html">如何为Upsource配置代理）</a> 。与cluster的唯一区别是不需要运行Upsource configure命令，而是将Upsource cluster base-url定义为属性UPSOURCE_URL的值。在这种情况下，请将代理地址设置为变量UPSOURCE_URL的值。</p>                        <p id="0e04ecd6">假设变量UPSOURCE_URL的值设置为some <upsource.url>。在这种情况下，您应该：</upsource.url></p>                    </li><li class="list__item" id="serviceId">                        <p id="483664fe"><a href="/help/hub/Managing-Services.html" rel="noopener noreferrer" data-external="true" target="_blank">在集线器</a> （页面<hub.url>/ hub / services）中为Upsource群集</hub.url>创建<a href="/help/hub/Managing-Services.html" rel="noopener noreferrer" data-external="true" target="_blank">一个受信任的服务</a> <hub.url>（注意服务ID和密码，因为<a href="#UpsServeId">在步骤e中</a>需要它们才能在<i id="24fd83e5">upsource.env</i>文件中进行设置）。</hub.url></p>                        <p id="98258142">该服务将由所有Upsource服务使用，以便与Hub进行通信。</p>                        <p id="a9f6ec3d">为创建的服务添加重定向URL：</p>                        <ul class="list _ul"><li class="list__item" id="06c0efaf"><p><upsource.url></upsource.url></p></li><li class="list__item" id="5605dde5"><p><upsource.url>/〜下载</upsource.url></p></li><li class="list__item" id="46d7e599"><p><upsource.url>/〜generatedTree</upsource.url></p></li><li class="list__item" id="79e13e29"><p><upsource.url>/〜oauth / github</upsource.url></p></li><li class="list__item" id="492d3f70"><p><upsource.url>/〜退订</upsource.url></p></li><li class="list__item" id="faf3adec"><p><upsource.url>/〜上传</upsource.url></p></li><li class="list__item" id="81735220"><p><upsource.url>/监控</upsource.url></p></li></ul>                        <p id="22f0412f">将Upsource服务的主URL设置为<upsource.url></upsource.url></p>                    </li><li class="list__item" id="c45fb055">                        <p id="UpsServeId">将UPSOURCE_SERVICE_ID和UPSOURCE_SERVICE_SECRET设置为在<a href="#serviceId">您创建的中心受信任服务中</a>定义的值：</p>                        <div class="code-block" data-lang="bash">UPSOURCE_SERVICE_ID = <key of="" the="" trusted="" service="" pre-configured="" in="" hub="">
    </key></div>                        <div class="code-block" data-lang="bash">UPSOURCE_SERVICE_SECRET = <secret of="" the="" trusted="" service="" pre-configured="" in="" hub="">
    </secret></div>                    </li></ul>            </li></ol>    </div>    <div class="chapter"><h2 id="StartUpsourceCluster" data-toc="Setting_up_Upsource_cluster#StartUpsourceCluster">启动上游集群</h2>        <ol class="list _decimal"><li class="list__item" id="364311c1">                <p id="41fa65f5">确保您的外部集线器已启动并且在上游群集启动之前可用。</p>            </li><li class="list__item" id="87e9edaf">                <p id="e0222cd4">准备Cassandra数据库：</p>                <div class="code-block" data-lang="bash">./cluster.sh init-cluster -H tcp：// <swarm.master.host>： <swarm.master.port>
    </swarm.master.port></swarm.master.host></div>                <p id="53cebac0">此命令启动Cassandra，配置其结构，然后停止它。</p>            </li><li class="list__item" id="110edc1b">                <p id="a2c1dde2">检查upsource-cluster-init是否已成功启动：</p>                <p id="dac6ef6a">cluster-init执行的日志位于启动容器的节点的<i id="5ca26d4e">/ var / log / upsource / cluster-init</i>目录中。以下命令将提供线索说明在哪个节点上执行了cluster-init：</p>                <div class="code-block" data-lang="bash">docker -H tcp：// <swarm.master.host>： <swarm.master.port>ps -a --format“ {{。ID}}： {{。名称}} {{。图片}}”</swarm.master.port></swarm.master.host></div>            </li><li class="list__item" id="4a628f30">                <p id="044cf02d">确保将<a href="https://docs.docker.com/compose/install/" rel="noopener noreferrer" data-external="true" target="_blank">docker-compose</a> （版本1.10或更高版本）安装在您要通过以下方式管理集群的节点上：</p>                <div class="code-block" data-lang="bash">码头工人组成-v</div>            </li><li class="list__item" id="456de564">                <p id="e4d4e2c3">启动上游集群：</p>                <div class="code-block" data-lang="bash">./cluster.sh -H tcp：// <swarm.master.host>： <swarm.master.port>向上</swarm.master.port></swarm.master.host></div>                <p id="4c0e0380">该<i id="f572cb5f">cluster.sh</i>具有相同<a href="https://docs.docker.com/compose/reference/" rel="noopener noreferrer" data-external="true" target="_blank">的命令行格式</a>作为搬运工-撰写因为<i id="2febeb6c">cluster.sh</i>是简单地<i id="7dbecbb7">搬运工-撰写</i>的包装。</p>            </li></ol>    </div>    <div class="last-modified" data-skip-index="skip">上次修改时间：2019年8月9日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="upsource-cluster-hardware-requirements.html">上游群集硬件要求</a> <a class="navigation-links__next" href="importing-a-hub-certificate-to-upsource.html">将集线器证书导入到上游</a></div><section class="seealso" data-skip-index="skip"><div class="seealso__header"><h2>也可以看看</h2></div><div class="seealso__content"><div class="seealso__col" data-skip-index="skip"><h3>操作方法：</h3><ul class="list"><li class="list__item"><a href="scaling-upsource-services-in-the-cluster.html">在集群中扩展上游服务</a></li></ul></div><div class="seealso__col" data-skip-index="skip"><h3>参考：</h3><ul class="list"><li class="list__item"><a href="upsource-cluster-hardware-requirements.html">上游集群硬件要求</a></li></ul></div></div></section></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>