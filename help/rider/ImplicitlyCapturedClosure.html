<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>代码检查：隐式捕获闭包-帮助|帮助JetBrains骑士</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="ImplicitlyCapturedClosure" data-breadcrumbs="Reference/ImplicitlyCapturedClosure.xml|Code Inspection: Implicitly captured closure" data-main-title="Code Inspection: Implicitly captured closure" data-article-props="
                {
                
            " seeals=":[=" titl=":=" concept=",=" link=":=" ur=":" finding_code_issues.htm="," tex=":" find="" issues="" with="" inspectio="}=" code_analysis__code_inspections.htm="," code="" inspection="}=" design_time_inspection.htm="," detect="" in="" design="" tim="}=" web="" resource=",=" http:="" ="" www.jetbrains.net="" devnet="" community="" idea="" k="," developer="" communit="}=" data-disqus-id="ImplicitlyCapturedClosure_rdr"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索JetBrains Rider帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>JetBrains Rider 2019.2帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option value="visual_studio" data-group="primary">视觉工作室</option><option value="resharper" data-group="primary">锐化器</option><option value="_default" data-group="primary">默认（IntelliJ IDEA）</option><option value="visual_studio_osx" data-group="secondary">Visual Studio（macOS）</option><option value="resharper_osx" data-group="secondary">ReSharper（macOS）</option><option value="mac_os_x_10.5_" data-group="secondary">Mac OS X 10.5+（IntelliJ IDEA）</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="ImplicitlyCapturedClosure.xml" data-toc="ImplicitlyCapturedClosure">代码检查：隐式捕获闭包</h1>    <a name="tip_disable"></a>        <aside class="prompt" rel="ImplicitlyCapturedClosure.xml" id="9c089c40" data-type="tip" data-title="">            <p id="6538db2e">您可以配置此检查：</p>            <ul class="list _ul"><li class="list__item" id="b933c229"><a href="Code_Analysis__Configuring_Warnings.html#disable">禁用它以忽略所有相关问题</a></li><li class="list__item" id="d26b8309"><a href="Code_Analysis__Configuring_Warnings.html#suppress">在代码中的任何位置都禁止显示它以忽略特定问题</a></li><li class="list__item" id="cf3ada7f"><a href="Code_Analysis__Configuring_Warnings.html#change_severity">更改其严重性级别，以使检测到的问题更少或更明显</a>                </li></ul>        </aside>        <p id="11a00ba2">该检查使您注意以下事实：捕获的封闭值比明显可见的多，这对这些值的寿命有影响。</p>    <p id="f119b07b">考虑以下代码：</p>    <div class="code-block" data-lang="csharp">使用系统；公共类Class1 {private Action _someAction; public void Method（）{var obj1 = new object（）; var obj2 = new object（）; _someAction + =（）=> {控制台。WriteLine（obj1）;安慰。WriteLine（obj2）; }; //“隐式捕获的闭包：obj2” _someAction + =（）=> {控制台。WriteLine（obj1）; }; }}</div>    <p id="7d6d97b2">在第一个闭包中，我们看到<code class="code">obj1</code>和<code class="code">obj2</code>被<span class="emphasis">明确</span>捕获；我们只要看一下代码就可以看到这一点。对于第二个闭合，我们可以看到<code class="code">obj1</code>被<span class="emphasis">明确</span>捕获，但JetBrains Rider警告我们<code class="code">obj2</code>被<span class="emphasis">隐式</span>捕获。</p>    <p id="ebbbb6e2">这是由于C＃编译器中的实现细节。在编译期间，将闭包重写为具有保存捕获的值的字段和表示闭包本身的方法的类。C＃编译器将为每个方法仅创建一个此类私有类，如果在一个方法中定义了多个闭包，则该类将包含多个方法（每个闭包一个），并且还将包括所有闭包中捕获的所有值。</p>    <p id="c4d2a159">如果我们看一下编译器生成的代码，它看起来像这样（一些名称已被清理以方便阅读）：</p>    <div class="code-block" data-lang="csharp">公共类Class1 {[CompilerGenerated]私有密封类<> c__DisplayClass1_0 {公共对象obj1;公共对象obj2;内部无效<method>b__0（）{控制台。WriteLine（obj1）;安慰。WriteLine（obj2）; } internal void <method>b__1（）{控制台。WriteLine（obj1）; }}私有动作_someAction; public void Method（）{//创建显示类-两个闭包都只有一个类var dc = new Class1。<> c__DisplayClass1_0（）; //将闭合值捕获为显示类dc.obj1 = new object（）;上的字段dc.obj2 =新的object（）; //将显示类方法添加为闭包值_someAction + = new Action（ <method>dc。b__0）; _someAction + =新动作（ <method>dc。b__1）; }}</method></method></method></method></div>    <p id="c52ab387">该方法运行时，它将创建显示类，该类捕获所有闭包的所有值。因此，即使其中一个闭包中未使用值，它也将被捕获。这是JetBrains Rider突出显示的“隐式”捕获。</p>    <p id="18e5fc80">这种检查的含义是， <span class="emphasis">直到关闭本身就是垃圾收集，才会</span>隐式捕获封闭值。现在，此值的生存期与未明确使用该值的闭包的生存期相关。如果闭包的寿命很长，那么这可能会对您的代码产生负面影响，尤其是当捕获的值很大时。</p>    <p id="f5d2a8a8">请注意，尽管这是编译器的实现细节，但在各个版本和实现（例如Microsoft（在Roslyn之前和之后）或Mono的编译器）之间是一致的。为了正确处理捕获值类型的多个闭包，实现必须按所述方式工作。例如，如果多个闭包捕获了一个<code class="code">int</code> ，那么它们必须捕获相同的实例，这只能在单个共享的私有嵌套类中发生。这样做的副作用是，所有捕获的值的生存期现在是捕获任何值的任何闭包的最大生存期。</p>    <a name="seealso_inspection_default"></a>            <div class="last-modified" data-skip-index="skip">上次修改时间：2019年11月29日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="RedundantArgumentDefaultValue.html">代码检查：带有默认值的冗余参数</a> <a class="navigation-links__next" href="ArrangeVarKeywordsInDecontructingDeclaration.html">代码检查：在解构声明中联接或分隔“ var”</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>