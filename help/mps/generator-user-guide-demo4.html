<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>Generator User Guide Demo4 - Help | MPS</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body data-id="Generator+User+Guide+Demo4.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.2 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Default</option><option data-group="primary" value="primary_default_for_gnome">Default for GNOME</option><option data-group="primary" value="primary_default_for_kde">Default for KDE</option><option data-group="primary" value="primary_default_for_xwin">Default for XWin</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="primary" value="primary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_jbuilder">JBuilder</option><option data-group="primary" value="primary_mac_os_x">Mac OS X</option><option data-group="primary" value="primary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_default">Default</option><option data-group="secondary" value="secondary_default_for_gnome">Default for GNOME</option><option data-group="secondary" value="secondary_default_for_kde">Default for KDE</option><option data-group="secondary" value="secondary_default_for_xwin">Default for XWin</option><option data-group="secondary" value="secondary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs</option><option data-group="secondary" value="secondary_jbuilder">JBuilder</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="secondary" value="secondary_netbeans">NetBeans</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Generator+User+Guide+Demo4.html" id="generator-user-guide-demo4.xml">Generator User Guide Demo4</h1>   <h2 id="generatoruserguidedemo4">Generator User Guide Demo 4</h2>   <p id="272b4a5e">In this demo, we will further evolve the demoLang3 generator (see <a href="generator-user-guide-demo3.html">Demo 3</a>) and add support for a&nbsp;<i id="170c8863">panel</i> component. Unlike <i id="ebd3585c">buttons</i> or <i id="288c914c">labels</i>, <i id="56efd038">panels</i> can contain other components, including other panels. So we get recursion in the generator. We will see how <b id="8587a6bb">reduction</b> can help to solve problems of this kind.</p>   <h2 id="newlanguage">New Language</h2>   <p id="f6dda078">We'll reuse a great part the demoLang3 generator in demoLang4.</p>   <ul class="list _ul"><li class="list__item" id="ada6a276"><p>create new language 'generator_demo.demoLang4'</p></li><li class="list__item" id="5bae1380"><p>in language properties dialog add <b id="2ad17278">extended languages</b>: 'jetbrains.mps.sampleXML' and 'jetbrains.mps.baseLanguage'</p></li><li class="list__item" id="6f800785"><p>create a new generator for this language if it does not exist (see <a href="generator-user-guide-demo1.html">Demo 1</a> for details)</p></li><li class="list__item" id="b91e557e"><p>delete the (empty) mapping configuration 'main' from the demoLang4 generator (we will copy all needed parts from the demoLang3 generator into the demoLang4 generator)</p></li><li class="list__item" id="a13df43c">         <p id="fe7d47ee">copy-paste <b id="44ffe7ff">all nodes</b> from the demoLang3 generator into demoLang4 generator</p>         <aside class="note " data-title="" rel="fe7d47ee" id="1297f2cc">            <p id="da4c12d2">See <a href="generator-user-guide-demo2.html#new_language">Demo 2</a> for details.</p>         </aside>         <aside class="tip sideblock" data-title="" rel="a13df43c" id="f0ef2cce">            <p id="7577aae8">Doing so you won't be even offered to import the generator model from demoLang3 generator.</p>         </aside>      </li></ul>   <h2 id="templateforpanel">Template for Panel</h2>   <p id="89151f72">In-line with how buttons and labels are generated, we'll create a new template to generate code for panels - <i id="471456c7">insert_Panel</i>.&nbsp;As this template is going to be very similar to, say, <i id="d0c905aa">insert_Label</i>, we will create the new template as a copy of one of the existing ones.</p>   <ul class="list _ul"><li class="list__item" id="8a80f0d0"><p>select (in the tree) the <i id="dba3820a">insert_Label</i>&nbsp;template in the demoLang4 generator and invoke <i id="64ff38d4">Clone Root</i> command in the popup-menu</p></li><li class="list__item" id="d1fe5b13"><p>in the editor - rename the new template: <i id="ebd438af">insert_Label</i> -&gt; <i id="bbe84047">insert_Panel</i>      </p></li><li class="list__item" id="b6446f7e"><p>in the template code - replace JLabel with JPanel</p></li><li class="list__item" id="1d7d9990"><p>remove the 'setText(...)' statement - panels don't support the 'text' property</p></li></ul>   <p id="25ed45e8">      <figure><img alt="Screen Shot 2017 06 27 at 12 50 52 PM" title="Screen Shot 2017 06 27 at 12 50 52 PM" src="/help/img/idea/2019.2/Screen-Shot-2017-06-27-at-12-50-52-PM.png" id="17880ce2" width="593" height="315"></figure>   </p>   <ul class="list _ul"><li class="list__item" id="59268758"><p>in the <i id="b1f4ef53">switch_Element</i>&nbsp;template switch adds an entry for panels:</p></li></ul>   <p id="78cbc40b">      <figure><img alt="gdd2" title="gdd2" src="/help/img/idea/2019.2/gdd2.png" id="0658bccf" width="862" height="445"></figure>   </p>   <ul class="list _ul"><li class="list__item" id="949d730d"><p>re-generate the generator</p></li></ul>   <h2 id="firsttest">First Test</h2>   <p id="ca92765a">Let's create a new test model:</p>   <ul class="list _ul"><li class="list__item" id="26162dde"><p>go to the 'test_models' solution</p></li><li class="list__item" id="20d1ec7f"><p>clone model 'test3' to model 'test4'</p></li><li class="list__item" id="f8654cd9"><p>in the model properties dialog replace 'engaged on generation' language demoLang3 -&gt; demoLang4 (See <a href="generator-user-guide-demo2.html">Demo 2</a> for details)</p></li><li class="list__item" id="2573cc6b"><p>in the model 'test4' add a new document 'Panel' with a root element - 'panel'</p></li><li class="list__item" id="df6485c6"><p>add an attribute: 'background="white"'&nbsp;to the 'panel' element</p></li><li class="list__item" id="e5be2163"><p>add a couple of 'label' elements to the 'panel' element:</p></li></ul>   <p id="debf1ea0">      <figure><img alt="gdd3" title="gdd3" src="/help/img/idea/2019.2/gdd3.png" id="8edef2e3" width="609" height="234"></figure>   </p>   <ul class="list _ul"><li class="list__item" id="06961328"><p>generate files for the 'test4' model</p></li><li class="list__item" id="f2458f62"><p>preview the generated files</p></li></ul>   <p id="a5ee17b9">      <figure><img alt="gddy" title="gddy" src="/help/img/idea/2019.2/gddy.png" id="77377026" width="386" height="629"></figure>   </p>   <p id="a5ece0d5">The generated UI clearly ignores that the 'Hello MPS!' labels should be nested inside the new panel. Instead, they are added to the frame directly.&nbsp;This is because our generator currently does not make any difference between root and non-root elements and simply turns them all into a top-level visual components. For each element in the input model the generator inserts a static method declaration 'createComponent()' into the 'DemoApp' class (which is perfectly okay) and generates a corresponding method call inside the 'addContent()' method in the 'DemoApp' class (which we need to change, since this should only be done for root elements).</p>   <p id="c3f17fe0">The current implementation flattens our component hierarchy (all components are added directly to the application's content pane).</p>   <h2 id="restrictingtheloopmacrotorootelements">Restricting the LOOP macro to root elements</h2>   <p id="c6e4aba1">The first problem to attack is the <i id="6fb2cba1">LOOP</i>&nbsp;macro in the&nbsp;<i id="8c8e3783">DemoApp</i>&nbsp;template, which should only iterate through root elements to generate <i id="6ffe927c">container.add()</i>&nbsp;calls for them. The elements nested inside panels, must not be included in the loop since it should be the containing panels that add them to the UI at some point later.</p>   <p id="b2e43ea2">Let's alter the first <i id="e5c09f97">LOOP</i>&nbsp;macro.&nbsp;Notice also, that the second <i id="ce2b14ff">LOOP</i>&nbsp;macro, which generated static method declarations for each <i id="558cdbfc">Element</i>, remains untouched.<br>       <figure><img alt="gdd6" title="gdd6" src="/help/img/idea/2019.2/gdd6.png" id="aaea13bd" width="740" height="569"></figure>   </p>   <p id="7043d34b">Since we're now looping over&nbsp;<i id="3b73bf1c">Documents</i>, not&nbsp;<i id="0cc897ed">Elements</i>, we need to alter&nbsp;the&nbsp;<i id="9883e7b0">reference macro</i>&nbsp;inside the <i id="c3dc9f97">LOOP</i>.</p>   <p id="c4cc6c97">      <figure><img alt="gdd7" title="gdd7" src="/help/img/idea/2019.2/gdd7.png" id="e6a371d6" width="862" height="302"></figure>      <br>    </p>   <p id="eb63f7e2">If you rebuild the language and see the generated files, you'll notice that we're no longer adding the nested components into the top-most application frame.</p>   <p id="61596767">      <figure><img alt="gdd8" title="gdd8" src="/help/img/idea/2019.2/gdd8.png" id="933e18ed" width="393" height="602"></figure>      <br>However, we're not adding them into the panel, either. So this is what we'll fix now.&nbsp;We will use the <i id="ebcac51a">COPY_SRC</i>-macro for that.</p>   <h2 id="copy_src-macro">COPY_SRC-macro</h2>   <p id="80c11009">      <i id="a8275444">COPY_SRC</i>&nbsp;macros replace the wrapped dummy piece of template code with a node from the input model. If this node has a reduction rule defined, it will be reduced before being added into the output model. In our case, we need panels to have their child <i id="0de15901">Elements</i>&nbsp;correctly added as visual components to the panel's visual representation. If, for example, our concrete <i id="ffe9d66e">Panel</i>&nbsp;get converted into a <i id="705d68d0">JPanel</i>, we need its two child <i id="a9dc48db">Labels</i>&nbsp;to be converted into <i id="5b854b18">JLabels</i>&nbsp;and these <i id="bd89dfac">JLabels</i>&nbsp;need to be added to the <i id="0967ee09">JPanel</i>. The conversion part is already done for all <i id="2753d96f">Elements</i>&nbsp;correctly irrespective of their nesting&nbsp;thanks to the second <i id="ff87a13d">LOOP</i>&nbsp;macro in the <i id="6ad57cf9">DemoApp</i>&nbsp;template. The addition part is only done partially, thought. For the nested <i id="531b399e">Elements</i>, it must be the <i id="68f04818">Panel</i> that&nbsp;adds them.</p>   <ul class="list _ul"><li class="list__item" id="57cab3a1"><p>open <i id="5eb3fae3">insert_Panel</i>      </p></li><li class="list__item" id="229271c3"><p>add code to add <i id="5b1ec924">null</i>&nbsp;to the component</p></li><li class="list__item" id="ae22a9e2"><p>wrap the whole statement (including the; character) with a <i id="f5afd8e8">LOOP</i>&nbsp;macro that iterates over the <i id="7e3ed276">content</i>&nbsp;of the XML&nbsp;<i id="ca642074">Panel</i>      </p></li></ul>   <p id="7b75f44b">      <i id="4d1fb2a1"></i>   </p>   <p id="22c7cf75">      <br>We obviously do not want to add&nbsp;<i id="4cad069a">nulls</i>&nbsp;into the panel, do we?&nbsp;Now, the trick with the <i id="68f051dd">COPY_SRC</i>&nbsp;macro - we'll add the current <i id="7a7ee737">node</i>, which refers to the <i id="65722b72">Panel's</i>&nbsp;child_&nbsp;Element_&nbsp;that we currently iterate over with the <i id="c8e13af2">LOOP</i>&nbsp;macro. The <i id="113800c7">COPY_SRC</i>&nbsp;macro will take care of converting <i id="e8506ac2">Element</i>&nbsp;into a swing component before being added to the <i id="1c969cec">component</i>.</p>   <p id="3c786b8e">      <figure><img alt="Screen Shot 2017 06 27 at 12 55 46 PM" title="Screen Shot 2017 06 27 at 12 55 46 PM" src="/help/img/idea/2019.2/Screen-Shot-2017-06-27-at-12-55-46-PM.png" id="43542a41" width="578" height="478"></figure>   </p>   <p id="e0ce8e7c">&nbsp;</p>   <aside class="tip sideblock" data-title="" rel="e0ce8e7c" id="4302183e">      <p id="59114873">While processing COPY_SRC-macros, MPS creates a copy of the input node (aka mapped node) in output model. The wrapped node in the template code is ignored.</p>      <p id="1107d39d">Well, it may sound really weird - are we going to generate java code where XML element is passed as a parameter in the method call?&nbsp;Of course, we are not, and the trick is that the 'copying' during a generation is not that simple.&nbsp;Whenever the MPS generator performs copying of an input node to output model, it tries to&nbsp;<b id="06563c6f">reduce</b>&nbsp;this node (i.e. find and apply a&nbsp;<b id="058fb4da">reduction rule</b>).</p>   </aside>   <p id="413b48b9">Thus, our input xml element can easily become something else after being 'copied' by the MPS generator.&nbsp;Now we will define what that 'something else' is going to be.</p>   <h2 id="reductionrule">Reduction Rule</h2>   <p id="a100c7ad">Reduction rules define transformations of source-language elements into target-language elements. For example, we want to transform XML <i id="b58d247d">Elements</i>, which represent a&nbsp;<i id="497073f7">Panel's</i>&nbsp;children, into Java swing components that have been created by already generated static factory methods. In our particular case, we want to replace the <i id="60409b08">Panel's</i>&nbsp;children with calls to static methods. Luckily, the static methods to look for have been preserved in the <i id="bed50f2b">method</i>&nbsp;<b id="55596f0c">mapping label</b>, so we can easily get hold of the correct one.</p>   <ul class="list _ul"><li class="list__item" id="d44a19e9"><p>go to the&nbsp;<b id="9649f686">mapping configuration</b> in the demoLang4 generator and create a <i id="9eeb0544">Reduction Rule</i>, which is applicable to <i id="d7c6a3e8">Elements</i>      </p></li><li class="list__item" id="b6df9925"><p>apply the&nbsp;<i id="4e590cca">intention</i>&nbsp;(<i id="6c9c0e57">Alt + Enter</i>) to create a new template for this rule</p></li></ul>   <p id="70faf501">      <figure><img alt="gdd11" title="gdd11" src="/help/img/idea/2019.2/gdd11.png" id="ed00374a" width="632" height="304"></figure>   </p>   <ul class="list _ul"><li class="list__item" id="8b6fc979"><p>open the 'reduce_Element' template in editor (<i id="d6d766e1">Ctrl-click</i> on reference)</p></li></ul>   <p id="295adcc8">      <figure><img alt="gdd12" title="gdd12" src="/help/img/idea/2019.2/gdd12.png" id="229ec0e4" width="428" height="83"></figure>       <figure><img alt="gdd13" title="gdd13" src="/help/img/idea/2019.2/gdd13.png" id="7d778a48" width="265" height="149"></figure>   </p>   <ul class="list _ul"><li class="list__item" id="ca06c994"><p>select <i id="a7ab5054">ClassConcept</i> as the rule content node</p></li><li class="list__item" id="67e17d58"><p>add a static method to this class (name doesn't matter)</p></li><li class="list__item" id="57dfda83"><p>create this method's call expression and make it a <b id="9a6203a4">template fragment</b> (<i id="e7596769">Ctrl-Shift+F</i>):</p></li></ul>   <p id="c0f01eb1">      <figure><img alt="gdd14" title="gdd14" src="/help/img/idea/2019.2/gdd14.png" id="43fee4fa" width="362" height="226"></figure>   </p>   <aside class="note " data-title="" rel="c0f01eb1" id="39d1d352">      <p id="5d797ba5">Make sure that only the method call expression is marked as a template fragment, not the whole statement. The rightmost ';' symbol should be outside the <b id="63dd17bc">template fragment</b>, otherwise, you'd be wrapping a <i id="5169645e">Statement</i>&nbsp;not a <i id="cb45693b">MethodCall</i>.</p>   </aside>   <ul class="list _ul"><li class="list__item" id="2ec73924"><p>add reference-macro for method name in method call expression - we'll retrieve the method declaration from the <i id="fa707704">method</i>&nbsp;<b id="24447f1b">mapping label</b>:</p></li></ul>   <p id="94a96154">      <figure><img alt="gdd15" title="gdd15" src="/help/img/idea/2019.2/gdd15.png" id="f17e8950" width="872" height="381"></figure>   </p>   <h2 id="finaltest">Final Test</h2>   <p id="7f411885">Rebuild the generator and preview generated text for the 'test4' model.</p>   <p id="76bc8ec4">      <figure><img alt="gdd16" title="gdd16" src="/help/img/idea/2019.2/gdd16.png" id="d882ee03" width="411" height="1053"></figure>   </p>   <p id="7f9013b5">This time both labels "Hello" and "MPS!" are correctly added to the content pane. We're done!</p><div class="last-modified" data-skip-index="skip">Last modified: 30 August 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="generator-user-guide-demo3.html">Generator User Guide Demo3</a><a class="navigation-links__next" href="generator-user-guide-demo5.html">Generator User Guide Demo5</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>