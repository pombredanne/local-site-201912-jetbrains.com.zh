<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>Open API - accessing models from code - Help | MPS</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body data-id="Open+API+-+accessing+models+from+code.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.2 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Default</option><option data-group="primary" value="primary_default_for_gnome">Default for GNOME</option><option data-group="primary" value="primary_default_for_kde">Default for KDE</option><option data-group="primary" value="primary_default_for_xwin">Default for XWin</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="primary" value="primary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_jbuilder">JBuilder</option><option data-group="primary" value="primary_mac_os_x">Mac OS X</option><option data-group="primary" value="primary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_default">Default</option><option data-group="secondary" value="secondary_default_for_gnome">Default for GNOME</option><option data-group="secondary" value="secondary_default_for_kde">Default for KDE</option><option data-group="secondary" value="secondary_default_for_xwin">Default for XWin</option><option data-group="secondary" value="secondary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs</option><option data-group="secondary" value="secondary_jbuilder">JBuilder</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="secondary" value="secondary_netbeans">NetBeans</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Open+API+-+accessing+models+from+code.html" id="open-api-accessing-models-from-code.xml">Open API - accessing models from code</h1>   <p id="efe2f5b5">The language repository, project modules, languages and models can be conveniently accessed programmatically through Open API.&nbsp;Open API gives you controlled access to the model and also allows you to provide your own implementations for some aspects, such as persistence.</p>   <p id="28df5901">These two usage types will be discussed individually.</p>   <p id="f389855b">      <i id="9cb49015">Note:&nbsp;This document is meant to provide a general high-level overview of the Open API philosophy and give you useful starting links to the API. For technical details on how to use it please consult&nbsp;</i>      <i id="fd848e5b"></i>      <i id="d2a8b133">.</i>   </p>   <p id="c155ca06">&nbsp;</p>   <aside class="tip sideblock" data-title="" rel="c155ca06" id="3fab8dec">      <p id="86b562d1">For hands-on code examples of using the API please check out&nbsp;<a href="using-model-module-dependencies-faq.html">Using model &amp; module dependencies FAQ</a>      </p>   </aside>   <h2 id="usingopenapi">Using Open API</h2>   <p id="87364340">The API is located under the <i id="96146b83">org.jetbrains.mps.openapi</i>&nbsp;package and is divided into several sub-packages:</p>   <ul class="list _ul"><li class="list__item" id="87c2e382"><p>         <i id="ee09a26e">event</i> - contains event classes for changes to the model</p></li><li class="list__item" id="2d43fcf1"><p>         <i id="a3229558">language</i>&nbsp;- provides a set of interfaces to gain access to compiled languages and inspect their structure</p></li><li class="list__item" id="7316aa30"><p>         <i id="ec3c8ffd">model</i>&nbsp;- gives you ways to inspect and modify the models (ASTs)</p></li><li class="list__item" id="790e6ff5"><p>         <i id="36158336">module</i>&nbsp;- abstracts repositories and modules as means to logically organize models</p></li><li class="list__item" id="cb0f2596"><p>         <i id="b47b763d">persistence</i>&nbsp;- holds the interfaces necessary to extend and customize the persistence mechanism for models</p></li><li class="list__item" id="55534105"><p>         <i id="ea217764">repository</i> - holds listeners to repository-specific events</p></li><li class="list__item" id="99325c7a"><p>         <i id="70692235">util</i>&nbsp;- contains utility classes, such as <i id="e276aff6">ProgressMonitor</i>&nbsp;to hook long-lasting actions to UI progress indicators</p></li></ul>   <p id="d3fe44d7">The API recognizes these logical elements, with the ones above containing the ones below in the list:</p>   <ul class="list _ul"><li class="list__item" id="95e7d073"><p>Repository</p></li><li class="list__item" id="2bb099cf"><p>Module</p></li><li class="list__item" id="720d931a"><p>Model</p></li><li class="list__item" id="2a767a81"><p>Node</p></li><li class="list__item" id="45d1078c"><p>Properties, References</p></li></ul>   <p id="ace9c60d">Open API also recognizes meta-structure, which is orthogonal to the elements above. The meta-structure consists of the following key elements:</p>   <ul class="list _ul"><li class="list__item" id="7ee4cfc9"><p>Language</p></li><li class="list__item" id="ec3dd3d8"><p>Concept, Enumeration</p></li><li class="list__item" id="d5199f59"><p>Members (such as properties, links and enum literals)</p></li></ul>   <p id="bf20ed2f">Each&nbsp;<i id="29b65d5a">node</i>&nbsp;has an associated&nbsp;<i id="08f66955">concept</i>. A concept belongs to a <i id="967050e4">Language</i>.&nbsp;<i id="ed18f8b1">Languages</i> may keep a pointer to the source&nbsp;<i id="563d3e59">module</i>&nbsp;that they originated from to give the language user a way to investigate the language in detail.</p>   <p id="7d07ff38">The API enables you to browse the whole repository and investigate its modules, their models as well as the nodes that these models are built from. Additionally the API has capabilities to search for element's usages or find any element by its name irrespective of its location within the repository.&nbsp;You can also modify all of these elements, save your changes or reload them from a persistent storage. The API will detect colliding modifications to the model in memory and its persistent storage.</p>   <h2 id="someapidetails">Some API details</h2>   <h3 id="meta-modellevel">Meta-model level</h3>   <h4 id="sabstractconcept">SAbstractConcept</h4>   <ul class="list _ul"><li class="list__item" id="25d35f72"><p>a common super-class to both&nbsp;<i id="6e2310b3">SConcept</i>&nbsp;and&nbsp;<i id="8f12d99b">SConceptInterface</i>      </p></li><li class="list__item" id="818c2c99"><p>gives access to concept's <b id="5aff5345">properties</b>, <b id="93c2a47b">&nbsp;containment links</b>&nbsp;and <b id="964b98f5">reference links</b>      </p></li><li class="list__item" id="1732da13"><p>use the <i id="bbb6c6de">getProperties()</i>, <i id="7c6f4caa">getContainmentLinks()</i>&nbsp;and <i id="6b2f60bb">getReferenceLinks()</i>&nbsp;methods to obtain concept's properties, containment and reference links, respectively</p></li></ul>   <h4 id="sproperty">SProperty</h4>   <ul class="list _ul"><li class="list__item" id="076bc1ff"><p>represents a property</p></li></ul>   <h4 id="scontainmentlink">SContainmentLink</h4>   <ul class="list _ul"><li class="list__item" id="0e03b0ee"><p>represents a containment (parent-child) relationship between concepts</p></li></ul>   <h4 id="sreferencelink">SReferenceLink</h4>   <ul class="list _ul"><li class="list__item" id="3a0a14ee"><p>represents an explicit (reference) relationship between concepts</p></li></ul>   <h3 id="modellevel">Model level</h3>   <h4 id="snode">SNode</h4>   <ul class="list _ul"><li class="list__item" id="9ee05660"><p>represents individual nodes in the model</p></li></ul>   <h4 id="sreference">SReference</h4>   <ul class="list _ul"><li class="list__item" id="4019ad4d"><p>represents references between nodes</p></li></ul>   <h4 id="snodereference">SNodeReference</h4>   <ul class="list _ul"><li class="list__item" id="d144dd00"><p>a unique global reference to a node that can be persisted and used repeatedly to obtain a node from a repository</p></li></ul>   <h3 id="openapiusagepatterns">Open API usage patterns</h3>   <h4 id="settingaproperty">Setting a property</h4>   <div class="code-block" data-lang="none">Iterable&lt;SProperty&gt; properties = concept/Shape/.getProperties();&nbsp;
list&lt;SProperty&gt; props = new arraylist&lt;SProperty&gt;(copy: properties);&nbsp;
currentNode/.setProperty(props.findFirst({~it =&gt; it.getName() :eq: "foo"; }), "value");
</div>   <h4 id="addingachild">Adding a child</h4>   <div class="code-block" data-lang="none">Iterable&lt;SContainmentLink&gt; containmentLinks = concept/Shape/.getContainmentLinks();&nbsp;
list&lt;SContainmentLink&gt; containments = new arraylist&lt;SContainmentLink&gt;(copy: containmentLinks);
currentNode/.addChild(containmentLinks.findFirst(...), childNode);
</div>   <h2 id="usingcommands">Using commands</h2>   <p id="6807b9ce">Open API provides means to alter the models, as well.&nbsp;Modifications need to be performed as commands that are passed to the repository for processing.&nbsp;Typical model-changing/editing actions can be un-done/re-done, while actions performing major changes to the module structure cannot.&nbsp;There are three types of changes:</p>   <ol class="list _decimal"><li class="list__item" id="28c5602c"><p>models and nodes can be changed through&nbsp;<b id="d85e39ba">undoable actions</b>      </p></li><li class="list__item" id="85fa0afa"><p>modules, their properties and dependencies can be performed through&nbsp;<b id="b86e5dae">repository commands</b>      </p></li><li class="list__item" id="7592713f"><p>radical changes to the project, such as a VCS update or a complete project reload, need an&nbsp;<b id="63b40fb7">external update action</b>&nbsp;to be performed - no node-level notifications are fired in such cases,&nbsp;only <b id="f5716e8c">model replaced</b> or <b id="23047d23">module changed</b> notifications are triggered.</p></li></ol>   <p id="03e37b7d">The commands depending on their type will have all the necessary read or write permission assigned automatically before they start changing the model. Change notifications are fired to the registered listeners on the node, model, module or repository levels.</p>   <h2 id="concurrentaccess">Concurrent access</h2>   <p id="4a3ccc99">Open API is designed for concurrent access and will correctly handle multiple threads accessing the models through Open API simultaneously, provided the supplied synchronization mechanisms are correctly utilized by the calling code. Open API will reject all improperly synchronized requests and thus preserve the integrity of the models.</p>   <p id="03524791">In a more concrete terms, you need to obtain a read or write action before you start performing your operations, otherwise you'd get exceptions fired from the code.</p>   <p id="cb48781a">Use <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/SRepository.java" data-external="true" target="_blank" rel="noopener noreferrer">SRepository</a>.<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/RepositoryAccess.java" data-external="true" target="_blank" rel="noopener noreferrer">getRepositoryAccess()</a>.applyChanges()&nbsp;to have your changes applied to the whole repository&nbsp;<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/SRepository.java" data-external="true" target="_blank" rel="noopener noreferrer">SRepository</a>.<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/ModelAccess.java" data-external="true" target="_blank" rel="noopener noreferrer">getModelAccess()</a>.runXXXAction()&nbsp;to run a read/write action and <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/SRepository.java" data-external="true" target="_blank" rel="noopener noreferrer">SRepository</a>.<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/module/ModelAccess.java" data-external="true" target="_blank" rel="noopener noreferrer">getModelAccess()</a>.executeCommand()&nbsp;to run a command.&nbsp;Commands get all write permissions automatically and so always gain exclusive access to the repository. Both methods offer an asynchronous variant that runs the supplied action asynchronously in the EDT.</p>   <h3 id="model-lockingexample">Model-locking example</h3>   <p id="b047efae">      <i id="6802827b">SRepository</i>&nbsp;is the right place to start locking the model. You can obtain an <i id="b3068f9b">SRepository</i> reference from context objects, such as <i id="b305cf0e">EditorContext</i>. Your code can than obtain <i id="7f8b568b">ModelAccess</i>&nbsp;and get the lock:</p>   <div class="code-block" data-lang="none">(node, editorContext)-&gt;JComponent {&nbsp;
  //get ModelAccess from the context
  final ModelAccess modelAccess = editorContext.getRepository().getModelAccess();&nbsp;
&nbsp;
  //read the model
  final boolean[] active = new boolean[]{false}; 
  modelAccess.runReadAction(new Runnable() { 
    public void run() { 
      active[0] = node.showActive; 
    } 
  }); 
   
  final JButton button = new JButton(active[0] ? "Show all" : "Show active"); 
  button.addActionListener(new ActionListener() { 
    
    public void actionPerformed(ActionEvent p0) {&nbsp;
      //update the model in an action, that can be undone
      modelAccess.executeCommand(new Runnable() { 
        public void run() { 
          node.showActive = !node.showActive; 
        } 
      }); 
    } 
  }); 
  return button; 
}
&nbsp;</div>   <h2 id="custompersistence">Custom persistence</h2>   <p id="2c9a0ee3">By default MPS stores models as flat files in an XML or binary format. To allow you to&nbsp;customize the way your models are persisted, Open API provides gives you several options.</p>   <h3 id="alternativefileformat">Alternative file format</h3>   <p id="edcbcdd4">Changing the format of model data stored in a flat file is the simplest way to customize model persistence. You simply register your own <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/ModelFactory.java" data-external="true" target="_blank" rel="noopener noreferrer">ModelFactory</a>&nbsp;with the file extension of your choice (through <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/PersistenceFacade.java" data-external="true" target="_blank" rel="noopener noreferrer">PersistenceFacade</a>) and MPS will use that factory to instantiate your custom&nbsp;<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/model/SModel.java" data-external="true" target="_blank" rel="noopener noreferrer">SModel</a>&nbsp;implementations whenever that file extension is discovered. You'll also need to provide and register your own implementations of <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/SModelIdFactory.java" data-external="true" target="_blank" rel="noopener noreferrer">SModelIdFactory</a> and <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/SNodeIdFactory.java" data-external="true" target="_blank" rel="noopener noreferrer">SNodeIdFactory</a>.</p>   <h3 id="alternativestorage">Alternative storage</h3>   <p id="4c8c30ca">If you're more adventurous and want, for example, to load your models from a database or other non-file storage, you need to additionally provide a&nbsp;<a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/ModelRootFactory.java" data-external="true" target="_blank" rel="noopener noreferrer">ModelRootFactory</a>, which can create custom <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/ModelRoot.java" data-external="true" target="_blank" rel="noopener noreferrer">ModelRoot</a> instances. These model roots will then handle all the specifics of your chosen storage in order to load/save models. You may typically also need to bundle UI that would allow the users to configure data source details, such as database location, user name or other.</p>   <aside class="tip sideblock" data-title="" rel="4c8c30ca" id="492c67fe">      <p id="cfa93dda">The <b id="e756b962">xmlPersistence</b> sample project that comes bundled with MPS shows a non-trivial example of implementing custom persistence. Check out the description of the <a href="custom-persistence-cookbook.html">Custom Persistence Cookbook</a> for practical details on how to provide your own persistence to MPS models in MPS as well as IDEA.</p>   </aside>   <h3 id="customfindusageandnavigationparticipants">Custom Find Usage and Navigation participants</h3>   <p id="225b67c9">Providing a custom implementation of <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/FindUsagesParticipant.java" data-external="true" target="_blank" rel="noopener noreferrer">FindUsagesParticipant</a>&nbsp;will allow you to&nbsp;optimize <i id="9accc74d">FindUsages</i>&nbsp;in models using your custom persistence. Similarly, custom implementations of <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/NavigationParticipant.java" data-external="true" target="_blank" rel="noopener noreferrer">NavigationParticipant</a>&nbsp;will have a chance to optimize <b id="8c812ce1">Go To Root/Class/Symbol</b>&nbsp;actions.&nbsp;Instead of letting the default find usages and navigation implementations load all models into memory and process them in a standard way, by providing custom participants to <a href="https://github.com/JetBrains/MPS/blob/master/core/openapi/source/org/jetbrains/mps/openapi/persistence/PersistenceFacade.java" data-external="true" target="_blank" rel="noopener noreferrer">PersistenceFacade</a> you have the option to access the persistent storage directly and thus speed-up search as well as navigation.</p><div class="last-modified" data-skip-index="skip">Last modified: 30 August 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="smodel-query-language.html">SModel Query language</a><a class="navigation-links__next" href="using-model-module-dependencies-faq.html">Using model &amp; module dependencies FAQ</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>