<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>Building an interpreter cookbook - Help | MPS</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body data-id="Building+an+interpreter+cookbook.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.2 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Default</option><option data-group="primary" value="primary_default_for_gnome">Default for GNOME</option><option data-group="primary" value="primary_default_for_kde">Default for KDE</option><option data-group="primary" value="primary_default_for_xwin">Default for XWin</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="primary" value="primary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_jbuilder">JBuilder</option><option data-group="primary" value="primary_mac_os_x">Mac OS X</option><option data-group="primary" value="primary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_default">Default</option><option data-group="secondary" value="secondary_default_for_gnome">Default for GNOME</option><option data-group="secondary" value="secondary_default_for_kde">Default for KDE</option><option data-group="secondary" value="secondary_default_for_xwin">Default for XWin</option><option data-group="secondary" value="secondary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs</option><option data-group="secondary" value="secondary_jbuilder">JBuilder</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="secondary" value="secondary_netbeans">NetBeans</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Building+an+interpreter+cookbook.html" id="building-an-interpreter-cookbook.xml">Building an interpreter cookbook</h1>   <p id="9ca99d1b">Check out the <i id="b5384b97">Shapes</i>&nbsp;sample project, which is bundled with MPS since version 3.1. It can do some fancy tricks in the editor.</p>   <aside class="tip sideblock" data-title="" rel="9ca99d1b" id="4c54188d">      <p id="94e78ced">The sample projects are automatically installed by MPS upon its first run and they should be located in <i id="91e2a3a6">$USER_HOME</i>         <i id="67ee8bfa">/MPSSamples</i>.</p>   </aside>   <p id="47274b50">By default, the editor shows plain code that consists of commands to draw visual shapes of given sizes and colors on a canvas.</p>   <p id="e29f0444">      <figure><img alt="I1" title="I1" src="/help/img/idea/2019.2/I1.png" id="f129c714" width="411" height="117"></figure>   </p>   <p id="c7b88744">The code can be generated into Java and run.&nbsp;This will start a new Java process running the application that just has been generated from the code above:</p>   <p id="c91f54f1">      <figure><img alt="I4" title="I4" src="/help/img/idea/2019.2/I4.png" id="b2bccbc4" width="477" height="548"></figure>   </p>   <p id="12cd66cb">      <figure><img alt="I5" title="I5" src="/help/img/idea/2019.2/I5.png" id="c70a3f49" width="501" height="523"></figure>   </p>   <p id="274151a9">MPS can, however, also interpret the code without generating Java. Just hit <i id="c0ec5ade">Alt + Enter</i>&nbsp;anywhere in the code to invoke the <i id="0c7b06d9">Intentions</i>&nbsp;pop-up menu and choose "Preview Scene".&nbsp;You'll get a new frame containing your scene, which is interpreting the code:</p>   <p id="0ee6ea4f">      <figure><img alt="I6" title="I6" src="/help/img/idea/2019.2/I6.png" id="d301d5e7" width="420" height="147"></figure>   </p>   <p id="122b6e34">      <figure><img alt="I7" title="I7" src="/help/img/idea/2019.2/I7.png" id="50676e08" width="605" height="322"></figure>   </p>   <h2 id="instantpreview">Instant preview</h2>   <p id="bbbfae3b">With the ability to interpret code the editor can now serve the results of the interpreter back to the developer through the editor. It can either interpret individual shapes and draw them in the editor next to the code that defines each of them:</p>   <p id="96c3713a">      <figure><img alt="I2" title="I2" src="/help/img/idea/2019.2/I2.png" id="1084dba7" width="559" height="443"></figure>   </p>   <p id="4e662ecd">Or the whole scene can be drawn next to the code and react instantaneously to the changes made to the code.</p>   <p id="6eb39893">      <figure><img alt="I3" title="I3" src="/help/img/idea/2019.2/I3.png" id="f471ee9f" width="951" height="595"></figure>   </p>   <p id="a9b14f67">To try these capabilities yourself, right-click the editor, pick "Push Editor Hints" and select the hints that will indicate to the editor, which of the preview capabilities you want to enable:</p>   <p id="936651e2">      <figure><img alt="I8" title="I8" src="/help/img/idea/2019.2/I8.png" id="e34fec61" width="482" height="492"></figure>   </p>   <p id="3f432716">      <figure><img alt="I9" title="I9" src="/help/img/idea/2019.2/I9.png" id="aefe011f" width="357" height="386"></figure>      <br> This was a quick teaser, now we can have a look at how to build such simple interpreting capabilities into your language.</p>   <h2 id="defininganinterpreter">Defining an Interpreter</h2>   <p id="9523f07b">MPS is primarily focused on code generation. Programs represented as ASTs get translated into code in a target language, which then may get compiled and run. There are, however, situations when interpreting your code directly may be a better option. You could give the developers some sort of&nbsp;Preview&nbsp;of what the code does and thus providing instant feedback to their code changes. You could&nbsp;detect and report errors that only show at run-time Or you could just want to speed up code-run-fix cycle turnaround by bypassing the generation and compilation phases.</p>   <p id="e85b9cab">MPS does not come with any infrastructure for building interpreters at the moment, but the <i id="0ae881bd">Behavior</i>&nbsp;aspect of your language gives you some power to build interpreters on your own. Ideally, just like with code generators, you would would create a runtime solution holding the&nbsp;interpreter runtime classes. The <i id="c9d9b473">Behavior</i>&nbsp;aspect of your language concepts would then cooperate with the runtime classed to navigate the AST properly and interpret all nodes in the mode.</p>   <p id="cf005431">We'll have a look at how the <i id="54ef736f">Shapes</i>&nbsp;language enabled interpreting its code.</p>   <h3 id="awhole-sceneinterpreter">A whole-scene Interpreter</h3>   <p id="3bfcea79">Let's start with the scenario when the user invokes the interpreter explicitly by an <i id="c50c365e">Intention</i>. First, the intention needs to be created:</p>   <p id="438fb83e">      <figure><img alt="I10" title="I10" src="/help/img/idea/2019.2/I10.png" id="a80e5da6" width="1012" height="293"></figure>   </p>   <p id="e9dc5689">The intention invokes the <i id="b17897cc">interpret()</i>&nbsp;method on the <i id="77a03e6f">Canvas</i>&nbsp;node, which is defined in the <i id="50fb3b49">Behavior</i>&nbsp;aspect of <i id="c276cd33">Canvas</i>.</p>   <p id="edb375f8">      <figure><img alt="I21" title="I21" src="/help/img/idea/2019.2/I21.png" id="7c895dfa" width="553" height="251"></figure>      <br> The method builds a new <i id="515514e4">Frame</i>&nbsp;that will hold a panel with a customized <i id="9816fb2d">paintComponent()</i>&nbsp;method. The panel is being reused by other preview functionality, so it has been extracted into a separate helper class <i id="5005fc95">PreviewFactory</i>. For other than trivial cases the class should be placed into a runtime solution, but here we've just put it directly into the <i id="069a292e">Behavior</i>&nbsp;aspect of the language.</p>   <p id="fd039a05">&nbsp; <figure><img alt="I22" title="I22" src="/help/img/idea/2019.2/I22.png" id="82e68322" width="1137" height="369"></figure>      <br> The current model is traversed with the code: <i id="d318e2f3">thisCanvas.shapes.forEach({~it =&gt; it.drawShape(graphics)});</i>. This is where the interpreting happens. The <i id="23043000">drawShape()</i>&nbsp;method is implemented by each <i id="adb978ca">Shape</i>&nbsp;subconcept so that they can get rendered on the screen. Notice that the traversal code is wrapped inside a <i id="6736d5af">ReadAction</i>&nbsp;to be guaranteed a read permission to the model.</p>   <p id="177a1924">The <i id="22c2706d">drawShape()</i>&nbsp;method has to be implemented by all <i id="0434b80f">Shapes:</i>   </p>   <p id="ec66bfa2">      <figure><img alt="I12" title="I12" src="/help/img/idea/2019.2/I12.png" id="41d5089b" width="861" height="218"></figure>      <br>       <figure><img alt="I13" title="I13" src="/help/img/idea/2019.2/I13.png" id="b2fd0a63" width="879" height="236"></figure>      <br>       <figure><img alt="I14" title="I14" src="/help/img/idea/2019.2/I14.png" id="742a0a4c" width="991" height="228"></figure>   </p>   <p id="18783427">This is enough to get our little interpreter off the ground.</p>   <h3 id="shapepreview">Shape preview</h3>   <p id="73a66892">To preview individual shapes next to their definition in code, we need to change the editor or define a new one with a different <i id="c0e6c8b8">editor hint</i>,&nbsp;so that it holds a <i id="97e040eb">swing component</i>&nbsp;containing the shape's visualization. In the sample we chose to leverage multiple projections (see the <a href="http://www.youtube.com/watch?v=j1iPF2JjzuU" data-external="true" target="_blank" rel="noopener noreferrer">Multiple Projections video</a>&nbsp;to see how multiple projections work in MPS) and thus we created a new editor with the <i id="3ac5af77">ShapePreview</i>&nbsp;hint specified in the header. Only when the user enables the <i id="58a5f4cc">ShapePreview</i>&nbsp;hint, this editor will be used instead of the default text-only one.</p>   <p id="ebb0b006">      <figure><img alt="I16" title="I16" src="/help/img/idea/2019.2/I16.png" id="36a2193e" width="749" height="456"></figure>   </p>   <p id="e5ecea93">The <i id="f3430f55">swing component</i>&nbsp;defines a <i id="bfdb86ba">JPanel</i>, which in the <i id="4374fa2e">paintComponent()</i>&nbsp;method obtains a read lock on the model and then draws the current <i id="ddae62ec">Shape</i>&nbsp;node at a specific location. Notice that a new <i id="e10c6ae3">drawShapeAt()</i>&nbsp;method has been added to <i id="6078e5b7">Shapes</i>&nbsp;to draw the <i id="03617d23">Shapes</i>&nbsp;ignoring their defined position within the canvas.</p>   <p id="18957f5a">      <figure><img alt="I17" title="I17" src="/help/img/idea/2019.2/I17.png" id="58804cd1" width="564" height="318"></figure>   </p>   <h3 id="scenepreview">Scene preview</h3>   <p id="b0f150c7">To preview a whole scene, we'll need to create a new editor for the <i id="c8e96125">Canvas</i>&nbsp;concept and hook it to the <i id="1faffcbe">ScenePreview</i>&nbsp;editor hint.</p>   <p id="de4c2cc4">      <figure><img alt="I23" title="I23" src="/help/img/idea/2019.2/I23.png" id="f0729ba4" width="615" height="353"></figure>   </p>   <p id="c503fd14">The <i id="ed596304">swing component</i>&nbsp;cell contains a customized <i id="aac24067">JPanel</i>, which is again created by the <i id="d31d8994">PreviewFactory</i>&nbsp;class just like when we were interpreting on explicit user request earlier on.</p>   <p id="496f3622">Now, this is it. I hope you liked it.</p><div class="last-modified" data-skip-index="skip">Last modified: 30 August 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="cookbook-type-system.html">Cookbook - Type System</a><a class="navigation-links__next" href="custom-language-aspect-cookbook.html">Custom language aspect cookbook</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>