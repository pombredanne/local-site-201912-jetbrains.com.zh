<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>Scopes - Help | MPS</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body data-id="Scopes.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.2 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Default</option><option data-group="primary" value="primary_default_for_gnome">Default for GNOME</option><option data-group="primary" value="primary_default_for_kde">Default for KDE</option><option data-group="primary" value="primary_default_for_xwin">Default for XWin</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="primary" value="primary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_jbuilder">JBuilder</option><option data-group="primary" value="primary_mac_os_x">Mac OS X</option><option data-group="primary" value="primary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_default">Default</option><option data-group="secondary" value="secondary_default_for_gnome">Default for GNOME</option><option data-group="secondary" value="secondary_default_for_kde">Default for KDE</option><option data-group="secondary" value="secondary_default_for_xwin">Default for XWin</option><option data-group="secondary" value="secondary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs</option><option data-group="secondary" value="secondary_jbuilder">JBuilder</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Mac OS X 10.5+</option><option data-group="secondary" value="secondary_netbeans">NetBeans</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Scopes.html" id="scopes.xml">Scopes</h1>   <p id="5d59adf8">We are going to look at two ways to define scopes for custom language elements - the <i id="a6f53b1d">inherited (hierarchical)</i> and the <i id="d1f02286">referential</i> approaches. We chose the <a href="https://www.jetbrains.com/help/mps/2019.1/mps-calculator-language-tutorial.html" data-external="true" target="_blank" rel="noopener noreferrer">Calculator tutorial</a> language as a testbed for our experiments. You can find the <i id="9c5b92ca">calculator-tutorial</i> project included in the set of sample projects that comes with the MPS distribution.</p>   <h2 id="twoways">Two ways</h2>   <p id="a8524e09">All references need to know the set of allowed targets. This enables MPS to populate the completion menu whenever the user is about to supply a value for the reference. Existing references can be validated against that set and marked as invalid, if they refer to elements out of the scope.   By default, when no scoping is defined for a reference, all targets in the current model as well as in the imported models, are in scope and thus available for the reference.</p>   <p id="2ee191ba">MPS offers two ways to define scopes:</p>   <ul class="list _ul"><li class="list__item" id="6a3f487c"><p>Inherited scopes</p></li><li class="list__item" id="d538dee0"><p>Reference scopes</p></li></ul>   <p id="1e3aec06">Reference scope offers lower ceremony, while Inherited scopes allow the scope to be built gradually following the hierarchy of nodes in the model.&nbsp;</p>   <aside class="tip sideblock" data-title="" rel="1e3aec06" id="7399ac99">      <p id="f26e6e39">The oldest type of scopes in MPS is called&nbsp;<i id="48e5ba3c">Search scope</i>&nbsp;and it has been deprecated in favor of the two types mentioned above, because the scoping API has changed significantly since its introduction.&nbsp;The&nbsp;<i id="ec5aba8b">Reference scope</i>&nbsp;can be viewed as the closest replacement for&nbsp;<i id="ffbf8faf">Search scope</i>&nbsp;compatible with the new API.</p>   </aside>   <h2 id="inheritedscopes">Inherited scopes</h2>   <p id="918dc61c">We will describe the new hierarchical (<i id="6add73cb">inherited</i>) mechanism of scope resolution first. This mechanism delegates scope resolution to the ancestors, who implement <i id="31c7dcdf">ScopeProvider</i>.</p>   <ol class="list _decimal"><li class="list__item" id="28e7b88a"><p>MPS starts looking for the closest ancestor to the reference node that implements <i id="eb089911">ScopeProvider</i>&nbsp;and who can provide scope for the current kind.</p></li><li class="list__item" id="ca42cdf8"><p>If the <i id="4e8ac4d4">ScopeProvider</i>&nbsp;returns <i id="a0963f69">null</i>, MPS continues searching for more distant ancestors.</p></li><li class="list__item" id="568e6679">Each <i id="3efaa412">ScopeProvider</i>&nbsp;can&nbsp;<ul class="list _ul"><li class="list__item" id="ec38626a"><p>build and return a <i id="a1f4a7e3">Scope</i>&nbsp;implementation (more on these later)</p></li><li class="list__item" id="cd7665e0"><p>delegate to the&nbsp;<b id="23862e63">parent scope</b>&nbsp;</p></li><li class="list__item" id="7b21d022"><p>add its own elements to the <b id="a112ad8b">parent scope</b>            </p></li><li class="list__item" id="0a881004"><p>hide elements from <b id="9debcb33">parent scope</b>&nbsp;(more on how to work with scopes will be discussed later)</p></li></ul>      </li></ol>   <p id="c4648192">Call to obtain the <b id="5b11a0b9">parent scope</b> must be made explicitly from within a <i id="20c2234e">ScopeProvider</i>.</p>   <p id="0f28bd6b">Our <i id="2c43b6fe">InputFieldReference</i> thus searches for <i id="2c854b12">InputField</i> nodes and relies on its ancestors to build a list of those.</p>   <p id="7d5ae6f6">      <figure><a class="lightbox" href="/help/img/idea/2019.2/Sc1.png"><img alt="Sc1" title="Sc1" src="/help/img/idea/2019.2/Sc1.png" id="a6935b2f" width="500" height="888"></a></figure>   </p>   <p id="6eef061c">      <figure><a class="lightbox" href="/help/img/idea/2019.2/Sc2.png"><img alt="Sc2" title="Sc2" src="/help/img/idea/2019.2/Sc2.png" id="9714be73" width="300" height="304"></a></figure>   </p>   <p id="61a88db8">Once we have specified that the scope for <i id="ef8aa8bf">InputFieldReference</i> when searching for an <i id="a5d6fe99">InputField</i> is <i id="4bfa5102">inherited</i>, we must indicate that <i id="b9be131c">Calculator</i> is a <i id="98c47751">ScopeProvider</i>. This ensures that <i id="cbb2b6d3">Calculator</i> will have say in building the scope for all <i id="26d36005">InputFieldReferences</i> that are placed as its descendants.</p>   <p id="b6414ff2">      <figure><a class="lightbox" href="/help/img/idea/2019.2/Sc3.png"><img alt="Sc3" title="Sc3" src="/help/img/idea/2019.2/Sc3.png" id="b1fefd4a" width="500" height="778"></a></figure>   </p>   <p id="51074eb0">The <i id="8377e6f2">Calculator</i> in our case should return a list of all its <i id="a2c1abf9">InputFields</i> whenever queried for scope of <i id="014a0020">InputField</i>. So in the <i id="bacc46f8">Behavior</i> aspect of <i id="19868e49">Calculator</i> we override (<i id="8dfddb44">Control + O</i>) the <i id="d3e71257">getScope()</i> method:</p>   <p id="383acfcb">      <figure><a class="lightbox" href="/help/img/idea/2019.2/Co1111.png"><img alt="Co1111" title="Co1111" src="/help/img/idea/2019.2/Co1111.png" id="25c34f93" width="300" height="1160"></a></figure>   </p>   <p id="5c8e5096">If <i id="50a3493b">Scope</i> remains unresolved, we need to import the model (<i id="ab4909fc">Control + R</i>) that contains it (<i id="71765334">jetbrains.mps.scope</i>):</p>   <p id="719b0b54">      <figure><a class="lightbox" href="/help/img/idea/2019.2/Sc5.png"><img alt="Sc5" title="Sc5" src="/help/img/idea/2019.2/Sc5.png" id="6c7b53bb" width="900" height="1212"></a></figure>   </p>   <p id="1c0d5188">The&nbsp;<i id="526908b6">getScope()</i> method takes two parameters:</p>   <ul class="list _ul"><li class="list__item" id="eb79c904"><p>         <b id="a13a6016">kind</b> - the concept of the possible targets for the reference</p></li><li class="list__item" id="921f2481"><p>         <b id="18fbec17">child</b> - the child node of the current (this) ScopeProvider, from which the request came, so the actual reference is among descendants of the&nbsp;<b id="d386c399">child</b> node</p></li></ul>   <p id="3f990dc2">We also need <i id="430d9ceb">BaseLanguage</i> since we need to encode some functionality. The <i id="cec8429d">jetbrains.mps.lang.</i>      <i id="f9a5981b">smodel</i> language needs to be imported in order to query nodes. These languages should have been imported for you automatically. If not, you can import them using the <i id="74ba80a1">Control + L</i> shortcut.<br>       <figure><a class="lightbox" href="/help/img/idea/2019.2/Sc6.png"><img alt="Sc6" title="Sc6" src="/help/img/idea/2019.2/Sc6.png" id="811d3235" width="600" height="1060"></a></figure>   </p>   <p id="0fa1f9c9">Now we can complete the scope definition code, which, in essence, returns all input fields from within the calculator:<br>       <figure><a class="lightbox" href="/help/img/idea/2019.2/Sc8.png"><img alt="Sc8" title="Sc8" src="/help/img/idea/2019.2/Sc8.png" id="365418ba" width="900" height="612"></a></figure>   </p>   <p id="6ec6b024">      <i id="7809ffbc">A quick tip: Notice the use of SimpleRoleScope class. It is one of several helper classes that can help you build your own custom scopes. Check them out by Navigating to SimpleRoleScope (Control + N) and opening up the containing package structure (Alt + F1).</i>   </p>   <h3 id="scopehelperimplementations">Scope helper implementations</h3>   <p id="ea5fd636">MPS comes with several helper <i id="bf0fecc3">Scope</i>&nbsp;implementations that cover many possible scenarios and you can use them to ease the task of defining a scope:</p>   <ul class="list _ul"><li class="list__item" id="07f71304"><p>         <i id="6058cd7b">ListScope</i> - represents the nodes passed into its constructor</p></li><li class="list__item" id="018a2865"><p>         <i id="7c80315a">DelegatingScope</i> - delegates to a Scope instance passed into its constructor, typically to be extended by scopes that need to add functionality around an existing scope, e.g. LazyScope</p></li><li class="list__item" id="695280c3"><p>         <i id="f3f395a8">CompositeScope</i> - delegates to a group of (wrapped) Scope instances</p></li><li class="list__item" id="c0df7a47"><p>         <i id="aca105ae">FilteringScope</i> - delegates to a single Scope instance, filtering its nodes with a predicate (the isExcluded method)</p></li><li class="list__item" id="b67cbb60"><p>         <i id="2c7fe98e">FilteringByNameScope</i> - delegates to a single Scope instance, filtering its nodes by a name blacklist, which it gets as a constructor parameter</p></li><li class="list__item" id="c753abd7"><p>         <i id="c5052b2f">EmptyScope</i> - scope with no nodes</p></li><li class="list__item" id="3876234a"><p>         <i id="b2c41991">SimpleRoleScope</i> - a scope providing all child nodes of a node, which match a given role</p></li><li class="list__item" id="7f69cf54"><p>         <i id="4a321117">ModelsScope</i> - a scope containing all nodes of a given concept contained in the supplied set of models</p></li><li class="list__item" id="e9370ecb"><p>         <i id="24424780">ModelPlusImportedScope</i> - like ModelsScope, but includes all models imported by the given model</p></li></ul>   <p id="d2143b27">For example, the&nbsp;<i id="d82e7553">getScope()</i> method could be rewritten using&nbsp;<i id="0496a85f">ListScope</i> this way:</p>   <p id="d858301b">      <figure><a class="lightbox" href="/help/img/idea/2019.2/Scopex1001.png"><img alt="Scopex1001" title="Scopex1001" src="/help/img/idea/2019.2/Scopex1001.png" id="38b20bd9" width="500" height="347"></a></figure>   </p>   <h3 id="variablereference">VariableReference</h3>   <p id="dfe3f20b">A slightly more advanced example can be found in <i id="13c57857">BaseLanguage. VariableReference</i>&nbsp;uses <i id="0cdf0d02">inherited scope</i>&nbsp;for its <i id="22f0e8ae">variableDeclaration</i>&nbsp;reference.</p>   <p id="a95345c4">      <figure><a class="lightbox" href="/help/img/idea/2019.2/scp1.png"><img alt="scp1" title="scp1" src="/help/img/idea/2019.2/scp1.png" id="ae9d09a0" width="500" height="948"></a></figure>   </p>   <p id="417ca750">Concepts such as <i id="6ccb8e41">ForStatement</i>, <i id="7dee9c3e">LocalVariableDeclaration</i>, <i id="6dcf113c">BaseMethodDeclaration</i>, <i id="eb6cc54a">Classifier</i>&nbsp;as well as some others add variable declarations to the scope and thus implement <i id="68c0ef73">ScopeProvider</i>.<br>       <figure><a class="lightbox" href="/help/img/idea/2019.2/scp2.png"><img alt="scp2" title="scp2" src="/help/img/idea/2019.2/scp2.png" id="90322a57" width="900" height="1058"></a></figure>   </p>   <p id="ff803b6e">For example, <i id="a4a07a43">ForStatement</i>&nbsp;uses the <i id="c4dd12c5">Scopes.forVariables</i>&nbsp;helper function to build a scope that enriches the <b id="aabde3f0">parent scope</b>&nbsp;with all variables declared in the for loop, potentially hiding variables of the same name in the <b id="fd65802a">parent scope</b>. The <b id="4ae4d25b">come from</b>&nbsp;expression detects whether the reference that we're currently resolving the scope for lies in the given&nbsp;part of the sub-tree.</p>   <aside class="tip sideblock" data-title="" rel="ff803b6e" id="4cbccd64">      <ul class="list _ul"><li class="list__item" id="99666df0"><p>The <b id="415f9759">parent scope</b>&nbsp;construct will create an instance of <i id="130900cc">LazyParentScope()</i> and effectively delegate to an ancestor in the model, which implements <i id="a4d9e143">ScopeProvider</i>, to supply the scope.</p></li><li class="list__item" id="2539aa8a"><p>The <b id="6aa3d51e">come from</b>&nbsp;construct will delegate to <i id="4f8df3bc">ScopeUtils.comeFrom()</i>&nbsp;in order to check, whether the scope is being calculated for a direct child of the current node in the given role.</p></li><li class="list__item" id="63fb153e"><p>The <b id="b423bc17">composite with</b>&nbsp;construct (used as <i id="7846d884">composite &lt;expr&gt; with parent scope</i>) will create a combined scope of the supplied scope expression and the parent scope.</p></li></ul>   </aside>   <h2 id="usingreferencescope">Using reference scope</h2>   <p id="15d9a4e6">Scopes can alternatively be implemented in a faster but less scalable way - using the reference scope:<br>       <figure><a class="lightbox" href="/help/img/idea/2019.2/rsc1.png"><img alt="rsc1" title="rsc1" src="/help/img/idea/2019.2/rsc1.png" id="88d1bba6" width="900" height="954"></a></figure>   </p>   <p id="5bb0e539">Instead of delegating to the ancestors of type <i id="97fe073c">ScopeProvider</i> to do the resolution, you can insert the scope resolution code right into the constraint definition.</p>   <aside class="tip sideblock" data-title="" rel="5bb0e539" id="b4a4d53c">      <p id="372aa834">You may need to import (<i id="c7e9c53b">Control/Cmd + R</i>) the <i id="1aaeee85">jetbrains.mps.scope</i> model in order to be able to use <i id="cef2c726">SimpleRoleScope</i>.</p>   </aside>   <p id="bce9fa97">      <br>      <figure><a class="lightbox" href="/help/img/idea/2019.2/rsc2.png"><img alt="rsc2" title="rsc2" src="/help/img/idea/2019.2/rsc2.png" id="0ed5dfca" width="900" height="400"></a></figure>   </p>   <p id="267d15a7">Instead of the code that originally was inside the <i id="fa181f84">Calculator's getScope()</i> method, it is now <i id="afd9500f">InputFieldReference</i> itself that defines the scope. The function for reference scope is supposed to return a <i id="ea53f183">Scope</i> instance, just like the <i id="74961fbb">ScopeProvider.getScope()</i> method.&nbsp;<i id="6a938b99">Scope</i>&nbsp;is essentially a list of potential reference targets together with logic to resolve these targets with textual values.</p>   <p id="2438b76f">To remind you, there are several predefined <i id="b7d42699">Scope</i>&nbsp;implementations and related helper factory methods ready for you to use:</p>   <ul class="list _ul"><li class="list__item" id="74582340"><p>         <i id="726e6107">SimpleRoleScope</i>&nbsp;- simply adds all nodes connected to the supplied node and being in the specified role</p></li><li class="list__item" id="70187c80"><p>         <i id="9c58edd1">ModelPlusImportedScope</i> -&nbsp;provides reference targets from imported&nbsp;models. Allows the user add targets to scope by <i id="20025e93">ctrl + R / cmd + R</i>&nbsp;(import containing model).</p></li><li class="list__item" id="9ae46375"><p>         <i id="47ee39a0">FilteringScope</i>&nbsp;- allow you to&nbsp;exclude some elements from another&nbsp;scope. Subclasses of FilteringScope with override the isExcluded() method.</p></li><li class="list__item" id="b07c1540"><p>         <i id="6c217195">DelegatingScope</i>&nbsp;- delegates to another scope. Meant to be overridden to customize the behavior of the original scope.</p></li></ul>   <p id="d03601df">You may also look around yourself in the <i id="e0c342f6">scope</i>&nbsp;model:<br>       <figure><a class="lightbox" href="/help/img/idea/2019.2/scp3.png"><img alt="scp3" title="scp3" src="/help/img/idea/2019.2/scp3.png" id="4476a284" width="300" height="996"></a></figure>   </p><div class="last-modified" data-skip-index="skip">Last modified: 30 August 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="mps-calculator-language-tutorial.html">MPS Calculator Language Tutorial</a><a class="navigation-links__next" href="description-comments.html">Description comments</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>