<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta name="robots" content="noindex"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><meta charset="UTF-8"><title>Custom language aspect cookbook - Help | MPS</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Custom+language+aspect+cookbook.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Windows/Linux Default</option><option data-group="primary" value="primary_default_for_gnome">GNOME</option><option data-group="primary" value="primary_default_for_kde">KDE</option><option data-group="primary" value="primary_default_for_xwin">XWin</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Default (Mac OS X 10.5+)</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_intellij_idea_classic_os_x">IntelliJ IDEA Classic (Mac OS X)</option><option data-group="secondary" value="secondary_xcode">Xcode</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_resharper">ReSharper</option><option data-group="secondary" value="secondary_resharper_osx">ReSharper (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs (Mac OS X)</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Custom+language+aspect+cookbook.html" id="custom-language-aspect-cookbook.xml">Custom language aspect cookbook</h1>   <p id="3abb0fd1">Alongside the usual language aspects, such as&nbsp;<b id="81661b9f">Structure</b>,&nbsp;<b id="6fe9c051">Editor</b>,&nbsp;<b id="be22b386">Type-system</b>, etc., it is possible for language authors to create custom language aspects (e.g. interpreter, alternative type-system, etc.), have them generated into a language runtime and then use these generated aspects from code.</p>   <aside class="tip sideblock" data-title="" rel="3abb0fd1" id="c4e4c627">      <p id="3f647d36">This document will use the&nbsp;<b id="81c64536">customAspect</b>&nbsp;sample bundled with MPS to teach you how to define custom language aspects. The custom aspect feature is still under development, so some java-stuff that can be seen in this doc will gradually be replaced with a specific DSL constructions.</p>   </aside>   <p id="091baa35">What is a custom aspect?</p>   <p id="4dcde9b5">Language definitions in MPS can be thought of as a collection of&nbsp;<b id="c38a757a">aspects</b>: structure, editor, typesystem, generator.&nbsp;Each of the aspects consists of declarations used by the corresponding <b id="10da1d59">aspect subsystem</b>. For example, the type-system <b id="7c0e6d31">aspect</b> consists of type-system <b id="82cd0e1d">rules</b> and is used by the type-system <b id="b6f4e744">engine</b>.</p>   <p id="757aa0a9">Each aspect of a language is now defined in a separate&nbsp;<b id="99168b90">aspect model</b>. For example, the editor aspect of language L is defined in the <i id="448c77c2">L.editor</i> model.</p>   <p id="c13c9b5e">Each aspect is described using a set of&nbsp;<b id="e74ab2cc">aspect's main languages</b>. E.g. there's the <i id="2a3aa7b6">j.m.lang.editor</i>      <b id="d2c6f20c">&nbsp;</b>language to describe the editor aspect.</p>   <p id="782fc123">Declarations in an aspect model may or may not be bound to some concept (like an editor of the concept is bound to a concept, mapping configuration in the generator aspect is not bound).</p>   <p id="e0043874">The aspect can be generated into a <b id="de0bc879">language's aspect runtime</b>, which represents this aspect at runtime, in other words, when the language is used.</p>   <p id="834153c5">Since version 3.3, MPS allows language authors to define new aspects for its languages.</p>   <h2 id="developmentcycleofcustomaspects">Development cycle of custom aspects</h2>   <ol class="list _decimal"><li class="list__item" id="0af30113"><p>Create a language to describe the aspect - you may reuse existing languages or create ones specific to the needs of the aspect. For example, each of the core MPS aspects uses its own set of languages, plus a few common ones, such as <i id="0fa0156d">BaseLanguage</i> or <i id="89dc7871">smodel</i>.&nbsp;</p></li><li class="list__item" id="8eadc78d"><p>Declare that this language (and maybe some others) describes some aspect of other languages - create an aspect descriptor</p></li><li class="list__item" id="3c8bead6"><p>Develop a generator in the created language to generate aspect's runtime classes (if needed)</p></li><li class="list__item" id="1ceeeb72"><p>Develop the aspect subsystem that uses the aspect's runtime&nbsp;</p></li></ol>   <p id="c571265a">We'll further go through each step in detail.</p>   <h2 id="lookaroundthesampleproject">Look around the sample project</h2>   <p id="04899eca">If you open the&nbsp;<b id="e90ca454">customAspect</b>&nbsp;sample project, you will get five modules.</p>   <p id="7701f107">      <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-04-27-51.png"><img alt="Screen Shot 2015 09 10 at 04 27 51" title="Screen Shot 2015 09 10 at 04 27 51" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-04-27-51.png" id="03cb0c74" width="500" height="474"></a></figure>      <br>The&nbsp;<i id="f450894f">documentation</i>&nbsp;language and its <i id="f5088389">runtime</i> solution are used to define new <b id="a79d4ae4">documentation aspects</b> for any other language,&nbsp;<i id="431afa01">sampleLanguage</i>       <b id="1abcb1c4">utilizes</b> this new aspect - it uses it to document its concepts. The the&nbsp;<i id="728831ae">sandbox</i> solution shows the <i id="e34bfee4">sampleLanguage</i>'s usage to view its documentation ability. The aspect subsystem is represented by the&nbsp;<i id="efb471e9">pluginSolution</i>, which defines an action that shows the documentation for the concept of the currently focused node.</p>   <aside class="tip sideblock" data-title="" rel="7701f107" id="646566e5">      <p id="9d4e6d70">We won't cover creation of the documentation's language concepts as well as creation of sampleLanguage and sandbox solution in this cookbook, since these are core topics covered by all entry-level MPS tutorials. We will only focus on the specifics of creating a new language aspect.&nbsp;</p>   </aside>   <h2 id="languageruntime">Language runtime</h2>   <p id="ff82d820">Before we move on, let's consider for a second how language aspects work at runtime.</p>   <ul class="list _ul"><li class="list__item" id="ffc727a6"><p>For each language in MPS, a language descriptor is generated (the class is called <i id="015988de">Language.java</i>).</p></li><li class="list__item" id="2eeb195a"><p>Given an <b id="6278f82b">aspect interface</b>, the language descriptor returns a <b id="19c10d55">concrete implementation</b> of this aspect in this language (let's call it <i id="078d1c4e">AspectDescriptor</i>).</p></li><li class="list__item" id="a51a4601"><p>The <i id="28fe16af">AspectDescriptor</i> can be&nbsp;any class with any methods, the only restriction is that it should implement a marker interface <i id="f42a8bf6">ILanguageAspect</i>. We suggest that an <i id="73bbc367">AspectDescriptor</i>&nbsp;contains no code except getters for entities described by this aspect.</p></li></ul>   <p id="faae8fe5">This is how a typical language runtime&nbsp;looks like:</p>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-33-07.png"><img alt="Screen Shot 2015 09 10 at 00 33 07" title="Screen Shot 2015 09 10 at 00 33 07" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-33-07.png" id="296ba0cc" width="500" height="206"></a></figure>      <p id="b4b733e3">The&nbsp;<i id="a9d50fe4">createAspect()</i> method checks the type of the parameter expecting one of interfaces declared in aspects and returns a corresponding newly instantiated implementation.</p>   <p id="8f11e333">This is how the interfaces defined in aspects may look like (this example is defined in the <b id="c5fd776d">Intentions</b> aspect):</p>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-30-32.png"><img alt="Screen Shot 2015 09 10 at 00 30 32" title="Screen Shot 2015 09 10 at 00 30 32" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-30-32.png" id="58e057ad" width="500" height="130"></a></figure>      <h3 id="usingthelanguageaspects">Using the language aspects</h3>   <p id="6b5fbfb5">Now, let's suppose we would like to use some of the aspects. E.g. while working with the editor, we'd like to acquire a list of <b id="9c759447">intentions</b>, which could be applied to the currently selected node.</p>   <ol class="list _decimal"><li class="list__item" id="a2e193b5"><p>We first find all the language runtimes corresponding to the languages imported</p></li><li class="list__item" id="f41f17eb"><p>then get the intentions descriptors for each of them</p></li><li class="list__item" id="fc5083b4"><p>and finally get all the intentions from the descriptors and check their for applicability to the current node</p></li></ol>   <p id="d6de76aa">The overall scheme is: <b id="ccb426c6">Languages-&gt;LanguageRuntimes-&gt;Required aspect-&gt;Get what you want from this aspect</b>   </p>   <p id="b113b114">So your custom aspect need to hook into this discovery mechanism so that the callers can get hold of it.</p>   <h2 id="implementingcustomaspect">Implementing custom aspect</h2>   <p id="b1950bb1">Let's look in detail into the steps necessary to implement your custom aspect using the <b id="33c7cb60">customAspect</b> sample project:</p>   <ol class="list _decimal"><li class="list__item" id="53d50ac7"><p>To make MPS treat some special model as a documentation aspect (that is our new custom aspect), an aspect declaration should be created in the documentation language. To do so, we create a plugin aspect in the language and import the <i id="e12f04bf">customAspect</i> language.<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-09-at-23-55-58.png"><img alt="Screen Shot 2015 09 09 at 23 55 58" title="Screen Shot 2015 09 09 at 23 55 58" src="/help/img/idea/2019.1/Screen-Shot-2015-09-09-at-23-55-58.png" id="3b49a9fc" width="300" height="339"></a></figure>      </p></li><li class="list__item" id="ef937632"><p>Create an aspect declaration in the plugin model of the language and fill in its fields. This tells MPS that this language can be used to implement a new custom aspect for other languages.<br>&nbsp;<figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-01-41.png"><img alt="Screen Shot 2015 09 10 at 00 01 41" title="Screen Shot 2015 09 10 at 00 01 41" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-01-41.png" id="c1b7a3d2" width="300" height="647"></a></figure>      </p></li><li class="list__item" id="6657c323"><p>After making/rebuilding the documentation language, it's already possible to create a <b id="6039a361">documentation aspect</b> in the sample language and create a doc concept in it.<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-05-02.png"><img alt="Screen Shot 2015 09 10 at 00 05 02" title="Screen Shot 2015 09 10 at 00 05 02" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-05-02.png" id="0327f7e8" width="300" height="320"></a></figure>      </p></li><li class="list__item" id="f68f36ec">         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-09-41.png"><img alt="Screen Shot 2015 09 10 at 00 09 41" title="Screen Shot 2015 09 10 at 00 09 41" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-09-41.png" id="1bf128ea" width="300" height="365"></a></figure>      </li><li class="list__item" id="e82bd4fb"><p>Now, we should move to the language runtime in order to specify the functionality of the new aspect as it should work inside MPS. In our example, let's create an interface that would be able to retrieve and return the documentation for a chosen concept. To do so, we create a runtime solution,&nbsp;add it as a runtime module of our <i id="15fd8ec9">documentation</i> language and create an <b id="44115b25">interface</b> in it. Note that the runtime class must implement the&nbsp;<i id="f31f5242">ILanguageAspect</i> interface. To satisfy our needs, the method must take a&nbsp;<i id="66fbd9a4">concept</i> as a parameter and return a&nbsp;<i id="4291d8fc">string</i> with the corresponding documentation text.<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-17-23.png"><img alt="Screen Shot 2015 09 10 at 00 17 23" title="Screen Shot 2015 09 10 at 00 17 23" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-00-17-23.png" id="cb6698cf" width="300" height="154"></a></figure>      </p></li><li class="list__item" id="37116942"><p>In the generator for the <i id="ce4d46ac">documentation</i> language we now need to have an implementation of the interface from above generated. A <b id="959c547b">conditional root rule</b> and the following <b id="6cd45378">template</b> will do the trick and generate the documentation descriptor class:<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-10-27-at-17-57-32.png"><img alt="Screen Shot 2015 10 27 at 17 57 32" title="Screen Shot 2015 10 27 at 17 57 32" src="/help/img/idea/2019.1/Screen-Shot-2015-10-27-at-17-57-32.png" id="3c21c2e0" width="300" height="425"></a></figure>         <br>The condition ensures that the rule only triggers for the models of your custom aspect, i.e. in our case models that hold the documentation definitions (<i id="2a434b0b">jetbrains.mps.samples.customAspect.sampleLanguage.documentation</i>).<br>The useful feature here is the <b id="bb583a80">concept switch</b>&nbsp;construction, which allows you to ignore the concept implementation details. It simply loops through all documented concepts (the <b id="4b193322">LOOP</b> macro) and for each such concept creates a matching case (exactly -&gt;$[ConceptDocumentation]) that returns a string value obtained from the associated&nbsp;<i id="fd4aa5af">ConceptDocumentation</i>.</p></li><li class="list__item" id="ff74aaf9"><p>So we have an interface and an implementation class. Now, we need to tie them together - we have to generate the part of the <i id="7262166b">LanguageRuntime</i> class, which will instantiate our concept, i.e. whenever the <b id="bed02384">documentation aspect</b> is required, it will return the <i id="7ce766a4">DocumentationDescriptor</i> class. To understand how the following works, look at how the class <i id="2f529b4f">Language.java</i> is generated (see Language class in model <i id="e9364ada">j.m.lang.descriptor.generator.template.main</i>). The descriptor instantiation is done by a template switch called&nbsp;<i id="d01bbf63">InstantiateAspectDescriptor</i>, which we have to extend in our new aspect language so that it works with one more aspect model:<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-10-27-at-18-00-22.png"><img alt="Screen Shot 2015 10 27 at 18 00 22" title="Screen Shot 2015 10 27 at 18 00 22" src="/help/img/idea/2019.1/Screen-Shot-2015-10-27-at-18-00-22.png" id="82eb6ec5" width="300" height="337"></a></figure>         <br>Essentially, we're adding a check for the&nbsp;<i id="36b4e828">DocumentationAspectDescriptor</i> interface to the generated&nbsp;<i id="57a5da23">Language</i> class and return a fresh instance of the&nbsp;<i id="9dbf58d5">DocumentationDescriptor</i>, if the requested&nbsp;<i id="ab59cce3">aspectClass</i> is our custom aspect interface.</p></li><li class="list__item" id="037e20bb"><p>The only thing left is using our new aspect. For that purpose, an action needs to be created that will show documentation for a concept of a node under cursor on demand:<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/clx202.png"><img alt="clx202" title="clx202" src="/help/img/idea/2019.1/clx202.png" id="f5bdfdd9" width="300" height="1502"></a></figure>         <br>         <br>The <i id="f723bb8e"></i> model must be imported in order to be able to specify the context parameters. The action must be created as part of a (newly created) plugin solution (more on plugin solutions at <a href="plugin.html">Plugin</a>) with a <i id="8b40cf05">StandalonePluginDescriptor</i> and hooked into the menu through an&nbsp;<i id="bd10985b">ActionGroupDeclaration</i>:<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/clx201.png"><img alt="clx201" title="clx201" src="/help/img/idea/2019.1/clx201.png" id="834e4572" width="300" height="160"></a></figure>      </p></li><li class="list__item" id="e2f1cbe0"><p>         <figure><a class="lightbox" href="/help/img/idea/2019.1/clx200.png"><img alt="clx200" title="clx200" src="/help/img/idea/2019.1/clx200.png" id="bc646213" width="300" height="426"></a></figure>         <br>This way the IDE <b id="50759939">Code</b> menu will be enhanced.<br>         <i id="d9246c8e">&nbsp;</i>      </p></li><li class="list__item" id="fee69cb6"><p>Let's now try it out! Rebuild the project, create or open a node of the&nbsp;<i id="db683bf3">DocumentedConcept</i> concept in the&nbsp;<b id="a6071efc">sandbox</b> solution and invoke the&nbsp;<b id="3a346075">Show Documentation</b> action from the&nbsp;<b id="98bcbdd5">Code</b> menu:<br>         <figure><a class="lightbox" href="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-04-22-19.png"><img alt="Screen Shot 2015 09 10 at 04 22 19" title="Screen Shot 2015 09 10 at 04 22 19" src="/help/img/idea/2019.1/Screen-Shot-2015-09-10-at-04-22-19.png" id="dad5ab38" width="300" height="686"></a></figure>      </p></li></ol><div class="last-modified" data-skip-index="skip">Last modified: 5 July 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="building-an-interpreter-cookbook.html">Building an interpreter cookbook</a><a class="navigation-links__next" href="custom-persistence-cookbook.html">Custom Persistence Cookbook</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>