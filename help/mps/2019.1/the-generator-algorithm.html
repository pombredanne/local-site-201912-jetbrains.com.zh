<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta name="robots" content="noindex"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><meta charset="UTF-8"><title>The Generator Algorithm - Help | MPS</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="The+Generator+Algorithm.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Windows/Linux Default</option><option data-group="primary" value="primary_default_for_gnome">GNOME</option><option data-group="primary" value="primary_default_for_kde">KDE</option><option data-group="primary" value="primary_default_for_xwin">XWin</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Default (Mac OS X 10.5+)</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_intellij_idea_classic_os_x">IntelliJ IDEA Classic (Mac OS X)</option><option data-group="secondary" value="secondary_xcode">Xcode</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_resharper">ReSharper</option><option data-group="secondary" value="secondary_resharper_osx">ReSharper (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs (Mac OS X)</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="The+Generator+Algorithm.html" id="the-generator-algorithm.xml">The Generator Algorithm</h1>   <h2 id="thegeneratoralgorithm">The Generator Algorithm</h2>   <p id="cb84ad26">The process of generation of target assets from an input model (generation session) includes 5 stages:</p>   <ul class="list _ul"><li class="list__item" id="e8f5d087"><p>Defining all generators that must be involved</p></li><li class="list__item" id="d2bfecea"><p>Defining the order of priorities of transformations</p></li><li class="list__item" id="1f61090d"><p>Step-by-step model transformation</p></li><li class="list__item" id="c714389f"><p>Generating text and saving it to a file (for each root in output model)</p></li><li class="list__item" id="2a6b9df3"><p>Post-processing assets: compiling, etc.</p></li></ul>   <p id="6d2bd446">We will discuss the first three stages of this process in detail.</p>   <h3 id="definingthegeneratorsinvolved">Defining the Generators Involved</h3>   <p id="c4035797">To define the required generators, MPS examines the input model and determines which languages are used in it. Doing this job MPS doesn't make use of 'Used Languages' specified in the model properties dialog. Instead MPS examines each node in the model and gathers languages that are actually used.</p>   <p id="c8337686">From each 'used language' MPS obtains its generator module. If there are more than one generator module in a language, MPS chooses the first one (multiple generators for the same language are not fully supported in the current version of MPS). If any generator in this list depends on other generators (as specified in the 'depends on generators' property), then those generators are added to the list as well.</p>   <p id="b6919c2a">After MPS obtains the initial list of generators, it begins to scan the generator's templates in order to determine what languages will be used in intermediate (transient) models. The languages detected this way are handled in the same manner as the languages used in the original input model. This procedure is repeated until no more 'used languages' can be detected.</p>   <h4 id="explicitengagement">Explicit Engagement</h4>   <p id="0cc8fcb6">In some rare cases, MPS is unable to detect the language whose generator must be involved in the model transformation. This may happen if that language is not used in the input model or in the template code of other (detected) languages. In this case, you can explicitly specify the generator engagement via the <i id="aad2b49e">Languages Engaged on Generation</i> section in the input model's properties dialog (<i id="ddcae66d">Advanced</i> tab).</p>   <h3 id="dependencyscope/kind-'generationtarget'and'design'.">Dependency scope/kind - 'Generation Target' and 'Design'.</h3>   <p id="59afc3fc">'Generation Target' replaces 'Extends' relation between two languages (L2 extends L1), when one needed to specify that Generator of L2 generates into L1 and thus needs its runtime dependencies. Now, when a language (L2) is translated to another language (L1), and L1 has runtime dependencies, use L1 as 'Generation Target' of L2. Though this approach is much better than 'Extends', it's still not perfect as it's rather an attribute of a generator than of a language. Once Generators become fully independent from their languages, we might need to fix this approach (different generators may target different languages, thus target has to be specified for a generator, not the source language).</p>   <p id="66ac32a0">'Design' dependency replaces 'Extends' between two generators. Use it when you need to reference another generator to specify priority rules (though consider if you indeed need these priorities, see changes in the Generator Plan, below)</p>      <h3 id="definingtheorderofpriorities">Defining the Order of Priorities</h3>   <p id="b3dfdcf2">As we discussed earlier, a generator module contains generator models, and generator models contain mapping configurations. Mapping configuration (<b id="508b8191">mapping</b> for short) is a set of generator rules. It is often required that some mappings must be applied before (or not later than, or together with) some other mappings. The language developer specifies such a relationship between mappings by means of mapping constraints in the generator properties dialog.</p>   <p id="524eab92">After MPS builds the list of involved generators, it divides all mappings into groups, according to the mapping priorities specified. All mappings for which no priority has been specified fall into the last (least-priority) group.</p>   <aside class="tip sideblock" data-title="" rel="524eab92" id="fbda2105">      <p id="1a3bb7e0">You can check the mapping partitioning for any (input) model by selecting <i id="2490f960">Show Generation Plan</i>&nbsp;action in the model's popup menu.<br> The result of partitioning will be shown in the MPS Output View.</p>   </aside>   <h3 id="optimizedgenerationplan">Optimized Generation Plan</h3>   <p id="37eb1de2">When planning the generation phase, MPS prefers to keep every generator as lonely as possible. Eventually, you'll see many relatively small and fast to process generation steps. Of course, the generators forced to run together with priority rules still run at the same step. Handling several unrelated generators at the same generation step (MPS prior to 3.2) proved to be inefficient, since it imposed a lot of unnecessary checking for rule applicability across other generators from the same step. With in-place transformation in 3.2 and later, the performance penalty for each extra generation steps is negligible.</p>   <h3 id="ignoredpriorityrules">Ignored priority rules</h3>   <p id="fbad4260">In addition to conflicting priorities, there are rules that get ignored during the generation plan. This might happen if an input model doesn't have any concept of a language participating in a priority rule. Since there's no actual use of a language, the rule is ignored, and the 'Show Generation Plan' action reports them along with conflicting rules. Previous MPS versions used to include generators of otherwise unused languages into the generation process, now these generators get no chance to jump in.</p>   <h3 id="implicitpriorities">Implicit priorities</h3>   <p id="25fca6ab">Target languages (languages produced by templates) are considered as implicit 'not later than' rules. You don't need to specify these priorities manually. MPS automatically inserts "not later than" rules for all <b id="fd1005a0">generator models</b> in the source and target languages. It is important to understand that priority rules work on the&nbsp;<b id="df38ecd4">model</b> granularity level.</p>   <aside class="tip sideblock" data-title="" rel="25fca6ab" id="dab3c480">      <p id="1d31023b">This implicit priority rule between two <b id="ad922a98">generator models</b> is ignored if an explicit priority rule is defined for these two models, one from the language that generates into the other language and one from the other language.</p>   </aside>   <h3 id="modeltransformation">Model Transformation</h3>   <p id="1cf98119">Each group of mappings is applied in a separate <b id="57f23366">generation step</b>. The entire generation session consists of as many generation steps as there were mapping groups formed during the mapping partitioning. A generation step includes three phases:</p>   <ul class="list _ul"><li class="list__item" id="2f27def5"><p>Executing pre-mapping scripts</p></li><li class="list__item" id="ee950e56"><p>Template-based model transformation</p></li><li class="list__item" id="aa0b9a88"><p>Executing post-mapping scripts</p></li></ul>   <p id="6445e7d2">The template-based model transformation phase consists of one or more micro-steps. A micro-step is a single-pass model transformation of an input model into a transient (output) model.</p>   <p id="6de97bfd">While executing micro-step MPS follows the next procedure:</p>   <ol class="list _decimal"><li class="list__item" id="d3d82306"><p>Apply conditional root rules (only once - on the 1-st micro-step)</p></li><li class="list__item" id="73fcc1c6"><p>Apply root mapping rules</p></li><li class="list__item" id="0dc15ed4"><p>Copy input roots for which no explicit root mapping is specified (this can be overridden by means of the 'keep input root' option in root mapping rules and by the 'abandon root' rules)</p></li><li class="list__item" id="473df700"><p>Apply weaving rules</p></li><li class="list__item" id="7153b254"><p>Apply delayed mappings (from MAP_SRC macro)</p></li><li class="list__item" id="3ef2eb0a"><p>Revalidate references in the output model (all reference-macro are executed here)</p></li></ol>   <p id="18ba4953">There is no separate stage for the application of reduction and pattern rules. Instead, every time MPS copies an input node into the output model, it attempts to find an applicable reduction (or pattern) rule. MPS performs the node copying when it is either copying a root node or executing a COPY_SRC-macro. Therefore, the reduction can occur at either stage of the model transformation.</p>   <p id="4cc4075d">MPS uses the same rule set (mapping group) for all micro-steps within the generation step. After a micro-step is completed and some transformations have taken place during its execution, MPS starts the next micro-step and passes the output model of the previous micro-step as input to the next micro-step. The whole generation step is considered completed if no transformations have occurred during the execution of the last micro-step, that is, when there are no more rules in the current rule set that are applicable to nodes in the current input model.</p>   <p id="1d9503d0">The next generation step (if any) will receive the output model of previous generation step as its input.</p>   <aside class="tip sideblock" data-title="" rel="1d9503d0" id="27694259">      <p id="ccc57a60">Intermediate models (transient models) that are the output/input of generation steps and micro-steps are normally destroyed immediately after their transformation to the next model is completed.<br> To keep transient models, enable the following option:<br>          <i id="a4c35499">Settings</i> -&gt; <i id="e35834b7">Generator Settings</i> -&gt; <b id="4cd4e657">Save transient models on generation</b>      </p>      <p id="529efd55">See also:</p>      <ul class="list _ul"><li class="list__item" id="ad9984e2">            <a href="generator-user-guide-demo6.html#savingtransientmodels">Saving Transient Models</a>         </li><li class="list__item" id="e58884a6">            <a href="generator-user-guide-demo6.html#usinggenerationtracertool">Using Generation Tracer Tool</a>         </li></ul>   </aside>   <h3 id="handlingofnodeattributesduringgeneration">Handling of node attributes during generation</h3>   <p id="b46a6fab">Node attributes constitute generic extension mechanism, thus Generator shall preserve attributes along the transformation process (unless attribute designer opts not to keep them) without explicit support in any template. When an input node is transformed to another node, Generator&nbsp;copies attributes of the input node to the output. Copy is controlled by newly introduced <b id="6ebb6b2e">drop attribute rule</b> only, and happens regardless of <b id="3df7e555">@attribute info</b>&nbsp;specification (i.e. its&nbsp;<b id="d844a2a3">attributed concept</b>&nbsp;or <b id="f8d7e7ce">multiple</b> restrictions). The fact that transformation rule may have produced attribute node itself is not taken into account (i.e. if a reduction rule explicitly copies node attributes to a newly created output node, the attributes would get duplicated due to automatic copy of attributes. However, it's rare for a reduction rule to copy node attributes, and the issue, if ever shows up, is easy to mitigate with drop rules).</p>   <p id="a7f15655">While copying attributes of a node, Generator consults <b id="b2c60aec">drop attribute rules </b>(newly introduced in MPS 3.3, reside next to <b id="6e03d35c">abandon root&nbsp;rules</b>) to see if language designer don't need these attributes to survive transformation process. This rules are quite similar to <b id="e67561e4">abandon root rules</b>&nbsp;- when any rule is triggered, attribute is not copied into output model.</p>   <p id="6e2f5ec8">With the growing adoption of attributes and their increasing complexity, we enabled the generator to transform the attribute contents using the regular template processing rules:</p>   <ul class="list _ul"><li class="list__item" id="9e8c7611"><p>references to nodes in the same model get updated to point to the respective nodes in the output model</p></li><li class="list__item" id="3c769889"><p>reduction rules are applied in order to transform children of the attribute node.</p></li></ul>   <h3 id="in-placetransformation">In-place transformation</h3>   <p id="c3e804a0">Generators for languages employed in a model are applied sequentially (aka&nbsp;<i id="fce8a4b6">Generation Plan</i>). Effectively, each generation step modifies just a fraction of original model, and the rest of the model is copied as-is. With huge models and numerous generation steps this approach proves to be quite ineffective. In-place transformation tries to address this with a well-known 'delta' approach, where changes only are collected and applied to original model to alter it in-place.</p>   <p id="b67d6c77">In version 3.1 in-place transformation is left as an option, enabled by default and configurable through the <i id="c6bc758d">Project settings -&gt; Generator</i>. Clients are encouraged to fix their templates that fail in the in-place mode, as in-place generation is likely to become the only generation mode later down the road.</p>   <p id="862153ed">Use of in-place transformation brings certain limitations or might even break patterns that used to work in the previous MPS versions:</p>   <ul class="list _ul"><li class="list__item" id="6630ba22"><p>Most notable and important - there's no output model at the moment when rule's queries/conditions are executed. To consult the output model during the transformation process is a bad practice, and in-place transformation enforces removing it. Access to the output model from a transformation rule implies certain order of execution, thus effectively limiting the set of optimizations applicable&nbsp;by the&nbsp;MPS generator. The contract of a transformation rule, with a&nbsp;<i id="e8e5e367">complete</i>&nbsp;input and a&nbsp;<i id="d2e0d816">fraction</i>&nbsp;of the output that this particular rule is responsible for, is more rigorous than "a complete input model" and "an output model in some uncertain state".</p></li><li class="list__item" id="bb67e4c1"><p>The output model is indeed there for weaving rules, as their purpose is to deal with output nodes.</p></li><li class="list__item" id="2cb362b7"><p>The process of delta building requires the generator to know about the nodes being added to the model. Thus, any&nbsp;<i id="4fc44e58">implicit</i>&nbsp;changes in the output model that used to work would fail with in-place generation enabled. As an example, consider&nbsp;<b id="5b08d792">            <i id="0ecac565">MAP-SRC</i>         </b>&nbsp;with a post-process function, which replaces the node with a new one:<code class="code">postprocess: if (node.someCondition()) node.replace with new(AnotherNode);</code>. Generator records a new node produced by MAP-SRC, schedules it for addition, and delays post-processing. Once post-processing is over, there's no way for the generator to figure out the node it tracks as 'addition to output model' is no longer valid and there's another node which should be used instead. Of course, the post-process can safely alter anything below the node produced by&nbsp;<b id="98e7fe2c">            <i id="7b0563ab">MAP-SRC</i>         </b>, but an attempt to go out from the sandbox of the node would lead to an error.</p></li><li class="list__item" id="6b53abbc"><p>Presence of active weaving rules prevents in-place transformation as these rule require both input and output models.</p></li></ul>   <h3 id="generationtrace">Generation trace</h3>   <p id="bcba370b">Much like in-place transformation, the updated generation trace is inspired by the idea to track actual changes only. Now it's much less demanding, as only the transformed nodes are being tracked. Besides, various presentation options are available to give different perspective on the transformation process.</p><div class="last-modified" data-skip-index="skip">Last modified: 5 July 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="generator-language.html">Generator Language</a><a class="navigation-links__next" href="mapping-priorities.html">Mapping Priorities</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>