<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta name="robots" content="noindex"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><meta charset="UTF-8"><title>Closures - Help | MPS</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Closures.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Windows/Linux Default</option><option data-group="primary" value="primary_default_for_gnome">GNOME</option><option data-group="primary" value="primary_default_for_kde">KDE</option><option data-group="primary" value="primary_default_for_xwin">XWin</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Default (Mac OS X 10.5+)</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_intellij_idea_classic_os_x">IntelliJ IDEA Classic (Mac OS X)</option><option data-group="secondary" value="secondary_xcode">Xcode</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_resharper">ReSharper</option><option data-group="secondary" value="secondary_resharper_osx">ReSharper (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs (Mac OS X)</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Closures.html" id="closures.xml">Closures</h1>   <h2 id="introduction">Introduction</h2>   <p id="2ee287c0">Closures are a handy extension to the base language. Not only they make code more consise, but you can use them as a vehicle to carry you through the lands of functional paradigm in programming. You can treat functions as first-class citizens in your programs - store them in variables, pass them around to methods as arguments or have methods and functions return other functions. The <i id="7ff4f3b9">MPS Closures Support</i> allows to you employ closures in your own languages. In fact, MPS itself uses closures heavily, for example, in the <i id="555e1c5e">collections language</i>.</p>   <p id="b6ac6835">      <br> This language loosely follows the "BGGA" proposal specification for closures in Java. However, you don't need Java 7 to run code with MPS closures. The actual implementation uses anonymous inner classes, so any recent version of Java starting with 1.5 will run the generated code without problems. Only the <i id="1a9b067e">closures runtime</i> jar file is required to be on the classpath of the generated solutions.</p>   <h2 id="functiontype">Function type</h2>   <p id="fdc8d1ed">{ Type1, Type2... =&gt; ReturnType }</p>   <p id="9a121ba2">Let's start with a trivial example of function type declaration. It declares a function that accepts no parameters and returns no value.</p>   <div class="code-block" data-lang="none">{=&gt; void}</div>   <h4 id="subtypingrules">Subtyping rules</h4>   <p id="811295ea">A function type is covariant by its return type and contravariant by parameter types.</p>   <p id="159c3393">For example, given we have defined a method that accepts {String =&gt; Number} :</p>   <div class="code-block" data-lang="none">public void accept_Number_from_String ({String =&gt; Number} function) {
...
}
</div>   <p id="6be0671c">we can pass an instance of {Object =&gt; Integer} (a function that accepts Object and returns int) to this method:</p>   <div class="code-block" data-lang="none">this.accept_Number_from_String ({Object o =&gt; o.hashCode();});</div>   <p id="17a89b3a">Simply put, you can use different actual types of parameters and the return value so long as you keep the promise made in the super-type's signature.</p>   <div class="code-block" data-lang="none"></div>   <h2 id="closureliteral">Closure literal</h2>   <p id="5f4f12fd">Closure literal is created simply by entering a following construct: <i id="e8277983">{ &lt;parameter decls&gt; =&gt; &lt;body&gt; }</i>. No <i id="775fdbaa">"new"</i> operator is necessary.</p>   <p id="f340b307">The result type is calculated following one or more of these rules:</p>   <ul class="list _ul"><li class="list__item" id="c65d88a5"><p>last statement, if it's an ExpressionStatement;</p></li><li class="list__item" id="9c427542"><p>return statement with an expression;</p></li><li class="list__item" id="e214bdb6"><p>yield statement.</p></li></ul>   <p id="b43c91b6">Note: it's impossible to combine <i id="ba1d7bac">return</i> and <i id="791ea480">yield</i> within a single closure literal.</p>   <h2 id="closureinvocation">Closure invocation</h2>   <p id="167b3da5">The <i id="f3c4f7e4">invoke</i> operation is the only method you can call on a closure. Instead of entering</p>   <div class="code-block" data-lang="none">closure.invoke(p1,p2);</div>   <p id="01c1b7b5">To invoke a closure, it is recommended to use the simplified version of this operation - parentheses enclosing the parameter list.</p>   <div class="code-block" data-lang="none">closure(p1,p2);</div>   <p id="35b99c88">Invoking a closure then looks like a regular method call.</p>   <p id="5a3df241">Some examples of closure literal definitions.</p>   <div class="code-block" data-lang="none">{int =&gt; int} fib = { int n =&gt; n &lt;= 1 ? n : invoke(n-1) + invoke(n-2); }
{int =&gt; int} fact = { int n =&gt; int res = 1;       };
    while (n &gt; 1) {
    res = res * n--;
    }
                               res;

{=&gt; sequence&lt;int&gt;} closure = {=&gt; yield 1;};
</div>   <h3 id="recursion">Recursion</h3>   <p id="f8faabbf">Functional programing without recursion would be like making coffe without water, so obviously you have a natural way to call recursively a closure from within its body:</p>   <div class="code-block" data-lang="none">{int =&gt; long} fact = {int n =&gt;
  if (n == 1) {
    return 1L;
  } else {
    return n * invoke(n - 1);
  }
};

println("Factorial of 10 = " + fact(10));
</div>   <p id="4c133266">A standalone <i id="67a5a34f">invoke</i> within the closure's body calls the current closure.</p>   <h2 id="closureconversion">Closure conversion</h2>   <p id="3ca430a9">      <br> For practical purposes a closure literal can be used in places where an instance of a single-method interface is expected, and vice versa.</p>   <div class="code-block" data-lang="none">public interface Worker {
  String doWork (int amount);
}

...

Worker worker = { int amount =&gt; "Done " + amount + " work";};
</div>   <p id="1ca9707f">The generated code is exactly the same as when using anonymous class:</p>   <div class="code-block" data-lang="none">Worker worker = new Worker() {
  public String doWork(int amount) {
    return "Done " + amount + " work";
  }
};
</div>   <p id="51b30593">Think of all the places where Java requires instances of <i id="f21f64be">Runnable</i>, <i id="f0b29b95">Callable</i> or various observer or listener classes:</p>   <div class="code-block" data-lang="none">println("Reported from the main thread " + Thread.currentThread());
final Runnable runnable = { =&gt; println("Reported from a thread " + Thread.currentThread()); };
Thread t = new Thread(runnable);
t.start();
</div>   <aside class="note " data-title="" rel="2f2e8e4a" id="06cff8c9">      <p id="0ffa5d7e">The following changes are applicable to the upcoming 1.5 version of MPS.</p>   </aside>   <p id="32f9694f">As with interfaces, an abstract class containing exactly one abstract method can also be adapted to from a closure literal. This can help, for example, in smooth transition to a new API, when existing interfaces serving as functions can be changed to abstract classes implementing the new interfaces.</p>   <h2 id="yieldstatement">Yield statement</h2>   <p id="c7013c4f">The yield statement allows closures populate collections. If a yield statement is encountered within the body of a closure literal, the following are the consequences:</p>   <ul class="list _ul"><li class="list__item" id="db15e473"><p>if the type of yield statement expression is Type, then the result type of the closure literal is sequence&lt;Type&gt;;</p></li><li class="list__item" id="a3240053"><p>all control statements within the body are converted into a switch statement within an infinite do-while loop at the generation;</p></li><li class="list__item" id="899d9ce7"><p>usage of return statement is forbidden and the value of last ExpressionStatement is ignored.</p></li></ul>   <div class="code-block" data-lang="none">sequence&lt;int&gt; sequence = new sequence&lt;int&gt; ({=&gt; yield 1;});
    yield 2;
    yield 3;</div>   <h2 id="functionsthatreturnfunctions">Functions that return functions</h2>   <p id="08e2e59b">A little bit of functional programming for the functional hearts out there:</p>   <div class="code-block" data-lang="none">{ int , int =&gt; int } add = { int x , int y =&gt; x + y ; } ;
{ int =&gt; int } plusThree = { int x =&gt; x + 3 ; } ;
{ int =&gt; int } curriedPlusThree = this . curry ( add , 3 ) ;
assert plusThree . invoke ( 1 ) equals curriedPlusThree . invoke ( 1 ) ;
</div>   <p id="a8f7cdde">The curry() method is defined as follows:</p>   <div class="code-block" data-lang="none">public { int =&gt; int }   curry ( final { int , int =&gt; int } fun , final int y ) {
   return  { int x =&gt; fun . invoke ( x , y ) ; } ;
}
</div>   <h2 id="runtime">Runtime</h2>   <p id="83b3bf49">In order to run the code generated by the closures language, it's necessary to add to the classpath of the solution the closures runtime library. This jar file contains the synthetic interfaces needed to support variables of function type and some utility classes. It's located in:      <span class="filepath">/core/baseLanguage/jetbrains.mps.baseLanguage.closures.runtime.jar</span>   </p>   <h2 id="differencesfromthebggaproposal">Differences from the BGGA proposal</h2>   <ul class="list _ul"><li class="list__item" id="76d513e2"><p>No messing up with control flow. This means no support for control flow statements that break the boundaries of a closure literal.</p></li><li class="list__item" id="57bc3f23"><p>No "early return" problem: since MPS allows return to be used anywhere within the body.</p></li><li class="list__item" id="f8c94e94"><p>The <i id="81918338">yield</i> statement.</p></li></ul>   <hr id="c88cf582">   <p id="bccc7a68">      <br> [1] <a href="http://www.javac.info/" data-external="true" target="_blank" rel="noopener noreferrer">Closures for the Java Programming Language</a>   </p>   <p id="71dc9a09">      <br> [2] <a href="http://www.javac.info/closures-v05.html" data-external="true" target="_blank" rel="noopener noreferrer">Version 0.5 of the BGGA closures specification is partially supported</a>   </p>   <p id="8c438608">      <br> [3] This is no longer true: only closure literal to interface conversion is supported, as an optimization measure.</p><div class="last-modified" data-skip-index="skip">Last modified: 5 July 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="implementing-generators-for-baselanguage-s-extensions.html">Implementing generators for BaseLanguage's extensions</a><a class="navigation-links__next" href="collections-language.html">Collections language</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>