<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta name="robots" content="noindex"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><meta charset="UTF-8"><title>Implementing generators for BaseLanguage's extensions - Help | MPS</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Implementing+generators+for+BaseLanguage%27s+extensions.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Windows/Linux Default</option><option data-group="primary" value="primary_default_for_gnome">GNOME</option><option data-group="primary" value="primary_default_for_kde">KDE</option><option data-group="primary" value="primary_default_for_xwin">XWin</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Default (Mac OS X 10.5+)</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_intellij_idea_classic_os_x">IntelliJ IDEA Classic (Mac OS X)</option><option data-group="secondary" value="secondary_xcode">Xcode</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_resharper">ReSharper</option><option data-group="secondary" value="secondary_resharper_osx">ReSharper (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs (Mac OS X)</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Implementing+generators+for+BaseLanguage%27s+extensions.html" id="implementing-generators-for-baselanguage-s-extensions.xml">Implementing generators for BaseLanguage's extensions</h1>   <p id="c863c79b">&nbsp;</p>   <p id="7d47efc6">This article showcases an idiomatic way for writing generators for&nbsp;BaseLanguage extensions that operate with lvalue-expressions. We say that a BaseLanguage expression is <i id="8bce07bb">lvalue&nbsp;</i>if it can be used in the left-hand side of an assignment&nbsp;expression. Concepts that introduce such expressions should override either the instance method <i id="18f823a9">Expression#isLValue()&nbsp;</i>or the static method <i id="e6a69d53">Expression#lvalue()&nbsp;</i>in the behaviour aspect.&nbsp;</p>   <p id="4751bfe3">The study consists of two independent languages, both of which are small extensions to BaseLanguage. The source code can be found in the BlReference sample project in the MPS distribution.</p>   <h4 id="jetbrains.mps.baselanguage.box">jetbrains.mps.baseLanguage.box</h4>   <p id="82f6bc31">In this language,&nbsp;we show the way to generate custom BaseLanguage extensions that introduce new lvalue-expressions. The presented technique can be used for generating expressions like <i id="470366e2">smodel&nbsp;property&nbsp;access</i> or custom collection's <i id="4138c956">element access by index</i>.</p>   <p id="ffbc9719">The box BaseLanguage's extension introduces a new "box" type that wraps a variable and provides read &amp; write operations over it. The whole language consists&nbsp;of three concepts:</p>   <ul class="list _ul"><li class="list__item" id="ec4e7a50"><p>         <i id="39a38218">BoxType</i> that represents&nbsp;"box" type in a model.</p></li><li class="list__item" id="8610f97e"><p>         <i id="f6af6f05">BoxCreator</i> that can be used in the new expression to create "box" instances</p></li><li class="list__item" id="77d8ff6d"><p>         <i id="96aed932">Box_ValueOperation</i> that can be used as an operation of dot expression when its operand is of "box" type.</p></li></ul>         <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-10-25-36.png"><img alt="image2018 11 12 10 25 36" title="image2018 11 12 10 25 36" src="/help/img/idea/2019.1/image2018-11-12-10-25-36.png" id="b301402a" width="500" height="236"></a></figure>      <p id="c0cc1c53">We treat a dot-expression with "value" operation as lvalue-expression, so we override<i id="e604f0f2"> IOperation#lvalue()</i> method in <i id="430daf4f">Box_ValueOperation</i>'s behaviour aspect. Once we've overridden&nbsp;this method, the dot-expression with "value" operation can be used at the left-hand side of an assignment. Additionally, this operation can be used in compound assignments&nbsp;(such as +=, -=), as well as the increment and decrement operations. Our final goal is to write a generator for&nbsp;<i id="14af086e">Box_ValueOperation </i>concept.</p>   <p id="a8d6d76b">The naive approach would be to manually handle all possible cases in which&nbsp;role a dot-expression with&nbsp;"value" operation is aggregated and generate a proper&nbsp;Java code for each case. However, this approach is insufficient because there're too many cases to handle. Also with this approach, we cannot handle cases when our expression is aggregated with some expression from an independent extension of BaseLanguage.</p>   <p id="90da3dfa">An alternative approach is to transform&nbsp;our expression into another, already existing, lvalue-expression. There are several lvalue-expressions available in Java language into which we can transform our expression - a variable references, a field access operation or an array's element access by index operation. Unfortunately, not all custom lvalue-expressions can be transformed easily into Java lvalue-expressions.</p>   <p id="f3980c5f">For instance, it will be difficult to transform the "value" operation into a Java lvalue-expression if at runtime the "box" type is represented with&nbsp;<i id="add13227">Box</i>&nbsp;interface that provides two methods -&nbsp;<i id="296ac541">getValue</i>&nbsp;and&nbsp;<i id="743e94bc">setValue.</i> To overcome this issue we can use BaseLanguage's generation-time concept of&nbsp;"generic lvalue expression", into which we can transform our expression:</p>         <figure><img alt="genxx1" title="genxx1" src="/help/img/idea/2019.1/genxx1.png" id="966b8255" width="500" height="364"></figure>            <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-11-36-58.png"><img alt="image2018 11 12 11 36 58" title="image2018 11 12 11 36 58" src="/help/img/idea/2019.1/image2018-11-12-11-36-58.png" id="1a7ee651" width="300" height="714"></a></figure>      <p id="0811da90">The "generic lvalue expression" consists of two obligatory roles: <i id="7b68dc1c">type</i> and <i id="fad671f8">reference.&nbsp;</i>The former role specifies the type of our original lvalue-expression while the latter role specifies the expression of type <i id="945c8ddd">jetbrains.mps.references.Reference&lt;T&gt;.&nbsp;</i>This type provides two methods: <i id="3eaa07ab">#get()</i> in order to read value from evaluated variable and <i id="381e5223">#set()</i> - to assign new value to evaluated variable.</p>   <p id="05537fc4">The "generic lvalue expression" additionally contains two optional roles:<i id="bce2808f"> get value</i> and <i id="52529d67">assign value</i>. These expressions are used to simplify the generated code and to produce fewer memory allocations of <i id="aa3b30bc">Reference&lt;T&gt;</i> objects during execution. The first is used in cases when the generated expression is used not in lvalue position while the second expression is used solely when the generated expression is in a left-hand side role of assignment. Note that there is a special&nbsp;"value" keyword available in the assign value expression and this keyword should be used exactly once in the expression.</p>   <h4 id="jetbrains.mps.baselanguage.date">jetbrains.mps.baseLanguage.date</h4>   <p id="e7e0f8fe">In this sample language, we show how to generate custom BaseLanguage extensions that&nbsp;are introducing new expressions or customising existing ones that aggregate&nbsp;lvalue-expression in some role.</p>   <p id="70e5d0a1">The date BaseLanguage's extension introduces new "date" type and several operations on the "date" instances.</p>         <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-10-45-48.png"><img alt="image2018 11 12 10 45 48" title="image2018 11 12 10 45 48" src="/help/img/idea/2019.1/image2018-11-12-10-45-48.png" id="acca047d" width="500" height="202"></a></figure>      <p id="28d7a15d">At runtime, we will represent our "date" type with <i id="6acbf078">java.time.LocalDate:</i>   </p>         <i id="8294c988"></i>      <p id="80e61152">The "date" extension overloads&nbsp;<i id="44b1e79e">plus operator&nbsp;</i>for&nbsp;"date" and "int" instances so that this operation adds days (the amount of which is evaluated from right sub-expression) to a date that is evaluated from left sub-expression. At generation we transform this plus operator into a simple static method call:</p>         <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-10-59-49.png"><img alt="image2018 11 12 10 59 49" title="image2018 11 12 10 59 49" src="/help/img/idea/2019.1/image2018-11-12-10-59-49.png" id="ff0488e3" width="900" height="202"></a></figure>            <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-11-31-48.png"><img alt="image2018 11 12 11 31 48" title="image2018 11 12 11 31 48" src="/help/img/idea/2019.1/image2018-11-12-11-31-48.png" id="aae902b1" width="500" height="110"></a></figure>      <p id="c8e7c2d7">To make our extension consistent, we also want overload plus assignment expression likewise we overloaded the plus operator. A significant difference between the&nbsp;<i id="337859eb">plus operator</i> and the&nbsp;<i id="35f6af7f">plus assignment expression</i> is that in <i id="fa7e995d">plus assignment</i>&nbsp;a left sub-expression should be an lvalue so this expression has to be evaluated to a variable to which we can assign computed values. However, in Java, we cannot pass variables through&nbsp;method invocations so we can not transform our expression into just a method call.</p>   <p id="ea521e29">To approach this problem MPS provides&nbsp;"@byRef" generation time-concept. This expression wraps an lvalue-expression and during generation transforms it into an expression of <i id="e7548f90">jetbrains.mps.references.Reference&lt;T&gt;&nbsp;</i>type. Given an instance of this type, you can produce get &amp; set operations to a variable that is evaluated from the wrapped lvalue-expression.&nbsp;</p>   <p id="a3d7c82c">With&nbsp;"@byRef" expression the plus assignment expression can be easily generated in the following way:</p>         <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-11-33-15.png"><img alt="image2018 11 12 11 33 15" title="image2018 11 12 11 33 15" src="/help/img/idea/2019.1/image2018-11-12-11-33-15.png" id="e6103610" width="900" height="194"></a></figure>            <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-11-34-3.png"><img alt="image2018 11 12 11 34 3" title="image2018 11 12 11 34 3" src="/help/img/idea/2019.1/image2018-11-12-11-34-3.png" id="58b3cace" width="600" height="182"></a></figure>      <h4 id="acompositionof&nbsp;independent&nbsp;extensions&nbsp;">A composition of independent extensions </h4>   <p id="4fdef1d5">Two extensions shown above do not depend on each other. Their both generators are designed with the use of generation-time concept provided with BaseLanguage. On their own, these generation-time facilities make generators to be more consistent and contain less boiler-plate code. In addition to that, extensions, the generators of which are designed in a shown way, can safely aggregate one another without having dependencies on each other:</p>         <figure><a class="lightbox" href="/help/img/idea/2019.1/image2018-11-12-11-51-17.png"><img alt="image2018 11 12 11 51 17" title="image2018 11 12 11 51 17" src="/help/img/idea/2019.1/image2018-11-12-11-51-17.png" id="f5134c80" width="500" height="240"></a></figure>      <p id="f9a87f73">&nbsp;</p>   <p id="97a839f8">&nbsp;</p><div class="last-modified" data-skip-index="skip">Last modified: 5 July 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="mps-java-compatibility.html">MPS Java compatibility</a><a class="navigation-links__next" href="closures.html">Closures</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>