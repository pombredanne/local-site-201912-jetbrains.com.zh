<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta name="robots" content="noindex"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v2/analytics.js"></script><meta charset="UTF-8"><title>Custom Persistence Cookbook - Help | MPS</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v2/app.css"></head><body data-id="Custom+Persistence+Cookbook.html"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search MPS Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>MPS 2019.1 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option data-group="primary" value="primary_default" selected>Windows/Linux Default</option><option data-group="primary" value="primary_default_for_gnome">GNOME</option><option data-group="primary" value="primary_default_for_kde">KDE</option><option data-group="primary" value="primary_default_for_xwin">XWin</option><option data-group="primary" value="primary_emacs">Emacs</option><option data-group="primary" value="primary_visual_studio">Visual Studio</option><option data-group="primary" value="primary_netbeans">NetBeans</option><option data-group="primary" value="primary_eclipse">Eclipse</option><option data-group="secondary" value="secondary_mac_os_x_10.5_">Default (Mac OS X 10.5+)</option><option data-group="secondary" value="secondary_mac_os_x">Mac OS X</option><option data-group="secondary" value="secondary_eclipse_mac_os_x">Eclipse (Mac OS X)</option><option data-group="secondary" value="secondary_intellij_idea_classic_os_x">IntelliJ IDEA Classic (Mac OS X)</option><option data-group="secondary" value="secondary_xcode">Xcode</option><option data-group="secondary" value="secondary_visual_studio">Visual Studio</option><option data-group="secondary" value="secondary_resharper">ReSharper</option><option data-group="secondary" value="secondary_resharper_osx">ReSharper (Mac OS X)</option><option data-group="secondary" value="secondary_emacs">Emacs (Mac OS X)</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Custom+Persistence+Cookbook.html" id="custom-persistence-cookbook.xml">Custom Persistence Cookbook</h1>   <p id="c0e9c755">This document will use the&nbsp;<b id="c8b0dcfb">xmlPersistence</b>&nbsp;sample bundled with MPS to teach you how to define, deploy and use your own persistence formats.</p>   <h2 id="whatiscustompersistence?">What is custom persistence?</h2>   <p id="a5fe206a">MPS normally saves models in its own XML-based format. However, there are cases when you may want to load or save model files in your own format.<br> Suppose, for example, that we want to leverage MPS to describe one of the existing languages. <i id="812cbe71">BaseLanguage</i>, for instance, is a good description of Java. In such a case, the libraries written for that original language should be accessible from within MPS. It is the <b id="cada2ece">stubs</b> aspect of a language that helps to create <b id="197bb25b">stub models</b> for such libraries. Stub models are then used to reference the code outside of MPS.<br> Another useful example - if all you need from MPS&nbsp; is to merely edit files of your own DSL using the MPS editor, it would be useful to store the model in text format so that it could be edited in any text editor.</p>   <h2 id="lookaroundthesampleproject">Look around the sample project</h2>   <p id="5bd0748f">If you open the <b id="b10b0da2">xmlPersistence</b>&nbsp;sample project, you will get three main solutions, each of which fulfills a separate role in the puzzle.</p>   <p id="6c4ffeee">      <figure><img alt="cp1" title="cp1" src="/help/img/idea/2019.1/cp1.png" id="36bf931c" width="479" height="375"></figure>      <br> The <i id="9bb22923">xmlPersistence</i>&nbsp;module defines the actual persistence logic,&nbsp;<i id="0972a3c2">xmlPersistence.build</i>&nbsp;contains a build script and <i id="500046fd">xmlPersistence.ideaPlugin</i>&nbsp;contains a customized plugin descriptor. Although the build script would normally provide a reasonable plugin descriptor by itself, this time we need to customize the descriptor, thus we include it in the project explicitly.</p>   <h2 id="definethepersistenceformat">Define the persistence format</h2>   <p id="cbdf236b">The&nbsp;<i id="18220ffd">xmlPersistence</i>&nbsp;module implements the persistence logic.&nbsp;The persistence type in MPS&nbsp;is set on the&nbsp;<b id="b2e2064f">per-model level</b>. In our simplified case, the sample can store a model, which is restricted to a single <i id="28bf2598">XMLFile</i> root element of the <i id="73999971">jetbrains.mps.core.xml</i>&nbsp;language, into plain XML documents. The actual XML parsing logic resides in the <i id="5101c510">XmlConverter</i>&nbsp;class, while the <i id="7ef4b9b6">XmlModelPersistence</i>&nbsp;class implements the essential interfaces for hooking into the internal workings of MPS.</p>   <p id="fcc29c65">      <figure><img alt="cp2" title="cp2" src="/help/img/idea/2019.1/cp2.png" id="8fd05991" width="369" height="142"></figure>      <br> The <i id="471c89ec">getFormatTitle()</i> method is worth a special mention here, since the string it returns will be used to represent the storage format to the future users.</p>   <p id="3e9b2890">Additionally, the <i id="22348e9b">getFileExtension()</i>&nbsp;method will register our custom persistence for <i id="3339ea2c">.xml</i>&nbsp;files.</p>   <h3 id="pluginid">Plugin ID</h3>   <p id="f60ef0ce">Also notice that the module has a&nbsp;<b id="8588d85f">Plugin ID</b>&nbsp;set in the <i id="51934dc7">Idea Plugin</i>&nbsp;tab of its module properties:</p>         <figure><img alt="cp3" title="cp3" src="/help/img/idea/2019.1/cp3.png" id="0b035329" width="630" height="436"></figure>      <p id="c364bb9a">The identifier must match the plugin identifier declared in the&nbsp;plugin (xml) descriptor inside the&nbsp;<i id="01b33682">xmlPersistence.ideaPlugin</i>&nbsp;solution.&nbsp;We add an IDEA plug-in identifier to the properties of the&nbsp;<i id="08463f54">xmlPersistence</i> solution in order to specify that the&nbsp;solution is part of the plugin and thus can reference (or load at&nbsp;runtime) any plugin's classes.</p>   <h2 id="buildthempsplugin">Build the MPS plugin</h2>   <p id="bee30d28">The <i id="5e5c3e46">xmlPersistencePlugin</i>&nbsp;build script is a standard build script that zips the three modules into an IDEA/MPS plugin.</p>         <figure><img alt="cp4" title="cp4" src="/help/img/idea/2019.1/cp4.png" id="be786e42" width="1117" height="922"></figure>      <aside class="tip sideblock" data-title="" rel="c40a6410" id="af6e20dc">      <p id="97c1bc4e">Make sure the paths specified in the <b id="e90696f0">macros</b>&nbsp;section correctly point to your MPS and IntelliJ IDEA installation folders.</p>   </aside>   <p id="b7a7d313">The <i id="1cfa1308">plugin</i>&nbsp;descriptor provides the standard plugin information plus it registers our&nbsp;<i id="001f9091">jetbrains.mps.persistence.XmlModelPersistence</i>&nbsp;class as <i id="767bd985">mps.ModelFactoryProvider.</i> This is the additional bit that requires us to provide an explicit plugin descriptor.</p>         <figure><img alt="cp5" title="cp5" src="/help/img/idea/2019.1/cp5.png" id="5498686f" width="1278" height="383"></figure>      <p id="d4ecaaf3">After rebuild you should be able to run the build script and get the plugin generated:</p>         <figure><img alt="cp6" title="cp6" src="/help/img/idea/2019.1/cp6.png" id="33c4c25b" width="542" height="481"></figure>      <p id="d3ccc109">This will create the plugin so we can distribute it to the users.</p>   <h2 id="buildtheintellijideaplugin">Build the IntelliJ IDEA plugin</h2>   <p id="92bbf9f1">Building an IntelliJ IDEA plugin isn't really that much different from building an MPS plugin. You only need to change the dependency from <i id="9a495bb6">mps</i>&nbsp;to <i id="5caca2dd">mpsPlugin</i>&nbsp;in the build script and set the artifacts location to wherever your MPS IDEA plugin has been deployed. <figure><img alt="cp7" title="cp7" src="/help/img/idea/2019.1/cp7.png" id="8845c207" width="780" height="330"></figure>   </p>   <p id="c0231b4a">After rebuilding the project and running the build script, you get a plugin to deploy into IDEA.</p>   <h2 id="usingthecustompersistenceplugininmps">Using the custom persistence plugin in MPS</h2>   <p id="f235e984">After installing the generated plugin into MPS, when you are creating new models you are able to specify the <i id="76a27722">XML file</i>&nbsp;persistence provider for them:</p>         <figure><img alt="cp8" title="cp8" src="/help/img/idea/2019.1/cp8.png" id="3be6e1bc" width="689" height="328"></figure>      <p id="9a4987ae">Just as we specify in the <i id="ba6c7ade">XmlModelPersistence.createEmpty()</i> method, the new model will have the <i id="3a045c46">jetbrains.mps.core.xml</i>&nbsp;language added as a used language and an empty Root Node will be added to it:<br>       <figure><img alt="cp9" title="cp9" src="/help/img/idea/2019.1/cp9.png" id="2a58c64f" width="635" height="451"></figure>      <br>       <figure><img alt="cp10" title="cp10" src="/help/img/idea/2019.1/cp10.png" id="6aa83dff" width="359" height="179"></figure>   </p>   <p id="db16e762">Whatever you type into the root node, will be persisted immediately into a corresponding xml file. Changes to the underlying xml file will be reflected in the model upon opening in the editor.<br>       <figure><img alt="cp11" title="cp11" src="/help/img/idea/2019.1/cp11.png" id="1ea488c8" width="301" height="182"></figure>       <figure><img alt="cp12" title="cp12" src="/help/img/idea/2019.1/cp12.png" id="56544c19" width="481" height="191"></figure>   </p>   <h2 id="usingthecustompersistenceplugininintellijidea">Using the custom persistence plugin in IntelliJ IDEA</h2>   <p id="628cc12a">The IDEA plugin also allows for XML documents to be edited with an MPS-based projectional editor and yet persisted into plain xml files. Since .xml files are associated with the XML editor in IDEA, we get the default IDEA's editor open when we click on an XML file. <figure><img alt="cp20" title="cp20" src="/help/img/idea/2019.1/cp20.png" id="6fe13c27" width="486" height="134"></figure>   </p>   <p id="94f42e70">However, since the <i id="b4c0ae18">sample.xml</i>&nbsp;file is located under the configured MPS models root, MPS will invoke our custom persistence plugin and have it build a model out of it. When you hit <i id="65d60fa9">Control + N / Cmd + N</i>&nbsp;to open a class by name, you get the option to open the sample model:<br>       <figure><img alt="cp21" title="cp21" src="/help/img/idea/2019.1/cp21.png" id="2b8e33bc" width="444" height="122"></figure>   </p>   <p id="35a82f3c">Then you can edit it in a projectional editor and have your changes persisted into the original xml file:<br>       <figure><img alt="cp22" title="cp22" src="/help/img/idea/2019.1/cp22.png" id="3156d602" width="354" height="162"></figure>   </p>   <aside class="tip sideblock" data-title="" rel="35a82f3c" id="e7b86bd2">      <p id="4cd70f2e">At the moment MPS does not allow you to customize the persistence storage type of newly created models in IntelliJ IDEA. New models always receive the default MPS persistence type. MPS can, however, open existing models with any supported persistence type, if they are copied into the configured models root directory.</p>   </aside>   <h2 id="debuggingtheplugin">Debugging the plugin</h2>   <p id="3d0487de">MPS can also give you a hand when you want to test your fresh persistence implementation right away, directly in MPS. You simply create a <i id="967abb5d">Run Configuration</i>&nbsp;off the <i id="53e53796">Deploy Plugins</i> template:</p>   <p id="df2963e8">      <figure><img alt="cp13" title="cp13" src="/help/img/idea/2019.1/cp13.png" id="0c91e247" width="792" height="283"></figure>      <br> Then you specify your plugin (after rebuilding the project and re-running the build script) to be deployed by the <i id="e5e97250">Run Configuration</i>:</p>         <figure><img alt="cp14" title="cp14" src="/help/img/idea/2019.1/cp14.png" id="d2b8a113" width="1105" height="727"></figure>      <p id="022b7c04">Finally you run the configuration to get the plugin installed into MPS (MPS will restart):<br>       <figure><img alt="cp15" title="cp15" src="/help/img/idea/2019.1/cp15.png" id="75610025" width="1072" height="676"></figure>   </p>   <p id="349a9a44">After this step you will be able to use the custom persistence provider for models and test that it behaves as expected.</p>   <p id="9e188632">The plugin will be installed into the <i id="8a11359f">.MPS3x</i>&nbsp;sub-directory of your home folder&nbsp;on Windows, or <i id="a31d9bee">$HOME/Library/Application Support/MPS3x</i>&nbsp;on Mac. You may uninstall or disable the plugin through the <i id="573ea8d0">Plugin Manager</i>&nbsp;UI or by deleting the plugin manually.</p><div class="last-modified" data-skip-index="skip">Last modified: 5 July 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="custom-language-aspect-cookbook.html">Custom language aspect cookbook</a><a class="navigation-links__next" href="regular-expressions.html">Regular expressions</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v2/app.js"></script></body></html>