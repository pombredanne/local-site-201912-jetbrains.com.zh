


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Get a Tree Node Under Caret / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/help/resharper/sdk/app/app.css">
    <link rel="shortcut icon" href="/help/resharper/sdk/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="57x57" href="/help/resharper/sdk/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/help/resharper/sdk/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/help/resharper/sdk/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/help/resharper/sdk/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/help/resharper/sdk/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/help/resharper/sdk/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/help/resharper/sdk/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/help/resharper/sdk/apple-touch-icon-180x180.png">
    <link rel="mask-icon" href="/help/resharper/sdk/apple-mask-icon.svg" color="black">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-square70x70logo" content="/help/resharper/sdk/mstile-70x70.png">
    <meta name="msapplication-TileImage" content="/help/resharper/sdk/mstile-144x144.png">
    <meta name="msapplication-square150x150logo" content="/help/resharper/sdk/mstile-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/help/resharper/sdk/mstile-310x150.png">
    <meta name="msapplication-square310x310logo" content="/help/resharper/sdk/mstile-310x310.png">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Documentation for writing extensions for ReSharper" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.jetbrains.com/help/resharper/sdk//HowTo/NavigateCode/GetTreeNodeUnderCaret.html" />
    <meta property="og:site_name" content="JetBrains ReSharper" />
    <meta property="og:title" content="Get a Tree Node Under Caret" />
    <meta property="og:description" content="Documentation for writing extensions for ReSharper" />
    <meta property="og:image" content="https://www.jetbrains.com/help/resharper/sdk/jetbrains.png" />
    <meta property="article:modified_time" content="2017-07-12T17:29:51+00:00" />
    <!-- <meta property="article:section" content="" /> 
    <meta property="article:tag" content="" /> -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@JBPlatform" />
    <meta name="twitter:title" content="Get a Tree Node Under Caret" />
    <meta name="twitter:description" content="Documentation for writing extensions for ReSharper" />
    <meta name="twitter:image" content="https://www.jetbrains.com/help/resharper/sdk/jetbrains.png" />
    <meta class="swiftype" name="product" data-type="string" content="/help/resharper/sdk/"></meta>
<link  rel="stylesheet" href="/help/resharper/sdk/app/styles.css"></head>
<body data-id="HowTo/NavigateCode/GetTreeNodeUnderCaret">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a data-bypass="true" href="//youtrack.jetbrains.com/issues/IJSDK">Send feedback</a></p>
                <p>&copy; 2000&ndash;2018 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">
                    <div class="navigation-links _top" data-swiftype-index="false">
                        
                        <a class="navigation-links__next" href="/HowTo/NavigateCode/GetTreeNodeByFullName.html">Get a Tree Node by Full CLR Name</a>
                    </div>
                    <a data-bypass="true" href="https://github.com/JetBrains/resharper-devguide/edit/master/HowTo/NavigateCode/GetTreeNodeUnderCaret.md" class="page-link-to-github" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub">
                        <i class="github-icon"></i>
                        <span class="text">Edit page</span>
                    </a>

                    <h1>Get a Tree Node Under Caret</h1>
                    <p><strong>What you should know beforehand:</strong></p>
<ul>
  <li><a href="/help/resharper/sdk/HowTo/ObtainComponentsInRuntime.html"><span>Component model</span></a></li>
  <li><a href="/help/resharper/sdk/HowTo/WorkWithLifetime.html"><span>Lifetime</span></a></li>
  <li><a href="/help/resharper/sdk/HowTo/NavigateCode/NavigateCode.html#project-model-basics"><span>Project model</span></a></li>
  <li><a href="/help/resharper/sdk/HowTo/NavigateCode/NavigateCode.html#psi-basics"><span>PSI</span></a></li>
  <li><a href="/help/resharper/sdk/HowTo/WorkWithIProperty.html"><span>IProperty</span></a></li>
  <li>ShellLocks</li>
</ul>

<p><strong>Examples (<a href="/help/resharper/sdk/HowTo/HowTo.html#sample-solution"><span>?</span></a>):</strong></p>
<ul>
  <li><a href="https://github.com/JetBrains/sample-resharper-plugin/blob/master/SampleReSharperPlugin/src/PsiNavigation/NodeUnderCaretDetector.cs" data-external="true" target="_blank" rel="noopener noreferrer"><span>NodeUnderCaretDetector.cs</span></a></li>
</ul>

<p>Getting a tree node under the current caret position is a very typical task when implementing a navigation or any other tree-node-dependent feature. Actually, there are many ways of obtaining the tree node depending on the context. For example, when implementing <a href="/help/resharper/sdk/HowTo/NavigateCode/NavigateCode.html"><span>context navigation</span></a>, you can use the <code class="code highlight language-text">GetSelectedTreeNode</code> method of the <code class="code highlight language-text">IDataContext</code> object. E.g.:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="c1">// ...</span>

<span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ContextNavigation</span><span class="p">&gt;</span> <span class="nf">CreateWorkflow</span><span class="p">(</span><span class="n">IDataContext</span> <span class="n">dataContext</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">node</span> <span class="p">=</span> <span class="n">dataContext</span><span class="p">.</span><span class="n">GetSelectedTreeNode</span><span class="p">&lt;</span><span class="n">ITreeNode</span><span class="p">&gt;();</span>
    <span class="c1">// ...</span>
</code></div>

<p>Nevertheless, if you need a more generic (context-independent) get-node-under-caret function implementation, see the example below:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="na">[SolutionComponent]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">NodeUnderCaretDetector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ISolution</span> <span class="n">Solution</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Lifetime</span> <span class="n">_lifetime</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">DocumentManager</span> <span class="n">_documentManager</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITextControlManager</span> <span class="n">_textControlManager</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IShellLocks</span> <span class="n">_shellLocks</span><span class="p">;</span>
    <span class="k">public</span> <span class="n">IProperty</span><span class="p">&lt;</span><span class="n">ITreeNode</span><span class="p">&gt;</span> <span class="n">NodeUnderCaret</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
 
    <span class="k">public</span> <span class="nf">NodeUnderCaretDetector</span><span class="p">(</span><span class="n">Lifetime</span> <span class="n">lifetime</span><span class="p">,</span> <span class="n">ISolution</span> <span class="n">solution</span><span class="p">,</span>
        <span class="n">DocumentManager</span> <span class="n">documentManager</span><span class="p">,</span>
        <span class="n">ITextControlManager</span> <span class="n">textControlManager</span><span class="p">,</span> <span class="n">IShellLocks</span> <span class="n">shellLocks</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Solution</span> <span class="p">=</span> <span class="n">solution</span><span class="p">;</span>
        <span class="n">_lifetime</span> <span class="p">=</span> <span class="n">lifetime</span><span class="p">;</span>
        <span class="n">_documentManager</span> <span class="p">=</span> <span class="n">documentManager</span><span class="p">;</span>
        <span class="n">_textControlManager</span> <span class="p">=</span> <span class="n">textControlManager</span><span class="p">;</span>
        <span class="n">_shellLocks</span> <span class="p">=</span> <span class="n">shellLocks</span><span class="p">;</span>
        <span class="n">NodeUnderCaret</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Property</span><span class="p">&lt;</span><span class="n">ITreeNode</span><span class="p">&gt;(</span><span class="s">"NodeUnderCaretDetector.NodeUnderCaret"</span><span class="p">);</span>
 
        <span class="n">EventHandler</span> <span class="n">caretMoved</span> <span class="p">=</span> <span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="n">_shellLocks</span><span class="p">.</span><span class="nf">QueueReadLock</span><span class="p">(</span><span class="s">"NodeUnderCaretDetector.CaretMoved"</span><span class="p">,</span> <span class="n">Refresh</span><span class="p">);</span>
        <span class="p">};</span>
 
        <span class="n">lifetime</span><span class="p">.</span><span class="nf">AddBracket</span><span class="p">(</span>
            <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">_textControlManager</span><span class="p">.</span><span class="n">Legacy</span><span class="p">.</span><span class="n">CaretMoved</span> <span class="p">+=</span> <span class="n">caretMoved</span><span class="p">,</span>
            <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">_textControlManager</span><span class="p">.</span><span class="n">Legacy</span><span class="p">.</span><span class="n">CaretMoved</span> <span class="p">-=</span> <span class="n">caretMoved</span><span class="p">);</span>
    <span class="p">}</span>
 
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Refresh</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">node</span> <span class="p">=</span> <span class="nf">GetTreeNodeUnderCaret</span><span class="p">();</span>
        <span class="n">NodeUnderCaret</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">node</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span>
    <span class="k">public</span> <span class="n">ITreeNode</span> <span class="nf">GetTreeNodeUnderCaret</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">textControl</span> <span class="p">=</span> <span class="n">_textControlManager</span><span class="p">.</span><span class="n">LastFocusedTextControl</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">textControl</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
 
        <span class="kt">var</span> <span class="n">projectFile</span> <span class="p">=</span> <span class="n">_documentManager</span><span class="p">.</span><span class="nf">TryGetProjectFile</span><span class="p">(</span><span class="n">textControl</span><span class="p">.</span><span class="n">Document</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">projectFile</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
 
        <span class="kt">var</span> <span class="n">range</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TextRange</span><span class="p">(</span><span class="n">textControl</span><span class="p">.</span><span class="n">Caret</span><span class="p">.</span><span class="nf">Offset</span><span class="p">());</span>
 
        <span class="kt">var</span> <span class="n">psiSourceFile</span> <span class="p">=</span> <span class="n">projectFile</span><span class="p">.</span><span class="nf">ToSourceFile</span><span class="p">().</span><span class="nf">NotNull</span><span class="p">(</span><span class="s">"File is null"</span><span class="p">);</span>
 
        <span class="kt">var</span> <span class="n">documentRange</span> <span class="p">=</span> <span class="n">range</span><span class="p">.</span><span class="nf">CreateDocumentRange</span><span class="p">(</span><span class="n">projectFile</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">file</span> <span class="p">=</span> <span class="n">psiSourceFile</span><span class="p">.</span><span class="nf">GetPsiFile</span><span class="p">(</span><span class="n">psiSourceFile</span><span class="p">.</span><span class="n">PrimaryPsiLanguage</span><span class="p">,</span> <span class="n">documentRange</span><span class="p">);</span>
 
        <span class="kt">var</span> <span class="n">element</span> <span class="p">=</span> <span class="n">file</span><span class="p">?.</span><span class="nf">FindNodeAt</span><span class="p">(</span><span class="n">documentRange</span><span class="p">);</span>
 
        <span class="k">return</span> <span class="n">element</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></div>

<a name="notes" class="elem-anchor"></a>
<h2>Notes<a href="#notes" class="anchor-link"><span></span></a></h2>
<ul>
  <li>The solution component <code class="code highlight language-text">NodeUnderCaretDetector</code> has the public <code class="code highlight language-text">IProperty</code> - <code class="code highlight language-text">NodeUnderCaret</code>. You can use this property to obtain the tree node under the caret at any moment of time.</li>
  <li>The <code class="code highlight language-text">NodeUnderCaret.Value</code> is updated each time the caret is moved. This is implemented by means of the legacy <code class="code highlight language-text">CaretMoved</code> event handler.</li>
  <li>The <code class="code highlight language-text">GetTreeNodeUnderCaret()</code> method performs all the work - it returns the <code class="code highlight language-text">ITreeNode</code> element under the caret.</li>
  <li>The <code class="code highlight language-text">textControl</code> instance (<code class="code highlight language-text">ITextControl</code>) allows working with the currently opened text file as if you worked with a text editor. Here we obtain the current caret offset by calling <code class="code highlight language-text">textControl.Caret.Offset()</code>.</li>
  <li>Note that, formally speaking, <code class="code highlight language-text">textControl</code> knows nothing about the code inside itself - it simply renders the content it gets from an <code class="code highlight language-text">IDocument</code> instance.</li>
  <li>By knowing the document, we can obtain the <a href="NavigateCode.html#project-model-basics"><span>IProjectFile</span></a> (<code class="code highlight language-text">_documentManager.TryGetProjectFile</code>) instance - it provides the API to work with the fileâ€™s syntax tree.</li>
  <li>From the <code class="code highlight language-text">IProjectFile</code>, we obtain, one after another <a href="NavigateCode.html#project-model-basics"><span>IPsiSourceFile</span></a> and <a href="NavigateCode.html#psi-basics"><span>IFile</span></a> (the main element of the PSI syntax tree).</li>
  <li><code class="code highlight language-text">IFile</code> provides the <code class="code highlight language-text">FindNodeAt()</code> method that returns the node by the specified range.</li>
  <li>Note that to prevent conflicts with user input, we must obtain the read lock before calculating the node under the caret. This is done by means of the special method of the <code class="code highlight language-text">IShellLocks</code> interface: <code class="code highlight language-text">_shellLocks.QueueReadLock(...)</code>.</li>
</ul>


                    <div class="navigation-links _bottom" data-swiftype-index="false">
                        
                        <a class="navigation-links__next" href="/HowTo/NavigateCode/GetTreeNodeByFullName.html">Get a Tree Node by Full CLR Name</a>
                    </div>
                    <div class="last-modified">
                        Last modified: 12 July 2017
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>

<script src="/help/resharper/sdk/app/app.js" data-baseurl="/help/resharper/sdk/"></script>

</body>
</html>

