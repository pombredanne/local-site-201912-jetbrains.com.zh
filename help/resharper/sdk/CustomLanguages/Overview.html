


<!doctype html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Custom Languages / ReSharper  DevGuide</title>
    <link rel="stylesheet" href="/help/resharper/sdk/app/app.css">
    <link rel="shortcut icon" href="/help/resharper/sdk/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="57x57" href="/help/resharper/sdk/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/help/resharper/sdk/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/help/resharper/sdk/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/help/resharper/sdk/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/help/resharper/sdk/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/help/resharper/sdk/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/help/resharper/sdk/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/help/resharper/sdk/apple-touch-icon-180x180.png">
    <link rel="mask-icon" href="/help/resharper/sdk/apple-mask-icon.svg" color="black">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-square70x70logo" content="/help/resharper/sdk/mstile-70x70.png">
    <meta name="msapplication-TileImage" content="/help/resharper/sdk/mstile-144x144.png">
    <meta name="msapplication-square150x150logo" content="/help/resharper/sdk/mstile-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/help/resharper/sdk/mstile-310x150.png">
    <meta name="msapplication-square310x310logo" content="/help/resharper/sdk/mstile-310x310.png">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Documentation for writing extensions for ReSharper" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.jetbrains.com/help/resharper/sdk//CustomLanguages/Overview.html" />
    <meta property="og:site_name" content="JetBrains ReSharper" />
    <meta property="og:title" content="Custom Languages" />
    <meta property="og:description" content="Documentation for writing extensions for ReSharper" />
    <meta property="og:image" content="https://www.jetbrains.com/help/resharper/sdk/jetbrains.png" />
    <meta property="article:modified_time" content="2017-07-10T19:28:42+00:00" />
    <!-- <meta property="article:section" content="" /> 
    <meta property="article:tag" content="" /> -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@JBPlatform" />
    <meta name="twitter:title" content="Custom Languages" />
    <meta name="twitter:description" content="Documentation for writing extensions for ReSharper" />
    <meta name="twitter:image" content="https://www.jetbrains.com/help/resharper/sdk/jetbrains.png" />
    <meta class="swiftype" name="product" data-type="string" content="/help/resharper/sdk/"></meta>
<link  rel="stylesheet" href="/help/resharper/sdk/app/styles.css"></head>
<body data-id="CustomLanguages/Overview">
<div class="wrapper">
    <section class="panel _nav">
        <header class="panel__header">
            <div class="container">
                <form class="search-box">
                    <label for="search-box__input" class="search-box__label">
                        <input type="text" class="search-box__input" id="search-box__input" placeholder="Search ReSharper  DevGuide">
                    </label>
                    <div class="search-box__clear" title="Clear"></div>
                </form>
            </div>
        </header>
        <nav class="panel__content">
            <div class="container _nav">
                <menu class="nav-tree"></menu>
            </div>
            <div class="container _footer panel__footer">
                <p><a data-bypass="true" href="//youtrack.jetbrains.com/issues/IJSDK">Send feedback</a></p>
                <p>&copy; 2000&ndash;2018 <a href="//www.jetbrains.com">JetBrains</a> s.r.o.<br>
                    All rights reserved.</p>
            </div>
        </nav>
    </section>

    <main class="panel _main" role="main">
        <header class="panel__header">
            <div class="container">
                <h3>ReSharper DevGuide</h3>
                
                <div class="panel-trigger"></div>
            </div>
        </header>
        <section class="panel__content">
            <div class="container">
                <article class="article" data-shortcut-switcher="false">
                    <div class="navigation-links _top" data-swiftype-index="false">
                        <a class="navigation-links__prev" href="/Products/InspectCode.html">InspectCode Plugins</a>
                        <a class="navigation-links__next" href="/CustomLanguages/Registration.html">Registering a Custom Language</a>
                    </div>
                    <a data-bypass="true" href="https://github.com/JetBrains/resharper-devguide/edit/master/CustomLanguages/Overview.md" class="page-link-to-github" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub">
                        <i class="github-icon"></i>
                        <span class="text">Edit page</span>
                    </a>

                    <h1>Custom Languages</h1>
                    <p>In this part of the guide we’ll look at developing ReSharper support for a new language. We shall take a look at the following:</p>

<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction"><span>Introduction</span></a></li>
  <li><a href="#tools" id="markdown-toc-tools"><span>Tools</span></a></li>
  <li><a href="#cslex" id="markdown-toc-cslex"><span>CsLex</span></a></li>
  <li><a href="#parsergen" id="markdown-toc-parsergen"><span>ParserGen</span></a></li>
  <li><a href="#language-definition" id="markdown-toc-language-definition"><span>Language Definition</span></a></li>
  <li><a href="#project-file-type" id="markdown-toc-project-file-type"><span>Project File Type</span></a></li>
  <li><a href="#project-file-language-service" id="markdown-toc-project-file-language-service"><span>Project File Language Service</span></a></li>
  <li><a href="#psi-properties" id="markdown-toc-psi-properties"><span>PSI Properties</span></a></li>
  <li><a href="#language-service" id="markdown-toc-language-service"><span>Language Service</span></a></li>
</ul>

<a name="introduction" class="elem-anchor"></a>
<h2>Introduction<a href="#introduction" class="anchor-link"><span></span></a></h2>

<p>ReSharper supports a wide variety of language and also supports a mixture of languages (e.g., <code class="code highlight language-text">.cshtml</code> files are a mixture of C# and HTML). Plugin writers can use existing infrastructure in order to support new languages within ReSharper. A language implementation can be a plugin or part of a plugin, and in most cases no special action is required for it to be picked up and recognized by ReSharper.</p>

<aside class="note">
  <p> While new language support may be provided in any .NET-compatible programming language, the provided parsing/lexing tools support only the C# programming language.</p>
</aside>

<a name="tools" class="elem-anchor"></a>
<h2>Tools<a href="#tools" class="anchor-link"><span></span></a></h2>

<p>The parsing and lexing of languages requires specialized tools. This is why, as of the 7.0 release, the ReSharper SDK comes with a set of tools and target files as well as a fully worked-out example of supporting a new language. The following items are included:</p>

<ul>
  <li><strong>CsLex</strong> - a tool for creating lexical analysers for different languages.</li>
  <li><strong>Java</strong> - contains IKVM infrastructure which permits the running of the Java-based parser generator.</li>
  <li><strong>MSBuild</strong> - contains build tasks that can be used to automate lexer and parser construction.</li>
  <li><strong>parserGen</strong> - a tool for creating ReSharper-compatible parsers.</li>
</ul>

<p>In addition to the tools, the SDK also comes with a full language plugin example located in the <code class="code highlight language-text">Samples/PsiPlugin</code> folder. This sample is a full implementation of a language plugin for supporting <code class="code highlight language-text">.psi</code> files, which are parser definition files used by <code class="code highlight language-text">parserGen</code>. As a result, plugin developers interested in using <code class="code highlight language-text">parserGen</code> for new language development are advised to compile and install <code class="code highlight language-text">PsiPlugin</code>, which can greatly simplify the process of working with parser definition files.</p>

<p>Let’s go through the tools one by one, since all of them are critical in putting together a language plugin.</p>

<a name="cslex" class="elem-anchor"></a>
<h2>CsLex<a href="#cslex" class="anchor-link"><span></span></a></h2>

<p><code class="code highlight language-text">CsLex</code> is a <a href="http://www.cybercom.net/~zbrad/DotNet/Lex/" data-external="true" target="_blank" rel="noopener noreferrer"><span>freely available</span></a> lexical analyzer generator that comes packaged in the SDK. CsLex can be found in the <code class="code highlight language-text">Tools/CsLex</code> folder, which includes the following files:</p>

<ul>
  <li><code class="code highlight language-text">CsLex.Targets</code> contains a set of targets that need to be included in the <code class="code highlight language-text">.csproj</code> file using an <code class="code highlight language-text">&lt;Import&gt;</code> directive:</li>
</ul>

<div class="code-block" data-lang="xml"><code class="code-block__wrapper"><span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$(ReSharperSdkTools)\CsLex\CsLex.Targets"</span> <span class="nt">/&gt;</span>
</code></div>

<ul>
  <li><code class="code highlight language-text">CsLex.Tasks</code> contains the definition for a <code class="code highlight language-text">CsLex</code> build task. It is automatically included by <code class="code highlight language-text">CsLex.Targets</code></li>
  <li><code class="code highlight language-text">lex.exe</code> is the executable that generates the lexical definitions. <code class="code highlight language-text">lex.xml</code> is the XML documentation for the tool. You do not need to interact directly with these two files, as the build task takes care of that for you.</li>
</ul>

<p>In order to generate lexical structures, your project needs to have a <code class="code highlight language-text">.lex</code> file. You can learn more about the format of lexical definition files in the <a href="http://www.cybercom.net/~zbrad/DotNet/Lex/Lex.htm" data-external="true" target="_blank" rel="noopener noreferrer"><span>CsLex documentation page</span></a>, but your definition also needs to have ReSharper-specific elements. To learn more about these elements, please take a look at the <code class="code highlight language-text">psi.lex</code> file in the sample <code class="code highlight language-text">PsiPlugin</code> that comes with the SDK.</p>

<p>The <code class="code highlight language-text">.lex</code> file is compiled with a build action of <code class="code highlight language-text">CsLex</code>. After compilation, CsLex generates from it a <code class="code highlight language-text">_lex.cs</code> file that contains a generated lexer.</p>

<p>One of the building blocks of the lexer is the unicode definition file <code class="code highlight language-text">Unicode.lex</code>. While this file currently lives in the <code class="code highlight language-text">Tools/parserGen</code> folder, its purpose is to provide detailed information about various unicode rangers that the lexer can consume to correctly distinguish identifiers. In order to use this file, it needs to be copied into the <code class="code highlight language-text">/obj</code> folder inside the project. The simplest way to do this is to add the following MSBuild directive to the project:</p>

<div class="code-block" data-lang="xml"><code class="code-block__wrapper"><span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">"BeforeBuild"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;MakeDir</span> <span class="na">Directories=</span><span class="s">"$(MSBuildProjectDirectory)\obj"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;Copy</span> <span class="na">SourceFiles=</span><span class="s">"$(ReSharperSdkTools)\parserGen\Unicode.lex"</span> <span class="na">DestinationFolder=</span><span class="s">"$(MSBuildProjectDirectory)\obj"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Target&gt;</span>
</code></div>

<a name="parsergen" class="elem-anchor"></a>
<h2>ParserGen<a href="#parsergen" class="anchor-link"><span></span></a></h2>

<p><code class="code highlight language-text">parserGen</code> is a parser generator that is used to define parsers for various languages. It lives in the <code class="code highlight language-text">tools/parserGen</code> folder and happens to be written in Java, which is why there is also a <code class="code highlight language-text">tools/Java</code> folder in the SDK that provides IKVM bindings. Let’s go briefly through some of the <em>non-java</em> files that parserGen comes with:</p>

<ul>
  <li><code class="code highlight language-text">ParserGen.Targets</code> and <code class="code highlight language-text">ParserGen.Tasks</code> contain the MSBuild targets and build task respectively. Plugin writers need to add the following to the <code class="code highlight language-text">.csproj</code> file:</li>
</ul>

<div class="code-block" data-lang="xml"><code class="code-block__wrapper"><span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$(ReSharperSdkTools)\parserGen\ParserGen.Targets"</span> <span class="nt">/&gt;</span>
</code></div>

<ul>
  <li><code class="code highlight language-text">ParserGenTask.dll</code> provides a .NET shim for using a Java-based <code class="code highlight language-text">ParserGen</code> build task.</li>
  <li><code class="code highlight language-text">Unicode.lex</code> is a file that actually relates to lexer construction. (See above.)</li>
</ul>

<p>A parser is defined in a proprietary format in a file with a <code class="code highlight language-text">.psi</code> extension and a specified build task of <code class="code highlight language-text">ParserGen</code>. This is precisely the format for which <code class="code highlight language-text">PsiPlugin</code> provides support, and thus you should compile and install <code class="code highlight language-text">PsiPlugin</code> if you intend to work with <code class="code highlight language-text">.psi</code> files. While no formal documentation exists, we recommend that you look at the <code class="code highlight language-text">psi.psi</code> grammar file in <code class="code highlight language-text">PsiPlugin</code> for a detailed example of a grammar definition.</p>

<a name="language-definition" class="elem-anchor"></a>
<h2>Language Definition<a href="#language-definition" class="anchor-link"><span></span></a></h2>

<p>First of all, you need to create a class inheriting from <code class="code highlight language-text">KnownLanguage</code>. The constraints on this class (let’s call it <code class="code highlight language-text">MyLanguage</code> here) are that it should:</p>

<ul>
  <li>Be declared <code class="code highlight language-text">public</code></li>
  <li>Have one public static non-<code class="code highlight language-text">readonly</code>, non-initialized field of a <code class="code highlight language-text">MyLanguage</code> type</li>
  <li>Must have a parameterless constructor</li>
  <li>Should have a set of <code class="code highlight language-text">protected</code> constructors to allow language inheritance.</li>
</ul>

<p>The <code class="code highlight language-text">MyLanguage</code> class must also be marked with the <code class="code highlight language-text">[LanguageDefinition]</code> attribute. This attribute takes two parameters:</p>

<ul>
  <li>The first and only required parameter is the name of the language.</li>
  <li><em>(Optional)</em> The <code class="code highlight language-text">Edition</code> parameter specifies the ReSharper edition that this language supports. If you need to constrain the language to a particular R# edition, use an element of the <code class="code highlight language-text">ReSharperEditions.Ids</code> enumeration here. Reminder: R# currently comes in three editions - C#, VB.NET and Full.</li>
</ul>

<p>Here is an example of a language definition for the C# language:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="na">[LanguageDefinition(Name, Edition = ReSharperEditions.Ids.Csharp)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CSharpLanguage</span> <span class="p">:</span> <span class="n">KnownLanguage</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">new</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"CSHARP"</span><span class="p">;</span>

  <span class="p">[</span><span class="n">CanBeNull</span><span class="p">]</span> <span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">CSharpLanguage</span> <span class="n">Instance</span><span class="p">;</span>

  <span class="k">private</span> <span class="nf">CSharpLanguage</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="s">"C#"</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="k">protected</span> <span class="nf">CSharpLanguage</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="kt">string</span> <span class="n">name</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="k">protected</span> <span class="nf">CSharpLanguage</span><span class="p">([</span><span class="n">NotNull</span><span class="p">]</span> <span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="n">NotNull</span><span class="p">]</span> <span class="kt">string</span> <span class="n">presentableName</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">presentableName</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
</code></div>

<a name="project-file-type" class="elem-anchor"></a>
<h2>Project File Type<a href="#project-file-type" class="anchor-link"><span></span></a></h2>

<p>Now, we need to tell ReSharper how to support a project of a particular type. This is another class that contains primarily metadata, and is used mainly to indicate the file extensions that correspond to a particular language. Just like the Language Definition class, this class (let’s call it <code class="code highlight language-text">MyLanguageProjectFileType</code>) requires that:</p>

<ul>
  <li>It is declared <code class="code highlight language-text">public</code></li>
  <li>It has a <code class="code highlight language-text">public</code>, <code class="code highlight language-text">static</code>, non-<code class="code highlight language-text">readonly</code> field of type <code class="code highlight language-text">MyLanguageProjectFileType</code></li>
  <li>It has a parameterless constructor. This constructor calls its base class’ constructor, passing the array of file extensions that this project file type supports.</li>
  <li>It has a set of <code class="code highlight language-text">protected</code> methods for inheritance</li>
</ul>

<p>In addition, the project file type class has to be decorated with the <code class="code highlight language-text">ProjectFileTypeDefinition</code> attribute. This attribute has the following parameters:</p>
<ul>
  <li>The <code class="code highlight language-text">Type</code> parameter requires name of the language (as per language definition)</li>
  <li><em>(Optional)</em> The <code class="code highlight language-text">Edition</code> parameter determines the R# edition that supports this project file type.</li>
  <li><em>(Optional)</em> The <code class="code highlight language-text">Internal</code> boolean parameter determines whether this project file type is only supported in internal mode. Plugin writers should not define this parameter.</li>
</ul>

<p>Here is an example of a project file type class for HTML files:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="na">[ProjectFileTypeDefinition(Name)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">HtmlProjectFileType</span> <span class="p">:</span> <span class="n">KnownProjectFileType</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">new</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">"HTML"</span><span class="p">;</span>
  <span class="k">public</span> <span class="k">new</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">HtmlProjectFileType</span> <span class="n">Instance</span><span class="p">;</span>

  <span class="k">private</span> <span class="nf">HtmlProjectFileType</span><span class="p">()</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="s">"Html"</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span><span class="n">HTML_EXTENSION</span><span class="p">,</span> <span class="n">HTM_EXTENSION</span><span class="p">})</span>  <span class="p">{</span>  <span class="p">}</span>

  <span class="k">protected</span> <span class="nf">HtmlProjectFileType</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  <span class="p">{</span>  <span class="p">}</span>

  <span class="k">protected</span> <span class="nf">HtmlProjectFileType</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">presentableName</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">resentableName</span><span class="p">)</span>  <span class="p">{</span>  <span class="p">}</span>

  <span class="k">protected</span> <span class="nf">HtmlProjectFileType</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">,</span> <span class="kt">string</span> <span class="n">presentableName</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">extensions</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">presentableName</span><span class="p">,</span> <span class="n">extensions</span><span class="p">)</span>  <span class="p">{</span>  <span class="p">}</span>

  <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">HTML_EXTENSION</span> <span class="p">=</span> <span class="s">".html"</span><span class="p">;</span>
  <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">HTM_EXTENSION</span> <span class="p">=</span> <span class="s">".htm"</span><span class="p">;</span>
<span class="p">}</span>
</code></div>

<a name="project-file-language-service" class="elem-anchor"></a>
<h2>Project File Language Service<a href="#project-file-language-service" class="anchor-link"><span></span></a></h2>

<p>Let’s create a project file language service. This entity is used to tell us which language tree needs to be constructed for a particular file. For example, the <code class="code highlight language-text">XamlProjectFileLanguageService</code> would create a XAML tree of the XAML file is part of the project, and only an XML tree if it is not.</p>

<p>The project file language service is a class which implements the <code class="code highlight language-text">IProjectFileLanguageService</code> interface and is decorated with the <code class="code highlight language-text">ProjectFileType</code> attribute relating to the project file type. The attribute takes a single parameter - the <code class="code highlight language-text">typeof(MyLanguageProjectFileType)</code> that we created earler.</p>

<p>We are now getting in the thick of language development, this being the last stop before we go to define the overall language service (the one that exposes lexers, parsers and other supplementary information). Let us go through the members of our <code class="code highlight language-text">MyProjectFileLanguageService</code> implementation.</p>

<ul>
  <li>First of all, we need to have a public constructor that will take a parameter of the <code class="code highlight language-text">MyProjectFileType</code> type. We’ll need to store this parameter for returning it later.</li>
  <li>The <code class="code highlight language-text">LanguageType</code> property is precisely the location where we would typically return the above stored value.</li>
  <li>The <code class="code highlight language-text">Icon</code> property needs to return the icon for this type of file. If you are storing the icon internally as an embedded resource, use <code class="code highlight language-text">ImageLoader.GetImage("icon.resource.name", null)</code> to return the icon.</li>
  <li>
    <p>The <code class="code highlight language-text">GetPsiLanguageType()</code> method takes an <code class="code highlight language-text">IProjectFile</code> parameter. If the <code class="code highlight language-text">LanguageType</code> property of this parameter matches our language, then we return the <code class="code highlight language-text">Instance</code> field of our language. Otherwise, we return <code class="code highlight language-text">UnknownLanguage.Instance</code>. Here is an example:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">public</span> <span class="n">PsiLanguageType</span> <span class="nf">GetPsiLanguageType</span><span class="p">(</span><span class="n">IProjectFile</span> <span class="n">projectFile</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">projectFile</span><span class="p">.</span><span class="n">LanguageType</span><span class="p">.</span><span class="n">Is</span><span class="p">&lt;</span><span class="n">MyLanguageProjectFileType</span><span class="p">&gt;())</span>
    <span class="k">return</span> <span class="n">MyLanguage</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">UnknownLanguage</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
<span class="p">}</span>
</code></div>
  </li>
  <li>
    <p>There is also an overload of the <code class="code highlight language-text">GetPsiLanguageType()</code> method that takes a <code class="code highlight language-text">ProjectFileType</code> as a parameter. The implementation of this method is similar to the one above:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">public</span> <span class="n">PsiLanguageType</span> <span class="nf">GetPsiLanguageType</span><span class="p">(</span><span class="n">ProjectFileType</span> <span class="n">languageType</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">languageType</span><span class="p">.</span><span class="n">Is</span><span class="p">&lt;</span><span class="n">MyLanguageProjectFileType</span><span class="p">&gt;())</span>
    <span class="k">return</span> <span class="n">MyLanguage</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="n">UnknownLanguage</span><span class="p">.</span><span class="n">Instance</span><span class="p">;</span>
<span class="p">}</span>
</code></div>
  </li>
  <li>
    <p>The <code class="code highlight language-text">GetMixedLexerFactory()</code> method returns the mixed lexer factory. The mixed lexer (<em>mixed</em> refers to the possibility of having mixed languages in a file) is returned by the language service, which we haven’t defined. The typical implementation of this method is as follows:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">public</span> <span class="n">ILexerFactory</span> <span class="nf">GetMixedLexerFactory</span><span class="p">(</span><span class="n">IBuffer</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">IPsiSourceFile</span> <span class="n">sourceFile</span><span class="p">,</span> <span class="n">PsiManager</span> <span class="n">manager</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">MyLanguage</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="nf">LanguageService</span><span class="p">().</span><span class="nf">GetPrimaryLexerFactory</span><span class="p">();</span>
<span class="p">}</span>
</code></div>
  </li>
</ul>

<aside class="note">
  <p> In the above code, <code class="code highlight language-text">LanguageService()</code> is an extension method that resides in the <code class="code highlight language-text">PsiLanguageTypeExtensions</code> class.</p>
</aside>

<ul>
  <li>The <code class="code highlight language-text">GetPreprocessorDefines()</code> method is used to return a set of <code class="code highlight language-text">PreProcessingDirective</code> definitions. If your language doesn’t have preprocessing directives, in which case you can simply return <code class="code highlight language-text">EmptyArray&lt;PreProcessingDirective&gt;.Instance</code>.</li>
  <li>
    <p>The <code class="code highlight language-text">GetPsiProperties()</code> method is used to return a new instance of the PSI properties type for this file as follows:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">public</span> <span class="n">IPsiSourceFileProperties</span> <span class="nf">GetPsiProperties</span><span class="p">(</span><span class="n">IProjectFile</span> <span class="n">projectFile</span><span class="p">,</span> <span class="n">IPsiSourceFile</span> <span class="n">sourceFile</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">Assertion</span><span class="p">.</span><span class="nf">Assert</span><span class="p">(</span><span class="n">projectFile</span><span class="p">.</span><span class="n">LanguageType</span><span class="p">.</span><span class="nf">IsProjectFileType</span><span class="p">(</span><span class="n">LanguageType</span><span class="p">),</span> <span class="s">"projectFile.LanguageType == LanguageType"</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">MyLanguagePsiProperties</span><span class="p">(</span><span class="n">projectFile</span><span class="p">,</span> <span class="n">sourceFile</span><span class="p">);</span>
<span class="p">}</span>
</code></div>
  </li>
</ul>

<p>We haven’t seen the PSI Properties class, so that’s coming up next.</p>

<a name="psi-properties" class="elem-anchor"></a>
<h2>PSI Properties<a href="#psi-properties" class="anchor-link"><span></span></a></h2>

<p>Yet another service entity that is required for successful language support is the PSI Properties entity. In order to understand it why it is needed, it’s important to understand that when working with files, we essentially operate on two different entities: <code class="code highlight language-text">IProjectFile</code> and <code class="code highlight language-text">IPsiSourceFile</code>:</p>

<ul>
  <li><code class="code highlight language-text">IProjectFile</code> is part of the project model, i.e., it holds information about the file in the context of the project it’s in. Among other things, it yields information regarding its <code class="code highlight language-text">ProjectFileType</code> (we have defined this earlier), and also yields an <code class="code highlight language-text">IProjectFileProperties</code> value that contains the types of file properties you see when you open the Properties window (or press F4) in Visual Studio.</li>
  <li><code class="code highlight language-text">IPsiSourceFile</code> is part of the PSI. It also yields a <code class="code highlight language-text">ProjectFileType</code> as one of its properties, but it also yields a language (a <code class="code highlight language-text">PsiLanguageType</code> inheritor such as <code class="code highlight language-text">MyLanguage</code>) as well as a set of <code class="code highlight language-text">IPsiSourceFileProperties</code>. These properties correspond to the code model, i.e., the AST that represents the file.</li>
</ul>

<p>Thus, the PSI Properties entity is a kind of glue that manages takes as parameters both an <code class="code highlight language-text">IProjectFile</code> and a <code class="code highlight language-text">IPsiSourceFile</code> and manages to bind the two together.</p>

<p>The PSI Properties class is a class deriving from <code class="code highlight language-text">DefaultPsiProjectFileProperties</code>, and is often located as an inner class of the above language service type. This class takes two parameters - the project file and the PSI source file. Typically, its constructor simply passes them up to the parent:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">private</span> <span class="k">class</span> <span class="nc">MyLanguageFileProperties</span> <span class="p">:</span> <span class="n">DefaultPsiProjectFileProperties</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="nf">MyLanguageFileProperties</span><span class="p">(</span><span class="n">IProjectFile</span> <span class="n">projectFile</span><span class="p">,</span> <span class="n">IPsiSourceFile</span> <span class="n">sourceFile</span><span class="p">)</span>
    <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">projectFile</span><span class="p">,</span> <span class="n">sourceFile</span><span class="p">)</span>
  <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></div>

<p>The above is a minimal implementation. Often, the PSI Properties type contains overrides for some of the properties defined by the base class. Here are a few such properties:</p>

<ul>
  <li><code class="code highlight language-text">ShouldBuildPsi</code> determines whether the PSI tree needs to be built for this file. By default, the value is <code class="code highlight language-text">true</code> for any type that isn’t <code class="code highlight language-text">null</code> or unknown. This property should be overridden in certain cases where it’s not worth building a PSI - for example, in the case where you have a XAML file that’s not part of a project.</li>
  <li><code class="code highlight language-text">ProvidesCodeModel</code> determines whether the file provides a code model. Not all files do - for example, an XML file does not. By default, this has the value of <code class="code highlight language-text">ShouldBuildPsi</code>.</li>
  <li><code class="code highlight language-text">IsNonUserFile</code> determines whether this is a file is owned by the user or not. Typically this has the value of <code class="code highlight language-text">\!IsCompile</code>, i.e. depends on the file’s build action.</li>
  <li><code class="code highlight language-text">IsGeneratedFile</code> determines whether this file is generated or not. By default, R# tries to get this information from the provided <code class="code highlight language-text">projectFile</code>.</li>
</ul>

<a name="language-service" class="elem-anchor"></a>
<h2>Language Service<a href="#language-service" class="anchor-link"><span></span></a></h2>

<p>We are finally ready to create is a language service – an entity that finally lets us work with the language AST. This is a class inheriting from <code class="code highlight language-text">LanguageService</code>. The requirements for this class are:</p>

<ul>
  <li>It must be declared <code class="code highlight language-text">public</code></li>
  <li>It must have a public constructor taking <em>at least</em> the language definition (i.e., the <code class="code highlight language-text">MyLanguage</code> type) and an <code class="code highlight language-text">IConstantValueService</code>.</li>
  <li>It must call the base constructor with the above parameters.</li>
</ul>

<aside class="note">
  <p> After implementing the above, check that your breakpoints actually fire when opening the file with your chosen extension. An empty implementation of the above should be sufficient for ReSharper to identify the feature-related language service.</p>
</aside>

<p>The language service is where all the activity occurs. In particular, the language services exposes both the lexer and the parser, as well as a number of complementary services that may or may not be required for the particular language.</p>

<p>We begin our language implementation with the lexer. The language service type has two members relating to the creation of lexers.</p>

<p>The first is the <code class="code highlight language-text">GetPrimaryLexerFactory()</code> method. This method returns a lexer factory, which is simply a class that implements the <code class="code highlight language-text">ILexerFactory</code> interface and whose <code class="code highlight language-text">CreateLexer()</code> method returns an instance of a lexer (which we’ll define in a moment):</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">private</span> <span class="k">class</span> <span class="nc">MyLanguageLexerFactory</span> <span class="p">:</span> <span class="n">ILexerFactory</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="n">ILexer</span> <span class="nf">CreateLexer</span><span class="p">(</span><span class="n">IBuffer</span> <span class="n">buffer</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">MyLanguageLexer</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></div>

<p>Thus, the implementation of <code class="code highlight language-text">MyLanguageService.GetPrimaryLexerFactory()</code> reduces to:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">public</span> <span class="k">override</span> <span class="n">ILexerFactory</span> <span class="nf">GetPrimaryLexerFactory</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">MyLanguageLexerFactory</span><span class="p">();</span>
<span class="p">}</span>
</code></div>

<p>Of course, we have not yet mentioned the <code class="code highlight language-text">ILexer</code>. Before we get on to actually making a lexer, it’s also worth mentioning another <code class="code highlight language-text">LanguageService</code> member - the <code class="code highlight language-text">CreateFilteringLexer()</code> method. Now, just as the name suggests, a filtering lexer is a lexer that filters (i.e. ignores) certain token types. A filtering lexer inherits from the <code class="code highlight language-text">FilteringLexer</code> class. Apart from having to have an <code class="code highlight language-text">ILexer</code> as a constructor parameter passed up to its base class, it has a single method called <code class="code highlight language-text">Skip()</code> that you need to override.</p>

<p>The <code class="code highlight language-text">Skip()</code> method is simple: it takes a <code class="code highlight language-text">TokenNodeType</code> and determines whether this is the kind of token that needs to be skipped. Typical tokens to be skipped often include whitespace, line breaks, comments or code within certain preprocessor directives. Now, the simplest way to provide support for this is to create a <code class="code highlight language-text">NodeTypeSet</code> of all the tokens that you intend to skip as follows:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">internal</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">NodeTypeSet</span> <span class="n">TokensToSkip</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NodeTypeSet</span><span class="p">(</span>
  <span class="k">new</span> <span class="n">NodeType</span><span class="p">[]</span>
    <span class="p">{</span>
      <span class="n">MyLanguageTokenType</span><span class="p">.</span><span class="n">WHITE_SPACE</span><span class="p">,</span>
      <span class="n">MyLanguageTokenType</span><span class="p">.</span><span class="n">NEW_LINE</span>
    <span class="p">}</span>
  <span class="p">);</span>
</code></div>

<p>With this definition in place, the implementation of the <code class="code highlight language-text">Skip()</code> method can be as follows:</p>

<div class="code-block" data-lang="csharp"><code class="code-block__wrapper"><span class="k">protected</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Skip</span><span class="p">(</span><span class="n">TokenNodeType</span> <span class="n">tokenType</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">MyLanguageService</span><span class="p">.</span><span class="n">TokensToSkip</span><span class="p">[</span><span class="n">tokenType</span><span class="p">];</span>
<span class="p">}</span>
</code></div>


                    <div class="navigation-links _bottom" data-swiftype-index="false">
                        <a class="navigation-links__prev" href="/Products/InspectCode.html">InspectCode Plugins</a>
                        <a class="navigation-links__next" href="/CustomLanguages/Registration.html">Registering a Custom Language</a>
                    </div>
                    <div class="last-modified">
                        Last modified: 10 July 2017
                    </div>
                </article>

                <section class="disqus">
                    <div id="disqus_thread"></div>
                </section>
            </div>
        </section>
    </main>
</div>

<script src="/help/resharper/sdk/app/app.js" data-baseurl="/help/resharper/sdk/"></script>

</body>
</html>

