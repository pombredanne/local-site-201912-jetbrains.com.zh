<html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><meta charset="UTF-8"><title>通过API控制分析会话-帮助|帮助点内存</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API" data-disqus-id="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API_dm"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索dotMemory帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>dotMemory 2019.2帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option value="rs" data-group="secondary">ReSharper 2.x / IntelliJ IDEA</option><option value="vs" data-group="primary" selected>视觉工作室</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API.xml" data-toc="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API">通过API控制分析会话</h1>    <a name="API"></a>    <p id="2ccaba65"><a href="https://www.nuget.org/packages/JetBrains.Profiler.Api/" rel="noopener noreferrer" data-external="true" target="_blank">分析API</a>提供了许多类，使您可以控制分析过程。例如，直接从您的应用程序代码，您可以：</p><ul class="list _ul"><li class="list__item" id="497b52ef"><p>获取内存快照： <code class="code">MemoryProfiler.GetSnapshot()</code> ，</p></li><li class="list__item" id="845faf47"><p>启用或禁用收集内存分配数据： <code class="code">MemoryProfiler.CollectAllocations(bool enable)</code> ，</p></li><li class="list__item" id="51a3f32a"><p>甚至强制垃圾回收： <code class="code">MemoryProfiler.ForceGc()</code> ，</p></li></ul>    <p></p>    <p id="40fa098f">有关API类的详细信息，请参阅<a href="API_Reference.html">API参考</a> 。</p>    <p id="60ffe5cf">需要使用概要分析API的主要场景有两种：</p>    <ul class="list _ul"><li class="list__item" id="648d0f6b">            <a href="#profiling-a-specific-part-of-the">分析代码的特定部分</a>        </li><li class="list__item" id="95c91431">            <a href="#self-profiled-applications">自我介绍的应用</a>        </li></ul>    <div class="chapter"><h2 id="profiling-a-specific-part-of-the" data-toc="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API#profiling-a-specific-part-of-the">分析代码的特定部分</h2>        <p id="4cfe27a0">该API允许您缩小分析范围，并仅对您感兴趣的代码进行概要分析。例如，有时在适当的时候单击“ <span class="control">获取快照”</span>按钮并不容易。使用分析API，您可以在代码的确切位置进行“获取快照”调用。</p>        <p id="9f6dd277">请注意，dotMemory 2018.3和更早版本使用了另一个版本的概要分析API（有关此API的详细信息，请参阅<a href="/help/dotmemory/2018.3/Controlling_Profiling_Process_Through_API.html#fe63298b" rel="noopener noreferrer" data-external="true" target="_blank">dotMemory 2018.3文档</a> ）。仍支持此API，但我们强烈建议您使用本节中介绍的最新API版本。</p>        <p id="89f8440b">主要概念：</p>        <ul class="list _ul"><li class="list__item" id="7c4724b4"><p>该API的源代码可在<a href="https://github.com/JetBrains/profiler-api" rel="noopener noreferrer" data-external="true" target="_blank">GitHub上获得</a> 。该代码在Apache许可下分发。</p></li><li class="list__item" id="7161054c"><p>分析API作为<a href="https://www.nuget.org/packages/JetBrains.Profiler.Api/" rel="noopener noreferrer" data-external="true" target="_blank">JetBrains分发</a><a href="https://www.nuget.org/packages/JetBrains.Profiler.Api/" rel="noopener noreferrer" data-external="true" target="_blank">。探查器。您应在项目中引用的API</a> NuGet包。</p></li><li class="list__item" id="67c8206b"><p>要启用API，必须使用启用的“ <span class="control">通过API进行控制”分析</span>选项启动分析会话。它位于高级<a href="dotMemory_Profiler_Options.html">Profiler选项中</a> 。</p></li><li class="list__item" id="427f5f4e"><p>使用API时，与常规分析会话相比，唯一的区别在于控制会话的方式：您无需单击<a href="Controlling_Profiling_Process.html">分析控制器中</a>的按钮，而是调用相应的API方法。</p></li><li class="list__item" id="6a2119e9"><p>如果您在禁用性能分析的情况下运行应用程序，则将仅忽略对API方法的调用。该API将不会引发任何错误。</p></li><li class="list__item" id="ae4bc480"><p>您应该用来控制性能分析会话的主要类是<code class="code">MemoryProfiler</code>静态类。</p></li><li class="list__item" id="c8233169"><p>要获取内存快照并将其保存到磁盘，请调用<code class="code">MemoryProfiler.GetSnapshot()</code> –等效于按性能分析控制器中的“ <span class="control">获取快照”</span>按钮。</p></li><li class="list__item" id="d72b0440"><p>要启用/禁用收集内存分配数据，请调用<code class="code">CollectAllocations(bool enable)</code> –等效于按“ <span class="control">收集分配”</span>按钮。</p></li><li class="list__item" id="055bc542"><p>检查是否<code class="code">CollectAllocations(bool enable)</code>通话会生效，使用<code class="code">MemoryProfiler.GetFeatures()</code> 。请注意，此检查不是必需的。</p></li></ul>            <section class="procedure-steps"><h3 id="dd4ed168">使用API剖析代码的特定部分</h3><ol class="list _decimal"><li class="list__item" id="03619c6e"><p>参考<code class="code">JetBrains.Profiler.API</code>项目中的NuGet软件包。</p></li><li class="list__item" id="54dc6436"><p>插入对的方法的调用<code class="code">MemoryProfiler</code>根据用例的需要将其分类为您的代码。例如：</p><div class="code-block" data-lang="none">private void SomeMethod（）{//启用收集内存分配数据MemoryProfiler。CollectAllocations（true）; ...//这里有一些我想分析的代码//获取快照MemoryProfiler。GetSnapshot（）; }</div>                <p></p></li><li class="list__item" id="82a442d3"><p>从dotMemory开始对应用程序进行性能分析，然后在<a href="dotMemory_Profiler_Options.html">探查器选项中</a>选择“ <span class="control">通过API控制性能分析</span> ” <a href="dotMemory_Profiler_Options.html">选项</a> 。</p></li></ol></section>    </div>    <div class="chapter"><h2 id="self-profiled-applications" data-toc="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API#self-profiled-applications">自我介绍的应用</h2>        <p id="a314e32f">顾名思义，在这种情况下，应用程序会自我配置。例如，ReSharper使用此API收集有关其在最终用户桌面上的行为的统计信息。当用户遇到性能或内存问题时，支持团队会要求用户使用特殊选项运行ReSharper（启用自我分析功能）并重现问题。然后将收集的快照发送给开发团队。</p>        <p id="c7f1c7f1">主要概念：</p>        <ul class="list _ul"><li class="list__item" id="04a3490f"><p>自分析API以zip存档的形式分发，可从<a href="/profiler/download/#section=dottracesdk" rel="noopener noreferrer" data-external="true" target="_blank">JetBrains网站</a>下载。</p></li><li class="list__item" id="3e8be6e4"><p>自分析API不支持.NET Core应用程序。</p></li><li class="list__item" id="b1b7360e"><p>最终用户未安装dotTrace。因此，必须在应用程序的安装包中包含dotMemory可再发行组件。</p></li><li class="list__item" id="e91c7852"><p>由于最终用户不应启动分析，因此API将启动自分析会话。为此，API使用静态<code class="code">SelfAttach</code>位于<span class="filepath">JetBrains中的课程<span class="filepath">。探查器。视窗。SelfApi.dll</span>库。</span></p></li><li class="list__item" id="7fef0e47"><p>的<code class="code">Attach()</code>方法准备概要分析配置，并从“可分发”文件夹中执行探查器。</p></li><li class="list__item" id="539596ef">                <p id="253395da">配置配置由以下两类之一定义（从<code class="code">BaseSnapshotProfilingConfig</code><code class="code">BaseProfilingConfig</code>类）传递给<code class="code">Attach</code>方法：</p>                <ul class="list _ul"><li class="list__item" id="1f409f8d"><p>                        <code class="code">SaveSnapshotProfilingConfig</code> –生成的快照将保存在指定的文件夹中。</p></li><li class="list__item" id="c54057a0"><p>                        <code class="code">ExecutableSnapshotProfilingConfig</code> –生成的快照将保存在指定或默认文件夹中，快照的路径作为命令行参数传递到外部应用程序。</p></li></ul>            </li><li class="list__item" id="4e727c76"><p>生成的自我分析快照具有<code class="code">.dmw</code>文件扩展名。</p></li></ul>        <section class="procedure-steps"><h3 id="9a7ce05e">在自分析应用程序中使用API</h3><ol class="list _decimal"><li class="list__item" id="7459c290"><p>下载并解压<a href="/profiler/download/#section=dottracesdk" rel="noopener noreferrer" data-external="true" target="_blank">性能分析SDK</a> 。如果您的域策略将从Internet下载的文件视为不安全，请使用文件属性中的“取消<span class="control">阻止”</span>按钮来取消阻止zip存档。</p></li><li class="list__item" id="9fc207f6"><p>参考<code class="code">JetBrains.Profiler.Windows.SelfApi</code>从<span class="filepath">JetBrains组装<span class="filepath">。探查器。视窗。位于SDK主目录中的SelfApi.dll</span>文件。</span></p></li><li class="list__item" id="391157f6"><p>为您的应用提供SDK可再分发文件。</p></li><li class="list__item" id="4a7abe39"><p>使用以下命令在应用程序中的某个地方启动自我分析<code class="code">SelfAttach</code>类。例如：</p><div class="code-block" data-lang="csharp">SelfAttach。附加（新的SaveSnapshotProfilingConfig（）{ProfilingControlKind = ProfilingControlKind。Api，SaveDir =“ C：\\ Temp”，RedistDir =“ C：\\ ProfilerSDK”，ProfilingType = ProfilingType。内存，ListFile =“ C：\\ snapshot_list.xml” //在分析过程中自动创建文件}）;</div><p></p></li><li class="list__item" id="12493e8e"><p>根据用例的要求，将对<a href="#profiling-a-specific-part-of-the">概要分析API的</a>调用插入代码中。如果您在自我分析初始化后立即开始分析，请添加一小段等待时间（ <code class="code">SelfAttach</code> API需要一些时间才能开始）：</p><div class="code-block" data-lang="none">//等到API启动一段时间（SelfAttach。状态！= SelfApiState。活动）线程。睡眠（250）; MemoryProfiler。CollectAllocations（true）; ...//这里有一些我想分析MemoryProfiler的代码。GetSnapshot（）;</div>            <p></p></li></ol></section>    </div>    <div class="last-modified" data-skip-index="skip">上次修改时间：2019年8月8日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="Getting_Snapshots_by_Condition.html">通过条件</a> <a class="navigation-links__next" href="API_Reference.html">API参考</a> <a class="navigation-links__prev" href="Getting_Snapshots_by_Condition.html">获取快照</a></div><section class="seealso" data-skip-index="skip"><div class="seealso__header"><h2>也可以看看</h2></div><div class="seealso__content"><div class="seealso__col" data-skip-index="skip"><h3>参考：</h3><ul class="list"><li class="list__item"><a href="API_Reference.html">API参考</a></li></ul></div></div></section></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>