<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>通过API控制分析会话-帮助|帮助dotTrace</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API" data-article-props="
                {
                
            " seeals=":{=" referenc="}=" hre=":" api_reference.htm="," titl=":" api="" ="" data-disqus-id="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API_dt"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索dotTrace帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>dotTrace 2019.2帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"><option value="rs" data-group="secondary">ReSharper 2.x / IntelliJ IDEA</option><option value="vs" data-group="primary">视觉工作室</option></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API.xml" data-toc="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API">通过API控制分析会话</h1>    <a name="API"></a>    <p id="84695dd1"><a href="https://www.nuget.org/packages/JetBrains.Profiler.Api/" rel="noopener noreferrer" data-external="true" target="_blank">分析API</a>提供了许多类，使您可以控制分析过程。例如，直接从您的应用程序代码，您可以：</p><ul class="list _ul"><li class="list__item" id="6ff598bc"><p>开始收集分析数据： <code class="code">MeasureProfiler.StartCollectingData()</code> ，</p></li><li class="list__item" id="9433d3a5"><p>停止收集数据： <code class="code">MeasureProfiler.StopCollectingData()</code> ，</p></li><li class="list__item" id="109b01c1"><p>将数据保存到磁盘： <code class="code">MeasureProfiler.SaveData()</code> ，</p></li><li class="list__item" id="7b2e56ad"><p>和更多。</p></li></ul>            <p></p>    <p id="ad2860b2">有关API类的详细信息，请参阅<a href="API_Reference.html">API参考</a> 。</p>    <p id="136ecfa9">需要使用概要分析API的主要场景有两种：</p>    <ul class="list _ul"><li class="list__item" id="129adf1a">            <a href="#profiling-a-specific-part-of-the">分析代码的特定部分</a>        </li><li class="list__item" id="64d8209e">            <a href="#self-profiled-applications">自我介绍的应用</a>        </li></ul>    <div class="chapter"><h2 id="profiling-a-specific-part-of-the" data-toc="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API#profiling-a-specific-part-of-the">分析代码的特定部分</h2>        <p id="cb84ef17">该API允许您缩小分析范围，并仅对您感兴趣的代码进行概要分析。例如，有时在适当的时候单击“ <span class="control">获取快照”</span>按钮并不容易。使用分析API，您可以在代码的确切位置进行“获取快照”调用。</p>        <p id="f6b9122a">请注意，dotTrace 2018.3和更早版本使用了另一个版本的概要分析API（有关此API的详细信息，请参阅<a href="/help/profiler/2018.3/Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API.html#b7ae75d5" rel="noopener noreferrer" data-external="true" target="_blank">dotTrace 2018.3文档</a> ）。仍支持此API，但我们强烈建议您使用本节中介绍的最新API版本。</p>        <p id="9ed6b772">主要概念：</p>        <ul class="list _ul"><li class="list__item" id="5145d093"><p>该API的源代码可在<a href="https://github.com/JetBrains/profiler-api" rel="noopener noreferrer" data-external="true" target="_blank">GitHub上获得</a> 。该代码在Apache许可下分发。</p></li><li class="list__item" id="b4c1cfdb"><p>分析API作为<a href="https://www.nuget.org/packages/JetBrains.Profiler.Api/" rel="noopener noreferrer" data-external="true" target="_blank">JetBrains分发</a><a href="https://www.nuget.org/packages/JetBrains.Profiler.Api/" rel="noopener noreferrer" data-external="true" target="_blank">。探查器。您应在项目中引用的API</a> NuGet包。</p></li><li class="list__item" id="a5e61f0e"><p>要启用该API，必须<span class="control">使用</span>启用的“ <span class="control">使用事件探查器API”</span>选项启动性能分析会话。它位于高级<a href="Profiler_Options.html">Profiler选项中</a> 。</p></li><li class="list__item" id="4a27c551"><p>使用API时，与常规分析会话相比，唯一的区别在于控制会话的方式：您无需单击<a href="Profiling_Guidelines__Launching_and_Controlling_the_Profiling_Process.html">分析控制器中</a>的按钮，而是调用相应的API方法。</p></li><li class="list__item" id="76ca1810"><p>如果您在禁用性能分析的情况下运行应用程序，则将仅忽略对API方法的调用。该API将不会引发任何错误。</p></li><li class="list__item" id="760b0b21"><p>您应该用来控制性能分析会话的主要类是<code class="code">MeasureProfiler</code>静态类。</p></li><li class="list__item" id="c4b67914"><p>要开始收集分析数据，请致电<code class="code">MeasureProfiler.StartCollectingData()</code> 。这等效于按下配置控制器中的“ <span class="control">开始”</span>按钮。</p></li><li class="list__item" id="48e257c4"><p>要停止收集数据并将其保存到磁盘，请致电<code class="code">MeasureProfiler.SaveData()</code> –等效于按“ <span class="control">获取快照并等待”</span>按钮。</p></li><li class="list__item" id="997c07c0"><p>要删除数据而不保存，请致电<code class="code">MeasureProfiler.DropData()</code> –等效于按下“ <span class="control">放下”</span>按钮。</p></li><li class="list__item" id="ca3998f5"><p>要停止收集分析数据而不将其保存到磁盘，请致电<code class="code">MeasureProfiler.StopCollectingData()</code> 。通常，您不需要使用此方法。请注意，此方法不适用于“ <a href="Profiler_Options.html#profiling_type">时间轴”概要分析类型，</a>并且探查器将忽略该方法。</p></li><li class="list__item" id="ded23015"><p>时间线分析需要ETW服务在后台运行。要启动此服务，需要管理员权限。因此，每次启动性能分析会话时，dotTrace都会提示您进行权限提升。为避免这种情况，请使用<span class="filepath"><dottrace_installation_directory>\ x64 \ JetBrains手动运行该服务<span class="filepath"><dottrace_installation_directory>。ETW。收藏家。Host.exe</dottrace_installation_directory></span>文件。另一个选择是使用<span class="filepath"><dottrace_installation_directory>\ Msi.x64 \ EtwService.msi</dottrace_installation_directory></span>安装文件安装服务。在这种情况下，该服务将在Windows启动时运行。</dottrace_installation_directory></span></p></li></ul>            <section class="procedure-steps"><h3 id="d147c5b5">使用API剖析代码的特定部分</h3><ol class="list _decimal"><li class="list__item" id="f838e1f9"><p>参考<code class="code">JetBrains.Profiler.API</code>项目中的NuGet软件包。</p></li><li class="list__item" id="d6cd6972"><p>插入对的方法的调用<code class="code">MeasureProfiler</code>根据用例的需要将其分类为您的代码。例如：</p><div class="code-block" data-lang="none">私人无效SomeMethod（）{MeasureProfiler。StartCollectingData（）; ...//这里有一些我想分析MeasureProfiler的代码。保存数据（）; }</div>                <p></p></li><li class="list__item" id="41aa4c61">                    <p id="a316a465">从dotTrace，JetBrains Rider或Visual Studio中开始对应用程序进行性能分析，然后在<a href="Profiler_Options.html">Profiler选项中</a>选择<span class="control">Use profiler API</span>复选框。<b id="db4963fe">*</b>                    </p>                    <aside class="note " rel="a316a465" id="00a0ac89" data-title="">                        <p id="d2a1bb45">*如果需要分析包含API调用的单元测试，则应仅使用独立的dotTrace进行性能分析。无法从Visual Studio或JetBrains Rider进行此类测试的性能分析。请参阅详细<a href="Profiling_Guidelines__Profiling_Unit_Tests.html#profile_unit_test">说明</a> 。</p>                    </aside>                </li></ol></section>    </div>    <div class="chapter"><h2 id="self-profiled-applications" data-toc="Profiling_Guidelines__Advanced_Profiling_Using_dotTrace_API#self-profiled-applications">自我介绍的应用</h2>        <p id="da78b549">顾名思义，在这种情况下，应用程序会自我配置。例如，ReSharper使用此API收集有关其在最终用户桌面上的行为的统计信息。当用户遇到性能或内存问题时，支持团队会要求用户使用特殊选项运行ReSharper（启用自我分析功能）并重现问题。然后将收集的快照发送给开发团队。</p>        <p id="c0c956a0">主要概念：</p>        <ul class="list _ul"><li class="list__item" id="0f95743e"><p>自分析API以zip存档的形式分发，可从<a href="/profiler/download/#section=dottracesdk" rel="noopener noreferrer" data-external="true" target="_blank">JetBrains网站</a>下载。</p></li><li class="list__item" id="b8379a2b"><p>自分析API不支持.NET Core应用程序。</p></li><li class="list__item" id="a329d705"><p>最终用户未安装dotTrace。因此，您必须将dotTrace可再发行文件包含在应用程序的安装包中。</p></li><li class="list__item" id="61141c89"><p>由于最终用户不应启动分析，因此API将启动自分析会话。为此，API使用静态<code class="code">SelfAttach</code>位于<span class="filepath">JetBrains中的课程<span class="filepath">。探查器。视窗。SelfApi.dll</span>库。</span></p></li><li class="list__item" id="c13b6f17"><p>的<code class="code">Attach()</code>方法准备概要分析配置，并从“可分发”文件夹中执行探查器。</p></li><li class="list__item" id="b3fc3e83">                <p id="a2c78972">配置配置由以下两类之一定义（从<code class="code">BaseSnapshotProfilingConfig</code><code class="code">BaseProfilingConfig</code>类）传递给<code class="code">Attach</code>方法：</p>                <ul class="list _ul"><li class="list__item" id="b8ea5f2c"><p>                        <code class="code">SaveSnapshotProfilingConfig</code> –生成的快照将保存在指定的文件夹中。</p></li><li class="list__item" id="a003a1fc"><p>                        <code class="code">ExecutableSnapshotProfilingConfig</code> –生成的快照将保存在指定或默认文件夹中，快照的路径作为命令行参数传递到外部应用程序。</p></li></ul>            </li><li class="list__item" id="16f1d770"><p>自谱API不<span class="control">通过线</span>支撑<span class="control">跟踪</span>和<span class="control">线</span> <a href="Profiler_Options.html#profiling_type">谱类型</a> 。</p></li></ul>        <section class="procedure-steps"><h3 id="2f15601f">在自分析应用程序中使用API</h3><ol class="list _decimal"><li class="list__item" id="681a2082"><p>下载并解压<a href="/profiler/download/#section=dottracesdk" rel="noopener noreferrer" data-external="true" target="_blank">性能分析SDK</a> 。如果您的域策略将从Internet下载的文件视为不安全，请使用文件属性中的“取消<span class="control">阻止”</span>按钮来取消阻止zip存档。</p></li><li class="list__item" id="f671423c"><p>参考<code class="code">JetBrains.Profiler.Windows.SelfApi</code>从<span class="filepath">JetBrains组装<span class="filepath">。探查器。视窗。位于SDK主目录中的SelfApi.dll</span>文件。</span></p></li><li class="list__item" id="854d531c"><p>为您的应用提供SDK可再分发文件。</p></li><li class="list__item" id="0bc59a48"><p>使用以下命令在应用程序中的某个地方启动自我分析<code class="code">SelfAttach</code>类。例如：</p><div class="code-block" data-lang="csharp">SelfAttach。附加（新的SaveSnapshotProfilingConfig（）{ProfilingControlKind = ProfilingControlKind。Api，SaveDir =“ C：\\ Temp”，RedistDir =“ C：\\ ProfilerSDK”，ProfilingType = ProfilingType。性能，ListFile =“ C：\\ snapshot_list.xml” //在分析过程中自动创建文件}）;</div><p></p></li><li class="list__item" id="99aa3ebd"><p>根据用例的要求，将对<a href="#profiling-a-specific-part-of-the">概要分析API的</a>调用插入代码中。如果您在自我分析初始化后立即开始分析，请添加一小段等待时间（ <code class="code">SelfAttach</code> API需要一些时间才能开始）：</p><div class="code-block" data-lang="none">//等到API启动一段时间（SelfAttach。状态！= SelfApiState。活动）线程。睡眠（250）; MeasureProfiler。StartCollectingData（）; ...//这里有一些我想分析MeasureProfiler的代码。保存数据（）;</div>                            <p></p></li></ol></section>    </div>    <div class="last-modified" data-skip-index="skip">上次修改时间：2019年9月19日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="Profiling_Guidelines__Launching_and_Controlling_the_Profiling_Process.html">控制性能分析会话</a> <a class="navigation-links__next" href="API_Reference.html">API参考</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>