<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>在JavaScript工作流中使用REST API方法-帮助|帮助YouTrack单机版</title><link rel="stylesheet" href="/resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="JS-Workflow-REST-API" data-breadcrumbs="Administration.xml|Administration/Workflow-Guide.xml|Workflows/Workflows-in-JavaScript.xml|JavaScript Workflow Reference/JS-Workflow-REST-API.xml|Using REST API Methods in JavaScript Workflows" data-main-title="Using REST API Methods in JavaScript Workflows"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索YouTrack独立帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>YouTrack Standalone 2019.2帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="JS-Workflow-REST-API.xml" data-toc="JS-Workflow-REST-API">在JavaScript工作流程中使用REST API方法</h1>    <p id="a9445b26">从7.0版开始，YouTrack将REST客户端实现引入工作流程API。您可以使用工作流程来编写与您喜欢的工具的推送式集成的脚本。</p>    <p id="731aade8">请参阅<a href="v1-http.html">Http</a>模块文档中的完整API参考。</p>    <p id="9c2185dd">这是一个基本示例：</p><div class="code-block" data-lang="javascript">//将问题内容发布到第三方工具，并添加响应作为注释var connection = new http。连接（'http://server.com'）; connection.addHeader（'Content-Type'，'text / html'）; var response = connection.postSync（'/ issueRegistry'，[]，issue.description）;如果（response && response.code === 200）{issue.addComment（response.response）; }</div>    <div class="chapter"><h2 id="workflow-rest-authentication" data-toc="JS-Workflow-REST-API#workflow-rest-authentication">认证方式</h2>        <p id="2318f2a5">REST客户端通过标头支持HTTP基本访问身份验证方案。要使用此方案，请计算一个base64（login：password）值并按如下所示设置授权标头：</p>        <div class="code-block" data-lang="none">connection.addHeader（'Authorization'，'Basic amsudmNAbWFFR5ydTp5b3V0cmFjaw =='）;;</div>        <p id="fd3ac69c">为每个请求设置授权标头，除非目标服务器在成功认证后提供cookie。</p>        <p id="318e289f">HTTP cookie（如果有）在后台进行透明管理。也就是说，如果任何REST调用返回cookie，它们将自动保留并提供对同一域的访问权，直到它们过期。您还可以在标题中手动设置Cookie：</p>        <div class="code-block" data-lang="none">connection.addHeader（'Cookie'，'MyServiceCookie = 732423sdfs73242'）;</div>    </div>    <div class="chapter"><h2 id="server-response" data-toc="JS-Workflow-REST-API#server-response">服务器响应</h2>        <p id="d1868eab">REST客户端将服务器响应作为对象返回，如<a href="v1-Response.html">Response中所述</a> 。</p>    </div>    <div class="chapter"><h2 id="workflow-rest-secure-connection-ssl" data-toc="JS-Workflow-REST-API#workflow-rest-secure-connection-ssl">安全连接（SSL / TLS）</h2>        <p id="3d17e371">REST客户端支持<code class="code">https://</code>开箱即用的连接。尽管当前无法在握手过程中提供客户端证书，但仍可以根据已知的证书颁发机构验证服务器证书。要了解有关将可信证书添加到YouTrack的更多信息，请参阅<a href="SSL-Certificates.html">SSL证书</a> 。</p>    </div>    <div class="chapter"><h2 id="workflow-rest-best-practices" data-toc="JS-Workflow-REST-API#workflow-rest-best-practices">最佳实践</h2>        <p id="126b85a6">为了获得最佳效果，请遵循以下准则。</p>        <ol class="list _decimal"><li class="list__item" id="ecbab4fe"><p>了解您的协议。如果您还不熟悉HTTP，那么该填补空白了。您应该至少对协议有一个基本的了解，以编写集成和解密错误的脚本。</p></li><li class="list__item" id="1dba4d53"><p>了解您的API。您将要与YouTrack集成的最喜欢的应用程序几乎可以肯定地具有说明如何使用其API的文档。在开始编写集成脚本之前，请先进行检查。例如，这是<a href="https://pastebin.com/api/" rel="noopener noreferrer" data-external="true" target="_blank">Pastebin服务</a>的手册。</p></li><li class="list__item" id="5e3e29bc"><p>使用日志记录。记录错误以及其他所有内容<code class="code">console.log(...)</code> 。</p></li><li class="list__item" id="b665f807"><p>使用第三方REST客户端来确保您的请求格式正确。诸如<span class="control">cURL</span> ， <span class="control">Wget</span>或Chrome的<span class="control">Postman</span>扩展程序之类的客户端中的诊断工具可以帮助您找出工作流程未按预期运行的原因。</p></li><li class="list__item" id="f4dcec92"><p>不要忘记添加<code class="code">Content-Type</code>和<code class="code">Accept</code>您请求的标头。那里的大多数API都依赖这些标头，并拒绝没有它们的工作。</p></li></ol>    </div>    <div class="chapter"><h2 id="workflow-rest-case-studies" data-toc="JS-Workflow-REST-API#workflow-rest-case-studies">实例探究</h2>        <p id="4e16e1be">以下案例研究说明了如何使用工作流REST API将YouTrack与外部应用程序集成。</p>        <div class="chapter"><h3 id="workflow-rest-pastebin-integratoin">Pastebin整合</h3>            <p id="1fe6b008"><a href="https://pastebin.com/" rel="noopener noreferrer" data-external="true" target="_blank">Pastebin</a>是一个网站，您可以在此网站上在线存储一段时间。您可以粘贴任何文本字符串，例如代码片段和从日志文件中提取的内容。</p>            <p id="036b1983">在本案例研究中，我们从新问题中提取代码片段，并将其存储在Pastebin中。问题说明保留指向已移至Pastebin的内容的链接。以下工作流程规则演示了如何实现此方案：</p><div class="code-block" data-lang="javascript">var实体= require（'@ jetbrains / youtrack-scripting-api / entities'）; var http = require（'@ jetbrains / youtrack-scripting-api / http'）; var工作流程= require（'@ jetbrains / youtrack-scripting-api / workflow'）; Exports.rule =实体。Issue.onChange（{标题：“导出到Pastebin.com”，操作：function（ctx）{var issue = ctx.issue; if（issue.becomesReported ||（issue.isReported && issue.isChanged（'description'））） } {//查找问题描述中的代码示例：代码标记令牌之间的文本。var findCode = function（）{var start = issue.description.indexOf（'{code}'）;如果（开始！== -1）{var end = issue.description.indexOf（'{code}'，开始+ 1）;如果（结束！== -1）{返回issue.description.substring（开始+ 6，结束）;返回''; }; var code = findCode（）;如果（code.length！== 0）{var连接=新的http。连接（'https://pastebin.com'）; connection.addHeader（'Content-Type'，'application / x-www-form-urlencoded'）; // Pastebin仅接受表单，因此我们将所有内容打包为表单字段。//通过api开发人员密钥执行的身份验证。var有效负载= []; payload.push（{name：'api_option'，value：'paste'}）; payload.push（{name：'api_dev_key'，value：'98bcac75e1e327b54c08947ea1dbcb7e'}）; payload.push（{name：'api_paste_private'，value：1}）; payload.push（{name：'api_paste_name'，value：'问题的代码示例'+ issue.id}）; payload.push（{name：'api_paste_code'，value：code.trim（）}）; var response = connection.postSync（'/ api / api_post.php'，[]，有效负载）;如果（response.code === 200 && response.response.indexOf（'https://pastebin.com/'）！== -1）{var url = response.response; issue.description = issue.description.replace（'{code}'+代码+'{code}'，'请参见'+ url上的示例）; stream.message（'代码示例移至<a href="' + url + '">'+ url +“</a> ”）; } else {workflow.message（'由于以下原因，无法替换代码：'+ response.response）; }}}}））；</div>            <p id="25d53f53">另一方面，我们可能想做相反的事情：将遇到的任何Pastebin链接扩展为代码段，即下载并插入问题。让我们尝试编写代码：</p><div class="code-block" data-lang="javascript">var实体= require（'@ jetbrains / youtrack-scripting-api / entities'）; var http = require（'@ jetbrains / youtrack-scripting-api / http'）; var工作流程= require（'@ jetbrains / youtrack-scripting-api / workflow'）; Exports.rule =实体。Issue.onChange（{ ）{var baseUrl =“ https://pastebin.com/”; var urlBaseLength = baseUrl.length; //检查问题描述是否包含指向pastebin的链接。var linkStart = issue.description.indexOf（baseUrl）;如果（linkStart！== -1）{//因此，我们找到了一个链接，让我们提取密钥并通过API下载内容。 var pasteKey = issue.description.substring（linkStart + urlBaseLength，linkStart + urlBaseLength + 8）; var connection =新的http。连接（'https://pastebin.com'）; var response = connection.getSync（'/ raw /'+ pasteKey，[]）;如果（response.code === 200）{var url = baseUrl + pasteKey; issue.description = issue.description.replace（URL，'{code}'+ response.response +'{code}'）; stream.message（'代码示例从<a href="' + url + '">'+ url +“</a> ”）移出； } else {workflow.message（由于以下原因，无法导入代码：“ + response.response）； }}}}））；</div>        </div>        <div class="chapter"><h3 id="workflow-rest-harvest-integration-time-tracking">使用Harvest Web服务进行自定义时间跟踪</h3>            <p id="4c83dd66">假设我们要为在YouTrack中记录的工作时间向客户收费。问题在于，YouTrack并非真正用于管理发票以及将花费的时间与特定客户相关联。与专用时间跟踪服务的集成可以使生活变得更加轻松。</p>            <p id="fd928ba6">首先，让我们为以下所有脚本介绍一个公共部分：一个<span class="control">公共</span>自定义脚本，其中包含连接初始化和公共有效负载字段：</p>            <div class="code-block" data-lang="javascript">var http = require（'@ jetbrains / youtrack-scripting-api / http'）; exports.userIds = {'jane.smith'：'1790518'，'john.black'：'1703589'}; Exports.initConnection = function（）{var connection = new http。连接（'https://yourapp.harvestapp.com'）; //参见http://help.getharvest.com/api-v1/authentication/authentication/http-basic/ connection.addHeader（'Authorization'，'Basic bXJzLm1hcml5YS8kYXZ5ZG94YUBnbWFpbC0jb206a3V6eWEyMDA0'）; connection.addHeader（'Accept'，'application / json'）; connection.addHeader（'Content-Type'，'application / json'）;返回连接； }; Exports.initPayload = function（user）{return {project_id：'14383202'，task_id：'8120350'，user_id：exports.userIds [user.login]}; };</div>            <p id="9d110ab4">一种可能的情况是引入自定义字段- <span class="control">计费时间</span> -并将对该字段值的更改发布到Harvest Web服务。</p>            <div class="code-block" data-lang="javascript">var实体= require（'@ jetbrains / youtrack-scripting-api / entities'）; var工作流程= require（'@ jetbrains / youtrack-scripting-api / workflow'）; var common = require（'./ common'）; Exports.rule =实体。Issue.onChange（{title：'Post Work Item'，action：function（ctx）{var issue = ctx.issue; if（issue.fields.isChanged（ctx。小时））{var hours =（issue.fields。小时|| 0）-（issue.fields.oldValue（ctx。小时）|| 0）; var connection = common.initConnection（）; var有效负载= common.initPayload（ctx.currentUser）; payload.hours =小时； var response = connection.postSync（'/ daily / add'，[]，有效负载）; if（response && response.code === 201）{workflow.message（'一个工作项已添加到Harvest！'）; } else {工作流。消息（“将工作项添加到Harvest时出了点问题：'+响应）； }}}，要求：{小时：{类型：实体。Field.integerType，名称：“计费时间”}}}）;</div>            <p id="d6e159b2">让我们考虑另一种选择：开始时间跟踪，当一个问题移动到<span class="control">正在进行</span>状态和停止时间的跟踪，当问题得到解决。对我们来说幸运的是，Harvest有一个计时器API，我们可以使用它远程启动和停止计时器。必须使用<span class="control">Harvest ID</span>自定义字段来存储计时器标识符。</p>            <div class="code-block" data-lang="javascript">var实体= require（'@ jetbrains / youtrack-scripting-api / entities'）; var工作流程= require（'@ jetbrains / youtrack-scripting-api / workflow'）; var common = require（'./ common'）; Exports.rule =实体。Issue.onChange（{title：'Start Timer'，action：function（ctx）{var issue = ctx.issue; if（issue.fields.becomes（ctx。状态，ctx。State ['In Progress']））{var connection = common.initConnection（）; var有效负载= common.initPayload（ctx.currentUser）; var response = connection.postSync（'/ daily / add'，[]，有效负载）; if（response && response.code === 201）{issue.fields。HID = JSON.parse（response.response）.id; stream.message（'计时器在Harvest处启动！'）; } else {工作流。消息（“在Harvest处启动计时器时发生错误：'+响应）； }}}，要求：{HID：{类型：实体。Field.stringType，名称：“ Harvest ID”}，状态：{type：实体。State.fieldType，“进行中”：{}}}}）；</div>            <p id="ec2829d2">解决问题后，以下工作流程规则将停止Harvest计时器。</p>            <div class="code-block" data-lang="javascript">var实体= require（'@ jetbrains / youtrack-scripting-api / entities'）; var工作流程= require（'@ jetbrains / youtrack-scripting-api / workflow'）; var common = require（'./ common'）; Exports.rule =实体。Issue.onChange（{title：'Stop Timer'，action：function（ctx）{var issue = ctx.issue; if（issue.becomesResolved && issue.fields。HID）{var connection = common.initConnection（）; var response = connection.getSync（'/ daily / timer /'+ issue.fields。HID）; if（response && response.code === 200）{working.message（'计时器在Harvest处停止！'）; } else {工作流。消息（'在Harvest停止计时器时发生错误：'+响应）； }}}，要求：{HID：{类型：实体。Field.stringType，名称：“收获ID”}}}）；</div>        </div>    </div><div class="last-modified" data-skip-index="skip">上次修改时间：2019年11月29日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="Slack-Integration-HTML.html">使用Slack</a> <a class="navigation-links__next" href="Workflow-Localization.html">本地化工作流消息</a> <a class="navigation-links__prev" href="Slack-Integration-HTML.html">构建集成</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>