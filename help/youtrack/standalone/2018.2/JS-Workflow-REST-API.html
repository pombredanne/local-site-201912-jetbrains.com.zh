<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/help/app/v2/analytics.js"></script><meta charset="UTF-8"><meta name="robots" content="noindex"><title>Using REST API Methods in JavaScript Workflows - Help | YouTrack Standalone</title><link rel="stylesheet" href="/help/app/v2/app.css"></head><body data-id="JS-Workflow-REST-API"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search YouTrack Standalone Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>YouTrack Standalone 2018.2 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="false"><h1 data-toc="JS-Workflow-REST-API" id="JS-Workflow-REST-API.xml">Using REST API Methods in JavaScript Workflows</h1>    <p id="52d01010">Since release 7.0 YouTrack brings REST client implementation to the workflow API.    You can use workflows to script push-style integrations with your favorite tools.</p>    <p id="a84fab69">See complete API reference in <a href="v1-http.html">Http</a> module documentation.</p>    <p id="0e057bf5">Here's a basic example:</p><div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="c1">// Post issue content to third-party tool and add response as a comment</span>
<span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Connection</span><span class="p">(</span><span class="s1">&#39;http://server.com&#39;</span><span class="p">);</span>
<span class="nx">connection</span><span class="p">.</span><span class="nx">addHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">postSync</span><span class="p">(</span><span class="s1">&#39;/issueRegistry&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">issue</span><span class="p">.</span><span class="nx">addComment</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
<span class="p">}</span></code></div>    <div class="chapter"><h2 id="workflow-rest-authentication" data-toc="JS-Workflow-REST-API#workflow-rest-authentication">Authentication</h2>        <p id="98e110a6">The REST client supports the HTTP basic access authentication scheme via headers.        To utilize this scheme, compute a base64(login:password) value and set the authorization header as follows:</p>        <div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">connection</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="err">&#39;</span><span class="n">Authorization</span><span class="err">&#39;</span><span class="o">,</span> <span class="err">&#39;</span><span class="n">Basic</span> <span class="n">amsudmNAbWFFR5ydTp5b3V0cmFjaw</span><span class="o">==</span><span class="err">&#39;</span><span class="o">);</span></code></div>        <p id="fc6454cd">Set the authorization header for every request, unless the target server provides cookies upon successful authentication.</p>        <p id="d19cc187">HTTP cookies are managed transparently under the hood, when present.        That is, if any REST call returns cookies, they persist automatically and provide access to the same domain until they expire.        You can also set cookies manually in the header:</p>        <div class="code-block" data-lang="Java"><code class="code-block__wrapper"><span class="n">connection</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="err">&#39;</span><span class="n">Cookie</span><span class="err">&#39;</span><span class="o">,</span> <span class="err">&#39;</span><span class="n">MyServiceCookie</span><span class="o">=</span><span class="mi">732423</span><span class="n">sdfs73242</span><span class="err">&#39;</span><span class="o">);</span></code></div>    </div>    <div class="chapter"><h2 id="server-response" data-toc="JS-Workflow-REST-API#server-response">Server Response</h2>        <p id="c43176c1">The REST client returns the server response as an object, described in        <a href="v1-Response.html">Response</a>.</p>    </div>    <div class="chapter"><h2 id="workflow-rest-secure-connection-ssl" data-toc="JS-Workflow-REST-API#workflow-rest-secure-connection-ssl">Secure Connections (SSL/TLS)</h2>        <p id="48ab5cea">The REST client supports <code class="code" data-lang="Java">https://</code> connections out of the box.        Although it's currently unable to present a client certificate during the handshake,        it can still validate a server certificate against known certificate authorities.        To learn more about adding trusted certificates to YouTrack, see <a href="SSL-Certificates.html"><span>SSL Certificates</span></a>.</p>    </div>    <div class="chapter"><h2 id="workflow-rest-best-practices" data-toc="JS-Workflow-REST-API#workflow-rest-best-practices">Best Practices</h2>        <p id="c37a2f67">For best results, observe the following guidelines.</p>        <ol class="list _decimal"><li class="list__item" id="1dd05095"><p>Know your protocol. If you're not yet familiar with HTTP, it's time to fill the gap.                You should have at least a basic understanding of the protocol to script the integration and decrypt errors.</p></li><li class="list__item" id="2faca449"><p>Know your API. Your favorite application that you're going to integrate with YouTrack almost certainly                has documentation that tells you how to use their API.                Check it out before you start to script an integration.                For instance, here's a manual for the <a href="http://pastebin.com/api/" data-external="true" target="_blank" rel="noopener noreferrer"><span>Pastebin service</span></a>.</p></li><li class="list__item" id="c795bf5f"><p>Use logging. Log errors and everything else with <code class="code" data-lang="Java">console.log(...)</code>.</p></li><li class="list__item" id="7c58f92d"><p>Use a third-party REST client to make sure your requests are formatted correctly.                Diagnostic tools in clients like <span class="control">cURL</span>, <span class="control">Wget</span>                or the <span class="control">Postman</span> extension for Chrome can help you to find out                why your workflow is not acting as expected.</p></li><li class="list__item" id="002f2e8a"><p>Don't forget to add <code class="code" data-lang="Java">Content-Type</code> and <code class="code" data-lang="Java">Accept</code> headers to your requests.                The majority of APIs out there rely on these headers and refuse to work without them.</p></li></ol>    </div>    <div class="chapter"><h2 id="workflow-rest-case-studies" data-toc="JS-Workflow-REST-API#workflow-rest-case-studies">Case Studies</h2>        <p id="d2e1617f">The following case studies illustrate how you can use the workflow REST API to integrate YouTrack with an external application.</p>        <div class="chapter"><h3 id="workflow-rest-pastebin-integratoin">Pastebin Integration</h3>            <p id="f7742b77"><a href="http://pastebin.com/" data-external="true" target="_blank" rel="noopener noreferrer"><span>Pastebin</span></a> is a  website where you can store text online for a set period of time.            You can paste any string of text like code snippets and extracts from log files.</p>            <p id="ddcea79d">In this case study, we extract code snippets from new issues and store them on Pastebin instead.            The issue description retains a link to the content that is moved to Pastebin.            The following workflow rule demonstrates how this scenario is implemented:</p><div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/entities&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/workflow&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Issue</span><span class="p">.</span><span class="nx">onChange</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Export to Pastebin.com&#39;</span><span class="p">,</span>
    <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">issue</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">becomesReported</span> <span class="o">||</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">isReported</span> <span class="o">&amp;&amp;</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">isChanged</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)))</span> <span class="p">{</span>
            <span class="c1">// Find a code sample in issue description: the text between code markup tokens.</span>
            <span class="kd">var</span> <span class="nx">findCode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;{code}&#39;</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">start</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;{code}&#39;</span><span class="p">,</span> <span class="nx">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">end</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="p">};</span>

            <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">findCode</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">code</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Connection</span><span class="p">(</span><span class="s1">&#39;http://pastebin.com&#39;</span><span class="p">);</span>
                <span class="nx">connection</span><span class="p">.</span><span class="nx">addHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">);</span>

                <span class="c1">// Pastebin accepts only forms, so we pack everything as form fields.</span>
                <span class="c1">// Authentication of performed via api developer key.</span>
                <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="p">[];</span>
                <span class="nx">payload</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;api_option&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;paste&#39;</span><span class="p">});</span>
                <span class="nx">payload</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;api_dev_key&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;98bcac75e1e327b54c08947ea1dbcb7e&#39;</span><span class="p">});</span>
                <span class="nx">payload</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;api_paste_private&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="mi">1</span><span class="p">});</span>
                <span class="nx">payload</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;api_paste_name&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;Code sample from issue &#39;</span> <span class="o">+</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">id</span><span class="p">});</span>
                <span class="nx">payload</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;api_paste_code&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">code</span><span class="p">.</span><span class="nx">trim</span><span class="p">()});</span>

                <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">postSync</span><span class="p">(</span><span class="s1">&#39;/api/api_post.php&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">payload</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;https://pastebin.com/&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span>
                    <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;{code}&#39;</span> <span class="o">+</span> <span class="nx">code</span> <span class="o">+</span> <span class="s1">&#39;{code}&#39;</span><span class="p">,</span>
                                                                  <span class="s1">&#39;See sample at &#39;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">);</span>
                    <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Code sample is moved at &#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Failed to replace code due to: &#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></code></div>            <p id="c93b3693">On the other hand, we may want to do the opposite: to expand any Pastebin link we met into a code snippet,            i.e. to download it and insert into issue. Let's try to code it:</p><div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/entities&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/workflow&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Issue</span><span class="p">.</span><span class="nx">onChange</span><span class="p">({</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Import from Pastebin.com&#39;</span><span class="p">,</span>
    <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">issue</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">becomesReported</span> <span class="o">||</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">isReported</span> <span class="o">&amp;&amp;</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">isChanged</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s2">&quot;https://pastebin.com/&quot;</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">urlBaseLength</span> <span class="o">=</span> <span class="nx">baseUrl</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

            <span class="c1">// Check, if issue description contains a link to pastebin.</span>
            <span class="kd">var</span> <span class="nx">linkStart</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">linkStart</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// So we found a link, let&#39;s extract the key and download the contents via API.</span>
                <span class="kd">var</span> <span class="nx">pasteKey</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">linkStart</span> <span class="o">+</span> <span class="nx">urlBaseLength</span><span class="p">,</span> <span class="nx">linkStart</span> <span class="o">+</span> <span class="nx">urlBaseLength</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Connection</span><span class="p">(</span><span class="s1">&#39;http://pastebin.com&#39;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">getSync</span><span class="p">(</span><span class="s1">&#39;/raw/&#39;</span> <span class="o">+</span> <span class="nx">pasteKey</span><span class="p">,</span> <span class="p">[]);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">baseUrl</span> <span class="o">+</span> <span class="nx">pasteKey</span><span class="p">;</span>
                    <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s1">&#39;{code}&#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">response</span> <span class="o">+</span> <span class="s1">&#39;{code}&#39;</span><span class="p">);</span>
                    <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Code sample is moved from &#39;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Failed to import code due to: &#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span></code></div>        </div>        <div class="chapter"><h3 id="workflow-rest-harvest-integration-time-tracking">Custom Time Tracking with the Harvest Web Service</h3>            <p id="95b1235b">Suppose that we want to bill customers for the working hours that we record in YouTrack.            The problem is that YouTrack isn't really built for managing invoices and associating spent time with specific customers.            An integration with a dedicated time tracking service can make life a lot easier.</p>            <p id="a062ff95">Let's first introduce a common part for all scripts below: a <span class="control">common</span> custom script,            containing connection initialization and common payload fields:</p>            <div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/http&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">userIds</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;jane.smith&#39;</span><span class="o">:</span> <span class="s1">&#39;1790518&#39;</span><span class="p">,</span>
  <span class="s1">&#39;john.black&#39;</span><span class="o">:</span> <span class="s1">&#39;1703589&#39;</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">initConnection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Connection</span><span class="p">(</span><span class="s1">&#39;https://yourapp.harvestapp.com&#39;</span><span class="p">);</span>
  <span class="c1">// see http://help.getharvest.com/api-v1/authentication/authentication/http-basic/</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">addHeader</span><span class="p">(</span><span class="s1">&#39;Authorization&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Basic bXJzLm1hcml5YS8kYXZ5ZG94YUBnbWFpbC0jb206a3V6eWEyMDA0&#39;</span><span class="p">);</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">addHeader</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
  <span class="nx">connection</span><span class="p">.</span><span class="nx">addHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">connection</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">initPayload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">project_id</span><span class="o">:</span> <span class="s1">&#39;14383202&#39;</span><span class="p">,</span>
    <span class="nx">task_id</span><span class="o">:</span> <span class="s1">&#39;8120350&#39;</span><span class="p">,</span>
    <span class="nx">user_id</span><span class="o">:</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">userIds</span><span class="p">[</span><span class="nx">user</span><span class="p">.</span><span class="nx">login</span><span class="p">]</span>
  <span class="p">};</span>
<span class="p">};</span></code></div>            <p id="eae0ad9b">One possible scenario is to introduce a custom field - <span class="control">Billable hours</span> -            and post changes to the value of this field to the Harvest web service.</p>            <div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/entities&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/workflow&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">common</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./common&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Issue</span><span class="p">.</span><span class="nx">onChange</span><span class="p">({</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Post Work Item&#39;</span><span class="p">,</span>
  <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">issue</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">isChanged</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Hours</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">hours</span> <span class="o">=</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">Hours</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">oldValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Hours</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">initConnection</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">initPayload</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">);</span>
      <span class="nx">payload</span><span class="p">.</span><span class="nx">hours</span> <span class="o">=</span> <span class="nx">hours</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">postSync</span><span class="p">(</span><span class="s1">&#39;/daily/add&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">payload</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">201</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;A work item was added to Harvest!&#39;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Something went wrong when adding a work item to Harvest: &#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">requirements</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">Hours</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Field</span><span class="p">.</span><span class="nx">integerType</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Billable hours&#39;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></code></div>            <p id="8907dfc9">Let's consider another option: start time tracking when an issue moves to an            <span class="control">In Progress</span> state and stop time tracking when the issue is resolved.            Lucky for us, Harvest has a timer API that we can use to start and stop the timers remotely.            The <span class="control">Harvest ID</span> custom field is required to store the timer identifier.</p>            <div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/entities&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/workflow&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">common</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./common&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Issue</span><span class="p">.</span><span class="nx">onChange</span><span class="p">({</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Start Timer&#39;</span><span class="p">,</span>
  <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">issue</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">becomes</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">State</span><span class="p">[</span><span class="s1">&#39;In Progress&#39;</span><span class="p">]))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">initConnection</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">payload</span> <span class="o">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">initPayload</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">currentUser</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">postSync</span><span class="p">(</span><span class="s1">&#39;/daily/add&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nx">payload</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">201</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">HID</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">response</span><span class="p">).</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;A timer is started at Harvest!&#39;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Something went wrong when starting a timer at Harvest: &#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">requirements</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">HID</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Field</span><span class="p">.</span><span class="nx">stringType</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Harvest ID&#39;</span>
    <span class="p">},</span>
    <span class="nx">State</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">State</span><span class="p">.</span><span class="nx">fieldType</span><span class="p">,</span>
      <span class="s1">&#39;In Progress&#39;</span><span class="o">:</span> <span class="p">{}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></code></div>            <p id="6e580f82">The following workflow rule stops the Harvest timer when an issue is resolved.</p>            <div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/entities&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/workflow&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">common</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./common&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Issue</span><span class="p">.</span><span class="nx">onChange</span><span class="p">({</span>
  <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Stop Timer&#39;</span><span class="p">,</span>
  <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">issue</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">becomesResolved</span> <span class="o">&amp;&amp;</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">HID</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">connection</span> <span class="o">=</span> <span class="nx">common</span><span class="p">.</span><span class="nx">initConnection</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">.</span><span class="nx">getSync</span><span class="p">(</span><span class="s1">&#39;/daily/timer/&#39;</span> <span class="o">+</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">HID</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;A timer is stopped at Harvest!&#39;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">workflow</span><span class="p">.</span><span class="nx">message</span><span class="p">(</span><span class="s1">&#39;Something went wrong when stopping a timer at Harvest: &#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">requirements</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">HID</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Field</span><span class="p">.</span><span class="nx">stringType</span><span class="p">,</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Harvest ID&#39;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></code></div>        </div>    </div><div class="last-modified" data-skip-index="skip">Last modified: 7 March 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="using-workflow-api.html">Using the Workflow API</a><a class="navigation-links__next" href="Workflow-Localization.html">Localization</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/help/app/v2/app.js"></script></body></html>