<html lang="en-US" ><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>反向代理配置-帮助|帮助YouTrack单机版</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body  data-id="Reverse-Proxy-Configuration" data-breadcrumbs="Installation-and-Upgrade.xml|Installation and Upgrade/Reverse-Proxy-Configuration.xml|Reverse Proxy Configuration" data-main-title="Reverse Proxy Configuration"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label class="search-box__label" for="search-box__input"><input type="text" class="search-box__input" id="search-box__input" placeholder="搜索YouTrack独立帮助"></label><div class="search-box__clear" title="明确"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">发送反馈</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>YouTrack Standalone 2019.2帮助</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">按键图：</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 id="Reverse-Proxy-Configuration.xml" data-toc="Reverse-Proxy-Configuration">反向代理配置</h1>    <p id="b1ea97b6">您可以将YouTrack设置为在反向代理服务器后面工作。</p>    <aside class="prompt" rel="b1ea97b6" id="ea725aee" data-type="note" data-title="">        <p id="d7a257d1">如果您使用第三方代理的唯一原因是为了确保YouTrack服务器与其客户端之间的连接安全，请考虑使用内置TLS。</p>        <ul class="list _ul"><li class="list__item" id="7f361e69"><p>您可以在安装或升级期间在“配置向导”中配置和启用它。有关详细信息，请参阅“ <a href="configure-server-tls-configuration-wizard.html">基于Web的配置向导”中的“配置内置TLS”</a> 。</p></li><li class="list__item" id="cdac9fc1"><p>您也可以从命令行为现有的YouTrack安装配置HTTPS。有关详细信息，请参阅<a href="configure-server-tls-from-command-line.html">从命令行配置内置TLS</a> 。</p></li></ul>    </aside>    <p id="4ae260cd">反向代理设置包括以下步骤：</p>    <ol class="list _decimal"><li class="list__item" id="a08c3301">            <a href="#change-base-url">配置YouTrack使其指向代理服务器的基本URL。</a>        </li><li class="list__item" id="de408fe6"><p><a href="#Configure_Headers">配置代理服务器的标头</a> 。该页面包含有关<a href="#Apache_Config">Apache</a> ， <a href="#IIS_Config">IIS</a>和<a href="#Nginx_Config">NGINX</a>服务器的指南。</p></li></ol>    <div class="chapter"><h2 id="prerequisites" data-toc="Reverse-Proxy-Configuration#prerequisites">先决条件</h2>        <p id="e06dfebb">为了从YouTrack安装中获得最佳性能，您的代理服务器应支持HTTP / 2。对于大多数服务器，HTTP / 2协议仅适用于HTTPS连接，这意味着您需要使用SSL / TLS证书保护连接的安全。</p>        <p id="b83b30c4">您还需要确保反向代理服务器使用的OpenSSL库为1.0.2版或更高版本。在早期版本的OpenSSL中，用户使用旧版HTTP / 1.1规范进行连接，而该规范缺乏HTTP / 2连接的性能优势。</p>        <p id="2fee80d0">本页上的说明假定满足这些要求。使用以下列表来确定完成此设置所需的服务器版本：</p>        <div class="table-wrapper"><table width="100%" id="a9f5ba88"><thead><tr id="e337803e" class="ijRowHead"><th id="a3a6e00c"><p>服务器</p></th><th id="c0023427"><p>最低版本</p></th></tr></thead><tbody><tr id="634574f4" class="ijRowOdd"><td id="c36d794e"><p>阿帕奇</p></td><td id="9b905514"><p>2.4.17</p></td></tr><tr id="6539bc08" class="ijRowEven"><td id="eea53d24"><p>IIS</p></td><td id="4b5136ed"><p>10.0版本1709</p></td></tr><tr id="b1bd2fdf" class="ijRowOdd"><td id="d2edb8d7"><p>NGINX</p></td><td id="3c5abced"><p>1.11.7</p></td></tr></tbody></table></div>        <div class="chapter"><h3 id="http-strict-transport-security">HTTP严格传输安全</h3>        <p id="ce7028fd">我们也强烈建议您将反向代理服务器设置为使用HTTP严格传输安全性（HSTS）。这可以保护您的安装免受可能的中间人攻击，在中间人攻击中，可以利用从站点到HTTPS版本的重定向将用户定向到恶意站点，而不是原始页面的安全版本。</p>        <p id="d3ca20b1">本页上提供的代理服务器标头配置说明包括支持HSTS的指令。</p>        </div>        <div class="chapter"><h3 id="worker-connections">工人连接的性能优化</h3>            <p id="8946a779">您还需要优化服务器的性能设置，以允许足够数量的YouTrack连接。支持实时更新的页面需要这些连接。如果连接数量不足，或者正在通过纯HTTP提供页面，则在新选项卡中打开的问题和敏捷板将为空白，正在加载或部分加载。</p>        <p id="b1a8ef26">与连接有关的伪指令的确切值根据服务器负载而有所不同。使用用于反向代理的诊断工具来确定是否提供足够的连接并相应地调整这些值。</p>        </div>    </div>    <div class="chapter"><h2 id="change-base-url" data-toc="Reverse-Proxy-Configuration#change-base-url">更改您的YouTrack服务器的基本URL</h2>        <p id="f7b9401e">您可以使用以下过程来更改ZIP和MSI分发的基本URL。要在MSI分发中执行这些命令，请以管理员身份打开“ <span class="control">命令提示符”</span>窗口。始终执行<code class="code">configure</code>命令代表运行YouTrack服务的OS用户。此命令创建配置文件和文件夹。YouTrack服务用户应具有足够的权限来访问这些文件和文件夹。</p>        <section class="procedure-steps"><h3 id="ad66a572">要更改ZIP或MSI分发的基本URL，请执行以下操作：</h3><ol class="list _decimal"><li class="list__item" id="cb4108dc"><p id="1fb41719">停止YouTrack服务。有关具体说明，请参见<a href="Stop-and-Start-YouTrack.html">停止和启动YouTrack</a> 。</p>                <aside class="prompt" rel="1fb41719" id="10835230" data-type="note" data-title="">                    <p id="a61eee3b">此过程的所有命令均针对Linux和macOS编写。</p>                    <p id="95ce71a3">对于Windows安装，请更换<code class="code">.sh</code>与<code class="code">.bat</code>并使用反斜杠。</p>                </aside>            </li><li class="list__item" id="68a7ed7c"><p id="ac33ad94">在命令行界面中，将目录更改为<code class="code"><youtrack_home>/bin/</code> 。</p>                <ul class="list _ul"><li class="list__item" id="fce9838a"><p>对于ZIP安装， <code class="code"><youtrack_home></code> directory是安装过程中解压缩ZIP分发包的位置。</p></li><li class="list__item" id="7fff4ad7"><p>对于MSI安装， <code class="code"><youtrack_home></code>目录是YouTrack的安装位置。</p></li></ul>            </li><li class="list__item" id="da3366f9"><p id="55e7fb84">输入以下命令：</p>                <div class="code-block" data-lang="bash">youtrack.sh配置--listen-port 1111 --base-url https://youtrack.mydomain.com:XXXX</div>                <ul class="list _bullet"><li class="list__item" id="02ced0b8"><p>                        <code class="code">1111</code>是您的YouTrack服务器监听的端口号。</p></li><li class="list__item" id="84bbaca9"><p>                        <code class="code">https://youtrack.mydomain.com</code>是您的代理服务器的地址。</p></li><li class="list__item" id="5b8bc32f"><p>                        <code class="code">XXXX</code>是您的代理服务器侦听的端口号。</p></li></ul>            </li><li class="list__item" id="2857a358"><p>在代理服务器中配置标头。请遵循适用于您的<a href="#Apache_Config">Apache</a> ， <a href="#IIS_Config">IIS</a>或<a href="#Nginx_Config">NGINX</a>服务器的准则。</p></li><li class="list__item" id="f297a779"><p>启动YouTrack服务。有关具体说明，请参见<a href="Stop-and-Start-YouTrack.html">停止和启动YouTrack</a> 。</p></li></ol></section>        <section class="procedure-steps"><h3 id="change-base-url-jar">要更改JAR分发的基本URL，请执行以下操作：</h3><ol class="list _decimal"><li class="list__item" id="0b849c62"><p>                <a href="start-stop-jar.html">停止YouTrack服务</a> 。</p></li><li class="list__item" id="001d8d52"><p id="898df3f2">跑过<code class="code">configure</code> YouTrack服务的命令：</p>                <div class="code-block" data-lang="bash">java -jar youtrack- <version>.jar configure</version> --listen <version>-port 1111 --base-url https://youtrack.mydomain.com:XXXX</version></div>                <ul class="list _bullet"><li class="list__item" id="63fc61fb"><p>                        <code class="code">1111</code>是您的YouTrack服务器监听的端口号。</p></li><li class="list__item" id="661c74f4"><p>                        <code class="code">https://youtrack.mydomain.com</code>是您的代理服务器的地址。</p></li><li class="list__item" id="407953e3"><p>                        <code class="code">XXXX</code>是您的代理服务器侦听的端口号。</p></li></ul>            </li><li class="list__item" id="fa0c9d0b"><p>在代理服务器中配置标头。请遵循适用于您的<a href="#Apache_Config">Apache</a> ， <a href="#IIS_Config">IIS</a>或<a href="#Nginx_Config">NGINX</a>服务器的准则。</p></li><li class="list__item" id="09cf9ce8"><p>启动YouTrack服务。</p></li></ol></section>        <section class="procedure-steps"><h3 id="94fdd320">要在Docker容器中更改YouTrack服务的基本URL：</h3><ol class="list _decimal"><li class="list__item" id="2792e321"><p>停止追踪： <code class="code">docker exec <containerId> stop</code>            </p></li><li class="list__item" id="0c5c4725">                <p id="d1fe9dcb">执行以下命令：</p>                <div class="code-block" data-lang="bash">docker run --rm -it \ -v <path to="" conf="" directory="">：/ opt / youtrack / conf \ jetbrains / youtrack： <version>\配置--base-url = https：//youtrack.mydomain.com：XXXX</version></path></div>                <ul class="list _bullet"><li class="list__item" id="59455554"><p>                        <code class="code">https://youtrack.mydomain.com</code>是您的代理服务器的地址。</p></li><li class="list__item" id="95e7ea59"><p>                        <code class="code">XXXX</code>是您的代理服务器侦听的端口号。</p></li></ul>                <p id="e8ac4b3f"><span class="emphasis">重要说明：</span>对于Docker容器，容器内的应用程序侦听端口未更改。这就是为什么在所提供的命令中未提及它。相反，您应该配置代理服务器以将所有流量传递到映射到容器内应用程序侦听端口<span class="emphasis">的主机端口</span> 。主机端口配置有<code class="code">-p</code>执行时的参数<code class="code">docker run</code>命令：</p>                    <code class="code">-p {port on the host machine to pass the traffic from proxy}:8080</code>            </li><li class="list__item" id="51cdd8d3">                <p id="77c70861">启动YouTrack： <code class="code">docker start <containerId></code>                </p>            </li></ol></section>    </div>    <div class="chapter"><h2 id="Configure_Headers" data-toc="Reverse-Proxy-Configuration#Configure_Headers">配置代理服务器头</h2>        <p id="689649ed">要在代理服务器中配置标头，请遵循特定于服务器的准则。下面提供了Apache HTTP Server，IIS，NGINX和Pound的配置指南。</p>        <div class="chapter"><h3 id="Apache_Config">Apache HTTP服务器配置</h3>            <p id="9e0e7566">要将Apache HTTP Server用作反向代理，您需要运行<code class="code">a2enmod</code>脚本并将指令添加到<code class="code">.conf</code>文件在您的服务器上。</p>            <p id="27312aac">需要Apache httpd 2.4.17或更高版本。</p>            <section class="procedure-steps"><h3 id="d7cb256b">要将Apache HTTP Server设置为反向代理，请执行以下操作：</h3><ol class="list _decimal"><li class="list__item" id="540fe59b"><p>使用以下<code class="code">a2enmod</code>脚本来启用<code class="code">headers</code> ， <code class="code">rewrite</code> ， <code class="code">proxy_http</code> ， <code class="code">ssl</code>和<code class="code">http2</code>模块：</p><div class="code-block" data-lang="apacheconf">$ a2enmod标头$ a2enmod重写$ a2enmod proxy_http $ a2enmod ssl $ a2enmod http2</div>                <p></p></li><li class="list__item" id="10c84ab3"><p>将以下指令添加到<code class="code">VirtualHost</code>相关部分<code class="code">.conf</code>文件：</p><div class="code-block" data-lang="apacheconf">协议h2 http / 1.1 RequestHeader在ProxyRequests上的AllowEncodedSlashes上设置了X-Forwarded-Proto“ https” RewriteEngine在ProxyPass / http://127.0.0.1:1111/ ProxyPassReverse / http://127.0.0.1:1111/ SSLEngine上的SSLCertificateFile <path_to_certificate>SSLCertificateKeyFile <path_to_key>
                    </path_to_key></path_to_certificate></div>                <p></p></li><li class="list__item" id="b31fe5ff"><p id="688999d2">设置以下变量以匹配您的集线器配置：</p>                    <ul class="list _bullet"><li class="list__item" id="c4be5c97"><p>更换<code class="code">1111</code>以及集线器服务器侦听的实际端口号。</p></li><li class="list__item" id="ca948d8f"><p>设置值<code class="code"><path_to_certificate></code>服务器的SSL / TLS证书的位置。</p></li><li class="list__item" id="885200a5"><p>设置值<code class="code"><path_to_key></code>服务器证书的PEM编码私钥文件的位置。</p></li></ul>                </li><li class="list__item" id="e6d7f9df"><p id="385c3e73">将其他HSTS标头添加到HTTPS VirtualHost指令。最大年龄以秒为单位。</p>                    <div class="code-block" data-lang="apacheconf">＃保证1年的HTTPS（包括子域）标头始终设置为严格传输安全性“ max-age = 31536000; includeSubDomains”</div>                    <p id="c886cad9">请注意，此标头仅在HTTPS VirtualHost上有效。</p></li><li class="list__item" id="6fac7d88"><p id="c681bfda">添加服务器端重定向以在首次访问站点时升级非HTTPS连接。将此添加到非HTTP VirtualHost。</p>                    <div class="code-block" data-lang="apacheconf">[...]ServerName myYouTrackService.com重定向永久/ https://myYouTrackService.com/</div>                    <p id="e7c050f5">更换<code class="code">myYouTrackService.com</code>使用您的YouTrack服务器的实际域名。</p></li></ol></section>            <p id="22736a4d">有关更多信息，请参阅<a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy.html" rel="noopener noreferrer" data-external="true" target="_blank">Apache模块mod_proxy</a>的文档。</p>        </div>        <div class="chapter"><h3 id="IIS_Config">IIS服务器配置</h3>            <p id="ac6f0050">要将IIS服务器用作反向代理，您需要使用应用程序请求路由（ARR）扩展。</p>            <p id="b7526f61">需要IIS 10.0版本1709或更高版本。</p>            <section class="procedure-steps"><h3 id="ebf43741">要将IIS服务器设置为反向代理，请执行以下操作：</h3><ol class="list _decimal"><li class="list__item" id="538a8326"><p>从<a href="https://www.iis.net/downloads/microsoft/application-request-routing" rel="noopener noreferrer" data-external="true" target="_blank">Microsoft网站</a>下载并安装应用程序请求路由（ARR）扩展。</p></li><li class="list__item" id="ac195a13"><p>在<span class="control">IIS管理器中</span> ，连接到IIS服务器-在这种情况下， <code class="code">localhost</code> 。</p></li><li class="list__item" id="fa67b9c7"><p>在“ <b id="f87f42ee">连接”</b>窗格中突出显示服务器。</p></li><li class="list__item" id="6acf0d66"><p>双击<span class="control">URL Rewrite</span> 。</p></li><li class="list__item" id="0ba4e1e5"><p>单击右窗格中的<span class="control">查看服务器变量</span> 。</p></li><li class="list__item" id="ead942e0"><p>将以下服务器变量添加到列表中：</p><div class="code-block" data-lang="bash">HTTP_X_FORWARDED_HOST HTTP_X_FORWARDED_SCHEME HTTP_X_FORWARDED_PROTO</div>                <p></p></li><li class="list__item" id="740f4553"><p id="0a5ba158">设置响应缓冲区阈值。对于单个Web服务器：</p>                    <ul class="list _ul"><li class="list__item" id="0867b030"><p>在“ <span class="control">连接”</span>窗格中选择服务器。</p></li><li class="list__item" id="69326f61"><p>双击“ <span class="control">应用程序请求路由缓存”</span> 。</p></li><li class="list__item" id="c424bec5"><p>单击<span class="control">“</span> <span class="control">操作”</span>窗格中“ <span class="control">代理”</span>标题下的“ <span class="control">服务器代理设置”</span> 。</p></li><li class="list__item" id="41ef5216"><p>选择<span class="control">启用代理</span>复选框，将<span class="control">响应缓冲区阈值</span>设置为<code class="code">0</code> ，然后单击“ <span class="control">应用”</span> 。保留默认值。</p></li></ul>                    <p id="60acd2d2">对于服务器场：</p>                    <ul class="list _ul"><li class="list__item" id="3f683d87"><p>在“ <span class="control">连接”</span>窗格中选择YouTrack服务器场。</p></li><li class="list__item" id="d1619556"><p>双击<span class="control">代理</span>图标。</p></li><li class="list__item" id="0c8c98e8"><p>在表单的“ <span class="control">缓冲区设置”</span>部分中，将“ <span class="control">响应缓冲区阈值”</span>设置为<code class="code">0</code> ，然后单击“ <span class="control">应用”</span> 。</p></li></ul>                </li><li class="list__item" id="1cdf9251"><p>取消选中“ <span class="control">在响应标头中反向重写主机”</span>复选框，然后单击“ <span class="control">应用”</span> 。</p></li><li class="list__item" id="8abab94b"><p>在“ <span class="control">连接”</span>窗格中的“ <span class="control">站点”</span>下，选择“ <span class="control">默认网站”</span> 。</p></li><li class="list__item" id="2a222d10"><p>双击“ <span class="control">URL重写”</span>功能，然后在“ <span class="control">操作”</span>窗格中单击“ <span class="control">添加规则”</span> 。</p></li><li class="list__item" id="003763d9"><p>添加具有服务器名称的反向代理规则： <code class="code">localhost:1111</code> （替换为您的YouTrack服务的真实位置和端口）。</p></li><li class="list__item" id="c3c95e44"><p id="ef25383c">打开规则，检查重写URL，然后添加以下服务器变量：</p>                    <ul class="list _bullet"><li class="list__item" id="dadfc2c5"><p>设置<code class="code">HTTP_X_FORWARDED_HOST</code>可变为<code class="code">{HTTP_HOST}</code> 。</p></li><li class="list__item" id="ba98140a"><p>设置<code class="code">HTTP_X_FORWARDED_SCHEME</code>可变为<code class="code">https</code> 。</p></li><li class="list__item" id="28b44da6"><p>设置<code class="code">HTTP_X_FORWARDED_PROTO</code>至<code class="code">https</code> 。</p></li></ul>                </li><li class="list__item" id="37451652"><p id="bd6ac175">确保启用了匿名身份验证：</p>                    <ul class="list _ul"><li class="list__item" id="537d5d50"><p>在“ <span class="control">连接”</span>窗格的“ <span class="control">站点”</span>部分中，选择“ <span class="control">默认网站”</span> 。</p></li><li class="list__item" id="d11b4361"><p>双击<span class="control">Authentication</span> ，选择<span class="control">Anonymous</span> ，然后在右窗格中单击<span class="control">Enable</span> 。</p></li></ul>                </li><li class="list__item" id="f8335a49"><p>确保禁用<span class="control">动态内容压缩</span> 。此设置的位置因操作系统而异。</p></li><li class="list__item" id="05e40c30"><p>在“ <span class="control">连接”</span>窗格中的“ <span class="control">站点”</span>下，选择“ <span class="control">默认网站”</span> 。</p></li><li class="list__item" id="7f21387c"><p>双击“ <span class="control">请求筛选”</span>功能，然后在“ <span class="control">操作”</span>窗格中单击“ <span class="control">编辑功能设置”</span> 。</p></li><li class="list__item" id="c5ba7584"><p id="00e671b3">增加以下参数的值：</p>                    <div class="table-wrapper"><table width="100%" id="43965662"><thead><tr id="7e5fa1a2" class="ijRowHead"><th id="50bc2807" width="20%"><p>参数</p></th><th id="1679cb37"><p>值</p></th></tr></thead><tbody><tr id="3a938250" class="ijRowOdd"><td id="78433d93"><p>最大网址长度</p></td><td id="cd34a866"><p>6144</p></td></tr><tr id="b605043c" class="ijRowEven"><td id="97343650"><p>最大查询字串</p></td><td id="9eee6d62"><p>4096</p></td></tr></tbody></table></div>                </li><li class="list__item" id="be88ee7e"><p id="b55063ca">将新的SSL绑定添加到“ <span class="control">默认网站”</span> 。</p>                    <ul class="list _ul"><li class="list__item" id="9fbadacc"><p>SSL绑定侦听的地址（主机URL）应与YouTrack基本URL匹配。</p></li><li class="list__item" id="fa2af0f6"><p>您选择的证书应与服务器DNS地址相对应。</p></li></ul>                </li><li class="list__item" id="6f1fef6b"><p id="55eb00e6">为<span class="control">默认网站</span>配置HTTP严格传输安全性（HSTS）设置</p>                    <ul class="list _ul"><li class="list__item" id="bc8b9f98"><p>设置<code class="code">enabled</code>的属性<code class="code"><hsts></code>至<code class="code">true</code> 。</p></li><li class="list__item" id="34707857"><p>指定一个值<code class="code">max-age</code>属性。例如， <code class="code">31536000</code> （一年，以秒为单位）。</p></li><li class="list__item" id="decef26c"><p>设置值<code class="code">includeSubDomains</code>和<code class="code">redirectHttpToHttps</code>至<code class="code">true</code>也一样</p></li></ul>                    <p id="5369acaf">有关特定说明，请参阅<a href="https://docs.microsoft.com/en-us/iis/configuration/system.applicationhost/sites/site/hsts" rel="noopener noreferrer" data-external="true" target="_blank">ISS配置参考</a> 。</p></li></ol></section>        </div>        <div class="chapter"><h3 id="Nginx_Config">NGINX服务器配置</h3>            <p id="df0a5547">将NGINX服务器配置为反向代理的基本要求包括以下步骤：</p>            <ul class="list _ul"><li class="list__item" id="04ca02d1"><p>更新<a href="http://nginx.org/en/docs/ngx_core_module.html#worker_rlimit_nofile" rel="noopener noreferrer" data-external="true" target="_blank">worker_rlimit_nofile</a>和<a href="http://nginx.org/en/docs/ngx_core_module.html#worker_connections" rel="noopener noreferrer" data-external="true" target="_blank">worker_connections</a>指令的值。这样可以确保为YouTrack提供合理数量的连接，以支持多个问题视图中的实时更新。</p></li><li class="list__item" id="1aa439d4"><p>设置<a href="http://nginx.org/en/docs/http/server_names.html" rel="noopener noreferrer" data-external="true" target="_blank">server_name</a>指令的变量。</p></li><li class="list__item" id="e6d47bf5"><p>添加<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" rel="noopener noreferrer" data-external="true" target="_blank">proxy_set_header</a>和<a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass" rel="noopener noreferrer" data-external="true" target="_blank">proxy_pass</a>指令。</p></li></ul>            <p id="a85c0c5d">需要NGINX版本1.11.7或更高版本。</p>            <section class="procedure-steps"><h3 id="cdd90bfc">配置NGINX反向代理头：</h3><ol class="list _decimal"><li class="list__item" id="27e63084"><p id="d8219253">打开您的NGINX服务器的配置文件。默认情况下，配置文件名为<code class="code">nginx.conf</code> 。默认目录为<code class="code">/usr/local/nginx/conf</code> ， <code class="code">/etc/nginx</code> ， 要么<code class="code">/usr/local/etc/nginx</code> 。</p>                    <p id="872fa2b7">您可以通过输入以下内容找到配置文件的确切位置<code class="code">nginx -V</code>在命令行界面中。</p>                </li><li class="list__item" id="4632a9b3"><p>增加价值<code class="code">worker_rlimit_nofile</code>指令的最小值<code class="code">4096</code> 。</p></li><li class="list__item" id="ab6d4b42"><p>在里面<code class="code">events</code>部分，增加<code class="code">worker_connections</code>指令的最小值<code class="code">2048</code> 。</p></li><li class="list__item" id="d8366802"><p id="4c33dbf2">更新<code class="code">server</code>指令并添加<code class="code">proxy_set_header</code>和<code class="code">proxy_pass</code>配置文件中的指令。使用以下示例作为指导：</p>                    <aside class="prompt" rel="4c33dbf2" id="dead5d28" data-type="warning" data-title="">                        <p id="d89c31c2">许多示例NGINX配置使用<code class="code">include</code>引用a的指令<code class="code">snippets/ssl-params.conf</code>文件。该文件包含用于SSL终止的一组通用配置参数。如果您选择包括此文件而不是遵循以下描述的设置，则必须更改<code class="code">X-Frame-Options</code>引用文件中的参数来自<code class="code">DENY</code>至<code class="code">SAMEORIGIN</code> 。否则，反向代理会干扰使用户保持登录YouTrack的过程。</p>                        <p id="53503cd3">有关更多信息，请参阅<a href="#users-logged-out">定期从YouTrack注销用户</a> 。</p>                    </aside>                    <div class="code-block" data-lang="nginx">服务器{监听443 SSL http2; ssl_certificate <path_to_certificate>; ssl_certificate_key <path_to_key>; server_name localhost; add_header严格传输安全性max-age = 31536000;位置/ {proxy_set_header X-Forwarded-Host $ http_host; proxy_set_header X-Forwarded-For $ proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $ scheme; client_max_body_size 10m; proxy_http_version 1.1; proxy_pass http：//youtrackmachine.domain.local：1111; } location / api / eventSourceBus {proxy_cache off; proxy_buffering关闭; proxy_read_timeout 86400s; proxy_send_timeout 86400s; proxy_set_header连接''; chunked_transfer_encoding关闭； proxy_set_header X转发的主机$ http_host; proxy_set_header X-Forwarded-For $ proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $ scheme; proxy_http_version 1.1; proxy_pass http：//youtrackmachine.domain.local：1111; }}</path_to_key></path_to_certificate></div>                </li><li class="list__item" id="250c01dd"><p id="d1a18dc7">设置以下变量以匹配您的YouTrack配置：</p>                    <ul class="list _bullet"><li class="list__item" id="29b85af2"><p>                            <code class="code">listen 443</code>是您在<code class="code">--base-url</code>参数。</p></li><li class="list__item" id="5c884a5d"><p>                            <code class="code">proxy_pass http://youtrackmachine.domain.local:1111</code>是YouTrack服务器的路径，其中包含您使用<code class="code">-–listen-port</code>命令。</p></li></ul>                </li><li class="list__item" id="b7a8647b"><p>保存并关闭您的配置文件。</p></li><li class="list__item" id="c3fcb50d"><p id="6e39279d">通过使用以下命令停止和启动服务器，检查NGINX配置中的错误：</p>                    <div class="code-block" data-lang="bash">sudo nginx -s停止sudo nginx</div>                    <p id="949dfc5f">或者，您可以使用以下命令重新加载配置：</p>                    <div class="code-block" data-lang="bash">sudo nginx -s重新加载</div>                </li></ol></section>            <p id="768ff801">的<code class="code">client_max_body_size</code>指令定义NGINX在HTTP请求中接受的最大数据量。如果未指定值，则NGINX设置的默认值为1兆字节。我们建议您将最大值增加到10 MB，以与YouTrack中的默认值相对应。</p>            <p id="e90c2731">第二<code class="code">location</code> block禁用缓冲来自敏捷板的连接以支持实时更新。如果您在第一个中自定义任何常用连接设置<code class="code">location</code>块，您应该为设置相同的自定义参数<code class="code">/api/eventSourceBus</code>地点。您也可以将所有常用设置放在单独的文件中，并使用<code class="code">include</code>指示。有关更多信息，请阅读<a href="http://nginx.org/en/docs/ngx_core_module.html#include" rel="noopener noreferrer" data-external="true" target="_blank">NGINX文档</a> 。</p>            <a name="Converting_Java_key_store_to_format_required_by_Nginx"></a>            <p id="a9f52ecb">如果使用Java密钥库，则需要将其转换为PKCS12格式，以将NGINX服务器用作SSL终止代理。以下过程显示了如何使用<span class="control">keytool</span>和<span class="control">openssl</span>转换密钥库。</p>            <section class="procedure-steps"><h3 id="c201f6c3">要将Java密钥库转换为PKCS12格式，请执行以下操作：</h3><ol class="list _decimal"><li class="list__item" id="5de437dd"><p id="734e45e5">使用<span class="control">keytool</span>转换当前<code class="code">.jks</code>文件转换为PKCS12密钥存储格式<code class="code">.p12</code> ：</p>                    <div class="code-block" data-lang="bash">keytool -importkeystore -srckeystore oldkeystore.jks -destkeystore newkeystore.p12 -deststoretype PKCS12输入目标密钥库密码：[从oldkeystore.jks输入私钥密码，它将是newkeystore.p12的密码]重新输入新密码：[与上面相同]输入源密钥库密码：[输入oldkeystore.jks的密码] ...输入<key name="" alias="">[从oldkeystore.jks输入私钥密码]的密钥密码...
    </key></div>                    <p id="25ba1192">您将需要输入“目标密钥库密码”。如果你的<code class="code">.jks</code>密钥库包含带有密码的私钥，那么“目标密钥库密码”应等于私钥的密码。</p>                </li><li class="list__item" id="4d63a975"><p>列出新密钥库文件的内容：</p><div class="code-block" data-lang="bash">keytool -deststoretype PKCS12 -keystore newkeystore.p12 -list输入密钥库密码：[输入步骤1提供的newkeystore.p12的密码] ...
    </div>                <p></p></li><li class="list__item" id="c82601cd"><p>从中提取.pem文件（证书） <code class="code">.p12</code>密钥库：</p><div class="code-block" data-lang="bash">openssl pkcs12 -nokeys -in newkeystore.p12 -out certfile.pem输入导入密码：[输入步骤1中提供的newkeystore.p12的密码] ...
    </div>                <p></p></li><li class="list__item" id="0df72961"><p>从以下位置提取未加密的密钥文件<code class="code">.p12</code>密钥库：</p><div class="code-block" data-lang="bash">openssl pkcs12 -nocerts -nodes -in newkeystore.p12 -out keyfile.key输入导入密码：[输入步骤1中提供的newkeystore.p12的密码] ...
    </div>                <p></p></li></ol></section>        </div>            </div>    <div class="chapter"><h2 id="CORS" data-toc="Reverse-Proxy-Configuration#CORS">CORS支持</h2>        <p id="691582d4">如果您使用外部集线器服务，则YouTrack可能需要CORS支持才能呼叫集线器。前述配置可以正常工作，不需要任何进一步的调整。但是，其他自定义代理规则可能会干扰CORS，因此无法登录到YouTrack。</p>        <p id="8220147d">在反向代理后面使用外部集线器服务时，请考虑以下准则：</p>        <ol class="list _decimal"><li class="list__item" id="cf564a40"><p id="bc68370d">代理规则不应阻止与CORS相关的HTTP标头：</p>                <ul class="list _ul"><li class="list__item" id="f1c9f3d8"><p>访问控制请求方法</p></li><li class="list__item" id="3983e23a"><p>访问控制请求标头</p></li><li class="list__item" id="28d59f3e"><p>访问控制允许来源</p></li><li class="list__item" id="9b9d1890"><p>访问控制允许凭证</p></li><li class="list__item" id="6ff54642"><p>访问控制公开标头</p></li><li class="list__item" id="2d8944f1"><p>访问控制最大年龄</p></li><li class="list__item" id="33cb359a"><p>访问控制允许方法</p></li><li class="list__item" id="4887fc4e"><p>访问控制允许标题</p></li></ul>            </li><li class="list__item" id="f0367b5e"><p>代理服务器应允许HTTP OPTIONS请求。</p></li><li class="list__item" id="1cade39c"><p>HTTP OPTIONS请求不应是代理强制身份验证的主题（如果有）。例如，您可能要设置基于证书的身份验证以符合企业安全策略。在这种情况下，如果传入请求是OPTIONS类型，则应跳过身份验证检查。OPTIONS请求无法自行返回任何与客户相关的数据，因此可以安全地接收它们。</p></li></ol>    </div>    <div class="chapter"><h2 id="troubleshooting" data-toc="Reverse-Proxy-Configuration#troubleshooting">故障排除</h2>        <p id="b644d98e">如果用户报告在反向代理服务器后面使用YouTrack时遇到问题，请检查以下错误。</p>        <div class="table-wrapper"><table width="100%" id="30664366"><thead><tr id="c70b7f15" class="ijRowHead"><th id="c9edeb55" width="20%"><p>条件</p></th><th id="6b21b31e"><p>YouTrack显示错误消息：“实时更新连接花费的时间比预期的长。”</p></th></tr></thead><tbody><tr id="5471a5e0" class="ijRowOdd"><td id="4e021b3e"><p>原因</p></td><td id="4f129540"><p>您的反向代理服务器正在缓冲支持实时更新的连接。</p></td></tr><tr id="0a83d605" class="ijRowEven"><td id="fc97afb7"><p>解</p></td><td id="95f2dd28"><p id="d72d42ce">验证反向代理服务器的当前设置，并确认您的连接不受缓冲。</p>                    <ul class="list _bullet"><li class="list__item" id="0ad827a8"><p>对于Apache安装，请检查<code class="code">ProxyIOBufferSize</code>指示。</p></li><li class="list__item" id="9aa00200"><p id="862a81b4">对于IIS：</p>                            <ul class="list _ul"><li class="list__item" id="8ec00081"><p>检查<code class="code">Response buffer threshold</code>被设定为<code class="code">0</code> 。</p></li><li class="list__item" id="b1fb6f00"><p>检查以确保<code class="code">Maximum URL length</code>和<code class="code">Maximum query string</code>如本安装指南中所述配置<span class="control">请求过滤</span>功能中的参数。</p></li><li class="list__item" id="57c4aff8"><p>确保禁用<span class="control">动态内容压缩</span> 。</p></li></ul>                        </li><li class="list__item" id="2607e739"><p>对于NGINX，请确认<code class="code">/api/eventSourceBus</code>位置如本安装指南中所述进行配置。</p></li></ul>                </td></tr></tbody></table></div>        <div class="table-wrapper"><table width="100%" id="1c2fc1bc"><thead><tr id="782f8189" class="ijRowHead"><th id="8088904f" width="20%"><p>条件</p></th><th id="21973ea7"><p>反向代理已按照本指南中的说明进行配置，或者您没有使用反向代理。您继续看到错误消息：“实时更新连接花费的时间比预期的长。”</p></th></tr></thead><tbody><tr id="3d0faac4" class="ijRowOdd"><td id="0996e74a"><p>原因</p></td><td id="c02f1d96"><p>您正在使用防病毒软件或终结点安全软件来阻止服务器发送的事件。</p></td></tr><tr id="addf4ffa" class="ijRowEven"><td id="a85bc8b3"><p>解</p></td><td id="d664dd3f"><p>禁用软件设置以允许从服务器自动更新。</p></td></tr></tbody></table></div>        <div class="table-wrapper"><table width="100%" id="998ac24c"><thead><tr id="adcc1fe3" class="ijRowHead"><th id="8174d37d" width="20%"><p>条件</p></th><th id="e3b1160c"><p>错误413请求实体过大。</p></th></tr></thead><tbody><tr id="9cea26da" class="ijRowOdd"><td id="c08d0197"><p>原因</p></td><td id="e2f703b3"><p>用户尝试上传超过反向代理服务器接受的最大正文大小的附件。</p></td></tr><tr id="fd045471" class="ijRowEven"><td id="c116ed5c"><p>解</p></td><td id="133727d8"><p id="72614994">验证反向代理服务器的当前设置，并根据需要增加允许的最大大小。此设置的建议值为10兆字节。</p>                    <ul class="list _bullet"><li class="list__item" id="1a2fb172"><p>对于Apache安装，请检查<code class="code">LimitRequestBody</code>指示。</p></li><li class="list__item" id="6654bc23"><p>对于IIS，请检查<code class="code">uploadreadaheadsize</code>配置设置。</p></li><li class="list__item" id="9eed3929"><p>对于NGINX，请检查<code class="code">client_max_body_size</code>指示。</p></li></ul>                </td></tr></tbody></table></div>        <div class="table-wrapper"><table width="100%" id="users-logged-out"><thead><tr id="17540366" class="ijRowHead"><th id="fc5084f2" width="20%"><p>条件</p></th><th id="a8e94866"><p>用户会定期退出YouTrack。</p></th></tr></thead><tbody><tr id="2b0b4f33" class="ijRowOdd"><td id="9669dfc0"><p>原因</p></td><td id="4c142e64"><p>内置的集线器服务使用隐藏的嵌入式框架刷新身份验证令牌。如果您已为<code class="code">X-Frame-Options</code>标头<code class="code">DENY</code>对于您的反向代理服务器，用户的令牌到期时将注销。</p></td></tr><tr id="fce09576" class="ijRowEven"><td id="3e9773cd"><p>解</p></td><td id="52504739"><p>所有包含中心服务静态内容的响应都将设置<code class="code">X-Frame-Options</code>标头<code class="code">SAMEORIGIN</code> 。要保留此值，请将反向代理服务器配置为使用<code class="code">X-Frame-Options: SAMEORIGIN</code>指令，用于YouTrack安装中的所有静态内容。如果您的YouTrack安装已连接到外部集线器服务，请为来自集线器的静态内容设置此伪指令。有关更多信息，请参见<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options" rel="noopener noreferrer" data-external="true" target="_blank">X-Frame-Options</a> 。</p></td></tr></tbody></table></div>        <div class="table-wrapper"><table width="100%" id="worker-connections-too-low"><thead><tr id="9e21fdbf" class="ijRowHead"><th id="ef86571a" width="20%"><p>条件</p></th><th id="d9825fb9"><p>在新选项卡中打开的问题和敏捷板为空白，正在加载或部分加载。</p></th></tr></thead><tbody><tr id="0137bd39" class="ijRowOdd"><td id="1e44571d"><p>原因</p></td><td id="9422299b"><p id="93c170d5">您的代理服务器不支持支持实时更新的页面所需的连接数。平均上限为每个用户30个连接。在不同的浏览器选项卡上打开多个问题视图的用户可以用尽所有可用的连接。</p>                    <p id="079bfb31">对于NGINX，您可以通过查找以下内容来确认这种情况<code class="code">worker_connections are not enough</code>日志中的错误。</p></td></tr><tr id="962e200b" class="ijRowEven"><td id="143b94bf"><p>解</p></td><td id="eda6cb11"><p id="5a9e3f2d">调整反向代理服务器的性能设置，以允许更多与YouTrack的连接。</p>                <ul class="list _ul"><li class="list__item" id="d06fe48b"><p>对于Apache安装，请检查以下值： <code class="code">MaxRequestWorkers</code>和<code class="code">ThreadsPerChild</code>指令。增加这些和其他与连接有关的指令的值可以提高性能。</p></li><li class="list__item" id="7af63db5"><p>对于NGINX，请检查<code class="code">worker_rlimit_nofile</code>和<code class="code">worker_connections</code>指令。我们建议您将这些指令的值设置为最小值<code class="code">4096</code>和<code class="code">2048</code>分别。</p></li></ul>                </td></tr></tbody></table></div>    </div><div class="last-modified" data-skip-index="skip">上次修改时间：2019年11月29日</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="Proxy-Configuration.html">代理配置</a> <a class="navigation-links__next" href="Configure-JVM-Options.html">配置JVM选项</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>