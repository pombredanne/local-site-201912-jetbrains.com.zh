<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta charset="UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="//resources.jetbrains.com/storage/help-app/v3/analytics.js"></script><title>State-machine Rules - Help | YouTrack Standalone</title><link rel="stylesheet" href="//resources.jetbrains.com/storage/help-app/v3/app.css"></head><body data-id="state-machine-per-issue-type" data-breadcrumbs="Administration.xml|Administration/Workflow-Guide.xml|Workflows/Workflow-Rules.xml|Workflow Rule Types/state-machine-per-issue-type.xml|State-machine Rules" data-main-title="State-machine Rules"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search YouTrack Standalone Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>YouTrack Standalone 2019.2 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="state-machine-per-issue-type" id="state-machine-per-issue-type.xml">State-machine Rules</h1>    <p id="24e406d6">A <span class="control">state-machine</span> rule regulates the transitions from one value to another for a custom field.      YouTrack provides templates for two types of state-machine rules.</p>    <ul class="list _ul"><li class="list__item" id="c3a8d735"><p id="48411727">A basic <span class="control">state-machine</span> rule that regulates the transitions from one value to another for a custom field.            To learn more about this type of state-machine, see <a href="#sample-state-machine-rule">Basic State-machines</a>.</p></li><li class="list__item" id="d0165f26"><p>A <span class="control">state-machine</span> rule that imposes separate sets of state transitions based on the current value in a specified field.            To learn how to script this type of state-machine, see <a href="#state-machine-per-issue-type">State-machine Rules State-machines per Issue Type</a>.</p></li></ul>  <p id="56b48ab4">Both of these state-machine types are built using a similar collection of parameters.</p>  <p id="38566de1">You can apply a state-machine rule to any custom field.    However, the most common use case for a state-machine rule is to regulate transitions between values for the <span class="control">State</span> field or another custom field that stores a <code class="code">state</code> type.</p>  <p id="685e919c">When a state-machine rule is applied to a project, the options that are shown in the drop-down list for the field are restricted to the transitions that are defined in the state-machine rule for the current state.    Custom fields that are regulated by a state-machine rule are marked with a <span class="control">Workflow-driven field</span> icon.    The action that is defined for each value in the state-machine rule is displayed in the drop-down list. The actual values are shown to the right.    The following image illustrates how the list of allowed transitions for the <span class="control">State</span> field changes based on the current value.</p>  <aside data-type="warning" class="prompt" data-title="" rel="685e919c" id="aeb3c93b">    <p id="fbcac7be">The allowed transitions for each value are displayed even when you have defined a guard that potentially blocks the selection of the value.      If the guard condition is not met, the selection is ignored.</p>    <p id="35d0d937">If you add guards to your transitions, be sure to use the <code class="code">workflow.message</code> method to explain the restriction that is applied by the workflow.</p>  </aside>  <figure><a class="lightbox" href="/help/img/youtrack/2019.2/statemachine-field-values.zoomed.png"><img alt="Statemachine field values" title="Statemachine field values" src="/help/img/youtrack/2019.2/statemachine-field-values.png" id="c5bfd52b" width="600" height="219"></a></figure>        <div class="chapter"><h2 id="sample-state-machine-rule" data-toc="state-machine-per-issue-type#sample-state-machine-rule">Basic State-machines</h2>          <p id="a9cb9391">A basic state-machine regulates the transitions from one value to another for a custom field for all issues in any project that uses the workflow.            For each transition, you can add one or more actions.            Additional properties for each transition determine how these actions are applied.</p>          <ul class="list _ul"><li class="list__item" id="9239f027"><p>Transitions that use <code class="code">onEnter</code> and <code class="code">onExit</code> properties perform an action when the value for the field is set.              These actions are executed by the user who changes the value of the field.</p></li><li class="list__item" id="651a301e"><p>Transitions that use the <code class="code">after</code> property perform an action after the specified time frame.              These actions are executed by the workflow user account.</p></li></ul>            <p id="036827a2">This example that follows shows a simplified state-machine rule.                This rule defines the transitions that are allowed for the <span class="control">State</span> field.</p>            <p id="5879ac84">The following transitions are defined in this rule:</p>            <ul class="list _ul"><li class="list__item" id="06191286"><p>From the initial <span class="control">Open</span> state, the value can change to <span class="control">In Progress</span>.                    An additional transition with the name <code class="code">reminder</code> includes an <code class="code">after</code> property that reminds the project owner if an issue remains in the <span class="control">Open</span> state for more than two days.</p></li><li class="list__item" id="b9f4283d"><p>When the issue transitions from <span class="control">Open</span> to <span class="control">In Progress</span>,                the <code class="code">onEnter</code> property for the <code class="code">In progress</code> state automatically assigns the issue to the user who changes the value of the <span class="control">State</span> field.</p></li><li class="list__item" id="5f4e9334"><p>From <span class="control">In progress</span>, the value can change to <span class="control">Fixed</span> or <span class="control">Open</span>.              When an issue transitions from <span class="control">In Progress</span> back to <span class="control">Open</span> an automation for this transition asks the user to unassign the issue,              otherwise the transition is blocked.</p></li><li class="list__item" id="2f1ea7e1"><p>The final state is <span class="control">Fixed</span>. There are no additional transitions that are defined for this value.                    Once this value is set, it cannot be changed.</p></li></ul>          <p id="a480c775">The following diagram shows an abstract representation of this rule.</p>          <figure><img alt="A diagram that illustrates the supported transitions between values for the State field." title="A diagram that illustrates the supported transitions between values for the State field." src="/help/img/youtrack/2019.2/basic-state-machine.png" id="a464afce" width="1009" height="214"></figure>          <p id="037f2ed1">The workflow rule that supports this state-machine is written as follows:</p>                        <div class="code-block" data-lang="javascript">var entities = require('@jetbrains/youtrack-scripting-api/entities');
var workflow = require('@jetbrains/youtrack-scripting-api/workflow');

exports.TWO_DAYS = 2 * 24 * 60 * 60 * 1000;
exports.rule = entities.Issue.stateMachine({
  title: 'Basic state-machine',
  fieldName: 'State',
  states: {
    Open: {
      initial: true,
      transitions: {
        start: {
          targetState: 'In progress'
        },
        reminder: {
          targetState: 'Open',
          after: exports.TWO_DAYS,
          action: function(ctx) {
            var issue = ctx.issue;
            issue.project.leader.notify('Reminder', 'Check out an issue ' + issue.id);
          }
        }
      }
    },
    'In progress': {
      onEnter: function(ctx) {
        ctx.issue.fields.Assignee = ctx.currentUser;
      },
      onExit: function(ctx) {
      },
      transitions: {
        fix: {
          targetState: 'Fixed'
        },
        reopen: {
          guard: function(ctx) {
            if (ctx.issue.fields.Assignee) {
              workflow.message('You cannot reopen an issue unless you unassign it first');
              return false;
            }
            return true;
          },
          targetState: 'Open'
        }
      }
    },
    Fixed: {
      transitions: {}
    }
  },
  requirements: {
    Assignee: {
      type: entities.User.fieldType
    }
  }
});</div>            <p id="e3014e99">The components that define this state-machine rule are as follows:</p>            <ul class="list _ul"><li class="list__item" id="028eceb2"><p>The <code class="code">require</code> statements reference the <code class="code">entities</code> module and the <code class="code">workflow</code> module in the workflow API.</p></li><li class="list__item" id="25bba68c"><p>The <code class="code">exports.TWO_DAYS</code> property sets a local variable that is used to send the reminder for issues that have the <span class="control">Open</span> status.                    This variable is assigned a value that equals 2 days in milliseconds.</p></li><li class="list__item" id="08108f2e"><p>The <code class="code">exports.rule</code> property uses the <code class="code">Issue.stateMachine</code> method to export the script that follows the declaration as a state-machine rule.</p></li><li class="list__item" id="1944cf3e"><p id="24a12b78">The body of the rule itself contains definitions for the following properties:</p>                    <div class="table-wrapper"><table width="100%" id="0a707c57"><thead><tr id="e991f2d9" class="ijRowHead"><th id="581724d8" width="20%"><p>Property</p></th><th id="ec4770bd"><p>Description</p></th></tr></thead><tbody><tr id="dbf7f621" class="ijRowOdd"><td id="1ea463f0"><p>title</p></td><td id="b9696b02"><p>An optional human-readable title.</p></td></tr><tr id="3d1d767d" class="ijRowEven"><td id="133d0262"><p>fieldName</p></td><td id="59dc1d2d"><p>The name of the custom field that is managed by the state-machine.</p></td></tr><tr id="b7beac63" class="ijRowOdd"><td id="7260b052"><p>states</p></td><td id="0eabe726"><p>The list of field values and definitions for the transitions between them.                                Values that contain spaces and special characters are set in single quotes.</p></td></tr><tr id="d7542c3e" class="ijRowEven"><td id="7d789de4"><p>requirements</p></td><td id="1ccad9bf"><p id="01b4ffbf">The list of entities that are required for the rule to execute without errors.                              This property ensures that rules can be attached to projects safely.</p>                                <p id="557e8ea3">In this example, we only require that there is an <span class="control">Assignee</span> field that stores a <code class="code">user</code> type in the projects to which the rule is attached.                                If this field is absent, an error is shown in the <span class="control">Workflows</span> list.                                  The rule cannot be enabled until the required field is attached.</p>                                <p id="c5805262">For a state-machine rule, you do not need to add the field that is managed by the state-machine to the requirements.                                  This field and its values are derived from the <code class="code">states</code> property.</p></td></tr></tbody></table></div></li><li class="list__item" id="91a59539"><p id="9cfe4b67">Each of the values that are defined in the <code class="code">states</code> property contain definitions for the following additional properties:</p>                    <div class="table-wrapper"><table width="100%" id="aad319c9"><thead><tr id="7eb87f14" class="ijRowHead"><th id="4329e357" width="20%"><p>Property</p></th><th id="c27e5487"><p>Description</p></th></tr></thead><tbody><tr id="55ab0324" class="ijRowOdd"><td id="b7313b68"><p>initial</p></td><td id="0d3e1c78"><p>A Boolean property that determines which of the values in the list is set when an issue is created.                                Exactly one value must set this property to <code class="code">true</code>.                                For other values that are not set as the initial value, this property is optional and can be omitted.</p></td></tr><tr id="8fbf2151" class="ijRowEven"><td id="b0ef84fb"><p>onEnter</p></td><td id="bc615571"><p>An optional function declaration that is called when the corresponding value is assigned to an issue.                                These functions behave similar to actions in other types of rules.</p></td></tr><tr id="ffe83415" class="ijRowOdd"><td id="c322e5e8"><p>onExit</p></td><td id="8bbe07c4"><p>An optional function declaration that is called when the field value is changed from the current value to another value.                                These functions behave similar to actions in other types of rules.</p></td></tr><tr id="284a8032" class="ijRowEven"><td id="e1384fb2"><p>transitions</p></td><td id="7ec2c5e5"><p id="4cbe633e">The list of possible target values that can be set for each value in the list.</p>                                <p id="106c3b1a">In this example, we only require that there is an <span class="control">Assignee</span> field that stores a <code class="code">user</code> type in the projects to which the rule is attached.                                If this field is absent, an error is shown in the <span class="control">Workflows</span> list.                                  The rule cannot be enabled until the required field is attached.</p>                                <p id="497f9332">For a state-machine rule, you do not need to list the values that are used by fields that are managed by the state-machine in the requirements.                                  This field and its values are derived from the <code class="code">states</code> property.</p></td></tr></tbody></table></div>                </li><li class="list__item" id="0f50f056"><p id="b630e0ac">Each of the values that are defined in the <code class="code">transitions</code> property contain a <code class="code">name</code> property.                    The name is used to set this value in a command and is also shown in the list of values for a custom field.                    Each transition name contains definitions for the following additional properties:</p>                    <div class="table-wrapper"><table width="100%" id="e7be413d"><thead><tr id="9ff3b3cc" class="ijRowHead"><th id="75ee192b" width="20%"><p>Property</p></th><th id="2a027d25"><p>Description</p></th></tr></thead><tbody><tr id="b7b14206" class="ijRowOdd"><td id="1f1c9877"><p>targetState</p></td><td id="d61a9013"><p>The actual name of the value that is set when the command specified in the <code class="code">name</code> property is applied.</p></td></tr><tr id="feb8c780" class="ijRowEven"><td id="599e068b"><p>after</p></td><td id="c28dc773"><p>An optional property that sets an interval for performing an action.                                The action itself is specified in the <code class="code">action</code> property.</p></td></tr><tr id="5c1c5de7" class="ijRowOdd"><td id="f1f88308"><p>action</p></td><td id="82f2c0ff"><p>An optional property for any transition that behaves similar to actions in other types of rules..</p></td></tr><tr id="03255478" class="ijRowEven"><td id="2ee3efa8"><p>guard</p></td><td id="9ef797e6"><p id="74fc1583">An optional condition that determines when the transition is allowed.                              If the guard condition is not met, the value for the custom field cannot change to the value that is defined for this transition.</p>                                <p id="0998bd59">In this example, for an issue to transition from <span class="control">In progress</span> back to an <span class="control">Open</span> state, the issue must be unassigned.                                  The guard contains a function that uses the <code class="code">message</code> method from the <code class="code">workflow</code> module to provide feedback to the user who attempts to reopen an issue without unassigning it first.</p></td></tr></tbody></table></div>                </li></ul>        </div>  <div class="chapter"><h2 id="state-machine-per-issue-type" data-toc="state-machine-per-issue-type#state-machine-per-issue-type">State-machines per Issue Type</h2>    <p id="73976a1e">A state-machine per issue type adds an additional dimension to a basic state-machine.    Instead of regulating a single set of transitions for values in a custom field, the rule provides separate state-machines for each of the possible values in a separate field.</p>    <p id="556a924c">Just like you can apply a state-machine rule to any custom field, not just the default <span class="control">State</span> field,      you can make type-specific transitions depend upon the value in any enumerated field, not just the default <span class="control">Type</span> field.      The most common use case is to regulate transitions between values for the <span class="control">State</span> field based on the current value for the issue <span class="control">Type</span>.</p>    <p id="1985be5e">A state-machine per issue type is written similarly to a basic state-machine, with the following changes:</p>    <ul class="list _ul"><li class="list__item" id="5d9aa00a"><p>The <code class="code">fieldName</code> property is replaced with an alias, <code class="code">stateFieldName</code> in the template for a new state-machine rule.      The value for this property determines which field is managed by the state-machine rule.</p></li><li class="list__item" id="f267b722"><p>A separate property for the <code class="code">typeFieldName</code> lets you specify the field that dictates which state-machine applies to the state field.      The presence of this property is the main difference between a basic state-machine (which doesn't use it) and a state-machine per issue type.</p></li><li class="list__item" id="9695a981"><p>The <code class="code">states</code> property is replaced with an alias, <code class="code">defaultMachine</code>.      This property describes the default set of transitions for values in the managed field.        This state-machine applies to issues that are not assigned a value for which an alternative state-machine has been defined.</p></li><li class="list__item" id="7ce4433f"><p>The <code class="code">alternativeMachines</code> property stores a collection of state-machine transitions for designated values in the custom field that is set for the <code class="code">typeFieldName</code> property.</p></li></ul>    <p id="384c623e">When you specify a value for the <code class="code">typeFieldName</code>, configure the <code class="code">defaultMachine</code>, and define at least one state-machine for a value in the <code class="code">alternativeMachines</code> section of the rule,      you end up with a state-machine per issue type.    The field that you specify for the <code class="code">typeFieldName</code> property functions as a switch between the default state-machine and the collection of alternative state-machines.</p>    <p id="5ec7cbf0">The following example shows how to build a state-machine per issue type.    Each of the tabs below describes the state-machine that corresponds to one of the possible values for the <span class="control">Type</span> field.</p>    <div class="tabs" id="04ce2271"><div class="tabs__content" data-title="Task" id="685683e0">        <figure><img alt="A diagram that shows the default transitions for the State field in a state-machine per issue type." title="A diagram that shows the default transitions for the State field in a state-machine per issue type." src="/help/img/youtrack/2019.2/basic-state-machine.png" id="ecbbcc88" width="1009" height="214"></figure>        <p id="a99ba1d6">First, we take the logic that is applied in the basic state-machine rule above and apply it as a default to any type of issue in a project.          As a result, the values for the <span class="control">State</span> field in issues that are assigned the <span class="control">Task</span> type are regulated according to the model shown above.          This state-machine also applies to issues that are assigned any type that isn't assigned an alternative state-machine.</p>      </div><div class="tabs__content" data-title="Bug" id="31220936">        <figure><img alt="A diagram that shows the transitions for the State field in issues that are assigned the Bug type." title="A diagram that shows the transitions for the State field in issues that are assigned the Bug type." src="/help/img/youtrack/2019.2/state-machine-for-bug-type.png" id="c679bde6" width="1139" height="319"></figure>        <p id="de0d9927">Next, we'll add an alternative state-machine just for issues that are assigned the <span class="control">Bug</span> type.</p>        <ul class="list _ul"><li class="list__item" id="a2acf78a"><p>For this issue type, we make it possible to assign the value <span class="control">Can't Reproduce</span> to the <span class="control">State</span> field.</p></li><li class="list__item" id="b93a8566"><p>We'll make it a little more flexible than the default state-machine, allowing a transition from <span class="control">Fixed</span> back to <span class="control">Open</span>.            This means that we can reopen issues when a regression occurs instead of having to report the same problem more than once.</p></li><li class="list__item" id="da5255c3"><p>We'll also make it possible to transition from <span class="control">Can't Reproduce</span> back to <span class="control">Open</span>.</p></li></ul>        <p id="39fafeed">We add some automation to specific states and transitions.</p>        <ul class="list _ul"><li class="list__item" id="32c9a469"><p>When an issue moves from <span class="control">Open</span> to <span class="control">In Progress</span>, the issue is assigned to the user who changes the issue state.            This is the same definition for the <code class="code">onEnter</code> property that is used for the <code class="code">In progress</code> state in the basic state-machine.</p></li><li class="list__item" id="84548833"><p>For the transition from <span class="control">In Progress</span> to <span class="control">Can't Reproduce</span> we add an <code class="code">action</code>.            This displays an alert that asks the user to describe what steps they took to try to reproduce the bug.</p></li><li class="list__item" id="cff2a97a"><p>From <span class="control">Fixed</span> the issue can only transition back to the <span class="control">Open</span> state.            As a result, we can add an automation for the <code class="code">onExit</code> property to the definition for the <code class="code">Fixed</code> field.            This automation sends a notification to the assignee to inform them that the issue was reopened.</p></li></ul>      </div><div class="tabs__content" data-title="Feature" id="2d892876">        <figure><img alt="A diagram that shows the transitions for the State field in issues that are classified as feature requests" title="A diagram that shows the transitions for the State field in issues that are classified as feature requests" src="/help/img/youtrack/2019.2/state-machine-for-features.png" id="82ce6b9d" width="1094" height="346"></figure>        <p id="a7e1f4e3">We'll add one more alternative state-machine and apply this to issues that are assigned the <span class="control">Feature</span> type.</p>        <ul class="list _ul"><li class="list__item" id="d4d9101b"><p>For these types of issues, we add the possibility to move an issue directly from an <span class="control">Open</span> state to <span class="control">Rejected</span>.            If anybody suggests a feature that the team decides doesn't fit with their vision of the product, they can throw it out.</p></li><li class="list__item" id="68e6d5b6"><p>Just to be open to the possibility for a change in direction, we'll allow issues to transition from <span class="control">Rejected</span> back to <span class="control">Open</span>.</p></li><li class="list__item" id="7cf84aff"><p>All of the other transitions are similar to the state-machine for bugs.</p></li></ul>        <p id="d8ae3b29">To keep it simple, we haven't added any automations to this state-machine.          That doesn't mean that there aren't any opportunities to automate or enhance the process for this issue type.          Possible enhancements include:</p>        <ul class="list _ul"><li class="list__item" id="a9d0ede1"><p>Using an <code class="code">after</code> event to the set of transitions for the <span class="control">Open</span> state to tag issues that remain in this state for over six months.            You can then review all of the tagged issues in your next backlog grooming session.</p></li><li class="list__item" id="3f99556f"><p>Adding an <code class="code">onEnter</code> event to the <span class="control">In Progress</span> state, prompting the user to assign the feature to a specific milestone or pipeline in the roadmap.</p></li><li class="list__item" id="40cd8425"><p>Adding an <code class="code">action</code> event to the transition from <span class="control">Rejected</span> to <span class="control">Open</span>, prompting the user to justify why they would reopen the feature request for future consideration.</p></li></ul>      </div></div>    <aside data-type="note" class="prompt" data-title="Transitions Between State-machines" rel="04ce2271" id="5e7b19c9">    <p id="f35990d7">For a state-machine per issue type, the field that is referenced in the <code class="code">typeFieldName</code> property works as a switch.    Changing the value of this field determines which state-machine is applied to the current issue.</p>      <p id="c5c923fc">When an issue is currently assigned a value in the managed field that is not supported by the state-machine for a target issue type,      the value for the managed field is reset to the initial value that is configured for the new state-machine.</p>      <p id="bf045a24">Following our example here, let's say that you have an issue that is currently classified as a feature request that was rejected by the development team.        You later learn that the problem is in fact a bug and should be fixed.        By changing the value of the <span class="control">Type</span> field from <span class="control">Feature</span> to <span class="control">Bug</span>,        the value for the <span class="control">State</span> field automatically changes from <span class="control">Rejected</span> to <span class="control">Open</span>.        This is because the state-machine that is associated with the <span class="control">Bug</span> type doesn't support transitions to the <span class="control">Rejected</span> state.</p>    </aside>    <p id="ba94bdee">We can take the sample code for the basic state-machine rule and quickly convert it into a state-machine per issue type with just a few changes.</p>    <ul class="list _ul"><li class="list__item" id="1d8bae73"><p>While it's not required, we have replaced the name of the <code class="code">fieldName</code> property with its alias, <code class="code">stateFieldName</code>.      As with the sample for the basic state-machine, we're managing transitions between values for a field called <code class="code">State</code>.      We don't change the value for this property.</p></li><li class="list__item" id="59946424"><p>We've added the property <code class="code">typeFieldName</code> and specified <code class="code">'Type'</code> as its value.      This means that the <span class="control">Type</span> field can now be used as a switch to determine whether to apply the default state-machine or an alternative state-machine that is assigned to one of the possible values for this field.</p></li><li class="list__item" id="173a40ff"><p>We've applied another change just for cosmetic purposes, replacing the name of the <code class="code">states</code> property with its alias, <code class="code">defaultMachine</code>.      We don't change the value for this property.      Instead, we reuse the basic state-machine rule, which will apply to any issue that isn't assigned one of the types that are defined in the <code class="code">alternativeMachines</code> section of the rule.</p></li><li class="list__item" id="d9571701"><p>We've added a new section for <code class="code">alternativeMachines</code>.      Here, we specify state-machines for issues that are assigned the values <span class="control">Bug</span> and <span class="control">Feature</span> in the <span class="control">Type</span> custom field.</p></li></ul>    <p id="a29412bb">Here's the modified state-machine rule:</p>    <div class="code-block" data-lang="javascript">var entities = require('@jetbrains/youtrack-scripting-api/entities');
var workflow = require('@jetbrains/youtrack-scripting-api/workflow');

exports.TWO_DAYS = 2 * 24 * 60 * 60 * 1000;
exports.ONE_WEEK_IN_MS = 7 * 24 * 60 * 60 * 1000;
exports.rule = entities.Issue.stateMachine({
  title: 'State-machine per Issue Type',
  stateFieldName: 'State',
  typeFieldName: 'Type',
  defaultMachine: {
    Open: {
      initial: true,
      transitions: {
        start: {
          targetState: 'In progress'
        },

        reminder: {
          targetState: 'Open',
          after: exports.TWO_DAYS,
          action: function(ctx) {
            var issue = ctx.issue;
            issue.project.leader.notify('Reminder', 'Check out an issue ' + issue.id);
          }
        }
      }
    },
    'In progress': {
      onEnter: function(ctx) {
        ctx.issue.fields.Assignee = ctx.currentUser;
      },
      onExit: function(ctx) {
      },
      transitions: {
        fix: {
          targetState: 'Fixed'
        },
        reopen: {
          guard: function(ctx) {
            if (ctx.issue.fields.Assignee) {
              workflow.message('You cannot reopen an issue unless you unassign it first');
              return false;
            }
            return true;
          },
          targetState: 'Open'
        }
      }
    },
    Fixed: {
      transitions: {}
    }
  },
  alternativeMachines: {
    Bug: {
      Open: {
        initial: true,
        transitions: {
          'in progress': {
            targetState: 'In Progress',
            action: function(ctx) {
              if (!ctx.issue.fields.Assignee) {
                ctx.issue.fields.Assignee = ctx.currentUser;
              }
            }
          },
          'can\'t reproduce': {
            targetState: 'Can\'t Reproduce'
          }
        }
      },
      'In Progress': {
        transitions: {
          'reopen': {
            targetState: 'Open'
          },
          'fix': {
            targetState: 'Fixed'
          },
          'can\'t reproduce': {
            targetState: 'Can\'t Reproduce'
          },
          'remind': {
            after: exports.ONE_WEEK_IN_MS,
            targetState: 'In Progress',
            action: function(ctx) {
              if (ctx.issue.fields.Assignee) {
                var subj = '[YouTrack] Issue is in progress';
                var body = 'Issue ' + ctx.issue.id + ' is in progress for a week.';
                ctx.issue.fields.Assignee.notify(subj, body);
              }
            }
          }
        }
      },
      Fixed: {
        transitions: {
          'reopen': {
            targetState: 'Open'
          }
        },
        onExit: function(ctx) {
          if (ctx.issue.fields.Assignee) {
            var subj = '[YouTrack] Issue is reopened';
            var body = 'Issue ' + ctx.issue.id + ' requires your attention.';
            ctx.issue.fields.Assignee.notify(subj, body);
          }
        }
      },
      'Can\'t Reproduce': {
        onEnter: function( /*ctx*/ ) {
          workflow.message('Please leave a comment explaining what you tried to do.');
        },
        transitions: {
          'reopen': {
            targetState: 'Open'
          }
        }
      }
    },
    Feature: {
      Open: {
        initial: true,
        transitions: {
          'in progress': {
            targetState: 'In Progress',
          },
          reject: {
            targetState: 'Rejected'
          }
        }
      },
      'In Progress': {
        transitions: {
          reopen: {
            targetState: 'Open'
          },
          fix: {
            targetState: 'Fixed'
          }
        }
      },
      Fixed: {
        transitions: {
          reopen: {
            targetState: 'Open'
          }
        }
      },
      Rejected: {
        transitions: {
          reopen: {
            targetState: 'Open'
          }
        }
      }
    }
  },
  requirements: {
    Assignee: {
      type: entities.User.fieldType
    }
  }
});</div>    <p id="f16f9bc7">The components that define this state-machine rule are as follows:</p>    <ul class="list _ul"><li class="list__item" id="2a96a2f6"><p>The <code class="code">require</code> statements reference the <code class="code">entities</code> and <code class="code">workflow</code> modules in the workflow API.</p></li><li class="list__item" id="b19d3964"><p>The <code class="code">exports.TWO_DAYS</code> property sets a local variable that is used to send the reminder for issues that have the <span class="control">Open</span> status.        This variable is assigned a value that equals 2 days in milliseconds.</p></li><li class="list__item" id="a9398358"><p>The <code class="code">exports.ONE_WEEK_IN_MS</code> property sets a local variable that is used to send the reminder for bugs that have been <span class="control">In Progress</span> for more than one week.      This variable is assigned a value that equals one week in milliseconds.</p></li><li class="list__item" id="3db41365"><p>The <code class="code">exports.rule</code> property uses the <code class="code">Issue.stateMachine</code> method to export the script that follows the declaration as a state-machine rule.</p></li><li class="list__item" id="5e772276"><p id="f3a5fa1a">The body of the rule itself contains definitions for the following properties:</p>        <div class="table-wrapper"><table width="100%" id="a73849e6"><thead><tr id="ef84a40d" class="ijRowHead"><th id="2463fb6a" width="20%"><p>Property</p></th><th id="f0a9d9eb"><p>Description</p></th></tr></thead><tbody><tr id="e7c25c33" class="ijRowOdd"><td id="cf9df00b"><p>title</p></td><td id="73e5715f"><p>An optional human-readable title.</p></td></tr><tr id="3e473af5" class="ijRowEven"><td id="ad638755"><p>stateFieldName</p></td><td id="964c564d"><p>The name of the custom field that is managed by the state-machine.</p></td></tr><tr id="82f124ee" class="ijRowOdd"><td id="c09611cf"><p>typeFieldName</p></td><td id="122de497"><p>The name of the custom field that regulates which state-machine is applied to the managed field.</p></td></tr><tr id="4c92bd9f" class="ijRowEven"><td id="f602bd5a"><p>defaultMachine</p></td><td id="1579de28"><p id="d9244b88">The list of field values and definitions for the transitions between them for the default state-machine.              The default state-machine applies to any issue that isn't assigned one of the types that are defined in the <code class="code">alternativeMachines</code> section of the rule.</p>              <p id="e9cd14db">Values that contain spaces and special characters are set in single quotes.</p></td></tr><tr id="35cae23e" class="ijRowOdd"><td id="fc846d94"><p>alternativeMachines</p></td><td id="1255cd4d"><p>Stores a collection of state-machine transitions for designated values in the custom field that is set for the <code class="code">typeFieldName</code> property.</p></td></tr><tr id="f155e42d" class="ijRowEven"><td id="43c1611f"><p>requirements</p></td><td id="e90948e8"><p id="65398285">The list of entities that are required for the rule to execute without errors.              This property ensures that rules can be attached to projects safely.</p>              <p id="eb20ae9f">In this example, we only require that there is an <span class="control">Assignee</span> field that stores a <code class="code">user</code> type in the projects to which the rule is attached.              If this field is absent, an error is shown in the <span class="control">Workflows</span> list.                The rule cannot be enabled until the required field is attached.</p>              <p id="38d3d721">For state-machines by issue type, you don't need to add any of the fields that are managed by the state-machine to the requirements.                This field and its values are derived from the <code class="code">defaultMachine</code> property and the collection of fields that are defined for each value in the <code class="code">alternativeMachines</code> section of the rule.              The field that is set for the <code class="code">typeFieldName</code> property is also implicitly added to the requirements for the workflow rule.</p></td></tr></tbody></table></div></li><li class="list__item" id="9f23aeb6"><p id="9da01742">Each of the values that are defined in the <code class="code">defaultMachine</code> property and each of the fields that are defined for each value in the <code class="code">alternativeMachines</code> section of the rule contain definitions for the following additional properties:</p>        <div class="table-wrapper"><table width="100%" id="154e5294"><thead><tr id="275ca2d0" class="ijRowHead"><th id="becaf2fb" width="20%"><p>Property</p></th><th id="8dd5ed89"><p>Description</p></th></tr></thead><tbody><tr id="378d8ffa" class="ijRowOdd"><td id="f5b7b897"><p>initial</p></td><td id="cfebc099"><p>A Boolean property that determines which of the values in the list is set when an issue is created.              Exactly one value must set this property to <code class="code">true</code>.              For other values that are not set as the initial value, this property is optional and can be omitted.</p></td></tr><tr id="1e0571d1" class="ijRowEven"><td id="c4b06823"><p>onEnter</p></td><td id="c46acaee"><p>An optional function declaration that is called when the corresponding value is assigned to an issue.              These functions behave similar to actions in other types of rules.</p></td></tr><tr id="d3e92c84" class="ijRowOdd"><td id="ead4151f"><p>onExit</p></td><td id="ce0c7cbf"><p>An optional function declaration that is called when the field value is changed from the current value to another value.              These functions behave similar to actions in other types of rules.</p></td></tr><tr id="f7415ce3" class="ijRowEven"><td id="756a3e6b"><p>transitions</p></td><td id="91f26111"><p id="52056540">The list of possible target values that can be set for each value in the list.</p>              <p id="9979a4a9">In this example, we only require that there is an <span class="control">Assignee</span> field that stores a <code class="code">user</code> type in the projects to which the rule is attached.              If this field is absent, an error is shown in the <span class="control">Workflows</span> list.                The rule cannot be enabled until the required field is attached.</p>              <p id="de0a7e88">For a state-machine rule, you do not need to list the values that are used by fields that are managed by the state-machine in the requirements.                This field and its values are derived from the <code class="code">states</code> property.</p></td></tr></tbody></table></div>      </li><li class="list__item" id="edbd51e8"><p id="37a6193d">Each of the values that are defined in the <code class="code">transitions</code> property contain a <code class="code">name</code> property.        The name is used to set this value in a command and is also shown in the list of values for a custom field.        Each transition name contains definitions for the following additional properties:</p>        <div class="table-wrapper"><table width="100%" id="3bc882ec"><thead><tr id="9a1846cf" class="ijRowHead"><th id="c29fdf55" width="20%"><p>Property</p></th><th id="566b4f23"><p>Description</p></th></tr></thead><tbody><tr id="40384c91" class="ijRowOdd"><td id="23fc2a27"><p>targetState</p></td><td id="33b60328"><p>The actual name of the value that is set when the command specified in the <code class="code">name</code> property is applied.</p></td></tr><tr id="1e5e3a1f" class="ijRowEven"><td id="3fa6ca5b"><p>after</p></td><td id="3074b006"><p>An optional property that sets an interval for performing an action.              The action itself is specified in the <code class="code">action</code> property.</p></td></tr><tr id="5aa206e5" class="ijRowOdd"><td id="df73c276"><p>action</p></td><td id="cb2232b1"><p>An optional property for any transition that behaves similar to actions in other types of rules..</p></td></tr><tr id="8444df49" class="ijRowEven"><td id="a01d399e"><p>guard</p></td><td id="b53d0d08"><p id="b244f690">An optional condition that determines when the transition is allowed.              If the guard condition is not met, the value for the custom field cannot change to the value that is defined for this transition.</p>              <p id="9f031203">In this example, for an issue to transition from <span class="control">In progress</span> back to an <span class="control">Open</span> state, the issue must be unassigned.                The guard contains a function that uses the <code class="code">message</code> method from the <code class="code">workflow</code> module to provide feedback to the user who attempts to reopen an issue without unassigning it first.</p></td></tr></tbody></table></div>      </li><li class="list__item" id="e58e4905"><p>The <code class="code">alternativeMachines</code> property stores a set of values from the field that is referenced in the <code class="code">typeFieldName</code> property.        Each of the values that are assigned dedicated state-machines are simply referenced by name.</p></li></ul>  </div><div class="last-modified" data-skip-index="skip">Last modified: 29 November 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="on-schedule-rules.html">On-schedule Rules</a><a class="navigation-links__next" href="action-rules.html">Action Rules</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="//resources.jetbrains.com/storage/help-app/v3/app.js"></script></body></html>