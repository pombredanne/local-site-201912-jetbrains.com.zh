<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
                        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
                        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
                        })(window,document,'script','dataLayer','GTM-5P98');
                    </script><script src="/help/app/v2/analytics.js"></script><meta charset="UTF-8"><meta name="robots" content="noindex"><title>Notify Multiple Unregistered Users - Help | YouTrack Standalone</title><link rel="stylesheet" href="/help/app/v2/app.css"></head><body data-id="Workflow-Notify-Multiple-Unregistered-Users"><noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-5P98" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div class="wrapper"><section class="panel _nav" data-skip-index="skip"><header class="panel__header"><div class="container"><form class="search-box"><label for="search-box__input" class="search-box__label"><input type="text" class="search-box__input" id="search-box__input" placeholder="Search YouTrack Standalone Help"></label><div class="search-box__clear" title="Clear"></div></form></div></header><nav class="panel__content"><div class="container _nav"><menu class="nav-tree"></menu></div><div class="container _footer panel__footer"><p><a href="#">Send feedback</a></p></div></nav></section><main class="panel _main"><header class="panel__header" data-skip-index="skip"><div class="container"><h3>YouTrack Standalone 2018.3 Help</h3><div class="shortcuts-switcher" data-skip-index="skip"><label for="switch-shortcuts">Keymap:</label><select id="switch-shortcuts" class="select _shortcuts" height="1"></select></div><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="false"><h1 data-toc="Workflow-Notify-Multiple-Unregistered-Users" id="Workflow-Notify-Multiple-Unregistered-Users.xml">Notify Multiple Unregistered Users</h1>    <p id="a0c1e7d9">This workflow is used as part of the Mailbox Integration that enables using YouTrack as a help desk. For a detailed description of this integration, see <a href="Use-YouTrack-as-a-Help-Desk.html"><span>Use YouTrack as a Help Desk</span></a></p>        <p id="aa2f96a3">You can use this workflow to send email messages to any email address, including unregistered users.        If overused, sending email messages to unregistered users can slow down the performance of your YouTrack server, which is not designed for use as a bulk email service.        You can configure a system property to set a daily email message limit. For more information, see <a href="YouTrack-Java-Start-Parameters.html"><span>Configuration Parameters</span></a>.</p>    <p id="f8cb3f0a">This workflow manages a of email addresses that are stored in the <span class="control">Last message related emails</span> and <span class="control">All related emails</span> fields.        It also includes a rule that sends email messages to unregistered users when a comment is added to an issue that was reported by sending an email to a specific mailbox.</p>    <div class="table-wrapper"><table class="left_header                 " width="100%" id="ccddce93"><tbody><tr id="55e108dd" class="ijRowOdd"><th id="bd0acf13" width="20%"><p>Name</p></th><td id="4e09fc91"><p>@jetbrains/youtrack-workflow-notify-multiple-unregistered-users</p></td></tr><tr id="5105183b" class="ijRowEven"><th id="634c7615"><p>Auto-attached</p></th><td id="acd5f21d"><p>no</p></td></tr><tr id="d8d04827" class="ijRowOdd"><th id="09b97822"><p>Modules</p></th><td id="c87ecf50"><p><a href="#collect-email-addresses">Collect related emails on issue creation</a> (on-change rule)<br>                <a href="#send-notifications">Send notifications to all unregistered users</a> (on-change rule)</p></td></tr></tbody></table></div>    <section class="procedure-steps"><h2 id="75ffa7ea">To enable this workflow:</h2><ol class="list _decimal"><li class="list__item" id="8b6bafa8"><p>Add a string-type field with the name <span class="control">Last message related emails</span> to your project.</p></li><li class="list__item" id="e04930db"><p>Add a string-type field with the name <span class="control">All related emails</span> to your project.</p></li><li class="list__item" id="e43138e4"><p>Attach the <span class="control">Notify Multiple Unregistered Users</span> workflow to your project.</p></li></ol></section>    <p id="49b0566a">For this workflow to function properly, there are a few additional settings you need to configure in your YouTrack instance:</p>    <ul class="list _ul"><li class="list__item" id="5a4d9ccc"><p>Configure your project to send notifications with the email address of your feedback or support account.</p></li><li class="list__item" id="f3e7f7c4"><p>Configure and enable the <span class="control">Mailbox Integration</span> feature.</p></li></ul>    <p id="045ae3d2">For a complete description of this setup, see <a href="Use-YouTrack-as-a-Help-Desk.html"><span>Use YouTrack as a Help Desk</span></a>.</p>    <div class="chapter"><h2 id="7be114f2">Use Case</h2>        <p id="b39c9f02">This workflow supports using YouTrack as a help desk. When an issue is reported by email, the email addresses in the <span class="control">From</span> and <span class="control">CC</span> fields are added to the issue.            These email addresses then receive email notifications when the issue is updated.</p>    </div>    <div class="chapter"><h2 id="b2508d81">Modules</h2>        <p id="6010663d">This workflow includes two modules. The first module contains a rule that manages the list of email addresses.            The second module contains a rule that sends notifications to these email addresses when an issue is updated.</p>        <div class="chapter"><h3 id="collect-email-addresses">Collect related emails on issue creation</h3>        <p id="291192e1">This rule collects the email addresses stored in the <span class="control">Last message related emails</span> field and copies them to the <span class="control">All related emails</span> field.</p>        <div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/entities&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/workflow&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Issue</span><span class="p">.</span><span class="nx">onChange</span><span class="p">({</span>
  <span class="nx">title</span><span class="o">:</span> <span class="nx">workflow</span><span class="p">.</span><span class="nx">i18n</span><span class="p">(</span><span class="s1">&#39;Collect related emails on issue creation&#39;</span><span class="p">),</span>
  <span class="nx">guard</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">.</span><span class="nx">becomesReported</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">issue</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lastMessageRelatedEmailsStr</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">lastEmails</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">isBlank</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">str</span> <span class="o">||</span> <span class="nx">str</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">lastMessageRelatedEmails</span> <span class="o">=</span> <span class="nx">isBlank</span><span class="p">(</span><span class="nx">lastMessageRelatedEmailsStr</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nx">lastMessageRelatedEmailsStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">lastMessageRelatedEmails</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">fromServiceEmail</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">notificationEmail</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">isEmailAllowed</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">email</span> <span class="o">&amp;&amp;</span> <span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">email</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">fromServiceEmail</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">allRelatedEmailsStr</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">allEmails</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">allRelatedEmails</span> <span class="o">=</span> <span class="nx">isBlank</span><span class="p">(</span><span class="nx">allRelatedEmailsStr</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nx">allRelatedEmailsStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">newUsersEmails</span> <span class="o">=</span> <span class="nx">lastMessageRelatedEmails</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">isEmailAllowed</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">allRelatedEmails</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">newUsersEmails</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">allEmails</span> <span class="o">=</span> <span class="nx">allRelatedEmails</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">newUsersEmails</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">lastEmails</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">requirements</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">lastEmails</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Last message related emails&#39;</span><span class="p">,</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Field</span><span class="p">.</span><span class="nx">stringType</span>
    <span class="p">},</span>
    <span class="nx">allEmails</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;All related emails&#39;</span><span class="p">,</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Field</span><span class="p">.</span><span class="nx">stringType</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span></code></div>            </div>        <div class="chapter"><h3 id="send-notifications">Send notifications to all unregistered users</h3>        <p id="78cbfcc3">The next rule sends notification to unregistered users whose email address is stored in the <span class="control">All related emails</span> field.            This is used to send notification to the email address of a person who reported an issue by sending an email to a specific inbox.        Additional email addresses that were set in the <span class="control">To</span> and <span class="control">CC</span> fields are also notified.</p>        <p id="31fef47f">The email message is formatted as a reply to the original email.</p>        <div class="code-block" data-lang="Javascript"><code class="code-block__wrapper"><span class="kd">var</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/entities&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">workflow</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/workflow&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">notifications</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;@jetbrains/youtrack-scripting-api/notifications&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">rule</span> <span class="o">=</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Issue</span><span class="p">.</span><span class="nx">onChange</span><span class="p">({</span>
  <span class="nx">title</span><span class="o">:</span> <span class="nx">workflow</span><span class="p">.</span><span class="nx">i18n</span><span class="p">(</span><span class="s1">&#39;Send notifications to all unregistered users&#39;</span><span class="p">),</span>
  <span class="nx">guard</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">added</span><span class="p">.</span><span class="nx">isNotEmpty</span><span class="p">();</span>
  <span class="p">},</span>
  <span class="nx">action</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">issue</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">issue</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">comment</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">added</span><span class="p">.</span><span class="nx">first</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">comment</span> <span class="o">&amp;&amp;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">permittedGroups</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">permittedUsers</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">isBlank</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">!</span><span class="nx">str</span> <span class="o">||</span> <span class="nx">str</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">allRelatedEmailsStr</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">allEmails</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">isBlank</span><span class="p">(</span><span class="nx">allRelatedEmailsStr</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">allRelatedEmails</span> <span class="o">=</span> <span class="nx">allRelatedEmailsStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">lastMessageRelatedEmailsStr</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">lastEmails</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">lastMessageRelatedEmails</span> <span class="o">=</span> <span class="nx">isBlank</span><span class="p">(</span><span class="nx">lastMessageRelatedEmailsStr</span><span class="p">)</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nx">lastMessageRelatedEmailsStr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">fromServiceEmail</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">project</span><span class="p">.</span><span class="nx">notificationEmail</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">isEmailAllowed</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">email</span> <span class="o">&amp;&amp;</span> <span class="nx">email</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">email</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">fromServiceEmail</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">();</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">emailsToNotify</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lastMessageRelatedEmails</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//case 1: comment from unregistered user</span>
        <span class="kd">var</span> <span class="nx">newUsersEmails</span> <span class="o">=</span> <span class="nx">lastMessageRelatedEmails</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">isEmailAllowed</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">allRelatedEmails</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newUsersEmails</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">allEmails</span> <span class="o">=</span> <span class="nx">allRelatedEmailsStr</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">newUsersEmails</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">issue</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">lastEmails</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

        <span class="nx">emailsToNotify</span> <span class="o">=</span> <span class="nx">allRelatedEmails</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">isEmailAllowed</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">lastMessageRelatedEmails</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">//case 2: comment from agent</span>
        <span class="nx">emailsToNotify</span> <span class="o">=</span> <span class="nx">allRelatedEmails</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">isEmailAllowed</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
        <span class="p">});</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">emailsToNotify</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">fromName</span><span class="o">:</span> <span class="nx">lastMessageRelatedEmails</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">lastMessageRelatedEmails</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">author</span><span class="p">.</span><span class="nx">fullName</span><span class="p">,</span>
          <span class="nx">toEmails</span><span class="o">:</span> <span class="nx">emailsToNotify</span><span class="p">,</span>
          <span class="nx">subject</span><span class="o">:</span> <span class="nx">createSubject</span><span class="p">(</span><span class="nx">issue</span><span class="p">),</span>
          <span class="nx">body</span><span class="o">:</span> <span class="nx">lastMessageRelatedEmails</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">createGeneralMessage</span><span class="p">(</span><span class="nx">issue</span><span class="p">)</span> <span class="o">:</span> <span class="nx">createInReplyToMessage</span><span class="p">(</span><span class="nx">issue</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="nx">notifications</span><span class="p">.</span><span class="nx">sendEmail</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">issue</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">requirements</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">lastEmails</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Last message related emails&#39;</span><span class="p">,</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Field</span><span class="p">.</span><span class="nx">stringType</span>
    <span class="p">},</span>
    <span class="nx">allEmails</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;All related emails&#39;</span><span class="p">,</span>
      <span class="nx">type</span><span class="o">:</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">Field</span><span class="p">.</span><span class="nx">stringType</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">createGeneralMessage</span><span class="p">(</span><span class="nx">issue</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">added</span><span class="p">.</span><span class="nx">first</span><span class="p">().</span><span class="nx">text</span><span class="p">;</span>
  <span class="nx">issue</span><span class="p">.</span><span class="nx">attachments</span><span class="p">.</span><span class="nx">added</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">attachment</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span> <span class="o">+</span> <span class="s1">&#39;\n[file:&#39;</span> <span class="o">+</span> <span class="nx">attachment</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">wikify</span><span class="p">(</span><span class="nx">text</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createInReplyToMessage</span><span class="p">(</span><span class="nx">issue</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">messageText</span> <span class="o">=</span> <span class="nx">createGeneralMessage</span><span class="p">(</span><span class="nx">issue</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">addedComments</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">added</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lastVisibleComment</span><span class="p">;</span>
  <span class="nx">issue</span><span class="p">.</span><span class="nx">comments</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">comment</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">addedComments</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">comment</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">permittedGroups</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">comment</span><span class="p">.</span><span class="nx">permittedUsers</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">lastVisibleComment</span> <span class="o">=</span> <span class="nx">comment</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">quotedText</span> <span class="o">=</span> <span class="nx">lastVisibleComment</span> <span class="o">?</span>
    <span class="nx">issue</span><span class="p">.</span><span class="nx">wikify</span><span class="p">(</span><span class="nx">lastVisibleComment</span><span class="p">.</span><span class="nx">text</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span> <span class="o">:</span>
    <span class="nx">issue</span><span class="p">.</span><span class="nx">wikify</span><span class="p">(</span><span class="nx">issue</span><span class="p">.</span><span class="nx">description</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>

  <span class="k">return</span> <span class="p">[</span>
    <span class="s1">&#39;&lt;div style=&quot;font-family: sans-serif&quot;&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;  &lt;div style=&quot;padding: 10px 10px; font-size: 13px; border-bottom: 1px solid #D4D5D6;&quot;&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="nx">messageText</span><span class="p">,</span>
    <span class="s1">&#39;  &lt;/div&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;  &lt;blockquote type=&quot;cite&quot;&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;    &lt;div style=&quot;font-size: 13px; color: #888;&quot;&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;      &#39;</span> <span class="o">+</span> <span class="nx">workflow</span><span class="p">.</span><span class="nx">i18n</span><span class="p">(</span><span class="s1">&#39;In reply to:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;br&gt;&lt;br&gt;&#39;</span> <span class="o">+</span> <span class="nx">quotedText</span><span class="p">,</span>
    <span class="s1">&#39;    &lt;/div&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;  &lt;/blockquote&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;  &lt;div style=&quot;margin: 20px 0 20px 44px; padding: 4px 0 8px 0; color: #888; font-size: 11px; border-top: 1px solid #D4D5D6;&quot;&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="nx">workflow</span><span class="p">.</span><span class="nx">i18n</span><span class="p">(</span><span class="s1">&#39;You have received this message because you are a participant of the conversation in the issue {0}. Sincerely yours, YouTrack&#39;</span><span class="p">,</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span>
    <span class="s1">&#39;  &lt;/div&gt;&#39;</span><span class="p">,</span>
    <span class="s1">&#39;&lt;/div&gt;&#39;</span>
  <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">createSubject</span><span class="p">(</span><span class="nx">issue</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">reStr</span> <span class="o">=</span> <span class="nx">workflow</span><span class="p">.</span><span class="nx">i18n</span><span class="p">(</span><span class="s1">&#39;Re:&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">summary</span> <span class="o">=</span> <span class="nx">issue</span><span class="p">.</span><span class="nx">summary</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">summary</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="nx">reStr</span><span class="p">)</span> <span class="o">?</span> <span class="nx">summary</span> <span class="o">:</span> <span class="nx">reStr</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">summary</span><span class="p">;</span>
<span class="p">}</span></code></div>    </div></div><div class="last-modified" data-skip-index="skip">Last modified: 7 March 2019 </div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom" data-skip-index="skip"><a class="navigation-links__prev" href="Workflow-Kanban.html">Kanban</a><a class="navigation-links__next" href="Workflow-Notify-Reporter-to-Approve-Fix.html">Notify Reporter to Approve Fix</a></div></article><div id="disqus_thread" data-skip-index="skip"></div></div></section></main></div><script src="/help/app/v2/app.js"></script></body></html>